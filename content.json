{"pages":[{"title":"å…³äºæœ¬ç«™","text":"è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚ æ­¤ç«™å›¾ç‰‡è¯·ä½¿ç”¨å…¨å±€ä»£ç†æŸ¥çœ‹ã€‚","link":"/about/index.html"}],"posts":[{"title":"M1èŠ¯ç‰‡Macå®‰è£…ä»»æ„iOS Appçš„æ–¹å¼","text":"2021.05.19 æ›´æ–° åœ¨ Mac OS 11.3.1 ç³»ç»Ÿä¸­ï¼Œå¦‚æœå¼€å‘è€…åœ¨è‹¹æœå¼€å‘è€…ç½‘ç«™ä¸Šæ˜ç¡®å£°æ˜äº†ç¦æ­¢å…¶ App è¿è¡Œåœ¨ M1 Mac ä¸Šï¼Œé‚£ä¹ˆæ­¤ç§æ–¹å¼æ˜¯å®‰è£…ä¸ä¸Šçš„ï¼Œä¹‹å‰çš„ç³»ç»Ÿç‰ˆæœ¬æ˜¯å¯ä»¥çš„ï¼Œæ‰€ä»¥åº”è¯¥æ˜¯è‹¹æœåœ¨ Mac OS 11.3.1 ç³»ç»Ÿä¸­åŠ ä¸Šäº†æ ¡éªŒã€‚ å‰æï¼šä½ è¦å®‰è£…åˆ° Mac ä¸Šçš„ App æ›¾ç»åœ¨ iPhone ä¸Šé¢å®‰è£…è¿‡ï¼ˆæ²¡æœ‰çš„è¯å°±å…ˆåœ¨ iPhone ä¸Šå®‰è£…ä¸€ä¸ªï¼‰ 1.åœ¨ Mac çš„åº”ç”¨å•†åº—ä¸­ä¸‹è½½å®‰è£… Apple Configurator2 å¹¶æ‰“å¼€ 2.è¿æ¥ iPhoneï¼ŒåŒå‡»è‡ªå·±çš„æ‰‹æœºï¼Œç‚¹å‡»æ·»åŠ  Appï¼Œæ‰¾åˆ°å¯¹åº”çš„ App åå¼€å§‹ä¸‹è½½ 3.ä¸‹è½½å®Œæˆåä¼šæç¤ºæ‰‹æœºä¸Šå­˜åœ¨è¿™ä¸ªåº”ç”¨ï¼Œè¿™ä¸ªæ—¶å€™ä¸è¦ç‚¹ä»»ä½•æŒ‰é’® 4.åœ¨è®¿è¾¾ä¸­å‰å¾€ä»¥ä¸‹è·¯å¾„ï¼š 1~/Library/Group Containers/K36BKF7T3D.group.com.apple.configurator/Library/Caches/Assets/TemporaryItems/MobileApps/ å¯ä»¥çœ‹åˆ°å·²ç»ä¸‹è½½å¥½çš„ ipa å®‰è£…åŒ…ï¼Œç›´æ¥åŒå‡»å°±èƒ½å®‰è£…åœ¨ç”µè„‘ä¸Š 5.æ‰“å¼€å®‰è£…å¥½çš„ App æ—¶ä¼šæç¤ºæ²¡æœ‰æƒé™ï¼Œæ­£å¸¸ï¼Œéœ€è¦ç¬¬6æ­¥ 6.æ‰“å¼€ç»ˆç«¯ï¼Œè¾“å…¥ï¼š 1sudo xattr -r -d com.apple.quarantine ä½ è¦å®‰è£…Appçš„è·¯å¾„ (ä¾‹å¦‚ sudo xattr -r -d com.apple.quarantine /Applications/WeChat.app ) å›è½¦ï¼Œè¾“å…¥å¯†ç ï¼Œå›è½¦ã€‚ 7.é‡æ–°æ‰“å¼€ App åä¸€åˆ‡æ­£å¸¸ã€‚","link":"/2020/11/28/Mac/M1%E8%8A%AF%E7%89%87Mac%E5%AE%89%E8%A3%85%E4%BB%BB%E6%84%8FiOS%20App%E7%9A%84%E6%96%B9%E5%BC%8F/"},{"title":"Macåº”ç”¨ç¨‹åºæ— æ³•æ‰“å¼€æˆ–æ–‡ä»¶æŸåçš„è§£å†³åŠæ³•","text":"ä¸€ã€é‡åˆ°æç¤º â€œXXX.app å·²æŸåï¼Œæ‰“ä¸å¼€ã€‚æ‚¨åº”è¯¥å°†å®ƒç§»åˆ°åºŸçº¸ç¯“ â€ æˆ– â€œ æ‰“ä¸å¼€ XXX.appï¼Œå› ä¸ºå®ƒæ¥è‡ªèº«ä»½ä¸æ˜çš„å¼€å‘è€…â€œ è§£å†³åŠæ³•ï¼š æ‰“å¼€ç³»ç»Ÿåå¥½è®¾ç½®ç•Œé¢ï¼Œè¿›å…¥å®‰å…¨æ€§ä¸éšç§ ç‚¹æŒ‰å·¦ä¸‹è§’çš„é”å›¾æ ‡ï¼Œè§£é”æ›´æ”¹æƒé™ å°†å…è®¸ä»ä»¥ä¸‹ä½ç½®ä¸‹è½½çš„åº”ç”¨ï¼Œæ›´æ”¹ä¸º â€œä»»ä½•æ¥æºâ€ ï¼Œç„¶åå†æ‰“å¼€åº”ç”¨å³å¯ äºŒã€æç¤ºå·²æŸåæ— æ³•æ‰“å¼€ æ‰“å¼€ç»ˆç«¯ï¼› è¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼Œå›è½¦ï¼›sudo xattr -d com.apple.quarantine /Applications/xxxx.appæ³¨æ„ï¼š/Applications/xxxx.app æ¢æˆä½ çš„Appè·¯å¾„ é‡å¯Appå³å¯ã€‚","link":"/2021/05/08/Mac/Mac%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E6%97%A0%E6%B3%95%E6%89%93%E5%BC%80%E6%88%96%E6%96%87%E4%BB%B6%E6%8D%9F%E5%9D%8F%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/"},{"title":"01-å¯¹è±¡çš„åˆ›å»º","text":"ä¸€ã€å‰è¨€çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š æ€è€ƒallocå’Œinitåº•å±‚åˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿå¸¦ç€è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬ä»æºç çš„è§’åº¦æ¢ç´¢ã€‚ äºŒã€åˆ†æ alloc æºç 1.0 å‡†å¤‡å·¥ä½œ1.ä» è‹¹æœå®˜æ–¹å¼€æºä»£ç åˆ—è¡¨ æ‰¾åˆ° objc4æºç ã€‚ è‹¹æœäº 2006 å¹´å‘å¸ƒ Objective-C 2.0 ï¼Œé‡å†™äº† Objective-C 1.0 ä¸­ç±»ä¸å¯¹è±¡çš„å®šä¹‰ï¼Œå‘½åä¸º objc4 2.ä¸‹è½½åˆ°æœ¬åœ°åï¼Œéœ€è¦å¯¹å·¥ç¨‹è¿›è¡Œä¸€ç•ªç¼–è¯‘è°ƒè¯•ï¼Œå…·ä½“æ­¥éª¤å¯å‚è€ƒ Cooci çš„åšå®¢ iOS_objc4-756.2 æœ€æ–°æºç ç¼–è¯‘è°ƒè¯•ã€‚ 3.ç¼–è¯‘é€šè¿‡åï¼Œå°±å¯ä»¥æ–°å»ºä¸ª target è°ƒè¯•äº† æˆ‘ Github ä¸Šçš„æºç ï¼šhttps://github.com/speam/OjbcSuorce.git 4.å¸¸ç”¨çš„ä»£ç è·Ÿè¸ªæ–¹å¼ï¼š Xcode èœå•æ ä¾æ¬¡ç‚¹å‡»Debug-&gt;Debug Workflow-&gt;Always show Disassembly control + step into ä¸‹ç¬¦å·æ–­ç‚¹ï¼Œå¦‚alloc 1.1 objc_allocâ€”allocçš„çœŸæ­£å…¥å£ç»™[Person alloc]åŠ æ–­ç‚¹ æ­¤æ—¶ï¼Œåœ¨Xcodeçš„èœå•æ ä¾æ¬¡ç‚¹å‡»Debug-&gt;Debug Workflow-&gt;Always show Disassemblyï¼Œå¾—åˆ°æ±‡ç¼–ä»£ç ï¼Œå‘ç°è°ƒç”¨äº†objc_alloc: å®šä½åˆ°objc_alloc()ï¼Œå‘ç°å†…éƒ¨è°ƒç”¨callAlloc() 1.2 callAllocåˆ†æobjc_alloc()å†…éƒ¨è°ƒç”¨callAlloc()ï¼Œå…¶æºç ä¸ºï¼š 123456789101112131415161718192021222324252627282930313233// Call [cls alloc] or [cls allocWithZone:nil], with appropriate // shortcutting optimizations.static ALWAYS_INLINE idcallAlloc(Class cls, bool checkNil, bool allocWithZone=false){ if (slowpath(checkNil &amp;&amp; !cls)) return nil;#if __OBJC2__ if (fastpath(!cls-&gt;ISA()-&gt;hasCustomAWZ())) { // No alloc/allocWithZone implementation. Go straight to the allocator. // fixme store hasCustomAWZ in the non-meta class and // add it to canAllocFast's summary if (fastpath(cls-&gt;canAllocFast())) { // æ°¸è¿œä¸èµ°è¿™é‡Œ // No ctors, raw isa, etc. Go straight to the metal. bool dtor = cls-&gt;hasCxxDtor(); id obj = (id)calloc(1, cls-&gt;bits.fastInstanceSize()); if (slowpath(!obj)) return callBadAllocHandler(cls); obj-&gt;initInstanceIsa(cls, dtor); return obj; } else { // æ°¸è¿œèµ°è¿™é‡Œ // Has ctor or raw isa or something. Use the slower path. id obj = class_createInstance(cls, 0); if (slowpath(!obj)) return callBadAllocHandler(cls); return obj; } }#endif // No shortcuts available. if (allocWithZone) return [cls allocWithZone:nil]; return [cls alloc];} å¯¹callAlloc()çš„åˆ†æå¦‚ä¸‹ï¼š â‘ __OBJC2__åœ¨ OC2.0 ä»¥åä¸º1ï¼Œæºç ï¼š 12345678// Define __OBJC2__ for the benefit of our asm files.#ifndef __OBJC2__# if TARGET_OS_OSX &amp;&amp; !TARGET_OS_IOSMAC &amp;&amp; __i386__ // old ABI# else# define __OBJC2__ 1 // æ€»ä¹‹éƒ½æ˜¯1# endif#endif â‘¡slowpath(bool)ä¸fastpath(bool)ï¼šå¸¸ç”¨äºif-elseï¼Œå¯ä»¥ä¼˜åŒ–åˆ¤æ–­çš„é€Ÿåº¦ã€‚ 12345// fastpath(x)ï¼šè¡¨ç¤ºè¿”å›å€¼ä¸ºxï¼Œä¸”xå¾ˆæœ‰å¯èƒ½ä¸º1#define fastpath(x) (__builtin_expect(bool(x), 1))// slowpath(x)ï¼šè¡¨ç¤ºè¿”å›å€¼ä¸ºxï¼Œä¸”xå¾ˆæœ‰å¯èƒ½ä¸º0#define slowpath(x) (__builtin_expect(bool(x), 0)) â‘¢hasCustomAWZ()ï¼šæ„æ€æ˜¯hasCustomAllocWithZoneï¼Œå³æ˜¯å¦æœ‰é‡å†™ç±»çš„+allocWithZone:æ–¹æ³•ï¼Œä½†æ˜¯å®ƒçš„å€¼å¹¶ä¸èƒ½ç®€å•åœ°è¿™ä¹ˆåˆ¤æ–­ï¼å…ˆçœ‹æºç  123bool hasCustomAWZ() { return ! bits.hasDefaultAWZ();} æ³¨æ„ï¼šhasCustomAWZ()çš„å€¼é—®é¢˜ã€éå¸¸é‡è¦ï¼Œè®¾ç½®åˆå§‹åŒ–é¡ºåºï¼Œå¾ˆå¤šåšå®¢ä¸­æ ¹æœ¬æ²¡æœ‰æåˆ°ï¼ã€‘ ç±»çš„+initializeæ–¹æ³•ä¸»è¦ç”¨äºåˆå§‹åŒ–é™æ€å˜é‡ã€‚åœ¨å…¶æ‰§è¡Œä¹‹å‰ï¼ŒhasDefaultAWZ()å€¼ä¸ºfalseï¼Œå³hasCustomAWZ()ä¸ºtrueï¼›å…¶æ‰§è¡Œä¹‹åï¼Œå¦‚æœå½“å‰ç±»é‡å†™äº†+allocWithZone:æ–¹æ³•ï¼ŒhasCustomAWZ()ä¸ºtrueï¼Œå¦åˆ™ä¸ºfalseï¼ˆä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šé‡å†™ï¼Œå³hasCustomAWZä¸ºfalseï¼‰ã€‚ ç±»çš„+initializeæ–¹æ³•ä¼šåœ¨ç¬¬ä¸€æ¬¡åˆå§‹åŒ–è¯¥ç±»ä¹‹å‰è°ƒç”¨ã€‚å½“è°ƒç”¨[cls alloc]æ—¶ï¼Œä¼šè§¦å‘objc_msgSendï¼Œç„¶åä¼šæ‰§è¡Œ+initialize:ã€‚ï¼ˆæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥åˆ†åˆ«æ‰“å°+allocå’Œ+initialize:æ–¹æ³•åŠ ä»¥éªŒè¯ï¼‰ å› æ­¤ï¼Œå½“ç±»ç¬¬ä¸€æ¬¡æ¥åˆ°callAlloc()æ—¶ï¼Œæœ€ç»ˆä¼šæ‰§è¡Œ[cls alloc]ã€‚ â‘£canAllocFast()æºç å¦‚ä¸‹ï¼š 1234bool canAllocFast() { assert(!isFuture()); return bits.canAllocFast();} å†å¾€åº•å±‚æ‰¾bits.canAllocFast()ï¼Œå‘ç°å…³é”®å®FAST_ALLOC 1234567891011#if FAST_ALLOC ... bool canAllocFast() { return bits &amp; FAST_ALLOC; }#else ... bool canAllocFast() { return false; }#endif ç»§ç»­æ·±å…¥ï¼Œæ¥åˆ°äº†FAST_ALLOCå®å®šä¹‰ä¹‹å¤„ 123456789#if !__LP64__ // å½“å‰æ“ä½œç³»ç»Ÿä¸æ˜¯64ä½...#elif 1 // å½“å‰æ“ä½œç³»ç»Ÿæ˜¯64ä½...#else ...#define FAST_ALLOC (1UL&lt;&lt;2) // æ‰¾åˆ°äº†...#endif ä»ä¸Šé¢å®ä»£ç å¯ä»¥å¾—å‡ºè¿™æ ·çš„ç»“è®ºï¼Œå³æ— è®ºå½“å‰æ“ä½œç³»ç»Ÿæ˜¯ä¸æ˜¯64ä½ï¼Œéƒ½æ²¡æœ‰å®šä¹‰FAST_ALLOCï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒcanAllocFast()æ°¸è¿œæ˜¯false! å› æ­¤ï¼Œå¦‚æœhasCustomAWZ()ä¸ºfalseæ—¶ï¼Œä¼šç›´æ¥å»åˆ°class_createInstance()ã€‚ 1.3 alloc-&gt;_objc_rootAlloc-&gt;callAlloc-&gt;class_createInstanceé€šè¿‡å¯¹hasCustomAWZ()çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“ç±»çš„ç¬¬ä¸€æ¬¡åˆå§‹åŒ–æœ€ç»ˆæ˜¯èµ°åˆ°callAllocçš„æœ€åï¼Œå³return [cls alloc]; â‘ ç”±äºæ‰§è¡Œäº†[cls alloc]ï¼Œè¿™æ¬¡çœŸçš„æ¥åˆ°alloc()æ–¹æ³•äº† 123+ (id)alloc { return _objc_rootAlloc(self);} â‘¡æ¥ç€æ˜¯_objc_rootAlloc() 1234567// Base class implementation of +alloc. cls is not nil.// Calls [cls allocWithZone:nil].id_objc_rootAlloc(Class cls){ return callAlloc(cls, false/*checkNil*/, true/*allocWithZone*/); // æ³¨æ„è¿™é‡Œçš„ä¸‰ä¸ªå‚æ•°} â‘¢å†æ¬¡æ¥åˆ°callAllocï¼Œæ­¤æ—¶hasCustomAWZ()çš„å€¼å–å†³äºå½“å‰ç±»æ˜¯å¦é‡å†™äº†+allocWithZone:æ–¹æ³•ã€‚ ç”±äºPersonç±»æ²¡æœ‰é‡å†™ï¼Œfastpath(!cls-&gt;ISA()-&gt;hasCustomAWZ())ä¸ºtrueï¼Œè€ŒcanAllocFast()æ°¸è¿œä¸ºfalseã€‚ å› æ­¤ï¼Œæ¥ä¸‹æ¥ä¼šèµ°åˆ°class_createInstance()ï¼Œå…¶æºç å¦‚ä¸‹ï¼š 12345id class_createInstance(Class cls, size_t extraBytes){ return _class_createInstanceFromZone(cls, extraBytes, nil);} 1.4 _class_createInstanceFromZoneé¡¾åæ€ä¹‰ï¼Œè¿™æ˜¯è¦åˆ›å»ºå¯¹è±¡ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546static __attribute__((always_inline)) id_class_createInstanceFromZone(Class cls, size_t extraBytes, void *zone, bool cxxConstruct = true, size_t *outAllocatedSize = nil){ if (!cls) return nil; assert(cls-&gt;isRealized()); // ä¸€æ¬¡è¯»å–ç±»çš„ä¿¡æ¯ä½ä»¥æé«˜æ€§èƒ½ bool hasCxxCtor = cls-&gt;hasCxxCtor(); // æ˜¯å¦æœ‰æ„é€ å‡½æ•° bool hasCxxDtor = cls-&gt;hasCxxDtor(); // æ˜¯å¦æœ‰ææ„å‡½æ•° bool fast = cls-&gt;canAllocNonpointer(); // OC 2.0ä»¥ä¸ŠåŸºæœ¬ä¸Šè¿”å›çš„éƒ½æ˜¯true // è®¡ç®—å†…å­˜ size_t size = cls-&gt;instanceSize(extraBytes); if (outAllocatedSize) *outAllocatedSize = size; id obj; if (!zone &amp;&amp; fast) { // åˆ†é…1å—å¤§å°ä¸ºsizeçš„è¿ç»­å†…å­˜ obj = (id)calloc(1, size); if (!obj) return nil; // åˆå§‹åŒ–å¯¹è±¡çš„isa obj-&gt;initInstanceIsa(cls, hasCxxDtor); } else { if (zone) { obj = (id)malloc_zone_calloc ((malloc_zone_t *)zone, 1, size); } else { obj = (id)calloc(1, size); } if (!obj) return nil; // Use raw pointer isa on the assumption that they might be // doing something weird with the zone or RR. obj-&gt;initIsa(cls); } if (cxxConstruct &amp;&amp; hasCxxCtor) { obj = _objc_constructOrFree(obj, cls); } return obj;} å¯¹_class_createInstanceFromZone()çš„åˆ†æå¦‚ä¸‹ï¼š â‘ cls-&gt;instanceSize(extraBytes)è®¡ç®—å†…å­˜ï¼Œæ­¤æ—¶çš„extraBytesæ˜¯0ï¼Œå…¶æºç æ˜¯ 1234567891011121314151617181920212223242526272829303132// 1.size_t instanceSize(size_t extraBytes) { size_t size = alignedInstanceSize() + extraBytes; // CF requires all objects be at least 16 bytes. if (size &lt; 16) size = 16; return size;}// 2.uint32_t alignedInstanceSize() { return word_align(unalignedInstanceSize());}// 3. å­—èŠ‚å¯¹é½static inline uint32_t word_align(uint32_t x) { return (x + WORD_MASK) &amp; ~WORD_MASK;}static inline size_t word_align(size_t x) { return (x + WORD_MASK) &amp; ~WORD_MASK;}// 4.#ifdef __LP64__# define WORD_SHIFT 3UL# define WORD_MASK 7UL# define WORD_BITS 64#else# define WORD_SHIFT 2UL# define WORD_MASK 3UL# define WORD_BITS 32#endif å¯è§ï¼ŒWORD_MASKåœ¨64ä½ç³»ç»Ÿä¸‹æ˜¯7ï¼Œå¦åˆ™æ˜¯3ï¼Œword_align()æ–¹æ³•å°±æ˜¯è¿›è¡Œå­—èŠ‚å¯¹é½çš„ã€‚ å­—èŠ‚å¯¹é½ç®—æ³•ï¼š(x + WORD_MASK) &amp; ~WORD_MASK 12345678910111213141516å‡å¦‚ï¼š x = 9ï¼Œå·²çŸ¥ WORD_MASK = 7 x + WORD_MASK = 9 + 7 = 16 WORD_MASK äºŒè¿›åˆ¶ ï¼š0000 0111 = 7 ï¼ˆ4+2+1ï¼‰ ~WORD_MASK äºŒè¿›åˆ¶ : 1111 1000 16çš„äºŒè¿›åˆ¶ä¸º : 0001 0000 0001 0000 &amp; 1111 1000--------------- 0001 0000 = 16æ‰€ä»¥å­—èŠ‚å¯¹é½åè¿”å›16 ä¹Ÿå°±æ˜¯8çš„å€æ•°å¯¹é½ï¼Œå³8å­—èŠ‚å¯¹é½ å› æ­¤ï¼Œword_align()åœ¨64ä½ç³»ç»Ÿä¸‹æ˜¯8å­—èŠ‚å¯¹é½ï¼Œå¦åˆ™æ˜¯4å­—èŠ‚å¯¹é½ã€‚ åŒæ—¶ï¼ŒinstanceSize()å‡½æ•°åˆå¯¹å†…å­˜å¤§å°åˆè¿›è¡Œäº†æœ€å°16å­—èŠ‚çš„é™åˆ¶ã€‚ â‘¡canAllocNonpointer()æ˜¯å¯¹isaçš„ç±»å‹çš„åŒºåˆ†ï¼Œå¦‚æœä¸€ä¸ªç±»ä½¿ç”¨isa_tç±»å‹çš„isaçš„è¯å°±è¿”å›trueï¼Œæˆ‘ä»¬ä¸ç”¨å¤ªå…³å¿ƒï¼ŒOC 2.0ä»¥ä¸ŠåŸºæœ¬ä¸Šè¿”å›çš„éƒ½æ˜¯trueï¼Œæ‰€ä»¥fastå°±æ˜¯trueï¼›è€Œåœ¨__OBJC2__ä¸­ï¼Œzoneä¼šè¢«å¿½ç•¥ï¼Œæ‰€ä»¥!zoneä¹Ÿæ˜¯trueï¼› ç»¼ä¸Šï¼Œæ¥ç€å°±æ˜¯calloc()å’ŒinitInstanceIsa()ã€‚ â‘¢size_t size = cls-&gt;instanceSize(extraBytes);è¿™ä¸€æ­¥å¾—åˆ°äº†è®¡ç®—åçš„sizeï¼Œä¼ åˆ°calloc(1, size)ä¸­è¿›è¡Œåˆ†é…å†…å­˜ã€‚ â‘£calloc()çš„åº•å±‚æºç æ˜¯åœ¨è‹¹æœå¼€æºçš„libmallocæºç ä¸­(æˆ‘Githubä¸­ä¹Ÿå‡†å¤‡äº†)ï¼Œç»è¿‡æ–­ç‚¹è·Ÿè¸ª(ä¸­é—´è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œç•¥è¿‡å…ˆ)ï¼Œå‘ç°calloc()åˆ†é…çš„å†…å­˜å¤§å°å—segregated_size_to_fit()å½±å“ï¼Œçœ‹ä¸‹é¢æºç ï¼š 123456789101112131415161718192021static MALLOC_INLINE size_tsegregated_size_to_fit(nanozone_t *nanozone, size_t size, size_t *pKey) // è¿™é‡Œçš„sizeå°±æ˜¯calloc(1, size)ä¸­ä¼ è¿‡æ¥çš„{ size_t k, slot_bytes; if (0 == size) { // Historical behavior size = NANO_REGIME_QUANTA_SIZE; } // round up and shift for number of quanta k = (size + NANO_REGIME_QUANTA_SIZE - 1) &gt;&gt; SHIFT_NANO_QUANTUM; // multiply by power of two quanta size slot_bytes = k &lt;&lt; SHIFT_NANO_QUANTUM; // Zero-based! *pKey = k - 1; return slot_bytes;}#define SHIFT_NANO_QUANTUM 4#define NANO_REGIME_QUANTA_SIZE (1 &lt;&lt; SHIFT_NANO_QUANTUM) // 16 ä»ä»£ç å¯ä»¥çœ‹å‡ºï¼Œslot_bytesç­‰äº(size + 16-1) &gt;&gt; 4 &lt;&lt; 4ï¼Œæ˜¯16å­—èŠ‚å¯¹é½ï¼Œæ‰€ä»¥å°±æ˜¯å°†è®¡ç®—å¾—åˆ°çš„sizeè¿›è¡Œä¸€æ¬¡16å­—èŠ‚å¯¹é½ï¼Œå› æ­¤calloc()åˆ†é…çš„å†…å­˜å¤§å°å¿…ç„¶æ˜¯16å­—èŠ‚çš„æ•´æ•°å€ï¼Œå› æ­¤ä¸ºå¯¹è±¡åˆ†é…çš„å†…å­˜ç©ºé—´ä¸€å®šæ˜¯16å­—èŠ‚å¯¹é½çš„ã€‚ â‘¤initInstanceIsa()å°±æ˜¯åˆå§‹åŒ–isaï¼Œå¹¶ä¸”å…³è”clsã€‚ ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œ_class_createInstanceFromZone()åšäº†å¾ˆå¤šäº‹æƒ…ï¼Œå¹¶ä¸”æœ€ç»ˆç¡®å®åˆ›å»ºäº†å¯¹è±¡ï¼Œå‡ ä¹å¹²äº†æ‰€æœ‰äº‹æƒ…ï¼Œé‚£ä¹ˆï¼Œinitåˆåˆ°åº•åšäº†ä»€ä¹ˆå‘¢ï¼Ÿ ä¸‰ã€initå’Œnew1. init1234567891011- (id)init { return _objc_rootInit(self);}id_objc_rootInit(id obj){ // In practice, it will be hard to rely on this function. // Many classes do not properly chain -init calls. return obj;} éå¸¸ç®€å•ï¼Œinitä»…ä»…æ˜¯å°†allocåˆ›å»ºçš„å¯¹è±¡è¿”å›ã€‚æ˜¯ä¸€ç§å·¥å‚è®¾è®¡æ–¹æ¡ˆï¼Œæ–¹ä¾¿å­ç±»é‡å†™ã€‚ 2. newæˆ‘ä»¬å†çœ‹çœ‹new 123+ (id)new { return [callAlloc(self, false/*checkNil*/) init];} å¾ˆæ˜æ˜¾ï¼Œnewç›¸å½“äºalloc+initã€‚ å››ã€æ€»ç»“å…³äºallocã€initä»¥åŠnewçš„æºç åˆ†æå°±åˆ°è¿™äº†ã€‚åœ¨allocçš„è¿‡ç¨‹ä¸­ï¼ŒcallAllocå’Œ_class_createInstanceFromZoneè¿™ä¸¤ä¸ªå‡½æ•°æ˜¯é‡ç‚¹ã€‚ ä»¥ä¸Šæºç æµç¨‹åˆ†æï¼Œæ˜¯å»ºç«‹åœ¨objc4-756.2æºç çš„åŸºç¡€ä¸Šçš„ï¼Œ756.2æ˜¯ç›®å‰æœ€æ–°çš„ç‰ˆæœ¬ã€‚ ä¸‹é¢ç”¨æµç¨‹å›¾æ€»ç»“ä¸€ä¸‹allocåˆ›å»ºå¯¹è±¡çš„è¿‡ç¨‹ï¼šï¼ˆè¿™æ˜¯æˆ‘çœ‹è¿‡çš„åšå®¢ä¸­ï¼Œæœ€å‡†ç¡®çš„å›¾ï¼‰ äº”ã€æºç æˆ‘çš„ malloc æºç  æˆ‘çš„ libobjc æºç  è‹¹æœå®˜æ–¹ objc4 æºç  å‚è€ƒçº¢é…’ç‰›æ’ https://juejin.im/post/6844904038467633160#heading-15","link":"/2020/10/29/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/01-%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%88%9B%E5%BB%BA/"},{"title":"07ä¸Š-é€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶å’ŒMach-Oæ–‡ä»¶","text":"å‰è¨€è¦ç ”ç©¶dyldçš„åŠ è½½æµç¨‹ï¼Œé¦–å…ˆè¦äº†è§£é€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶å’ŒMach-Oæ–‡ä»¶ã€‚ ä¸€ã€é€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶1.1 ç®€ä»‹é€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆMach-O Universal Filesï¼‰å°†å¤šç§æ¶æ„çš„Mach-Oæ–‡ä»¶åˆå¹¶è€Œæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ WWDC ç¤ºä¾‹å›¾ï¼š ä½¿ç”¨ MachOView è½¯ä»¶æŸ¥çœ‹ä¸€ä¸ªé€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶ï¼š å¯ä»¥çœ‹åˆ°é€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶åŒ…å«ï¼š 1.Fat Headerï¼šè®°å½•ä¸åŒæ¶æ„åœ¨æ–‡ä»¶ä¸­çš„åç§»é‡ 2.ä¸åŒæ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶â€”Mach O 1.2 æ“ä½œé€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶1.2.1 æŸ¥çœ‹è‹¹æœè‡ªå®¶ç³»ç»Ÿä¸­å­˜åœ¨ç€å¾ˆå¤šé€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶ã€‚æ¯”å¦‚/usr/bin/pythonï¼Œåœ¨ç»ˆç«¯ä¸­æ‰§è¡Œfileå‘½ä»¤å¯ä»¥æŸ¥çœ‹å®ƒçš„ä¿¡æ¯ï¼š 1234$ file /usr/bin/python/usr/bin/python: Mach-O universal binary with 2 architectures: [x86_64:Mach-O 64-bit executable x86_64] [arm64e:Mach-O 64-bit executable arm64e]/usr/bin/python (for architecture x86_64): Mach-O 64-bit executable x86_64/usr/bin/python (for architecture arm64e): Mach-O 64-bit executable arm64e 1.2.2 æå–ç³»ç»Ÿæä¾›äº†ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·lipoæ¥æ“ä½œé€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶ã€‚å¯ä»¥æ·»åŠ ã€æå–ã€åˆ é™¤ä»¥åŠæ›¿æ¢é€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ç‰¹å®šæ¶æ„çš„äºŒè¿›åˆ¶ç‰ˆæœ¬ã€‚ ä¾‹å¦‚æå– python ä¸­ x86_64 ç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶å¯ä»¥æ‰§è¡Œï¼š 1$ lipo /usr/bin/python -extract x86_64 -output ~/Desktop/python.x64 1.2.3 åˆ é™¤åˆ é™¤ x86 ç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶å¯ä»¥æ‰§è¡Œï¼š 1$ lipo /usr/bin/python -remove i386 -output ~/Desktop/python.x64 1.2.4 ç˜¦èº«æˆ–è€…ç›´æ¥ç˜¦èº«ä¸º x86_64 ç‰ˆæœ¬ï¼š 1$ lipo /usr/bin/python -thin x86_64 -output ~/Desktop/python.x64 äºŒã€Mach-Oæ–‡ä»¶2.1 ç®€ä»‹Mach-Oæ˜¯Mach Objectæ–‡ä»¶æ ¼å¼çš„ç¼©å†™ï¼Œæ˜¯macä»¥åŠiOSä¸Šå¯æ‰§è¡Œæ–‡ä»¶çš„æ ¼å¼ã€‚ 2.2 åˆ†ç±»å¸¸è§çš„MachOæ–‡ä»¶ï¼š ç›®æ ‡æ–‡ä»¶.o åº“æ–‡ä»¶ .a .dylib .Framework å¯æ‰§è¡Œæ–‡ä»¶ dyldï¼ˆåŠ¨æ€é“¾æ¥å™¨ï¼‰ .dsymï¼ˆç¬¦å·è¡¨ï¼šReleseç¯å¢ƒè¿è¡Œç”Ÿæˆï¼‰ 2.3 ç»“æ„ é€šè¿‡ä¸Šå›¾ï¼Œå¯ä»¥çœ‹å‡ºMach-Oä¸»è¦ç”±ä»¥ä¸‹ä¸‰éƒ¨åˆ†ç»„æˆï¼š Header Load commands Data 2.3.1 HeaderheaderåŒ…å«äº†è¯¥äºŒè¿›åˆ¶æ–‡ä»¶çš„å­—èŠ‚é¡ºåºã€æ¶æ„ç±»å‹ã€åŠ è½½æŒ‡ä»¤çš„æ•°é‡ç­‰ï¼Œä½¿å¾—å¯ä»¥å¿«é€Ÿç¡®è®¤ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚å½“å‰æ–‡ä»¶ç”¨äº32ä½è¿˜æ˜¯64 ä½ï¼Œå¯¹åº”çš„å¤„ç†å™¨æ˜¯ä»€ä¹ˆã€æ–‡ä»¶ç±»å‹æ˜¯ä»€ä¹ˆã€‚ Xcodeä¸­ shift+command+O-&gt;load.h-&gt;å¦‚ä¸‹ä¿¡æ¯ 12345678910struct mach_header_64 { uint32_t magic; /* é­”æ•°,å¿«é€Ÿå®šä½64ä½/32ä½ */ cpu_type_t cputype; /* cpu ç±»å‹ æ¯”å¦‚ ARM */ cpu_subtype_t cpusubtype; /* cpu å…·ä½“ç±»å‹ æ¯”å¦‚arm64 , armv7 */ uint32_t filetype; /* æ–‡ä»¶ç±»å‹ ä¾‹å¦‚å¯æ‰§è¡Œæ–‡ä»¶ .. */ uint32_t ncmds; /* load commands åŠ è½½å‘½ä»¤æ¡æ•° */ uint32_t sizeofcmds; /* load commands åŠ è½½å‘½ä»¤å¤§å°*/ uint32_t flags; /* æ ‡å¿—ä½æ ‡è¯†äºŒè¿›åˆ¶æ–‡ä»¶æ”¯æŒçš„åŠŸèƒ½ , ä¸»è¦æ˜¯å’Œç³»ç»ŸåŠ è½½ã€é“¾æ¥æœ‰å…³*/ uint32_t reserved; /* reserved , ä¿ç•™å­—æ®µ */}; 2.3.2 Load commandsæ˜¯ä¸€å¼ åŒ…æ‹¬åŒºåŸŸçš„ä½ç½®ã€ç¬¦å·è¡¨ã€åŠ¨æ€ç¬¦å·è¡¨ç­‰å†…å®¹çš„è¡¨ã€‚ å®ƒè¯¦ç»†ä¿å­˜ç€åŠ è½½æŒ‡ä»¤çš„å†…å®¹ï¼Œå‘Šè¯‰é“¾æ¥å™¨å¦‚ä½•å»åŠ è½½è¿™ä¸ª Mach-O æ–‡ä»¶ã€‚ æŸ¥çœ‹MachOViewä¸­çš„loadcommandsï¼š åç§° å†…å®¹ LC_SEGMENT_64 å°†æ–‡ä»¶ä¸­ï¼ˆ32ä½æˆ–64ä½ï¼‰çš„æ®µæ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ä¸­ LC_DYLD_INFO_ONLY åŠ¨æ€é“¾æ¥ç›¸å…³ä¿¡æ¯ LC_SYMTAB ç¬¦å·åœ°å€ LC_DYSYMTAB åŠ¨æ€é“¾æ¥ç›¸å…³ä¿¡æ¯ LC_LOAD_DYLINKER åŠ¨æ€é“¾æ¥ç›¸å…³ä¿¡æ¯ LC_UUID åŠ¨æ€é“¾æ¥ç›¸å…³ä¿¡æ¯ LC_VERSION_MIN_MACOSX æ”¯æŒæœ€ä½çš„æ“ä½œç³»ç»Ÿç‰ˆæœ¬ LC_SOURCE_VERSION æºä»£ç ç‰ˆæœ¬ LC_MAIN è®¾ç½®ç¨‹åºä¸»çº¿ç¨‹çš„å…¥å£åœ°å€å’Œæ ˆå¤§å° LC_LOAD_DYLIB ä¾èµ–åº“çš„è·¯å¾„ï¼ŒåŒ…å«ä¸‰æ–¹åº“ LC_FUNCTION_STARTS å‡½æ•°èµ·å§‹åœ°å€è¡¨ LC_CODE_SIGNATURE ä»£ç ç­¾å 2.3.3 Datadataæ˜¯ MachO æ–‡ä»¶ä¸­æœ€å¤§çš„éƒ¨åˆ†ï¼ŒåŒ…å«_TEXTæ®µã€_DATAæ®µã€‚ _TEXTæ®µ åç§° ä½œç”¨ _text ä¸»ç¨‹åºä»£ç  _stubsã€_stub_helper åŠ¨æ€é“¾æ¥ _objc_methodname æ–¹æ³•åç§° _objc_classname ç±»åç§° _objc_methtype æ–¹æ³•ç±»å‹(v@:) _cstring é™æ€å­—ç¬¦ä¸²å¸¸é‡ _DATAæ®µ åç§° ä½œç”¨ _got éæ‡’åŠ è½½ç¬¦å·è¡¨ _la_symbol_ptr æ‡’åŠ è½½ç¬¦å·è¡¨ _objc_classlist æ–¹æ³•åç§° â€¦ â€¦ ä¸‰ã€è¡¥å……ï¼šé™æ€åº“å’ŒåŠ¨æ€åº“çš„åŒºåˆ«é™æ€åº“ï¼š åŠ¨æ€åº“ï¼š é€šè¿‡ä¸Šé¢ä¸¤å¹…å›¾æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼š é™æ€åº“è¡¨ç°ä¸ºï¼šåœ¨é“¾æ¥é˜¶æ®µä¼šå°†æ±‡ç¼–ç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶ä¸å¼•ç”¨çš„åº“ä¸€èµ·é“¾æ¥æ‰“åŒ…è¿›å¯æ‰§è¡Œæ–‡ä»¶ä¸­ã€‚ã€ç®€å•æ¥è¯´å°±æ˜¯æŠŠåº“ä¸€èµ·æ‰“åˆ°ä»£ç ä¸­ã€‘ åŠ¨æ€åº“è¡¨ç°ä¸ºï¼šç¨‹åºç¼–è¯‘å¹¶ä¸ä¼šæŠŠåº“æ‰“åŒ…åˆ°ç›®æ ‡ä»£ç ä¸­ï¼Œåœ¨ç¨‹åºå¯æ‰§è¡Œæ–‡ä»¶é‡Œé¢ä¼šä¿ç•™å¯¹åŠ¨æ€åº“çš„å¼•ç”¨ã€‚å…¶ä¸­ï¼ŒåŠ¨æ€åº“åˆ†ä¸ºåŠ¨æ€é“¾æ¥åº“å’ŒåŠ¨æ€åŠ è½½åº“ã€‚ã€ç®€å•æ¥è¯´å°±æ˜¯ä¸æŠŠåº“æ‰“åˆ°ä»£ç ä¸­ï¼Œåœ¨ä»£ç ä¸­ä¿ç•™å¯¹åº“çš„å¼•ç”¨ã€‘ åŠ¨æ€é“¾æ¥åº“ï¼šå½“å¯æ‰§è¡Œæ–‡ä»¶è¢«åŠ è½½æ—¶ï¼ŒåŠ¨æ€åº“ä¹Ÿéšç€è¢«åŠ è½½åˆ°å†…å­˜ä¸­ã€‚ã€éšç€ç¨‹åºå¯åŠ¨è€Œå¯åŠ¨ã€‘ åŠ¨æ€åŠ è½½åº“ï¼šå½“éœ€è¦çš„æ—¶å€™å†é€šè¿‡ä»£ç æˆ–è€…å‘½ä»¤çš„æ–¹å¼æ¥åŠ è½½ã€‚ã€åœ¨ç¨‹åºå¯åŠ¨ä¹‹åï¼Œç”¨åˆ°å†å»å¯åŠ¨ã€‘ å‚è€ƒiOSé€†å‘ MachOæ–‡ä»¶ Mach-O Mach-Oå¯æ‰§è¡Œæ–‡ä»¶ iOS åº•å±‚æ¢ç´¢ - åº”ç”¨åŠ è½½","link":"/2021/01/15/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/07%E4%B8%8A-%E9%80%9A%E7%94%A8%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E5%92%8CMach-O%E6%96%87%E4%BB%B6/"},{"title":"10-åº•å±‚é¢è¯•ç­”ç–‘","text":"ä¸€ã€ä»€ä¹ˆæ˜¯ Runtimeç­”ï¼šç”¨ Cã€C++ã€æ±‡ç¼–å®ç°çš„ä¸€å¥— APIï¼Œä¸º OC è¯­è¨€åŠ å…¥äº†é¢å‘å¯¹è±¡å’Œè¿è¡Œæ—¶çš„åŠŸèƒ½ã€‚ åº”ç”¨ä¸¾ä¾‹ï¼š ç±»çš„ ro å’Œ rw å±æ€§ï¼Œro(read-only)åœ¨ç¼–è¯‘æœŸå°±ç¡®å®šå¥½äº†ï¼Œè€Œ rw(read-write)æ˜¯åœ¨è¿è¡Œæ—¶æ‰å®Œå…¨èµ‹å€¼ã€‚ äºŒã€æ–¹æ³•çš„æœ¬è´¨æ˜¯ä»€ä¹ˆç­”ï¼šæ–¹æ³•çš„æœ¬è´¨å°±æ˜¯æ¶ˆæ¯çš„å‘é€ï¼Œå°±æ˜¯åœ¨åº•å±‚è°ƒç”¨_objc_msgSenndæ–¹æ³•å¯»æ‰¾æ–¹æ³•IMPçš„è¿‡ç¨‹ï¼Œä¸»è¦ç»å†äº†ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š å¿«é€ŸæŸ¥æ‰¾æµç¨‹ï¼šé€šè¿‡æ±‡ç¼–ï¼ˆobjc_msgSendï¼‰æŸ¥æ‰¾cache_tä¸­ç¼“å­˜çš„æ¶ˆæ¯ï¼Œæ‰¾åˆ°å°±è¿”å›impï¼Œæ‰¾ä¸åˆ°å°±è¿›è¡Œæ…¢é€ŸæŸ¥æ‰¾ã€‚ æ…¢é€ŸæŸ¥æ‰¾æµç¨‹ï¼šé€šè¿‡å‡½æ•°lookUpImpOrForwardé€’å½’æŸ¥æ‰¾å½“å‰ç±»å’Œçˆ¶ç±»çš„ç¼“å­˜å’Œæ–¹æ³•åˆ—è¡¨ï¼Œå¦‚æœæ‰¾åˆ°äº†å°±ä¼šç¼“å­˜æ–¹æ³•æ–¹ä¾¿å¿«é€ŸæŸ¥æ‰¾ï¼Œæ‰¾ä¸åˆ°å°±ä¼šè¿›è¡ŒåŠ¨æ€æ–¹æ³•è§£æ åŠ¨æ€æ–¹æ³•è§£æï¼šæ­¤æ—¶OCä¼šç»™æˆ‘ä»¬ä¸€æ¬¡å¯¹selçš„å¤„ç†æœºä¼šï¼Œä½ å¯ä»¥åœ¨resolveInstanceMethod:ï¼ˆç±»æ–¹æ³•å¯¹åº”resolveClassMethod:ï¼‰ä¸­æ·»åŠ ä¸€ä¸ªIMP å¦‚æœä½ æ²¡æŠŠæ¡ä½è¿™æ¬¡æœºä¼šï¼Œä¹Ÿå°±æ˜¯è§£æå¤±è´¥æ—¶ï¼Œä¼šæ¥åˆ°æ¶ˆæ¯è½¬å‘é˜¶æ®µï¼Œè¿™ä¸ªé˜¶æ®µæœ‰ä¸¤ä¸ªæœºä¼šå»å¤„ç†selï¼Œåˆ†åˆ«æ˜¯å¿«é€Ÿè½¬å‘çš„forwardingTargetForSelector:ï¼Œä»¥åŠæ…¢é€Ÿè½¬å‘çš„methodSignatureForSelector:ã€‚ æ¶ˆæ¯å¿«é€Ÿè½¬å‘ï¼šforwardingTargedForSelectorï¼Œå¦‚æœæœ‰å¤„ç†ï¼Œå°±äº¤ç»™å¤„ç†çš„å¯¹è±¡æ¥å®ç°ï¼Œæ²¡æœ‰å°±äº¤ç»™å…¶ä»–å¯¹è±¡å¤„ç†ï¼Œè¿›å…¥æ…¢é€Ÿè½¬å‘é˜¶æ®µã€‚ æ¶ˆæ¯æ…¢é€Ÿè½¬å‘ï¼šmethodSignatureForSelectorï¼Œè¿›è¡Œæ–¹æ³•ç­¾åï¼ŒæŠŠæ–¹æ³•ä¸¢å‡ºå»ï¼ŒforwardInvocationæ¥å¯¹æ¶ˆæ¯å¤„ç†ã€‚ æœªæ‰¾åˆ°æ¶ˆæ¯ï¼šæ— æ³•æ‰¾åˆ°IMPï¼Œå°±è¿›å…¥åˆ°äº†doesNotRecognizeSelectoræŠ¥é”™ï¼Œæ‰“å°log ä¸‰ã€sel æ˜¯ä»€ä¹ˆï¼ŸIMP æ˜¯ä»€ä¹ˆï¼Ÿä¸¤è€…ä¹‹é—´çš„å…³ç³»ï¼Ÿç­”ï¼š SELæ˜¯æ–¹æ³•ç¼–å·ï¼Œä¹Ÿæ˜¯æ–¹æ³•åï¼Œåœ¨dyldåŠ è½½é•œåƒå¸¦å†…å­˜æ—¶ï¼Œé€šè¿‡_read_imageæ–¹æ³•åŠ è½½åˆ°å†…å­˜çš„è¡¨ä¸­äº† IMP å°±æ˜¯æˆ‘ä»¬å‡½æ•°å®ç°æŒ‡é’ˆ ï¼Œæ‰¾IMPå°±æ˜¯æ‰¾å‡½æ•°çš„è¿‡ç¨‹ å‡½æ•°å°±æ˜¯å¯¹åº”çš„å®ç°å†…å®¹ å››ã€èƒ½å¦å‘è¿â¾æ—¶åˆ›å»ºçš„ç±»ä¸­æ·»åŠ æˆå‘˜å˜é‡ï¼Ÿç­”ï¼šä¸èƒ½ã€‚ åŸå› ï¼š 1234567891011121314151617181920struct class_ro_t { uint32_t flags; uint32_t instanceStart; uint32_t instanceSize;#ifdef __LP64__ uint32_t reserved;#endif const uint8_t * ivarLayout; const char * name; method_list_t * baseMethodList; // æ–¹æ³•åˆ—è¡¨ protocol_list_t * baseProtocols; // åè®®åˆ—è¡¨ const ivar_list_t * ivars; // æˆå‘˜å˜é‡åˆ—è¡¨ const uint8_t * weakIvarLayout; property_list_t *baseProperties; // å±æ€§åˆ—è¡¨ ...} 12345678910111213struct class_rw_t { // Be warned that Symbolication knows the layout of this structure. uint32_t flags; uint32_t version; const class_ro_t *ro; method_array_t methods; // æ–¹æ³•åˆ—è¡¨ property_array_t properties; // å±æ€§åˆ—è¡¨ protocol_array_t protocols; // åè®®åˆ—è¡¨ ...} å› ä¸ºæˆ‘ä»¬ç¼–è¯‘å¥½çš„æˆå‘˜å˜é‡å­˜å‚¨çš„ä½ç½®åœ¨ç±»çš„roä¸­ï¼Œâ¼€æ—¦ç¼–è¯‘å®Œæˆï¼Œå†…å­˜ç»“æ„å°±å®Œå…¨ç¡®å®šâ½†æ³•ä¿®æ”¹ï¼Œåªèƒ½ä¿®æ”¹ç±»çš„rwä¸­çš„æ–¹æ³•æˆ–è€…å¯ä»¥é€šè¿‡å…³è”å¯¹è±¡çš„æ–¹å¼æ¥æ·»åŠ å±æ€§ã€‚ å…³è”å¯¹è±¡æ·»åŠ çš„ä¸»è¦æ­¥éª¤å¦‚ä¸‹ï¼š objc_setAssociatedObjectè®¾ç½®setæ–¹æ³•ï¼šæ‰¾åˆ°å…³è”å¯¹è±¡çš„æ€»å“ˆå¸Œè¡¨ï¼Œç„¶åé€šè¿‡æŒ‡é’ˆåœ°å€æ‰¾åˆ°è¯¥ç±»çš„å“ˆå¸Œè¡¨ï¼Œç„¶åé€šè¿‡keyå€¼è¿›è¡Œå­˜å‚¨ objc_getAssociatedObjectè®¾ç½®getæ–¹æ³•ï¼šå’Œsetæ–¹æ³•ä¸€æ ·æŸ¥è¯¢è¡¨ï¼Œæ‰¾åˆ°å€¼ åœ¨ç±»çš„deallocä¼šæ¸…é™¤å…³è”å¯¹è±¡çš„å“ˆå¸Œè¡¨ äº”ã€isKindOfClass å’Œ isMemberOfClassçš„åŒºåˆ«ç­”ï¼šå½“è°ƒç”¨è€…å¯¹è±¡æ˜¯å®ä¾‹å¯¹è±¡æ—¶ï¼šã€å¸¸ç”¨ã€‘ -isKindOfClassï¼šåˆ¤æ–­è°ƒç”¨è€…å¯¹è±¡æ˜¯å¦æ˜¯xxç±»ä»¥åŠä»–çš„å­ç±»çš„å®ä¾‹-isMemberOfClassï¼šåˆ¤æ–­è°ƒç”¨è€…å¯¹è±¡æ˜¯å¦æ˜¯xxç±»çš„å®ä¾‹ å½“è°ƒç”¨è€…å¯¹è±¡æ˜¯ç±»å¯¹è±¡æ—¶ï¼šã€å¯å¿½ç•¥ã€‘ +isKindOfClassï¼šåˆ¤æ–­å½“å‰ç±»å¯¹è±¡çš„å…ƒç±»å¯¹è±¡åŠå…¶çˆ¶ç±»çš„å…ƒç±»å¯¹è±¡æ˜¯å¦ç­‰äºä¼ å…¥çš„å¯¹è±¡ +isMemberOfClassï¼šåˆ¤æ–­å½“å‰ç±»å¯¹è±¡çš„å…ƒç±»å¯¹è±¡æ˜¯å¦ç­‰äºä¼ å…¥çš„è¿™ä¸ªå¯¹è±¡ åŸç†æ¢ç©¶ï¼šä¸¾ä¾‹ï¼š 1.æ¶ˆæ¯æ¥æ”¶è€…æ˜¯å®åŠ›å¯¹è±¡-&gt;è°ƒç”¨å¯¹è±¡æ–¹æ³• 12345BOOL re5 = [(id)[NSObject alloc] isKindOfClass:[NSObject class]]; // 1BOOL re6 = [(id)[NSObject alloc] isMemberOfClass:[NSObject class]]; // 1BOOL re7 = [(id)[LGPerson alloc] isKindOfClass:[LGPerson class]]; // 1BOOL re8 = [(id)[LGPerson alloc] isMemberOfClass:[LGPerson class]]; // 1NSLog(@&quot; re5 :%hhd\\n re6 :%hhd\\n re7 :%hhd\\n re8 :%hhd\\n&quot;,re5,re6,re7,re8); ä¸Šè¿°Logçš„æ‰“å°ç»“æœä¸º1ï¼Œ0ï¼Œ0ï¼Œ0 2.æ¶ˆæ¯æ¥æ”¶è€…æ˜¯ç±»å¯¹è±¡-&gt;è°ƒç”¨ç±»æ–¹æ³• 12345BOOL re1 = [(id)[NSObject class] isKindOfClass:[NSObject class]]; // 1BOOL re2 = [(id)[NSObject class] isMemberOfClass:[NSObject class]]; // 0BOOL re3 = [(id)[LGPerson class] isKindOfClass:[LGPerson class]]; // 0BOOL re4 = [(id)[LGPerson class] isMemberOfClass:[LGPerson class]]; // 0NSLog(@&quot; re1 :%hhd\\n re2 :%hhd\\n re3 :%hhd\\n re4 :%hhd\\n&quot;,re1,re2,re3,re4); ä¸Šè¿°Logçš„æ‰“å°ç»“æœä¸º1ï¼Œ1ï¼Œ1ï¼Œ1 å¯¹äºç¬¬1ä¸ªä¾‹å­ï¼Œå¤§å®¶éƒ½ä½¿ç”¨çš„éå¸¸ç†Ÿç»ƒï¼Œä½†æ˜¯å¯¹äºç¬¬2ä¸ªä¾‹å­çš„æ‰“å°ç»“æœå°±æœ‰äº›çº³é—·äº†ã€‚æˆ‘ä»¬å‘ç°ä¸¤ä¸ªä¾‹å­çš„ä¸»è¦åŒºåˆ«åœ¨äºæ¶ˆæ¯æ¥å—è€…æ˜¯å®ä¾‹å¯¹è±¡è¿˜æ˜¯ç±»å¯¹è±¡ã€‚ å…¶å®è¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯æœ‰å¯¹åº”çš„ç±»æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•çš„ï¼Œåªä¸è¿‡æˆ‘ä»¬å¹³æ—¶ä¸ä½¿ç”¨ç±»æ–¹æ³•è€Œå·²ï¼ŒæŸ¥çœ‹æºç ï¼š 123456789101112/************************************************************************ object_getClass.* Locking: None. If you add locking, tell gdb (rdar://7516456).**********************************************************************/// object_getClass()æ–¹æ³•å–å¾—çš„æ˜¯å¯¹è±¡çš„isaæŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡// å¯¹äºå¯¹è±¡æ¥è¯´å°±æ˜¯è·å–åˆ°ä»–çš„ç±»// å¯¹äºç±»å¯¹è±¡æ¥è¯´å°±æ˜¯è·å–åˆ°ä»–çš„å…ƒç±»Class object_getClass(id obj){ if (obj) return obj-&gt;getIsa(); else return Nil;} 12345678910111213141516171819202122232425// åˆ¤æ–­å½“å‰ç±»å¯¹è±¡çš„å…ƒç±»å¯¹è±¡æ˜¯å¦ä¸ä¼ å…¥çš„è¿™ä¸ªå¯¹è±¡ç›¸ç­‰ï¼Œæ‰€ä»¥è¿™ä¸ªclsåº”è¯¥æ˜¯å…ƒç±»å¯¹è±¡æ‰æœ‰å¯èƒ½ä¸º true+ (BOOL)isMemberOfClass:(Class)cls {return object_getClass((id)self) == cls;}// åˆ¤æ–­å½“å‰å®ä¾‹å¯¹è±¡çš„ç±»å¯¹è±¡æ˜¯å¦ä¸ä¼ å…¥çš„å¯¹è±¡ç›¸ç­‰ï¼Œæ‰€ä»¥clsåªæœ‰å¯èƒ½æ˜¯ç±»å¯¹è±¡æ‰æœ‰å¯èƒ½ç›¸ç­‰- (BOOL)isMemberOfClass:(Class)cls {return [self class] == cls;}// å¾ªç¯åˆ¤æ–­å½“å‰ç±»å¯¹è±¡çš„å…ƒç±»å¯¹è±¡åŠå…¶çˆ¶ç±»çš„å…ƒç±»å¯¹è±¡æ˜¯å¦ç­‰äºä¼ å…¥çš„cls+ (BOOL)isKindOfClass:(Class)cls { for (Class tcls = object_getClass((id)self); tcls; tcls = tcls-&gt;superclass) { if (tcls == cls) return YES; } return NO;}// å¾ªç¯åˆ¤æ–­å½“å‰å®ä¾‹å¯¹è±¡çš„çˆ¶ç±»çš„ç±»å¯¹è±¡æ˜¯å¦ç­‰äºä¼ å…¥çš„å¯¹è±¡clsï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­å®ä¾‹å¯¹è±¡æ˜¯å¦æ˜¯clsåŠå…¶å­ç±»çš„ä¸€ç§- (BOOL)isKindOfClass:(Class)cls { for (Class tcls = [self class]; tcls; tcls = tcls-&gt;superclass) { if (tcls == cls) return YES; } return NO;} æ‰€ä»¥ï¼Œå¦‚æœæ–¹æ³•è°ƒç”¨è€…æ˜¯å®ä¾‹å¯¹è±¡ï¼Œé‚£ä¹ˆä¼ å…¥çš„å°±åº”è¯¥æ˜¯ç±»å¯¹è±¡ï¼›å¦‚æœæ–¹æ³•è°ƒç”¨è€…æ˜¯ç±»å¯¹è±¡ï¼Œé‚£ä¹ˆä¼ å…¥çš„å°±åº”è¯¥æ˜¯å…ƒç±»å¯¹è±¡ã€‚ å…­ã€[self class]ã€[super class]ã€[self superclass]çš„åŒºåˆ«ä»¥åŠåŸç†åˆ†æç»“è®º class:è·å–å½“å‰æ–¹æ³•è°ƒç”¨è€…çš„ç±» superclass:è·å–å½“å‰æ–¹æ³•è°ƒç”¨è€…çš„çˆ¶ç±» super:æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œç»“æ„ä½“ä¸­æ¶ˆæ¯æ¥æ”¶è€…è¿˜æ˜¯å½“å‰å¯¹è±¡ï¼Œæ‰€ä»¥å°±ä¼šè®©å½“å‰å¯¹è±¡å»è°ƒç”¨çˆ¶ç±»æ–¹æ³•ï¼Œæœ¬è´¨è¿˜æ˜¯å½“å‰å¯¹è±¡åœ¨è°ƒç”¨ ä¾‹åˆ›å»ºä¸€ä¸ªStudentç±»ç»§æ‰¿å­Personç±»ï¼ŒæŸ¥çœ‹æ‰“å°ï¼š 1234NSLog(@&quot;[self class] = %@&quot;, [self class]); // [self class] = StudentNSLog(@&quot;[super class] = %@&quot;, [super class]); // [super class] = StudentNSLog(@&quot;[self superclass] = %@&quot;, [self superclass]); // [self superclass] = PersonNSLog(@&quot;[super superclass] = %@&quot;, [super superclass]);// [super superclass] = Person åŸç†å…ˆä¸Šæºç çœ‹ä¸€ä¸‹ç¬¬ä¸€ä¸ªå’Œç¬¬ä¸‰ä¸ªçš„ç†è§£ 1234567891011121314151617181920212223242526272829303132 // object_getClass()æ–¹æ³•å–å¾—çš„æ˜¯å¯¹è±¡çš„isaæŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ // å¯¹äºå¯¹è±¡æ¥è¯´å°±æ˜¯è·å–åˆ°ä»–çš„ç±» // å¯¹äºç±»å¯¹è±¡æ¥è¯´å°±æ˜¯è·å–åˆ°ä»–çš„å…ƒç±» Class object_getClass(id obj) { if (obj) return obj-&gt;getIsa(); else return Nil; } + (Class)class { return self; } - (Class)class { return object_getClass(self); } + (Class)superclass { return self-&gt;superclass; } - (Class)superclass { return [self class]-&gt;superclass; }Class class_getSuperclass(Class cls){ if (!cls) return nil; return cls-&gt;superclass;} æˆ‘ä»¬çŸ¥é“ï¼Œè¿™é‡Œæ–¹æ³•ä¸­çš„selféƒ½æ˜¯æŒ‡æ¶ˆæ¯çš„æ¥å—è€…ï¼Œåœ¨è¿™é‡Œå°±è¡¨ç¤ºStudentç±»ï¼Œæ ¹æ®ä»¥ä¸Šæºç ï¼Œç¬¬ä¸€ä¸ªå’Œç¬¬ä¸‰ä¸ªæ²¡å•¥ç–‘é—®ï¼Œéƒ½æ˜¯å¯»æ‰¾Studentçš„isaå’Œçˆ¶ç±»ã€‚ é‚£ä¹ˆsuperè°ƒç”¨æ—¶ï¼Œæœ‰å•¥ä¸åŒï¼Œæˆ‘ä»¬éœ€è¦å…ˆçŸ¥é“superçš„æœ¬è´¨ é€šè¿‡clangç¼–è¯‘ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåº•å±‚è°ƒç”¨æ—¶superè°ƒç”¨çš„æ–¹æ³•ä¸æ˜¯msgSend,è€Œæ˜¯objc_msgSendSuper(object ,superclass, @selector(class))ï¼Œä¼ å…¥äº†ä¸€ä¸ªsuperçš„ç»“æ„ä½“å’Œæ–¹æ³•ã€‚ æˆ‘ä»¬çŸ¥é“æ¶ˆæ¯å‘é€çš„æ—¶å€™ï¼Œæ…¢é€ŸæŸ¥æ‰¾æµç¨‹æ˜¯éœ€è¦ä»è‡ªèº«é€’å½’æŸ¥æ‰¾åˆ°NSObjectçš„ï¼Œè€Œobjc_msgSendSuperå°±è¡¨ç¤ºç›´æ¥ä»æ¶ˆæ¯æ¥å—è€…çš„çˆ¶ç±»å¼€å§‹é€’å½’æŸ¥æ‰¾ï¼Œè·³è¿‡äº†æœ¬èº«çš„æ–¹æ³•åˆ—è¡¨ï¼Œè¿™æ ·æŸ¥æ‰¾çš„é€Ÿåº¦å¯ä»¥æ›´å¿«ã€‚ superçš„ç»“æ„ä½“å¦‚ä¸‹ 1234struct objc_super { __unsafe_unretained _Nonnull id receiver; __unsafe_unretained _Nonnull Class super_class;}; ä¸¤ä¸ªå‚æ•°åˆ†åˆ«ä¸ºæ¶ˆæ¯çš„æ¥å—è€…å’Œçˆ¶ç±»ï¼Œåœ¨è¿™é‡ŒStudentå³ä¸ºæ¶ˆæ¯æ¥å—è€…,Personä¸ºçˆ¶ç±». æ‰€ä»¥è°ƒç”¨[super class]å’Œ[super superclass]æœ¬è´¨ä¸Šæ¶ˆæ¯çš„æ¥å—è€…è¿˜æ˜¯selfï¼Œå³Studentç±»ã€‚æ‰€ä»¥å°±è·Ÿç¬¬ä¸€ä¸ªå’Œç¬¬ä¸‰ä¸ªç»“æœæ²¡æœ‰åŒºåˆ«ã€‚ å°ç»“[self class] å°±æ˜¯å‘é€æ¶ˆæ¯objc_msgSendï¼Œæ¶ˆæ¯æ¥å—è€…æ˜¯ self,â½…æ³•ç¼–å·ï¼šclass [super class] æœ¬è´¨å°±æ˜¯objc_msgSendSuper, æ¶ˆæ¯çš„æ¥å—è€…è¿˜æ˜¯ self â½…æ³•ç¼–å·ï¼šclass(çˆ¶ç±»çš„) åªæ˜¯objc_msgSendSuper ä¼šæ›´å¿« ç›´æ¥è·³è¿‡ self çš„æŸ¥æ‰¾,ä½†æ˜¯éƒ½ä¼šèµ°åˆ°NSObjectåŸºç±»çš„å®ç°æ–¹æ³•ä¸­ï¼Œä½†æ˜¯éƒ½æ˜¯ä»¥selfä¸ºæ¥å—è€… ä¸ƒã€Runtime æ˜¯å¦‚ä½•å®ç° weak çš„ï¼Œä¸ºä»€ä¹ˆå¯ä»¥â¾ƒåŠ¨ç½® nilï¼Ÿä¸»è¦æ€»ç»“å¦‚ä¸‹ï¼š é€šè¿‡SideTableæ‰¾åˆ°æˆ‘ä»¬çš„weak_table weak_table æ ¹æ®referent æ‰¾åˆ°æˆ–è€…åˆ›å»º weak_entry_t ç„¶åappend_referrer(entry, referrer)å°†æ–°å¼±å¼•â½¤çš„å¯¹è±¡åŠ è¿›å»entry æœ€åweak_entry_insert æŠŠentryåŠ â¼Šåˆ°æˆ‘ä»¬çš„weak_table åœ¨ç±»deallocæ—¶ï¼Œä¼šæ ¹æ®æ’å…¥çš„æ­¥éª¤æ‰¾åˆ°å¯¹åº”çš„å¼±å¼•ç”¨ï¼Œå¹¶ç½®ä¸ºnil å…³äºweakçš„ç›¸å…³çŸ¥è¯†åšäº†å•ç‹¬çš„æ€»ç»“ï¼Œè¯¦æƒ…å¯ä»¥çœ‹ä¸‹æ–¹æ–‡ç« ğŸ‘‡ 11-weakåŸç†æ¢ç©¶ å…«ã€Method Swizzling çš„å‘ä¸åº”â½¤è¯¦æƒ…å¯ä»¥çœ‹ä¸‹é¢çš„æ–‡ç« ï¼š 12-Method Swizzlingçš„å‘ä¸åº”ç”¨ å‚è€ƒiOSåº•å±‚å­¦ä¹  - Runtimeä¹‹ç –å‚é¢è¯•ç­”ç–‘","link":"/2021/02/16/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/10-%E5%BA%95%E5%B1%82%E9%9D%A2%E8%AF%95%E7%AD%94%E7%96%91/"},{"title":"ç™¾åº¦ç§»åŠ¨ç»Ÿè®¡é”™è¯¯æŠ¥å‘Šçš„ä½¿ç”¨","text":"linkï¼š https://mtj.baidu.com/web/dashboard ç»ˆç«¯å‘½ä»¤ï¼š 1xcrun atos --arch arm64 -o +åŒ…è·¯å¾„ -l åŸºåœ°å€+å›è½¦+åç§»åœ°å€+å›è½¦ åŒ…è·¯å¾„ åŸºåœ°å€ &amp; åç§»åœ°å€","link":"/2020/10/19/iOS%C2%B7%E8%B4%A8%E9%87%8F&%E6%95%88%E7%8E%87/%E7%99%BE%E5%BA%A6%E7%A7%BB%E5%8A%A8%E7%BB%9F%E8%AE%A1%E9%94%99%E8%AF%AF%E6%8A%A5%E5%91%8A%E7%9A%84%E4%BD%BF%E7%94%A8/"},{"title":"è§£æ ips æ–‡ä»¶","text":"ä¸€ã€å‰è¨€å¦‚æœ iOS è®¾å¤‡ä¸Šçš„æŸæ¬¾ APP å‘ç”Ÿ crashï¼Œé‚£ä¹ˆæ˜¯èƒ½å¤Ÿåœ¨æ‰‹æœºå†…æŸ¥æ‰¾åˆ° crash ä¿¡æ¯çš„ã€‚ æ–¹æ³•å°±æ˜¯è®¾ç½®-&gt;éšç§-&gt;åˆ†æ-&gt;åˆ†ææ•°æ®ï¼›æ–‡ä»¶åæ ¼å¼å°±æ˜¯ APP åŒ…å+æ—¶é—´çš„ ips æ–‡ä»¶ï¼Œä¸€çœ¼å°±èƒ½å®šä½å‡ºå“ªä¸€ä¸ªAPPä»€ä¹ˆæ—¶é—´å‘ç”Ÿçš„ crashï¼Œæ¥ä¸‹æ¥å¯¼å‡ºä½ å…³æ³¨çš„ ips æ–‡ä»¶ã€‚ å› ä¸ºè§£æå‰çš„ ips æ–‡ä»¶æ˜¯åå…­è¿›åˆ¶çš„å †æ ˆä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹è¿™äº›æ•°æ®è¿›è¡Œç¬¦å·åŒ–è½¬æ¢ï¼Œå°†å †æ ˆåœ°å€è½¬åŒ–ä¸ºæˆ‘ä»¬å¯è¯†åˆ«çš„ä¸€äº›ç±»åã€æ–¹æ³•åç­‰ç¬¦å·ä¿¡æ¯ã€‚ äºŒã€è§£æåœ¨æ¡Œé¢æ–°å»ºåä¸º crash çš„æ–‡ä»¶å¤¹ï¼Œè¯¥æ–‡ä»¶å¤¹éœ€è¦å¯¼å…¥å››æ ·ä¸œè¥¿ï¼› ç¬¬ä¸€ä¸ªï¼šä»è®¾å¤‡å¯¼å‡ºçš„ ips æ–‡ä»¶ï¼Œéœ€è¦æ”¹åç¼€åä¸º crash ç¬¬äºŒä¸ªï¼šæ‰¾åˆ° /Applications/Xcode.app/Contents/SharedFrameworks/DVTFoundation.framework/Versions/A/Resources/symbolicatecrash è·¯å¾„ï¼ŒæŠŠ symbolicatecrash æ‹·è´åˆ° crash æ–‡ä»¶å¤¹ä¸­ ç¬¬ä¸‰ä¸ªï¼šæ‰“å¼€ Xcode-&gt;window-&gt;Organizerï¼Œæ‰¾åˆ°å¯¹åº”ç‰ˆæœ¬çš„ archivesï¼Œå³é”® Show in Finderï¼Œé€‰ä¸­xcarchive æ–‡ä»¶å³é”®æ˜¾ç¤ºåŒ…å†…å®¹ï¼Œæ‹·è´å‡º dSYMs æ–‡ä»¶å¤¹ä¸‹çš„ dSYM æ–‡ä»¶ ç¬¬å››ä¸ªï¼šæ‰“å¼€ Xcode-&gt;window-&gt;Organizerï¼Œæ‰¾åˆ°å¯¹åº”ç‰ˆæœ¬çš„ archivesï¼Œå³é”®Show in Finderï¼Œé€‰ä¸­xcarchive æ–‡ä»¶å³é”®æ˜¾ç¤ºåŒ…å†…å®¹ï¼Œæ‹·è´å‡º Products-&gt;Applications æ–‡ä»¶å¤¹ä¸‹çš„APPæ–‡ä»¶ æ­¤æ—¶crashæ–‡ä»¶å¤¹ä¸‹æ–‡ä»¶ï¼š ç„¶åæ‰“å¼€ç»ˆç«¯ï¼Œcd åˆ° crash æ–‡ä»¶å¤¹ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š ./symbolicatecrash xxx.carsh xxx.dSYM &gt; log.carsh æ‰§è¡Œä¹‹åï¼Œç»ˆç«¯å¯èƒ½æŠ¥é”™ Error: â€œDEVELOPER_DIRâ€ is not defined at ./symbolicatecrash line 69. ç»§ç»­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š export DEVELOPER_DIR=â€/Applications/Xcode.app/Contents/Developerâ€ ç„¶åï¼Œå†ç»§ç»­æ‰§è¡Œç¬¬ä¸€æ¡ç”Ÿæˆ log çš„å‘½ä»¤ï¼Œæ­¤æ—¶ crash æ–‡ä»¶å¤¹å†…åº”è¯¥å°±èƒ½çœ‹åˆ°ä¸€ä¸ª log.crash æ–‡ä»¶ï¼Œæ‰“å¼€æ­¤æ–‡ä»¶ï¼Œå°±èƒ½æ›´å¥½çš„å®šä½é—®é¢˜æ‰€åœ¨äº†ã€‚","link":"/2021/03/11/iOS%C2%B7%E8%B4%A8%E9%87%8F&%E6%95%88%E7%8E%87/%E8%A7%A3%E6%9E%90%20ips%E6%96%87%E4%BB%B6/"},{"title":"12-Method Swizzlingçš„å‘ä¸åº”ç”¨","text":"ä¸€ã€æ–¹æ³•çš„æœ¬è´¨Objective-Cä¸­ï¼Œæ–¹æ³•æ˜¯ç”±SELå’ŒIMPç»„æˆçš„ï¼Œå‰è€…å«åšæ–¹æ³•ç¼–å·ï¼Œåè€…å«æ–¹æ³•å®ç°ã€‚OCä¸­è°ƒç”¨æ–¹æ³•å«åšå‘é€æ¶ˆæ¯ï¼Œå‘é€æ¶ˆæ¯å‰ä¼šå…ˆæŸ¥æ‰¾æ¶ˆæ¯ï¼ŒæŸ¥æ‰¾è¿‡ç¨‹å°±æ˜¯é€šè¿‡SELæŸ¥æ‰¾IMPçš„è¿‡ç¨‹ï¼Œå¦å¤–ï¼Œæˆ‘ä»¬ç»å¸¸åœ¨ä»£ç ä¸­ä½¿ç”¨@selector(someMethod)è¿™æ ·çš„è¯­æ³•ï¼Œ@selector()å«åšæ–¹æ³•é€‰æ‹©å™¨ï¼Œå…¶è¿”å›çš„å°±æ˜¯SELï¼ŒçœŸæ­£æ‰§è¡Œæ—¶ä¼šæ ¹æ®è¿™ä¸ªSELæŸ¥æ‰¾å¯¹åº”çš„IMPã€‚ äºŒã€MethodSwizzling åŸç†æ¯”å¦‚æœ‰æ–¹æ³•sel1å¯¹åº”imp1ï¼Œsel2å¯¹åº”imp2ï¼Œç»è¿‡æ–¹æ³•äº¤æ¢ï¼Œä½¿å¾—runtimeåœ¨æ–¹æ³•æŸ¥æ‰¾æ—¶å°†sel1çš„æŸ¥æ‰¾ç»“æœå˜ä¸ºimp2ï¼š ï¿¼ ä¸‰ã€Method Swizzling ç›¸å…³å‡½æ•° API1234567891011121314151617// é€šè¿‡SELè·å–ä¸€ä¸ªæ–¹æ³•class_getInstanceMethod// è·å–ä¸€ä¸ªæ–¹æ³•çš„å®ç°method_getImplementation// è·å–ä¸€ä¸ªOCå®ç°çš„ç¼–ç ç±»å‹method_getTypeEncoding// ç»™æ–¹æ³•æ·»åŠ å®ç°class_addMethod// ç”¨ä¸€ä¸ªæ–¹æ³•çš„å®ç°æ›¿æ¢å¦ä¸€ä¸ªæ–¹æ³•çš„å®ç°class_replaceMethod// äº¤æ¢ä¸¤ä¸ªæ–¹æ³•çš„å®ç°method_exchangeImplementations å››ã€ç®€å•ç¤ºä¾‹æ–°å»ºä¸€ä¸ªiOSå·¥ç¨‹ï¼Œæ–°å»ºä¸€ä¸ªPersonç±»ï¼Œå¹¶ä¸ºPersonæ·»åŠ ä¸¤ä¸ªæ–¹æ³•-walkå’Œ-runï¼š 123456789101112131415161718192021// Person.h@interface Person : NSObject- (void)walk;- (void)run;@end// Person.m@implementation Person- (void)walk { NSLog(@&quot;walk&quot;);}- (void)run { NSLog(@&quot;run&quot;);}@end æ–°å»ºä¸€ä¸ªNSObjectçš„åˆ†ç±»MethodSwizzlingå¦‚ä¸‹ï¼š 12345678910111213141516171819// NSObject+MethodSwizzling.h@interface NSObject (MethodSwizzling)+ (void)methodswizzlingWithClass:(Class)cls orgSEL:(SEL)orgSEL targetSEL:(SEL)targetSEL;@end// NSObject+MethodSwizzling.m#import &lt;objc/runtime.h&gt;@implementation NSObject (MethodSwizzling)+ (void)methodswizzlingWithClass:(Class)cls orgSEL:(SEL)orgSEL targetSEL:(SEL)targetSEL { Method orgMethod = class_getInstanceMethod(cls, orgSEL); Method tgtMethod = class_getInstanceMethod(cls, targetSEL); method_exchangeImplementations(orgMethod, tgtMethod);}@end åœ¨Person.mä¸­é‡å†™+loadæ–¹æ³•ï¼š 12345678+ (void)load { static dispatch_once_t onceToken; dispatch_once(&amp;onceToken, ^{ [self methodswizzlingWithClass:self orgSEL:@selector(walk) targetSEL:@selector(run)]; });} åœ¨ViewControllerçš„-viewDidLoadä¸­è°ƒç”¨-walkï¼š 12345- (void)viewDidLoad { [super viewDidLoad]; Person *person = [[Person alloc] init]; [person walk];} è¿è¡Œç¨‹åºï¼Œæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š 12020-02-09 21:26:07.613230+0800 TestObjC[1716:74628] run è°ƒç”¨çš„æ˜¯-walkï¼Œå®é™…æ‰§è¡Œçš„æ˜¯-runï¼Œå®Œæˆäº†æ–¹æ³•äº¤æ¢ã€‚ äº”ã€å‘ç‚¹5.1 äº¤æ¢æ–¹æ³•åå†è°ƒç”¨ load æ–¹æ³•ç¬¬ä¸€ä¸ªå‘ç‚¹æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯æˆ‘ä»¬åœ¨loadä¸­äº¤æ¢å®Œæ–¹æ³•åï¼Œä¸åšå¤„ç†çš„è¯ï¼Œå¦‚æœå†å»è°ƒç”¨loadï¼Œæ–¹æ³•IMPä¼šåˆè¢«äº¤æ¢å›æ¥ï¼Œå¯¼è‡´äº¤æ¢ä¸æˆåŠŸã€‚ è§£å†³çš„æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼šä½¿ç”¨å•ä¾‹æ¨¡å¼æ¥äº¤æ¢æ–¹æ³•ï¼Œä¿è¯æ–¹æ³•çš„äº¤æ¢åªæ‰§è¡Œä¸€æ¬¡ 5.2 åœ¨ç»§æ‰¿çš„ç±»ä¸­è¿›è¡Œæ–¹æ³•äº¤æ¢å¯¼è‡´äº¤æ¢çš„ç»“æœå’Œé¢„æœŸä¸ä¸€è‡´å…·ä½“æè¿°æ˜¯ï¼šåœ¨å­ç±»ä¸­äº¤æ¢å®ƒç‹¬æœ‰çš„æ–¹æ³•å’Œç»§æ‰¿è‡ªçˆ¶ç±»çš„æ–¹æ³•ï¼Œå­ç±»äº¤æ¢æ˜¯æˆåŠŸäº†ï¼Œä½†æ˜¯çˆ¶ç±»ä¸­çš„æ–¹æ³•ä¹Ÿè¢«äº¤æ¢äº†ã€‚ ä½¿ç”¨çš„æ—¶å€™å¤šæ³¨æ„ä¸€ä¸‹ã€‚ ä¾‹ï¼š 123456789101112131415161718Person.h @interface Person : NSObject- (void)walk;@end Person.m@implementation Person- (void)walk { NSLog(@&quot;walk&quot;);}@end 123456789101112131415161718192021222324252627282930313233Student.h@interface Student : Person- (void)study;@end Student.m@implementation Student- (void)study { NSLog(@&quot;study&quot;);}+ (void)load { static dispatch_once_t onceToken; dispatch_once(&amp;onceToken, ^{ [self methodSwizzlingWithClass:self orgSEL:@selector(walk) targetSEL:@selector(study)]; });}+ (void)methodSwizzlingWithClass:(Class)cls orgSEL:(SEL)orgSEL targetSEL:(SEL)targetSEL { Method orgMethod = class_getInstanceMethod(cls, orgSEL); Method tgtMethod = class_getInstanceMethod(cls, targetSEL); method_exchangeImplementations(orgMethod, tgtMethod);}@end 123456789// Student ç±»ä¸­æ–¹æ³•äº¤æ¢æˆåŠŸäº†Student *s = [Student new];[s walk]; // study[s study]; // walk// ä½†æ˜¯é¡ºä¾¿ä¹ŸæŠŠçˆ¶ç±»ç»™äº¤æ¢äº†ï¼ˆè¿™æ˜¯æˆ‘ä»¬ä¸éœ€è¦çš„ï¼Œå¤šæ³¨æ„ï¼‰Person *p = [Person new];[p walk]; // study 5.3 è¦äº¤æ¢çš„æ–¹æ³•æœªå®ç°æ—¶ä¼šäº¤æ¢å¤±è´¥è¿˜æ˜¯ä¸Šé¢çš„ä¾‹å­ï¼Œå¦‚æœ Student ç±»ä¸­ï¼Œåªå£°æ˜äº† -study æ–¹æ³•ï¼Œä½†æ˜¯æœªå®ç°ï¼Œå†äº¤æ¢ -walk æ–¹æ³•å’Œ -study æ–¹æ³•å°±ä¼šäº¤æ¢å¤±è´¥ï¼Œè¿˜æ˜¯ä¹‹å‰çš„è€æ ·å­ï¼Œè¿™ç‚¹ä¹Ÿè¦æ³¨æ„ï¼ˆä¸è¿‡æ­£å¸¸äººå†™ä¸å‡ºè¿™ç§ä»£ç ï¼‰ å…­ã€å¸¸è§åº”ç”¨6.1 åŸ‹ç‚¹ç»Ÿè®¡6.1.1 é¡µé¢æµè§ˆäº‹ä»¶åœ¨ iOS å¼€å‘ä¸­æœ€å¸¸è§çš„ä¸‰ç§åŸ‹ç‚¹ï¼Œå°±æ˜¯å¯¹é¡µé¢è¿›å…¥æ¬¡æ•°ã€é¡µé¢åœç•™æ—¶é—´ã€ç‚¹å‡»äº‹ä»¶çš„åŸ‹ç‚¹ã€‚è¿™äº›éƒ½å¯ä»¥é€šè¿‡Method Swizzlingæ¥å®ç°ã€‚ é€šè¿‡äº¤æ¢UIViewControllerä¸­viewWillAppearå’ŒviewWillDisappearçš„æ–¹æ³•ï¼Œæ¥å®ç°äº†è¿›å…¥ç•Œé¢å’Œé€€å‡ºç•Œé¢çš„ç»Ÿè®¡ï¼Œå¹¶è®°å½•äº†ç›¸å…³çš„ç±»åï¼Œé€šè¿‡æ˜ å°„çš„å…³ç³»ï¼Œå°±å¯ä»¥æ¸…æ¥šçš„çŸ¥é“ç”¨æˆ·çš„è¡Œä¸ºäº†ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243@implementation UIViewController (logger)+ (void)load { static dispatch_once_t onceToken; dispatch_once(&amp;onceToken, ^{ // é€šè¿‡ @selector è·å¾—è¢«æ›¿æ¢å’Œæ›¿æ¢æ–¹æ³•çš„ SELï¼Œä½œä¸º SMHook:hookClass:fromeSelector:toSelector çš„å‚æ•°ä¼ å…¥ SEL fromSelectorAppear = @selector(viewWillAppear:); SEL toSelectorAppear = @selector(hook_viewWillAppear:); [SMHook hookClass:self fromSelector:fromSelectorAppear toSelector:toSelectorAppear]; SEL fromSelectorDisappear = @selector(viewWillDisappear:); SEL toSelectorDisappear = @selector(hook_viewWillDisappear:); [SMHook hookClass:self fromSelector:fromSelectorDisappear toSelector:toSelectorDisappear]; });}- (void)hook_viewWillAppear:(BOOL)animated { // å…ˆæ‰§è¡Œæ’å…¥ä»£ç ï¼Œå†æ‰§è¡ŒåŸ viewWillAppear æ–¹æ³• [self insertToViewWillAppear]; [self hook_viewWillAppear:animated];}- (void)hook_viewWillDisappear:(BOOL)animated { // æ‰§è¡Œæ’å…¥ä»£ç ï¼Œå†æ‰§è¡ŒåŸ viewWillDisappear æ–¹æ³• [self insertToViewWillDisappear]; [self hook_viewWillDisappear:animated];}- (void)insertToViewWillAppear { // åœ¨ ViewWillAppear æ—¶è¿›è¡Œæ—¥å¿—çš„åŸ‹ç‚¹ [[[[SMLogger create] message:[NSString stringWithFormat:@&quot;%@ Appear&quot;,NSStringFromClass([self class])]] classify:ProjectClassifyOperation] save];}- (void)insertToViewWillDisappear { âœ…/ åœ¨ ViewWillDisappear æ—¶è¿›è¡Œæ—¥å¿—çš„åŸ‹ç‚¹ [[[[SMLogger create] message:[NSString stringWithFormat:@&quot;%@ Disappear&quot;,NSStringFromClass([self class])]] classify:ProjectClassifyOperation] save];}@end 6.1.2 æ§ä»¶ç‚¹å‡»äº‹ä»¶é‚£ä¹ˆç‚¹å‡»æ–¹æ³•ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è¿è¡Œæ—¶è¿›è¡Œæ–¹æ³•æ›¿æ¢å®ç°æ— ä¾µå…¥åŸ‹ç‚¹ã€‚ åŸç†ï¼š å½“æˆ‘ä»¬ä¸ºä¸€ä¸ªæ§ä»¶æ·»åŠ  Target-Action åï¼Œç”¨æˆ·æ“ä½œæ§ä»¶ï¼ˆæ¯”å¦‚ç‚¹å‡»ï¼‰æ—¶ï¼Œé¦–å…ˆä¼šè°ƒç”¨-sendAction:to:forEvent:æ–¹æ³•ï¼Œå¹¶å°†äº‹ä»¶è½¬å‘ç»™åº”ç”¨ç¨‹åºçš„ UIApplication å¯¹è±¡ã€‚ï¼ˆUIApplication ç±»ä¸­å¯¹åº”çš„æ˜¯-sendAction:from:forEvent:æ–¹æ³•ï¼‰ å¦‚æœ Target ä¸ä¸ºç©ºï¼Œåº”ç”¨ç¨‹åºä¼šè®©è¯¥å¯¹è±¡è°ƒç”¨å¯¹åº”çš„æ–¹æ³•å“åº”äº‹ä»¶ï¼›å¦‚æœ Target ä¸ºç©ºï¼Œåº”ç”¨ç¨‹åºä¼šåœ¨å“åº”é“¾ä¸­æœç´¢å®šä¹‰äº†è¯¥æ–¹æ³•çš„å¯¹è±¡ï¼Œç„¶åæ‰§è¡Œè¯¥æ–¹æ³•ã€‚ å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ Method Swizzling äº¤æ¢ UIApplication ç±»ä¸­çš„-sendAction:from:forEvent:æ–¹æ³•ï¼Œç„¶ååœ¨äº¤æ¢åçš„æ–¹æ³•ä¸­è§¦å‘é‡‡é›†äº‹ä»¶ã€‚ å®Œæ•´ä»£ç ï¼š 123456789101112131415161718192021222324#import &quot;UIApplication+XWTracking.h&quot;#import &quot;XWTrackingAnalysisSDK.h&quot;#import &quot;NSObject+XWSwizzler.h&quot;#import &quot;UIView+XWTracking.h&quot;@implementation UIApplication (XWTracking)+ (void)load { [UIApplication xwtracking_swizzleMethod:@selector(sendAction:to:from:forEvent:) withMethod:@selector(xwtracking_sendAction:to:from:forEvent:)];}- (BOOL)xwtracking_sendAction:(SEL)action to:(nullable id)target from:(nullable id)sender forEvent:(nullable UIEvent *)event { // UITabBarItemç»§æ‰¿è‡ªNSObjectï¼Œä¸è¿‡æ»¤ä¼šå´©æºƒ BOOL condition = ((event.allTouches.anyObject.phase == UITouchPhaseEnded) || [sender isKindOfClass:UISwitch.class] || [sender isKindOfClass:UISegmentedControl.class] || [sender isKindOfClass:UIStepper.class]) &amp;&amp; !([sender isKindOfClass:UITabBarItem.class] || [sender isKindOfClass:UIBarButtonItem.class]); if (condition) { // è§¦å‘$AppClickäº‹ä»¶ [XWTrackingAnalysisSDK.shareInstance trackAppClickWithView:sender properties:nil]; } // è°ƒç”¨åŸæœ‰å®ç° return [self xwtracking_sendAction:action to:target from:sender forEvent:event];}@end å’Œ UIViewControllerç”Ÿå‘½å‘¨æœŸåŸ‹ç‚¹ä¸åŒçš„æ˜¯ï¼ŒUIButtonåœ¨ä¸€ä¸ªè§†å›¾ç±»ä¸­å¯èƒ½æœ‰å¤šä¸ªä¸åŒçš„ç»§æ‰¿ç±»ï¼Œç›¸åŒ UIButtonçš„å­ç±»åœ¨ä¸åŒè§†å›¾ç±»çš„åŸ‹ç‚¹ä¹Ÿè¦åŒºåˆ«å¼€ï¼š 123456789101112131415- (void)trackAppClickWithView:(UIView *)view properties:(NSDictionary&lt;NSString *,id&gt; *)properties { NSMutableDictionary *eventProperties = [NSMutableDictionary dictionary]; // è·å–æ§ä»¶ç±»å‹ eventProperties[@&quot;$element_type&quot;] = view.xwtracking_elementType; // è·å–æ§ä»¶æ˜¾ç¤ºæ–‡æœ¬ eventProperties[@&quot;$element_content&quot;] = view.xwtracking_elementContent; // è·å–æ§ä»¶æ‰€åœ¨çš„ UIViewController UIViewController *vc = view.xwtracking_viewController; // è®¾ç½®é¡µé¢ç›¸å…³å±æ€§ eventProperties[@&quot;$screen_name&quot;] = NSStringFromClass(vc.class); // æ·»åŠ è‡ªå®šä¹‰å±æ€§ [eventProperties addEntriesFromDictionary:properties]; // è§¦å‘$AppClickäº‹ä»¶ [XWTrackingAnalysisSDK.shareInstance track:@&quot;$AppClick&quot; properties:eventProperties];} é™¤äº† UIViewControllerã€UIButton æ§ä»¶ä»¥å¤–ï¼ŒCocoa æ¡†æ¶çš„å…¶ä»–æ§ä»¶éƒ½å¯ä»¥ä½¿ç”¨è¿™ç§æ–¹æ³•æ¥è¿›è¡Œæ— ä¾µå…¥åŸ‹ç‚¹ã€‚ä»¥ Cocoa æ¡†æ¶ä¸­æœ€å¤æ‚çš„ UITableView æ§ä»¶ä¸ºä¾‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ hook setDelegate æ–¹æ³•æ¥å®ç°æ— ä¾µå…¥åŸ‹ç‚¹ã€‚å¦å¤–ï¼Œå¯¹äº Cocoa æ¡†æ¶ä¸­çš„æ‰‹åŠ¿äº‹ä»¶ï¼ˆGesture Eventï¼‰ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ hook initWithTarget:action:æ–¹æ³•æ¥å®ç°æ— ä¾µå…¥åŸ‹ç‚¹ã€‚ 6.2 é˜²æ­¢æ•°ç»„ï¼Œå­—å…¸ç­‰è¶Šç•Œå´©æºƒæ•°ç»„è¶Šç•Œç­‰æ˜¯æœ€å®¹æ˜“é€ æˆcrashçš„ä¸€ç§æ–¹å¼ï¼Œè€Œä¸”ä¸€èˆ¬å´©æºƒèµ·æ¥æ¯”è¾ƒä¸¥é‡ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å°½é‡é¿å…ã€‚ åœ¨iOSä¸­NSNumberã€NSArrayã€NSDictionaryç­‰è¿™äº›ç±»éƒ½æ˜¯ç±»ç°‡(Class Clusters)ï¼Œä¸€ä¸ªNSArrayçš„å®ç°å¯èƒ½ç”±å¤šä¸ªç±»ç»„æˆã€‚æ‰€ä»¥å¦‚æœæƒ³å¯¹NSArrayè¿›è¡ŒSwizzlingï¼Œå¿…é¡»è·å–åˆ°å…¶çœŸèº«è¿›è¡ŒSwizzlingï¼Œç›´æ¥å¯¹NSArrayè¿›è¡Œæ“ä½œæ˜¯æ— æ•ˆçš„ã€‚è¿™æ˜¯å› ä¸ºMethod Swizzlingå¯¹NSArrayè¿™äº›çš„ç±»ç°‡æ˜¯ä¸èµ·ä½œç”¨çš„ã€‚ å› ä¸ºè¿™äº›ç±»ç°‡ç±»ï¼Œå…¶å®æ˜¯ä¸€ç§æŠ½è±¡å·¥å‚çš„è®¾è®¡æ¨¡å¼ã€‚æŠ½è±¡å·¥å‚å†…éƒ¨æœ‰å¾ˆå¤šå…¶å®ƒç»§æ‰¿è‡ªå½“å‰ç±»çš„å­ç±»ï¼ŒæŠ½è±¡å·¥å‚ç±»ä¼šæ ¹æ®ä¸åŒæƒ…å†µï¼Œåˆ›å»ºä¸åŒçš„æŠ½è±¡å¯¹è±¡æ¥è¿›è¡Œä½¿ç”¨ã€‚ä¾‹å¦‚æˆ‘ä»¬è°ƒç”¨NSArrayçš„objectAtIndex:æ–¹æ³•ï¼Œè¿™ä¸ªç±»ä¼šåœ¨æ–¹æ³•å†…éƒ¨åˆ¤æ–­ï¼Œå†…éƒ¨åˆ›å»ºä¸åŒæŠ½è±¡ç±»è¿›è¡Œæ“ä½œã€‚ æ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯¹NSArrayç±»è¿›è¡ŒSwizzlingæ“ä½œå…¶å®åªæ˜¯å¯¹çˆ¶ç±»è¿›è¡Œäº†æ“ä½œï¼Œåœ¨NSArrayå†…éƒ¨ä¼šåˆ›å»ºå…¶ä»–å­ç±»æ¥æ‰§è¡Œæ“ä½œï¼ŒçœŸæ­£æ‰§è¡ŒSwizzlingæ“ä½œçš„å¹¶ä¸æ˜¯NSArrayè‡ªèº«ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥å¯¹å…¶â€œçœŸèº«â€è¿›è¡Œæ“ä½œã€‚ ä¸‹é¢åˆ—ä¸¾äº†NSArrayå’ŒNSDictionaryæœ¬ç±»çš„ç±»åï¼Œå¯ä»¥é€šè¿‡Runtimeå‡½æ•°å–å‡ºæœ¬ç±»ï¼š ç±»å çœŸèº« NSArray __NSArrayI NSMutableArray __NSArrayM NSDictionary __NSDictionaryI NSMutableDictionary __NSDictionaryM 6.2.1 å¤„ç† NSArrayNSArray+CrashHandle.h 1234567891011121314151617//// NSArray+CrashHandle.h// Test14//// Created by IMO on 2020/10/10.// Copyright Â© 2020 IMO. All rights reserved.//#import &lt;Foundation/Foundation.h&gt;NS_ASSUME_NONNULL_BEGIN@interface NSArray (CrashHandle)@endNS_ASSUME_NONNULL_END NSArray+CrashHandle.m 123456789101112131415161718192021222324252627282930313233343536//// NSArray+CrashHandle.m// Test14//// Created by IMO on 2020/10/10.// Copyright Â© 2020 IMO. All rights reserved.//#import &quot;NSArray+CrashHandle.h&quot;#import &lt;objc/runtime.h&gt;@implementation NSArray (CrashHandle)// å¦‚æœä¸‹é¢ä»£ç ä¸èµ·ä½œç”¨ï¼Œé€ æˆè¿™ä¸ªé—®é¢˜çš„åŸå› å¤§å¤šéƒ½æ˜¯å…¶è°ƒç”¨äº†super loadæ–¹æ³•ã€‚åœ¨ä¸‹é¢çš„loadæ–¹æ³•ä¸­ï¼Œä¸åº”è¯¥è°ƒç”¨çˆ¶ç±»çš„loadæ–¹æ³•ã€‚è¿™æ ·ä¼šå¯¼è‡´æ–¹æ³•äº¤æ¢æ— æ•ˆ+ (void)load { Method fromMethod = class_getInstanceMethod(objc_getClass(&quot;__NSArrayI&quot;), @selector(objectAtIndex:)); Method toMethod = class_getInstanceMethod(objc_getClass(&quot;__NSArrayI&quot;), @selector(xw_objectAtIndex:)); method_exchangeImplementations(fromMethod, toMethod);}- (id)xw_objectAtIndex:(NSUInteger)index { if (index &gt; self.count - 1) { // æ•°ç»„è¶Šç•Œ @try { return [self xw_objectAtIndex:index]; } @catch (NSException *exception) { // åœ¨å´©æºƒåä¼šæ‰“å°å´©æºƒä¿¡æ¯ã€‚å¦‚æœæ˜¯çº¿ä¸Šï¼Œå¯ä»¥åœ¨è¿™é‡Œå°†å´©æºƒä¿¡æ¯å‘é€åˆ°æœåŠ¡å™¨ NSLog(@&quot;---------- %s Crash Because Method %s ----------\\n&quot;, class_getName(self.class), __func__); NSLog(@&quot;%@&quot;, [exception callStackSymbols]); return nil; } @finally {} } else { // å¦‚æœæ²¡æœ‰é—®é¢˜ï¼Œåˆ™æ­£å¸¸è¿›è¡Œæ–¹æ³•è°ƒç”¨ return [self xw_objectAtIndex:index]; }}@end 12345678910**************************è°ƒç”¨******************************- (void)viewDidLoad { [super viewDidLoad]; // æµ‹è¯•ä»£ç  NSArray *array = @[@0, @1, @2, @3]; [array objectAtIndex:3]; //æœ¬æ¥è¦å¥”æºƒçš„ï¼Œä½†æ˜¯æ²¡æœ‰ï¼Œæ‰“å°å‡ºäº†ä¿¡æ¯ [array objectAtIndex:4];} 6.2.2 å¤„ç† NSMutableArrayNSMutableArray+CrashHandle.h 1234567891011121314151617//// NSMutableArray+CrashHandle.h// Test14//// Created by IMO on 2020/10/10.// Copyright Â© 2020 IMO. All rights reserved.//#import &lt;Foundation/Foundation.h&gt;NS_ASSUME_NONNULL_BEGIN@interface NSMutableArray (CrashHandle)@endNS_ASSUME_NONNULL_END NSMutableArray+CrashHandle.m 12345678910111213141516171819202122232425262728293031323334//// NSMutableArray+CrashHandle.m// Test14//// Created by IMO on 2020/10/10.// Copyright Â© 2020 IMO. All rights reserved.//#import &quot;NSMutableArray+CrashHandle.h&quot;#import &lt;objc/runtime.h&gt;@implementation NSMutableArray (CrashHandle)+ (void)load { Method fromMethod = class_getInstanceMethod(objc_getClass(&quot;__NSArrayM&quot;), @selector(objectAtIndex:)); Method toMethod = class_getInstanceMethod(objc_getClass(&quot;__NSArrayM&quot;), @selector(xw_objectAtIndex:)); method_exchangeImplementations(fromMethod, toMethod);}- (id)xw_objectAtIndex:(NSUInteger)index { if (index &gt; self.count - 1) { // æ•°ç»„è¶Šç•Œ @try { return [self xw_objectAtIndex:index]; } @catch (NSException *exception) { NSLog(@&quot;---------- %s Crash Because Method %s ----------\\n&quot;, class_getName(self.class), __func__); NSLog(@&quot;%@&quot;, [exception callStackSymbols]); return nil; } @finally {} } else { return [self xw_objectAtIndex:index]; }}@end ä»¥ä¸Šçš„ä¸¤ä¸ªä¾‹å­ï¼Œåªæ˜¯å¼€å‘ä¸­å¸¸ç”¨çš„ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„åº”ç”¨ï¼Œå°±éœ€è¦æ ¹æ®éœ€æ±‚æ¥ä¸æ–­è°ƒæ•´äº†ã€‚è¿™äº›éƒ½å±äº AOP é¢å‘åˆ‡é¢ç¼–ç¨‹çš„ä¸€ä¸ªå®é™…åº”ç”¨ï¼ŒMethod Swizzling ä¹Ÿæ˜¯å…¶åœ¨ iOS å¼€å‘ä¸­åº”ç”¨çš„æœ€å¸¸ç”¨çš„ä¸€ç§ AOP æ€æƒ³ å‚è€ƒiOSåº•å±‚å­¦ä¹  - Runtimeä¹‹Method Swizzlingé»‘é­”æ³• Objective-C çš„ MethodSwizzling","link":"/2021/02/18/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/12-Method%20Swizzling%E7%9A%84%E5%9D%91%E4%B8%8E%E5%BA%94%E7%94%A8/"},{"title":"ã€ŠæŒ‡æ•°åŸºé‡‘æŠ•èµ„æŒ‡å—ã€‹è¯»ä¹¦ç¬”è®°","text":"ä¸€ã€ä¹¦ç±ä¿¡æ¯ä¹¦åï¼šæŒ‡æ•°åŸºé‡‘æŠ•èµ„æŒ‡å— ä½œè€…ï¼šé“¶è¡Œèºä¸é’‰ åˆ†ç±»ï¼šæŠ•èµ„ç†è´¢å·¥å…·ä¹¦ è¯»å®Œæ—¶é—´ï¼š2021.3 äºŒã€å‰è¨€ä½œè€…åœ¨å…¶å‰è¨€ä¸­æåˆ°çš„è‡ªå·±â€œå°†ä¼šé‡‡å–â€çš„ç»„åˆï¼š50%æ²ªæ·±300æŒ‡æ•°åŸºé‡‘ï¼Œ15%ä¸Šè¯çº¢åˆ©åŸºé‡‘ï¼Œ30%æ ‡æ™®500æŒ‡æ•°åŸºé‡‘ï¼Œ5%çº³æ–¯è¾¾å…‹ç»¼åˆåŸºé‡‘ã€‚ ä¸‰ã€ç†è§£3.1 æŒ‡æ•°åŸºé‡‘çš„åˆ†ç±»å®½åŸºæŒ‡æ•°åŸºé‡‘ è¡Œä¸šæŒ‡æ•°åŸºé‡‘ 3.2 å¦‚ä½•é€‰æŒ‡æ•°åŸºé‡‘ï¼Ÿ3.2.1 åŸºæœ¬ç†å¿µä½ä¼°å€¼ä»·å€¼æŠ•èµ„ã€‚å·´è²ç‰¹çš„è€å¸ˆæ ¼é›·å„å§†åŸºäºä»·å€¼æŠ•èµ„æ€»ç»“äº†ä¸‰ä¸ªç†è®ºï¼šä»·æ ¼ä¸ä»·å€¼çš„å…³ç³»ã€èƒ½åŠ›åœˆã€å®‰å…¨è¾¹é™…ã€‚ 1.ä»·æ ¼ä¸ä»·å€¼çš„å…³ç³»ï¼š ä»·æ ¼å›´ç»•ä»·å€¼ä¸Šä¸‹æ³¢åŠ¨ 2.èƒ½åŠ›åœˆï¼š äº†è§£è‡ªå·±çš„æŠ•èµ„å“ç§ï¼Œåˆ¤æ–­å…¶å¤§è‡´ä»·å€¼ï¼Œå¾ˆé‡è¦ 3.å®‰å…¨è¾¹é™…ï¼š ä»·æ ¼ä½äºä»·å€¼çš„æ—¶å€™æ‰å¯ä»¥æŠ•èµ„ 3.2.2 ä¼°å€¼æŒ‡æ ‡å¸‚ç›ˆç‡ã€å…³æ³¨ã€‘$$å¸‚ç›ˆç‡ = \\frac{å¸‚å€¼}{ç›ˆåˆ©}$$ å¸‚å€¼ä¼šæ³¢åŠ¨ï¼Œä½ä»£è¡¨ä½ä¼°ï¼Œè¶Šä½è¶Šå¥½ ç›ˆåˆ©æ”¶ç›Šç‡$$ç›ˆåˆ©æ”¶ç›Šç‡=\\frac{ç›ˆåˆ©}{å¸‚å€¼}$$ è¶Šé«˜ä»£è¡¨ä¼°å€¼è¶Šä½ï¼Œè¶Šé«˜è¶Šå¥½ å¸‚å‡€ç‡$$å¸‚å‡€ç‡=\\frac{å¸‚å€¼}{å‡€èµ„äº§}$$ è¶Šä½è¶Šå¥½ è‚¡æ¯ç‡$$è‚¡æ¯ç‡=\\frac{åˆ†çº¢}{å¸‚å€¼}$$ è¶Šé«˜è¶Šå¥½ åˆ†çº¢ç‡$$åˆ†çº¢ç‡=\\frac{åˆ†çº¢}{å‡€åˆ©æ¶¦}$$ ä¸€èˆ¬ä¸å˜ ROE(å‡€èµ„äº§æ”¶ç›Šç‡)$$ROE=\\frac{å‡€åˆ©æ¶¦}{å‡€èµ„äº§}$$ 3.2.3 ä¼°å€¼æŸ¥è¯¢æ–¹å¼å…¬ä¼—å·ï¼šå®šæŠ•åå¹´èµšåå€ 3.2.4 ä¸¤ç§æ–¹å¼æŒ‘é€‰ç›ˆåˆ©æ”¶ç›Šç‡æ³•å½“ç›ˆåˆ©æ”¶ç›Šç‡å¤§äº10%æ—¶ï¼Œå¼€å§‹å®šæŠ• å½“ç›ˆåˆ©æ”¶ç›Šç‡åœ¨6.4%ï½10%æ—¶ï¼ŒåšæŒæŒæœ‰ å½“ç›ˆåˆ©æ”¶ç›Šç‡å°äº6.4%æ—¶ï¼Œåˆ†æ‰¹å–å‡º åšæ ¼å…¬å¼æ³•æŒ‡æ•°åŸºé‡‘æœªæ¥çš„å¹´å¤åˆæ”¶ç›Šç‡ = æŒ‡æ•°åŸºé‡‘çš„æŠ•èµ„åˆæœŸè‚¡æ¯ç‡ + æŒ‡æ•°åŸºé‡‘æ¯å¹´çš„å¸‚ç›ˆç‡å˜åŒ–ç‡ + æŒ‡æ•°åŸºé‡‘æ¯å¹´çš„ç›ˆåˆ©å˜åŒ–ç‡ 3.3 å¦‚ä½•ä¹°å–3.3.1 å®šæŠ•è§„åˆ™ç›ˆåˆ©æ”¶ç›Šç‡æ³• + å®šæŠ• åšæ ¼å…¬å¼æ³• + å®šæŠ• 3.3.2 è®¡ç®—å¹´å¤åˆæ”¶ç›Šç‡IRR å…¬å¼ 3.3.3 æé«˜æ”¶ç›Šç‡çš„å°æŠ€å·§å®šæœŸä¸å®šé¢ + ç›ˆåˆ©æ”¶ç›Šç‡æ³•$$æ¯ä¸ªæœˆçš„å®šæŠ•é‡‘é¢=é¦–æ¬¡ä½ä¼°æ—¶çš„å®šæŠ•èµ„é‡‘*\\frac{å½“æœˆçš„ç›ˆåˆ©æ”¶ç›Šç‡}{é¦–æ¬¡çš„ç›ˆåˆ©æ”¶ç›Šç‡}$$ 3.4 æ„å»ºè‡ªå·±çš„å®šæŠ•è®¡åˆ’ 3.5 å®¶åº­èµ„äº§é…ç½®çŸ­æœŸèµ„é‡‘ç®¡ç†â€”è´§å¸åŸºé‡‘ï¼ˆä½™é¢å®ï¼‰ ä¸­æœŸèµ„é‡‘ç®¡ç†â€”å€ºåˆ¸ å››ã€ç»“å°¾å¼•ç”¨ä½œè€…å–œæ¬¢çš„ä¸€å¥è¯ï¼šâ€œæˆ‘ç›¸ä¿¡ï¼Œæˆ‘ç»ˆå°†å¯Œæœ‰ï¼â€","link":"/2021/03/28/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E3%80%8A%E6%8C%87%E6%95%B0%E5%9F%BA%E9%87%91%E6%8A%95%E8%B5%84%E6%8C%87%E5%8D%97%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"},{"title":"WKWebview ç™½å±é—®é¢˜å¤„ç†","text":"ä¸€ã€é—®é¢˜æè¿°WKWebview è½½å…¥è¿‡ç¨‹ä¸­æœ‰æ¦‚ç‡ä¼šå‡ºç°æ•´ä¸ª webview ç©ºç™½çš„æƒ…å†µï¼Œæˆ‘ä»¬åˆ†æè®¤ä¸ºè¿™å±äº iOS ç³»ç»Ÿçš„ bugï¼ŒçŒœæµ‹å¤§æ¦‚æˆ–è®¸æœ‰å¯èƒ½maybeå‡ºç°çš„åŸå› æ˜¯ç½‘é¡µé‡å®šå‘è¿‡å¤šæˆ–è€…å…¶ä»–å„ç§åŸå› ã€‚ è™½ç„¶æ˜¯ç³»ç»Ÿ bugï¼Œä½†è¿˜æ˜¯è¦æˆ‘ä»¬è‡ªå·±å»è§£å†³ã€‚ äºŒã€å°è¯•è§£å†³å®éªŒä¸€ï¼šåœ¨ webViewWebContentProcessDidTerminate å›è°ƒå‡½æ•°ä¸­å¤„ç†å®éªŒè¿‡ç¨‹ï¼š åšå®¢æ‘˜å½•ï¼š 1å½“ WKWebView æ€»ä½“å†…å­˜å ç”¨è¿‡å¤§ï¼Œé¡µé¢å³å°†ç™½å±çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šè°ƒç”¨`-webViewWebContentProcessDidTerminate:`å›è°ƒå‡½æ•°ï¼Œç„¶ååœ¨è¯¥å‡½æ•°é‡Œæ‰§è¡Œ`[webView reload]`å»è§£å†³ç™½å±é—®é¢˜ã€‚ å®éªŒç»“æœï¼š é¡µé¢å³å°†ç™½å±çš„æ—¶å€™å¹¶ä¸èµ°ä¸Šé¢çš„ä»£ç†æ–¹æ³•ã€‚è€Œä¸”è·Ÿ WKWebView å†…å­˜å ç”¨æ²¡ä»»ä½•å…³ç³»ï¼Œå› ä¸ºæˆ‘ç›´æ¥åœ¨ MacBook Pro with M1 chip ä¸Šè·‘çœŸæœºä¹Ÿä¼šå‡ºç°ç™½å±é—®é¢˜ï¼Œä½¿ç”¨ç”µè„‘16 GBå†…å­˜ï¼Œè¶³å¤Ÿå¤§äº†ã€‚ å®éªŒäºŒï¼šåœ¨ webViewWebContentProcessDidTerminate å›è°ƒå‡½æ•°ä¸­å¤„ç†å®éªŒè¿‡ç¨‹ï¼š åšå®¢æ‘˜å½•ï¼š 1å½“h5é¡µé¢å³å°†ç™½å±æ—¶ï¼Œä¼šè°ƒç”¨`-(void)webViewWebContentProcessDidTerminate:`æ–¹æ³•ï¼Œæˆ‘ä»¬åªéœ€åœ¨è¿™ä¸ªæ–¹æ³•ä¸­é‡æ–°åŠ è½½webviewå³å¯ å®éªŒç»“æœï¼š é¡µé¢å³å°†ç™½å±çš„æ—¶å€™å¹¶ä¸èµ°ä¸Šé¢çš„ä»£ç†æ–¹æ³•ã€‚å®éªŒè¿‡ç¨‹ä¸­å‘ç°å‡ºç°ç™½å±é—®é¢˜æ—¶æœ‰æ—¶å€™ä¼šè°ƒç”¨ï¼šdidFailNavigation:æ–¹æ³•ï¼Œå¹¶ä¸”å½“æ—¶çš„æŠ¥é”™æ˜¯é‡å®šå‘è¿‡å¤šã€‚ä½†æ˜¯æœ‰æ—¶å€™åˆä¸èµ°didFailNavigationè¿™ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥ä¹Ÿä¸èƒ½åœ¨è¿™é‡Œå»å¤„ç†ã€‚ å®éªŒä¸‰ï¼šæ£€æµ‹ webView.title æ˜¯å¦ä¸ºç©ºå®éªŒè¿‡ç¨‹ï¼š åœ¨-viewWillAppearçš„æ—¶å€™æ£€æµ‹webView.titleï¼Œå¦‚æœä¸ºç©ºåˆ™reloadé¡µé¢ã€‚ å®éªŒç»“æœï¼š æ‰€æœ‰é¡µé¢åœ¨-viewWillAppearçš„æ—¶å€™webView.titleéƒ½ä¸ºç©ºï¼Œå› ä¸ºé¡µé¢éƒ½æ²¡åŠ è½½å®Œï¼Œæ–¹æ¡ˆå°±æœ‰é—®é¢˜ï¼Œæ‰€ä»¥ passã€‚ å®éªŒå››ï¼šjs æ³¨å…¥èµ„æºåŠ è½½é”™è¯¯æ£€æµ‹ä»£ç å®éªŒè¿‡ç¨‹ï¼š æ³¨å…¥ä¸‹é¢çš„ js ä»£ç ï¼Œç›‘æµ‹åˆ°å‡ºé”™å°±é‡æ–°åŠ è½½ç½‘é¡µ 123456789101112// ç›‘æ§èµ„æºåŠ è½½é”™è¯¯(img,script,css,ä»¥åŠjsonp)ï¼Œå‡ºé”™å°±é‡æ–°åŠ è½½window.addEventListener('error', function (e) { console.log(&quot;===&quot; + e.message + &quot;===&quot;); location.reload();}, true);window.onerror = function (errorMessage, scriptURI, lineNumber, columnNumber, errorObj) { console.log(&quot;é”™è¯¯ä¿¡æ¯ï¼š&quot;, errorMessage); console.log(&quot;å‡ºé”™æ–‡ä»¶ï¼š&quot;, scriptURI); console.log(&quot;å‡ºé”™è¡Œå·ï¼š&quot;, lineNumber); console.log(&quot;å‡ºé”™åˆ—å·ï¼š&quot;, columnNumber); console.log(&quot;é”™è¯¯è¯¦æƒ…ï¼š&quot;, errorObj);} å®éªŒç»“æœï¼š æ³¨å…¥ js ä»£ç åä¼šå‡ºç°é¡µé¢æ— é™é‡è½½é—®é¢˜ï¼Œè€Œä¸”åç»­æˆ‘ä»¬åˆ†æé¡µé¢ç™½å±æ˜¯ iOS ç³»ç»Ÿé—®é¢˜ï¼Œé‚£ä¹ˆæŠŠé—®é¢˜çš„æ£€æµ‹äº¤ç»™ H5 å»åšæ˜¾ç„¶æ˜¯ä¸åˆç†ä¹Ÿä¸å¯¹çš„ã€‚ ä¸‰ã€æœ€ç»ˆæ–¹æ¡ˆï¼šåƒç´ éå†ï¼Œçº¯ç™½åƒç´ è¶…è¿‡é˜ˆå€¼å°±é‡æ–°è½½å…¥å‚è€ƒå­—èŠ‚è·³åŠ¨å›¢é˜Ÿçš„è§£å†³æ–¹æ¡ˆï¼Œé‡‡ç”¨åœ¨ç½‘é¡µåŠ è½½å®Œæ¯•åå¯¹å½“å‰ webview çš„å¯è§†åŒºåŸŸæˆªå›¾ï¼Œå¹¶å¯¹æ­¤å¿«ç…§è¿›è¡Œåƒç´ ç‚¹éå†ï¼Œå¦‚æœçº¯ç™½è‰²åƒç´ æ‰€å ç™¾åˆ†æ¯”è¶…è¿‡é˜ˆå€¼ï¼Œåˆ™è®¤ä¸ºå‡ºç°ç™½å±ï¼Œç„¶åè®©å½“å‰é¡µé¢é‡æ–°åŠ è½½çš„æ–¹å¼å»å¤„ç†ã€‚ 3.1 è·å–å¿«ç…§ioså®˜æ–¹æä¾›äº†ç®€æ˜“çš„è·å–webviewå¿«ç…§æ¥å£ï¼Œé€šè¿‡å¼‚æ­¥å›è°ƒæ‹¿åˆ°å½“å‰å¯è§†åŒºåŸŸçš„å±å¹•æˆªå›¾ã€‚ 1- (void)takeSnapshotWithConfiguration:(nullable WKSnapshotConfiguration *)snapshotConfiguration completionHandler:(void (^)(UIImage * _Nullable snapshotImage, NSError * _Nullable error))completionHandler API_AVAILABLE(ios(11.0)); å…¶ä¸­snapshotConfigurationå‚æ•°å¯ç”¨äºé…ç½®å¿«ç…§å¤§å°èŒƒå›´ï¼Œé»˜è®¤æˆªå–å½“å‰å®¢æˆ·ç«¯æ•´ä¸ªå±å¹•åŒºåŸŸã€‚å½“ç„¶è¦å‰”é™¤å¯¼èˆªæ ï¼Œå› ä¸ºä¸€èˆ¬å¯¼èˆªæ çš„é¢œè‰²éƒ½æ˜¯è‡ªå®šä¹‰çš„é¢œè‰²ï¼Œéçº¯ç™½ï¼Œä¼šå¹²æ‰°æ£€æµ‹ç»“æœã€‚ 12345678910111213141516- (void)judgeLoadingStatus:(WKWebView *)webview { if (@available(iOS 11.0, *)) { if (webView &amp;&amp; [webView isKindOfClass:[WKWebView class]]) { // çŠ¶æ€æ é«˜åº¦ CGFloat statusBarHeight = [[UIApplication sharedApplication] statusBarFrame].size.height; // å¯¼èˆªæ é«˜åº¦ CGFloat navigationHeight = webView.viewController.navigationController.navigationBar.frame.size.height; // âœ…ä»…æˆªå›¾æ£€æµ‹å¯¼èˆªæ ä»¥ä¸‹éƒ¨åˆ†å†…å®¹ WKSnapshotConfiguration *shotConfiguration = [[WKSnapshotConfiguration alloc] init]; shotConfiguration.rect = CGRectMake(0, statusBarHeight + navigationHeight, _webView.bounds.size.width, (_webView.bounds.size.height - navigationHeight - statusBarHeight)); [_webView takeSnapshotWithConfiguration:shotConfiguration completionHandler:^(UIImage * _Nullable snapshotImage, NSError * _Nullable error) { //todo }]; } }} 3.2 ç¼©æ”¾å¿«ç…§ ä¸ºäº†æå‡æ£€æµ‹æ€§èƒ½ï¼Œè€ƒè™‘å°†å¿«ç…§ç¼©æ”¾è‡³1/5ï¼Œå‡å°‘åƒç´ ç‚¹æ€»æ•°ï¼Œä»è€ŒåŠ å¿«éå†é€Ÿåº¦ã€‚ 1234567891011121314- (UIImage *)scaleImage:(UIImage *)image { CGFloat scale = 0.2; CGSize newsize; newsize.width = floor(image.size.width * scale); newsize.height = floor(image.size.height * scale); if (@available(iOS 10.0, *)) { UIGraphicsImageRenderer *renderer = [[UIGraphicsImageRenderer alloc] initWithSize:newsize]; return [renderer imageWithActions:^(UIGraphicsImageRendererContext * _Nonnull rendererContext) { [image drawInRect:CGRectMake(0, 0, newsize.width, newsize.height)]; }]; } else { return image; }} ç»æµ‹è¯•ç¼©æ”¾åéå†è¿‡ç¨‹å¤§æ¦‚åœ¨20msä»¥å†…ã€‚ æ³¨æ„è¿™é‡Œæœ‰ä¸ªå‘ï¼šç”±äºç¼©æ”¾åçš„å›¾çš„å°ºå¯¸åœ¨ åŸå›¾å®½é«˜*ç¼©æ”¾ç³»æ•°åå¯èƒ½ä¸æ˜¯æ•´æ•°ï¼Œåœ¨å¸ƒç½®ç”»å¸ƒé‡ç»˜æ—¶é»˜è®¤å‘ä¸Šå–æ•´ï¼Œè¿™å°±é€ æˆé‡ç»˜çš„ç”»å¸ƒæ¯”ç†è®ºä¸Šç¼©æ”¾åçš„å›¾å¤§ã€‚åœ¨éå†ç¼©æ”¾åå›¾ç‰‡çš„åƒç´ æ—¶ï¼Œä¼šå°†å›¾å¤–ç”»å¸ƒä¸Šçš„åƒç´ çº³å…¥è€ƒè™‘èŒƒå›´ï¼Œå¯¼è‡´å®é™…ç™½å±é¡µåƒç´ å æ¯”å¹¶é100%ã€‚å› æ­¤ä½¿ç”¨floorå°†å…¶å°ºå¯¸å¤§å°å‘ä¸‹å–æ•´ï¼ˆä½¿ç”¨ floor å‡½æ•°ï¼‰ã€‚ 3.3 éå†å¿«ç…§éå†å¿«ç…§ç¼©æ”¾åå›¾ç‰‡çš„åƒç´ ç‚¹ï¼Œå¯¹çº¯ç™½åƒç´ å æ¯”å¤§äº99%çš„é¡µé¢ï¼Œè®¤å®šå…¶ä¸ºç™½å±é—®é¢˜é¡µã€‚ 12345678910111213141516171819202122232425262728293031323334353637// éå†åƒç´ ç‚¹ ç™½è‰²åƒç´ å æ¯”å¤§äº99%è®¤å®šä¸ºç™½å±- (BOOL)searchEveryPixel:(UIImage *)image { CGImageRef cgImage = [image CGImage]; size_t width = CGImageGetWidth(cgImage); size_t height = CGImageGetHeight(cgImage); // æ¯ä¸ªåƒç´ ç‚¹åŒ…å«r g b a å››ä¸ªå­—èŠ‚ size_t bytesPerRow = CGImageGetBytesPerRow(cgImage); size_t bitsPerPixel = CGImageGetBitsPerPixel(cgImage); CGDataProviderRef dataProvider = CGImageGetDataProvider(cgImage); CFDataRef data = CGDataProviderCopyData(dataProvider); UInt8 *buffer = (UInt8 *)CFDataGetBytePtr(data); int whiteCount = 0; int totalCount = 0; for (int j = 0; j &lt; height; j ++ ) { for (int i = 0; i &lt; width; i ++) { UInt8 *pt = buffer + j * bytesPerRow + i * (bitsPerPixel / 8); UInt8 red = * pt; UInt8 green = *(pt + 1); UInt8 blue = *(pt + 2); totalCount ++; if (red &gt;= 254 &amp;&amp; green &gt;= 254 &amp;&amp; blue &gt;= 254) { whiteCount ++; } } } float proportion = (float)whiteCount / totalCount ; NSLog(@&quot;å½“å‰åƒç´ ç‚¹æ•°ï¼š%d,ç™½è‰²åƒç´ ç‚¹æ•°:%d , å æ¯”: %f&quot;,totalCount , whiteCount , proportion ); if (proportion &gt; 0.99) { return YES; } else { return NO; }} æ³¨æ„è¿™é‡Œæœ‰ä¸ªå‘ï¼šæœ‰æ—¶å€™å‡ºç°ç™½å±äº†ï¼Œä½†æ˜¯æ£€æµ‹å‡ºæ¥çš„ RGB å€¼æœ‰äº›ä¸º254ï¼Œæœ‰äº›ä¸º255ï¼Œæ‰€ä»¥éœ€è¦if (red &gt;= 254 &amp;&amp; green &gt;= 254 &amp;&amp; blue &gt;= 254)è¿™æ ·å¤„ç†ã€‚ 3.4 ä½¿ç”¨åœ¨é¡µé¢åŠ è½½å®Œæˆåè°ƒç”¨-judgeLoadingStatus:æ–¹æ³•åˆ¤æ–­æ˜¯å¦å‡ºç°ç™½å±ï¼Œå‡ºç°äº†å°±é‡æ–°åˆ·æ–°é¡µé¢ï¼Œç»æµ‹è¯•å¯ä»¥å®Œç¾è§£å†³ç™½å±é—®é¢˜ã€‚ 12345678910111213141516171819- (void)webView:(WKWebView *)webView didFinishNavigation:(null_unspecified WKNavigation *)navigation { @weakify(self); [self judgeLoadingStatus:webView withBlock:^(webviewLoadingStatus status) { @strongify(self); switch (status) { case WebViewErrorStatus: self.reloadTime += 1; if (self.reloadTime &gt; 2) { return; } [webView reload]; NSLog(@&quot;é‡åˆ°ç™½å±ï¼Œé‡æ–°åŠ è½½ğŸ†˜&quot;); break; default: break; } }];} 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687#pragma mark - å¤„ç†ç™½å±é—®é¢˜// åˆ¤æ–­æ˜¯å¦ç™½å±- (void)judgeLoadingStatus:(WKWebView *)webview withBlock:(void (^)(webviewLoadingStatus status))completionBlock { webviewLoadingStatus __block status = WebViewPendStatus; if (@available(iOS 11.0, *)) { if (webview) { // çŠ¶æ€æ é«˜åº¦ CGFloat statusBarHeight = [[UIApplication sharedApplication] statusBarFrame].size.height; // å¯¼èˆªæ é«˜åº¦ CGFloat navigationHeight = webview.viewController.navigationController.navigationBar.frame.size.height; WKSnapshotConfiguration *shotConfiguration = [[WKSnapshotConfiguration alloc] init]; // ä»…æˆªå›¾æ£€æµ‹å¯¼èˆªæ ä»¥ä¸‹éƒ¨åˆ†å†…å®¹(åº•éƒ¨å®‰å…¨åŒºåŸŸä¸å½±å“) shotConfiguration.rect = CGRectMake(0, statusBarHeight + navigationHeight, webview.bounds.size.width, (webview.bounds.size.height - navigationHeight - statusBarHeight)); @weakify(self); [webview takeSnapshotWithConfiguration:shotConfiguration completionHandler:^(UIImage * _Nullable snapshotImage, NSError * _Nullable error) { @strongify(self); if (snapshotImage) { UIImage *scaleImage = [self scaleImage:snapshotImage]; BOOL isWhiteScreen = [self searchEveryPixel:scaleImage]; if (isWhiteScreen) { status = WebViewErrorStatus; } else { status = WebViewNormalStatus; } } if (completionBlock) { completionBlock(status); } }]; } }}// éå†åƒç´ ç‚¹ ç™½è‰²åƒç´ å æ¯”å¤§äº99%è®¤å®šä¸ºç™½å±- (BOOL)searchEveryPixel:(UIImage *)image { CGImageRef cgImage = [image CGImage]; size_t width = CGImageGetWidth(cgImage); size_t height = CGImageGetHeight(cgImage); // æ¯ä¸ªåƒç´ ç‚¹åŒ…å«r g b a å››ä¸ªå­—èŠ‚ size_t bytesPerRow = CGImageGetBytesPerRow(cgImage); size_t bitsPerPixel = CGImageGetBitsPerPixel(cgImage); CGDataProviderRef dataProvider = CGImageGetDataProvider(cgImage); CFDataRef data = CGDataProviderCopyData(dataProvider); UInt8 *buffer = (UInt8 *)CFDataGetBytePtr(data); int whiteCount = 0; int totalCount = 0; for (int j = 0; j &lt; height; j ++ ) { for (int i = 0; i &lt; width; i ++) { UInt8 *pt = buffer + j * bytesPerRow + i * (bitsPerPixel / 8); UInt8 red = * pt; UInt8 green = *(pt + 1); UInt8 blue = *(pt + 2); totalCount ++; if (red &gt;= 254 &amp;&amp; green &gt;= 254 &amp;&amp; blue &gt;= 254) { whiteCount ++; } } } float proportion = (float)whiteCount / totalCount ; NSLog(@&quot;å½“å‰åƒç´ ç‚¹æ•°ï¼š%d,ç™½è‰²åƒç´ ç‚¹æ•°:%d , å æ¯”: %f&quot;,totalCount , whiteCount , proportion ); if (proportion &gt; 0.99) { return YES; } else { return NO; }}// ä¸ºäº†æå‡æ£€æµ‹æ€§èƒ½ï¼Œè€ƒè™‘å°†å¿«ç…§ç¼©æ”¾è‡³1/5ï¼Œå‡å°‘åƒç´ ç‚¹æ€»æ•°ï¼Œä»è€ŒåŠ å¿«éå†é€Ÿåº¦- (UIImage *)scaleImage:(UIImage *)image { CGFloat scale = 0.2; CGSize newsize; newsize.width = floor(image.size.width * scale); newsize.height = floor(image.size.height * scale); if (@available(iOS 10.0, *)) { UIGraphicsImageRenderer *renderer = [[UIGraphicsImageRenderer alloc] initWithSize:newsize]; return [renderer imageWithActions:^(UIGraphicsImageRendererContext * _Nonnull rendererContext) { [image drawInRect:CGRectMake(0, 0, newsize.width, newsize.height)]; }]; } else { return image; }} åè®°ä¿æŒæ€€ç–‘ç²¾ç¥ã€‚","link":"/2021/02/22/iOS%C2%B7%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/WKWebview-%E7%99%BD%E5%B1%8F%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/"},{"title":"iOS+SQLite","text":"ä¸€ã€SQLite31.1 åŸºæœ¬æ“ä½œæ•°æ®åº“æ“ä½œæœ€åŸºæœ¬çš„æ— éå°±æ˜¯==å¢ï¼Œåˆ ï¼Œæ”¹ï¼ŒæŸ¥==å››ä¸ªåŠŸèƒ½ã€‚å¢åˆ æ”¹å¯ä»¥ç»Ÿä¸€å½’ä¸ºä¿®æ”¹æ•°æ®ï¼š åœ¨ SQLite ä¸­ï¼Œä¿®æ”¹æ•°æ®çš„åŸºæœ¬æµç¨‹ä¸ºï¼š ç¬¬ä¸€æ­¥ sqlite3_open_v2 æ‰“å¼€æ•°æ®åº“ç¬¬äºŒæ­¥ sqlite3_prepare_v2 é¢„å¤„ç† SQL è¯­å¥æ“ä½œç¬¬ä¸‰æ­¥ sqlite3_bind_xxx ç»‘å®šå‚æ•°ç¬¬å››æ­¥ sqlite3_step / sqlite3_exec æ‰§è¡Œ SQL è¯­å¥ç¬¬äº”æ­¥ sqlite3_finalize å’Œ sqlite3_close é‡Šæ”¾èµ„æº 1.2 APIsqlite3_open_v2æ‰“å¼€æ•°æ®åº“ å‚æ•°1:æ•°æ®åº“æ–‡ä»¶è·¯å¾„ å‚æ•°2:æ•°æ®åº“å¥æŸ„ / æ•°æ®åº“å®ä¾‹ å‚æ•°3:æ ‡è®° æœ‰ä»¥ä¸‹å‡ ç§ï¼š SQLITE_OPEN_NOMUTEX: è®¾ç½®æ•°æ®åº“è¿æ¥è¿è¡Œåœ¨å¤šçº¿ç¨‹æ¨¡å¼(æ²¡æœ‰æŒ‡å®šå•çº¿ç¨‹æ¨¡å¼çš„æƒ…å†µä¸‹)SQLITE_OPEN_FULLMUTEXï¼šè®¾ç½®æ•°æ®åº“è¿æ¥è¿è¡Œåœ¨ä¸²è¡Œæ¨¡å¼ã€‚SQLITE_OPEN_SHAREDCACHEï¼šè®¾ç½®è¿è¡Œåœ¨å…±äº«ç¼“å­˜æ¨¡å¼ã€‚SQLITE_OPEN_PRIVATECACHEï¼šè®¾ç½®è¿è¡Œåœ¨éå…±äº«ç¼“å­˜æ¨¡å¼ã€‚SQLITE_OPEN_READWRITEï¼šæŒ‡å®šæ•°æ®åº“è¿æ¥å¯ä»¥è¯»å†™ã€‚SQLITE_OPEN_CREATEï¼šå¦‚æœæ•°æ®åº“ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºã€‚ å‚æ•°4:ä½¿ç”¨è¯¥æ•°æ®åº“çš„è™šæ‹Ÿæœºçš„åå­—ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸éœ€è¦ç”¨ï¼Œç›´æ¥ä¼  NULL sqlite3_prepare_v2æ£€æŸ¥SQLè¯­å¥çš„åˆæ³•æ€§ï¼ˆæŸ¥è¯¢å‰çš„å‡†å¤‡ï¼‰ è‹¥è¯­å¥åˆæ³•å³ç¼–è¯‘é€šè¿‡ï¼Œåˆ™å°†è¯­å¥äº§ç”Ÿçš„æŒ‡ä»¤å¡è¿› stmt å¥æŸ„ï¼ˆæ­¤æ—¶å¹¶æœªæ‰§è¡ŒæŒ‡ä»¤ï¼‰ å‚æ•°1:æ•°æ®åº“å®ä¾‹ å‚æ•°2:éœ€è¦æ£€æŸ¥çš„ SQL è¯­å¥ å‚æ•°3:SQL è¯­å¥çš„æœ€å¤§å­—èŠ‚é•¿åº¦ï¼Œ-1ä»£è¡¨æ€»é•¿åº¦ å‚æ•°4:stmt å¥æŸ„ï¼Œç”¨æ¥å­˜å‚¨ SQL stmt æŒ‡ä»¤ å‚æ•°5:æŒ‡å‘ zSql æœªä½¿ç”¨éƒ¨åˆ†çš„æŒ‡é’ˆï¼Œä¼  null sqlite3_bindé€šè¿‡ prepare æ¥å£å¯ä»¥æ”¯æŒå‚æ•°åŒ–çš„ SQL è¯­å¥ï¼Œå³å¸¦é—®å·çš„SQLè¯­å¥ã€‚æ¯”å¦‚æŸ¥è¯¢è¯­å¥select * from t where id=?ï¼Œæˆ–è€…æ’å…¥è¯­å¥insert into t(a,b,c) values(?,?,?)ã€‚ç”±äºé—®å·æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œå› æ­¤éœ€è¦è°ƒç”¨sqlite3_bind_xxxæ¥å£æ¥ç»‘å®šå…·ä½“çš„å‚æ•°ã€‚ ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç±»ï¼šsqlite3_bind_intsqlite3_bind_int64sqlite3_bind_doublesqlite3_bind_textsqlite3_bind_blobsqlite3_bind_null å‚æ•°1:è¯­å¥å¯¹è±¡ å‚æ•°2:å‚æ•°å¼€å§‹æ‰§è¡Œçš„åºå· å‚æ•°3:æˆ‘ä»¬è¦ç»‘å®šçš„å€¼ å‚æ•°4:ç»‘å®šçš„å­—ç¬¦ä¸²çš„é•¿åº¦ å‚æ•°5:æŒ‡é’ˆï¼Œä¼  NULL sqlite3_stepæ‰§è¡Œstmtå¥æŸ„ï¼ˆæ‰§è¡Œå­˜å‚¨åœ¨ stmt å¥æŸ„çš„æŒ‡ä»¤ï¼‰ å¦‚æœæŒ‡ä»¤èƒ½æŸ¥è¯¢åˆ°ä¸‹ä¸€è¡Œæ•°æ®ï¼Œå°±ä¼šè¿”å›SQLITE_ROW å¦‚æœæŒ‡ä»¤ï¼ˆä¾‹å¦‚å†™å…¥æ•°æ®ï¼‰ä¸éœ€è¦è¿”è¿˜æ•°æ®ï¼Œå°±ä¼šè¿”è¿˜SQLITE_DONE å‚æ•°ï¼šstmt å¥æŸ„ sqlite3_execç›´æ¥ç¼–è¯‘å¹¶æ‰§è¡Œ SQL è¯­å¥ ç‰¹ç‚¹ï¼š1ã€æ²¡æœ‰SQLè¯­æ³•æ£€æŸ¥ 2ã€æ¯ä¸€å¥SQLè¯­å¥å³ä½¿å®Œå…¨ä¸€æ ·ï¼Œä¹Ÿä¼šé‡æ–°ç¼–è¯‘æ‰§è¡Œï¼Œå¯¹æ‰¹é‡æŒ‡ä»¤æ¥è¯´æ•ˆç‡ä¸é«˜ã€‚ å‚æ•°1:ä¸€ä¸ªæ‰“å¼€çš„æ•°æ®åº“å®ä¾‹ å‚æ•°2:éœ€è¦æ‰§è¡Œçš„SQLè¯­å¥ å‚æ•°3:SQLè¯­å¥æ‰§è¡Œå®Œæ¯•åçš„å›è°ƒ å‚æ•°4:å›è°ƒå‡½æ•°çš„ç¬¬1ä¸ªå‚æ•° å‚æ•°5:é”™è¯¯ä¿¡æ¯ sqlite3_finalizeæ¸…ç†è¯­å¥å¥æŸ„(ä»¥ä¾¿é‡å¤ä½¿ç”¨åŒä¸€ä¸ª stmt å¥æŸ„) å‚æ•°ï¼šstmt å¥æŸ„ sqlite3_closeå…³é—­æ•°æ®åº“è¿æ¥ å‚æ•°ï¼šæ•°æ®åº“å®ä¾‹ sqlite3_resetå°†å·²ç¼–è¯‘çš„SQLè¯­å¥æ¢å¤åˆ°åˆå§‹çŠ¶æ€ï¼Œä¿ç•™è¯­å¥ç›¸å…³çš„èµ„æºï¼Œé‡ç½®åå¯é‡æ–°ç»‘å®šæ•°æ® å‚æ•°ï¼šstmt å¥æŸ„ 1.3 SQLite å¤šçº¿ç¨‹SQLite å¤šçº¿ç¨‹æ“ä½œçš„ç‰¹ç‚¹ä¸ºä¿è¯çº¿ç¨‹å®‰å…¨ï¼ŒSQLite æ•°æ®åº“åªèƒ½å¹¶å‘è¯»ï¼Œä¸èƒ½å¹¶å‘å†™ã€‚ SQLite å¤šçº¿ç¨‹æ“ä½œçš„æ­£ç¡®æ–¹å¼ å¤šçº¿ç¨‹è¯»å†™ï¼Œä½¿ç”¨åŒä¸€ä¸ªæ•°æ®åº“ã€‚ã€é‡‡ç”¨ã€‘ è¿™ç§æƒ…å†µä¸‹ç”±äºä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªæ•°æ®åº“è¿æ¥ï¼ŒSQLite å†…éƒ¨æœ‰é”æœºåˆ¶ï¼Œä¸ä¼šå‡ºç°å¼‚å¸¸ã€‚è¿™ç§å¤šçº¿ç¨‹æ“ä½œå¹¶ä¸æ˜¯çœŸæ­£çš„å¹¶å‘æ“ä½œï¼Œç”±äºé”æœºåˆ¶çš„å­˜åœ¨æ‰€ä»¥ä»ç„¶æ˜¯é˜»å¡çš„ã€‚ å¤šçº¿ç¨‹è¯»ï¼Œå•çº¿ç¨‹å†™ï¼Œæ¯ä¸ªçº¿ç¨‹ä½¿ç”¨å„è‡ªç‹¬ç«‹çš„æ•°æ®åº“è¿æ¥ï¼ˆä½†æ˜¯éœ€è¦å¼€å¯walæ¨¡å¼ï¼Œä»¥å¼€å¯æ•°æ®åº“è¿æ¥æ± ï¼‰ã€‚ è¿™ç§æƒ…å†µä¸‹æ˜¯çœŸçš„å®ç°äº†å¤šçº¿ç¨‹å¹¶å‘è¯»æ“ä½œï¼Œä½†æ˜¯å†™æ“ä½œä»èƒ½åªå¯ä»¥å•çº¿ç¨‹ï¼Œå¦‚æœå¤šçº¿ç¨‹å†™(æ¯ä¸ªçº¿ç¨‹ä½¿ç”¨å„è‡ªçš„æ•°æ®åº“è¿æ¥)å°±ä¼šå‡ºç°é—®é¢˜ã€‚ ä¸¤ç§æ–¹æ¡ˆå¯¹æ¯”ï¼š ç†è®ºä¸Šå¹¶å‘æ“ä½œè¶Šå¤šï¼Œæ–¹æ¡ˆ2æ•ˆç‡è¶Šé«˜ã€‚å®é™…æµ‹è¯•ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ äºŒã€iOS ä¸­çš„ä½¿ç”¨æ–¹å¼å¯¹äºæ–¹æ¡ˆä¸€ï¼Œé‡‡ç”¨å¼‚æ­¥å‡½æ•°+ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—å»æ“ä½œåŒä¸€ä¸ªæ•°æ®åº“(å¼€å¯æ•°æ®åº“åä¸å…³é—­)ã€‚ è¿™ç§æƒ…å†µä¸‹å°±ä¼šå¼€è¾Ÿä¸€ä¸ªå­çº¿ç¨‹ï¼ŒåŒæ—¶ä¸²è¡Œçš„æ“ä½œåŒä¸€ä¸ªæ•°æ®åº“ï¼Œæ‰€ä»¥æ—¢èƒ½å¤Ÿä¸é˜»å¡ UIï¼Œåˆèƒ½å¤Ÿä¿è¯çº¿ç¨‹å®‰å…¨ã€‚ ä»£ç å°è£…ï¼š XWTrackingAnalyticsDatabase.h 123456789101112131415161718192021222324252627282930313233343536373839404142434445//// XWTrackingAnalyticsDatabase.h// XWTrackingSDK//// Created by IMO on 2021/2/20.//// å‘½ä»¤è¡ŒéªŒè¯ï¼š// 1. è¿›å…¥æ•°æ®åº“ç¼“å­˜çš„ Caches è·¯å¾„// 2. æ‰§è¡Œ sqlite3 XWTrackingAnalyticsDatabase.sqlite// 3. sqlite&gt; .tables// 4. sqlite&gt; select * from events#import &lt;Foundation/Foundation.h&gt;#import &lt;sqlite3.h&gt;NS_ASSUME_NONNULL_BEGIN@interface XWTrackingAnalyticsDatabase : NSObject@property (nonatomic, copy, readonly) NSString *filePath;@property (nonatomic) sqlite3 *database;/// æœ¬åœ°äº‹ä»¶å­˜å‚¨æ€»é‡@property (nonatomic) NSUInteger eventCount;/// åˆå§‹åŒ–æ–¹æ³•/// @param filePath æ•°æ®åº“è·¯å¾„ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™ä½¿ç”¨é»˜è®¤è·¯å¾„- (instancetype)initWithFilePath:(nullable NSString *)filePath NS_DESIGNATED_INITIALIZER;/// å‘æ•°æ®åº“ä¸­æ’å…¥äº‹ä»¶æ•°æ®/// @param event äº‹ä»¶- (void)insertEvent:(NSDictionary *)event;/// ä»æ•°æ®åº“ä¸­è·å–äº‹ä»¶æ•°æ®/// @param count è·å–äº‹ä»¶æ•°æ®çš„æ¡æ•°- (NSArray&lt;NSString *&gt; *)selectEventsForCount:(NSUInteger)count;/// ä»æ•°æ®åº“ä¸­åˆ é™¤ä¸€å®šæ•°é‡çš„äº‹ä»¶æ•°æ®ï¼Œè¿”å›æ˜¯å¦åˆ é™¤æˆåŠŸ/// @param count åˆ é™¤äº‹ä»¶æ•°æ®çš„æ¡æ•°- (BOOL)deleteEventsForCount:(NSUInteger)count;@endNS_ASSUME_NONNULL_END XWTrackingAnalyticsDatabase.m 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164#import &quot;XWTrackingAnalyticsDatabase.h&quot;static NSString * const XWTrackingAnalyticsDatabaseName = @&quot;XWTrackingAnalyticsDatabase.sqlite&quot;;@interface XWTrackingAnalyticsDatabase ()@property (nonatomic, strong) dispatch_queue_t queue;@end@implementation XWTrackingAnalyticsDatabase- (instancetype)init { return [self initWithFilePath:nil];}- (instancetype)initWithFilePath:(NSString *)filePath { self = [super init]; if (self) { _filePath = filePath ? : [NSSearchPathForDirectoriesInDomains(NSCachesDirectory, NSUserDomainMask, YES).lastObject stringByAppendingPathComponent:XWTrackingAnalyticsDatabaseName]; NSLog(@&quot;æ•°æ®åº“è·¯å¾„æ˜¯ï¼š%@&quot;, _filePath); // åˆå§‹åŒ–é˜Ÿåˆ—çš„å”¯ä¸€æ ‡è¯† NSString *label = [NSString stringWithFormat:@&quot;cn.imo.serialQueue.%p&quot;, self]; // åˆ›å»ºä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ— _queue = dispatch_queue_create(label.UTF8String, DISPATCH_QUEUE_SERIAL); [self open]; [self queryLocalDatabaseEventCount]; } return self;}- (void)open { dispatch_async(self.queue, ^{ // åˆå§‹åŒ– SQLite åº“ if (sqlite3_open_v2(self.filePath.UTF8String, &amp;(self-&gt;_database), SQLITE_OPEN_READWRITE | SQLITE_OPEN_CREATE, NULL) != SQLITE_OK) { return NSLog(@&quot;SQLite stmt prepare error:%s&quot;, sqlite3_errmsg(self.database)); } char *error; // åˆ›å»ºæ•°æ®åº“è¡¨çš„ SQL è¯­å¥ NSString *sql = @&quot;CREATE TABLE IF NOT EXISTS events (id INTEGER PRIMARY KEY AUTOINCREMENT, event BLOB);&quot;; // è¿è¡Œåˆ›å»ºè¡¨æ ¼çš„ SQL è¯­å¥ if (sqlite3_exec(self.database, sql.UTF8String, NULL, NULL, &amp;error) != SQLITE_OK) { return NSLog(@&quot;Create events Failure %s&quot;, error); } });}static sqlite3_stmt *insertStmt = NULL;- (void)insertEvent:(NSDictionary *)event { dispatch_async(self.queue, ^{ if (insertStmt) { // é‡ç½®æ’å…¥è¯­å¥ï¼Œé‡ç½®åå¯é‡æ–°ç»‘å®šæ•°æ® sqlite3_reset(insertStmt); } else { // æ’å…¥è¯­å¥ NSString *sql = @&quot;INSERT INTO events (event) values(?)&quot;; // å‡†å¤‡æ‰§è¡Œ SQL è¯­å¥ï¼Œè·å– sqlite3_stmt if (sqlite3_prepare_v2(self.database, sql.UTF8String, -1, &amp;insertStmt, NULL) != SQLITE_OK) { // å‡†å¤‡æ‰§è¡Œ SQL è¯­å¥å¤±è´¥ï¼Œæ‰“å° log è¿”å›å¤±è´¥ (NO) return NSLog(@&quot;SQlite stmt prepare error:%s&quot;, sqlite3_errmsg(self.database)); } } NSError *error = nil; // å°† event è½¬æ¢æˆ JSON æ•°æ® NSData *data = [NSJSONSerialization dataWithJSONObject:event options:NSJSONWritingPrettyPrinted error:&amp;error]; if (error) { // event è½¬æ¢å¤±è´¥ return NSLog(@&quot;JSON Serialization error:%@&quot;, error); } // å°† JSON æ•°æ®ä¸ stmt ç»‘å®š sqlite3_bind_blob(insertStmt, 1, data.bytes, (int)data.length, SQLITE_TRANSIENT); // æ‰§è¡Œ stmt if (sqlite3_step(insertStmt) != SQLITE_DONE) { // æ‰§è¡Œå¤±è´¥ return NSLog(@&quot;Insert event into events error&quot;); } // æ•°æ®æ’å…¥æˆåŠŸï¼Œäº‹ä»¶æ•°é‡åŠ ä¸€ self.eventCount++; });}// æœ€åä¸€æ¬¡æŸ¥è¯¢çš„äº‹ä»¶æ•°é‡static NSUInteger lastSelectEventCount = 50;static sqlite3_stmt *selectStmt = NULL;- (NSArray&lt;NSString *&gt; *)selectEventsForCount:(NSUInteger)count { NSMutableArray&lt;NSString *&gt; *events = [NSMutableArray arrayWithCapacity:count]; // è¿™é‡Œéœ€è¦ä½¿ç”¨åŒæ­¥å‡½æ•°ï¼Œå¦åˆ™ä¼šå¯¼è‡´è¿”å›çš„äº‹ä»¶ä¸å®Œæ•´ dispatch_sync(self.queue, ^{ if (self.eventCount == 0) { return; } if (count != lastSelectEventCount) { lastSelectEventCount = count; selectStmt = NULL; } if (selectStmt) { // é‡ç½®æŸ¥è¯¢è¯­å¥ï¼Œé‡ç½®ä¹‹åå¯ä»¥é‡æ–°æŸ¥è¯¢æ•°æ® sqlite3_reset(selectStmt); } else { // æŸ¥è¯¢è¯­å¥ï¼ˆæŒ‰ id å‡åºæ’ï¼‰ NSString *sql = [NSString stringWithFormat:@&quot;SELECT id, event FROM events ORDER BY id ASC LIMIT %lu&quot;, (unsigned long)count]; // å‡†å¤‡æ‰§è¡Œ SQL è¯­å¥ï¼Œè·å– sqlite3_stmt if (sqlite3_prepare_v2(self.database, sql.UTF8String, -1, &amp;selectStmt, NULL) != SQLITE_OK) { return NSLog(@&quot;SQLite stmt prepare error:%s&quot;, sqlite3_errmsg(self.database)); } } // æ‰§è¡Œ SQL è¯­å¥ while (sqlite3_step(selectStmt) == SQLITE_ROW) { // å°†æŸ¥è¯¢åˆ°çš„è¿™æ¡æ•°æ®è½¬æ¢æˆ NSData å¯¹è±¡ NSData *data = [[NSData alloc] initWithBytes:sqlite3_column_blob(selectStmt, 1) length:sqlite3_column_bytes(selectStmt, 1)]; // å°†æŸ¥è¯¢åˆ°çš„äº‹ä»¶æ•°æ®è½¬æ¢æˆ JSON å­—ç¬¦ä¸² NSString *jsonString = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];#if DEBUG NSLog(@&quot;%@&quot;, jsonString);#endif // å°† JSON å­—ç¬¦ä¸²æ·»åŠ åˆ°æ•°ç»„ä¸­ [events addObject:jsonString]; } }); return events;}- (BOOL)deleteEventsForCount:(NSUInteger)count { __block BOOL success = YES; dispatch_sync(self.queue, ^{ if (self.eventCount == 0) { return; } // åˆ é™¤è¯­å¥ NSString *sql = [NSString stringWithFormat:@&quot;DELETE FROM events WHERE id IN (SELECT id FROM events ORDER BY id ASC LIMIT %lu);&quot;, (unsigned long)count]; char *errmsg; // æ‰§è¡Œåˆ é™¤è¯­å¥ if (sqlite3_exec(self.database, sql.UTF8String, NULL, NULL, &amp;errmsg) != SQLITE_OK) { success = NO; return NSLog(@&quot;Failed to delete record msg=%s&quot;, errmsg); } self.eventCount = self.eventCount &lt; count ? 0 : self.eventCount - count; }); return success;}// æŸ¥è¯¢æ•°æ®åº“ä¸­å·²ç¼“å­˜çš„äº‹ä»¶æ¡æ•°- (void)queryLocalDatabaseEventCount { dispatch_async(self.queue, ^{ // æŸ¥è¯¢è¯­å¥ NSString *sql = @&quot;SELECT count(*) FROM events;&quot;; sqlite3_stmt *stmt = NULL; // å‡†å¤‡æ‰§è¡Œ SQL è¯­å¥ï¼Œè·å– sqlite3_stmt if (sqlite3_prepare_v2(self.database, sql.UTF8String, -1, &amp;stmt, NULL) != SQLITE_OK) { return NSLog(@&quot;SQLite stmt prepare error:%s&quot;, sqlite3_errmsg(self.database)); } while (sqlite3_step(stmt) == SQLITE_ROW) { self.eventCount = sqlite3_column_int(stmt, 0); } });}@end å‚è€ƒSQLiteå¤šçº¿ç¨‹å¹¶å‘æ“ä½œ SQLiteä½¿ç”¨(ä¸‰)&amp;&amp;æ ¸å¿ƒAPIä½¿ç”¨","link":"/2021/02/25/iOS%C2%B7%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/iOS+SQLite/"},{"title":"02-isaåŸç†","text":"ä¸€ã€ å‰è¨€ åœ¨arm64æ¶æ„ä¹‹å‰ï¼Œisaä»…ä»…æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œä¿å­˜ç€ç±»å¯¹è±¡æˆ–å…ƒç±»å¯¹è±¡çš„å†…å­˜åœ°å€ åœ¨arm64æ¶æ„ä¹‹å,è‹¹æœå¯¹isaè¿›è¡Œäº†ä¼˜åŒ–,å˜æˆäº†ä¸€ä¸ªisa_tç±»å‹çš„è”åˆä½“ç»“æ„,åŒæ—¶ä½¿ç”¨ä½åŸŸæ¥å­˜å‚¨æ›´å¤šçš„ä¿¡æ¯: å¯¹è±¡çš„isaæŒ‡é’ˆå¹¶ä¸æ˜¯ç›´æ¥æŒ‡å‘ç±»å¯¹è±¡æˆ–è€…å…ƒç±»å¯¹è±¡çš„å†…å­˜åœ°å€ï¼Œè€Œæ˜¯éœ€è¦&amp; ISA_MASKæ‰èƒ½è·å–ç±»å¯¹è±¡æˆ–è€…å…ƒç±»å¯¹è±¡çš„åœ°å€ã€‚ äºŒã€ å†…å®¹è¡¥å……2.1 ä½è¿ç®—ç¬¦ ä½è¿ç®—ç¬¦ç”¨æ¥å¯¹äºŒè¿›åˆ¶ä½è¿›è¡Œæ“ä½œ æ“ä½œæ•°åªèƒ½ä¸ºæ•´å‹å’Œå­—ç¬¦å‹æ•°æ®ã€‚ Cè¯­è¨€ä¸­å…­ç§ä½è¿ç®—ç¬¦ï¼š&amp;æŒ‰ä½ä¸ã€|æŒ‰ä½æˆ–ã€^æŒ‰ä½å¼‚æˆ–ã€~éã€&lt;&lt;å·¦ç§»å’Œ&gt;&gt;å³ç§»ã€‚ 1)æŒ‰ä½ä¸&amp; å…¨1å‡º1 A B &amp; 0 0 0 1 0 0 0 1 0 1 1 1 2)æŒ‰ä½æˆ– | æœ‰1å‡º1 A B I 0 0 0 1 0 1 0 1 1 1 1 1 3)æŒ‰ä½å¼‚æˆ–^ ç›¸åŒä¸º0,ä¸åŒä¸º1. A B ^ 0 0 0 1 0 1 0 1 1 1 1 0 4)é ~ éè¿ç®—å³å–åè¿ç®—ï¼Œåœ¨äºŒè¿›åˆ¶ä¸­ 1 å˜ 0 ï¼Œ0 å˜ 1ã€‚ä¾‹å¦‚110101è¿›è¡Œéè¿ç®—åä¸º001010ï¼Œå³1010. 5)å·¦ç§» &lt;&lt; å·¦ç§»è¿ç®—å°±æ˜¯æŠŠ&lt;&lt;å·¦è¾¹çš„è¿ç®—æ•°çš„å„äºŒè¿›ä½å…¨éƒ¨å·¦ç§»è‹¥å¹²ä½ï¼Œç§»åŠ¨çš„ä½æ•°å³&lt;&lt;å³è¾¹çš„æ•°çš„æ•°å€¼ã€‚ é«˜ä½ä¸¢å¼ƒï¼Œä½ä½è¡¥0ã€‚ å·¦ç§»nä½å°±æ˜¯ä¹˜ä»¥2çš„næ¬¡æ–¹ã€‚ä¾‹å¦‚ï¼ša&lt;&lt;4æ˜¯æŒ‡æŠŠaçš„å„äºŒè¿›ä½å‘å·¦ç§»åŠ¨4ä½ã€‚å¦‚åŸæ¥a=00000011(åè¿›åˆ¶3)ï¼Œå·¦ç§»4ä½åä¸º00110000(åè¿›åˆ¶48)ã€‚ 6)å³ç§» &gt;&gt; å³ç§»è¿ç®—å°±æ˜¯æŠŠ&gt;&gt;å·¦è¾¹çš„è¿ç®—æ•°çš„å„äºŒè¿›ä½å…¨éƒ¨å³ç§»è‹¥å¹²ä½ï¼Œ&gt;&gt;å³è¾¹çš„æ•°æŒ‡å®šç§»åŠ¨çš„ä½æ•°ã€‚ä¾‹å¦‚ï¼šè®¾ a=15ï¼Œa&gt;&gt;2 è¡¨ç¤ºæŠŠ00001111å³ç§»ä¸º00000011(åè¿›åˆ¶3) 2.2 ä½è¿ç®—ç¬¦çš„è¿ç”¨1)å–å€¼ å¯ä»¥åˆ©ç”¨æŒ‰ä½ä¸ &amp;è¿ç®—å–å‡ºæŒ‡å®šä½çš„å€¼ å…·ä½“æ“ä½œæ˜¯æƒ³å–å‡ºå“ªä¸€ä½çš„å€¼å°±å°†é‚£ä¸€ä½ç½®ä¸º1,å…¶å®ƒä½éƒ½ä¸º0,ç„¶ååŒåŸæ•°æ®è¿›è¡ŒæŒ‰ä½ä¸è®¡ç®—,å³å¯å–å‡ºç‰¹å®šçš„ä½. ä¾‹: 0000 0011å–å‡ºå€’æ•°ç¬¬ä¸‰ä½çš„å€¼ 123456// æƒ³å–å‡ºå€’æ•°ç¬¬ä¸‰ä½çš„å€¼ï¼Œå°±å°†å€’æ•°ç¬¬ä¸‰ä½çš„å€¼ç½®ä¸º1ï¼Œå…¶å®ƒä½ä¸º0ï¼Œè·ŸåŸæ•°æ®æŒ‰ä½ä¸è¿ç®— 0000 0011 (æºç )&amp; 0000 0100 ï¼ˆæ©ç ï¼‰------------ 0000 0000 // å¾—å‡ºæŒ‰ä½ä¸è¿ç®—åçš„ç»“æœï¼Œå³å¯æ‹¿åˆ°åŸæ•°æ®ä¸­å€’æ•°ç¬¬ä¸‰ä½çš„å€¼ä¸º0 ä¸Šé¢çš„ä¾‹å­ä¸­,æˆ‘ä»¬ä»0000 0011ä¸­å–å€¼,åˆ™æœ‰0000 0011è¢«ç§°ä¹‹ä¸ºæºç .è¿›è¡ŒæŒ‰ä½ä¸æ“ä½œè®¾å®šçš„0000 0100ç§°ä¹‹ä¸ºæ©ç . ä¾‹: 0000 0011å–å‡ºåä¸‰ä½çš„å€¼ 123456// æƒ³å–å‡ºåä¸‰ä½çš„å€¼ï¼Œå°±å°†æ©ç åä¸‰ä½ç½®ä¸º1ï¼Œå…¶å®ƒä½ä¸º0ï¼Œè·ŸåŸæ•°æ®æŒ‰ä½ä¸è¿ç®— 0000 0011 (æºç )&amp; 0000 0111 ï¼ˆæ©ç ï¼‰------------ 0000 0011 // å¾—å‡ºæŒ‰ä½ä¸è¿ç®—åçš„ç»“æœï¼Œå³å¯æ‹¿åˆ°åŸæ•°æ®ä¸­åä¸‰ä½çš„å€¼ä¸º011 2)è®¾å€¼ å¯ä»¥é€šè¿‡æŒ‰ä½æˆ– |æˆ–è€…æŒ‰ä½ä¸ &amp;è¿ç®—ç¬¦å°†æŸä¸€ä½çš„å€¼è®¾ä¸º1æˆ–0. è¦å°†æŸä¸€ä½çš„å€¼ç½®ä¸º1çš„è¯ï¼Œé‚£ä¹ˆå°±å°†æ©ç ä¸­å¯¹åº”ä½çš„å€¼è®¾ä¸º1ï¼Œæ©ç å…¶å®ƒä½ä¸º0ï¼Œå°†æºç ä¸æ©ç è¿›è¡ŒæŒ‰ä½æˆ–|æ“ä½œå³å¯. ä¾‹: å°†0000 0011å€’æ•°ç¬¬ä¸‰ä½çš„å€¼æ”¹ä¸º1 12345// æ”¹å˜å€’æ•°ç¬¬ä¸‰ä½çš„å€¼ï¼Œå°±å°†æ©ç å€’æ•°ç¬¬ä¸‰ä½çš„å€¼ç½®ä¸º1ï¼Œå…¶å®ƒä½ä¸º0ï¼Œè·Ÿæºç æŒ‰ä½æˆ–è¿ç®— 0000 0011| 0000 0100------------ 0000 0111 // å³å¯å°†æºç ä¸­å€’æ•°ç¬¬ä¸‰ä½çš„å€¼æ”¹ä¸º1 è¦å°†æŸä¸€ä½çš„å€¼ç½®ä¸º0çš„è¯ï¼Œé‚£ä¹ˆå°±å°†æ©ç ä¸­å¯¹åº”ä½çš„å€¼è®¾ä¸º0ï¼Œæ©ç å…¶å®ƒä½ä¸º1ï¼Œå°†æºç ä¸æ©ç è¿›è¡ŒæŒ‰ä½ä¸&amp;æ“ä½œå³å¯. ä¾‹: å°†0000 0011å€’æ•°ç¬¬äºŒä½çš„å€¼æ”¹ä¸º0 12345// æ”¹å˜å€’æ•°ç¬¬äºŒä½çš„å€¼ï¼Œå°±å°†æ©ç å€’æ•°ç¬¬äºŒä½çš„å€¼ç½®ä¸º0ï¼Œå…¶å®ƒä½ä¸º1ï¼Œè·Ÿæºç `æŒ‰ä½ä¸&amp;`è¿ç®— 0000 0011&amp; 1111 1101------------ 0000 0001 // å³å¯å°†æºç ä¸­å€’æ•°ç¬¬äºŒä½çš„å€¼æ”¹ä¸º0 3)å®é™…åº”ç”¨ å£°æ˜ä¸€ä¸ªTCJCarç±»ï¼Œç±»ä¸­æœ‰å››ä¸ªBOOLç±»å‹çš„å±æ€§,åˆ†åˆ«ä¸ºfrontã€backã€leftã€right,é€šè¿‡è¿™å››ä¸ªå±æ€§æ¥åˆ¤æ–­è¿™è¾†å°è½¦çš„è¡Œé©¶æ–¹å‘. ç„¶åæˆ‘ä»¬æ¥æŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ªTCJCarç±»å¯¹è±¡æ‰€å æ®çš„å†…å­˜å¤§å°: æˆ‘ä»¬çœ‹åˆ°,ä¸€ä¸ªTCJCarç±»çš„å¯¹è±¡å æ®16ä¸ªå­—èŠ‚.å…¶ä¸­åŒ…æ‹¬ä¸€ä¸ªisaæŒ‡é’ˆå’Œå››ä¸ªBOOLç±»å‹çš„å±æ€§,8+1+1+1+1=12,æ ¹æ®å†…å­˜å¯¹é½åŸåˆ™,æ‰€ä»¥ä¸€ä¸ªTCJCarç±»çš„å¯¹è±¡å 16ä¸ªå­—èŠ‚. æˆ‘ä»¬çŸ¥é“,BOOLå€¼åªæœ‰ä¸¤ç§æƒ…å†µ:0æˆ–1ï¼Œå æ®ä¸€ä¸ªå­—èŠ‚çš„å†…å­˜ç©ºé—´.è€Œä¸€ä¸ªå­—èŠ‚çš„å†…å­˜ç©ºé—´ä¸­åˆæœ‰8ä¸ªäºŒè¿›åˆ¶ä½ï¼Œå¹¶ä¸”äºŒè¿›åˆ¶åŒæ ·åªæœ‰0æˆ–1ï¼Œé‚£ä¹ˆæˆ‘ä»¬å®Œå…¨å¯ä»¥ä½¿ç”¨1ä¸ªäºŒè¿›åˆ¶ä½æ¥è¡¨ç¤ºä¸€ä¸ªBOOLå€¼ã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¸Šé¢å£°æ˜çš„å››ä¸ªBOOLå€¼æœ€ç»ˆåªä½¿ç”¨4ä¸ªäºŒè¿›åˆ¶ä½å°±å¯ä»¥ä»£æ›¿ï¼ˆåŠä¸ªå­—èŠ‚ï¼‰ï¼Œè¿™æ ·å°±èŠ‚çœäº†å†…å­˜ç©ºé—´ã€‚é‚£æˆ‘ä»¬å¦‚ä½•å®ç°å‘¢ï¼Ÿ æƒ³è¦å®ç°å››ä¸ªBOOLå€¼å­˜æ”¾åœ¨ä¸€ä¸ªå­—èŠ‚ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡charç±»å‹çš„æˆå‘˜å˜é‡æ¥å®ç°ã€‚ charç±»å‹å ä¸€ä¸ªå­—èŠ‚å†…å­˜ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯8ä¸ªäºŒè¿›åˆ¶ä½.å¯ä»¥ä½¿ç”¨å…¶ä¸­æœ€åå››ä¸ªäºŒè¿›åˆ¶ä½æ¥å­˜å‚¨4ä¸ªBOOLå€¼ã€‚ (å½“ç„¶ä¸èƒ½æŠŠcharç±»å‹å†™æˆå±æ€§,å› ä¸ºä¸€æ—¦å†™æˆå±æ€§,ç³»ç»Ÿä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬æ·»åŠ æˆå‘˜å˜é‡,è‡ªåŠ¨å®ç°setå’Œgetæ–¹æ³•) 123@interface TCJCar(){ char _frontBackLeftRight;} å¦‚æœæˆ‘ä»¬èµ‹å€¼_frontBackLeftRightä¸º1,å³0b 0000 0001,åªä½¿ç”¨8ä¸ªäºŒè¿›åˆ¶ä½ä¸­çš„æœ€å4ä¸ªåˆ†åˆ«ç”¨0æˆ–è€…1æ¥ä»£è¡¨frontã€backã€leftã€rightçš„å€¼.é‚£ä¹ˆæ­¤æ—¶frontã€backã€leftã€rightçš„çŠ¶æ€ä¸º: ç»“åˆæˆ‘ä»¬ä¸Šæ–‡è®²çš„6ç§ä½è¿ç®—ç¬¦ä»¥åŠä½¿ç”¨åœºæ™¯,æˆ‘ä»¬å¯ä»¥åˆ†åˆ«å£°æ˜frontã€backã€leftã€rightçš„æ©ç ,æ¥æ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œä¸‹ä¸€æ­¥çš„ä½è¿ç®—å–å€¼å’Œèµ‹å€¼: 1234#define TCJDirectionFrontMask 0b00001000 //æ­¤äºŒè¿›åˆ¶æ•°å¯¹åº”åè¿›åˆ¶æ•°ä¸º 8#define TCJDirectionBackMask 0b00000100 //æ­¤äºŒè¿›åˆ¶æ•°å¯¹åº”åè¿›åˆ¶æ•°ä¸º 4#define TCJDirectionLeftMask 0b00000010 //æ­¤äºŒè¿›åˆ¶æ•°å¯¹åº”åè¿›åˆ¶æ•°ä¸º 2#define TCJDirectionRightMask 0b00000001 //æ­¤äºŒè¿›åˆ¶æ•°å¯¹åº”åè¿›åˆ¶æ•°ä¸º 1 é€šè¿‡å¯¹ä½è¿ç®—ç¬¦çš„å·¦ç§»&lt;&lt;å’Œå³ç§»&gt;&gt;çš„äº†è§£ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸Šé¢çš„ä»£ç ä¼˜åŒ–æˆï¼š 1234#define TCJDirectionFrontMask (1 &lt;&lt; 3)#define TCJDirectionBackMask (1 &lt;&lt; 2)#define TCJDirectionLeftMask (1 &lt;&lt; 1)#define TCJDirectionRightMask (1 &lt;&lt; 0) è‡ªå®šä¹‰çš„setæ–¹æ³•å¦‚ä¸‹: 1234567891011121314151617181920212223242526272829303132- (void)setFront:(BOOL)front{ if (front) {// å¦‚æœéœ€è¦å°†å€¼ç½®ä¸º1ï¼Œå°†æºç å’Œæ©ç è¿›è¡ŒæŒ‰ä½æˆ–è¿ç®— _frontBackLeftRight |= TCJDirectionFrontMask; } else {// å¦‚æœéœ€è¦å°†å€¼ç½®ä¸º0 // å°†æºç å’ŒæŒ‰ä½å–ååçš„æ©ç è¿›è¡ŒæŒ‰ä½ä¸è¿ç®— _frontBackLeftRight &amp;= ~TCJDirectionFrontMask; }}- (void)setBack:(BOOL)back{ if (back) { _frontBackLeftRight |= TCJDirectionBackMask; } else { _frontBackLeftRight &amp;= ~TCJDirectionBackMask; }}- (void)setLeft:(BOOL)left{ if (left) { _frontBackLeftRight |= TCJDirectionLeftMask; } else { _frontBackLeftRight &amp;= ~TCJDirectionLeftMask; }}- (void)setRight:(BOOL)right{ if (right) { _frontBackLeftRight |= TCJDirectionRightMask; } else { _frontBackLeftRight &amp;= ~TCJDirectionRightMask; }} è‡ªå®šä¹‰çš„getæ–¹æ³•å¦‚ä¸‹: 12345678910111213141516- (BOOL)isFront{ return !!(_frontBackLeftRight &amp; TCJDirectionFrontMask);}- (BOOL)isBack{ return !!(_frontBackLeftRight &amp; TCJDirectionBackMask);}- (BOOL)isLeft{ return !!(_frontBackLeftRight &amp; TCJDirectionLeftMask);}- (BOOL)isRight{ return !!(_frontBackLeftRight &amp; TCJDirectionRightMask);} æ­¤å¤„éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä»£ç ä¸­!ä¸ºé€»è¾‘è¿ç®—ç¬¦éï¼Œå› ä¸º_frontBackLeftRight &amp; TCJDirectionFrontMaskä»£ç æ‰§è¡Œåï¼Œè¿”å›çš„è‚¯å®šæ˜¯ä¸€ä¸ªæ•´å‹æ•°ï¼Œå¦‚å½“frontä¸ºYESæ—¶ï¼Œè¯´æ˜äºŒè¿›åˆ¶æ•°ä¸º0b 0000 1000ï¼Œå¯¹åº”çš„åè¿›åˆ¶æ•°ä¸º8ï¼Œé‚£ä¹ˆè¿›è¡Œä¸€æ¬¡é€»è¾‘éè¿ç®—åï¼Œ!(8)çš„å€¼ä¸º0ï¼Œå¯¹0å†è¿›è¡Œä¸€æ¬¡é€»è¾‘éè¿ç®—!(0)ï¼Œç»“æœå°±æˆäº†1ï¼Œé‚£ä¹ˆæ­£å¥½è·Ÿfrontä¸ºYESå¯¹åº”.æ‰€ä»¥æ­¤å¤„è¿›è¡Œä¸¤æ¬¡é€»è¾‘éè¿ç®—ï¼Œ!!ã€‚ å½“ç„¶,è¿˜è¦å®ç°åˆå§‹åŒ–æ–¹æ³•: 12345678- (instancetype)init{ self = [super init]; if (self) { _frontBackLeftRight = 0b00001000; } return self;} é€šè¿‡æµ‹è¯•éªŒè¯,æˆ‘ä»¬å®Œæˆäº†å–å€¼å’Œèµ‹å€¼: 2.3 ä½åŸŸæœ‰äº›ä¿¡æ¯åœ¨å­˜å‚¨æ—¶ï¼Œå¹¶ä¸éœ€è¦å ç”¨ä¸€ä¸ªå®Œæ•´çš„å­—èŠ‚(8ä¸ªäºŒè¿›åˆ¶ä½)ï¼Œ è€Œåªéœ€å å‡ ä¸ªæˆ–ä¸€ä¸ªäºŒè¿›åˆ¶ä½ã€‚â€œä½åŸŸâ€æ˜¯æŠŠä¸€ä¸ªå­—èŠ‚ä¸­çš„äºŒè¿›ä½åˆ’åˆ†ä¸ºå‡ ä¸ªä¸åŒçš„åŒºåŸŸï¼Œ å¹¶è¯´æ˜æ¯ä¸ªåŒºåŸŸçš„ä½æ•°ã€‚æ¯ä¸ªåŒºåŸŸå°±å¯ä»¥å­˜å‚¨ä¸€æ®µä¿¡æ¯ï¼Œè¿™æ ·å°±å¯ä»¥æŠŠä¿¡æ¯ç”¨ä¸€ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºã€‚ 2.4 è”åˆä½“è¿™é‡Œé€šè¿‡ä¸structçš„å¯¹æ¯”æ¥ç†è§£union: â‘ ä¸¤è€…éƒ½å¯ä»¥åŒ…å«å¤šä¸ªä¸åŒç±»å‹çš„æ•°æ®ï¼Œå¦‚intã€doubleã€Classç­‰ã€‚ â‘¡åœ¨structä¸­å„æˆå‘˜æœ‰å„è‡ªçš„å†…å­˜ç©ºé—´ï¼Œä¸€ä¸ªstructå˜é‡çš„å†…å­˜æ€»é•¿åº¦å¤§äºç­‰äºå„æˆå‘˜å†…å­˜é•¿åº¦ä¹‹å’Œï¼›è€Œåœ¨unionä¸­ï¼Œå„æˆå‘˜å…±äº«ä¸€æ®µå†…å­˜ç©ºé—´ï¼Œä¸€ä¸ªunionçš„å†…å­˜æ€»é•¿åº¦ç­‰äºå„æˆå‘˜ä¸­å†…å­˜æœ€é•¿çš„é‚£ä¸ªæˆå‘˜çš„å†…å­˜é•¿åº¦ã€‚ â‘¢å¯¹structä¸­çš„æˆå‘˜è¿›è¡Œèµ‹å€¼ï¼Œä¸ä¼šå½±å“å…¶ä»–æˆå‘˜çš„å€¼ï¼›å¯¹unionä¸­çš„æˆå‘˜èµ‹å€¼æ—¶ï¼Œæ¯æ¬¡åªèƒ½ç»™ä¸€ä¸ªæˆå‘˜èµ‹å€¼ï¼ŒåŒæ—¶å…¶å®ƒæˆå‘˜çš„å€¼ä¹Ÿå°±ä¸å­˜åœ¨äº†ã€‚ å†™æ³•ï¼š 123union è”åˆä½“å{ æˆå‘˜åˆ—è¡¨} 2.5 oc ä¸­çš„ GDB è°ƒè¯•2.5.1 ç®€ä»‹GDBï¼ˆGNU Debuggerï¼‰æ˜¯ UNIX åŠ UNIX-like ä¸‹çš„å¼ºå¤§è°ƒè¯•å·¥å…·ï¼Œå¯ä»¥è°ƒè¯•ada, c, c++, asm, minimal, d, fortran, Objective-c, go, java,pascalç­‰è¯­è¨€ã€‚ 2.5.2 åœ¨ iOS å¼€å‘ä¸­çš„ä½œç”¨â‘  æ™®é€šå˜é‡æŸ¥çœ‹ ä½¿ç”¨ p å˜é‡åå³å¯ï¼š 12(gdb) p a$1 = 10 â‘¡ æ‰“å°æŒ‡é’ˆæŒ‡å‘å†…å®¹ å¦‚æœè¿˜æ˜¯ä½¿ç”¨ä¸Šé¢çš„æ–¹å¼æ‰“å°æŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ï¼Œé‚£ä¹ˆæ‰“å°å‡ºæ¥çš„åªæ˜¯æŒ‡é’ˆåœ°å€è€Œå·²ï¼Œä¾‹å¦‚ï¼š 12(gdb) p d$1 = (int *) 0x602010 è€Œå¦‚æœæƒ³è¦æ‰“å°æŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ï¼Œéœ€è¦è§£å¼•ç”¨ï¼š 12(gdb) p *d$2 = 0 â‘¢ æŒ‰ç…§ç‰¹å®šæ ¼å¼æ‰“å°å˜é‡ å¯¹äºç®€å•çš„æ•°æ®ï¼Œpé»˜è®¤çš„æ‰“å°æ–¹å¼å·²ç»è¶³å¤Ÿäº†ï¼Œå®ƒä¼šæ ¹æ®å˜é‡ç±»å‹çš„æ ¼å¼æ‰“å°å‡ºæ¥ï¼Œä½†æ˜¯æœ‰æ—¶å€™è¿™è¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬éœ€è¦æ›´å¤šçš„æ ¼å¼æ§åˆ¶ã€‚ä½¿ç”¨æ ¼å¼æ§åˆ¶å­—ç¬¦æ¥æ§åˆ¶ æ­£å¸¸æ–¹å¼æ‰“å°å­—ç¬¦æ•°ç»„cï¼š 12(gdb) p c$18 = &quot;hello world&quot; æŸ¥çœ‹å®ƒçš„åå…­è¿›åˆ¶æ ¼å¼æ‰“å°: 123(gdb) p/x c$19 = {0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x2c, 0x73, 0x68, 0x6f, 0x75, 0x77, 0x61, 0x6e, 0x67, 0x0} ä½†æ˜¯å¦‚æœæˆ‘ä»¬æƒ³ç”¨è¿™ç§æ–¹å¼æŸ¥çœ‹æµ®ç‚¹æ•°çš„äºŒè¿›åˆ¶æ ¼å¼æ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºç›´æ¥æ‰“å°å®ƒé¦–å…ˆä¼šè¢«è½¬æ¢æˆæ•´å‹ï¼Œå› æ­¤æœ€ç»ˆä¼šå¾—åˆ°8ï¼š 12345(gdb) p e$1 = 8.5(gdb) p/t e$2 = 1000 â‘£ æŸ¥çœ‹å†…å­˜å†…å®¹ examine(ç®€å†™ä¸ºx)å¯ä»¥ç”¨æ¥æŸ¥çœ‹å†…å­˜åœ°å€ä¸­çš„å€¼ã€‚è¯­æ³•å¦‚ä¸‹ï¼š 1x/[n][f][u] addr å…¶ä¸­ï¼š n è¡¨ç¤ºè¦æ˜¾ç¤ºçš„å†…å­˜å•å…ƒæ•°ï¼Œé»˜è®¤å€¼ä¸º1(æƒ³æ‰“å¤šå°‘æ®µå°±å†™å‡ ) f è¡¨ç¤ºè¦æ‰“å°çš„æ ¼å¼ï¼Œé€šè¿‡æ ¼å¼æ§åˆ¶å­—ç¬¦æ§åˆ¶ u è¦æ‰“å°çš„å•å…ƒé•¿åº¦ addr å†…å­˜åœ°å€ æ ¼å¼æ§åˆ¶å­—ç¬¦ï¼š x æŒ‰åå…­è¿›åˆ¶æ ¼å¼æ˜¾ç¤ºå˜é‡ã€å¸¸ç”¨ã€‘ d æŒ‰åè¿›åˆ¶æ ¼å¼æ˜¾ç¤ºå˜é‡ u æŒ‰åå…­è¿›åˆ¶æ ¼å¼æ˜¾ç¤ºæ— ç¬¦å·æ•´å‹ o æŒ‰å…«è¿›åˆ¶æ ¼å¼æ˜¾ç¤ºå˜é‡ t æŒ‰äºŒè¿›åˆ¶æ ¼å¼æ˜¾ç¤ºå˜é‡ a æŒ‰åå…­è¿›åˆ¶æ ¼å¼æ˜¾ç¤ºå˜é‡ c æŒ‰å­—ç¬¦æ ¼å¼æ˜¾ç¤ºå˜é‡ f æŒ‰æµ®ç‚¹æ•°æ ¼å¼æ˜¾ç¤ºå˜é‡ å•å…ƒé•¿åº¦ï¼š g å…«å­—èŠ‚ã€å¸¸ç”¨ã€‘ b å­—èŠ‚ h åŠå­—ï¼Œå³åŒå­—èŠ‚ w å­—ï¼Œå³å››å­—èŠ‚ ä¸¾ä¾‹ï¼š 1234x/4xg p // æ‰“å° p çš„å†…å­˜å†…å®¹ // æ‰“4æ®µå†…å­˜å†…å®¹ // 16è¿›åˆ¶æ‰“å° // æ¯æ®µå†…å­˜å†…å®¹æ‰“å°8å­—èŠ‚ ä¸‰ã€ isa ä»‹ç»3.1 å‰è¨€å›é¡¾ä¸Šç¯‡æ–‡ç« ä¸­çš„ä»£ç : 12345678910111213141516171819202122232425262728293031323334353637383940414243444546static __attribute__((always_inline)) id_class_createInstanceFromZone(Class cls, size_t extraBytes, void *zone, bool cxxConstruct = true, size_t *outAllocatedSize = nil){ if (!cls) return nil; assert(cls-&gt;isRealized()); // ä¸€æ¬¡è¯»å–ç±»çš„ä¿¡æ¯ä½ä»¥æé«˜æ€§èƒ½ bool hasCxxCtor = cls-&gt;hasCxxCtor(); // æ˜¯å¦æœ‰æ„é€ å‡½æ•° bool hasCxxDtor = cls-&gt;hasCxxDtor(); // æ˜¯å¦æœ‰ææ„å‡½æ•° bool fast = cls-&gt;canAllocNonpointer(); // OC 2.0ä»¥ä¸ŠåŸºæœ¬ä¸Šè¿”å›çš„éƒ½æ˜¯true // è®¡ç®—å†…å­˜ size_t size = cls-&gt;instanceSize(extraBytes); if (outAllocatedSize) *outAllocatedSize = size; id obj; if (!zone &amp;&amp; fast) { // åˆ†é…1å—å¤§å°ä¸ºsizeçš„è¿ç»­å†…å­˜ obj = (id)calloc(1, size); if (!obj) return nil; // åˆå§‹åŒ–å¯¹è±¡çš„isa obj-&gt;initInstanceIsa(cls, hasCxxDtor); } else { if (zone) { obj = (id)malloc_zone_calloc ((malloc_zone_t *)zone, 1, size); } else { obj = (id)calloc(1, size); } if (!obj) return nil; // Use raw pointer isa on the assumption that they might be // doing something weird with the zone or RR. obj-&gt;initIsa(cls); } if (cxxConstruct &amp;&amp; hasCxxCtor) { obj = _objc_constructOrFree(obj, cls); } return obj;} åœ¨ä¸Šæ–‡ä¸­æˆ‘ä»¬çŸ¥é“allocåº•å±‚ä¼šè°ƒç”¨callocåˆ†é…å†…å­˜ï¼Œæ¥ç€å°±æ˜¯initInstanceIsa(cls, hasCxxDtor)ï¼Œé¡¾åæ€ä¹‰æ˜¯åˆå§‹åŒ–å¯¹è±¡çš„isaï¼Œå…¶å…³é”®ä»£ç å¦‚ä¸‹ 1234567891011121314151617181920212223242526272829303132333435363738394041inline void objc_object::initInstanceIsa(Class cls, bool hasCxxDtor){ assert(!cls-&gt;instancesRequireRawIsa()); assert(hasCxxDtor == cls-&gt;hasCxxDtor()); // ç•™æ„è¿™é‡Œçš„true initIsa(cls, true, hasCxxDtor);}inline void objc_object::initIsa(Class cls, bool nonpointer, bool hasCxxDtor) { assert(!isTaggedPointer()); if (!nonpointer) { isa.cls = cls; } else { assert(!DisableNonpointerIsa); assert(!cls-&gt;instancesRequireRawIsa()); isa_t newisa(0);#if SUPPORT_INDEXED_ISA assert(cls-&gt;classArrayIndex() &gt; 0); newisa.bits = ISA_INDEX_MAGIC_VALUE; // isa.magic is part of ISA_MAGIC_VALUE // isa.nonpointer is part of ISA_MAGIC_VALUE newisa.has_cxx_dtor = hasCxxDtor; newisa.indexcls = (uintptr_t)cls-&gt;classArrayIndex();#else newisa.bits = ISA_MAGIC_VALUE; // isa.magic is part of ISA_MAGIC_VALUE // isa.nonpointer is part of ISA_MAGIC_VALUE newisa.has_cxx_dtor = hasCxxDtor; newisa.shiftcls = (uintptr_t)cls &gt;&gt; 3;#endif isa = newisa; }} Tagged Pointer: æ®è¯´ï¼Œä¸ºäº†èŠ‚çœå†…å­˜å’Œæé«˜æ‰§è¡Œæ•ˆç‡ï¼Œè‹¹æœæå‡ºäº†Tagged Pointerçš„æ¦‚å¿µã€‚å¯¹äº 64 ä½ç¨‹åºï¼Œå¼•å…¥Tagged Pointeråï¼Œç›¸å…³é€»è¾‘èƒ½å‡å°‘ä¸€åŠçš„å†…å­˜å ç”¨ï¼Œä»¥åŠ 3å€ çš„è®¿é—®é€Ÿåº¦æå‡ï¼Œ100å€ çš„åˆ›å»ºã€é”€æ¯é€Ÿåº¦æå‡ã€‚ Tagged Pointeré¦–æ¬¡åº”ç”¨äºiPhone 5sè®¾å¤‡ä¸Šï¼Œç°åœ¨å‡ ä¹éƒ½åº”ç”¨Tagged Pointeräº†ã€‚æƒ³äº†è§£æ›´å¤šå…³äºTagged Pointerçš„å†…å®¹å¯å‚è€ƒï¼š æ·±å…¥ç†è§£ Tagged Pointerã€‚ 3.2 isa çš„ç»“æ„ç‚¹å‡»objc_object::initIsa()ä¸­çš„isaï¼Œå‘ç°isaæ˜¯isa_tç±»å‹ 123456789101112union isa_t { isa_t() { } isa_t(uintptr_t value) : bits(value) { } Class cls; uintptr_t bits;#if defined(ISA_BITFIELD) struct { ISA_BITFIELD; // ä½åŸŸ };#endif}; è€Œisa_tå®é™…ä¸Šæ˜¯ä¸€ä¸ªunionï¼Œå³è”åˆä½“ï¼Œå 8ä¸ªå­—èŠ‚ï¼Œå®ƒçš„ç‰¹æ€§å°±æ˜¯å…±ç”¨å†…å­˜ï¼Œæˆ–è€…è¯´æ˜¯äº’æ–¥ï¼Œæ¯”å¦‚è¯´å¦‚æœclsèµ‹å€¼äº†å°±ä¸åœ¨å¯¹bitsè¿›è¡Œèµ‹å€¼ã€‚ 3.2.1 isa çš„ bits æˆå‘˜å˜é‡3.2.2 isaçš„ cls æˆå‘˜å˜é‡å®ƒæ˜¯Classç±»å‹ï¼Œæºç ï¼š 12345678910111213141516171819202122typedef struct objc_class *Class;// é¡ºä¾¿äº†è§£ä¸€ä¸‹idçš„ç±»å‹ï¼Œæ˜¾ç„¶idæ˜¯ä¸ªæŒ‡é’ˆå˜é‡ï¼Œå®ƒçš„å€¼åªæœ‰ä¸€ä¸ªisaå˜é‡typedef struct objc_object *id;struct objc_class : objc_object { // Class ISA; Class superclass; cache_t cache; class_data_bits_t bits; class_rw_t *data() { return bits.data(); } ... // ä¸€äº›æ–¹æ³•};struct objc_object {private: isa_t isa; ... // ä¸€äº›å…¬æœ‰ã€ç§æœ‰æ–¹æ³•}; ä»æºç å¾—çŸ¥ï¼ŒClasså®é™…ä¸Šæ˜¯objc_classç»“æ„ä½“çš„æŒ‡é’ˆå˜é‡ï¼Œè€Œobjc_classåˆç»§æ‰¿è‡ªobjc_objectï¼ˆè¯´æ˜ç±»æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼‰ï¼Œå› æ­¤Classè¿™ä¸ªç»“æ„ä½“æŒ‡é’ˆå˜é‡çš„å€¼å†…éƒ¨æœ‰ä¸€ä¸ªisaæˆå‘˜å˜é‡ï¼ˆç±»å‹ä¸ºisa_tï¼‰ï¼Œè¿™ä¸ªisaæˆå‘˜å˜é‡åœ¨64ä½CPUæ¶æ„ä¸‹æ˜¯8å­—èŠ‚ï¼Œä¸”æ’åœ¨objc_classç»“æ„ä½“çš„å‰8å­—èŠ‚ã€‚ 3.2.3 isa çš„ä½åŸŸæŸ¥çœ‹ISA_BITFIELDï¼š æ¨¡æ‹Ÿå™¨ï¼š 12345678910111213141516# elif __x86_64__# define ISA_MASK 0x00007ffffffffff8ULL# define ISA_MAGIC_MASK 0x001f800000000001ULL# define ISA_MAGIC_VALUE 0x001d800000000001ULL# define ISA_BITFIELD \\ uintptr_t nonpointer : 1; \\ uintptr_t has_assoc : 1; \\ uintptr_t has_cxx_dtor : 1; \\ uintptr_t shiftcls : 44; /*MACH_VM_MAX_ADDRESS 0x7fffffe00000*/ \\ uintptr_t magic : 6; \\ uintptr_t weakly_referenced : 1; \\ uintptr_t deallocating : 1; \\ uintptr_t has_sidetable_rc : 1; \\ uintptr_t extra_rc : 8# define RC_ONE (1ULL&lt;&lt;56)# define RC_HALF (1ULL&lt;&lt;7) çœŸæœºï¼š 12345678910111213141516# if __arm64__# define ISA_MASK 0x0000000ffffffff8ULL# define ISA_MAGIC_MASK 0x000003f000000001ULL# define ISA_MAGIC_VALUE 0x000001a000000001ULL# define ISA_BITFIELD \\ uintptr_t nonpointer : 1; \\ uintptr_t has_assoc : 1; \\ uintptr_t has_cxx_dtor : 1; \\ uintptr_t shiftcls : 33; /*MACH_VM_MAX_ADDRESS 0x1000000000*/ \\ uintptr_t magic : 6; \\ uintptr_t weakly_referenced : 1; \\ uintptr_t deallocating : 1; \\ uintptr_t has_sidetable_rc : 1; \\ uintptr_t extra_rc : 19# define RC_ONE (1ULL&lt;&lt;45)# define RC_HALF (1ULL&lt;&lt;18) é¦–å…ˆæ˜ç¡®ä¸€ç‚¹ï¼Œåœ¨64ä½CPUæ¶æ„ä¸‹isaæŒ‡é’ˆçš„é•¿åº¦ä¹Ÿæ˜¯8å­—èŠ‚ï¼Œå®ƒå¯ä»¥å­˜å‚¨è¶³å¤Ÿå¤šçš„å†…å®¹ï¼Œè‹¹æœä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼Œå­˜å‚¨ç±»åœ°å€åªç”¨äº†ä¸€éƒ¨åˆ†ä½ï¼ˆx86_64ä¸‹æ˜¯44ä½ï¼Œarm64ä¸‹æ˜¯33ä½ï¼‰ï¼Œå‰©ä¸‹çš„ä½ç”¨æ¥å­˜å‚¨ä¸€äº›å…¶å®ƒä¿¡æ¯ã€‚ å…·ä½“åˆ†æä¸€ä¸‹ISA_BITFIELDä½åŸŸå„æˆå‘˜çš„è¡¨ç¤ºæ„ä¹‰ï¼š nonpointerï¼šè¡¨ç¤ºæ˜¯å¦å¯¹isaæŒ‡é’ˆå¼€å¯æŒ‡é’ˆä¼˜åŒ–ã€‚ 0ï¼šä¸ä¼˜åŒ–ï¼Œæ˜¯çº¯isaæŒ‡é’ˆï¼Œå½“è®¿é—®isaæŒ‡é’ˆæ—¶ï¼Œç›´æ¥è¿”å›å…¶æˆå‘˜å˜é‡cls 1ï¼šä¼˜åŒ–ï¼Œå³isa æŒ‡é’ˆå†…å®¹ä¸æ­¢æ˜¯ç±»åœ°å€ï¼Œè¿˜åŒ…å«äº†ç±»çš„ä¸€äº›ä¿¡æ¯ã€å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ç­‰ã€‚ has_assocï¼šæ˜¯å¦æœ‰å…³è”å¯¹è±¡ã€‚ has_cxx_dtorï¼šè¯¥å¯¹è±¡æ˜¯å¦æœ‰C++æˆ–Objcçš„ææ„å™¨ã€‚ å¦‚æœæœ‰ææ„å‡½æ•°ï¼Œåˆ™éœ€è¦åšä¸€äº›ææ„çš„é€»è¾‘å¤„ç†ï¼› å¦‚æœæ²¡æœ‰ï¼Œåˆ™å¯ä»¥æ›´å¿«çš„é‡Šæ”¾å¯¹è±¡ã€‚ shiftclsï¼šå­˜å‚¨ç±»åœ°å€ã€‚å¼€å¯æŒ‡é’ˆä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œåœ¨ x86_64 æ¶æ„æœ‰ 44ä½ ç”¨æ¥å­˜å‚¨ç±»åœ°å€ï¼Œarm64 æ¶æ„ä¸­å  33ä½ ã€‚ magicï¼šç”¨äºè°ƒè¯•å™¨åˆ¤æ–­å½“å‰å¯¹è±¡æ˜¯çœŸçš„å¯¹è±¡ï¼Œè¿˜æ˜¯ä¸€æ®µæ²¡æœ‰åˆå§‹åŒ–çš„ç©ºé—´ã€‚ weakly_referencedï¼šç”¨äºæ ‡è¯†å¯¹è±¡æ˜¯å¦è¢«æŒ‡å‘æˆ–è€…æ›¾ç»è¢«æŒ‡å‘ä¸€ä¸ªARCçš„å¼±å˜é‡ï¼Œæ²¡æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡é‡Šæ”¾çš„æ›´å¿«ã€‚ deallocatingï¼šæ ‡è¯†å¯¹è±¡æ˜¯å¦æ­£åœ¨é‡Šæ”¾å†…å­˜ã€‚ has_sidetable_rcï¼šå¯¹è±¡çš„å¼•ç”¨è®¡æ•°å€¼æ˜¯å¦æœ‰è¿›ä½ã€‚ extra_rcï¼šè¡¨ç¤ºè¯¥å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å€¼ã€‚ extra_rcåªæ˜¯å­˜å‚¨äº†é¢å¤–çš„å¼•ç”¨è®¡æ•°ï¼Œå®é™…çš„å¼•ç”¨è®¡æ•°å…¬å¼ï¼šå®é™…å¼•ç”¨è®¡æ•° = extra_rc + 1ã€‚è¿™é‡Œå äº†8ä½ï¼Œæ‰€ä»¥ç†è®ºä¸Šå¯ä»¥å­˜å‚¨çš„æœ€å¤§å¼•ç”¨è®¡æ•°æ˜¯ï¼š2^8 - 1 + 1 = 256ï¼ˆarm64CPUæ¶æ„ä¸‹çš„extra_rcå 19ä½ï¼Œå¯å­˜å‚¨çš„æœ€å¤§å¼•ç”¨è®¡æ•°ä¸º2^19 - 1 + 1 = 524288ï¼‰ã€‚ ä¸has_sidetable_rcçš„å…³è”ï¼šå½“å¯¹è±¡çš„æœ€å¤§å¼•ç”¨è®¡æ•°è¶…è¿‡ç•Œé™åï¼Œhas_sidetable_rcçš„å€¼ä¸º1ï¼Œå¦åˆ™ä¸º0 3.5 isaçš„ä½œç”¨ä»objc_objectçš„ç»“æ„å¯ä»¥è¯´æ˜ï¼Œå½“ç³»ç»Ÿä¸ºä¸€ä¸ªå¯¹è±¡åˆ†é…å¥½å†…å­˜ï¼Œå¹¶åˆå§‹åŒ–å®ä¾‹å˜é‡åï¼Œåœ¨è¿™äº›å¯¹è±¡çš„å®ä¾‹å˜é‡çš„ç»“æ„ä½“ä¸­çš„ç¬¬ä¸€ä¸ªå°±æ˜¯isaã€‚ åŒæ—¶ï¼Œé€šè¿‡å¯¹isaçš„ä½åŸŸè¯´æ˜ï¼Œæˆ‘ä»¬çŸ¥é“shiftclså­˜å‚¨çš„æ˜¯ç±»åœ°å€ã€‚åœ¨arm64 æ¶æ„ä¸­å  33ä½ã€‚ æˆ‘ä»¬å°†ISA_MASKçš„å€¼0x0000000ffffffff8ULLè½¬åŒ–ä¸ºäºŒè¿›åˆ¶æ•°åˆ†æä¸€ä¸‹: ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ISA_MASKçš„å€¼è½¬åŒ–ä¸ºäºŒè¿›åˆ¶åä¸­é—´æœ‰33ä½éƒ½ä¸º1ï¼Œé‚£ä¹ˆisaæŒ‡é’ˆåŒISA_MASKè¿›è¡ŒæŒ‰ä½ä¸è¿ç®—å°±å¯ä»¥å–å‡ºä¸­é—´33ä½çš„å€¼ï¼Œè¿™æ­£æ˜¯ä¸­é—´å 33ä½çš„shiftclsï¼Œæ‰€ä»¥å°±å–å‡ºäº†ç±»å¯¹è±¡å’Œå…ƒç±»å¯¹è±¡çš„å†…å­˜åœ°å€ä¿¡æ¯ã€‚ ä¾‹ï¼š æ­¤æ—¶é€šè¿‡lldbå‘½ä»¤è°ƒè¯• è¯´æ˜ï¼š 0x001d800100001129æ˜¯å¯¹è±¡pçš„isaå€¼ï¼Œé€šè¿‡isa &amp; ISA_MASKè¿ç®—å¾—åˆ°çš„0x0000000100001128å°±æ˜¯Personç±»çš„åœ°å€ è¯æ˜ã€1ã€‘ï¼šé€šè¿‡p/x Person.classç›´æ¥æ‰“å°Personç±»åœ°å€ï¼Œæ˜¾ç„¶å¾—åˆ°çš„æ˜¯0x0000000100001128ï¼Œå¦‚æ­¤ã€1ã€‘è¯æ˜æˆç«‹ï¼ ç»“è®ºï¼šisaå°†å¯¹è±¡å’Œç±»å…³è”èµ·æ¥ï¼Œèµ·åˆ°äº†ä¸­é—´æ¡¥æ¢çš„ä½œç”¨ã€‚ 3.6 isaçš„åˆå§‹åŒ–è¡¥å……æœ€åè¡¥å……ä¸€ä¸‹isaçš„åˆå§‹åŒ–ã€‚è¿˜è®°å¾—åˆå§‹åŒ–isaçš„å…¥å£å—ï¼Ÿæ˜¯initIsa(cls, true, hasCxxDtor);ï¼Œæ­¤æ—¶nonpointerçš„å€¼æ˜¯trueï¼Œå†çœ‹SUPPORT_INDEXED_ISAçš„å®šä¹‰ 12345#if __ARM_ARCH_7K__ &gt;= 2 || (__arm64__ &amp;&amp; !__LP64__)# define SUPPORT_INDEXED_ISA 1#else# define SUPPORT_INDEXED_ISA 0#endif åœ¨x86_64ä¸‹ï¼ŒSUPPORT_INDEXED_ISAæ˜¯0ï¼Œæ‰€ä»¥isaçš„åˆå§‹åŒ–æœ€ç»ˆä¼šæ¥åˆ° 1234567891011isa_t newisa(0);// ä½¿ç”¨ISA_MAGIC_VALUE(0x001d800000000001ULL)èµ‹å€¼ç»™bits// nonpointerä¸º1ï¼Œmagicä¸º1dï¼Œå…¶ä»–å˜é‡ä¸ºé›¶newisa.bits = ISA_MAGIC_VALUE;// hasCxxDtoræ˜¯ä»ç±»çš„isaä¸­å–å‡ºçš„newisa.has_cxx_dtor = hasCxxDtor;// å°†clså³ç§»3ä½åèµ‹å€¼ç»™shiftclsnewisa.shiftcls = (uintptr_t)cls &gt;&gt; 3;isa = newisa; ç¢äºç¯‡å¹…ï¼Œè¿™é‡Œä¸ç»§ç»­æ·±å…¥hasCxxDtorã€‚ å››ã€isa æŒ‡å‘å›¾åœ¨OCä¸­ï¼Œå¯¹è±¡çš„æ–¹æ³•å¹¶æ²¡æœ‰å­˜å‚¨äºå¯¹è±¡çš„ç»“æ„ä½“ä¸­ï¼ˆå¦‚æœæ¯ä¸€ä¸ªå¯¹è±¡éƒ½ä¿å­˜äº†è‡ªå·±èƒ½æ‰§è¡Œçš„æ–¹æ³•ï¼Œé‚£ä¹ˆå¯¹å†…å­˜çš„å ç”¨æœ‰æå¤§çš„å½±å“ï¼‰ã€‚ å½“å¯¹è±¡çš„å®ä¾‹æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå®ƒé€šè¿‡è‡ªå·±çš„isaæ¥æŸ¥æ‰¾å¯¹åº”çš„ç±»ï¼Œç„¶ååœ¨æ‰€å±ç±»çš„ class_data_bits_tç»“æ„ä½“ä¸­æŸ¥æ‰¾å¯¹åº”æ–¹æ³•çš„å®ç°ã€‚åŒæ—¶ï¼Œæ¯ä¸€ä¸ªobjc_class ä¹Ÿæœ‰ä¸€ä¸ªæŒ‡å‘è‡ªå·±çš„çˆ¶ç±»çš„æŒ‡é’ˆsuperclassç”¨æ¥æŸ¥æ‰¾ç»§æ‰¿çš„æ–¹æ³•ã€‚ è€Œå½“è°ƒç”¨ ç±»æ–¹æ³• æ—¶ï¼Œå®ƒçš„æŸ¥æ‰¾æµç¨‹æ˜¯æ€æ ·çš„å‘¢ï¼Ÿå¯¹æ­¤OCçš„è§£å†³æ–¹æ¡ˆå°±æ˜¯å¼•å…¥å…ƒç±»ï¼Œæ¥ä¿è¯ç±»æ–¹æ³•ä¹Ÿèƒ½é€šè¿‡ç›¸åŒçš„æœºåˆ¶æŸ¥æ‰¾åˆ°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç±»çš„isaæŒ‡å‘çš„æ˜¯å…ƒç±»ã€‚ è‹¹æœå®˜æ–¹isaæŒ‡å‘å›¾ï¼š æ¥ä¸‹æ¥æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹å§ã€‚ 4.1 å‡†å¤‡å·¥ä½œåˆ›å»ºTeacherç±»ã€Personç±»ï¼Œå…¶ä¸­Personç±»ç»§æ‰¿äºNSObjectï¼ŒTeacherç±»ç»§æ‰¿äºPersonç±»ã€‚ 4.2 éªŒè¯è¿‡ç¨‹1.è·å–teacherå¯¹è±¡çš„ç±»ï¼ˆç»“æœæ˜¯Teacherç±»ï¼Œåœ°å€ä¸º0x0000000100001230ï¼‰ 123456789(lldb) x/4gx teacher0x100f59400: 0x001d800100001231 0x00000000000000000x100f59410: 0x636f72504b575b2d 0x70756f7247737365 (lldb) p/x 0x001d800100001231 &amp; 0x00007ffffffffff8 // isa &amp; ISA_MASK(long) $3 = 0x0000000100001230 // å¯¹è±¡teacherçš„ç±»åœ°å€ (lldb) po $3Teacher // å¯¹è±¡teacherçš„ç±» 2.è·å–Teacherç±»çš„å…ƒç±»ï¼ˆç»“æœæ˜¯Teacherå…ƒç±»ï¼Œåœ°å€ä¸º0x0000000100001208ï¼‰ 123456789(lldb) x/4gx Teacher.class0x100001230: 0x001d800100001209 0x00000001000011e00x100001240: 0x0000000100f61150 0x0000000100000003(lldb) p/x 0x001d800100001209 &amp; 0x00007ffffffffff8 // isa &amp; ISA_MASK(long) $5 = 0x0000000100001208 // Teacherç±»çš„å…ƒç±»åœ°å€ (lldb) po $5Teacher // Teacherç±»çš„å…ƒç±» Teacherç±» å’Œ Teacherå…ƒç±» åœ°å€ä¸ä¸€æ · 3.è·å–personå¯¹è±¡çš„ç±»ï¼ˆç»“æœæ˜¯Personç±»ï¼Œåœ°å€ä¸º0x00000001000011e0ï¼‰ï¼Œä»¥åŠç±»çš„å…ƒç±»ï¼ˆç»“æœæ˜¯Personå…ƒç±»ï¼Œåœ°å€ä¸º0x00000001000011b8ï¼‰ 12345678910111213141516171819(lldb) x/4gx person0x100f60a30: 0x001d8001000011e1 0x00000000000000000x100f60a40: 0x0000000000000002 0x00007fff9b855588 (lldb) p/x 0x001d8001000011e1 &amp; 0x00007ffffffffff8 // isa &amp; ISA_MASK(long) $8 = 0x00000001000011e0 // å¯¹è±¡personçš„ç±»åœ°å€ (lldb) po $8Person // å¯¹è±¡personçš„ç±»(lldb) x/4gx Person.class0x1000011e0: 0x001d8001000011b9 0x0000000100b381400x1000011f0: 0x0000000100f61030 0x0000000100000003 (lldb) p/x 0x001d8001000011b9 &amp; 0x00007ffffffffff8 // isa &amp; ISA_MASK(long) $10 = 0x00000001000011b8 // Personç±»çš„å…ƒç±»åœ°å€ (lldb) po $10Person // Personç±»çš„å…ƒç±» 4.è·å–objectå¯¹è±¡çš„ç±»ï¼ˆç»“æœæ˜¯NSObjectç±»ï¼Œåœ°å€ä¸º0x0000000100b38140ï¼‰ï¼Œä»¥åŠç±»çš„å…ƒç±»ï¼ˆç»“æœæ˜¯NSObjectå…ƒç±»ï¼Œåœ°å€ä¸º0x0000000100b380f0ï¼‰ 123456789101112131415161718192021(lldb) x/4gx object0x100f5cc50: 0x001d800100b38141 0x00000000000000000x100f5cc60: 0x70736e494b575b2d 0x574b57726f746365 (lldb) p/x 0x001d800100b38141 &amp; 0x00007ffffffffff8 // isa &amp; ISA_MASK(long) $12 = 0x0000000100b38140 // å¯¹è±¡objectçš„ç±»åœ°å€ (lldb) po $12 NSObject // å¯¹è±¡objectçš„ç±» (lldb) x/4gx NSObject.class0x100b38140: 0x001d800100b380f1 0x00000000000000000x100b38150: 0x0000000101913060 0x0000000200000003 (lldb) p/x 0x001d800100b380f1 &amp; 0x00007ffffffffff8 // isa &amp; ISA_MASK(long) $14 = 0x0000000100b380f0 // NSObjectç±»çš„å…ƒç±»åœ°å€ (lldb) po $14NSObject // NSObjectç±»çš„å…ƒç±» 5.è·å–Teacherå…ƒç±»çš„å…ƒç±»ï¼ŒPersonå…ƒç±»çš„å…ƒç±»ï¼Œä»¥åŠNSObjectå…ƒç±»çš„å…ƒç±» 123456789101112131415161718192021222324252627282930313233(lldb) x/4gx 0x0000000100001208 // Teacherå…ƒç±»0x100001208: 0x001d800100b380f1 0x00000001000011b80x100001218: 0x000000010186f950 0x0000000400000007 (lldb) p/x 0x001d800100b380f1 &amp; 0x00007ffffffffff8 // isa &amp; ISA_MASK(long) $16 = 0x0000000100b380f0 // NSObjectå…ƒç±» (lldb) po $16NSObject // NSObjectå…ƒç±» (lldb) x/4gx 0x00000001000011b8 // Personå…ƒç±»0x1000011b8: 0x001d800100b380f1 0x0000000100b380f00x1000011c8: 0x0000000101905a50 0x0000000300000007 (lldb) p/x 0x001d800100b380f1 &amp; 0x00007ffffffffff8 // isa &amp; ISA_MASK(long) $17 = 0x0000000100b380f0 // NSObjectå…ƒç±» (lldb) po $17NSObject // NSObjectå…ƒç±» (lldb) x/4gx 0x0000000100b380f0 // NSObjectå…ƒç±»0x100b380f0: 0x001d800100b380f1 0x0000000100b381400x100b38100: 0x0000000101903820 0x0000000500000007 (lldb) p/x 0x001d800100b380f1 &amp; 0x00007ffffffffff8 // isa &amp; ISA_MASK(long) $18 = 0x0000000100b380f0 // NSObjectå…ƒç±» (lldb) po $18NSObject // NSObjectå…ƒç±» 4.3 isaæŒ‡å‘ç»“è®º åŸºäºã€4.2ã€‘çš„éªŒè¯è¿‡ç¨‹ï¼Œå¯ä»¥å¾—å‡ºç»“è®ºï¼š å¯¹è±¡çš„isaæŒ‡é’ˆæŒ‡å‘å¯¹è±¡çš„æ‰€å±ç±» ç±»çš„isaæŒ‡é’ˆæŒ‡å‘ç±»çš„å…ƒç±» å…ƒç±»çš„isaæŒ‡é’ˆæŒ‡å‘æ ¹å…ƒç±» æ ¹å…ƒç±»çš„isaæŒ‡é’ˆæŒ‡å‘ä»–è‡ªå·±(å½¢æˆé—­ç¯) 4.4 ç»§æ‰¿å…³ç³»çš„è¯æ˜ç±»çš„ç»§æ‰¿å…³ç³»è¯æ˜è¿‡ç¨‹ï¼šï¼ˆä»¥ -&gt; è¡¨ç¤º ç»§æ‰¿è‡ªï¼‰ 12345678(lldb) p class_getSuperclass(Teacher.class)(Class) $19 = Person // Teacherç±» -&gt; Personç±»(lldb) p class_getSuperclass(Person.class)(Class) $20 = NSObject // Personç±» -&gt; NSObjectç±»(lldb) p class_getSuperclass(NSObject.class)(Class) $21 = nil // NSObjectç±» -&gt; nil å…ƒç±»çš„ç»§æ‰¿å…³ç³»è¯æ˜è¿‡ç¨‹ï¼šï¼ˆä»¥ -&gt; è¡¨ç¤º ç»§æ‰¿è‡ªï¼‰ 1234567891011121314151617// 0x0000000100001208 æ˜¯ Teacherå…ƒç±»(lldb) p/x class_getSuperclass((Class)0x0000000100001208)(Class) $17 = 0x00000001000011b8 // Personå…ƒç±»(lldb) po $17Person // Teacherå…ƒç±» -&gt; Personå…ƒç±»// 0x00000001000011b8 æ˜¯ Personå…ƒç±»(lldb) p/x class_getSuperclass((Class)0x00000001000011b8)(Class) $22 = 0x0000000100b380f0 // NSObjectå…ƒç±»ï¼ˆæ ¹å…ƒç±»ï¼‰(lldb) po $22NSObject // Personå…ƒç±» -&gt; æ ¹å…ƒç±»// 0x0000000100b380f0 æ˜¯ æ ¹å…ƒç±»(lldb) p/x class_getSuperclass((Class)0x0000000100b380f0)(Class) $23 = 0x0000000100b38140 NSObject // NSObjectç±»ï¼ˆæ ¹ç±»ï¼‰(lldb) po $23NSObject // æ ¹å…ƒç±» -&gt; æ ¹ç±» æ ¹å…ƒç±»ç»§æ‰¿è‡ªæ ¹ç±»ï¼ˆNSObjectå…ƒç±» -&gt; NSObjectç±»ï¼‰ï¼Œæ ¹ç±»ç»§æ‰¿è‡ªnilï¼ˆNSObjectç±» -&gt; nilï¼‰ äº”ã€æ€»ç»“1.isaæ˜¯isa_tç»“æ„ï¼Œé‡‡ç”¨ è”åˆä½“+ä½åŸŸ çš„æ­é…æ¥è®¾è®¡ï¼šåœ¨ä¸åŒçš„ä½ä¸Šæ˜¾ç¤ºä¸åŒçš„å†…å®¹ï¼Œä»¥æ­¤æ¥èŠ‚çœå‚¨å­˜ç©ºé—´ï¼Œè¿›è€Œä¼˜åŒ–å†…å­˜ã€‚ 2.isaåŒ…å«äº†clså’Œbitsä¸¤ä¸ªæˆå‘˜å˜é‡ï¼Œè¿™ä¸¤ä¸ªæˆå‘˜å˜é‡åœ¨64ä½CPUæ¶æ„ä¸‹çš„é•¿åº¦éƒ½æ˜¯8å­—èŠ‚ï¼Œæ‰€ä»¥isaåœ¨64ä½CPUæ¶æ„ä¸‹çš„é•¿åº¦ä¹Ÿæ˜¯8å­—èŠ‚ã€‚ 3.isaçš„ä½åŸŸä¸Šå­˜å‚¨äº†ä¸€äº›å¯¹è±¡ä¸ç±»çš„ä¿¡æ¯ï¼Œå¹¶å°†å¯¹è±¡ä¸ç±»å…³è”èµ·æ¥ï¼Œèµ·åˆ°ä¸­é—´æ¡¥æ¢çš„ä½œç”¨ã€‚ 4.æŒ‡å‘å›¾ç›¸å…³ç»“è®ºï¼š ç»§æ‰¿ å­ç±» -&gt; çˆ¶ç±» -&gt; æ ¹ç±»(NSObject) å­å…ƒç±» -&gt; çˆ¶å…ƒç±» -&gt; æ ¹å…ƒç±» !!! æ ¹å…ƒç±» -&gt; æ ¹ç±» (NSObject) å½¢æˆé—­ç¯ isa æŒ‡å‘ å®ä¾‹å¯¹è±¡ isa -&gt; ç±»å¯¹è±¡ ç±»å¯¹è±¡ isa -&gt; å…ƒç±»å¯¹è±¡ å…ƒç±»å¯¹è±¡ isa -&gt; æ ¹å…ƒç±»å¯¹è±¡ æ ¹å…ƒç±»å¯¹è±¡ isa -&gt; ä»–è‡ªå·±(å½¢æˆé—­ç¯) å…­ã€æºç æˆ‘çš„ malloc æºç  æˆ‘çš„ libobjc æºç  å‚è€ƒèµ„æ–™OCæºç åˆ†æä¹‹isa GDBè°ƒè¯•æŒ‡å—","link":"/2020/11/16/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/02-isa%E5%8E%9F%E7%90%86/"},{"title":"04-æ–¹æ³•çš„ç¼“å­˜åŸç†","text":"å‰è¨€ä¸€ã€ cache_tæºç åˆ†æå½“OCé¡¹ç›®ç¼–è¯‘å®Œæˆåï¼Œç±»çš„å®ä¾‹æ–¹æ³•ï¼ˆæ–¹æ³•ç¼–å·SEL å’Œ å‡½æ•°åœ°å€IMPï¼‰å°±ä¿å­˜åœ¨ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­ã€‚æˆ‘ä»¬çŸ¥é“ OC ä¸ºäº†å®ç°å…¶åŠ¨æ€æ€§ï¼Œå°† æ–¹æ³•çš„è°ƒç”¨åŒ…è£…æˆäº† SEL å¯»æ‰¾ IMP çš„è¿‡ç¨‹ã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæ¯æ¬¡è°ƒç”¨æ–¹æ³•ï¼Œéƒ½è¦å»ç±»çš„æ–¹æ³•åˆ—è¡¨ï¼ˆç”šè‡³çˆ¶ç±»ã€æ ¹ç±»çš„æ–¹æ³•åˆ—è¡¨ï¼‰ä¸­æŸ¥è¯¢å…¶å‡½æ•°åœ°å€ï¼ŒåŠ¿å¿…ä¼šå¯¹æ€§èƒ½é€ æˆæå¤§çš„æŸè€—ã€‚ ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼ŒOC é‡‡ç”¨äº†æ–¹æ³•ç¼“å­˜çš„æœºåˆ¶æ¥æé«˜è°ƒç”¨æ•ˆç‡ï¼Œä¹Ÿå°±æ˜¯cache_tï¼Œå…¶ä½œç”¨å°±æ˜¯ç¼“å­˜å·²è°ƒç”¨çš„æ–¹æ³•ã€‚å½“è°ƒç”¨æ–¹æ³•æ—¶ï¼Œobjc_msgSendä¼šå…ˆå»ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°å°±æ‰§è¡Œè¯¥æ–¹æ³•ï¼›å¦‚æœä¸åœ¨ç¼“å­˜ä¸­ï¼Œåˆ™å»ç±»çš„æ–¹æ³•åˆ—è¡¨ï¼ˆåŒ…æ‹¬çˆ¶ç±»ã€æ ¹ç±»çš„æ–¹æ³•åˆ—è¡¨ï¼‰æŸ¥æ‰¾ï¼Œæ‰¾åˆ°åä¼šå°†æ–¹æ³•çš„SELå’ŒIMPç¼“å­˜åˆ°cache_tä¸­ï¼Œä»¥ä¾¿ä¸‹æ¬¡è°ƒç”¨æ—¶èƒ½å¤Ÿå¿«é€Ÿæ‰§è¡Œã€‚ 1.1 cache_tç»“æ„æºç ï¼š 12345678910111213141516171819202122232425struct cache_t { struct bucket_t *_buckets; // ç¼“å­˜æ•°ç»„ï¼Œå³å“ˆå¸Œæ¡¶ mask_t _mask; // ç¼“å­˜æ•°ç»„çš„å®¹é‡ä¸´ç•Œå€¼ mask_t _occupied; // ç¼“å­˜æ•°ç»„ä¸­å·²ç¼“å­˜æ–¹æ³•æ•°é‡ ... // ä¸€äº›å‡½æ•°};#if __LP64__typedef uint32_t mask_t;#elsetypedef uint16_t mask_t;#endifstruct bucket_t {private:#if __arm64__ uintptr_t _imp; SEL _sel;#else SEL _sel; uintptr_t _imp;#endif ... // ä¸€äº›æ–¹æ³•}; ä»ä¸Šé¢æºç ä¸éš¾çœ‹å‡ºï¼Œåœ¨64ä½CPUæ¶æ„ä¸‹ï¼Œcache_té•¿åº¦æ˜¯16å­—èŠ‚ã€‚å•ä»ç»“æ„æ¥çœ‹ï¼Œæ–¹æ³•æ˜¯ç¼“å­˜åœ¨bucket_tï¼ˆåˆç§°å“ˆå¸Œæ¡¶ï¼‰ä¸­ï¼Œæ¥ä¸‹æ¥ç”¨ä¸ªä¾‹å­éªŒè¯ä¸€ä¸‹cache_tæ˜¯å¦ç¼“å­˜äº†å·²è°ƒç”¨çš„æ–¹æ³•ã€‚ 1.2 æ–¹æ³•ç¼“å­˜çš„éªŒè¯1.åˆ›å»ºä¸€ä¸ªç®€å•çš„Personç±»ï¼Œä»£ç å¦‚ä¸‹ 1234567891011121314151617181920212223@interface Person : NSObject- (void)methodFirst;- (void)methodSecond;- (void)methodThird;@end@implementation Person- (void)methodFirst { NSLog(@&quot;%s&quot;, __FUNCTION__);}- (void)methodSecond { NSLog(@&quot;%s&quot;, __FUNCTION__);}- (void)methodThird { NSLog(@&quot;%s&quot;, __FUNCTION__);}@end 2.æ–¹æ³•è°ƒç”¨å‰çš„cache_t åœ¨æ–¹æ³•è°ƒç”¨å‰æ‰“ä¸ªæ–­ç‚¹ï¼Œçœ‹çœ‹cache_tçš„ç¼“å­˜æƒ…å†µ è¯´æ˜ï¼š objc_classç»“æ„ä¸­ISAå 8å­—èŠ‚ï¼ŒsuperClasså 8å­—èŠ‚ï¼Œç”±äºæˆ‘ä»¬æ˜¯æŒ‰ç…§8å­—èŠ‚ä¸ºä¸€æ®µæ‰“å°çš„ï¼Œæ‰€ä»¥åˆšå¥½0x1000011d8å°±æ˜¯cache_té¦–åœ°å€ã€‚ ç”±äºè¿˜æ²¡æœ‰ä»»ä½•æ–¹æ³•è°ƒç”¨ï¼Œæ‰€ä»¥_maskå’Œ_occupiedéƒ½æ˜¯0ï¼Œå³è¿˜æ²¡æœ‰æ–¹æ³•ç¼“å­˜ã€‚ ä¸ºä»€ä¹ˆè°ƒç”¨äº†allocå’Œclassï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªæ–¹æ³•æ€ä¹ˆæ²¡æœ‰ç¼“å­˜ï¼Œè¿™é‡Œè¦æåˆ°æˆ‘ä»¬ä¹‹å‰æ¢ç´¢ç±»çš„æ–¹æ³•å­˜å‚¨ä¸­è¯´åˆ°çš„ï¼Œå¯¹è±¡çš„æ–¹æ³•å­˜åœ¨ç±»ä¸­ï¼Œç±»çš„ç±»æ–¹æ³•ä»¥å®ä¾‹æ–¹æ³•çš„å½¢å¼å­˜åœ¨å…ƒç±»ä¸­ï¼Œæˆ‘ä»¬è¿™é‡Œæ¢ç´¢çš„æ˜¯ç±»çš„cacheç¼“å­˜ï¼Œæ‰€ä»¥åªèƒ½æ‰¾åˆ°å®ä¾‹æ–¹æ³•çš„ç¼“å­˜ã€‚ä¸‹é¢ç›´æ¥ç»™å¤§å®¶çœ‹ä¸€ä¸‹å…ƒç±»é‡Œçš„cacheä»¥åŠbucketï¼Œä¹Ÿæ‰¾åˆ°äº†allocæ–¹æ³•çš„ç¼“å­˜ï¼Œè¿™ä¹Ÿè¯´æ˜ï¼Œæˆ‘ä»¬çš„æ€è·¯æ˜¯æ­£ç¡®çš„ï¼š 123456789101112131415161718192021(lldb) p/x 0x001d8001000012b9 &amp; 0x00007ffffffffff8ULL(unsigned long long) $5 = 0x00000001000012b8// 0x00000001000012b8è¿™ä¸ªç©æ„å°±æ˜¯å…ƒç±»çš„åœ°å€äº†ã€‚ä¹‹å‰çš„isaåŸç†ï¼Œé‡Œé¢ä»‹ç»åˆ°äº†å¦‚ä½•ä»ç±»æŸ¥æ‰¾åˆ°å…ƒç±»(lldb) x/4gx 0x00000001000012b80x1000012b8: 0x001d800100b360f1 0x0000000100b360f00x1000012c8: 0x0000000101e236c0 0x0000000200000003(lldb) p (cache_t *)0x1000012c8(cache_t *) $6 = 0x00000001000012c8(lldb) p *$6(cache_t) $7 = { _buckets = 0x0000000101e236c0 _mask = 3 _occupied = 2}(lldb) p $7._buckets(bucket_t *) $8 = 0x0000000101e236c0(lldb) p *$8(bucket_t) $9 = { _key = 4298994200 _imp = 0x00000001003cc3b0 (libobjc.A.dylib`::+[NSObject alloc]() at NSObject.mm:2294)} 3.æ–¹æ³•è°ƒç”¨åçš„cache_t æ‰§è¡Œallocå’Œinitè¿™ä¸¤ä¸ªæ–¹æ³•åï¼Œcache_tå˜åŒ–å¦‚ä¸‹ ä»ä¸Šå›¾å¯çŸ¥ï¼Œè°ƒç”¨initåï¼Œ_maskçš„å€¼æ˜¯3ï¼Œ_occupiedåˆ™æ˜¯1ã€‚_bucketsæŒ‡é’ˆçš„å€¼ï¼ˆæ•°ç»„é¦–åœ°å€ï¼‰å‘ç”Ÿäº†å˜åŒ–ï¼ˆä»0x1003db250å˜æˆ0x101700090ï¼‰ï¼ŒåŒæ—¶ç¼“å­˜äº†initæ–¹æ³•çš„SELå’ŒIMPã€‚ æ€è€ƒï¼š 1. alloc æ–¹æ³•è°ƒç”¨åï¼Œç¼“å­˜åœ¨å“ªé‡Œï¼Ÿ 2. ä¸ºä»€ä¹ˆ init æ–¹æ³•ä¸åœ¨ _buckets ç¬¬ä¸€ä¸ªä½ç½®ï¼Ÿ ç»§ç»­æ‰§è¡ŒmethodFirstï¼Œå†çœ‹cache_t æ­¤æ—¶ï¼Œ_maskçš„å€¼æ˜¯3ï¼ˆæ²¡å‘ç”Ÿå˜åŒ–ï¼‰ï¼Œ_occupiedåˆ™å˜æˆäº†2ï¼Œ_bucketsæŒ‡é’ˆåœ°å€æ²¡å˜ï¼Œå¢åŠ ç¼“å­˜äº†methodFirstæ–¹æ³•çš„SELå’ŒIMPã€‚ æ¥ç€æ˜¯æ‰§è¡ŒmethodSecondï¼Œä¸”çœ‹ æ˜¾ç„¶ï¼Œ_occupiedå˜æˆäº†3ï¼Œè€Œ_bucketsæŒ‡é’ˆåœ°å€ä¸æ”¹å˜ï¼ŒåŒæ—¶æ–°å¢methodSecondçš„æ–¹æ³•ç¼“å­˜ã€‚ æœ€åæ‰§è¡ŒmethodThirdåï¼Œå†çœ‹cache_tå˜åŒ– è¿™æ¬¡çš„ç»“æœå°±å®Œå…¨ä¸åŒäº†ã€‚_maskçš„å€¼å˜æˆ7ï¼Œ_occupiedåˆ™é‡æ–°å˜æˆäº†1ï¼Œè€Œ_bucketsä¸ä»…é¦–åœ°å€å˜äº†ï¼Œä¹‹å‰ç¼“å­˜çš„initã€methodFirstå’ŒmethodSecondæ–¹æ³•ä¹Ÿæ²¡äº†ï¼Œä»…å­˜åœ¨çš„åªæœ‰æ–°å¢çš„methodThirdæ–¹æ³•ã€‚çœ‹æ¥ï¼Œcache_tå¹¶éæ˜¯å¦‚æˆ‘ä»¬æ‰€æ„¿çš„é‚£æ ·â€”â€”è°ƒç”¨ä¸€ä¸ªæ–¹æ³•å°±ç¼“å­˜ä¸€ä¸ªæ–¹æ³•ã€‚ æ€è€ƒï¼šä¹‹å‰ç¼“å­˜çš„æ–¹æ³•ï¼ˆinitã€methodFirst å’Œ methodSecondï¼‰å“ªå»äº†ï¼Ÿ 1.3 cache_tå°ç»“è®©æˆ‘ä»¬æ¢³ç†ä¸€ä¸‹ä¸Šé¢çš„ä¾‹å­ã€‚åœ¨ä¾æ¬¡æ‰§è¡ŒPersonçš„å®ä¾‹æ–¹æ³•initã€methodFirstã€methodSecondã€methodThirdåï¼Œcache_tå˜åŒ–å¦‚ä¸‹ è°ƒç”¨çš„æ–¹æ³• _buckets _mask _occupied æœªè°ƒç”¨æ–¹æ³• ç©º 0 0 init init 3 1 initã€methodFirst initã€methodFirst 3 2 initã€methodFirstã€methodSecond initã€methodFirstã€methodSecond 3 3 initã€methodFirstã€methodSecondã€methodThird methodThird 7 1 å¯è§ï¼Œ**cache_tçš„ç¡®èƒ½å®æ—¶ç¼“å­˜å·²è°ƒç”¨çš„æ–¹æ³•**ã€‚ ä¸Šé¢çš„éªŒè¯è¿‡ç¨‹ä¹Ÿå¯ä»¥å¸®åŠ©æˆ‘ä»¬ç†è§£cache_tä¸‰ä¸ªæˆå‘˜å˜é‡çš„æ„ä¹‰ã€‚ bucketå¯è¯‘ä¸ºæ¡¶ï¼ˆå³å“ˆå¸Œæ¡¶ï¼‰ï¼Œç”¨äºè£…æ–¹æ³•ï¼› occupiedå¯è¯‘ä¸ºå·²å æœ‰ï¼Œè¡¨ç¤ºå·²ç¼“å­˜çš„æ–¹æ³•æ•°é‡ï¼› maskå¯è¯‘ä¸ºé¢å…·ã€æ©é¥°ç‰©ï¼Œä¹çœ‹æ— å¤´ç»ªï¼Œä½†æ˜¯æ³¨æ„åˆ°cache_tä¸­æœ‰è·å–å®¹é‡çš„å‡½æ•°ï¼ˆcapacityï¼‰ï¼Œå…¶æºç å¦‚ä¸‹ 12345678910111213141516struct cache_t { ... mask_t mask(); mask_t capacity(); ...}mask_t cache_t::mask() { return _mask; }mask_t cache_t::capacity() { return mask() ? mask()+1 : 0; } ä»capacityæ–¹æ³•çœ‹å‡ºï¼šå½“_maskä¸ç­‰äº0çš„æ—¶å€™ï¼Œæ„å‘³ç€å·²ç»è°ƒç”¨è¿‡å®ä¾‹æ–¹æ³•ï¼Œæ­¤æ—¶æ¡¶çš„å®¹é‡ä¸º_mask + 1ï¼Œå¦‚æœ_maskæ˜¯0ï¼Œè¯´æ˜æœªè°ƒç”¨å®ä¾‹æ–¹æ³•ï¼Œå³æ¡¶çš„å®¹é‡ä¸º0ã€‚æ•…ï¼Œ_maskä»ä¾§é¢åæ˜ äº†æ¡¶çš„å®¹é‡ã€‚ äºŒã€cache_tçš„æ–¹æ³•ç¼“å­˜åŸç†æ¥ä¸‹æ¥ï¼Œä»æ–¹æ³•çš„è°ƒç”¨è¿‡ç¨‹å¼€å§‹åˆ†æcache_tçš„æ–¹æ³•ç¼“å­˜åŸç†ã€‚ 2.1 cache_fillOCæ–¹æ³•çš„æœ¬è´¨æ˜¯ **æ¶ˆæ¯å‘é€ï¼ˆå³objc_msgSendï¼‰ï¼Œåº•å±‚æ˜¯é€šè¿‡æ–¹æ³•çš„ SEL æŸ¥æ‰¾ IMP**ã€‚ ç®€è¦æµç¨‹ï¼š 1.è°ƒç”¨æ–¹æ³•æ—¶ï¼Œobjc_msgSendä¼šå»cache_tå³ç¼“å­˜ä¸­æŸ¥è¯¢æ–¹æ³•çš„å‡½æ•°å®ç°ï¼ˆè¿™éƒ¨åˆ†æ˜¯ç”±æ±‡ç¼–ä»£ç å®ç°çš„ï¼Œéå¸¸é«˜æ•ˆï¼‰ï¼Œåœ¨ç¼“å­˜ä¸­æ‰¾çš„è¿‡ç¨‹æš‚ä¸”ä¸è¡¨ 2.å½“ç¼“å­˜ä¸­æ²¡æœ‰çš„æ—¶å€™ï¼Œåˆ™å»ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾ï¼Œç›´è‡³æ‰¾åˆ°åï¼Œå†è°ƒç”¨cache_fillï¼Œç›®çš„æ˜¯ä¸ºäº†å°†æ–¹æ³•ç¼“å­˜åˆ°cache_tä¸­ï¼Œå…¶æºç å¦‚ä¸‹ 12345678910void cache_fill(Class cls, SEL sel, IMP imp, id receiver){#if !DEBUG_TASK_THREADS mutex_locker_t lock(cacheUpdateLock); cache_fill_nolock(cls, sel, imp, receiver);#else _collecting_in_critical(); return;#endif} objc_msgSendçš„å…·ä½“æµç¨‹å°†å¦èµ·ä¸€æ–‡åˆ†æï¼Œè¿™é‡Œä¸ä½œèµ˜è¿°ã€‚ 2.2 cache_fill_nolockcache_fillåˆä¼šæ¥åˆ°cache_fill_nolockï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯å°†æ–¹æ³•çš„SELå’ŒIMPå†™å…¥_bucketsï¼ŒåŒæ—¶æ›´æ–°_maskå’Œ_occupiedã€‚ å…¶æºç ä»¥åŠè¯¦ç»†åˆ†æå¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253static void cache_fill_nolock(Class cls, SEL sel, IMP imp, id receiver){ cacheUpdateLock.assertLocked(); // Never cache before +initialize is done åœ¨+initializeå®Œæˆä¹‹å‰æ°¸è¿œä¸è¦ç¼“å­˜ if (!cls-&gt;isInitialized()) return; // åœ¨è·å–cacheUpdateLockä¹‹å‰ï¼Œç¡®ä¿å…¶ä»–çº¿ç¨‹æ²¡æœ‰å°†è¯¥æ–¹æ³•å†™å…¥ç¼“å­˜ // Make sure the entry wasn't added to the cache by some other thread // before we grabbed the cacheUpdateLock. if (cache_getImp(cls, sel)) return; // è·å– cls çš„ cache_tæŒ‡é’ˆ cache_t *cache = getCache(cls); // newOccupiedä¸ºæ–°çš„æ–¹æ³•ç¼“å­˜æ•°ï¼Œç­‰äº å½“å‰æ–¹æ³•ç¼“å­˜æ•°+1 // Use the cache as-is if it is less than 3/4 full mask_t newOccupied = cache-&gt;occupied() + 1; // è·å–å½“å‰cache_tçš„æ€»å®¹é‡ï¼Œå³ mask+1 mask_t capacity = cache-&gt;capacity(); // ä¸‰ç§ç­–ç•¥ if (cache-&gt;isConstantEmptyCache()) { // â‘ åˆå§‹åŒ–ç¼“å­˜ // å½“ç¬¬ä¸€æ¬¡è°ƒç”¨ç±»çš„å®ä¾‹æ–¹æ³•æ—¶ï¼ˆå¦‚æœ¬æ–‡çš„ã€1.2ã€‘ä¾‹ä¸­çš„alloc initè¿˜æ²¡è¢«è°ƒç”¨çš„æ—¶å€™ï¼‰ // Cache is read-only. Replace it. cache-&gt;reallocate(capacity, capacity ?: INIT_CACHE_SIZE); } else if (newOccupied &lt;= capacity / 4 * 3) { // â‘¡ç›´æ¥ç¼“å­˜ // Cache is less than 3/4 full. Use it as-is. // æ–°çš„æ–¹æ³•ç¼“å­˜æ•° ä¸å¤§äº æ€»å®¹é‡çš„3/4ï¼ŒæŒ‰åŸæ ·ä½¿ç”¨ï¼Œæ— éœ€æ‰©å®¹ } else { // â‘¢æ‰©å®¹åç¼“å­˜ // Cache is too full. Expand it. // æ–°çš„æ–¹æ³•ç¼“å­˜æ•° å¤§äº æ€»å®¹é‡çš„3/4ï¼Œéœ€è¦æ‰©å®¹ cache-&gt;expand(); } // æ ¹æ®selå¯»æ‰¾å¯¹åº”çš„bucketï¼Œæ­¤bucketçš„selä¸€èˆ¬ä¸º0ï¼ˆè¯´æ˜è¿™ä¸ªä½ç½®è¿˜æ²¡ç¼“å­˜æ–¹æ³•ï¼‰ï¼Œ // ä¹Ÿå¯èƒ½ä¸å®å‚selç›¸ç­‰ï¼ˆhashå†²çªï¼Œå¯èƒ½æ€§å¾ˆä½ï¼‰ // Scan for the first unused slot and insert there. // There is guaranteed to be an empty slot because the // minimum size is 4 and we resized at 3/4 full. bucket_t *bucket = cache-&gt;find(sel, receiver); // å½“ä¸”ä»…å½“bucketçš„selä¸º0æ—¶ï¼Œæ‰§è¡Œ_occupied++ if (bucket-&gt;sel() == 0) cache-&gt;incrementOccupied(); // æ›´æ–°bucketçš„selå’Œimp bucket-&gt;set&lt;Atomic&gt;(sel, imp);}// INIT_CACHE_SIZE å³ä¸º4enum { INIT_CACHE_SIZE_LOG2 = 2, INIT_CACHE_SIZE = (1 &lt;&lt; INIT_CACHE_SIZE_LOG2)}; ä»ä¸Šé¢çš„æºç ä¸éš¾çœ‹å‡ºï¼Œcache_fill_nolockæ˜¯cache_tç¼“å­˜æ–¹æ³•çš„è°ƒåº¦ä¸­å¿ƒï¼Œåœ¨è¿™é‡Œä¼šï¼š 1.å†³å®šæ‰§è¡Œ_bucketsçš„å“ªä¸€ç§ç¼“å­˜ç­–ç•¥ï¼ˆåˆå§‹åŒ–åç¼“å­˜ã€ç›´æ¥ç¼“å­˜ã€æ‰©å®¹åç¼“å­˜ï¼Œä¸‰è€…å–ä¸€ï¼‰ï¼› 2.ç„¶åé€šè¿‡æ–¹æ³•çš„selæ‰¾åˆ°ä¸€ä¸ªbucketï¼Œå¹¶æ›´æ–°è¿™ä¸ªbucketçš„selå’Œimpã€‚ï¼ˆå¦‚æœè¿™ä¸ªbucketçš„selä¸º0ï¼Œè¯´æ˜æ˜¯ä¸ªç©ºæ¡¶ï¼Œæ­£å¥½å¯ä»¥ç¼“å­˜æ–¹æ³•ï¼Œäºæ˜¯æ‰§è¡Œ_occupied++ï¼‰ã€‚ æ€è€ƒï¼šä¸ºä»€ä¹ˆæ‰©å®¹ä¸´ç•Œç‚¹æ˜¯ 3/4ï¼Ÿ 2.3 reallocateåœ¨ä¸‹é¢è¿™ä¸¤ç§æƒ…å†µä¸‹ä¼šæ‰§è¡Œreallocateï¼š ä¸€æ˜¯ç¬¬ä¸€æ¬¡åˆå§‹åŒ–_bucketsçš„æ—¶å€™ å¦ä¸€ç§åˆ™æ˜¯_bucketsæ‰©å®¹çš„æ—¶å€™ æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹reallocateåšäº†å“ªäº›äº‹æƒ… 1234567891011121314151617181920212223242526void cache_t::reallocate(mask_t oldCapacity, mask_t newCapacity){ // å½“ä¸”ä»…å½“`_buckets`ä¸­æœ‰ç¼“å­˜æ–¹æ³•æ—¶ï¼ŒfeeOldä¸ºtrue bool freeOld = canBeFreed(); // è·å–å½“å‰bucketsæŒ‡é’ˆï¼Œå³_buckets bucket_t *oldBuckets = buckets(); // å¼€è¾Ÿæ–°çš„bucketsæŒ‡é’ˆ bucket_t *newBuckets = allocateBuckets(newCapacity); // Cache's old contents are not propagated. // This is thought to save cache memory at the cost of extra cache fills. // fixme re-measure this assert(newCapacity &gt; 0); assert((uintptr_t)(mask_t)(newCapacity-1) == newCapacity-1); // å°†æ–°bucketsã€æ–°maskï¼ˆnewCapacity-1ï¼‰åˆ†åˆ«èµ‹å€¼è·Ÿå½“å‰çš„ _buckets å’Œ _mask setBucketsAndMask(newBuckets, newCapacity - 1); if (freeOld) { // é‡Šæ”¾æ—§çš„bucketså†…å­˜ç©ºé—´ cache_collect_free(oldBuckets, oldCapacity); cache_collect(false); }} reallocateå®Œç¾è§£é‡Šäº†åœ¨ä¾‹ã€1.2ã€‘ä¸­çš„å‡ ä¸ªæƒ…å†µï¼š initæ‰§è¡Œå®Œåï¼Œ_bucketsæŒ‡é’ˆåœ°å€å˜äº†ï¼Œ_maskå˜æˆäº†3ï¼› methodThirdæ‰§è¡Œå®Œåï¼Œ_bucketsä¸ä»…æŒ‡é’ˆåœ°å€å˜äº†ï¼ŒåŒæ—¶ä¹‹å‰ç¼“å­˜çš„initã€methodFirstå’ŒmethodSecondæ–¹æ³•ä¹Ÿéƒ½ä¸åœ¨äº† æ³¨æ„ï¼Œ_occupiedçš„å˜åŒ–æ˜¯åœ¨å›åˆ°cache_fill_nolockåå‘ç”Ÿçš„ã€‚ æ€è€ƒï¼šæ‰©å®¹åï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥æŠŠä¹‹å‰ç¼“å­˜çš„æ–¹æ³•åŠ å…¥æ–°çš„bucketsä¸­ï¼Ÿ 2.4 expandä»cache_fill_nolockæºç æ¥çœ‹ï¼Œå½“æ–°çš„æ–¹æ³•ç¼“å­˜æ•°ï¼ˆ_occupied+1ï¼‰å¤§äºæ€»å®¹é‡ï¼ˆ_mask+1ï¼‰æ—¶ï¼Œä¼šå¯¹_bucketsè¿›è¡Œæ‰©å®¹ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œexpandå‡½æ•°ï¼Œå…¶æºç å¦‚ä¸‹ 1234567891011121314151617void cache_t::expand(){ cacheUpdateLock.assertLocked(); // è·å–å½“å‰æ€»å®¹é‡ï¼Œå³_mask+1 uint32_t oldCapacity = capacity(); // æ–°çš„å®¹é‡ = æ—§å®¹é‡ * 2 uint32_t newCapacity = oldCapacity ? oldCapacity*2 : INIT_CACHE_SIZE; if ((uint32_t)(mask_t)newCapacity != newCapacity) { // mask overflow - can't grow further // fixme this wastes one bit of mask newCapacity = oldCapacity; } reallocate(oldCapacity, newCapacity);} è¿™ä¸ªå‡½æ•°éå¸¸ç®€å•ï¼Œä»…ä»…æ˜¯è®¡ç®—å¥½æ–°çš„å®¹é‡åï¼Œå°±å»è°ƒç”¨reallocateå‡½æ•°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼š åœ¨ä¸è¶…è¿‡uint32_tå¤§å°ï¼ˆ4å­—èŠ‚ï¼‰æ—¶ï¼Œæ¯æ¬¡æ‰©å®¹ä¸ºåŸæ¥çš„2å€ å¦‚æœè¶…è¿‡äº†uint32_tï¼Œåˆ™é‡æ–°ç”³è¯·è·ŸåŸæ¥ä¸€æ ·å¤§å°çš„buckets 2.5 findåœ¨æ‰§è¡Œå®Œç›¸åº”çš„bucketsç­–ç•¥åï¼Œæ¥ä¸‹æ¥å°±éœ€è¦æ‰¾åˆ°åˆé€‚çš„ä½ç½®ï¼ˆbucketï¼‰ï¼Œä»¥å­˜å‚¨ æ–¹æ³•çš„SELå’ŒIMPã€‚findå…·ä½“åšçš„äº‹æƒ…å°±æ˜¯æ ¹æ®æ–¹æ³•çš„SELï¼Œè¿”å›ä¸€ä¸ªç¬¦åˆè¦æ±‚çš„bucketï¼ŒåŒæ ·ä¸Šæºç  123456789101112131415161718192021222324252627282930313233343536373839404142434445464748bucket_t * cache_t::find(SEL s, id receiver){ assert(s != 0); // è·å–å½“å‰bucketsï¼Œå³_buckets bucket_t *b = buckets(); // è·å–å½“å‰maskï¼Œå³_mask mask_t m = mask(); // ç”± sel &amp; mask å¾—å‡ºèµ·å§‹ç´¢å¼•å€¼ mask_t begin = cache_hash(s, m); mask_t i = begin; do { // selä¸º0ï¼šè¯´æ˜ i è¿™ä¸ªä½ç½®å°šæœªç¼“å­˜æ–¹æ³•ï¼› // selç­‰äºsï¼šå‘½ä¸­ç¼“å­˜ï¼Œè¯´æ˜ i è¿™ä¸ªä½ç½®å·²ç¼“å­˜æ–¹æ³•ï¼Œå¯èƒ½æ˜¯hashå†²çª if (b[i].sel() == 0 || b[i].sel() == s) { return &amp;b[i]; } } while ((i = cache_next(i, m)) != begin); // hack // æ‰¾ä¸åˆ°å¤šä½™çš„å“ˆå¸Œæ¡¶ï¼ˆå‡ºé”™çš„å¤„ç†ï¼Œæ‰“å°é—®é¢˜ï¼‰ã€‚ä¸€èˆ¬ä¸ä¼šèµ°åˆ°è¿™é‡Œï¼ Class cls = (Class)((uintptr_t)this - offsetof(objc_class, cache)); cache_t::bad_cache(receiver, (SEL)s, cls);}static inline mask_t cache_hash(SEL sel, mask_t mask) { return (mask_t)(uintptr_t)sel &amp; mask;}#if __arm__ || __x86_64__ || __i386__// objc_msgSend has few registers available.// Cache scan increments and wraps at special end-marking bucket.#define CACHE_END_MARKER 1static inline mask_t cache_next(mask_t i, mask_t mask) { return (i+1) &amp; mask;}#elif __arm64__// objc_msgSend has lots of registers available.// Cache scan decrements. No end marker needed.#define CACHE_END_MARKER 0static inline mask_t cache_next(mask_t i, mask_t mask) { return i ? i-1 : mask;}#else#error unknown architecture#endif ä»æºç å¯ä»¥å‘ç°ï¼Œfindæ‰¾bucketçš„æ–¹å¼ç”¨åˆ°äº†hashçš„æ€æƒ³ï¼šä»¥_bucketsä½œä¸ºå“ˆå¸Œæ¡¶ï¼Œä»¥cache_hashä½œä¸ºå“ˆå¸Œå‡½æ•°ï¼Œè¿›è¡Œå“ˆå¸Œè¿ç®—åå¾—å‡ºç´¢å¼•å€¼indexï¼ˆæœ¬è´¨æ˜¯SEL &amp; maskï¼Œæ‰€ä»¥indexæœ€å¤§å€¼å°±æ˜¯_maskçš„å€¼ï¼‰ã€‚ ç”±äºç´¢å¼•å€¼æ˜¯é€šè¿‡å“ˆå¸Œè¿ç®—å¾—å‡ºçš„ï¼Œå…¶ç»“æœè‡ªç„¶æ˜¯æ— åºçš„ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¸Šä¾‹ä¸­initæ–¹æ³•ä¸åœ¨_bucketsç¬¬ä¸€ä¸ªä½ç½®çš„åŸå› ã€‚ ä¸‰ã€å¤šçº¿ç¨‹å¯¹æ–¹æ³•ç¼“å­˜çš„å½±å“æ—¢ç„¶å“ˆå¸Œæ¡¶çš„æ•°é‡æ˜¯åœ¨è¿è¡Œæ—¶åŠ¨æ€å¢åŠ çš„ï¼Œé‚£ä¹ˆåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è°ƒç”¨æ–¹æ³•æ—¶ï¼Œå¯¹æ–¹æ³•çš„ç¼“å­˜æœ‰æ²¡æœ‰ä»€ä¹ˆå½±å“å‘¢ï¼Ÿçœ‹ä¸‹é¢çš„åˆ†æã€‚ 3.1 å¤šçº¿ç¨‹åŒæ—¶è¯»å–ç¼“å­˜åœ¨æ•´ä¸ªobjc_msgSendå‡½æ•°ä¸­ï¼Œä¸ºäº†è¾¾åˆ°æœ€ä½³çš„æ€§èƒ½ï¼Œå¯¹æ–¹æ³•ç¼“å­˜çš„==è¯»å–æ“ä½œ==æ˜¯æ²¡æœ‰æ·»åŠ ä»»ä½•é”çš„ã€‚è€Œå¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨å·²ç¼“å­˜çš„æ–¹æ³•ï¼Œå¹¶ä¸ä¼šå¼•å‘_bucketså’Œ_maskçš„å˜åŒ–ï¼Œå› æ­¤å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–æ–¹æ³•ç¼“å­˜çš„æ“ä½œæ˜¯ä¸ä¼šæœ‰å®‰å…¨éšæ‚£çš„ã€‚ 3.2 å¤šçº¿ç¨‹åŒæ—¶å†™ç¼“å­˜ä»å†™ç¼“å­˜çš„cache_fill_nolockæ–¹æ³•ä¸­æˆ‘ä»¬çŸ¥é“åœ¨æ¡¶æ•°é‡æ‰©å®¹å’Œå†™æ¡¶æ•°æ®ä¹‹å‰ï¼Œç³»ç»Ÿä½¿ç”¨äº†ä¸€ä¸ªå…¨å±€çš„äº’æ–¥é”ï¼ˆcacheUpdateLock.assertLocked()ï¼‰æ¥ä¿è¯==å†™å…¥çš„åŒæ­¥å¤„ç†==ï¼Œå¹¶ä¸”åœ¨é”ä½çš„èŒƒå›´å†…éƒ¨è¿˜åšäº†ä¸€æ¬¡æŸ¥ç¼“å­˜çš„æ“ä½œï¼ˆif (cache_getImp(cls, sel)) return;ï¼‰ï¼Œè¿™æ ·å°± ä¿è¯äº†å“ªæ€•å¤šä¸ªçº¿ç¨‹åŒæ—¶å†™åŒä¸€ä¸ªæ–¹æ³•çš„ç¼“å­˜ä¹Ÿåªä¼šäº§ç”Ÿå†™ä¸€æ¬¡çš„æ•ˆæœï¼Œå³å¤šçº¿ç¨‹åŒæ—¶å†™ç¼“å­˜çš„æ“ä½œä¹Ÿä¸ä¼šæœ‰å®‰å…¨éšæ‚£ã€‚ 3.3 å¤šçº¿ç¨‹åŒæ—¶è¯»å†™ç¼“å­˜è¿™ä¸ªæƒ…å†µå°±æ¯”è¾ƒå¤æ‚äº†ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹objc_msgSendè¯»ç¼“å­˜çš„ä»£ç ï¼ˆä»¥ arm64æ¶æ„æ±‡ç¼– ä¸ºä¾‹ï¼‰ 12345678910111213141516171819202122232425262728293031323334353637383940.macro CacheLookup // x1 = SEL, x16 = isa ldp x10, x11, [x16, #CACHE] // x10 = buckets, x11 = occupied|mask and w12, w1, w11 // x12 = _cmd &amp; mask add x12, x10, x12, LSL #4 // x12 = buckets + ((_cmd &amp; mask)&lt;&lt;4) ldp x9, x17, [x12] // {x9, x17} = *bucket1: cmp x9, x1 // if (bucket-&gt;sel != _cmd) b.ne 2f // scan more CacheHit $0 // call or return imp 2: // not hit: x12 = not-hit bucket CheckMiss $0 // miss if bucket-&gt;sel == 0 cmp x12, x10 // wrap if bucket == buckets b.eq 3f ldp x9, x17, [x12, #-16]! // {x9, x17} = *--bucket b 1b // loop3: // wrap: x12 = first bucket, w11 = mask add x12, x12, w11, UXTW #4 // x12 = buckets+(mask&lt;&lt;4) // Clone scanning loop to miss instead of hang when cache is corrupt. // The slow path may detect any corruption and halt later. ldp x9, x17, [x12] // {x9, x17} = *bucket1: cmp x9, x1 // if (bucket-&gt;sel != _cmd) b.ne 2f // scan more CacheHit $0 // call or return imp 2: // not hit: x12 = not-hit bucket CheckMiss $0 // miss if bucket-&gt;sel == 0 cmp x12, x10 // wrap if bucket == buckets b.eq 3f ldp x9, x17, [x12, #-16]! // {x9, x17} = *--bucket b 1b // loop3: // double wrap JumpMiss $0 .endmacro å…¶ä¸­ï¼ŒldpæŒ‡ä»¤çš„ä½œç”¨æ˜¯å°†æ•°æ®ä»å†…å­˜è¯»å–å‡ºæ¥å­˜åˆ°å¯„å­˜å™¨ï¼Œç¬¬ä¸€ä¸ªldpä»£ç ä¼š æŠŠcache_tä¸­çš„_buckets å’Œ _occupied | _maskæ•´ä¸ªç»“æ„ä½“æˆå‘˜åˆ†åˆ«è¯»å–åˆ°x10å’Œx11ä¸¤ä¸ªå¯„å­˜å™¨ä¸­ï¼Œå¹¶ä¸”CacheLookupçš„åç»­ä»£ç æ²¡æœ‰å†æ¬¡è¯»å–cache_tçš„æˆå‘˜æ•°æ®ï¼Œè€Œæ˜¯ä¸€ç›´ä½¿ç”¨x10å’Œx11ä¸­çš„å€¼è¿›è¡Œå“ˆå¸ŒæŸ¥æ‰¾ã€‚ç”±äºCPUèƒ½ä¿è¯å•æ¡æŒ‡ä»¤æ‰§è¡Œçš„åŸå­æ€§ï¼Œæ‰€ä»¥ åªè¦ä¿è¯ldp x10, x11, [x16, #CACHE]è¿™æ®µä»£ç è¯»å–åˆ°çš„_bucketsä¸_maskæ˜¯äº’ç›¸åŒ¹é…çš„ï¼ˆå³è¦ä¹ˆåŒæ—¶æ˜¯æ‰©å®¹å‰çš„æ•°æ®ï¼Œè¦ä¹ˆåŒæ—¶æ˜¯æ‰©å®¹åçš„æ•°æ®ï¼‰ï¼Œé‚£ä¹ˆå¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å†™æ–¹æ³•ç¼“å­˜ä¹Ÿæ˜¯æ²¡æœ‰å®‰å…¨éšæ‚£çš„ã€‚ 3.3.1 ç¼–è¯‘å†…å­˜å±éšœè¿™é‡Œæœ‰ä¸ªç–‘é—®ï¼Œå³ç³»ç»Ÿæ˜¯å¦‚ä½•ç¡®ä¿_bucketsä¸_maskçš„è¿™ç§ä¸€è‡´æ€§çš„å‘¢ï¼Ÿè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªå˜é‡çš„å†™å…¥æºç  1234567891011121314151617181920void cache_t::setBucketsAndMask(struct bucket_t *newBuckets, mask_t newMask){ // objc_msgSend uses mask and buckets with no locks. // It is safe for objc_msgSend to see new buckets but old mask. // (It will get a cache miss but not overrun the buckets' bounds). // It is unsafe for objc_msgSend to see old buckets and new mask. // Therefore we write new buckets, wait a lot, then write new mask. // objc_msgSend reads mask first, then buckets. // ensure other threads see buckets contents before buckets pointer mega_barrier(); _buckets = newBuckets; // ensure other threads see new buckets before new mask mega_barrier(); _mask = newMask; _occupied = 0;} è¿™æ®µC++ä»£ç å…ˆä¿®æ”¹_bucketsï¼Œç„¶åå†æ›´æ–°_maskçš„å€¼ï¼Œä¸ºäº†ç¡®ä¿è¿™ä¸ªé¡ºåºä¸è¢«ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œè¿™é‡Œä½¿ç”¨äº†mega_baerrier()æ¥å®ç° ç¼–è¯‘å†…å­˜å±éšœï¼ˆCompiler Memory Barrierï¼‰ã€‚ å¦‚æœä¸è®¾ç½® ç¼–è¯‘å†…å­˜å±éšœ çš„è¯ï¼Œç¼–è¯‘å™¨æœ‰å¯èƒ½ä¼šä¼˜åŒ–ä»£ç å…ˆèµ‹å€¼_maskï¼Œç„¶åæ‰æ˜¯èµ‹å€¼_bucketsï¼Œä¸¤è€…çš„èµ‹å€¼ä¹‹é—´ï¼Œå¦‚æœå¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œldp x10, x11, [x16, #0x10]æŒ‡ä»¤ï¼Œå¾—åˆ°çš„å°±æ˜¯æ—§_bucketså’Œæ–°_maskï¼Œè¿›è€Œå‡ºç°å†…å­˜æ•°ç»„è¶Šç•Œå¼•å‘ç¨‹åºå´©æºƒã€‚ è€ŒåŠ å…¥äº†ç¼–è¯‘å†…å­˜å±éšœåï¼Œå°±ç®—å¾—åˆ°çš„æ˜¯æ–°_bucketså’Œæ—§_maskï¼Œä¹Ÿä¸ä¼šå¯¼è‡´ç¨‹åºå´©æºƒã€‚ ç¼–è¯‘å†…å­˜å±éšœä»…ä»…æ˜¯ç¡®ä¿_bucketsçš„èµ‹å€¼ä¼šä¼˜å…ˆäº_maskçš„èµ‹å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä»»ä½•åœºæ™¯ä¸‹å½“æŒ‡ä»¤ldp x10, x11, [x16, #CACHE]æ‰§è¡Œåï¼Œå¾—åˆ°çš„_bucketsæ•°ç»„çš„é•¿åº¦ä¸€å®šæ˜¯å¤§äºæˆ–ç­‰äº_mask+1çš„ï¼Œå¦‚æ­¤å°±ä¿è¯äº†ä¸ä¼šå‡ºç°å†…å­˜æ•°ç»„è¶Šç•Œå¯¼è‡´çš„ç¨‹åºå´©æºƒã€‚å¯è§ï¼Œå€ŸåŠ©ç¼–è¯‘å†…å­˜å±éšœçš„æŠ€å·§åœ¨ä¸€å®šçš„ç¨‹åº¦ä¸Šå¯ä»¥å®ç°æ— é”è¯»å†™æŠ€æœ¯ã€‚ å¯¹å†…å­˜å±éšœæ„Ÿå…´è¶£çš„åŒå­¦å¯æˆ³ ç†è§£ Memory barrierï¼ˆå†…å­˜å±éšœï¼‰ 3.3.2 å†…å­˜åƒåœ¾å›æ”¶æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨å¤šçº¿ç¨‹è¯»å†™æ–¹æ³•ç¼“å­˜æ—¶ï¼Œå†™çº¿ç¨‹å¯èƒ½ä¼šæ‰©å®¹_bucketsï¼ˆå¼€è¾Ÿæ–°çš„_bucketså†…å­˜ï¼ŒåŒæ—¶é”€æ¯æ—§çš„_bucketsï¼‰ï¼Œæ­¤æ—¶ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹è¯»å–åˆ°çš„_bucketsæ˜¯æ—§çš„å†…å­˜ï¼Œå°±æœ‰å¯èƒ½ä¼šå‘ç”Ÿè¯»å†…å­˜å¼‚å¸¸è€Œç³»ç»Ÿå´©æºƒã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒOCä½¿ç”¨äº†ä¸¤ä¸ªå…¨å±€æ•°ç»„objc_entryPointsã€objc_exitPointsï¼Œåˆ†åˆ«ä¿å­˜æ‰€æœ‰ä¼šè®¿é—®åˆ°cacheçš„å‡½æ•°çš„èµ·å§‹åœ°å€ã€ç»“æŸåœ°å€ 12extern &quot;C&quot; uintptr_t objc_entryPoints[];extern &quot;C&quot; uintptr_t objc_exitPoints[]; ä¸‹é¢åˆ—å‡ºè¿™äº›å‡½æ•°ï¼ˆåŒæ ·ä»¥ arm64æ¶æ„æ±‡ç¼– ä¸ºä¾‹ï¼‰ 12345678910111213141516171819.private_extern _objc_entryPoints_objc_entryPoints: .quad _cache_getImp .quad _objc_msgSend .quad _objc_msgSendSuper .quad _objc_msgSendSuper2 .quad _objc_msgLookup .quad _objc_msgLookupSuper2 .quad 0.private_extern _objc_exitPoints_objc_exitPoints: .quad LExit_cache_getImp .quad LExit_objc_msgSend .quad LExit_objc_msgSendSuper .quad LExit_objc_msgSendSuper2 .quad LExit_objc_msgLookup .quad LExit_objc_msgLookupSuper2 .quad 0 å½“çº¿ç¨‹æ‰©å®¹å“ˆå¸Œæ¡¶æ—¶ï¼Œä¼šå…ˆæŠŠæ—§çš„æ¡¶å†…å­˜ä¿å­˜åœ¨ä¸€ä¸ªå…¨å±€çš„åƒåœ¾å›æ”¶æ•°ç»„å˜é‡garbage_refsä¸­ï¼Œç„¶åå†éå†å½“å‰è¿›ç¨‹ï¼ˆåœ¨iOSä¸­ï¼Œä¸€ä¸ªè¿›ç¨‹å°±æ˜¯ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼‰ä¸­çš„æ‰€æœ‰çº¿ç¨‹ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œobjc_entryPointsåˆ—è¡¨ä¸­çš„å‡½æ•°ï¼ˆåŸç†æ˜¯PCå¯„å­˜å™¨ä¸­çš„å€¼æ˜¯å¦åœ¨objc_entryPointså’Œobjc_exitPointsè¿™ä¸ªèŒƒå›´å†…ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¯´æ˜æ²¡æœ‰ä»»ä½•çº¿ç¨‹è®¿é—®cacheï¼Œå¯ä»¥æ”¾å¿ƒåœ°å¯¹garbage_refsä¸­çš„æ‰€æœ‰å¾…é”€æ¯çš„å“ˆå¸Œæ¡¶å†…å­˜å—æ‰§è¡ŒçœŸæ­£çš„é”€æ¯æ“ä½œï¼›å¦‚æœæœ‰åˆ™è¯´æ˜æœ‰çº¿ç¨‹è®¿é—®cacheï¼Œè¿™æ¬¡å°±ä¸åšå¤„ç†ï¼Œä¸‹æ¬¡å†æ£€æŸ¥å¹¶åœ¨é€‚å½“çš„æ—¶å€™è¿›è¡Œé”€æ¯ã€‚ ä»¥ä¸Šï¼Œ**OC 2.0çš„runtimeå·§å¦™çš„åˆ©ç”¨äº†ldpæ±‡ç¼–æŒ‡ä»¤ã€ç¼–è¯‘å†…å­˜å±éšœæŠ€æœ¯ã€å†…å­˜åƒåœ¾å›æ”¶æŠ€æœ¯ç­‰å¤šç§æ‰‹æ®µæ¥è§£å†³å¤šçº¿ç¨‹è¯»å†™çš„æ— é”å¤„ç†æ–¹æ¡ˆï¼Œæ—¢ä¿è¯äº†å®‰å…¨ï¼Œåˆæå‡äº†ç³»ç»Ÿçš„æ€§èƒ½ã€‚** æ·±å…¥è§£æ„objc_msgSendå‡½æ•°çš„å®ç° è¿™ç¯‡åšæ–‡ä¼šå¸®åŠ©ä½ è¿›ä¸€æ­¥äº†è§£Runtimeçš„å®ç°ï¼Œå°¤å…¶åœ¨å¤šçº¿ç¨‹è¯»å†™æ–¹æ³•ç¼“å­˜æ–¹é¢ å››ã€é—®é¢˜è®¨è®ºæ¥åˆ°è¿™é‡Œï¼Œç›¸ä¿¡å¤§å®¶å¯¹cache_tç¼“å­˜æ–¹æ³•çš„åŸç†å·²ç»æœ‰äº†ä¸€å®šçš„ç†è§£ã€‚ç°åœ¨è¯·çœ‹ä¸‹é¢çš„å‡ ä¸ªé—®é¢˜ï¼š 4.1 ç±»æ–¹æ³•çš„ç¼“å­˜ä½ç½®Qï¼šPersonç±»è°ƒç”¨allocæ–¹æ³•åï¼Œallocæ–¹æ³•ç¼“å­˜åœ¨å“ªé‡Œï¼Ÿ Aï¼šç¼“å­˜åœ¨ Personå…ƒç±» çš„ cache_t ä¸­ã€‚è¯æ˜å¦‚ä¸‹å›¾ 4.2 _maskçš„ä½œç”¨Qï¼šè¯·è¯´æ˜cache_tä¸­_maskçš„ä½œç”¨ Aï¼š_maskä»ä¾§é¢åæ˜ äº†cache_tä¸­å“ˆå¸Œæ¡¶çš„æ•°é‡ï¼ˆå“ˆå¸Œæ¡¶çš„æ•°é‡ = _mask + 1ï¼‰ï¼Œä¿è¯äº†æŸ¥æ‰¾å“ˆå¸Œæ¡¶æ—¶ä¸ä¼šå‡ºç°è¶Šç•Œçš„æƒ…å†µã€‚ é¢˜è§£ï¼šä»ä¸Šé¢çš„æºç åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“cache_tåœ¨ä»»ä½•ä¸€æ¬¡ç¼“å­˜æ–¹æ³•çš„æ—¶å€™ï¼Œå“ˆå¸Œæ¡¶çš„æ•°é‡ä¸€å®šæ˜¯ &gt;=4ä¸”èƒ½è¢« 4æ•´é™¤çš„ï¼Œ_maskåˆ™ç­‰äºå“ˆå¸Œæ¡¶çš„æ•°é‡-1ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç¼“å­˜æ–¹æ³•çš„æ—¶å€™ï¼Œ_maskçš„äºŒè¿›åˆ¶ä½ä¸Šå…¨éƒ½æ˜¯1ã€‚å½“å¾ªç¯æŸ¥è¯¢å“ˆå¸Œæ¡¶çš„æ—¶å€™ï¼Œç´¢å¼•å€¼æ˜¯ç”±xx &amp; _maskè¿ç®—å¾—å‡ºçš„ï¼Œå› æ­¤ç´¢å¼•å€¼æ˜¯å°äºå“ˆå¸Œæ¡¶çš„æ•°é‡çš„ï¼ˆindex &lt;= _maskï¼Œæ•…index &lt; capacityï¼‰ï¼Œä¹Ÿå°±ä¸ä¼šå‡ºç°è¶Šç•Œçš„æƒ…å†µã€‚ 4.3 å…³äºæ‰©å®¹ä¸´ç•Œç‚¹3/4=0.75çš„è®¨è®ºQï¼šä¸ºä»€ä¹ˆæ‰©å®¹ä¸´ç•Œç‚¹æ˜¯3/4ï¼Ÿ Aï¼šä¸€èˆ¬è®¾å®šä¸´ç•Œç‚¹å°±ä¸å¾—ä¸æƒè¡¡ ç©ºé—´åˆ©ç”¨ç‡ å’Œ æ—¶é—´åˆ©ç”¨ç‡ ã€‚åœ¨ 3/4 è¿™ä¸ªä¸´ç•Œç‚¹çš„æ—¶å€™ï¼Œç©ºé—´åˆ©ç”¨ç‡æ¯”è¾ƒé«˜ï¼ŒåŒæ—¶åˆé¿å…äº†ç›¸å½“å¤šçš„å“ˆå¸Œå†²çªï¼Œæ—¶é—´åˆ©ç”¨ç‡ä¹Ÿæ¯”è¾ƒé«˜ã€‚ é¢˜è§£ï¼šæ‰©å®¹ä¸´ç•Œç‚¹ç›´æ¥å½±å“å¾ªç¯æŸ¥æ‰¾å“ˆå¸Œæ¡¶çš„æ•ˆç‡ã€‚è®¾æƒ³ä¸¤ä¸ªæç«¯æƒ…å†µï¼š å½“ä¸´ç•Œç‚¹æ˜¯1çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å…¨éƒ¨çš„å“ˆå¸Œæ¡¶éƒ½ç¼“å­˜æœ‰æ–¹æ³•æ—¶ï¼Œæ‰ä¼šæ‰©å®¹ã€‚è¿™è™½ç„¶è®©å¼€è¾Ÿå‡ºæ¥çš„å†…å­˜ç©ºé—´çš„åˆ©ç”¨ç‡è¾¾åˆ°100%ï¼Œä½†æ˜¯ä¼šé€ æˆå¤§é‡çš„å“ˆå¸Œå†²çªï¼ŒåŠ å‰§äº†æŸ¥æ‰¾ç´¢å¼•çš„æ—¶é—´æˆæœ¬ï¼Œå¯¼è‡´æ—¶é—´åˆ©ç”¨ç‡ä½ä¸‹ï¼Œè¿™ä¸é«˜é€Ÿç¼“å­˜çš„ç›®çš„ç›¸æ‚–ï¼› å½“ä¸´ç•Œç‚¹æ˜¯0.5çš„æ—¶å€™ï¼Œæ„å‘³ç€å“ˆå¸Œæ¡¶çš„å ç”¨é‡è¾¾åˆ°æ€»æ•°ä¸€åŠçš„æ—¶å€™ï¼Œå°±ä¼šæ‰©å®¹ã€‚è¿™è™½ç„¶æå¤§é¿å…äº†å“ˆå¸Œå†²çªï¼Œæ—¶é—´åˆ©ç”¨ç‡éå¸¸é«˜ï¼Œå´æµªè´¹äº†ä¸€åŠçš„ç©ºé—´ï¼Œä½¿å¾—ç©ºé—´åˆ©ç”¨ç‡ä½ä¸‹ã€‚è¿™ç§ä»¥ç©ºé—´æ¢å–æ—¶é—´çš„åšæ³•åŒæ ·ä¸å¯å–ï¼› ä¸¤ç›¸æƒè¡¡ä¸‹ï¼Œå½“æ‰©å®¹ä¸´ç•Œç‚¹æ˜¯3/4çš„æ—¶å€™ï¼Œç©ºé—´åˆ©ç”¨ç‡ å’Œ æ—¶é—´åˆ©ç”¨ç‡ éƒ½ç›¸å¯¹æ¯”è¾ƒé«˜ã€‚ 4.4 ç¼“å­˜å¾ªç¯æŸ¥æ‰¾çš„æ­»å¾ªç¯æƒ…å†µQï¼šç¼“å­˜å¾ªç¯æŸ¥æ‰¾å“ˆå¸Œæ¡¶æ˜¯å¦ä¼šå‡ºç°æ­»å¾ªç¯çš„æƒ…å†µï¼Ÿ Aï¼šä¸ä¼šå‡ºç°ã€‚ é¢˜è§£ï¼šå½“å“ˆå¸Œæ¡¶çš„åˆ©ç”¨ç‡è¾¾åˆ°3/4çš„æ—¶å€™ï¼Œä¸‹æ¬¡ç¼“å­˜çš„æ—¶å€™å°±ä¼šè¿›è¡Œæ‰©å®¹ï¼Œå³ç©ºæ¡¶çš„æ•°é‡æœ€å°‘ä¹Ÿä¼šæœ‰æ€»æ•°çš„1/4ï¼Œå› æ­¤å¾ªç¯æŸ¥è¯¢ç´¢å¼•çš„æ—¶å€™ï¼Œä¸€å®šä¼šå‡ºç°å‘½ä¸­ç¼“å­˜æˆ–è€…ç©ºæ¡¶çš„æƒ…å†µï¼Œä»è€Œç»“æŸå¾ªç¯ã€‚ äº”ã€æ€»ç»“é€šè¿‡ä»¥ä¸Šä¾‹å­çš„éªŒè¯ã€æºç çš„åˆ†æä»¥åŠé—®é¢˜çš„è®¨è®ºï¼Œç°åœ¨æ€»ç»“ä¸€ä¸‹cache_tçš„å‡ ä¸ªç»“è®ºï¼š 1.cache_tèƒ½ç¼“å­˜è°ƒç”¨è¿‡çš„æ–¹æ³•ã€‚ 2.cache_tçš„ä¸‰ä¸ªæˆå‘˜å˜é‡ä¸­ï¼Œ _bucketsçš„ç±»å‹æ˜¯struct bucket_t *ï¼Œä¹Ÿå°±æ˜¯æŒ‡é’ˆæ•°ç»„ï¼Œå®ƒè¡¨ç¤ºä¸€ç³»åˆ—çš„å“ˆå¸Œæ¡¶ï¼ˆå·²è°ƒç”¨çš„æ–¹æ³•çš„SELå’ŒIMPå°±ç¼“å­˜åœ¨å“ˆå¸Œæ¡¶ä¸­ï¼‰ï¼Œä¸€ä¸ªæ¡¶å¯ä»¥ç¼“å­˜ä¸€ä¸ªæ–¹æ³•ã€‚ _maskçš„ç±»å‹æ˜¯mask_tï¼ˆmask_tåœ¨64ä½æ¶æ„ä¸‹å°±æ˜¯uint32_tï¼Œé•¿åº¦ä¸º4ä¸ªå­—èŠ‚ï¼‰ï¼Œå®ƒçš„å€¼ç­‰äºå“ˆå¸Œæ¡¶çš„æ€»æ•°-1ï¼ˆcapacity - 1ï¼‰ï¼Œä¾§é¢åæ˜ äº†å“ˆå¸Œæ¡¶çš„æ€»æ•°ã€‚ _occupiedçš„ç±»å‹ä¹Ÿæ˜¯mask_tï¼Œå®ƒä»£è¡¨çš„æ˜¯å½“å‰_bucketså·²ç¼“å­˜çš„æ–¹æ³•æ•°ã€‚ 3.å½“ç¼“å­˜çš„æ–¹æ³•æ•°åˆ°è¾¾ä¸´ç•Œç‚¹ï¼ˆæ¡¶æ€»æ•°çš„3/4ï¼‰æ—¶ï¼Œä¸‹æ¬¡å†ç¼“å­˜æ–°çš„æ–¹æ³•æ—¶ï¼Œé¦–å…ˆä¼šä¸¢å¼ƒæ—§çš„æ¡¶ï¼ŒåŒæ—¶å¼€è¾Ÿæ–°çš„å†…å­˜ï¼Œä¹Ÿå°±æ˜¯æ‰©å®¹ï¼ˆæ‰©å®¹åéƒ½æ˜¯å…¨æ–°çš„æ¡¶ï¼Œä»¥åæ¯ä¸ªæ–¹æ³•éƒ½è¦é‡æ–°ç¼“å­˜çš„ï¼‰ï¼Œç„¶åå†æŠŠæ–°çš„æ–¹æ³•ç¼“å­˜ä¸‹æ¥ï¼Œæ­¤æ—¶_occupiedä¸º1ã€‚ 4.å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œå¯åˆ†ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š å¤šçº¿ç¨‹è¯»ç¼“å­˜ï¼šè¯»ç¼“å­˜ç”±æ±‡ç¼–å®ç°ï¼Œæ— é”ä¸”é«˜æ•ˆï¼Œç”±äºå¹¶æ²¡æœ‰æ”¹å˜_bucketså’Œ_maskï¼Œæ‰€ä»¥å¹¶æ— å®‰å…¨éšæ‚£ã€‚ å¤šçº¿ç¨‹å†™ç¼“å­˜ï¼šOCç”¨äº†ä¸ªå…¨å±€çš„äº’æ–¥é”ï¼ˆcacheUpdateLock.assertLocked()ï¼‰æ¥ä¿è¯ä¸ä¼šå‡ºç°å†™ä¸¤æ¬¡ç¼“å­˜çš„æƒ…å†µã€‚ å¤šçº¿ç¨‹è¯»å†™ç¼“å­˜ï¼šOCä½¿ç”¨äº†ldpæ±‡ç¼–æŒ‡ä»¤ã€ç¼–è¯‘å†…å­˜å±éšœæŠ€æœ¯ã€å†…å­˜åƒåœ¾å›æ”¶æŠ€æœ¯ç­‰å¤šç§æ‰‹æ®µæ¥è§£å†³å¤šçº¿ç¨‹è¯»å†™çš„æ— é”å¤„ç†æ–¹æ¡ˆï¼Œæ—¢ä¿è¯äº†å®‰å…¨ï¼Œåˆæå‡äº†ç³»ç»Ÿçš„æ€§èƒ½ã€‚ å‚è€ƒhttps://juejin.cn/post/6844904070596001806","link":"/2020/12/16/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/04-%E6%96%B9%E6%B3%95%E7%9A%84%E7%BC%93%E5%AD%98%E5%8E%9F%E7%90%86/"},{"title":"05-æ–¹æ³•çš„æœ¬è´¨å’Œæ¶ˆæ¯æŸ¥æ‰¾æµç¨‹","text":"å‰è¨€ åœ¨Objective-Cä¸­ï¼Œå½“ç¼–è¯‘å™¨é‡åˆ°ä¸€ä¸ªæ–¹æ³•è°ƒç”¨æ—¶ï¼Œå®ƒä¼šå°†æ–¹æ³•çš„è°ƒç”¨å˜æˆä»¥ä¸‹å‡½æ•°ä¸­çš„ä¸€ä¸ªï¼šobjc_msgSendã€objc_msgSend_stretã€objc_msgSendSuperå’Œobjc_msgSendSuper_stretã€‚ å‘é€ç»™å¯¹è±¡çš„çˆ¶ç±»çš„æ¶ˆæ¯ï¼ˆä½¿ç”¨superå…³é”®å­—æ—¶ï¼‰æ˜¯ä½¿ç”¨objc_msgSendSuperå‘é€çš„ï¼Œå…¶ä»–æ¶ˆæ¯æ˜¯ä½¿ç”¨objc_msgSendå‘é€çš„ã€‚å¦‚æœæ˜¯ä»¥æ•°æ®ç»“æ„ä½“ä½œä¸ºè¿”å›å€¼çš„æ–¹æ³•ï¼Œåˆ™æ˜¯ä½¿ç”¨objc_msgSendSuper_stretæˆ–objc_msgSend_stretå‘é€çš„ã€‚ ç„¶è€Œè¿™ä¸€åˆ‡ï¼Œéƒ½è¦ä»Runtimeå¼€å§‹è¯´èµ· ä¸€ã€Runtime1.1 ä»€ä¹ˆæ˜¯RuntimeRuntimeæ˜¯ä¸€å¥—APIï¼Œç”±cã€c++ã€æ±‡ç¼–ä¸€èµ·å†™æˆçš„ï¼Œä¸ºOCæä¾›äº†è¿è¡Œæ—¶çš„ç‰¹æ€§ è¿è¡Œæ—¶ï¼šä»£ç è·‘èµ·æ¥ï¼Œå°†å¯æ‰§è¡Œæ–‡ä»¶è£…è½½åˆ°å†…å­˜ ç¼–è¯‘æ—¶ï¼šæ­£åœ¨ç¼–è¯‘çš„æ—¶é—´â€”â€”ç¿»è¯‘æºä»£ç å°†é«˜çº§è¯­è¨€ï¼ˆOCã€Swiftï¼‰ç¿»è¯‘æˆæœºå™¨è¯­è¨€ï¼ˆæ±‡ç¼–ç­‰ï¼‰ï¼Œæœ€åå˜æˆäºŒè¿›åˆ¶ 1.2 Runtimeç‰ˆæœ¬Runtimeæœ‰ä¸¤ä¸ªç‰ˆæœ¬â€”â€”Legacyå’ŒModernï¼Œè‹¹æœå¼€å‘è€…æ–‡æ¡£éƒ½å†™å¾—æ¸…æ¸…æ¥šæ¥š æºç ä¸­-oldã€__OBJC__ä»£è¡¨Legacyç‰ˆæœ¬ -newã€__OBJC2__ä»£è¡¨Modernç‰ˆæœ¬ï¼Œä»¥æ­¤åšå…¼å®¹ 1.3 Runtimeçš„ä½œç”¨åŠè°ƒç”¨Runtimeåº•å±‚ç»è¿‡ç¼–è¯‘ä¼šæä¾›ä¸€å¥—APIå’Œä¾›FrameWorkã€Serviceä½¿ç”¨ 1.4 Runtime è°ƒç”¨æ–¹å¼ Runtime APIï¼Œå¦‚ sel_registerName() NSObject APIï¼Œå¦‚ isKindOf() OCä¸Šå±‚æ–¹å¼ï¼Œå¦‚ @selector() åŸæ¥å¹³å¸¸åœ¨ç”¨çš„è¿™ä¹ˆå¤šæ–¹æ³•éƒ½æ˜¯Runtimeå•Šï¼Œé‚£ä¹ˆæ–¹æ³•ç©¶ç«Ÿæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ äºŒã€æ–¹æ³•çš„æœ¬è´¨2.1 ç ”ç©¶æ–¹æ³•é€šè¿‡clangç¼–è¯‘æˆcppæ–‡ä»¶å¯ä»¥çœ‹åˆ°åº•å±‚ä»£ç ï¼Œå¾—åˆ°æ–¹æ³•çš„æœ¬è´¨ å…¼å®¹ç¼–è¯‘ï¼ˆä»£ç å°‘ï¼‰ï¼š 1clang -rewrite-objc main.m -o main.cpp å®Œæ•´ç¼–è¯‘ï¼ˆä¸æŠ¥é”™ï¼‰ï¼š 1xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc main.m -o main.cpp 2.2 ä»£ç è½¬æ¢12FXPerson *p = [FXPerson alloc];[p fly]; è½¬ä¸ºï¼š 12FXPerson *p = ((FXPerson *(*)(id, SEL))(void *)objc_msgSend)((id)objc_getClass(&quot;FXPerson&quot;), sel_registerName(&quot;alloc&quot;));((void (*)(id, SEL))(void *)objc_msgSend)((id)p, sel_registerName(&quot;fly&quot;)); ((FXPerson *(*)(id, SEL))(void *)æ˜¯ç±»å‹å¼ºè½¬ (id)objc_getClass(&quot;FXPerson&quot;)è·å–FXPersonç±»å¯¹è±¡ sel_registerName(&quot;alloc&quot;)ç­‰åŒäº@selector() é‚£ä¹ˆå¯ä»¥ç†è§£ä¸º((ç±»å‹å¼ºè½¬)objc_msgSend)(å¯¹è±¡, æ–¹æ³•è°ƒç”¨) å»é™¤å¼ºè½¬åå°±å®¹æ˜“åˆ†è¾¨å¤šäº† 12Person *person = objc_msgSend(objc_getClass(&quot;Person&quot;), sel_registerName(&quot;alloc&quot;));objc_msgSend(person, sel_registerName(&quot;personInstanceMethod1&quot;)); å‘ç°+allocå’ŒpersonInstanceMethod1è¿™ä¸¤ä¸ªæ–¹æ³•çš„è°ƒç”¨ï¼Œå®é™…ä¸Šå°±æ˜¯è°ƒç”¨objc_msgSendå‡½æ•°ã€‚ 2.3æ–¹æ³•çš„æœ¬è´¨å¯ä»¥åœ¨arm64.sæ–‡ä»¶ä¸­æ‰¾åˆ°objc_msgSendå‡½æ•°çš„è¯´æ˜ 1id objc_msgSend(id self, SEL _cmd, ...) å…¶ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°selfæ˜¯è°ƒç”¨è€…æœ¬èº«ï¼Œå®ƒä¹Ÿæ˜¯æ¥æ”¶è€…ï¼›ç¬¬äºŒä¸ªå‚æ•°_cmdæ˜¯æ–¹æ³•ç¼–å·ï¼›å‰©ä¸‹çš„å¯å˜å‚æ•°åˆ—è¡¨æ˜¯æ–¹æ³•è‡ªå·±çš„å‚æ•°ã€‚ ç®€å•è¯´æ˜ä¸€ä¸‹ï¼š idæŒ‡çš„æ˜¯OCå¯¹è±¡ï¼Œæ¯ä¸ªå¯¹è±¡åœ¨å†…å­˜çš„ç»“æ„éƒ½æ˜¯ä¸ç¡®å®šçš„ï¼Œä½†å…¶é¦–åœ°å€æŒ‡å‘çš„æ˜¯å¯¹è±¡çš„isaï¼Œé€šè¿‡isaï¼Œåœ¨è¿è¡Œæ—¶å°±èƒ½è·å–åˆ°objc_class objc_classè¡¨ç¤ºå¯¹è±¡çš„Classï¼Œå®ƒçš„ç»“æ„åœ¨ç¼–è¯‘åå°±ç¡®å®šäº† SELè¡¨ç¤ºé€‰æ‹©å™¨ï¼Œé€šå¸¸å¯ç†è§£ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ã€‚OCåœ¨è¿è¡Œæ—¶ç»´æŠ¤ç€ä¸€å¼ SELè¡¨ï¼Œå°†å­—ç¬¦ä¸²ç›¸åŒçš„æ–¹æ³•åæ˜ å°„åˆ°å”¯ä¸€ä¸€ä¸ªSELä¸Š ä»»æ„ç±»çš„ç›¸åŒæ–¹æ³•åæ˜ å°„çš„SELéƒ½ç›¸åŒï¼ˆå¯ä»¥æŠŠSELè¿‘ä¼¼åœ°ç­‰åŒäºæ–¹æ³•åï¼‰ å¯ä»¥é€šè¿‡sel_registerName(char *name)è¿™ä¸ªCå‡½æ•°å¾—åˆ°SELï¼ŒOCä¹Ÿæä¾›äº†ä¸€ä¸ªè¯­æ³•ç³–@selectorç”¨æ¥æ–¹ä¾¿çš„è°ƒç”¨è¯¥å‡½æ•° IMPæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆã€‚OCä¸­çš„æ–¹æ³•æœ€ç»ˆéƒ½ä¼šè½¬æ¢æˆçº¯Cçš„å‡½æ•°ï¼ŒIMPè¡¨ç¤ºçš„å°±æ˜¯è¿™äº›å‡½æ•°çš„åœ°å€ã€‚ å¦‚æœå¤–éƒ¨å®šä¹‰äº†Cå‡½æ•°å¹¶è°ƒç”¨å¦‚void fly() {}ï¼Œåœ¨clangç¼–è¯‘ä¹‹åè¿˜æ˜¯fly()è€Œä¸æ˜¯é€šè¿‡objc_msgSendå»è°ƒç”¨ã€‚å› ä¸ºå‘é€æ¶ˆæ¯å°±æ˜¯æ‰¾å‡½æ•°å®ç°çš„è¿‡ç¨‹ï¼Œè€ŒCå‡½æ•°å¯ä»¥é€šè¿‡å‡½æ•°åâ€”â€”æŒ‡é’ˆå°±å¯ä»¥æ‰¾åˆ° ä»ä¸Šé¢çš„ä¾‹å­å¯ä»¥å¾—å‡ºä¸€ä¸ªç»“è®ºï¼šæ–¹æ³•è°ƒç”¨çš„æœ¬è´¨æ˜¯é€šè¿‡objc_msgSendå‡½æ•°ï¼Œå‘è°ƒç”¨è€…å‘é€åä¸ºSELçš„æ¶ˆæ¯ï¼Œæ‰¾åˆ°å…·ä½“çš„å‡½æ•°åœ°å€IMPï¼Œè¿›è€Œæ‰§è¡Œè¯¥å‡½æ•°ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸‹é¢çš„ä¸¤æ®µä»£ç å®é™…ä¸Šæ•ˆæœæ˜¯ç›¸åŒçš„ è¦æƒ³ä½¿ç”¨ objc_msgSend å‡½æ•°ï¼Œéœ€è¦æ”¹ä¸€å¤„è®¾ç½®ã€‚å¦‚ä¸‹å›¾ï¼š 2.4å‘ä¸åŒå¯¹è±¡å‘é€æ¶ˆæ¯1234567891011121314151617#import &lt;Foundation/Foundation.h&gt;#import &lt;objc/message.h&gt;@interface FXFather: NSObject- (void)walk;+ (void)run;@end@implementation FXFather- (void)walk { NSLog(@&quot;%s&quot;,__func__); }+ (void)run { NSLog(@&quot;%s&quot;,__func__); }@end@interface FXSon: FXFather- (void)jump;+ (void)swim;@end å­ç±»FXSonæœ‰å®ä¾‹æ–¹æ³•jumpã€ç±»æ–¹æ³•swim çˆ¶ç±»FXFatheræœ‰å®ä¾‹æ–¹æ³•walkã€ç±»æ–¹æ³•run â‘ å‘é€å®ä¾‹æ–¹æ³• æ¶ˆæ¯æ¥æ”¶è€…â€”â€”å®ä¾‹å¯¹è±¡ 12FXSon *s = [FXSon new];objc_msgSend(s, sel_registerName(&quot;jump&quot;)); â‘¡å‘é€ç±»æ–¹æ³• æ¶ˆæ¯æ¥æ”¶è€…â€”â€”ç±»å¯¹è±¡ 1objc_msgSend(objc_getClass(&quot;FXSon&quot;), sel_registerName(&quot;swim&quot;)); â‘¢å‘çˆ¶ç±»å‘é€å®ä¾‹æ–¹æ³• objc_msgSendä¸èƒ½å‘çˆ¶ç±»å‘é€æ¶ˆæ¯ï¼Œéœ€è¦ä½¿ç”¨objc_msgSendSuperï¼Œå¹¶ç»™objc_superç»“æ„ä½“èµ‹å€¼ï¼ˆåœ¨objc2ä¸­åªéœ€è¦èµ‹å€¼receiverã€super_classï¼‰ 123456789101112131415/// Specifies the superclass of an instance. struct objc_super { /// Specifies an instance of a class. __unsafe_unretained _Nonnull id receiver; /// Specifies the particular superclass of the instance to message. #if !defined(__cplusplus) &amp;&amp; !__OBJC2__ /* For compatibility with old objc-runtime.h header */ __unsafe_unretained _Nonnull Class class;#else __unsafe_unretained _Nonnull Class super_class;#endif /* super_class is the first class to search */};#endif receiverâ€”â€”å®ä¾‹å¯¹è±¡ï¼›super_classâ€”â€”çˆ¶ç±»ç±»å¯¹è±¡ 1234struct objc_super superInstanceMethod;superInstanceMethod.receiver = s;superInstanceMethod.super_class = objc_getClass(&quot;FXFather&quot;);objc_msgSendSuper(&amp;superInstanceMethod, sel_registerName(&quot;walk&quot;)); â‘£å‘çˆ¶ç±»å‘é€ç±»æ–¹æ³• receiverâ€”â€”ç±»å¯¹è±¡ï¼›super_classâ€”â€”çˆ¶ç±»å…ƒç±»å¯¹è±¡ 1234struct objc_super superClassMethod;superClassMethod.receiver = [s class];superClassMethod.super_class = class_getSuperclass(object_getClass([s class]));objc_msgSendSuper(&amp;superClassMethod, sel_registerName(&quot;run&quot;)); ä¸‰ã€æ¶ˆæ¯æŸ¥æ‰¾æµç¨‹æ–¹æ³•çš„æŸ¥æ‰¾ï¼Œä¹Ÿå«æ¶ˆæ¯çš„æŸ¥æ‰¾ï¼Œå®ƒçš„å‡†å¤‡å·¥ä½œæ˜¯ä»objc_msgSendå¼€å§‹ï¼Œå‡†å¤‡å°±ç»ªåï¼Œæ‰ä¼šå±•å¼€æŸ¥æ‰¾ã€‚ 3.1å¼€å§‹æŸ¥æ‰¾æ‰“å¼€objcæºç ï¼Œç”±äºä¸»è¦ç ”ç©¶arm64ç»“æ„çš„æ±‡ç¼–å®ç°ï¼Œæ¥åˆ°objc-msg-arm64.sï¼š æ‰¾åˆ°objc_msgSendçš„æºç ï¼š 1id objc_msgSend(id self, SEL _cmd, ...); p0è¡¨ç¤º0å¯„å­˜å™¨çš„æŒ‡é’ˆï¼Œx0è¡¨ç¤ºå®ƒçš„å€¼ï¼Œw0è¡¨ç¤ºä½32ä½çš„å€¼ï¼ˆä¸ç”¨è¿‡å¤šåœ¨æ„ï¼‰ â‘ å¼€å§‹objc_msgSend â‘¡åˆ¤æ–­æ¶ˆæ¯æ¥æ”¶è€…æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºç›´æ¥è¿”å› â‘¢åˆ¤æ–­tagged_pointersï¼ˆä¹‹åä¼šè®²åˆ°ï¼‰ â‘£å–å¾—å¯¹è±¡ä¸­çš„isaå­˜ä¸€ä»½åˆ°p13ä¸­ï¼ˆå¯„å­˜å™¨æŒ‡ä»¤åœ¨é€†å‘ç¯‡ä¸­ä¼šè®²åˆ°ï¼‰ â‘¤æ ¹æ®isaè¿›è¡Œmaskåœ°å€åç§»å¾—åˆ°å¯¹åº”çš„ä¸Šçº§å¯¹è±¡ï¼ˆç±»ã€å…ƒç±»ï¼‰ æŸ¥çœ‹GetClassFromIsa_p16æºç ï¼š 1.macro GetClassFromIsa_p16 ä¸»è¦å°±æ˜¯è¿›è¡Œisa &amp; maskå¾—åˆ°classæ“ä½œ â‘¥å¼€å§‹åœ¨ç¼“å­˜ä¸­æŸ¥æ‰¾impâ€”â€”å¼€å¯å¿«é€Ÿæµç¨‹ 3.2å¿«é€Ÿæµç¨‹ä»CacheLookupå¼€å§‹å¿«é€ŸæŸ¥æ‰¾æµç¨‹ï¼ˆæ­¤æ—¶x0æ˜¯selï¼Œx16æ˜¯classï¼‰ï¼Œæ¨¡å¼æ˜¯NORMALã€‚ 1.macro CacheLookup â‘ #CACHEæ˜¯ä¸ªå®å®šä¹‰è¡¨ç¤º16ä¸ªå­—èŠ‚ï¼Œ[x16, #CACHE]è¡¨ç¤ºç±»å¯¹è±¡å†…å­˜åœ°å€åç§»16å­—èŠ‚å¾—åˆ°cacheã€‚ cacheä¸€åˆ†ä¸ºäºŒï¼š8å­—èŠ‚çš„bucketså­˜æ”¾åœ¨p10ï¼Œä¸¤ä¸ª4å­—èŠ‚çš„occupiedå’Œmaskå­˜æ”¾åœ¨p11 12#define CLASS __SIZEOF_POINTER__#define CACHE (2 * __SIZEOF_POINTER__) â‘¡x1æ˜¯selå³cmdï¼Œå–å‡ºp11ä¸­çš„ä½32ä½ï¼ˆw11ï¼‰ï¼šmaskï¼Œä¸¤è€…è¿›è¡Œä¸è¿ç®—å¾—åˆ°hashä¸‹æ ‡ å­˜æ”¾åœ¨x12 â‘¢p12å…ˆå·¦ç§»åŠ¨(1+PTRSHIFT)ï¼Œå†ä¸p10bucketsç›¸åŠ å¾—åˆ°æ–°çš„p12â€”â€”bucket â‘£æ‹¿å‡ºp12bucketåœ°å€æ‰€åœ¨çš„å€¼ï¼Œæ”¾åœ¨p17impå’Œp9selä¸­ï¼Œè¿™ç‚¹å¯ä»¥ä»bucket_tçš„ç»“æ„ä¸­çœ‹å‡ºï¼ˆselå¼ºè½¬æˆkeyï¼‰ç”¨bucketä¸­çš„selä¸x1cmdä½œå¯¹æ¯”ï¼Œå¦‚æœç›¸åŒåˆ™ç¼“å­˜å‘½ä¸­CacheHitå¾—åˆ°å…¶ä¸­çš„impï¼›å¦‚æœä¸ç­‰å°±è·³è½¬ 12345678910111213struct bucket_t {private: // IMP-first is better for arm64e ptrauth and no worse for arm64. // SEL-first is better for armv7* and i386 and x86_64.#if __arm64__ MethodCacheIMP _imp; cache_key_t _key;#else cache_key_t _key; MethodCacheIMP _imp;#endif ...} â‘¤å¦‚æœbucket-&gt;sel == 0åˆ™CheckMissï¼›æ¯”è¾ƒp12bucketå’Œp10bucketsï¼Œå¦‚æœä¸ç›¸ç­‰å°±å°†x12bucketçš„å€¼è¿›è¡Œè‡ªå‡æ“ä½œï¼ˆæŸ¥æ‰¾ä¸Šä¸€ä¸ªbucketï¼‰ï¼Œè·³è½¬å›â‘£é‡æ–°å¾ªç¯ï¼Œç›´åˆ°bucket == bucketséå†ç»“æŸè·³è½¬â‘¥ 123456789101112.macro CheckMiss // miss if bucket-&gt;sel == 0.if $0 == GETIMP cbz p9, LGetImpMiss.elseif $0 == NORMAL cbz p9, __objc_msgSend_uncached.elseif $0 == LOOKUP cbz p9, __objc_msgLookup_uncached.else.abort oops.endif.endmacro â‘¥å¹³ç§»å“ˆå¸Œä½¿å¾—p12 = first bucketï¼Œå†é‡å¤è¿›è¡Œä¸€ä¸‹ç±»ä¼¼â‘£â‘¤â‘¥çš„æ“ä½œï¼š é˜²æ­¢ä¸æ–­å¾ªç¯çš„è¿‡ç¨‹ä¸­å¤šçº¿ç¨‹å¹¶å‘çš„æ—¶å€™æ­£å¥½ç¼“å­˜æ›´æ–°äº†ã€‚ å¦‚æœbucket-&gt;sel == 0èµ°CheckMissï¼Œå¦‚æœbucket == bucketsèµ°JumpMissï¼Œæœ¬è´¨æ˜¯ä¸€æ ·çš„ 1234567891011.macro JumpMiss.if $0 == GETIMP b LGetImpMiss.elseif $0 == NORMAL b __objc_msgSend_uncached.elseif $0 == LOOKUP b __objc_msgLookup_uncached.else.abort oops.endif.endmacro å½“NORMALæ—¶ï¼ŒCheckMisså’ŒJumpMisséƒ½èµ°__objc_msgSend_uncached â‘¦__objc_msgSend_uncachedè°ƒç”¨MethodTableLookup â‘§ä¿å­˜å‚æ•°è°ƒç”¨c++æ–¹æ³•è¿›å…¥æ…¢é€Ÿæµç¨‹ 1.macro MethodTableLookup å¿«é€ŸæŸ¥æ‰¾çš„è¿‡ç¨‹ç®€è¦æ€»ç»“: å¿«é€ŸæŸ¥æ‰¾å®Œæ•´æµç¨‹å›¾ï¼š 3.3æ…¢é€ŸæŸ¥æ‰¾æ±‡ç¼–__class_lookupMethodAndLoadCache3ä¸c++ä¸­_class_lookupMethodAndLoadCache3ç›¸å¯¹åº” 12345IMP _class_lookupMethodAndLoadCache3(id obj, SEL sel, Class cls){ return lookUpImpOrForward(cls, sel, obj, YES/*initialize*/, NO/*cache*/, YES/*resolver*/);} 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128// initialize = YES , cache = NO , resolver = YESIMP lookUpImpOrForward(Class cls, SEL sel, id inst, bool initialize, bool cache, bool resolver){ IMP imp = nil; bool triedResolver = NO; runtimeLock.assertUnlocked(); // ç¼“å­˜æŸ¥æ‰¾ï¼Œcacheä¸ºNOç›´æ¥è·³è¿‡ if (cache) { imp = cache_getImp(cls, sel); if (imp) return imp; } // runtimeLock is held during isRealized and isInitialized checking // to prevent races against concurrent realization. // runtimeLock is held during method search to make // method-lookup + cache-fill atomic with respect to method addition. // Otherwise, a category could be added but ignored indefinitely because // the cache was re-filled with the old value after the cache flush on // behalf of the category. // lockæ˜¯ä¸ºäº†é˜²æ­¢å¤šçº¿ç¨‹æ“ä½œï¼› ç±»æ˜¯å¦è¢«ç¼–è¯‘ runtimeLock.lock(); checkIsKnownClass(cls); // ä¸ºæŸ¥æ‰¾æ–¹æ³•åšå‡†å¤‡æ¡ä»¶ï¼Œå¦‚æœç±»æ²¡æœ‰åˆå§‹åŒ–æ—¶ï¼Œåˆå§‹åŒ–ç±»å’Œçˆ¶ç±»ã€å…ƒç±»ç­‰ if (!cls-&gt;isRealized()) { realizeClass(cls); } if (initialize &amp;&amp; !cls-&gt;isInitialized()) { runtimeLock.unlock(); _class_initialize (_class_getNonMetaClass(cls, inst)); runtimeLock.lock(); // If sel == initialize, _class_initialize will send +initialize and // then the messenger will send +initialize again after this // procedure finishes. Of course, if this is not being called // from the messenger then it won't happen. 2778172 } retry: runtimeLock.assertLocked(); // Try this class's cache. // ä»ç¼“å­˜é‡Œé¢æŸ¥æ‰¾ä¸€éï¼Œè‹¥æœ‰ç›´æ¥goto done imp = cache_getImp(cls, sel); if (imp) goto done; // Try this class's method lists. // å½¢æˆå±€éƒ¨ä½œç”¨åŸŸï¼Œé¿å…å±€éƒ¨å˜é‡å‘½åé‡å¤ { // åœ¨ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾æ–¹æ³•ï¼Œè‹¥æœ‰ç›´æ¥cache_fill Method meth = getMethodNoSuper_nolock(cls, sel); if (meth) { log_and_fill_cache(cls, meth-&gt;imp, sel, inst, cls); imp = meth-&gt;imp; goto done; } } // Try superclass caches and method lists. { unsigned attempts = unreasonableClassCount(); // éå†çˆ¶ç±»è¿›è¡ŒæŸ¥æ‰¾ for (Class curClass = cls-&gt;superclass; curClass != nil; curClass = curClass-&gt;superclass) { // Halt if there is a cycle in the superclass chain. if (--attempts == 0) { _objc_fatal(&quot;Memory corruption in class list.&quot;); } // Superclass cache. // åœ¨çˆ¶ç±»ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œè‹¥æœ‰ç›´æ¥cache_fill imp = cache_getImp(curClass, sel); if (imp) { if (imp != (IMP)_objc_msgForward_impcache) { // Found the method in a superclass. Cache it in this class. log_and_fill_cache(cls, imp, sel, inst, curClass); goto done; } else { // Found a forward:: entry in a superclass. // Stop searching, but don't cache yet; call method // resolver for this class first. break; } } // Superclass method list. // åœ¨çˆ¶ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾æ–¹æ³•ï¼Œè‹¥æœ‰ç›´æ¥cache_fill Method meth = getMethodNoSuper_nolock(curClass, sel); if (meth) { log_and_fill_cache(cls, meth-&gt;imp, sel, inst, curClass); imp = meth-&gt;imp; goto done; } } } // No implementation found. Try method resolver once. // å¦‚æœæ–¹æ³•ä»ç„¶æ²¡æ‰¾åˆ°ï¼Œå°±å¼€å§‹åšåŠ¨æ€æ–¹æ³•è§£æ if (resolver &amp;&amp; !triedResolver) { runtimeLock.unlock(); _class_resolveMethod(cls, sel, inst); // âœ… runtimeLock.lock(); // Don't cache the result; we don't hold the lock so it may have // changed already. Re-do the search from scratch instead. triedResolver = YES; goto retry; } // No implementation found, and method resolver didn't help. // Use forwarding. // å¼€å§‹æ¶ˆæ¯è½¬å‘ imp = (IMP)_objc_msgForward_impcache; cache_fill(cls, sel, imp, inst); done: runtimeLock.unlock(); return imp;} æ…¢é€Ÿæµç¨‹ä¸»è¦åˆ†ä¸ºå‡ ä¸ªæ­¥éª¤ï¼š â‘ _class_lookupMethodAndLoadCache3è°ƒç”¨lookUpImpOrForwardï¼Œæ­¤æ—¶å‚æ•°initialize=YES cache=NO resolver=YES â‘¡runtimeLock.lock()ä¸ºäº†é˜²æ­¢å¤šçº¿ç¨‹æ“ä½œ â‘¢realizeClass(cls)ä¸ºæŸ¥æ‰¾æ–¹æ³•åšå‡†å¤‡æ¡ä»¶ï¼Œå¦‚æœç±»æ²¡æœ‰åˆå§‹åŒ–æ—¶ï¼Œåˆå§‹åŒ–ç±»å’Œçˆ¶ç±»ã€å…ƒç±»ç­‰ â‘£imp = cache_getImp(cls, sel)ä¸ºäº†å®¹é”™ä»ç¼“å­˜ä¸­å†æ‰¾ä¸€éï¼Œè‹¥æœ‰goto doneâ‘¨ â‘¤// Try this class's method listså±€éƒ¨ä½œç”¨åŸŸä¸­ï¼Œåœ¨ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾æ–¹æ³•ï¼Œè‹¥æœ‰ç›´æ¥log_and_fill_cacheå¹¶goto doneâ‘¨ â‘¥// Try superclass caches and method listså±€éƒ¨ä½œç”¨åŸŸä¸­ï¼Œéå†çˆ¶ç±»ï¼šå…ˆåœ¨çˆ¶ç±»ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œè‹¥æœ‰ç›´æ¥log_and_fill_cacheå¹¶goto doneï¼›æ²¡æœ‰å†å»çˆ¶ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾æ–¹æ³•ï¼Œè‹¥æœ‰ç›´æ¥log_and_fill_cacheå¹¶goto doneâ‘¨ â‘¦å¦‚æœè¿˜æ²¡æ‰¾åˆ°å°±åŠ¨æ€æ–¹æ³•è§£æresolveMethodï¼Œæ ‡è®°ä¸ºtriedResolver = YESï¼ˆå·²è‡ªæˆ‘æ‹¯æ•‘è¿‡ï¼‰ã€‚åŠ¨æ€æ–¹æ³•è§£æç»“æŸåè·³è½¬æ…¢é€Ÿæµç¨‹â‘£ â‘§å¦‚æœåŠ¨æ€æ–¹æ³•è§£æå®Œæˆåå†æ‰¾ä¸€éä»ç„¶æ²¡æ‰¾åˆ°impï¼Œå°±æŠ›å‡ºé”™è¯¯_objc_msgForward_impcacheå¾—åˆ°impå¹¶cache_fill â‘¨doneï¼šå¤šçº¿ç¨‹è§£é”ï¼Œè¿”å›imp æ¥ä¸‹æ¥æ‹†è§£æ­¥éª¤è¿›è¡Œè¯´æ˜ï¼š cache_getImpè¿™ä¸ªæ–¹æ³•åç»­ä¼šè§£é‡Š getMethodNoSuper_nolockéå†è°ƒç”¨search_method_listæŸ¥æ‰¾æ–¹æ³•åˆ—è¡¨ 12345678910111213141516171819getMethodNoSuper_nolock(Class cls, SEL sel){ runtimeLock.assertLocked(); assert(cls-&gt;isRealized()); // fixme nil cls? // fixme nil sel? for (auto mlists = cls-&gt;data()-&gt;methods.beginLists(), end = cls-&gt;data()-&gt;methods.endLists(); mlists != end; ++mlists) { method_t *m = search_method_list(*mlists, sel); if (m) return m; } return nil;} search_method_liståˆ©ç”¨äºŒåˆ†æŸ¥æ‰¾å¯»æ‰¾æ–¹æ³• 1234567891011121314151617181920212223242526272829static method_t *search_method_list(const method_list_t *mlist, SEL sel){ int methodListIsFixedUp = mlist-&gt;isFixedUp(); int methodListHasExpectedSize = mlist-&gt;entsize() == sizeof(method_t); if (__builtin_expect(methodListIsFixedUp &amp;&amp; methodListHasExpectedSize, 1)) { // å¦‚æœæ–¹æ³•åˆ—è¡¨å·²ç»æ’åºå¥½äº†ï¼Œåˆ™é€šè¿‡äºŒåˆ†æŸ¥æ‰¾æ³•æŸ¥æ‰¾æ–¹æ³•ï¼Œä»¥èŠ‚çœæ—¶é—´ return findMethodInSortedMethodList(sel, mlist); } else { // Linear search of unsorted method list // å¦‚æœæ–¹æ³•åˆ—è¡¨æ²¡æœ‰æ’åºå¥½å°±éå†æŸ¥æ‰¾ for (auto&amp; meth : *mlist) { if (meth.name == sel) return &amp;meth; } }#if DEBUG // sanity-check negative results if (mlist-&gt;isFixedUp()) { for (auto&amp; meth : *mlist) { if (meth.name == sel) { _objc_fatal(&quot;linear search worked when binary search did not&quot;); } } }#endif return nil;} findMethodInSortedMethodListäºŒåˆ†æŸ¥æ‰¾ç®—æ³•çš„å…·ä½“å®ç°ï¼ˆäº†è§£å³å¯ï¼‰ 12345678910111213141516171819202122232425262728293031323334353637static method_t *findMethodInSortedMethodList(SEL key, const method_list_t *list){ assert(list); const method_t * const first = &amp;list-&gt;first; const method_t *base = first; const method_t *probe; uintptr_t keyValue = (uintptr_t)key; uint32_t count; // &gt;&gt;1 è¡¨ç¤ºå°†å˜é‡nçš„å„ä¸ªäºŒè¿›åˆ¶ä½é¡ºåºå³ç§»1ä½ï¼Œæœ€é«˜ä½è¡¥äºŒè¿›åˆ¶0 // count &gt;&gt;= 1 å¦‚æœcountä¸ºå¶æ•°åˆ™å€¼å˜ä¸º(count / 2)ï¼›å¦‚æœcountä¸ºå¥‡æ•°åˆ™å€¼å˜ä¸º(count-1) / 2 for (count = list-&gt;count; count != 0; count &gt;&gt;= 1) { probe = base + (count &gt;&gt; 1); // å–å‡ºä¸­é—´method_tçš„nameï¼Œä¹Ÿå°±æ˜¯SEL uintptr_t probeValue = (uintptr_t)probe-&gt;name; if (keyValue == probeValue) { // `probe` is a match. // Rewind looking for the *first* occurrence of this value. // This is required for correct category overrides. // ç»§ç»­å‘å‰äºŒåˆ†æŸ¥è¯¢ while (probe &gt; first &amp;&amp; keyValue == (uintptr_t)probe[-1].name) { probe--; } // å–å‡º probe return (method_t *)probe; } // å¦‚æœkeyValue &gt; probeValue åˆ™æŠ˜åŠå‘åæŸ¥è¯¢ if (keyValue &gt; probeValue) { base = probe + 1; count--; } } return nil;} log_and_fill_cache-&gt;cache_fill-&gt;cache_fill_nolockè¿›è¡Œç¼“å­˜ 12345678910111213log_and_fill_cache(Class cls, IMP imp, SEL sel, id receiver, Class implementer){#if SUPPORT_MESSAGE_LOGGING if (objcMsgLogEnabled) { bool cacheIt = logMessageSend(implementer-&gt;isMetaClass(), cls-&gt;nameForLogging(), implementer-&gt;nameForLogging(), sel); if (!cacheIt) return; }#endif cache_fill (cls, sel, imp, receiver);} resolveMethodåŠ¨æ€æ–¹æ³•è§£æâ€”â€”åœ¨æ‰¾ä¸åˆ°impæ—¶çš„è‡ªæˆ‘æ‹¯æ•‘æ“ä½œ ä¸»è¦é€»è¾‘æ˜¯æ˜¯objc_msgSendå‡½æ•°å‘é€SEL_resolveInstanceMethodæ¶ˆæ¯ï¼Œç³»ç»Ÿè°ƒç”¨resolveInstanceMethod å‘é€æ¶ˆæ¯åï¼Œç³»ç»Ÿä¼šå†æŸ¥æ‰¾ä¸€ä¸‹selæ–¹æ³• 123456789101112131415161718void _class_resolveMethod(Class cls, SEL sel, id inst){ if (! cls-&gt;isMetaClass()) { // try [cls resolveInstanceMethod:sel] _class_resolveInstanceMethod(cls, sel, inst); } else { // try [nonMetaClass resolveClassMethod:sel] // and [cls resolveInstanceMethod:sel] _class_resolveClassMethod(cls, sel, inst); if (!lookUpImpOrNil(cls, sel, inst, NO/*initialize*/, YES/*cache*/, NO/*resolver*/)) { _class_resolveInstanceMethod(cls, sel, inst); } }} _objc_msgForward_impcacheåœ¨æ±‡ç¼–ä¸­è°ƒç”¨äº†_objc_msgForwardï¼Œç„¶ååˆè¿›å…¥_objc_forward_handlerï¼Œå®ƒåœ¨c++è°ƒç”¨äº†objc_defaultForwardHandler 123456789void *_objc_forward_handler = (void*)objc_defaultForwardHandler;objc_defaultForwardHandler(id self, SEL sel){ _objc_fatal(&quot;%c[%s %s]: unrecognized selector sent to instance %p &quot; &quot;(no message forward handler is installed)&quot;, class_isMetaClass(object_getClass(self)) ? '+' : '-', object_getClassName(self), sel_getName(sel), self);} åŸæ¥unrecognized selector sent to instance xxxæ˜¯è¿™ä¹ˆæ¥çš„å•Šâ€¦ æ…¢é€ŸæŸ¥æ‰¾çš„è¿‡ç¨‹ç®€è¦æ€»ç»“: æ…¢é€ŸæŸ¥æ‰¾å®Œæ•´æµç¨‹å›¾ï¼š å››ã€æ€»ç»“æ¥åˆ°è¿™é‡Œï¼Œå·²ç»æŠŠæ¶ˆæ¯çš„æŸ¥æ‰¾ä»‹ç»å®Œæ¯•ï¼Œæ˜¯æ—¶å€™æ€»ç»“ä¸€ä¸‹äº†ã€‚ 4.1æ–¹æ³•è°ƒç”¨çš„æœ¬è´¨ æ–¹æ³•çš„è°ƒç”¨ä¼šè¢«ç¼–è¯‘å™¨ç¿»è¯‘æˆobjc_msgSendã€objc_msgSendSuperã€objc_msgSend_stretå’Œobjc_msgSendSuper_stretè¿™å››ä¸ªå‡½æ•°ä¹‹ä¸€ï¼Œè¿™å››ä¸ªå‡½æ•°éƒ½æ˜¯ç”±æ±‡ç¼–ä»£ç å®ç°çš„ã€‚ å¦‚æœæ˜¯ä»¥æ•°æ®ç»“æ„ä½“ä½œä¸ºè¿”å›å€¼çš„æ–¹æ³•ï¼Œæœ€ç»ˆä¼šè½¬æ¢æˆç›¸åº”çš„objc_msgSend_stretæˆ–objc_msgSendSuper_stretå‡½æ•° ä½¿ç”¨superå…³é”®å­—è°ƒç”¨æ–¹æ³•æ—¶ï¼Œæ˜¯ä½¿ç”¨objc_msgSendSuperå‘é€çš„ å…¶ä»–çš„æ–¹æ³•è°ƒç”¨æ˜¯ä½¿ç”¨objc_msgSendå‡½æ•°å‘é€æ¶ˆæ¯çš„ã€‚ æ–¹æ³•çš„è°ƒç”¨æ˜¯é€šè¿‡objc_msgSendï¼ˆæˆ–objc_msgSendSuperï¼Œæˆ–objc_msgSend_stretï¼Œæˆ–objc_msgSendSuper_stretï¼‰å‡½æ•°ï¼Œå‘è°ƒç”¨è€…å‘é€åä¸ºSELçš„æ¶ˆæ¯ï¼Œæ‰¾åˆ°å…·ä½“çš„å‡½æ•°åœ°å€IMPï¼Œè¿›è€Œæ‰§è¡Œè¯¥å‡½æ•°ã€‚ 4.2æ–¹æ³•çš„æŸ¥æ‰¾æ–¹æ³•çš„æŸ¥æ‰¾æµç¨‹å¦‚ä¸‹ï¼š 1.ä»objc_msgSendæºç å¼€å§‹ï¼Œä¼šå…ˆå» ç±»ï¼ˆå®ä¾‹æ–¹æ³•ï¼‰/å…ƒç±»ï¼ˆç±»æ–¹æ³•ï¼‰ çš„ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°IMPåˆ™è¿”å›å¹¶è°ƒç”¨ï¼Œå¦åˆ™ä¼šå» ç±»/å…ƒç±» çš„æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾ 2.â€œæ­¥éª¤1â€ä¸­çš„â€œç¼“å­˜+æ–¹æ³•åˆ—è¡¨â€çš„æŸ¥æ‰¾æ–¹æ¡ˆï¼Œä¼šéå†ç±»çš„ç»§æ‰¿ä½“ç³»ï¼ˆç±»ã€ç±»çš„çˆ¶ç±»ã€â€¦ã€æ ¹ç±»ï¼‰ï¼Œåˆ†åˆ«è¿›è¡ŒæŸ¥æ‰¾ï¼Œç›´è‡³æ‰¾åˆ°IMPä¸ºæ­¢ã€‚ å¦‚æœåœ¨å½“å‰ç±»çš„ç¼“å­˜ä¸­æ²¡æ‰¾åˆ°ï¼Œä½†æ˜¯åœ¨å…¶æ–¹æ³•åˆ—è¡¨ï¼ˆæˆ–å…¶â€œçˆ¶ç±»â€¦æ ¹ç±»â€çš„ç¼“å­˜æˆ–æ–¹æ³•åˆ—è¡¨ï¼‰ä¸­æ‰¾åˆ°äº†IMPï¼Œéœ€è¦è¿›è¡Œä¸€æ¬¡æ˜¯å¦æ˜¯æ¶ˆæ¯è½¬å‘çš„åˆ¤æ–­ï¼Œå¦‚æœä¸æ˜¯æ¶ˆæ¯è½¬å‘ï¼Œé‚£ä¹ˆå°±å¯¹å½“å‰ç±»çš„ç¼“å­˜è¿›è¡Œå¡«å……æ“ä½œï¼Œæ–¹ä¾¿ä¸‹æ¬¡è°ƒç”¨æ—¶çš„æŸ¥æ‰¾ï¼›å¦‚æœæ˜¯æ¶ˆæ¯è½¬å‘ï¼Œåˆ™ä¸ä¼šç¼“å­˜åˆ°å½“å‰ç±»ä¸­ 3.å¦‚æœéå†ç»“æŸåä¾ç„¶æœªæ‰¾åˆ°IMPï¼Œåˆ™ä¼šå¯åŠ¨æ¶ˆæ¯çš„è§£ææˆ–è½¬å‘ã€‚ äº”ã€é—®é¢˜è®¨è®º5.1objc_msgSendä¸ºä»€ä¹ˆè¦ç”¨æ±‡ç¼–ç¼–å†™ï¼ŸAï¼šåŸå› å¤§è‡´æœ‰ä»¥ä¸‹å‡ ç‚¹ Cè¯­è¨€æ˜¯é™æ€è¯­è¨€ï¼Œæ— æ³•å®ç°å‚æ•°ä¸ªæ•°ã€ç±»å‹æœªçŸ¥çš„æƒ…å†µä¸‹è·³è½¬åˆ°å¦ä¸€ä¸ªä»»æ„çš„å‡½æ•°å®ç°çš„åŠŸèƒ½ï¼›è€Œæ±‡ç¼–çš„å¯„å­˜å™¨å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ æ±‡ç¼–æ‰§è¡Œæ•ˆç‡æ¯”Cè¯­è¨€çš„é«˜ ä½¿ç”¨æ±‡ç¼–å¯ä»¥æœ‰æ•ˆé˜²æ­¢ç³»ç»Ÿå‡½æ•°è¢«hookï¼Œå› æ­¤æ›´ä¸ºå®‰å…¨ã€‚ 5.2ä¸ºä»€ä¹ˆç´¢å¼•å€¼è¦å·¦ç§»1 + PTRSHIFTä½ï¼ŸAï¼šåœ¨objc4-756.2æºç ä¸­æ‰¾åˆ°ç­”æ¡ˆï¼Œä½†æ˜¯åœ¨objc4-779.1æºç ç‰ˆæœ¬çš„cache_tç»“æ„ä¸­ï¼Œå­˜åœ¨å…³äºè¿™ä¸ªé—®é¢˜çš„è§£é‡Šã€‚å…¶éƒ¨åˆ†æºç å¦‚ä¸‹ï¼š 12345678910111213// How much the mask is shifted by.static constexpr uintptr_t maskShift = 48; // Additional bits after the mask which must be zero. msgSend// takes advantage of these additional bits to construct the value// `mask &lt;&lt; 4` from `_maskAndBuckets` in a single instruction.static constexpr uintptr_t maskZeroBits = 4; // The largest mask value we can store.static constexpr uintptr_t maxMask = ((uintptr_t)1 &lt;&lt; (64 - maskShift)) - 1; // The mask applied to `_maskAndBuckets` to retrieve the buckets pointer.static constexpr uintptr_t bucketsMask = ((uintptr_t)1 &lt;&lt; (maskShift - maskZeroBits)) - 1; æ€»çš„æ¥è¯´ï¼Œåœ¨64ä½ä¸­ï¼Œmaskçš„åç§»å€¼ä¸º48ï¼Œä¹Ÿå°±æ˜¯æœ€é«˜çš„16ä½å­˜å‚¨maskï¼›æ¥ç€çš„44ä½æ˜¯bucketsæŒ‡é’ˆåœ°å€ï¼Œæœ€ä½çš„4ä½æ˜¯é™„åŠ ä½ï¼Œå³ bucketsçš„æœ‰æ•ˆæŒ‡é’ˆåœ°å€ä»…ä»…æ˜¯64ä½ä¸­çš„[4, 47]ä½ã€‚åœ¨CacheLookupæºç ä¸­ï¼Œç”±_cmd &amp; maskå“ˆå¸Œè¿ç®—å¯ä»¥å¾—åˆ°ç´¢å¼•å€¼ï¼ˆç´¢å¼•å€¼ &lt; ((1 &lt;&lt; 16) - 1)ï¼‰ï¼Œå¦‚æœæƒ³å¾—åˆ°è¿™ä¸ªä½ç½®çš„bucketï¼Œå…¶ç´¢å¼•å€¼å¿…é¡»å·¦ç§»4ä½åï¼Œæ‰èƒ½ä¸bucketsæŒ‡é’ˆåœ°å€ç›¸åŠ å¾—åˆ°æ­£ç¡®çš„bucketåœ°å€ã€‚ å‚è€ƒ Objective-C ä¸­çš„æ¶ˆæ¯ä¸æ¶ˆæ¯è½¬å‘ Objective-Cåº•å±‚æ±‡æ€» https://juejin.cn/post/6844904118973104135#heading-0 OCæºç åˆ†æä¹‹æ–¹æ³•çš„æŸ¥æ‰¾åŸç† æ¶ˆæ¯æŸ¥æ‰¾æµç¨‹ iOSæ¢ç´¢ æ–¹æ³•çš„æœ¬è´¨å’Œæ¶ˆæ¯æŸ¥æ‰¾æµç¨‹","link":"/2020/12/29/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/05-%20%E6%96%B9%E6%B3%95%E7%9A%84%E6%9C%AC%E8%B4%A8%E5%92%8C%E6%B6%88%E6%81%AF%E6%9F%A5%E6%89%BE%E6%B5%81%E7%A8%8B/"},{"title":"03-å¯¹è±¡&amp;ç±»çš„ç»“æ„","text":"ä¸€ã€å¯¹è±¡&amp;ç±»çš„ç»“æ„1.1 è§£è¯»ç±»çš„æœ¬è´¨ä»NSObjectç±»çš„å®šä¹‰å¼€å§‹ 123456789OBJC_AVAILABLE(10.0, 2.0, 9.0, 1.0, 2.0)OBJC_ROOT_CLASSOBJC_EXPORT@interface NSObject &lt;NSObject&gt; {#pragma clang diagnostic push#pragma clang diagnostic ignored &quot;-Wobjc-interface-ivars&quot; Class isa OBJC_ISA_AVAILABILITY;#pragma clang diagnostic pop} æ³¨æ„ï¼šNSObjectæœ‰ä¸ªClassç±»å‹çš„isaæˆå‘˜å˜é‡ æ¥ä¸‹æ¥ç”¨Clangç¼–è¯‘main.mï¼Œè¾“å‡º.cppæ–‡ä»¶ï¼Œçœ‹ä¸€ä¸‹NSObjectç±»çš„åº•å±‚å®šä¹‰ 1clang -x objective-c -rewrite-objc -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk main.m æ‰“å¼€main.cppæ–‡ä»¶ï¼Œæ‰¾åˆ°äº†NSObject 123456789#ifndef _REWRITER_typedef_NSObject#define _REWRITER_typedef_NSObjecttypedef struct objc_object NSObject;typedef struct {} _objc_exc_NSObject;#endifstruct NSObject_IMPL { Class isa;}; å‘ç°NSObjectç±»æœ¬è´¨ä¸Šæ˜¯objc_objectç»“æ„ä½“ï¼ŒåŒæ—¶æœ‰å®šä¹‰ä¸€ä¸ªNSObject_IMPLç»“æ„ä½“ï¼ˆIMPLæ˜¯implementationçš„ç¼©å†™ï¼‰ï¼Œé‡Œé¢æœ‰NSObjectç±»çš„isaæˆå‘˜å˜é‡ã€‚ ç°åœ¨æŠŠæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„Personç±»ç”¨clangç¼–è¯‘æˆc++çœ‹ä¸€ä¸‹ã€‚æˆ‘ä»¬å®šä¹‰çš„Personç±»ï¼š(æœ‰ä¸ªageå±æ€§å’Œrunæ–¹æ³•) 123456789101112131415@interface Person : NSObject@property (nonatomic) NSInteger age;- (void)run;@end@implementation Person- (void)run { NSLog(@&quot;I am running.&quot;);}@end ç¼–è¯‘æˆc++åï¼š 123456789101112131415161718#ifndef _REWRITER_typedef_Person#define _REWRITER_typedef_Persontypedef struct objc_object Person;typedef struct {} _objc_exc_Person;#endifextern &quot;C&quot; unsigned long OBJC_IVAR_$_Person$_age;struct Person_IMPL { struct NSObject_IMPL NSObject_IVARS; NSInteger _age;};static void _I_Person_run(Person * self, SEL _cmd) { NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_mc_9fhhprrj4k92vxzqm3g127z40000gn_T_main_09fc70_mi_0);}static NSInteger _I_Person_age(Person * self, SEL _cmd) { return (*(NSInteger *)((char *)self + OBJC_IVAR_$_Person$_age)); }static void _I_Person_setAge_(Person * self, SEL _cmd, NSInteger age) { (*(NSInteger *)((char *)self + OBJC_IVAR_$_Person$_age)) = age; } å¯è§ï¼ŒPersonç±»æœ¬è´¨åŒæ ·æ˜¯objc_objectç»“æ„ä½“ç±»å‹ï¼ŒPerson_IMPLç»“æ„ä½“å†…éƒ¨å¤šäº†ä¸ªstruct NSObject_IMPLç±»å‹çš„NSObject_IVARSæˆå‘˜å˜é‡â€”â€”å³ç»§æ‰¿è‡ªNSObjectçš„ç±»ï¼Œéƒ½æœ‰ä¸ªClassç±»å‹çš„isaæˆå‘˜å˜é‡ã€‚ 1.2 objc_objectç»“æ„æºç ï¼š 12345678910111213141516171819202122struct objc_object {private: isa_t isa; public: ... // ä¸€äº›å‡½æ•°};union isa_t { isa_t() { } isa_t(uintptr_t value) : bits(value) { } Class cls; uintptr_t bits;#if defined(ISA_BITFIELD) struct { ISA_BITFIELD; // defined in isa.h };#endif}; å…³äºisa_tçš„åˆ†æè§ä¸Šç¯‡æ–‡ç«  objc_objectç»“æ„ä½“å†…éƒ¨çš„æ–¹æ³•æœ‰äº”åä¸ªå·¦å³ï¼Œå¤§è‡´å¯åˆ†ä¸ºä»¥ä¸‹å‡ ç±» ä¸€äº›å…³äºisaçš„å‡½æ•°ï¼Œå¦‚initIsa()ã€getIsa()ã€changeIsa()ç­‰ ä¸€äº›å¼±å¼•ç”¨çš„å‡½æ•°ï¼Œå¦‚isWeaklyReferenced()ã€setWeaklyReferenced_nolock()ç­‰ ä¸€äº›å†…å­˜ç®¡ç†å‡½æ•°ï¼Œå¦‚retain()ã€release()ã€autorelease()ç­‰ ä¸¤ä¸ªå…³è”å¯¹è±¡å‡½æ•°ï¼Œåˆ†åˆ«æ˜¯hasAssociatedObjects()å’ŒsetHasAssociatedObjects 1.3 objc_classç»“æ„åŒæ ·å…ˆä¸Šæºç  1234567891011121314typedef struct objc_class *Class;typedef struct objc_object *id;struct objc_class : objc_object { // Class ISA; Class superclass; cache_t cache; // formerly cache pointer and vtable class_data_bits_t bits; // class_rw_t * plus custom rr/alloc flags class_rw_t *data() { return bits.data(); } ... // ä¸€äº›å‡½æ•°}; ä»æºç å¯ä»¥çœ‹å‡ºï¼ŒClassæ˜¯objc_classç»“æ„ä½“ç±»å‹çš„æŒ‡é’ˆå˜é‡ï¼Œç»§æ‰¿è‡ªobjc_objectç»“æ„ä½“ã€‚Classæœ‰4ä¸ªæˆå‘˜å˜é‡ï¼Œä¸”å®ƒä»¬åœ¨å†…å­˜å­˜å‚¨ä¸Šæ˜¯æœ‰åºçš„ï¼Œä¾æ¬¡åˆ†åˆ«æ˜¯ï¼š 1.isaï¼šç±»å‹æ˜¯isa_tï¼Œ64ä½ä¸‹é•¿åº¦ä¸º8å­—èŠ‚ï¼Œä¸Šç¯‡å·²åšè¿‡åˆ†æï¼Œè¿™é‡Œç•¥è¿‡ 2.superclassï¼šç±»å‹æ˜¯Classï¼Œè¡¨ç¤ºç»§æ‰¿å…³ç³»ï¼ŒæŒ‡å‘å½“å‰ç±»çš„çˆ¶ç±»ï¼ŒåŒæ ·8å­—èŠ‚ 3.cacheï¼šç±»å‹æ˜¯cache_tï¼Œè¡¨ç¤ºç¼“å­˜ï¼Œç”¨äºç¼“å­˜å·²è°ƒç”¨çš„æ–¹æ³•ï¼ŒåŠ é€Ÿæ–¹æ³•çš„è°ƒç”¨ã€‚å…¶å…·ä½“ç»“æ„å¦‚ä¸‹: 12345678910111213141516struct cache_t { struct bucket_t *_buckets; // 64ä½ä¸‹æ˜¯8å­—èŠ‚ mask_t _mask; // 64ä½ä¸‹æ˜¯4å­—èŠ‚ mask_t _occupied; // 64ä½ä¸‹æ˜¯4å­—èŠ‚public: ... // ä¸€äº›å‡½æ•°};#if __LP64__typedef uint32_t mask_t; // uint32_t 4å­—èŠ‚ // x86_64 &amp; arm64 asm are less efficient with 16-bits#elsetypedef uint16_t mask_t; // uint16_t 2å­—èŠ‚#endiftypedef unsigned int uint32_t; å¯è§ï¼Œcacheè¿™ä¸ªæˆå‘˜å˜é‡é•¿åº¦æ˜¯16å­—èŠ‚ã€‚ cacheæ¯”è¾ƒé‡è¦ï¼Œå…³äºå®ƒçš„åˆ†æå¯æˆ³ OCæºç åˆ†æä¹‹æ–¹æ³•çš„ç¼“å­˜åŸç†ã€‚ 4.bitsï¼šç±»å‹æ˜¯class_data_bits_tï¼Œç”¨äºå­˜å‚¨ç±»çš„æ•°æ®ï¼ˆç±»çš„æ–¹æ³•ã€å±æ€§ã€éµå¾ªçš„åè®®ç­‰ä¿¡æ¯ï¼‰ï¼Œå…¶ç»“æ„å¦‚ä¸‹ 12345678struct class_data_bits_t { // Values are the FAST_ flags above. uintptr_t bits; // unsigned longprivate: ... // ä¸€äº›å‡½æ•°}; å…¶é•¿åº¦ä¹Ÿæ˜¯8å­—èŠ‚ã€‚æ ¹æ®bitsæˆå‘˜å˜é‡åœ¨objc_objectç»“æ„ä½“ä¸­æ³¨é‡Šçš„æè¿°ï¼Œå®ƒå®è´¨ä¸Šæ˜¯class_rw_t *åŠ ä¸Šè‡ªå®šä¹‰rr/allocæ ‡å¿—ï¼Œæœ€é‡è¦çš„æ˜¯class_rw_tã€‚ æ¥ä¸‹æ¥å°†é‡ç‚¹ä»‹ç»å®ƒã€‚ äºŒã€class_rw_t &amp; class_ro_tåˆ†æ rwæ˜¯readwriteçš„æ„æ€ï¼Œè€Œroåˆ™æ˜¯readonlyã€‚ OCç±»ä¸­çš„å±æ€§ã€æ–¹æ³•è¿˜æœ‰éµå¾ªçš„åè®®ç­‰ä¿¡æ¯éƒ½ä¿å­˜åœ¨class_rw_tä¸­ï¼Œé¦–å…ˆçœ‹çœ‹class_rw_tçš„ç»“æ„ï¼š 12345678910111213141516171819202122232425262728struct class_rw_t { uint32_t flags; uint32_t version; const class_ro_t *ro; method_array_t methods; // æ–¹æ³•åˆ—è¡¨ property_array_t properties; // å±æ€§åˆ—è¡¨ protocol_array_t protocols; // åè®®åˆ—è¡¨ Class firstSubclass; Class nextSiblingClass; char *demangledName;#if SUPPORT_INDEXED_ISA uint32_t index;#endif ...// ä¸€äº›å‡½æ•°};#if __ARM_ARCH_7K__ &gt;= 2 || (__arm64__ &amp;&amp; !__LP64__)# define SUPPORT_INDEXED_ISA 1 // armv7k or arm64_32#else# define SUPPORT_INDEXED_ISA 0#endif å‘ç°class_rw_tä¸­è¿˜æœ‰ä¸€ä¸ªè¢«constä¿®é¥°çš„æŒ‡é’ˆå˜é‡ roï¼Œæ˜¯class_ro_tç»“æ„ä½“æŒ‡é’ˆï¼Œå…¶ä¸­å­˜å‚¨äº†å½“å‰ç±»åœ¨ç¼–è¯‘æœŸç¡®å®šçš„æ–¹æ³•ã€æˆå‘˜å˜é‡ã€å±æ€§ä»¥åŠéµå¾ªçš„åè®®ç­‰ä¿¡æ¯ã€‚ 1234567891011121314151617181920212223struct class_ro_t { uint32_t flags; uint32_t instanceStart; uint32_t instanceSize;#ifdef __LP64__ uint32_t reserved;#endif const uint8_t * ivarLayout; const char * name; method_list_t * baseMethodList; // æ–¹æ³•åˆ—è¡¨ protocol_list_t * baseProtocols; // åè®®åˆ—è¡¨ const ivar_list_t * ivars; // æˆå‘˜å˜é‡åˆ—è¡¨ const uint8_t * weakIvarLayout; property_list_t *baseProperties; // å±æ€§åˆ—è¡¨ // This field exists only when RO_HAS_SWIFT_INITIALIZER is set. _objc_swiftMetadataInitializer __ptrauth_objc_method_list_imp _swiftMetadataInitializer_NEVER_USE[0]; ... // ä¸€äº›å‡½æ•°}; 2.1 è·å–class_rw_tè¦æƒ³è·å–class_rw_tæŒ‡é’ˆåœ°å€ï¼Œéœ€è¦çŸ¥é“objc_classçš„bitsæŒ‡é’ˆåœ°å€ï¼Œé€šè¿‡å¯¹objc_classçš„ç»“æ„åˆ†æå¾—çŸ¥ï¼ŒbitsæŒ‡é’ˆåœ°å€æ˜¯objc_classé¦–åœ°å€åç§»32ä¸ªå­—èŠ‚ï¼ˆisa + superclass + cache = 8+8+16=32å­—èŠ‚ï¼‰ ä¹Ÿå¯ä»¥ä»æºç å¾—çŸ¥å¦‚ä½•æ‹¿åˆ°class_rw_tæŒ‡é’ˆ 12345678910111213// objc_classç»“æ„ä½“ä¸­class_rw_t *data() { return bits.data(); // bitsæ˜¯class_data_bits_tç±»å‹}// class_data_bits_tç»“æ„ä½“ä¸­...class_rw_t* data() { return (class_rw_t *)(bits &amp; FAST_DATA_MASK);}// 64ä½ä¸‹#define FAST_DATA_MASK 0x00007ffffffffff8UL åœ¨64ä½ä¸‹ï¼Œclass_rw_tæŒ‡é’ˆåœ°å€æ˜¯åœ¨[3, 46]æ•°æ®æ®µï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥ç”¨bits &amp; FAST_DATA_MASKè®¡ç®—å‡ºclass_rw_tæŒ‡é’ˆåœ°å€ã€‚ æ¥ç€é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥éªŒè¯class_rw_tå’Œclass_ro_tæ˜¯å¦å­˜å‚¨äº†ç±»çš„ä¿¡æ¯ 2.2 å‡†å¤‡å·¥ä½œç»™Personç±»æ·»åŠ å±æ€§ã€æ–¹æ³•å’Œåè®®ï¼Œä»£ç å¦‚ä¸‹ 123456789101112131415161718192021222324252627282930313233@protocol PersonProtocol &lt;NSObject&gt;- (void)walk;@end@interface Person : NSObject &lt;PersonProtocol&gt; { NSInteger _gender;}@property (nonatomic) NSString *name;@property (nonatomic) NSInteger age;+ (void)printMyClassName;- (void)run;@end@implementation Person+ (void)printMyClassName { NSLog(@&quot;my class name is Person&quot;);}- (void)run { NSLog(@&quot;I am running.&quot;);}- (void)walk { NSLog(@&quot;I am walking.&quot;);}@end ç„¶åæ‰“ä¸Šæ–­ç‚¹ å¥½äº†ï¼Œå‡†å¤‡å·¥ä½œå®Œæˆï¼Œä¸‹é¢å¼€å§‹éªŒè¯ 2.3 class_rw_téªŒè¯è¿‡ç¨‹1.æ‰“å°Personç±» 1234(lldb) x/5gx pcls0x100002820: 0x001d8001000027f9 0x0000000100b391400x100002830: 0x00000001003dc250 0x00000000000000000x100002840: 0x0000000102237404 è¯´æ˜ï¼š Personç±»é¦–åœ°å€æ˜¯0x100002820ï¼Œå› æ­¤ï¼Œ0x100002840æ˜¯å…¶bitsåœ°å€ï¼ˆ32å­—èŠ‚å°±æ˜¯0x20ï¼Œ0x100002840 = 0x100002820 + 0x20ï¼‰ï¼Œbitså†…å®¹æ˜¯0x0000000102237404 0x001d8001000027f9æ˜¯Personç±»çš„isaåœ°å€ï¼ŒæŒ‡å‘Personå…ƒç±» 0x0000000100b39140æ˜¯Personç±»çš„superclassåœ°å€ï¼Œä¹Ÿå°±æ˜¯NSObjectç±»é¦–åœ°å€ 0x00000001003dc250 0x0000000000000000åˆ™æ˜¯Personç±»çš„cacheæ®µ 2.æ‰“å°class_rw_t 12345678910111213141516171819202122232425262728293031323334353637// bits &amp; FAST_DATA_MASK(lldb) p (class_rw_t *)(0x0000000102237404 &amp; 0x00007ffffffffff8)(class_rw_t *) $1 = 0x0000000102237400(lldb) p *$1(class_rw_t) $2 = { flags = 2148139008 version = 0 ro = 0x0000000100002788 methods = { list_array_tt&lt;method_t, method_list_t&gt; = { = { list = 0x0000000100002608 arrayAndFlag = 4294977032 } } } properties = { list_array_tt&lt;property_t, property_list_t&gt; = { = { list = 0x0000000100002720 arrayAndFlag = 4294977312 } } } protocols = { list_array_tt&lt;unsigned long, protocol_list_t&gt; = { = { list = 0x00000001000025a8 arrayAndFlag = 4294976936 } } } firstSubclass = nil nextSiblingClass = NSUUID demangledName = 0x0000000000000000} è¿™é‡Œè¯·å¤§å®¶ç•™æ„ä¸€ä¸‹class_rw_tçš„å‡ ä¸ªå…³é”®æˆå‘˜å˜é‡ï¼š roåœ°å€æ˜¯0x0000000100002788 methodsçš„liståœ°å€æ˜¯0x0000000100002608 propertiesçš„liståœ°å€æ˜¯0x0000000100002720 protocolsçš„liståœ°å€æ˜¯0x0000000100002608 3.éªŒè¯methods ç›®å‰æ¥çœ‹ï¼ŒPersonç±»è‡³å°‘æœ‰6ä¸ªå®ä¾‹æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯runã€walkä»¥åŠnameå’Œageçš„getterã€setterï¼Œè¿˜æœ‰1ä¸ªç±»æ–¹æ³•ï¼Œå³printMyClassNameï¼Œæ€»è®¡7ä¸ªæ–¹æ³•ã€‚ 123456789101112131415(lldb) p (method_list_t *)0x0000000100002608 // rwçš„methodsçš„liståœ°å€(method_list_t *) $7 = 0x0000000100002608(lldb) p *$7(method_list_t) $8 = { entsize_list_tt&lt;method_t, method_list_t, 3&gt; = { entsizeAndFlags = 26 count = 7 first = { name = &quot;walk&quot; types = 0x0000000100001e96 &quot;v16@0:8&quot; imp = 0x0000000100001530 (CCTest`-[Person walk] at main.m:45) } }} æ­£å¥½æ˜¯7ä¸ªæ–¹æ³•ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹éƒ½æ˜¯å“ªäº›ï¼ˆç”±äºmethod_list_tç»§æ‰¿è‡ªentsize_list_ttï¼Œå¯ä»¥é€šè¿‡entsize_list_ttçš„get()å‡½æ•°ä¸€ä¸€æ‰“å°ï¼‰ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748(lldb) p $8.get(0)(method_t) $9 = { name = &quot;walk&quot; types = 0x0000000100001e96 &quot;v16@0:8&quot; imp = 0x0000000100001530 (CCTest`-[Person walk] at main.m:45)}(lldb) p $8.get(1)(method_t) $10 = { name = &quot;.cxx_destruct&quot; types = 0x0000000100001e96 &quot;v16@0:8&quot; imp = 0x0000000100001600 (CCTest`-[Person .cxx_destruct] at main.m:35)}(lldb) p $8.get(2)(method_t) $11 = { name = &quot;name&quot; types = 0x0000000100001eb1 &quot;@16@0:8&quot; imp = 0x0000000100001560 (CCTest`-[Person name] at main.m:27)}(lldb) p $8.get(3)(method_t) $12 = { name = &quot;setName:&quot; types = 0x0000000100001f4b &quot;v24@0:8@16&quot; imp = 0x0000000100001580 (CCTest`-[Person setName:] at main.m:27)}(lldb) p $8.get(4)(method_t) $13 = { name = &quot;age&quot; types = 0x0000000100001f56 &quot;q16@0:8&quot; imp = 0x00000001000015c0 (CCTest`-[Person age] at main.m:28)}(lldb) p $8.get(5)(method_t) $14 = { name = &quot;run&quot; types = 0x0000000100001e96 &quot;v16@0:8&quot; imp = 0x0000000100001500 (CCTest`-[Person run] at main.m:41)}(lldb) p $8.get(6)(method_t) $15 = { name = &quot;setAge:&quot; types = 0x0000000100001f5e &quot;v24@0:8q16&quot; imp = 0x00000001000015e0 (CCTest`-[Person setAge:] at main.m:28)} æ˜¾ç„¶ï¼Œclass_rw_tçš„methodsç¡®å®åŒ…å«äº†Personç±»çš„å…¨éƒ¨å®ä¾‹æ–¹æ³•ï¼Œåªæ˜¯å¤šäº†ä¸ª.cxx_destructæ–¹æ³•ã€‚.cxx_destructæ–¹æ³•åŸæœ¬æ˜¯ä¸ºäº†C++å¯¹è±¡ææ„çš„ï¼ŒARCå€Ÿç”¨äº†è¿™ä¸ªæ–¹æ³•æ’å…¥ä»£ç å®ç°äº†è‡ªåŠ¨å†…å­˜é‡Šæ”¾çš„å·¥ä½œï¼Œå…³äºå…¶åŸç†è¿™é‡Œç•¥è¿‡ä¸æã€‚ æ€è€ƒï¼šç±»æ–¹æ³•printMyClassNameå“ªé‡Œå»äº†ï¼Ÿ 4.éªŒè¯properties åŒç†ï¼ŒPersonç±»è‡³å°‘æœ‰nameå’Œageè¿™ä¸¤ä¸ªå±æ€§ï¼Œä¸”çœ‹ 1234567891011121314151617181920212223242526272829(lldb) p (property_list_t *)0x0000000100002720 // rwçš„propertiesçš„liståœ°å€(property_list_t *) $18 = 0x0000000100002720(lldb) p *$18(property_list_t) $19 = { entsize_list_tt&lt;property_t, property_list_t, 0&gt; = { entsizeAndFlags = 16 count = 6 first = (name = &quot;name&quot;, attributes = &quot;T@\\&quot;NSString\\&quot;,&amp;,N,V_name&quot;) }}(lldb) p $19.get(0)(property_t) $20 = (name = &quot;name&quot;, attributes = &quot;T@\\&quot;NSString\\&quot;,&amp;,N,V_name&quot;) (lldb) p $19.get(1)(property_t) $21 = (name = &quot;age&quot;, attributes = &quot;Tq,N,V_age&quot;) (lldb) p $19.get(2)(property_t) $22 = (name = &quot;hash&quot;, attributes = &quot;TQ,R&quot;) (lldb) p $19.get(3)(property_t) $23 = (name = &quot;superclass&quot;, attributes = &quot;T#,R&quot;) (lldb) p $19.get(4)(property_t) $24 = (name = &quot;description&quot;, attributes = &quot;T@\\&quot;NSString\\&quot;,R,C&quot;) (lldb) p $19.get(5)(property_t) $25 = (name = &quot;debugDescription&quot;, attributes = &quot;T@\\&quot;NSString\\&quot;,R,C&quot;) æ˜¾ç„¶nameå’Œageå­˜å‚¨åœ¨propertiesä¸­ã€‚ å¤šä½™çš„å±æ€§ä¹Ÿä¸ä½œèµ˜è¿°ã€‚ 5.éªŒè¯protocols åœ¨éªŒè¯ä¹‹å‰ï¼Œå…ˆåˆ†æä¸€ä¸‹protocol_list_tï¼Œè¿™ä¸ªç»“æ„ä½“å¹¶ä¸æ˜¯ç»§æ‰¿è‡ªentsize_list_ttçš„ï¼Œå…¶ç»“æ„å¦‚ä¸‹ 1234567struct protocol_list_t { // count is 64-bit by accident. uintptr_t count; protocol_ref_t list[0]; // variable-size ... // ä¸€äº›å‡½æ•°} æ³¨æ„åˆ°variable-sizeè¿™ä¸ªæ³¨é‡Šéƒ¨åˆ†ï¼ˆå¯å˜å¤§å°ï¼‰ï¼Œä»¿ä½›çœ‹åˆ°äº†å¸Œæœ› 123456789101112131415161718192021typedef uintptr_t protocol_ref_t; // protocol_t *, but unremappedstruct protocol_t : objc_object { const char *mangledName; struct protocol_list_t *protocols; method_list_t *instanceMethods; method_list_t *classMethods; method_list_t *optionalInstanceMethods; method_list_t *optionalClassMethods; property_list_t *instanceProperties; uint32_t size; // sizeof(protocol_t) uint32_t flags; // Fields below this point are not always present on disk. const char **_extendedMethodTypes; const char *_demangledName; property_list_t *_classProperties; const char *demangledName(); ... // ä¸€äº›å‡½æ•°}; protocol_ref_tè™½ç„¶æœªæ˜ å°„æˆprotocol_t *ï¼Œä¸è¿‡åº”è¯¥å¯ä»¥è€ƒè™‘ä¸€ä¸‹å¼ºè½¬ï¼Œå®éªŒä¸€ä¸‹å§ï¼ˆè¿™æ¬¡æ˜¯æ‰¾åˆ°PersonProtocolåè®®ï¼‰ 1234567891011121314151617181920212223242526272829303132333435363738394041(lldb) p (protocol_list_t *)0x00000001000025a8 // rwçš„protocolsçš„liståœ°å€(protocol_list_t *) $26 = 0x00000001000025a8 (lldb) p *$26(protocol_list_t) $27 = (count = 1, list = protocol_ref_t [] @ 0x00007fb5decb30f8)(lldb) p (protocol_t *)$26-&gt;list[0](protocol_t *) $32 = 0x00000001000028a8 (lldb) p *$32(protocol_t) $33 = { objc_object = { isa = { cls = Protocol bits = 4306735304 = { nonpointer = 0 has_assoc = 0 has_cxx_dtor = 0 shiftcls = 538341913 magic = 0 weakly_referenced = 0 deallocating = 0 has_sidetable_rc = 0 extra_rc = 0 } } } mangledName = 0x0000000100001d16 &quot;PersonProtocol&quot; // å‡ºç°äº†ï¼ï¼ï¼ protocols = 0x0000000100002568 instanceMethods = 0x0000000100002580 classMethods = 0x0000000000000000 optionalInstanceMethods = 0x0000000000000000 optionalClassMethods = 0x0000000000000000 instanceProperties = 0x0000000000000000 size = 96 flags = 0 _extendedMethodTypes = 0x00000001000025a0 _demangledName = 0x0000000000000000 _classProperties = 0x0000000000000000} åŠŸå¤«ä¸è´Ÿæœ‰å¿ƒäººï¼Œæœ€ç»ˆéªŒè¯äº†class_rw_tçš„protocolsä¸­å«æœ‰Personç±»æ‰€éµå¾ªçš„PersonProtocolåè®®ã€‚ åˆ°äº†è¿™é‡Œï¼Œ**class_rw_tç¡®å®å­˜å‚¨äº†ç±»çš„å®ä¾‹æ–¹æ³•ã€å±æ€§å’Œéµå¾ªçš„åè®®äº†ã€‚** 2.4 class_ro_téªŒè¯è¿‡ç¨‹ç°åœ¨å°±å‰©ä¸‹roäº† 1.æ‰“å°class_ro_t 123456789101112131415161718(lldb) p $1-&gt;ro(const class_ro_t *) $38 = 0x0000000100002788 (lldb) p *$38(const class_ro_t) $39 = { flags = 388 instanceStart = 8 instanceSize = 32 reserved = 0 ivarLayout = 0x0000000100001d2e &quot;\\x11&quot; name = 0x0000000100001d0f &quot;Person&quot; baseMethodList = 0x0000000100002608 baseProtocols = 0x00000001000025a8 ivars = 0x00000001000026b8 weakIvarLayout = 0x0000000000000000 baseProperties = 0x0000000100002720 _swiftMetadataInitializer_NEVER_USE = {}} æœ‰æ²¡æœ‰å‘ç°ä»€ä¹ˆï¼**class_ro_tçš„æ–¹æ³•ã€å±æ€§å’Œåè®®çš„åœ°å€éƒ½ä¸class_rw_tçš„ä¸€è‡´ï¼Œæ—¢ç„¶æŒ‡å‘çš„æ˜¯åŒä¸€å—å†…å­˜ç©ºé—´ï¼Œæ˜¾ç„¶class_ro_tä¹Ÿå­˜å‚¨äº†Personç±»çš„å®ä¾‹æ–¹æ³•ã€å±æ€§å’Œåè®®**ã€‚ ä¸class_rw_tä¸åŒçš„æ˜¯ï¼Œclass_ro_tå¤šäº†ä¸€ä¸ªivarsåˆ—è¡¨ï¼Œé‡Œé¢å­˜æ”¾çš„åº”è¯¥æ˜¯Personç±»çš„æˆå‘˜å˜é‡ã€‚ 2.éªŒè¯ivars Personç±»çš„æˆå‘˜å˜é‡æœ‰ï¼š_genderã€_nameå’Œ_age æ‰€å¹¸ivar_list_tæ˜¯ç»§æ‰¿è‡ªentsize_list_ttçš„ï¼Œget()å‡½æ•°åˆå¯ä»¥ç”¨äº†ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940(lldb) p $39.ivars(const ivar_list_t *const) $40 = 0x00000001000026b8(lldb) p *$40(const ivar_list_t) $41 = { entsize_list_tt&lt;ivar_t, ivar_list_t, 0&gt; = { entsizeAndFlags = 32 count = 3 first = { offset = 0x00000001000027e0 name = 0x0000000100001e83 &quot;_gender&quot; type = 0x0000000100001f69 &quot;q&quot; alignment_raw = 3 size = 8 } }}(lldb) p $41.get(0)(ivar_t) $42 = { offset = 0x00000001000027e0 name = 0x0000000100001e83 &quot;_gender&quot; type = 0x0000000100001f69 &quot;q&quot; alignment_raw = 3 size = 8}(lldb) p $41.get(1)(ivar_t) $43 = { offset = 0x00000001000027e8 name = 0x0000000100001e8b &quot;_name&quot; type = 0x0000000100001f6b &quot;@\\&quot;NSString\\&quot;&quot; alignment_raw = 3 size = 8}(lldb) p $41.get(2)(ivar_t) $44 = { offset = 0x00000001000027f0 name = 0x0000000100001e91 &quot;_age&quot; type = 0x0000000100001f69 &quot;q&quot; alignment_raw = 3 size = 8} å®Œå…¨ç¬¦åˆé¢„æœŸï¼Œclass_ro_tç¡®å®å­˜å‚¨äº†Personç±»çš„æˆå‘˜å˜é‡ã€‚ 2.5 rwå’Œroçš„è”ç³»ä¸ºä»€ä¹ˆclass_rw_tã€class_ro_tçš„æ–¹æ³•ã€å±æ€§å’Œåè®®çš„åœ°å€ä¸€è‡´ï¼Ÿ åœ¨class_data_bits_tç»“æ„ä½“ä¸­çš„safe_ro()å‡½æ•°ä¸­å‘ç°äº†ç«¯å€ª 12345678910const class_ro_t *safe_ro() { class_rw_t *maybe_rw = data(); if (maybe_rw-&gt;flags &amp; RW_REALIZED) { // maybe_rw is rw return maybe_rw-&gt;ro; } else { // maybe_rw is actually ro return (class_ro_t *)maybe_rw; }} å¯è§ï¼Œrwä¸ä¸€å®šæ˜¯rwï¼Œä¹Ÿå¯èƒ½æ˜¯roã€‚ å®é™…ä¸Šï¼Œåœ¨ç¼–è¯‘æœŸé—´ï¼Œç±»çš„class_data_bits_t *bitsæŒ‡é’ˆæŒ‡å‘çš„æ˜¯class_ro_t *ï¼Œç„¶ååœ¨OCè¿è¡Œæ—¶è°ƒç”¨äº†realizeClassWithoutSwift()ï¼ˆè‹¹æœå¼€æºçš„objc4-756.2æºç æ˜¯realizeClassWithoutSwift()ï¼Œåœ¨æ­¤ä¹‹å‰çš„ç‰ˆæœ¬æ˜¯realizeClass()æ–¹æ³•ï¼‰ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦åšçš„å°±æ˜¯åˆ©ç”¨ç¼–è¯‘æœŸç¡®å®šçš„roæ¥åˆå§‹åŒ–rwï¼š 12345678910111213141516171819ro = (const class_ro_t *)cls-&gt;data();if (ro-&gt;flags &amp; RO_FUTURE) { // This was a future class. rw data is already allocated. rw = cls-&gt;data(); ro = cls-&gt;data()-&gt;ro; cls-&gt;changeInfo(RW_REALIZED|RW_REALIZING, RW_FUTURE);} else { // ä¸€èˆ¬èµ°è¿™é‡Œ // Normal class. Allocate writeable class data. rw = (class_rw_t *)calloc(sizeof(class_rw_t), 1); // ç»™rwç”³è¯·å†…å­˜ rw-&gt;ro = ro; // è®¾ç½®rwçš„ro rw-&gt;flags = RW_REALIZED|RW_REALIZING; // è®¾ç½®flags cls-&gt;setData(rw); // ç»™clsè®¾ç½®æ­£ç¡®çš„rw}... // åˆå§‹åŒ– rw çš„å…¶ä»–å­—æ®µï¼Œæ›´æ–°superclassã€meta class// Attach categoriesmethodizeClass(cls); åœ¨ä»£ç çš„æœ€åï¼Œè¿˜è°ƒç”¨äº†methodizeClass()ï¼Œå…¶æºç å¦‚ä¸‹ 1234567891011121314151617181920212223242526272829303132333435363738static void methodizeClass(Class cls){ runtimeLock.assertLocked(); bool isMeta = cls-&gt;isMetaClass(); auto rw = cls-&gt;data(); auto ro = rw-&gt;ro; ... // æ‰“å°ä¿¡æ¯ // Install methods and properties that the class implements itself. method_list_t *list = ro-&gt;baseMethods(); if (list) { prepareMethodLists(cls, &amp;list, 1, YES, isBundleClass(cls)); rw-&gt;methods.attachLists(&amp;list, 1); } property_list_t *proplist = ro-&gt;baseProperties; if (proplist) { rw-&gt;properties.attachLists(&amp;proplist, 1); } protocol_list_t *protolist = ro-&gt;baseProtocols; if (protolist) { rw-&gt;protocols.attachLists(&amp;protolist, 1); } if (cls-&gt;isRootMetaclass()) { addMethod(cls, SEL_initialize, (IMP)&amp;objc_noop_imp, &quot;&quot;, NO); } category_list *cats = unattachedCategoriesForClass(cls, true /*realizing*/); attachCategories(cls, cats, false /*don't flush caches*/); ... // æ‰“å°ä¿¡æ¯ if (cats) free(cats); ... // æ‰“å°ä¿¡æ¯} åœ¨è¿™ä¸ªæ–¹æ³•é‡Œï¼Œå°†ç±»è‡ªå·±å®ç°çš„æ–¹æ³•ï¼ˆåŒ…æ‹¬åˆ†ç±»ï¼‰ã€å±æ€§å’Œéµå¾ªçš„åè®®åŠ è½½åˆ° methodsã€properties å’Œ protocols åˆ—è¡¨ä¸­ã€‚ è¿™å°±å®Œç¾è§£é‡Šäº†ä¸ºä»€ä¹ˆè¿è¡Œæ—¶rwå’Œroçš„æ–¹æ³•ã€å±æ€§å’Œåè®®ç›¸åŒã€‚ 2.6 rwå’Œroåœ¨è¿è¡Œæ—¶çš„ä¸åŒä¹‹å¤„ç›®å‰ä¸ºæ­¢çš„éªŒè¯éƒ½æ˜¯åŸºäºPersonç±»çš„ç°æœ‰ç»“æ„ï¼Œä¹Ÿå°±æ˜¯åœ¨ç¼–è¯‘æœŸå°±ç¡®å®šçš„ï¼Œä½“ç°ä¸å‡ºclass_rw_tå’Œclass_ro_tçš„å·®å¼‚æ€§ã€‚æ¥ä¸‹æ¥ç”¨runtimeçš„apiåœ¨è¿è¡Œæ—¶ä¸ºPersonåŠ¨æ€æ·»åŠ ä¸€ä¸ªfly()æ–¹æ³•ï¼Œå†æ¥ä¸€è¯•ã€‚ 1.æ·»åŠ æ–¹æ³• å…·ä½“ä»£ç å¦‚ä¸‹ï¼š 12345void fly(id obj, SEL sel) { NSLog(@&quot;I am flying&quot;);}class_addMethod([Person class], NSSelectorFromString(@&quot;fly&quot;), (IMP)fly, &quot;v@:&quot;); å†åŠ ä¸€ä¸ªæ‰“å°æ–¹æ³•ï¼Œç”¨äºæ‰“å°ç±»çš„methods 123456789101112void printMethods(Class cls) { if (cls == nil) { return ; } CCNSLog(@&quot;------------ print %@ methods ------------&quot;, NSStringFromClass(cls)); uint32_t count; Method *methods = class_copyMethodList(cls, &amp;count); for (uint32_t i = 0; i &lt; count; i++) { Method method = methods[i]; CCNSLog(@&quot;åå­—ï¼š%@ -- ç±»å‹ï¼š%s&quot;, NSStringFromSelector(method_getName(method)), method_getTypeEncoding(method)); }} è¿è¡Œä¸€ä¸‹çœ‹æ•ˆæœï¼Œå‘ç°æ·»åŠ æˆåŠŸï¼Œå¦‚å›¾ 2.éªŒè¯è¿‡ç¨‹ å…ˆæ‰“å°class_rw_tï¼Œå³ è¿˜æœ‰class_ro_t å¯¹æ¯”åå‘ç°ï¼Œä¸¤è€…çš„å±æ€§ã€åè®®æŒ‡é’ˆåœ°å€æœªå‘ç”Ÿå˜åŒ–ï¼Œä½†æ˜¯æ–¹æ³•çš„æŒ‡é’ˆåœ°å€ä¸ä¸€æ ·äº†ã€‚ ç”±äºclass_rw_tæ˜¯è¿è¡Œæ—¶æ‰åˆå§‹åŒ–çš„ï¼Œè€Œclass_ro_tåœ¨ç¼–è¯‘æœŸé—´å°±ç¡®å®šäº†ï¼Œå› æ­¤å¯ä»¥çŒœæµ‹æ–°å¢çš„flyæ–¹æ³•å­˜å‚¨åœ¨class_rw_tçš„methodsæŒ‡é’ˆä¸Šï¼Œclass_ro_tçš„baseMethodListæŒ‡é’ˆä»ç¼–è¯‘æœŸä¹‹åå°±æœªå‘ç”Ÿæ”¹å˜ã€‚ ä¸‹é¢ç»§ç»­éªŒè¯ï¼Œé¦–å…ˆçœ‹class_ro_tçš„æ–¹æ³•åˆ—è¡¨ OKï¼Œç¼–è¯‘æœŸå°±ç¡®å®šçš„æ–¹æ³•éƒ½åœ¨ï¼Œå¹¶ä¸”æ²¡æœ‰flyæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´class_ro_tçš„æ–¹æ³•åˆ—è¡¨åœ¨è¿è¡Œæ—¶åŸºæœ¬æ²¡å˜ã€‚ class_ro_tçš„å±æ€§åˆ—è¡¨ã€æˆå‘˜å˜é‡åˆ—è¡¨ã€åè®®åœ¨è¿è¡Œæ—¶éƒ½æ²¡æœ‰å‘ç”Ÿæ”¹å˜ã€‚æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±å°è¯•éªŒè¯ä¸€ä¸‹ã€‚ æ¥ç€çœ‹class_rw_tçš„æ–¹æ³•åˆ—è¡¨ class_rw_tçš„methodsé‡Œé¢æ•°æ®å±…ç„¶éƒ½æ²¡æœ‰äº†ï¼Ÿ æ²¡åŠæ³•ï¼Œè¿™é‡Œæš‚æ—¶ç•™ä¸ªå‘å§ï¼Œæš‚æ—¶ä¸çŸ¥é“åŸå› ã€‚ ä¸‰ã€æ€»ç»“3.1 ç±»çš„ç»“æ„æ€»ç»“å…³äºç±»çš„ç»“æ„ï¼Œæˆ‘ä»¬äº†è§£åˆ°ï¼š ç±»æœ¬è´¨ä¸Šæ˜¯objc_objectç»“æ„ä½“ï¼Œä¹Ÿå°±æ˜¯ç±»ä¹Ÿæ˜¯å¯¹è±¡ï¼Œå³ä¸‡ç‰©æ˜¯å¯¹è±¡ã€‚ ç±»éƒ½åŒ…å«ä¸€ä¸ªisa_tç±»å‹çš„æˆå‘˜å˜é‡isa Classæ˜¯objc_classç»“æ„ä½“ç±»å‹çš„æŒ‡é’ˆå˜é‡ï¼Œå†…éƒ¨æœ‰4ä¸ªæˆå‘˜å˜é‡ï¼Œå³ isaï¼šç±»å‹æ˜¯isa_t superclassï¼šç±»å‹æ˜¯Classï¼Œè¡¨ç¤ºç»§æ‰¿å…³ç³»ï¼ŒæŒ‡å‘ç±»çš„çˆ¶ç±» cacheï¼šç±»å‹æ˜¯cache_tï¼Œè¡¨ç¤ºç¼“å­˜ï¼Œç”¨äºç¼“å­˜æŒ‡é’ˆå’Œ vtableï¼ŒåŠ é€Ÿæ–¹æ³•çš„è°ƒç”¨ bitsï¼šç±»å‹æ˜¯class_data_bits_tï¼Œç”¨äºå­˜å‚¨ç±»çš„æ•°æ®ï¼ˆç±»çš„æ–¹æ³•ã€å±æ€§ã€éµå¾ªçš„åè®®ç­‰ä¿¡æ¯ï¼‰ï¼Œå…¶é•¿åº¦åœ¨64ä½CPUä¸‹ä¸º8å­—èŠ‚ï¼Œæ˜¯ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘class_rw_t * 3.2 class_rw_tå’Œclass_ro_tæ€»ç»“ class_ro_tå­˜å‚¨äº†ç±»åœ¨ç¼–è¯‘æœŸç¡®å®šçš„æ–¹æ³•ï¼ˆåŒ…æ‹¬å…¶åˆ†ç±»çš„ï¼‰ã€æˆå‘˜å˜é‡ã€å±æ€§ä»¥åŠéµå¾ªçš„åè®®ç­‰ä¿¡æ¯ï¼Œåœ¨è¿è¡Œæ—¶ä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚ç¼–è¯‘æœŸï¼Œç±»çš„bitsæŒ‡é’ˆæŒ‡å‘çš„æ˜¯class_ro_tæŒ‡é’ˆï¼ˆå³æ­¤æ—¶class_rw_t å®é™…ä¸Šæ˜¯class_ro_t ï¼‰ã€‚ å®ä¾‹æ–¹æ³•å­˜å‚¨åœ¨ç±»ä¸­ ç±»æ–¹æ³•å­˜å‚¨åœ¨å…ƒç±»ä¸­ åœ¨realizeClassWithoutSwift()æ‰§è¡Œä¹‹åï¼Œclass_rw_tæ‰ä¼šè¢«åˆå§‹åŒ–ï¼ŒåŒæ—¶å­˜å‚¨ç±»çš„æ–¹æ³•ã€å±æ€§ä»¥åŠéµå¾ªçš„åè®®ï¼Œå®é™…ä¸Šï¼Œclass_rw_tå’Œclass_ro_tä¸¤è€…çš„æ–¹æ³•åˆ—è¡¨ï¼ˆæˆ–å±æ€§åˆ—è¡¨ã€åè®®åˆ—è¡¨ï¼‰çš„æŒ‡é’ˆæ˜¯ç›¸åŒçš„ã€‚ è¿è¡Œæ—¶å‘ç±»åŠ¨æ€æ·»åŠ å±æ€§ã€æ–¹æ³•æ—¶ï¼Œä¼šä¿®æ”¹class_rw_tçš„å±æ€§åˆ—è¡¨ã€æ–¹æ³•åˆ—è¡¨æŒ‡é’ˆï¼Œä½†class_ro_tå¯¹åº”çš„å±æ€§åˆ—è¡¨ã€æ–¹æ³•åˆ—è¡¨ä¸ä¼šå˜ã€‚ ä¸€ä¸ªå¾…è§£å†³çš„å‘ï¼šé€šè¿‡è¿è¡Œæ—¶æ·»åŠ æ–¹æ³•ï¼ˆæˆ–å±æ€§ã€åè®®ï¼‰æ”¹å˜äº† class_rw_t å¯¹åº”çš„æ–¹æ³•åˆ—è¡¨ï¼ˆæˆ–å±æ€§åˆ—è¡¨ã€åè®®åˆ—è¡¨ï¼‰çš„æŒ‡é’ˆåï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆå±…ç„¶åœ¨ class_rw_t çš„æ–¹æ³•åˆ—è¡¨ï¼ˆæˆ–å±æ€§åˆ—è¡¨ã€åè®®åˆ—è¡¨ï¼‰ä¸Šæ‰¾ä¸åˆ°æ–°å¢çš„æ–¹æ³•ï¼ˆæˆ–å±æ€§ã€åè®®ï¼‰äº†ã€‚ 3.3 ç±»æ–¹æ³•çš„å­˜å‚¨ä½ç½®ï¼ˆPersonç±»çš„ç±»æ–¹æ³•printMyClassName()ï¼‰ 12345678910111213141516171819202122232425262728293031323334353637383940414243// 1. è·å– Personå…ƒç±»(lldb) x/4gx pcls0x100002820: 0x001d8001000027f9 0x0000000100b391400x100002830: 0x00000001003dc250 0x0000000000000000(lldb) p/x 0x001d8001000027f9 &amp; 0x00007ffffffffff8(long) $50 = 0x00000001000027f8(lldb) po 0x00000001000027f8Person // Personå…ƒç±»// 2. è·å– Personå…ƒç±» çš„ bits(lldb) x/5gx 0x00000001000027f80x1000027f8: 0x001d800100b390f1 0x0000000100b390f00x100002808: 0x0000000102237440 0x00000001000000030x100002818: 0x00000001022373a0 // Personå…ƒç±» çš„ bits// 3. è·å– Personå…ƒç±» çš„ class_rw_t(lldb) p (class_rw_t *)(0x00000001022373a0 &amp; 0x00007ffffffffff8)(class_rw_t *) $52 = 0x00000001022373a0// 4. éªŒè¯ Personå…ƒç±» çš„ methods(lldb) p $52-&gt;methods(method_array_t) $55 = { list_array_tt&lt;method_t, method_list_t&gt; = { = { list = 0x0000000100002270 arrayAndFlag = 4294976112 } }}(lldb) p (method_list_t *)0x0000000100002270(method_list_t *) $56 = 0x0000000100002270(lldb) p *$56(method_list_t) $57 = { entsize_list_tt&lt;method_t, method_list_t, 3&gt; = { entsizeAndFlags = 26 count = 1 first = { name = &quot;printMyClassName&quot; // æˆåŠŸæ‰¾åˆ° Personç±»çš„ç±»æ–¹æ³• types = 0x0000000100001e96 &quot;v16@0:8&quot; imp = 0x00000001000014d0 (CCTest`+[Person printMyClassName] at main.m:37) } }} ç»“è®ºï¼šç±»æ–¹æ³• å­˜å‚¨ åœ¨ç±»çš„å…ƒç±»ä¸Šï¼Œä¸”ä½äºå…ƒç±»çš„class_ro_tçš„baseMethodListæŒ‡é’ˆä¸Šï¼ˆæˆ–åœ¨class_rw_tçš„methodsæŒ‡é’ˆä¸Šï¼‰","link":"/2020/11/18/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/03-%E5%AF%B9%E8%B1%A1&%E7%B1%BB%E7%9A%84%E7%BB%93%E6%9E%84/"},{"title":"08-ç±»çš„åŠ è½½è¿‡ç¨‹","text":"å‰è¨€ï¼šdyldåŠ è½½æµç¨‹ï¼ˆç²¾ç®€ï¼‰ç”±äºdyldæµç¨‹åŠ è½½æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„è¿‡ç¨‹ï¼Œè¿™é‡Œæˆ‘ä»¬åªåšç®€å•çš„åˆ†æã€‚ ä¸‹é¢æ˜¯mainå‡½æ•°ä¹‹å‰è°ƒç”¨å †æ ˆçš„ä¿¡æ¯ï¼š é€šè¿‡ä¸Šé¢çš„å †æ ˆä¿¡æ¯æˆ‘ä»¬å¯ä»¥ç®€å•åˆ†æå‡ºæ¥ä¸€ä¸ªæµç¨‹ _dyld_startå‡½æ•°ï¼Œæ˜¯æ•´ä¸ªåŠ è½½çš„å…¥å£ã€‚ ç»è¿‡dyldbooststrap::start-&gt;dyld::start-&gt;ImageLoad::-&gt;ImageLoadMackO::è¿™äº›æµç¨‹æŠŠMachOé‡Œé¢çš„ä¿¡æ¯è¯»å–åˆ°ã€‚ libSystem_initializerï¼Œåˆå§‹åŒ–ç³»ç»Ÿåº“ã€‚ libdispatch_initï¼Œåˆå§‹åŒ–libdispatchåº“ã€‚ _os_object_init-&gt;::_objc_initï¼Œåˆå§‹åŒ–objcåº“ã€‚ dyldä¸»è¦çš„æ­¥éª¤éƒ½åœ¨è¯»å–MachOæ®µé‡Œé¢çš„æ•°æ® æ¥ä¸‹æ¥ä½¿ç”¨objc4-756.2æºç è¿›è¡Œåˆ†æ ä¸€ã€_objc_initæµç¨‹123456789101112131415void _objc_init(void){ static bool initialized = false; if (initialized) return; initialized = true; // fixme defer initialization until an objc-using image is found? environ_init(); tls_init(); static_init(); lock_init(); exception_init(); _dyld_objc_notify_register(&amp;map_images, load_images, unmap_image);} 1.1 environ_init å‡½æ•°åˆå§‹åŒ–ç¯å¢ƒå˜é‡ã€‚è¿™é‡Œæˆ‘ä»¬çš„é‡ç‚¹ä¸æ˜¯çœ‹æºç ï¼Œä¸»è¦çœ‹ä¸‹é¢ï¼š æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ç»ˆç«¯è¿›è¡Œï¼šexport OBJC_HELP=1ç„¶åï¼š lsï¼ŒæŸ¥çœ‹ç›¸å…³çš„ç¯å¢ƒå˜é‡ï¼Œç•™æ„ä¸‹é¢ä¸¤ä¸ªå˜é‡ï¼š â€¦çœç•¥ä¸­é—´çš„éƒ¨åˆ†â€¦ æˆ‘ä»¬å¯ä»¥åœ¨Xcodeä¸­è°ƒæ•´è¿™ä¸¤ä¸ªç¯å¢ƒå˜é‡ç©ä¸€ä¸‹ï¼š 1.1.1 ä¿®æ”¹ç¯å¢ƒå˜é‡OBJC_PRINT_LOAD_METHODä¸ºYESå ä¿®æ”¹è¯¥ç¯å¢ƒå˜é‡ä¹‹åè§‚å¯Ÿæ§åˆ¶å°æ‰“å°è¾“å‡ºçš„ç»“æœ ç³»ç»Ÿçš„loadæ–¹æ³•ä¼šå…¨éƒ¨æ‰“å°å‡ºæ¥ã€‚ è‡ªå·±å®šä¹‰çš„loadæ–¹æ³•ä¹Ÿä¼šæ‰“å°å‡ºæ¥ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä»è¿™é‡Œå…¥æ‰‹ï¼Œåœ¨åšå¯åŠ¨ä¼˜åŒ–çš„æ—¶å€™å¯ä»¥å¿«é€Ÿå®šä½è°ƒæ•´è¿™äº›loadæ–¹æ³•ã€‚ 1.1.2 ä¿®æ”¹OBJC_PRINT_NONPOINTER_ISAä¸ºYESå ä¿®æ”¹è¯¥ç¯å¢ƒå˜é‡ä¹‹åè§‚å¯Ÿæ§åˆ¶å°æ‰“å°è¾“å‡ºçš„ç»“æœ ä¼˜åŒ–è¿‡çš„isaæŒ‡é’ˆåˆ™éœ€è¦&amp;ä¸ŠISA_MASKæ‰èƒ½çš„åˆ°ç±»çš„å†…å­˜åœ°å€ã€‚ å…³é—­nonpointerä¹‹åï¼ŒisaæŒ‡é’ˆå°±ä¸åšå†…å­˜ä¼˜åŒ–äº†ï¼Œæ‰€ä»¥ç±»çš„å†…å­˜åœ°å€å’Œisaçš„å†…å­˜åœ°å€å°±ç›¸åŒäº†ã€‚ è¿™é‡Œä¹ŸéªŒè¯äº†02-isaåŸç†ä¸­isaçš„åˆå§‹åŒ–çš„æ—¶å€™ï¼Œç›´æ¥å°†ç±»èµ‹å€¼isaçš„clsæˆå‘˜ã€‚ 1.2 tls_init å‡½æ•°tls_init()æ–¹æ³•æ˜¯å…³äºçº¿ç¨‹keyçš„ç»‘å®š 123456789void tls_init(void){#if SUPPORT_DIRECT_THREAD_KEYS _objc_pthread_key = TLS_DIRECT_KEY; pthread_key_init_np(TLS_DIRECT_KEY, &amp;_objc_pthread_destroyspecific);#else _objc_pthread_key = tls_create(&amp;_objc_pthread_destroyspecific);#endif} 1.3 static_init å‡½æ•°static_init()æ–¹æ³•æ³¨é‡Šä¸­æåˆ°ï¼šè¯¥æ–¹æ³•ä¼šè¿è¡ŒC++é™æ€æ„é€ å‡½æ•°ï¼ˆåªä¼šè¿è¡Œç³»ç»Ÿçº§åˆ«çš„æ„é€ å‡½æ•°ï¼‰ï¼Œåœ¨dyldè°ƒç”¨é™æ€æ„é€ å‡½æ•°ä¹‹å‰libcä¼šè°ƒç”¨_objc_initï¼Œæ‰€ä»¥å¿…é¡»è‡ªå·±å»å®ç° 1234567891011121314/************************************************************************ static_init* Run C++ static constructor functions.* libc calls _objc_init() before dyld would call our static constructors, * so we have to do it ourselves.**********************************************************************/static void static_init(){ size_t count; auto inits = getLibobjcInitializers(&amp;_mh_dylib_header, &amp;count); for (size_t i = 0; i &lt; count; i++) { inits[i](); }} 1.4 lock_init å‡½æ•°lock_init()æ–¹æ³•æ˜¯ä¸ªç©ºå‡½æ•°ï¼ŒOCçš„é”æœºåˆ¶å®Œå…¨é‡‡ç”¨Cã€C++é‚£ä¸€å¥— 123void lock_init(void){} 1.5 exception_init å‡½æ•°exception_init()åˆå§‹åŒ–libobjcçš„å¼‚å¸¸å¤„ç†ç³»ç»Ÿï¼Œæ³¨å†Œå¼‚å¸¸å¤„ç†çš„å›è°ƒï¼Œä»è€Œç›‘æ§å¼‚å¸¸çš„å¤„ç† 1234void exception_init(void){ old_terminate = std::set_terminate(&amp;_objc_terminate);} è°ƒç”¨åªå£°æ˜ä¸å®ç°ä¸ä½œä»»ä½•å¤„ç†çš„æ–¹æ³•ï¼Œå°±ä¼šæŠ¥é”™ï¼Œæ¥åˆ°_objc_terminate 1.6 _dyld_objc_notify_register å‡½æ•° é€šè¿‡ä¸‰ä¸ªå‡½æ•°æŒ‡é’ˆç›´æ¥å‘èµ·å›è°ƒã€‚è¿™é‡Œåˆ†æ_dyld_objc_notify_mappedè¿™ä¸ªå‡½æ•°ï¼Œåœ¨dyldé‡Œé¢é€šè¿‡æ³¨å†Œå‡½æ•°çš„å†…å­˜åœ°å€ï¼Œç„¶åé€šè¿‡å‡½æ•°æŒ‡é’ˆåˆå›è°ƒåˆ°äº†map_imagesè¿™ä¸ªå‡½æ•°ã€‚ è®°å½•ä¿å­˜æ³¨å†Œå‡½æ•°çš„å†…å­˜åœ°å€ã€‚ é€šè¿‡å‡½æ•°æŒ‡é’ˆçš„å½¢å¼å›è°ƒè¿™ä¸ªå‡½æ•°å³map_images,ä¸‹é¢è¿›å…¥åˆ°map_imagesåˆ†æã€‚ äºŒã€map_images å‡½æ•°å½“é•œåƒåŠ è½½åˆ°å†…å­˜æ—¶ä¼šè§¦å‘map_image 1234567891011121314/************************************************************************ map_images* Process the given images which are being mapped in by dyld.* Calls ABI-agnostic code after taking ABI-specific locks.** Locking: write-locks runtimeLock**********************************************************************/voidmap_images(unsigned count, const char * const paths[], const struct mach_header * const mhdrs[]){ mutex_locker_t lock(runtimeLock); return map_images_nolock(count, paths, mhdrs);} map_images_nolockå‡½æ•°ï¼š map_imageè°ƒç”¨map_images_nolockï¼Œç”±äºä»£ç æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬å»æ‰ä¸€äº›æ— å…³ç´§è¦çš„ä»£ç ï¼Œæ¯”å¦‚æ‰“å°æ—¥å¿—ä¿¡æ¯ã€ä»£ç çš„æ³¨é‡Šã€iOSç³»ç»Ÿç”¨åˆ°çš„ï¼Œç²¾ç®€ä¹‹åå¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465void map_images_nolock(unsigned mhCount, const char * const mhPaths[], const struct mach_header * const mhdrs[]){ static bool firstTime = YES; header_info *hList[mhCount]; uint32_t hCount; size_t selrefCount = 0; if (firstTime) { preopt_init(); } // Find all images with Objective-C metadata. hCount = 0; // Count classes. Size various table based on the total. int totalClasses = 0; int unoptimizedTotalClasses = 0; { uint32_t i = mhCount; while (i--) { const headerType *mhdr = (const headerType *)mhdrs[i]; auto hi = addHeader(mhdr, mhPaths[i], totalClasses, unoptimizedTotalClasses); if (!hi) { // no objc data in this entry continue; } if (mhdr-&gt;filetype == MH_EXECUTE) { // Size some data structures based on main executable is size#if __OBJC2__ size_t count; _getObjc2SelectorRefs(hi, &amp;count); selrefCount += count; _getObjc2MessageRefs(hi, &amp;count); selrefCount += count;#else _getObjcSelectorRefs(hi, &amp;selrefCount);#endif } hList[hCount++] = hi; } } // Perform one-time runtime initialization that must be deferred until // the executable itself is found. This needs to be done before // further initialization. // (The executable may not be present in this infoList if the // executable does not contain Objective-C code but Objective-C // is dynamically loaded later. if (firstTime) { sel_init(selrefCount); arr_init(); } if (hCount &gt; 0) { _read_images(hList, hCount, totalClasses, unoptimizedTotalClasses); } firstTime = NO;} ç°åœ¨å¼€å§‹åˆ†æç²¾ç®€ä¹‹åçš„ä»£ç  firstTimeä¸€ä¸ªç”¨staticä¿®é¥°çš„å±€éƒ¨æˆå‘˜å˜é‡ï¼Œè®°å½•ç¬¬ä¸€æ¬¡éœ€è¦åšçš„äº‹ã€‚ _getObjc2SelectorRefså‡½æ•°ï¼Œä»mach_oè¯»å–__objc_selrefsæ®µçš„ä¿¡æ¯ã€‚ _getObjc2MessageRefså‡½æ•°ï¼Œä»mach_oè¯»å–__objc_msgrefsæ®µçš„ä¿¡æ¯ã€‚ ç¬¬ä¸€æ¬¡éœ€è¦æ‰§è¡Œçš„å‡½æ•°preopt_init()ã€sel_init()ã€arr_init()ã€‚ _read_images()å‡½æ•°ï¼Œè¯»å–é•œåƒæ–‡ä»¶ã€‚ 2.1 preopt_init()æ³¨é‡Šæè¿°è¿™é‡Œä¼šå»¶è¿Ÿåˆå§‹åŒ–ï¼Œä¸»è¦æ˜¯å…±äº«ç¼“å­˜æœ‰äº†ä¹‹åçš„å¤„ç†ã€‚ 2.2 sel_init() å»æ‰å…¶ä»–ä¿¡æ¯ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ˜¯æ³¨å†Œäº†ä¸€äº›ç³»ç»Ÿæä¾›çš„APIã€‚ 2.3 arr_init() è¿™ä¸€å—ä¹Ÿæ˜¯æ¯”è¾ƒé‡è¦çš„ä¿¡æ¯ï¼Œè®©æˆ‘ä»¬çŸ¥é“äº†AutorereleasePoolPageå’ŒSideTableçš„åˆå§‹åŒ–åœ¨è¿™é‡Œæ˜¯æœ‰æ‰§è¡Œçš„ã€‚ 2.4 _read_images()å‰é¢çš„ä¸‰ä¸ªå‡½æ•°ä¸æ˜¯æˆ‘ä»¬ç›®å‰æ¢ç´¢çš„é‡ç‚¹ï¼Œåªæ˜¯ç®€å•çš„åˆ†æäº†ä¸€ä¸‹ã€‚ä¸‹é¢æˆ‘ä»¬å¼€å§‹æ·±å…¥_read_images()ï¼Œè¯·çœ‹æ¥ä¸‹æ¥çš„ç±»åŠ è½½éƒ¨åˆ†ã€‚ ä¸‰ã€ç±»åŠ è½½å…¥å£ï¼š_read_images() å‡½æ•°è¯»å–é•œåƒæ–‡ä»¶ã€‚ç”±äºè¿™ä¸ªå‡½æ•°çš„ä»£ç æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬æŠŠå…¶ä¸­çš„ä»£ç å…ˆç”¨ä¼ªä»£ç çš„ä¿¡æ¯å±•ç¤ºå‡ºæ¥ï¼Œç„¶åå†æ¥è®²è§£æ¯ä¸€æ­¥ã€‚ 1234567891011121314151617181920212223242526272829303132333435void _read_images(header_info **hList, uint32_t hCount, int totalClasses, int unoptimizedTotalClasses){ 1. å®šä¹‰å±€éƒ¨å˜é‡ï¼Œå¤„ç†ç¬¬ä¸€æ¬¡è¦åšçš„äº‹æƒ…ã€‚ if (!doneOnce){ ... } 2. ç±»çš„é‡æ˜ å°„ for (EACH_HEADER) { ... } 3. ä¿®å¤é‡æ˜ å°„ if (!noClassesRemapped()) { ... } 4. æ·»åŠ SELåˆ°namedSelectorsè¡¨ { ... } 5. ä¿®å¤æ—§çš„å‡½æ•°æŒ‡é’ˆè°ƒç”¨é—ç•™ for (EACH_HEADER) { ... } 6. æ·»åŠ Protocolåˆ°åè®®è¡¨ for (EACH_HEADER) { ... } 7. ä¿®å¤åè®®åˆ—è¡¨å¼•ç”¨ for (EACH_HEADER) { ... } 8. å®ç°éæ‡’åŠ è½½çš„ç±» for (EACH_HEADER) { ... } 9. Realize newly-resolved future classes if (resolvedFutureClasses) { ... } 10. å‘ç°å’Œå¤„ç†æ‰€æœ‰Category for (EACH_HEADER) { ... } 11. +load handled by prepare_load_methods() if (DebugNonFragileIvars) { ... }} é‡è¦çš„æœ‰ç¬¬1æ­¥ã€ç¬¬2æ­¥ã€ç¬¬11æ­¥ã€‚ 3.1 ç¬¬ä¸€æ¬¡è¦åšçš„äº‹æƒ… - doneOnceã€é‡è¦ã€‘å»æ‰æ‰“å°éƒ¨åˆ†çš„ä»£ç ã€ä¸iOSæ“ä½œç³»ç»Ÿä¸ç›¸å¹²çš„ä»£ç ã€‚ 123456789101112131415161718192021222324252627282930313233343536if (!doneOnce) { doneOnce = YES;#if SUPPORT_NONPOINTER_ISA# if SUPPORT_INDEXED_ISA# endif# if TARGET_OS_OSX# endif#endif if (DisableTaggedPointers) { disableTaggedPointers(); } initializeTaggedPointerObfuscator(); if (PrintConnecting) { _objc_inform(&quot;CLASS: found %d classes during launch&quot;, totalClasses); } // namedClasses // Preoptimized classes do not go in this table. // 4/3 is NXMapTable is load factor int namedClassesSize = (isPreoptimized() ? unoptimizedTotalClasses : totalClasses) * 4 / 3; gdb_objc_realized_classes = NXCreateMapTable(NXStrValueMapPrototype, namedClassesSize); allocatedClasses = NXCreateHashTable(NXPtrPrototype, 0, nil); ts.log(&quot;IMAGE TIMES: first time tasks&quot;); } disableTaggedPointers()å‡½æ•°ï¼Œæ¡ä»¶å…è®¸çš„æ—¶å€™ï¼Œç¦ç”¨taggedPointersã€‚ initializeTaggedPointerObfuscatorå‡½æ•°ï¼Œåˆå§‹åŒ–taggedPointerã€‚ gdb_objc_realized_classesé€šè¿‡NXæŠ€æœ¯åˆ›å»ºçš„mapTableï¼Œè¿™å¼ è¡¨é‡Œé¢åŒ…å«çš„æ‰€æœ‰ç±»çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºæ€»è¡¨ã€‚ allocatedClassesé€šè¿‡NXæŠ€æœ¯åˆ›å»ºçš„HashTableï¼Œè¿™å¼ è¡¨åªåŒ…å«å·²ç»å¼€è¾Ÿçš„ç±»çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºå·²å¼€è¾Ÿç±»çš„è¡¨ã€‚ 3.2 å¯¹æ‰€æœ‰ç±»åšé‡æ˜ å°„ã€é‡è¦ã€‘ä»åˆ—è¡¨ä¸­å–å‡ºæ‰€æœ‰ç±»ï¼Œéå†è¿›è¡Œå¤„ç† 123456789101112131415161718192021222324252627282930313233for (EACH_HEADER) { // ä»ç¼–è¯‘åçš„ç±»åˆ—è¡¨ä¸­å–å‡ºæ‰€æœ‰ç±»ï¼Œè·å–åˆ°çš„æ˜¯ä¸€ä¸ªclassref_tç±»å‹çš„æŒ‡é’ˆ classref_t *classlist = _getObjc2ClassList(hi, &amp;count); if (! mustReadClasses(hi)) { // Image is sufficiently optimized that we need not call readClass() continue; } bool headerIsBundle = hi-&gt;isBundle(); bool headerIsPreoptimized = hi-&gt;isPreoptimized(); for (i = 0; i &lt; count; i++) { // æ•°ç»„ä¸­ä¼šå–å‡ºOS_dispatch_queue_concurrentã€OS_xpc_objectã€NSRunloopç­‰ç³»ç»Ÿç±»ï¼Œä¾‹å¦‚CFã€Fundationã€libdispatchä¸­çš„ç±»ã€‚ä»¥åŠè‡ªå·±åˆ›å»ºçš„ç±» Class cls = (Class)classlist[i]; // é€šè¿‡readClasså‡½æ•°è·å–å¤„ç†åçš„æ–°ç±»ï¼Œ Class newCls = readClass(cls, headerIsBundle, headerIsPreoptimized); // åˆå§‹åŒ–æ‰€æœ‰æ‡’åŠ è½½çš„ç±»éœ€è¦çš„å†…å­˜ç©ºé—´ - ç°åœ¨æ•°æ®æ²¡æœ‰åŠ è½½åˆ°çš„ - è¿ç±»éƒ½æ²¡æœ‰åˆå§‹åŒ–çš„ if (newCls != cls &amp;&amp; newCls) { // Class was moved but not deleted. Currently this occurs // only when the new class resolved a future class. // Non-lazily realize the class below. // å°†æ‡’åŠ è½½çš„ç±»æ·»åŠ åˆ°æ•°ç»„ä¸­ resolvedFutureClasses = (Class *) realloc(resolvedFutureClasses, (resolvedFutureClassCount+1) * sizeof(Class)); resolvedFutureClasses[resolvedFutureClassCount++] = newCls; } }} readClassæ–¹æ³•ä¼šè¿”å›Classï¼Œè·Ÿè¿›å»çœ‹çœ‹å…·ä½“å®ç° å½“å‰ç±»çš„çˆ¶ç±»ä¸­è‹¥æœ‰ä¸¢å¤±çš„weak-linkedç±»ï¼Œåˆ™è¿”å›nil æ­£å¸¸æƒ…å†µä¸‹ä¸ä¼šèµ°è¿›popFutureNamedClassåˆ¤æ–­ï¼Œè¿™æ˜¯ä¸“é—¨é’ˆå¯¹æœªæ¥çš„å¾…å¤„ç†çš„ç±»çš„ç‰¹æ®Šæ“ä½œï¼Œå› æ­¤ä¹Ÿä¸ä¼šå¯¹roã€rwè¿›è¡Œæ“ä½œï¼ˆå¯æ‰“æ–­ç‚¹è°ƒè¯•ï¼Œåˆ›å»ºç±»å’Œç³»ç»Ÿç±»éƒ½ä¸ä¼šè¿›å…¥ï¼‰ åœ¨è°ƒç”¨addNamedClassï¼ŒaddClassTableEntryæ–¹æ³•åè¿”å›cls å°†å½“å‰ç±»æ·»åŠ åˆ°å·²åˆ›å»ºå¥½çš„gdb_objc_realized_classeså“ˆå¸Œè¡¨ï¼ˆæ€»è¡¨ï¼‰ 12345678910111213141516171819static void addNamedClass(Class cls, const char *name, Class replacing = nil){ runtimeLock.assertLocked(); Class old; if ((old = getClassExceptSomeSwift(name)) &amp;&amp; old != replacing) { inform_duplicate(name, old, cls); // getMaybeUnrealizedNonMetaClass uses name lookups. // Classes not found by name lookup must be in the // secondary meta-&gt;nonmeta table. addNonMetaClass(cls); } else { NXMapInsert(gdb_objc_realized_classes, name, cls); } assert(!(cls-&gt;data()-&gt;flags &amp; RO_META)); // wrong: constructed classes are already realized when they get here // assert(!cls-&gt;isRealized());} å½“å‰ç±»å·²ç»åˆå§‹åŒ–ï¼Œæ‰€ä»¥è¦æ·»åŠ åˆ°allocatedClasseså“ˆå¸Œè¡¨(å·²å¼€è¾Ÿç±»çš„è¡¨) 123456789101112static void addClassTableEntry(Class cls, bool addMeta = true) { runtimeLock.assertLocked(); // This class is allowed to be a known class via the shared cache or via // data segments, but it is not allowed to be in the dynamic table already. assert(!NXHashMember(allocatedClasses, cls)); if (!isKnownClass(cls)) NXHashInsert(allocatedClasses, cls); if (addMeta) addClassTableEntry(cls-&gt;ISA(), false);} 3.3 ä¿®å¤é‡æ˜ å°„å°†æœªæ˜ å°„Classå’ŒSuper Classé‡æ˜ å°„ï¼Œè°ƒç”¨_getObjc2ClassRefsè·å–ç±»çš„å¼•ç”¨ï¼Œè°ƒç”¨_getObjc2SuperRefsè·å–çˆ¶ç±»çš„å¼•ç”¨ï¼Œé€šè¿‡remapClassRefè¿›è¡Œé‡æ˜ å°„ 123456789101112131415// å°†æœªæ˜ å°„Classå’ŒSuper Classé‡æ˜ å°„ï¼Œè¢«remapçš„ç±»éƒ½æ˜¯éæ‡’åŠ è½½çš„ç±»if (!noClassesRemapped()) { for (EACH_HEADER) { // é‡æ˜ å°„Classï¼Œæ³¨æ„æ˜¯ä»_getObjc2ClassRefså‡½æ•°ä¸­å–å‡ºç±»çš„å¼•ç”¨ Class *classrefs = _getObjc2ClassRefs(hi, &amp;count); for (i = 0; i &lt; count; i++) { remapClassRef(&amp;classrefs[i]); } // fixme why doesn't test future1 catch the absence of this? classrefs = _getObjc2SuperRefs(hi, &amp;count); for (i = 0; i &lt; count; i++) { remapClassRef(&amp;classrefs[i]); } }} 3.4 æ·»åŠ SELåˆ°namedSelectorsè¡¨é€šè¿‡_getObjc2SelectorRefsæ‹¿åˆ°MachOä¸­çš„é™æ€æ®µ__objc_selrefsï¼Œéå†åˆ—è¡¨è°ƒç”¨sel_registerNameNoLockå°†SELæ·»åŠ åˆ°namedSelectorså“ˆå¸Œè¡¨ 123456789101112131415161718// å°†æ‰€æœ‰SELéƒ½æ³¨å†Œåˆ°å“ˆå¸Œè¡¨ä¸­ï¼Œæ˜¯å¦å¤–ä¸€å¼ å“ˆå¸Œè¡¨// Fix up @selector referencesstatic size_t UnfixedSelectors;{ mutex_locker_t lock(selLock); for (EACH_HEADER) { if (hi-&gt;isPreoptimized()) continue; bool isBundle = hi-&gt;isBundle(); SEL *sels = _getObjc2SelectorRefs(hi, &amp;count); UnfixedSelectors += count; for (i = 0; i &lt; count; i++) { const char *name = sel_cname(sels[i]); // æ³¨å†ŒSELçš„æ“ä½œ sels[i] = sel_registerNameNoLock(name, isBundle); } }} 3.5 ä¿®å¤æ—§çš„å‡½æ•°æŒ‡é’ˆè°ƒç”¨é—ç•™é€šè¿‡_getObjc2MessageRefsè·å–åˆ°é™æ€æ®µ__objc_selrefsï¼ŒfixupMessageReféå†å°†å‡½æ•°æŒ‡é’ˆè¿›è¡Œæ³¨å†Œï¼Œå¹¶fixä¸ºæ–°çš„å‡½æ•°æŒ‡é’ˆ 123456789101112131415// Fix up old objc_msgSend_fixup call sites// ä¿®å¤æ—§çš„å‡½æ•°æŒ‡é’ˆè°ƒç”¨é—ç•™for (EACH_HEADER) { message_ref_t *refs = _getObjc2MessageRefs(hi, &amp;count); if (count == 0) continue; if (PrintVtables) { _objc_inform(&quot;VTABLES: repairing %zu unsupported vtable dispatch &quot; &quot;call sites in %s&quot;, count, hi-&gt;fname()); } for (i = 0; i &lt; count; i++) { // å†…éƒ¨å°†å¸¸ç”¨çš„allocã€objc_msgSendç­‰å‡½æ•°æŒ‡é’ˆè¿›è¡Œæ³¨å†Œï¼Œå¹¶fixä¸ºæ–°çš„å‡½æ•°æŒ‡é’ˆ fixupMessageRef(refs+i); }} 3.6 å°†æ‰€æœ‰Protocoléƒ½æ·»åŠ åˆ°protocol_mapè¡¨ä¸­è°ƒç”¨_getObjc2ProtocolListè·å–åˆ°__objc_protoliståè®®åˆ—è¡¨ï¼ŒreadProtocoléå†æ·»åŠ Protocolåˆ°protocol_mapå“ˆå¸Œè¡¨ 12345678910111213141516171819// Discover protocols. Fix up protocol refs.// éå†æ‰€æœ‰åè®®åˆ—è¡¨ï¼Œå¹¶ä¸”å°†åè®®åˆ—è¡¨åŠ è½½åˆ°Protocolçš„å“ˆå¸Œè¡¨ä¸­for (EACH_HEADER) { extern objc_class OBJC_CLASS_$_Protocol; // cls = Protocolç±»ï¼Œæ‰€æœ‰åè®®å’Œå¯¹è±¡çš„ç»“æ„ä½“éƒ½ç±»ä¼¼ï¼Œisaéƒ½å¯¹åº”Protocolç±» Class cls = (Class)&amp;OBJC_CLASS_$_Protocol; assert(cls); // è·å–protocolå“ˆå¸Œè¡¨ NXMapTable *protocol_map = protocols(); bool isPreoptimized = hi-&gt;isPreoptimized(); bool isBundle = hi-&gt;isBundle(); // ä»ç¼–è¯‘å™¨ä¸­è¯»å–å¹¶åˆå§‹åŒ–Protocol protocol_t **protolist = _getObjc2ProtocolList(hi, &amp;count); for (i = 0; i &lt; count; i++) { readProtocol(protolist[i], cls, protocol_map, isPreoptimized, isBundle); }} 3.7 å¯¹æ‰€æœ‰Protocolåšé‡æ˜ å°„é€šè¿‡_getObjc2ProtocolRefsè·å–åˆ°__objc_protorefsï¼ˆä¸__objc_protolistä¸æ˜¯åŒä¸€ä¸ªä¸œè¥¿ï¼‰éå†remapProtocolRefä¿®å¤åè®®ï¼ŒremapProtocolRefæ¯”è¾ƒå½“å‰åè®®å’Œåè®®åˆ—è¡¨ä¸­åŒä¸€å†…å­˜åœ°å€çš„åè®®æ˜¯å¦ç›¸åŒï¼Œå¦‚æœä¸åŒåˆ™æ›¿æ¢ 1234567891011// Fix up @protocol references// Preoptimized images may have the right // answer already but we don't know for sure.// ä¿®å¤åè®®åˆ—è¡¨å¼•ç”¨ï¼Œä¼˜åŒ–åçš„imageså¯èƒ½æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯å¹¶ä¸ç¡®å®šfor (EACH_HEADER) { // éœ€è¦æ³¨æ„åˆ°æ˜¯ï¼Œä¸‹é¢çš„å‡½æ•°æ˜¯_getObjc2ProtocolRefsï¼Œå’Œä¸Šé¢çš„_getObjc2ProtocolListä¸ä¸€æ · protocol_t **protolist = _getObjc2ProtocolRefs(hi, &amp;count); for (i = 0; i &lt; count; i++) { remapProtocolRef(&amp;protolist[i]); }} 3.8 åˆå§‹åŒ–æ‰€æœ‰éæ‡’åŠ è½½çš„ç±»ï¼Œè¿›è¡Œrwã€roç­‰æ“ä½œã€é‡è¦ã€‘è‹¹æœå®˜æ–¹å¯¹äºéæ‡’åŠ è½½ç±»çš„å®šä¹‰æ˜¯ï¼šå®ç°äº†+loadæ–¹æ³•çš„ç±»æ˜¯éæ‡’åŠ è½½ç±»ï¼Œå¦åˆ™å°±æ˜¯æ‡’åŠ è½½ç±» ä¸‹é¢æ˜¯éæ‡’åŠ è½½ç±»çš„åŠ è½½æµç¨‹: _getObjc2NonlazyClassListè·å–åˆ°__objc_nlclslistï¼Œå–å‡ºéæ‡’åŠ è½½ç±» addClassTableEntryå†åŠ è½½ä¸€éâ€”â€”å¦‚æœå·²æ·»åŠ å°±ä¸ä¼šæ·»åŠ è¿›å»ï¼Œç¡®ä¿æ•´ä¸ªç»“æ„éƒ½è¢«æ·»åŠ  realizeClassWithoutSwiftæ˜¯æ¥ä¸‹æ¥è¦å…³æ³¨çš„åœ°æ–¹ 123456789101112131415161718192021222324252627282930313233343536373839404142// Realize non-lazy classes (for +load methods and static instances)// å®ç°éæ‡’åŠ è½½çš„ç±»ï¼Œå¯¹äºloadæ–¹æ³•å’Œé™æ€å®ä¾‹å˜é‡for (EACH_HEADER) { classref_t *classlist = _getObjc2NonlazyClassList(hi, &amp;count); for (i = 0; i &lt; count; i++) { Class cls = remapClass(classlist[i]); // printf(&quot;non-lazy Class:%s\\n&quot;,cls-&gt;mangledName()); if (!cls) continue; // hack for class __ARCLite__, which didn't get this above#if TARGET_OS_SIMULATOR if (cls-&gt;cache._buckets == (void*)&amp;_objc_empty_cache &amp;&amp; (cls-&gt;cache._mask || cls-&gt;cache._occupied)) { cls-&gt;cache._mask = 0; cls-&gt;cache._occupied = 0; } if (cls-&gt;ISA()-&gt;cache._buckets == (void*)&amp;_objc_empty_cache &amp;&amp; (cls-&gt;ISA()-&gt;cache._mask || cls-&gt;ISA()-&gt;cache._occupied)) { cls-&gt;ISA()-&gt;cache._mask = 0; cls-&gt;ISA()-&gt;cache._occupied = 0; }#endif addClassTableEntry(cls); if (cls-&gt;isSwiftStable()) { if (cls-&gt;swiftMetadataInitializer()) { _objc_fatal(&quot;Swift class %s with a metadata initializer &quot; &quot;is not allowed to be non-lazy&quot;, cls-&gt;nameForLogging()); } // fixme also disallow relocatable classes // We can't disallow all Swift classes because of // classes like Swift.__EmptyArrayStorage } // å®ç°æ‰€æœ‰éæ‡’åŠ è½½çš„ç±»(å®ä¾‹åŒ–ç±»å¯¹è±¡çš„ä¸€äº›ä¿¡æ¯ï¼Œä¾‹å¦‚rw) realizeClassWithoutSwift(cls); }} realizeClassWithoutSwiftåˆ†æï¼š â‘ rwåˆå§‹åŒ–å¹¶å°†roæ‹·è´ä¸€ä»½åˆ°rwä¸­çš„ro rwè¡¨ç¤ºreadWriteï¼Œç”±äºåŠ¨æ€æ€§ï¼Œå¯èƒ½ä¼šå¾€ç±»ä¸­æ·»åŠ å±æ€§ã€æ–¹æ³•ã€æ·»åŠ åè®® roè¡¨ç¤ºreadOnlyï¼Œåœ¨ç¼–è¯‘æ—¶å·²ç»ç¡®å®šäº†å†…å­˜ 12345678910111213ro = (const class_ro_t *)cls-&gt;data();if (ro-&gt;flags &amp; RO_FUTURE) { // This was a future class. rw data is already allocated. rw = cls-&gt;data(); ro = cls-&gt;data()-&gt;ro; cls-&gt;changeInfo(RW_REALIZED|RW_REALIZING, RW_FUTURE);} else { // Normal class. Allocate writeable class data. rw = (class_rw_t *)calloc(sizeof(class_rw_t), 1); rw-&gt;ro = ro; rw-&gt;flags = RW_REALIZED|RW_REALIZING; cls-&gt;setData(rw);} â‘¡é€’å½’è°ƒç”¨realizeClassWithoutSwiftå®Œå–„ç»§æ‰¿é“¾å¹¶å¤„ç†å½“å‰ç±»çš„çˆ¶ç±»ã€å…ƒç±»ï¼›å¦‚æœæœ‰çˆ¶ç±»ï¼Œå°±é€šè¿‡addSubclassæŠŠå½“å‰ç±»æ”¾åˆ°çˆ¶ç±»çš„å­ç±»åˆ—è¡¨ä¸­å» 123456789101112131415if (!cls) return nil;...supercls = realizeClassWithoutSwift(remapClass(cls-&gt;superclass));metacls = realizeClassWithoutSwift(remapClass(cls-&gt;ISA()));...// Update superclass and metaclass in case of remappingcls-&gt;superclass = supercls;cls-&gt;initClassIsa(metacls);...// Connect this class to its superclass's subclass listsif (supercls) { addSubclass(supercls, cls);} else { addRootClass(cls);} supercls = realizeClassWithoutSwift(remapClass(cls-&gt;superclass));é€’å½’çˆ¶ç±»çš„ä¿¡æ¯åˆå§‹åŒ–ï¼Œå‡ºå£æ˜¯çˆ¶ç±»ä¸ºnilã€‚ metacls = realizeClassWithoutSwift(remapClass(cls-&gt;ISA()));é€’å½’å…ƒç±»çš„ä¿¡æ¯åˆå§‹åŒ–ï¼Œå‡ºå£æ˜¯å…ƒç±»çš„å…ƒç±»ä¸ºè‡ªå·±ã€‚ if (supercls) {addSubclass(supercls, cls);} else { addRootClass(cls);}ï¼Œå¤„ç†class_data_bits_tæˆå‘˜åŒå‘ç»‘å®šçˆ¶ç±»ï¼Œå­ç±»ã€‚ â‘¢remapClassä¸­å¯¹ç±»åœ¨è¡¨ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¦‚æœè¡¨ä¸­å·²æœ‰è¯¥ç±»ï¼Œåˆ™è¿”å›ä¸€ä¸ªç©ºå€¼ï¼›å¦‚æœæ²¡æœ‰åˆ™è¿”å›å½“å‰ç±»ï¼Œè¿™æ ·ä¿è¯äº†ç±»åªåŠ è½½ä¸€æ¬¡å¹¶ç»“æŸé€’å½’ 123456789101112131415static Class remapClass(Class cls){ runtimeLock.assertLocked(); Class c2; if (!cls) return nil; NXMapTable *map = remappedClasses(NO); if (!map || NXMapMember(map, cls, (void**)&amp;c2) == NX_MAPNOTAKEY) { return cls; } else { return c2; }} â‘£æœ€åè°ƒç”¨äº†methodizeClass 123// Attach categoriesmethodizeClass(cls);return cls; â‘¤åœ¨methodizeClassä¸­ï¼Œä»roä¸­è¯»å–æ–¹æ³•åˆ—è¡¨ï¼ˆåŒ…æ‹¬åˆ†ç±»ä¸­çš„æ–¹æ³•ï¼‰ã€å±æ€§åˆ—è¡¨ã€åè®®åˆ—è¡¨å†™åˆ°rwä¸­ï¼ŒåŒæ—¶ä¹Ÿä¼šåŠ è½½åˆ†ç±»çš„ä¿¡æ¯åˆ°ç±»é‡Œé¢ã€‚ 1234567891011121314151617181920212223242526272829...// Install methods and properties that the class implements itself.method_list_t *list = ro-&gt;baseMethods();if (list) { prepareMethodLists(cls, &amp;list, 1, YES, isBundleClass(cls)); rw-&gt;methods.attachLists(&amp;list, 1);}property_list_t *proplist = ro-&gt;baseProperties;if (proplist) { rw-&gt;properties.attachLists(&amp;proplist, 1);}protocol_list_t *protolist = ro-&gt;baseProtocols;if (protolist) { rw-&gt;protocols.attachLists(&amp;protolist, 1);}// Root classes get bonus method implementations if they don't have // them already. These apply before category replacements.if (cls-&gt;isRootMetaclass()) { // root metaclass addMethod(cls, SEL_initialize, (IMP)&amp;objc_noop_imp, &quot;&quot;, NO);}// Attach categories.category_list *cats = unattachedCategoriesForClass(cls, true /*realizing*/);attachCategories(cls, cats, false /*don't flush caches*/);... ä¸ºä»€ä¹ˆè¦åŒºåˆ†roå’Œrwï¼Ÿ roçš„ç‰¹æ€§å°±æ˜¯åœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šäº†ã€‚æˆ‘ä»¬ä¸å¸Œæœ›è¿™äº›åŸå§‹æ•°æ®è¢«æ±¡æŸ“ï¼Œæ‰€ä»¥æŠŠè¿™äº›æ•°æ®å­˜åˆ°roä¸­ rwçš„ç‰¹æ€§æ˜¯å¯å˜çš„ã€‚å› ä¸ºruntimeçš„å­˜åœ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šåŠ¨æ€çš„æ·»åŠ å±æ€§ã€æ–¹æ³•ã€åè®®ç­‰ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠè¿™äº›æ•°æ®å­˜åˆ°å¯æ›´æ”¹çš„rwå½“ä¸­ å‰é¢å·²ç»æåˆ°äº†å®ç°+loadæ–¹æ³•çš„ç±»å°±æ˜¯éæ‡’åŠ è½½ç±»ï¼Œé‚£ä¹ˆæ²¡æœ‰å®ç°çš„ç±»å°±æ˜¯æ‡’åŠ è½½ç±»ã€‚ æ‰“å°éæ‡’åŠ è½½ç±»ï¼š å¯ä»¥é€šè¿‡printf(&quot;non-lazy Class:%s\\n&quot;,cls-&gt;mangledName())å»æ‰“å°è·å–åˆ°æ‰€æœ‰éæ‡’åŠ è½½ç±»ã€åªæœ‰å®ç°äº†+loadçš„ç±»æ‰ä¼šèµ°åˆ°è¿™é‡Œç„¶åè¢«æ‰“å°ï¼ˆFXPersonå†…éƒ¨å®ç°äº†+loadï¼Œå…¶ä»–éƒ½æ˜¯ç³»ç»Ÿå†…ç½®çš„ç±»ï¼‰ã€‘ é‚£ä¹ˆæ‡’åŠ è½½ç±»æ˜¯ä½•æ—¶åŠ åˆ°å†…å­˜ä¸­çš„å‘¢ï¼Ÿéœ€è¦çœ‹ä¸‹æ–‡åˆ†æã€‚ 3.9 å¤„ç†æ‰€æœ‰çš„åˆ†ç±»ï¼ŒåŒ…æ‹¬Classå’ŒMetal Classå°†åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­å…·ä½“ä»‹ç» 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748// Discover categories.// å‘ç°å’Œå¤„ç†æ‰€æœ‰Categoryfor (EACH_HEADER) { // å¤–éƒ¨å¾ªç¯éå†æ‰¾åˆ°å½“å‰ç±»ï¼ŒæŸ¥æ‰¾ç±»å¯¹åº”çš„Categoryæ•°ç»„ category_t **catlist = _getObjc2CategoryList(hi, &amp;count); bool hasClassProperties = hi-&gt;info()-&gt;hasCategoryClassProperties(); for (i = 0; i &lt; count; i++) { // å†…éƒ¨å¾ªç¯éå†å½“å‰ç±»çš„æ‰€æœ‰Category category_t *cat = catlist[i]; Class cls = remapClass(cat-&gt;cls); // é¦–å…ˆï¼Œé€šè¿‡å…¶æ‰€å±çš„ç±»æ³¨å†ŒCategoryã€‚å¦‚æœè¿™ä¸ªç±»å·²ç»è¢«å®ç°ï¼Œåˆ™é‡æ–°æ„é€ ç±»çš„æ–¹æ³•åˆ—è¡¨ã€‚ bool classExists = NO; if (cat-&gt;instanceMethods || cat-&gt;protocols || cat-&gt;instanceProperties) { // å°†Categoryæ·»åŠ åˆ°å¯¹åº”Classçš„valueä¸­ï¼Œvalueæ˜¯Classå¯¹åº”çš„æ‰€æœ‰categoryæ•°ç»„ addUnattachedCategoryForClass(cat, cls, hi); // å°†Categoryçš„methodã€protocolã€propertyæ·»åŠ åˆ°Class if (cls-&gt;isRealized()) { remethodizeClass(cls); classExists = YES; } if (PrintConnecting) { _objc_inform(&quot;CLASS: found category -%s(%s) %s&quot;, cls-&gt;nameForLogging(), cat-&gt;name, classExists ? &quot;on existing class&quot; : &quot;&quot;); } } // è¿™å—å’Œä¸Šé¢é€»è¾‘ä¸€æ ·ï¼ŒåŒºåˆ«åœ¨äºè¿™å—æ˜¯å¯¹Meta Classåšæ“ä½œï¼Œè€Œä¸Šé¢åˆ™æ˜¯å¯¹Classåšæ“ä½œ // æ ¹æ®ä¸‹é¢çš„é€»è¾‘ï¼Œä»ä»£ç çš„è§’åº¦æ¥è¯´ï¼Œæ˜¯å¯ä»¥å¯¹åŸç±»æ·»åŠ Categoryçš„ if (cat-&gt;classMethods || cat-&gt;protocols || (hasClassProperties &amp;&amp; cat-&gt;_classProperties)) { addUnattachedCategoryForClass(cat, cls-&gt;ISA(), hi); if (cls-&gt;ISA()-&gt;isRealized()) { remethodizeClass(cls-&gt;ISA()); } if (PrintConnecting) { _objc_inform(&quot;CLASS: found category +%s(%s)&quot;, cls-&gt;nameForLogging(), cat-&gt;name); } } }} 3.10 åˆå§‹åŒ–æ‰€æœ‰æœªåˆå§‹åŒ–çš„ç±»ã€é‡è¦ã€‘å®ç°æ‰€æœ‰çš„ç±»ã€‚åŒ…æ‹¬Swiftå’ŒOCï¼ŒåŒæ—¶ä¼šåˆå§‹åŒ–å…¶ä»–objc_classç»“æ„ä½“ç›¸å…³çš„ä¿¡æ¯ 123456789static void realizeAllClasses(void){ runtimeLock.assertLocked(); header_info *hi; for (hi = FirstHeader; hi; hi = hi-&gt;getNext()) { realizeAllClassesInImage(hi); // may drop and re-acquire runtimeLock }} å¾ªç¯å¤„ç†header_infoï¼Œè°ƒç”¨realizedAllClassesInImage()ã€‚ 1234567891011121314151617181920static void realizeAllClassesInImage(header_info *hi){ runtimeLock.assertLocked(); size_t count, i; classref_t *classlist; if (hi-&gt;areAllClassesRealized()) return; classlist = _getObjc2ClassList(hi, &amp;count); for (i = 0; i &lt; count; i++) { Class cls = remapClass(classlist[i]); // é‡æ–°æ˜ å°„ç±» if (cls) { realizeClassMaybeSwiftAndLeaveLocked(cls, runtimeLock); } } hi-&gt;setAllClassesRealized(YES);} å¾ªç¯è°ƒç”¨realizeClassMaybeSwiftAndLeaveLockedå‡½æ•° 12345static ClassrealizeClassMaybeSwiftAndLeaveLocked(Class cls, mutex_t&amp; lock){ return realizeClassMaybeSwiftMaybeRelock(cls, lock, true);} realizeClassMaybeSwiftMaybeRelockå‡½æ•°çœŸæ­£è°ƒç”¨çš„æ€»å…¥å£ 123456789101112131415161718192021static ClassrealizeClassMaybeSwiftMaybeRelock(Class cls, mutex_t&amp; lock, bool leaveLocked){ lock.assertLocked(); if (!cls-&gt;isSwiftStable_ButAllowLegacyForNow()) { // Non-Swift class. Realize it now with the lock still held. // fixme wrong in the future for objc subclasses of swift classes realizeClassWithoutSwift(cls); // éswiftç±» if (!leaveLocked) lock.unlock(); } else { // Swift class. We need to drop locks and call the Swift // runtime to initialize it. lock.unlock(); cls = realizeSwiftClass(cls); // swiftç±» assert(cls-&gt;isRealized()); // callback must have provoked realization if (leaveLocked) lock.lock(); } return cls;} é€šè¿‡åˆ¤æ–­æ˜¯å¦Swift classæ¥åŒºåˆ†Swiftå’ŒOCç±»çš„å®ç°å…¥å£ã€‚ ç„¶årealizeClassWithoutSwiftåœ¨3.8ä¸­åˆ†æè¿‡ä¸€æ¬¡äº†ã€‚ PSobjc4-756.2æºç æœ¬æ–‡ä½¿ç”¨ï¼šobjc4-756.2æºç  è¿›è¡Œåˆ†æ å‚è€ƒiOS åº•å±‚æ¢ç´¢ç¯‡Â·Easting iOSæ¢ç´¢ ç±»çš„åŠ è½½è¿‡ç¨‹","link":"/2021/01/21/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/08-%E7%B1%BB%E7%9A%84%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B/"},{"title":"11-weakåŸç†æ¢ç©¶","text":"å†…å­˜ç®¡ç†åœ¨APPå¼€å‘è¿‡ç¨‹ä¸­å æ®ç€ä¸€ä¸ªå¾ˆé‡è¦çš„åœ°ä½ï¼Œåœ¨iOSä¸­ï¼Œç³»ç»Ÿä¸ºæˆ‘ä»¬æä¾›äº†ARCçš„å¼€å‘ç¯å¢ƒï¼Œå¸®åŠ©æˆ‘ä»¬åšäº†å¾ˆå¤šå†…å­˜ç®¡ç†çš„å†…å®¹ã€‚æœ¬ç« æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ï¼Œå¹³æ—¶å¼€å‘ä¸­ä½¿ç”¨æœ€å¤šçš„weakåœ¨åº•å±‚æ˜¯å¦‚ä½•è¿›è¡Œå®ç°çš„ ä¸€ã€__strongã€__weakã€__unsafe_unretainedçš„åŒºåˆ«æˆ‘ä»¬é€šè¿‡ä¾‹å­æ¥çœ‹ä¸€ä¸‹__strongã€__weakã€__unsafe_unretainedçš„åŒºåˆ«ã€‚ é¦–å…ˆæ˜¯çœ‹å¦‚ä¸‹ä¾‹å­ï¼Œå¯ä»¥çŸ¥é“åœ¨ä¸´æ—¶ä½œç”¨åŸŸç»“æŸä¹‹åï¼Œç”Ÿæˆçš„å¯¹è±¡å°±ä¼šè¿›è¡Œé”€æ¯ï¼Œæˆ‘ä»¬åœ¨ä½œç”¨åŸŸå¤–éƒ¨ç”¨ä¿®é¥°ç¬¦æ¥æŒæœ‰å¯¹è±¡ï¼Œå†æ¥çœ‹ä¸€ä¸‹å¯¹è±¡çš„é”€æ¯æƒ…å†µ 123456789101112NSLog(@&quot;ä¸´æ—¶ä½œç”¨åŸŸå¼€å§‹&quot;);{ LGPerson *person = [[LGPerson alloc] init]; NSLog(@&quot;personå¯¹è±¡ï¼š%@&quot;, person);}NSLog(@&quot;ä¸´æ—¶ä½œç”¨åŸŸç»“æŸ&quot;);***************************æ‰“å°ç»“æœ******************************2020-01-19 10:57:13.910542+0800 objc-debug[74175:19740208] ä¸´æ—¶ä½œç”¨åŸŸå¼€å§‹2020-01-19 10:57:13.911181+0800 objc-debug[74175:19740208] personå¯¹è±¡ï¼š&lt;LGPerson: 0x10221c900&gt;2020-01-19 10:57:13.911277+0800 objc-debug[74175:19740208] LGPerson -[LGPerson dealloc]2020-01-19 10:57:13.911367+0800 objc-debug[74175:19740208] ä¸´æ—¶ä½œç”¨åŸŸç»“æŸ __strongå…ˆæ¥çœ‹ä¸€ä¸‹ç”¨__strongä¿®é¥°çš„ç»“æœã€‚å¯ä»¥å‘ç°ä¿®é¥°çš„å¯¹è±¡åœ¨ä½œç”¨åŸŸç»“æŸä¹‹åå¹¶æ²¡æœ‰é”€æ¯ï¼Œè¯´æ˜è¯¥å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å¢åŠ äº† 12345678910111213141516__strong LGPerson *strongPerson;NSLog(@&quot;ä¸´æ—¶ä½œç”¨åŸŸå¼€å§‹&quot;);{ LGPerson *person = [[LGPerson alloc] init]; NSLog(@&quot;personå¯¹è±¡ï¼š%@&quot;, person); strongPerson = person;}NSLog(@&quot;ä¸´æ—¶ä½œç”¨åŸŸç»“æŸ&quot;);NSLog(@&quot;strongPersonï¼š%@&quot;, strongPerson);***************************æ‰“å°ç»“æœ******************************2020-01-19 11:54:44.079292+0800 objc-debug[74452:19777011] ä¸´æ—¶ä½œç”¨åŸŸå¼€å§‹2020-01-19 11:54:44.080060+0800 objc-debug[74452:19777011] personå¯¹è±¡ï¼š&lt;LGPerson: 0x101945ae0&gt;2020-01-19 11:54:44.080172+0800 objc-debug[74452:19777011] ä¸´æ—¶ä½œç”¨åŸŸç»“æŸ2020-01-19 11:54:44.080292+0800 objc-debug[74452:19777011] strongPersonï¼š&lt;LGPerson: 0x101945ae0&gt; __weakå†æ¥çœ‹ä¸€ä¸‹__weakä¿®é¥°çš„ç»“æœã€‚é€šè¿‡ä¸‹é¢çš„è¿è¡Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œç”¨__weakä¿®é¥°åï¼Œå¹¶æ²¡æœ‰å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œå¹¶ä¸”ä½œç”¨åŸŸç»“æŸï¼Œå¯¹è±¡é‡Šæ”¾åï¼Œä¿®é¥°çš„å¯¹è±¡ä¸ºnilï¼Œæ²¡æœ‰é€ æˆé‡æŒ‡é’ˆçš„å´©æºƒï¼Œå¯ä»¥è¯´æ˜¯ä¸€ç§å®‰å…¨çš„æ–¹æ¡ˆ 12345678910111213141516__weak LGPerson *weakPerson;NSLog(@&quot;ä¸´æ—¶ä½œç”¨åŸŸå¼€å§‹&quot;);{ LGPerson *person = [[LGPerson alloc] init]; NSLog(@&quot;personå¯¹è±¡ï¼š%@&quot;, person); weakPerson = person;}NSLog(@&quot;ä¸´æ—¶ä½œç”¨åŸŸç»“æŸ&quot;);NSLog(@&quot;weakPersonï¼š%@&quot;, weakPerson);***************************æ‰“å°ç»“æœ******************************2020-01-19 11:58:08.842409+0800 objc-debug[74479:19780263] ä¸´æ—¶ä½œç”¨åŸŸå¼€å§‹2020-01-19 11:58:08.843151+0800 objc-debug[74479:19780263] personå¯¹è±¡ï¼š&lt;LGPerson: 0x101712030&gt;2020-01-19 11:58:08.843382+0800 objc-debug[74479:19780263] LGPerson -[LGPerson dealloc]2020-01-19 11:58:08.843572+0800 objc-debug[74479:19780263] ä¸´æ—¶ä½œç”¨åŸŸç»“æŸ2020-01-19 11:58:08.843762+0800 objc-debug[74479:19780263] weakPersonï¼š(null) __unsafe_unretainedæœ€åæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼Œå¹³æ—¶å¼€å‘ä½¿ç”¨è¾ƒå°‘çš„__unsafe_unretainedå’Œä¸Šé¢ä¸¤ä¸ªçš„åŒºåˆ«åœ¨å“ªã€‚æˆ‘ä»¬é€šè¿‡ç»“æœå¯ä»¥å‘ç°ï¼Œåœ¨ä½œç”¨åŸŸæ¶ˆå¤±ï¼Œå¯¹è±¡å°±è¿›è¡Œäº†é”€æ¯ï¼Œå¹¶ä¸”åœ¨å‡ºä½œç”¨åŸŸæ‰“å°ä¿®é¥°å¯¹è±¡æ—¶ï¼Œå‡ºç°äº†é‡æŒ‡é’ˆçš„å´©æºƒEXC_BAD_ACCESS æ‰€ä»¥è¿™æ ·å°±çœ‹å‡ºäº†__weakå’Œ__unsafe_unretainedçš„åŒºåˆ«å°±æ˜¯å‰è€…ä¼šåœ¨å¯¹è±¡è¢«é‡Šæ”¾çš„æ—¶å€™è‡ªåŠ¨ç½®ä¸ºnilï¼Œè€Œåè€…å´ä¸è¡Œã€‚ 123456789101112131415__unsafe_unretained LGPerson *unsafePerson;NSLog(@&quot;ä¸´æ—¶ä½œç”¨åŸŸå¼€å§‹&quot;);{ LGPerson *person = [[LGPerson alloc] init]; NSLog(@&quot;personå¯¹è±¡ï¼š%@&quot;, person); unsafePerson = person;}NSLog(@&quot;ä¸´æ—¶ä½œç”¨åŸŸç»“æŸ&quot;);NSLog(@&quot;unsafePersonï¼š%@&quot;, unsafePerson);***************************æ‰“å°ç»“æœ******************************2020-01-19 12:02:34.428120+0800 objc-debug[74513:19785153] ä¸´æ—¶ä½œç”¨åŸŸå¼€å§‹2020-01-19 12:02:34.428813+0800 objc-debug[74513:19785153] personå¯¹è±¡ï¼š&lt;LGPerson: 0x1019159f0&gt;2020-01-19 12:02:34.428901+0800 objc-debug[74513:19785153] LGPerson -[LGPerson dealloc]2020-01-19 12:02:34.429015+0800 objc-debug[74513:19785153] ä¸´æ—¶ä½œç”¨åŸŸç»“æŸ å°ç»“ __strongä¿®é¥°åï¼Œå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¼šå¢åŠ ï¼Œåœ¨ä½œç”¨åŸŸå¤–ä¸ä¼šé”€æ¯ __weakä¿®é¥°åï¼Œå¯¹è±¡å¼•ç”¨è®¡æ•°ä¸ä¼šå¢åŠ ï¼Œåœ¨ä½œç”¨åŸŸå¤–ä¼šè‡ªåŠ¨ç½®ä¸ºnil __unsafe_unretainedä¿®é¥°åï¼Œå¼•ç”¨è®¡æ•°ä¸ä¼šå¢åŠ ï¼Œåœ¨ä½œç”¨åŸŸå¤–ä¸ä¼šç½®ç©ºï¼Œä¼šé€ æˆé‡æŒ‡é’ˆå´©æºƒ é€šè¿‡ä¸Šé¢ä¾‹å­åŸºæœ¬äº†è§£äº†__weakçš„ä½œç”¨ï¼Œé‚£ä¹ˆ__weakæ˜¯å¦‚ä½•è¿›è¡Œåˆ›å»ºå’Œé”€æ¯çš„å‘¢ï¼Œä¸‹é¢é€šè¿‡æºç è¿›è¡Œæ·±åº¦æ¢ç´¢ äºŒã€weak ä»£ç å®šä½æ‰“æ–­ç‚¹æŸ¥çœ‹æ±‡ç¼– åœ¨æ±‡ç¼–ä¸­å‘ç°weakåº•å±‚è°ƒç”¨çš„æ˜¯objc_initWeak æˆ‘ä»¬ç»™objc_initWeakæ‰“ä¸Šç¬¦å·æ–­ç‚¹é‡æ–°è¿è¡Œï¼Œå‘ç°objc_initWeakå­˜åœ¨äºlibobjc.A.dylibçš„åŠ¨æ€åº“ä¸­ã€‚ ä¸‰ã€weak çš„ä¿å­˜é€»è¾‘é€šè¿‡ä¸Šé¢çš„åˆ†ææˆ‘ä»¬æŠŠ weak çš„åˆ›å»ºå®šä½åˆ°äº†objc_initWeakè¿™ä¸ªæ–¹æ³•ï¼Œä¸‹é¢å¼€å§‹è¿›è¡Œæºç åˆ†æ objc_initWeakå…¶ä¸­ä¸¤ä¸ªå‚æ•°locationå’ŒnewObjçš„å«ä¹‰å¦‚ä¸‹ locationï¼šè¡¨ç¤º__weak æŒ‡é’ˆçš„åœ°å€ã€‚ä¹‹æ‰€ä»¥è¦å­˜å‚¨æŒ‡é’ˆçš„åœ°å€ï¼Œæ˜¯å› ä¸ºæœ€åæˆ‘ä»¬è¦æŠŠ__weakæŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ç½®ä¸ºnilï¼Œå¦‚æœä»…å­˜å‚¨æŒ‡é’ˆçš„è¯ï¼Œæ˜¯ä¸èƒ½å¤Ÿå®Œæˆè¿™ä¸ªåŠŸèƒ½çš„ã€‚ newObjï¼šæ‰€å¼•ç”¨çš„å¯¹è±¡ã€‚ 1234567891011idobjc_initWeak(id *location, id newObj){ if (!newObj) { *location = nil; return nil; } return storeWeak&lt;DontHaveOld, DoHaveNew, DoCrashIfDeallocating&gt; (location, (objc_object*)newObj);} storeWeakæŸ¥çœ‹storeWeakæºç ï¼Œæ ¹æ®æ³¨é‡Šï¼Œå¯ä»¥çŸ¥é“å¦‚ä¸‹å‡ ç‚¹ HaveOldï¼šweakæŒ‡é’ˆä¹‹å‰æ˜¯å¦å·²ç»æŒ‡å‘äº†ä¸€ä¸ªå¼±å¼•ç”¨ HaveNewï¼šweakæŒ‡é’ˆæ˜¯å¦éœ€è¦æŒ‡å‘ä¸€ä¸ªæ–°å¼•ç”¨ CrashIfDeallocatingï¼šå¦‚æœè¢«å¼±å¼•ç”¨çš„å¯¹è±¡æ­£åœ¨ææ„ï¼Œæ­¤æ—¶å†å¼±å¼•ç”¨è¯¥å¯¹è±¡ï¼Œæ˜¯å¦åº”è¯¥crashã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111// Update a weak variable.// If HaveOld is true, the variable has an existing value // that needs to be cleaned up. This value might be nil.// If HaveNew is true, there is a new value that needs to be // assigned into the variable. This value might be nil.// If CrashIfDeallocating is true, the process is halted if newObj is // deallocating or newObj's class does not support weak references. // If CrashIfDeallocating is false, nil is stored instead.enum CrashIfDeallocating { DontCrashIfDeallocating = false, DoCrashIfDeallocating = true};template &lt;HaveOld haveOld, HaveNew haveNew, CrashIfDeallocating crashIfDeallocating&gt;static id storeWeak(id *location, objc_object *newObj){ assert(haveOld || haveNew); if (!haveNew) assert(newObj == nil); Class previouslyInitializedClass = nil; id oldObj; SideTable *oldTable; SideTable *newTable; // Acquire locks for old and new values. // Order by lock address to prevent lock ordering problems. // Retry if the old value changes underneath us. retry: // âœ…å¦‚æœweakæŒ‡é’ˆä¹‹å‰å¼±å¼•ç”¨è¿‡ä¸€ä¸ªobjï¼Œåˆ™å°†è¿™ä¸ªobjæ‰€å¯¹åº”çš„SideTableå–å‡ºï¼Œèµ‹å€¼ç»™oldTable if (haveOld) { oldObj = *location; oldTable = &amp;SideTables()[oldObj]; } else { // æ²¡æœ‰å¼±å¼•ç”¨è¿‡ï¼Œåˆ™oldTable = nil oldTable = nil; } // âœ…å¦‚æœweakæŒ‡é’ˆè¦å¼±å¼•ç”¨ä¸€ä¸ªæ–°çš„objï¼Œåˆ™å°†è¯¥objå¯¹åº”çš„SideTableå–å‡ºï¼Œèµ‹å€¼ç»™newTable if (haveNew) { newTable = &amp;SideTables()[newObj]; } else { newTable = nil; } // âœ…åŠ é”æ“ä½œï¼Œé˜²æ­¢å¤šçº¿ç¨‹ä¸­ç«äº‰å†²çª SideTable::lockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable); // âœ…å¤šçº¿ç¨‹å®‰å…¨ï¼šlocation åº”è¯¥ä¸ oldObj ä¿æŒä¸€è‡´ï¼Œå¦‚æœä¸åŒï¼Œè¯´æ˜å½“å‰çš„ location å·²ç»å¤„ç†è¿‡ oldObj å¯æ˜¯åˆè¢«å…¶ä»–çº¿ç¨‹æ‰€ä¿®æ”¹ if (haveOld &amp;&amp; *location != oldObj) { SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable); goto retry; } // Prevent a deadlock between the weak reference machinery // and the +initialize machinery by ensuring that no // weakly-referenced object has an un-+initialized isa. if (haveNew &amp;&amp; newObj) { Class cls = newObj-&gt;getIsa(); // âœ…å¦‚æœclsè¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œå…ˆåˆå§‹åŒ–ï¼Œå†å°è¯•è®¾ç½®å¼±å¼•ç”¨ if (cls != previouslyInitializedClass &amp;&amp; !((objc_class *)cls)-&gt;isInitialized()) { SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable); class_initialize(cls, (id)newObj); // If this class is finished with +initialize then we're good. // If this class is still running +initialize on this thread // (i.e. +initialize called storeWeak on an instance of itself) // then we may proceed but it will appear initializing and // not yet initialized to the check above. // Instead set previouslyInitializedClass to recognize it on retry. // âœ…å®Œæˆåˆå§‹åŒ–åè¿›è¡Œæ ‡è®° previouslyInitializedClass = cls; // âœ…newObj åˆå§‹åŒ–åï¼Œé‡æ–°è·å–ä¸€énewObj goto retry; } } // Clean up old value, if any. // âœ… å¦‚æœweakæŒ‡é’ˆä¹‹å‰å¼±å¼•ç”¨è¿‡åˆ«çš„å¯¹è±¡oldObjï¼Œåˆ™è°ƒç”¨weak_unregister_no_lockï¼Œåœ¨oldObjçš„weak_entry_tä¸­ç§»é™¤è¯¥weakæŒ‡é’ˆåœ°å€ if (haveOld) { weak_unregister_no_lock(&amp;oldTable-&gt;weak_table, oldObj, location); } // Assign new value, if any. // âœ…å¦‚æœweakæŒ‡é’ˆéœ€è¦å¼±å¼•ç”¨æ–°çš„å¯¹è±¡newObj if (haveNew) { // âœ…è°ƒç”¨weak_register_no_lockæ–¹æ³•ï¼Œå°†weakæŒ‡é’ˆçš„åœ°å€è®°å½•åˆ°newObjå¯¹åº”çš„weak_entry_tä¸­ newObj = (objc_object *) weak_register_no_lock(&amp;newTable-&gt;weak_table, (id)newObj, location, crashIfDeallocating); // weak_register_no_lock returns nil if weak store should be rejected // Set is-weakly-referenced bit in refcount table. // âœ…æ›´æ–°newObjçš„isaæŒ‡é’ˆçš„weakly_referenced bitæ ‡å¿—ä½ if (newObj &amp;&amp; !newObj-&gt;isTaggedPointer()) { newObj-&gt;setWeaklyReferenced_nolock(); } // Do not set *location anywhere else. That would introduce a race. // âœ…*location èµ‹å€¼ï¼Œä¹Ÿå°±æ˜¯å°†weakæŒ‡é’ˆç›´æ¥æŒ‡å‘äº†newObjï¼Œè€Œä¸”æ²¡æœ‰å°†newObjçš„å¼•ç”¨è®¡æ•°+1 *location = (id)newObj; } else { // No new value. The storage is not changed. } SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable); return (id)newObj;} å› ä¸ºæˆ‘ä»¬è¿™é‡Œæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œæ‰€ä»¥æ˜¯ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯haveNewçš„æƒ…å†µï¼Œè·å–åˆ°çš„æ˜¯æ–°çš„æ•£åˆ—è¡¨SideTableï¼Œä¸»è¦æ‰§è¡Œäº†weak_register_no_lockæ–¹æ³•æ¥è¿›è¡Œæ’å…¥ã€‚ weak_register_no_lockæ¥ç€æˆ‘ä»¬æ¥åˆ†æweak_register_no_lockå‡½æ•°æ˜¯æ€ä¹ˆæ³¨å†Œå¼±å¼•ç”¨çš„ã€‚ æˆ‘ä»¬å‘ç°å‡½æ•°å†…éƒ¨ä¸»è¦è¿›è¡Œäº†isTaggedPointerå’Œdeallocatingçš„åˆ¤æ–­ç­‰å‰ç½®æ¡ä»¶ï¼Œè¿™äº›éƒ½æ˜¯ä¸èƒ½è¿›è¡Œå¼±å¼•ç”¨çš„æƒ…å†µã€‚ å¦‚æœå¯ä»¥è¢«å¼±å¼•ç”¨ï¼Œåˆ™å°†è¢«å¼±å¼•ç”¨å¯¹è±¡æ‰€åœ¨çš„weak_tableä¸­çš„weak_entry_tå“ˆå¸Œæ•°ç»„ä¸­å–å‡ºå¯¹åº”çš„weak_entry_tï¼Œå¦‚æœweak_entry_tä¸å­˜åœ¨ï¼Œåˆ™ä¼šæ–°å»ºä¸€ä¸ªã€‚ç„¶åå°†æŒ‡å‘è¢«å¼±å¼•ç”¨å¯¹è±¡åœ°å€çš„æŒ‡é’ˆreferreré€šè¿‡å‡½æ•°append_referreræ’å…¥åˆ°å¯¹åº”çš„weak_entry_tå¼•ç”¨æ•°ç»„ã€‚è‡³æ­¤å°±å®Œæˆäº†å¼±å¼•ç”¨ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768/** * Registers a new (object, weak pointer) pair. Creates a new weak * object entry if it does not exist. * * @param weak_table The global weak table. * @param referent The object pointed to by the weak reference. * @param referrer The weak pointer address. */id weak_register_no_lock(weak_table_t *weak_table, id referent_id, id *referrer_id, bool crashIfDeallocating){ // âœ…é¦–å…ˆè·å–éœ€è¦å¼±å¼•ç”¨å¯¹è±¡ objc_object *referent = (objc_object *)referent_id; objc_object **referrer = (objc_object **)referrer_id; // âœ…å¦‚æœè¢«å¼±å¼•ç”¨å¯¹è±¡referentä¸ºnil æˆ–è€…è¢«å¼±å¼•ç”¨å¯¹è±¡é‡‡ç”¨äº†TaggedPointerè®¡æ•°æ–¹å¼ï¼Œåˆ™ç›´æ¥è¿”å› if (!referent || referent-&gt;isTaggedPointer()) return referent_id; // ensure that the referenced object is viable // âœ…ç¡®ä¿è¢«å¼•ç”¨çš„å¯¹è±¡å¯ç”¨ï¼ˆæ²¡æœ‰åœ¨é”€æ¯ï¼ŒåŒæ—¶åº”è¯¥æ”¯æŒweakå¼±å¼•ç”¨ï¼‰ bool deallocating; if (!referent-&gt;ISA()-&gt;hasCustomRR()) { deallocating = referent-&gt;rootIsDeallocating(); } else { BOOL (*allowsWeakReference)(objc_object *, SEL) = (BOOL(*)(objc_object *, SEL)) object_getMethodImplementation((id)referent, SEL_allowsWeakReference); if ((IMP)allowsWeakReference == _objc_msgForward) { return nil; } deallocating = ! (*allowsWeakReference)(referent, SEL_allowsWeakReference); } // âœ…å¦‚æœæ˜¯æ­£åœ¨é”€æ¯çš„å¯¹è±¡ï¼Œé‚£ä¹ˆä¸èƒ½å¤Ÿè¢«å¼±å¼•ç”¨ if (deallocating) { if (crashIfDeallocating) { _objc_fatal(&quot;Cannot form weak reference to instance (%p) of &quot; &quot;class %s. It is possible that this object was &quot; &quot;over-released, or is in the process of deallocation.&quot;, (void*)referent, object_getClassName((id)referent)); } else { return nil; } } // now remember it and where it is being stored // âœ…åœ¨ weak_table ä¸­æ‰¾åˆ°è¢«å¼±å¼•ç”¨å¯¹è±¡ referent å¯¹åº”çš„ weak_entry,å¹¶å°† referrer åŠ å…¥åˆ° weak_entry ä¸­ weak_entry_t *entry; if ((entry = weak_entry_for_referent(weak_table, referent))) { // âœ…å¦‚æœèƒ½æ‰¾åˆ° weak_entry,åˆ™è®² referrer æ’å…¥åˆ° weak_entry ä¸­ append_referrer(entry, referrer); } else { // âœ…å¦‚æœæ‰¾ä¸åˆ° weak_entryï¼Œå°±æ–°å»ºä¸€ä¸ª weak_entry_t new_entry(referent, referrer); weak_grow_maybe(weak_table); weak_entry_insert(weak_table, &amp;new_entry); } // Do not set *referrer. objc_storeWeak() requires that the // value not change. return referent_id;} append_referrerè¿™ä¸€æ­¥ä¸»è¦æ˜¯æ‰¾åˆ°å¼±å¼•ç”¨å¯¹è±¡çš„å¯¹åº”çš„weak_entryå“ˆå¸Œæ•°ç»„ä¸­ï¼ŒåŸºæœ¬å°±æ˜¯ä¸ªéå†æ’å…¥çš„è¿‡ç¨‹ï¼ŒåŸç†æ¯”è¾ƒç®€å• 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152static void append_referrer(weak_entry_t *entry, objc_object **new_referrer){ // âœ…å¦‚æœweak_entry ä½¿ç”¨é™æ€æ•°ç»„ inline_referrers if (! entry-&gt;out_of_line()) { // Try to insert inline. // âœ…å°è¯•å°† referrer æ’å…¥æ•°ç»„ for (size_t i = 0; i &lt; WEAK_INLINE_COUNT; i++) { if (entry-&gt;inline_referrers[i] == nil) { entry-&gt;inline_referrers[i] = new_referrer; return; } } // Couldn't insert inline. Allocate out of line. // âœ…å¦‚æœinline_referrersçš„ä½ç½®å·²ç»å­˜æ»¡äº†ï¼Œåˆ™è¦è½¬å‹ä¸º referrersï¼ŒåŠ¨æ€æ•°ç»„ weak_referrer_t *new_referrers = (weak_referrer_t *) calloc(WEAK_INLINE_COUNT, sizeof(weak_referrer_t)); // This constructed table is invalid, but grow_refs_and_insert // will fix it and rehash it. for (size_t i = 0; i &lt; WEAK_INLINE_COUNT; i++) { new_referrers[i] = entry-&gt;inline_referrers[i]; } entry-&gt;referrers = new_referrers; entry-&gt;num_refs = WEAK_INLINE_COUNT; entry-&gt;out_of_line_ness = REFERRERS_OUT_OF_LINE; entry-&gt;mask = WEAK_INLINE_COUNT-1; entry-&gt;max_hash_displacement = 0; } assert(entry-&gt;out_of_line()); // âœ…å¦‚æœåŠ¨æ€æ•°ç»„ä¸­å…ƒç´ ä¸ªæ•°å¤§äºæˆ–ç­‰äºæ•°ç»„æ€»ç©ºé—´çš„3/4ï¼Œåˆ™æ‰©å±•æ•°ç»„ç©ºé—´ä¸ºå½“å‰é•¿åº¦çš„ä¸€å€ï¼Œç„¶åå°† referrer æ’å…¥æ•°ç»„ if (entry-&gt;num_refs &gt;= TABLE_SIZE(entry) * 3/4) { return grow_refs_and_insert(entry, new_referrer); } // âœ…å¦‚æœä¸éœ€è¦æ‰©å®¹ï¼Œç›´æ¥æ’å…¥åˆ°weak_entryä¸­ // âœ…&amp; (entry-&gt;mask) ä¿è¯ begin çš„ä½ç½®åªèƒ½å¤§äºæˆ–ç­‰äºæ•°ç»„çš„é•¿åº¦ size_t begin = w_hash_pointer(new_referrer) &amp; (entry-&gt;mask); size_t index = begin; size_t hash_displacement = 0; while (entry-&gt;referrers[index] != nil) { hash_displacement++; index = (index+1) &amp; entry-&gt;mask; if (index == begin) bad_weak_table(entry); } if (hash_displacement &gt; entry-&gt;max_hash_displacement) { entry-&gt;max_hash_displacement = hash_displacement; } weak_referrer_t &amp;ref = entry-&gt;referrers[index]; ref = new_referrer; entry-&gt;num_refs++;} weak_unregister_no_lockå¦‚æœweakæŒ‡é’ˆåœ¨æŒ‡å‘objä¹‹å‰ï¼Œå·²ç»å¼±å¼•ç”¨äº†å…¶ä»–çš„å¯¹è±¡ï¼Œåˆ™éœ€è¦å…ˆå°†weakæŒ‡é’ˆä»å…¶ä»–å¯¹è±¡çš„weak_entry_tçš„hashæ•°ç»„ä¸­ç§»é™¤ã€‚åœ¨storeWeakæ–¹æ³•ä¸­ä¼šè°ƒç”¨weak_unregister_no_lockå‡½æ•°æ¥åšç§»é™¤æ“ä½œã€‚ weak_unregister_no_lockå‡½æ•°é¦–å…ˆä¼šåœ¨weak_tableä¸­æ‰¾å‡ºä»¥å‰è¢«å¼±å¼•ç”¨çš„å¯¹è±¡referentå¯¹åº”çš„weak_entry_tï¼Œåœ¨weak_entry_tä¸­ç§»é™¤è¢«å¼±å¼•ç”¨çš„å¯¹è±¡referrerã€‚ç§»é™¤å…ƒç´ åï¼Œåˆ¤æ–­æ­¤æ—¶weak_entry_tä¸­æ˜¯å¦è¿˜æœ‰å…ƒç´ ã€‚å¦‚æœæ­¤æ—¶weak_entry_tå·²ç»æ²¡æœ‰å…ƒç´ äº†ï¼Œåˆ™éœ€è¦å°†weak_entry_tä»weak_tableä¸­ç§»é™¤ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940voidweak_unregister_no_lock(weak_table_t *weak_table, id referent_id, id *referrer_id){ // æ‹¿åˆ°ä»¥å‰å¼±å¼•ç”¨çš„å¯¹è±¡å’Œå¯¹è±¡çš„åœ°å€ objc_object *referent = (objc_object *)referent_id; objc_object **referrer = (objc_object **)referrer_id; weak_entry_t *entry; if (!referent) return; // æŸ¥æ‰¾åˆ°ä»¥å‰å¼±å¼•ç”¨çš„å¯¹è±¡ referent æ‰€å¯¹åº”çš„ weak_entry_t if ((entry = weak_entry_for_referent(weak_table, referent))) { // åœ¨ä»¥å‰å¼±å¼•ç”¨çš„å¯¹è±¡ referent æ‰€å¯¹åº”çš„ weak_entry_t çš„ hash æ•°ç»„ä¸­ï¼Œç§»é™¤å¼±å¼•ç”¨ referrer remove_referrer(entry, referrer); // ç§»é™¤å…ƒç´ ä¹‹åï¼Œ è¦æ£€æŸ¥ä¸€ä¸‹ weak_entry_t çš„ hash æ•°ç»„æ˜¯å¦å·²ç»ç©ºäº† bool empty = true; if (entry-&gt;out_of_line() &amp;&amp; entry-&gt;num_refs != 0) { empty = false; } else { for (size_t i = 0; i &lt; WEAK_INLINE_COUNT; i++) { if (entry-&gt;inline_referrers[i]) { empty = false; break; } } } // å¦‚æœ weak_entry_t çš„hashæ•°ç»„å·²ç»ç©ºäº†ï¼Œåˆ™éœ€è¦å°† weak_entry_t ä» weak_table ä¸­ç§»é™¤ if (empty) { weak_entry_remove(weak_table, entry); } } // Do not set *referrer = nil. objc_storeWeak() requires that the // value not change.} è‡³æ­¤ï¼Œä¸€ä¸ªå¯¹è±¡çš„å¼±å¼•ç”¨è¿‡ç¨‹å·²ç»ç»“æŸ å››ã€weak çš„é”€æ¯é€»è¾‘é€šè¿‡å¼€å¤´çš„ä¾‹å­ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå‡ºä½œç”¨åŸŸï¼Œå¯¹è±¡deallocåï¼Œä¼šè‡ªåŠ¨æŠŠå¼±å¼•ç”¨å¯¹è±¡ç½®ç©ºï¼Œé‚£ä¹ˆä»–æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•æŸ¥çœ‹ä¸‹ç±»çš„deallocçš„æºç ï¼š _objc_rootDealloc123456789101112131415161718192021222324252627282930313233343536373839- (void)dealloc { _objc_rootDealloc(self);}**********************************void _objc_rootDealloc(id obj){ assert(obj); obj-&gt;rootDealloc();}***********************************inline voidobjc_object::rootDealloc(){ // âœ…å¦‚æœæ˜¯Tagged Pointerï¼Œå°±ç›´æ¥è¿”å› if (isTaggedPointer()) return; // fixme necessary? /* âœ…å¦‚æœåŒæ—¶æ»¡è¶³ 1. æ˜¯ä¼˜åŒ–è¿‡çš„isaã€ 2. æ²¡æœ‰è¢«weakæŒ‡é’ˆå¼•ç”¨è¿‡ã€ 3. æ²¡æœ‰å…³è”å¯¹è±¡ã€ 4. æ²¡æœ‰C++ææ„å‡½æ•°ã€ 5. æ²¡æœ‰sideTableï¼Œ å°±å¯ä»¥ç›´æ¥é‡Šæ”¾å†…å­˜free() */ if (fastpath(isa.nonpointer &amp;&amp; !isa.weakly_referenced &amp;&amp; !isa.has_assoc &amp;&amp; !isa.has_cxx_dtor &amp;&amp; !isa.has_sidetable_rc)) { assert(!sidetable_present()); free(this); } else { //å¦åˆ™çš„è¯å°±éœ€è¦é€šè¿‡ä¸‹é¢çš„å‡½æ•°å¤„ç† object_dispose((id)this); }} æˆ‘ä»¬è¿™é‡Œæ˜¾ç„¶ä¸æ»¡è¶³ä¸Šè¿°æ¡ä»¶ï¼Œå› ä¸ºæˆ‘ä»¬å¼±å¼•ç”¨è¿‡ï¼Œç»§ç»­è·Ÿè¿›object_dispose object_disposeobject_disposeå‡½æ•°ä¸­è°ƒç”¨äº†objc_destructInstance 1234567891011id object_dispose(id obj){ if (!obj) return nil; objc_destructInstance(obj); free(obj); return nil;} objc_destructInstanceæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å†…éƒ¨ä¼šåšé”€æ¯C++ææ„å‡½æ•°ä»¥åŠç§»é™¤å…³è”å¯¹è±¡çš„æ“ä½œï¼Œçœ‹æ¥å¼±å¼•ç”¨è¦åœ¨clearDeallocatingä¸­äº† 123456789101112131415161718void *objc_destructInstance(id obj) { if (obj) { // Read all of the flags at once for performance. bool cxx = obj-&gt;hasCxxDtor(); bool assoc = obj-&gt;hasAssociatedObjects(); // This order is important. // å¦‚æœæœ‰C++ææ„å‡½æ•°ï¼Œåˆ™è¿è¡Œç›¸å…³å‡½æ•° if (cxx) object_cxxDestruct(obj); // å¦‚æœæœ‰å…³è”å¯¹è±¡ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„å…³è”å¯¹è±¡ï¼Œå¹¶å°†å…¶è‡ªèº«ä»Association Managerçš„mapä¸­ç§»é™¤ if (assoc) _object_remove_assocations(obj); // ç»§ç»­æ¸…ç†å…¶å®ƒç›¸å…³çš„å¼•ç”¨ obj-&gt;clearDeallocating(); } return obj;} clearDeallocating12345678910111213141516inline void objc_object::clearDeallocating(){ if (slowpath(!isa.nonpointer)) { // Slow path for raw pointer isa. // å¦‚æœè¦é‡Šæ”¾çš„å¯¹è±¡æ²¡æœ‰é‡‡ç”¨äº†ä¼˜åŒ–è¿‡çš„isaå¼•ç”¨è®¡æ•° sidetable_clearDeallocating(); } else if (slowpath(isa.weakly_referenced || isa.has_sidetable_rc)) { // Slow path for non-pointer isa with weak refs and/or side table data. // âœ… å¦‚æœè¦é‡Šæ”¾çš„å¯¹è±¡é‡‡ç”¨äº†ä¼˜åŒ–è¿‡çš„isaå¼•ç”¨è®¡æ•°ï¼Œå¹¶ä¸”æœ‰å¼±å¼•ç”¨æˆ–è€…ä½¿ç”¨äº†sideTableçš„è¾…åŠ©å¼•ç”¨è®¡æ•°ï¼ˆç°åœ¨ä¸€èˆ¬éƒ½æ˜¯ä¼˜åŒ–è¿‡çš„ isaï¼‰ clearDeallocating_slow(); } assert(!sidetable_present());} clearDeallocating_slowæˆ‘ä»¬ç°åœ¨ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨ä¼˜åŒ–çš„ isa ï¼Œæ‰€ä»¥èµ°clearDeallocating_slowå‡½æ•°ã€‚ æˆ‘ä»¬é€šè¿‡æºç å¯ä»¥çœ‹åˆ°ä¸»è¦æ“ä½œæ˜¯æ‰¾åˆ°å¯¹åº”çš„SideTableï¼Œç„¶ååœ¨SideTableçš„weak_tableä¸­ï¼Œå°†å¼±å¼•ç”¨å¯¹è±¡ç½®ç©ºï¼Œä¸»è¦çš„æ–¹æ³•ä¸ºweak_clear_no_lock 123456789101112131415161718NEVER_INLINE voidobjc_object::clearDeallocating_slow(){ assert(isa.nonpointer &amp;&amp; (isa.weakly_referenced || isa.has_sidetable_rc)); // åœ¨å…¨å±€çš„SideTablesä¸­ï¼Œä»¥thisæŒ‡é’ˆ(è¦é‡Šæ”¾çš„å¯¹è±¡)ä¸ºkeyï¼Œæ‰¾åˆ°å¯¹åº”çš„SideTable SideTable&amp; table = SideTables()[this]; table.lock(); if (isa.weakly_referenced) { // âœ… è¦é‡Šæ”¾çš„å¯¹è±¡è¢«å¼±å¼•ç”¨äº†ï¼Œé€šè¿‡weak_clear_no_lockå‡½æ•°å°†æŒ‡å‘è¯¥å¯¹è±¡çš„å¼±å¼•ç”¨æŒ‡é’ˆç½®ä¸ºnil weak_clear_no_lock(&amp;table.weak_table, (id)this); } // ä½¿ç”¨äº†sideTableçš„è¾…åŠ©å¼•ç”¨è®¡æ•°,ç›´æ¥åœ¨SideTableä¸­æ“¦é™¤è¯¥å¯¹è±¡çš„å¼•ç”¨è®¡æ•° if (isa.has_sidetable_rc) { table.refcnts.erase(this); } table.unlock();} weak_clear_no_lockæˆ‘ä»¬é€šè¿‡æºç å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ–¹æ³•å’Œæ’å…¥æ—¶çš„æ–¹æ³•æ¯”è¾ƒç±»ä¼¼ï¼Œéƒ½æ˜¯æ‰¾åˆ°å¯¹åº”çš„weak_entry_tæ•°ç»„ï¼Œç„¶åé€šè¿‡éå†æ‰¾åˆ°å¯¹åº”çš„æŒ‡é’ˆåœ°å€ï¼Œç„¶åç½®ä¸ºnilï¼Œé˜²æ­¢äº†é‡æŒ‡é’ˆçš„æŠ¥é”™ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950void weak_clear_no_lock(weak_table_t *weak_table, id referent_id) { // è·å–è¢«å¼±å¼•ç”¨å¯¹è±¡çš„åœ°å€ objc_object *referent = (objc_object *)referent_id; // æ ¹æ®å¯¹è±¡åœ°å€æ‰¾åˆ°è¢«å¼±å¼•ç”¨å¯¹è±¡ referent åœ¨ weak_table ä¸­å¯¹åº”çš„ weak_entry_t weak_entry_t *entry = weak_entry_for_referent(weak_table, referent); if (entry == nil) { /// XXX shouldn't happen, but does with mismatched CF/objc //printf(&quot;XXX no entry for clear deallocating %p\\n&quot;, referent); return; } // zero out references weak_referrer_t *referrers; size_t count; // æ‰¾å‡ºå¼±å¼•ç”¨è¯¥å¯¹è±¡çš„æ‰€æœ‰ weak æŒ‡é’ˆåœ°å€æ•°ç»„ if (entry-&gt;out_of_line()) { referrers = entry-&gt;referrers; count = TABLE_SIZE(entry); } else { referrers = entry-&gt;inline_referrers; count = WEAK_INLINE_COUNT; } // éå†å–å‡ºæ¯ä¸ª weak æŒ‡é’ˆçš„åœ°å€ for (size_t i = 0; i &lt; count; ++i) { objc_object **referrer = referrers[i]; if (referrer) { // å¦‚æœweakæŒ‡é’ˆç¡®å®å¼±å¼•ç”¨äº†å¯¹è±¡ referentï¼Œåˆ™å°†weakæŒ‡é’ˆè®¾ç½®ä¸ºnil if (*referrer == referent) { *referrer = nil; } // å¦‚æœæ‰€å­˜å‚¨çš„weakæŒ‡é’ˆæ²¡æœ‰å¼±å¼•ç”¨å¯¹è±¡ referentï¼Œè¿™å¯èƒ½æ˜¯ç”±äºruntimeä»£ç çš„é€»è¾‘é”™è¯¯å¼•èµ·çš„ï¼ŒæŠ¥é”™ else if (*referrer) { _objc_inform(&quot;__weak variable at %p holds %p instead of %p. &quot; &quot;This is probably incorrect use of &quot; &quot;objc_storeWeak() and objc_loadWeak(). &quot; &quot;Break on objc_weak_error to debug.\\n&quot;, referrer, (void*)*referrer, (void*)referent); objc_weak_error(); } } } weak_entry_remove(weak_table, entry);} è‡³æ­¤ï¼Œä¸€ä¸ªå¼±å¼•ç”¨çš„é”€æ¯ä¹Ÿå®Œæˆäº†ï¼Œå¹¶è‡ªåŠ¨ç½®ä¸ºnil äº”ã€æ€»ç»“ å½“ä¸€ä¸ªå¯¹è±¡objè¢«weakæŒ‡é’ˆæŒ‡å‘æ—¶ï¼Œè¿™ä¸ªweakæŒ‡é’ˆä¼šä»¥objä½œä¸ºkeyï¼Œè¢«å­˜å‚¨åˆ°sideTableç±»çš„weak_tableè¿™ä¸ªæ•£åˆ—è¡¨ä¸Šå¯¹åº”çš„ä¸€ä¸ªweakæŒ‡é’ˆæ•°ç»„é‡Œé¢ã€‚ å½“ä¸€ä¸ªå¯¹è±¡objçš„deallocæ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼ŒRuntimeä¼šä»¥objä¸ºkeyï¼Œä»sideTableçš„weak_tableæ•£åˆ—è¡¨ä¸­ï¼Œæ‰¾å‡ºå¯¹åº”çš„weakæŒ‡é’ˆåˆ—è¡¨ï¼Œç„¶åå°†é‡Œé¢çš„weakæŒ‡é’ˆé€ä¸ªç½®ä¸ºnilã€‚ åˆ›å»ºæµç¨‹ç®€å›¾ åˆ›å»ºæµç¨‹å°ç»“Runtimeç»´æŠ¤äº†ä¸€ä¸ªå¼±å¼•ç”¨è¡¨ï¼Œå°†æ‰€æœ‰å¼±å¼•ç”¨objçš„æŒ‡é’ˆåœ°å€éƒ½ä¿å­˜åœ¨objå¯¹åº”çš„weak_entry_tä¸­ã€‚ åˆ›å»ºæ—¶ï¼Œå…ˆä»æ‰¾åˆ°å…¨å±€æ•£åˆ—è¡¨SideTablesä¸­å¯¹åº”çš„å¼±å¼•ç”¨è¡¨weak_table åœ¨weak_tableä¸­è¢«å¼±å¼•ç”¨å¯¹è±¡çš„referentä¸­åˆ›å»ºæˆ–è€…æ’å…¥å¯¹åº”çš„weak_entry_t ç„¶åappend_referrer(entry, referrer)å°†æˆ‘çš„æ–°å¼±å¼•â½¤çš„å¯¹è±¡åŠ è¿›å»entry æœ€åweak_entry_insert æŠŠentryåŠ â¼Šåˆ°æˆ‘ä»¬çš„weak_table é”€æ¯æµç¨‹ç®€å›¾ é”€æ¯æµç¨‹å°ç»“ é¦–å…ˆæ ¹æ®å¯¹è±¡åœ°å€è·å–æ‰€æœ‰weakæŒ‡é’ˆåœ°å€çš„æ•°ç»„ ç„¶åéå†è¿™ä¸ªæ•°ç»„æŠŠå¯¹åº”çš„æ•°æ®æ¸…ç©ºç½®ä¸ºnil åŒæ—¶ï¼Œå°†weak_entry_tç§»é™¤å‡ºå¼±å¼•ç”¨è¡¨weak_tableã€‚ PSobjc4-756.2æºç æœ¬æ–‡ä½¿ç”¨ï¼šobjc4-756.2æºç  è¿›è¡Œåˆ†æ å‚è€ƒiOSåº•å±‚å­¦ä¹  - å†…å­˜ç®¡ç†ä¹‹weakåŸç†æ¢ç©¶ iOS weakå®ç°åŸç†","link":"/2021/02/17/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/11-weak%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/"},{"title":"13-KVCåŸç†","text":"ä¸€ã€KVCåˆæ¢1.KVCå®šä¹‰KVC(Key-Value Coding)æ˜¯åˆ©ç”¨NSKeyValueCoding åè®®å®ç°çš„ä¸€ç§æœºåˆ¶ï¼Œå¯¹è±¡é‡‡ç”¨è¿™ç§æœºåˆ¶æ¥æä¾›å¯¹å…¶å±æ€§çš„é—´æ¥è®¿é—®ã€‚ å†™ä¸‹ KVC ä»£ç setValueå¹¶ç‚¹å‡»è·Ÿè¿›ï¼Œå‘ç°å…¶ä½äºFoundationæ¡†æ¶ä¸­ KVCåœ¨NSObjectç±»çš„æ‰©å±•NSObject(NSKeyValueCoding)ä¸­ =&gt; æ‰€æœ‰ç»§æ‰¿è‡ªNSObjectçš„ç±»å‡å¯ä»¥ä½¿ç”¨KVC NSArrayã€NSDictionaryã€NSMutableDictionaryã€NSOrderedSetã€NSSetç­‰ä¹Ÿéµå®ˆKVCåè®® é™¤å°‘æ•°ç±»å‹(ç»“æ„ä½“)ä»¥å¤–éƒ½å¯ä»¥ä½¿ç”¨KVC 2.å¸¸ç”¨ API1234567891011// é€šè¿‡ key è®¾å€¼- (void)setValue:(nullable id)value forKey:(NSString *)key;// é€šè¿‡ key å–å€¼- (nullable id)valueForKey:(NSString *)key;// é€šè¿‡ keyPath è®¾å€¼- (void)setValue:(nullable id)value forKeyPath:(NSString *)keyPath;// é€šè¿‡ keyPath å–å€¼- (nullable id)valueForKeyPath:(NSString *)keyPath; NSKeyValueCodingç±»åˆ«çš„å…¶å®ƒæ–¹æ³• 1234567891011121314151617// é»˜è®¤ä¸ºYESã€‚ å¦‚æœè¿”å›ä¸ºYES,å¦‚æœæ²¡æœ‰æ‰¾åˆ° set&lt;Key&gt; æ–¹æ³•çš„è¯, ä¼šæŒ‰ç…§_key, _isKey, key, isKeyçš„é¡ºåºæœç´¢æˆå‘˜å˜é‡, è¿”å›NOåˆ™ä¸ä¼šæœç´¢+ (BOOL)accessInstanceVariablesDirectly;// é”®å€¼éªŒè¯, å¯ä»¥é€šè¿‡è¯¥æ–¹æ³•æ£€éªŒé”®å€¼çš„æ­£ç¡®æ€§, ç„¶ååšå‡ºç›¸åº”çš„å¤„ç†- (BOOL)validateValue:(inout id _Nullable * _Nonnull)ioValue forKey:(NSString *)inKey error:(out NSError **)outError;// å¦‚æœkeyä¸å­˜åœ¨, å¹¶ä¸”æ²¡æœ‰æœç´¢åˆ°å’Œkeyæœ‰å…³çš„å­—æ®µ, ä¼šè°ƒç”¨æ­¤æ–¹æ³•, é»˜è®¤æŠ›å‡ºå¼‚å¸¸ã€‚ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«å¯¹åº” get å’Œ set çš„æƒ…å†µ- (nullable id)valueForUndefinedKey:(NSString *)key;- (void)setValue:(nullable id)value forUndefinedKey:(NSString *)key;// setValueæ–¹æ³•ä¼  nil æ—¶è°ƒç”¨çš„æ–¹æ³•// æ³¨æ„æ–‡æ¡£è¯´æ˜: å½“ä¸”ä»…å½“ NSNumber å’Œ NSValue ç±»å‹æ—¶æ‰ä¼šè°ƒç”¨æ­¤æ–¹æ³• - (void)setNilValueForKey:(NSString *)key;// ä¸€ç»„ keyå¯¹åº”çš„value, å°†å…¶è½¬æˆå­—å…¸è¿”å›, å¯ç”¨äºå°† Model è½¬æˆå­—å…¸- (NSDictionary&lt;NSString *, id&gt; *)dictionaryWithValuesForKeys:(NSArray&lt;NSString *&gt; *)keys; 3.æ‹“å±•â€”â€”è‡ªåŠ¨ç”Ÿæˆçš„setterå’Œgetteræ–¹æ³•è¯•æƒ³ä¸€ä¸‹ç¼–è¯‘å™¨è¦ä¸ºæˆåƒä¸Šä¸‡ä¸ªå±æ€§åˆ†åˆ«ç”Ÿæˆsetterå’Œgetteræ–¹æ³•é‚£ä¸å¾—æ­‡èœäº†å˜› äºæ˜¯è‹¹æœå°±ç»™æ‰€æœ‰å±æ€§éƒ½æä¾›äº†åŒä¸€ä¸ªå…¥å£â€”â€”objc-accessors.mmä¸­setteræ–¹æ³•æ ¹æ®ä¿®é¥°ç¬¦ä¸åŒè°ƒç”¨ä¸åŒæ–¹æ³•ï¼Œæœ€åç»Ÿä¸€è°ƒç”¨reallySetPropertyæ–¹æ³• è‡³äºæ˜¯å“ªé‡Œè°ƒç”¨çš„objc_setProperty_nonatomic_copyï¼Ÿ å¹¶ä¸æ˜¯åœ¨objcæºç ä¸­ï¼Œè€Œåœ¨llvmæºç ä¸­å‘ç°äº†å®ƒï¼Œæ ¹æ®å®ƒä¸€å±‚å±‚æ‰¾ä¸Šå»å°±èƒ½æ‰¾åˆ°æºå¤´ äºŒã€KVCä½¿ç”¨12345678910111213141516typedef struct { float x, y, z;} ThreeFloats;@interface FXPerson : NSObject@property (nonatomic, copy) NSString *name;@property (nonatomic, assign) NSInteger age;@property (nonatomic, copy) NSArray *family;@property (nonatomic) ThreeFloats threeFloats;@property (nonatomic, strong) FXFriend *friend;@end@interface FXFriend : NSObject@property (nonatomic, copy) NSString *name;@property (nonatomic, assign) NSInteger age;@end 1.åŸºæœ¬ç±»å‹æ³¨æ„ä¸€ä¸‹NSIntegerè¿™ç±»çš„å±æ€§èµ‹å€¼æ—¶è¦è½¬æˆNSNumberæˆ–NSString 123456FXPerson *person = [FXPerson new];[person setValue:@&quot;imo&quot; forKey:@&quot;name&quot;];[person setValue:@(18) forKey:@&quot;age&quot;];NSLog(@&quot;åå­—%@ å¹´é¾„%@&quot;, [person valueForKey:@&quot;name&quot;], [person valueForKey:@&quot;age&quot;]); æ‰“å°ç»“æœï¼š 1åå­—imo å¹´é¾„18 2.é›†åˆç±»å‹ä¸¤ç§æ–¹æ³•å¯¹æ•°ç»„è¿›è¡Œèµ‹å€¼ï¼Œæ›´æ¨èä½¿ç”¨ç¬¬äºŒç§æ–¹æ³• 123456789101112FXPerson *person = [FXPerson new];person.family = @[@&quot;FXPerson&quot;, @&quot;FXFather&quot;];// ç›´æ¥ç”¨æ–°çš„æ•°ç»„èµ‹å€¼NSArray *temp = @[@&quot;FXPerson&quot;, @&quot;FXFather&quot;, @&quot;FXMother&quot;];[person setValue:temp forKey:@&quot;family&quot;];NSLog(@&quot;ç¬¬ä¸€æ¬¡æ”¹å˜%@&quot;, [person valueForKey:@&quot;family&quot;]);// å–å‡ºæ•°ç»„ä»¥å¯å˜æ•°ç»„å½¢å¼ä¿å­˜ï¼Œå†ä¿®æ”¹NSMutableArray *mTemp = [person mutableArrayValueForKeyPath:@&quot;family&quot;];[mTemp addObject:@&quot;FXChild&quot;];NSLog(@&quot;ç¬¬äºŒæ¬¡æ”¹å˜%@&quot;, [person valueForKey:@&quot;family&quot;]); æ‰“å°ç»“æœï¼š 123456789101112ç¬¬ä¸€æ¬¡æ”¹å˜( FXPerson, FXFather, FXMother)ç¬¬äºŒæ¬¡æ”¹å˜( FXPerson, FXFather, FXMother, FXChild) 3.è®¿é—®éå¯¹è±¡ç±»å‹â€”â€”ç»“æ„ä½“ å¯¹äºéå¯¹è±¡ç±»å‹çš„èµ‹å€¼æ€»æ˜¯æŠŠå®ƒå…ˆè½¬æˆNSValueç±»å‹å†è¿›è¡Œå­˜å‚¨ å–å€¼æ—¶è½¬æˆå¯¹åº”ç±»å‹åå†ä½¿ç”¨ 12345678910111213FXPerson *person = [FXPerson new];// èµ‹å€¼ThreeFloats floats = {180.0, 180.0, 18.0};NSValue *value = [NSValue valueWithBytes:&amp;floats objCType:@encode(ThreeFloats)];[person setValue:value forKey:@&quot;threeFloats&quot;];NSLog(@&quot;éå¯¹è±¡ç±»å‹%@&quot;, [person valueForKey:@&quot;threeFloats&quot;]);// å–å€¼ThreeFloats th;NSValue *currentValue = [person valueForKey:@&quot;threeFloats&quot;];[currentValue getValue:&amp;th];NSLog(@&quot;éå¯¹è±¡ç±»å‹çš„å€¼%f-%f-%f&quot;, th.x, th.y, th.z); 4.é›†åˆæ“ä½œç¬¦ èšåˆæ“ä½œç¬¦ @avg: è¿”å›æ“ä½œå¯¹è±¡æŒ‡å®šå±æ€§çš„å¹³å‡å€¼ @count: è¿”å›æ“ä½œå¯¹è±¡æŒ‡å®šå±æ€§çš„ä¸ªæ•° @max: è¿”å›æ“ä½œå¯¹è±¡æŒ‡å®šå±æ€§çš„æœ€å¤§å€¼ @min: è¿”å›æ“ä½œå¯¹è±¡æŒ‡å®šå±æ€§çš„æœ€å°å€¼ @sum: è¿”å›æ“ä½œå¯¹è±¡æŒ‡å®šå±æ€§å€¼ä¹‹å’Œ æ•°ç»„æ“ä½œç¬¦ @distinctUnionOfObjects: è¿”å›æ“ä½œå¯¹è±¡æŒ‡å®šå±æ€§çš„é›†åˆâ€“å»é‡ @unionOfObjects: è¿”å›æ“ä½œå¯¹è±¡æŒ‡å®šå±æ€§çš„é›†åˆ åµŒå¥—æ“ä½œç¬¦ @distinctUnionOfArrays: è¿”å›æ“ä½œå¯¹è±¡(åµŒå¥—é›†åˆ)æŒ‡å®šå±æ€§çš„é›†åˆâ€“å»é‡ï¼Œè¿”å›çš„æ˜¯ NSArray @unionOfArrays: è¿”å›æ“ä½œå¯¹è±¡(é›†åˆ)æŒ‡å®šå±æ€§çš„é›†åˆ @distinctUnionOfSets: è¿”å›æ“ä½œå¯¹è±¡(åµŒå¥—é›†åˆ)æŒ‡å®šå±æ€§çš„é›†åˆâ€“å»é‡ï¼Œè¿”å›çš„æ˜¯ NSSet é›†åˆæ“ä½œç¬¦ç”¨å¾—å°‘ä¹‹åˆå°‘ã€‚ä¸‹é¢ä¸¾ä¸ªğŸŒ° 12345678910111213141516171819202122232425262728FXPerson *person = [FXPerson new];NSMutableArray *friendArray = [NSMutableArray array];for (int i = 0; i &lt; 6; i++) { FXFriend *f = [FXFriend new]; NSDictionary *dict = @{ @&quot;name&quot;:@&quot;Felix&quot;, @&quot;age&quot;:@(18+i), }; [f setValuesForKeysWithDictionary:dict]; [friendArray addObject:f];}NSLog(@&quot;%@&quot;, [friendArray valueForKey:@&quot;age&quot;]);float avg = [[friendArray valueForKeyPath:@&quot;@avg.age&quot;] floatValue];NSLog(@&quot;å¹³å‡å¹´é¾„%f&quot;, avg);int count = [[friendArray valueForKeyPath:@&quot;@count.age&quot;] intValue];NSLog(@&quot;è°ƒæŸ¥äººå£%d&quot;, count);int sum = [[friendArray valueForKeyPath:@&quot;@sum.age&quot;] intValue];NSLog(@&quot;å¹´é¾„æ€»å’Œ%d&quot;, sum);int max = [[friendArray valueForKeyPath:@&quot;@max.age&quot;] intValue];NSLog(@&quot;æœ€å¤§å¹´é¾„%d&quot;, max);int min = [[friendArray valueForKeyPath:@&quot;@min.age&quot;] intValue];NSLog(@&quot;æœ€å°å¹´é¾„%d&quot;, min); æ‰“å°ç»“æœï¼š 123452020-03-08 14:06:20.914503+0800 FXDemo[2998:151140] å¹³å‡å¹´é¾„20.5000002020-03-08 14:06:20.914577+0800 FXDemo[2998:151140] è°ƒæŸ¥äººå£62020-03-08 14:06:20.914652+0800 FXDemo[2998:151140] å¹´é¾„æ€»å’Œ1232020-03-08 14:06:20.914739+0800 FXDemo[2998:151140] æœ€å¤§å¹´é¾„232020-03-08 14:06:20.914832+0800 FXDemo[2998:151140] æœ€å°å¹´é¾„18 5.å±‚å±‚åµŒå¥—é€šè¿‡forKeyPathå¯¹å®ä¾‹å˜é‡ï¼ˆfriendsï¼‰è¿›è¡Œå–å€¼èµ‹å€¼ 123456789FXPerson *person = [FXPerson new];FXFriend *f = [[FXFriend alloc] init];f.name = @&quot;Felixçš„æœ‹å‹&quot;;f.age = 18;person.friend = f;[person setValue:@&quot;Feng&quot; forKeyPath:@&quot;friend.name&quot;];NSLog(@&quot;%@&quot;, [person valueForKeyPath:@&quot;friend.name&quot;]); æ‰“å°ç»“æœï¼š 1Feng ä¸‰ã€KVCåº•å±‚åŸç†ç”±äºNSKeyValueCodingçš„å®ç°åœ¨Foundationæ¡†æ¶ï¼Œä½†å®ƒåˆä¸å¼€æºï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡KVOå®˜æ–¹æ–‡æ¡£æ¥äº†è§£å®ƒ 1.è®¾å€¼è¿‡ç¨‹å®˜æ–¹æ–‡æ¡£ä¸Šå¯¹Setteræ–¹æ³•çš„è¿‡ç¨‹è¿›è¡Œäº†è¿™æ ·ä¸€æ®µè®²è§£ï¼š æŒ‰set&lt;Key&gt;:ã€_set&lt;Key&gt;:é¡ºåºæŸ¥æ‰¾å¯¹è±¡ä¸­æ˜¯å¦æœ‰å¯¹åº”çš„æ–¹æ³• æ‰¾åˆ°äº†ç›´æ¥è°ƒç”¨è®¾å€¼ æ²¡æœ‰æ‰¾åˆ°è·³è½¬ç¬¬2æ­¥ åˆ¤æ–­accessInstanceVariablesDirectlyç»“æœ ä¸ºYESæ—¶æŒ‰ç…§_&lt;key&gt;ã€_is&lt;Key&gt;ã€&lt;key&gt;ã€is&lt;Key&gt;çš„é¡ºåºæŸ¥æ‰¾æˆå‘˜å˜é‡ï¼Œæ‰¾åˆ°äº†å°±èµ‹å€¼ï¼›æ‰¾ä¸åˆ°å°±è·³è½¬ç¬¬3æ­¥ ä¸ºNOæ—¶è·³è½¬ç¬¬3æ­¥ è°ƒç”¨setValueï¼šforUndefinedKey:ã€‚é»˜è®¤æƒ…å†µä¸‹ä¼šå¼•å‘ä¸€ä¸ªå¼‚å¸¸ï¼Œä½†æ˜¯ç»§æ‰¿äºNSObjectçš„å­ç±»å¯ä»¥é‡å†™è¯¥æ–¹æ³•å°±å¯ä»¥é¿å…å´©æºƒå¹¶åšå‡ºç›¸åº”æªæ–½ 2.å–å€¼è¿‡ç¨‹åŒæ ·çš„å®˜æ–¹æ–‡æ¡£ä¸Šä¹Ÿç»™å‡ºäº†Getteræ–¹æ³•çš„è¿‡ç¨‹ï¼š æŒ‰ç…§get&lt;Key&gt;ã€&lt;key&gt;ã€is&lt;Key&gt;ã€_&lt;key&gt;é¡ºåºæŸ¥æ‰¾å¯¹è±¡ä¸­æ˜¯å¦æœ‰å¯¹åº”çš„æ–¹æ³• å¦‚æœæœ‰åˆ™è°ƒç”¨getterï¼Œæ‰§è¡Œç¬¬5æ­¥ å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œè·³è½¬åˆ°ç¬¬2æ­¥ æŸ¥æ‰¾æ˜¯å¦æœ‰countOf&lt;Key&gt;å’ŒobjectIn&lt;Key&gt;AtIndex: æ–¹æ³•(å¯¹åº”äºNSArrayç±»å®šä¹‰çš„åŸå§‹æ–¹æ³•)ï¼Œ ä»¥åŠ&lt;key&gt;AtIndexes: æ–¹æ³•(å¯¹åº”äºNSArrayæ–¹æ³•objectsAtIndexes:)ã€‚ å¦‚æœæ‰¾åˆ°å…¶ä¸­çš„ç¬¬ä¸€ä¸ª(countOf&lt;Key&gt;)ï¼Œå†æ‰¾åˆ°å…¶ä»–ä¸¤ä¸ªä¸­çš„è‡³å°‘ä¸€ä¸ªï¼Œåˆ™åˆ›å»ºä¸€ä¸ªå“åº”æ‰€æœ‰ NSArrayæ–¹æ³•çš„ä»£ç†é›†åˆå¯¹è±¡ï¼Œå¹¶è¿”å›è¯¥å¯¹è±¡(å³è¦ä¹ˆæ˜¯countOf&lt;Key&gt; + objectIn&lt;Key&gt;AtIndex:ï¼Œè¦ä¹ˆæ˜¯countOf&lt;Key&gt; + &lt;key&gt;AtIndexes:ï¼Œè¦ä¹ˆæ˜¯countOf&lt;Key&gt; + objectIn&lt;Key&gt;AtIndex: + &lt;key&gt;AtIndexes:) å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œè·³è½¬åˆ°ç¬¬3æ­¥ æŸ¥æ‰¾åä¸ºcountOf&lt;Key&gt;ã€enumeratorOf&lt;Key&gt;å’Œ memberOf&lt;Key&gt;è¿™ä¸‰ä¸ªæ–¹æ³•(å¯¹åº”äºNSSetç±»å®šä¹‰çš„åŸå§‹æ–¹æ³•ï¼‰ å¦‚æœæ‰¾åˆ°è¿™ä¸‰ä¸ªæ–¹æ³•ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªå“åº”æ‰€æœ‰NSSetæ–¹æ³•çš„ä»£ç†é›†åˆå¯¹è±¡ï¼Œå¹¶è¿”å›è¯¥å¯¹è±¡ å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œè·³è½¬åˆ°ç¬¬4æ­¥ åˆ¤æ–­accessInstanceVariablesDirectly ä¸ºYESæ—¶æŒ‰ç…§_&lt;key&gt;ã€_is&lt;Key&gt;ã€&lt;key&gt;ã€is&lt;Key&gt;çš„é¡ºåºæŸ¥æ‰¾æˆå‘˜å˜é‡ï¼Œæ‰¾åˆ°äº†å°±å–å€¼ï¼Œè·³è½¬ç¬¬5æ­¥ ä¸ºNOæ—¶è·³è½¬ç¬¬6æ­¥ åˆ¤æ–­å–å‡ºçš„å±æ€§å€¼ å±æ€§å€¼æ˜¯å¯¹è±¡ï¼Œç›´æ¥è¿”å› å±æ€§å€¼ä¸æ˜¯å¯¹è±¡ï¼Œä½†æ˜¯å¯ä»¥è½¬åŒ–ä¸ºNSNumberç±»å‹ï¼Œåˆ™å°†å±æ€§å€¼è½¬åŒ–ä¸ºNSNumber ç±»å‹è¿”å› å±æ€§å€¼ä¸æ˜¯å¯¹è±¡ï¼Œä¹Ÿä¸èƒ½è½¬åŒ–ä¸ºNSNumberç±»å‹ï¼Œåˆ™å°†å±æ€§å€¼è½¬åŒ–ä¸ºNSValueç±»å‹è¿”å› è°ƒç”¨valueForUndefinedKey:ã€‚é»˜è®¤æƒ…å†µä¸‹ä¼šå¼•å‘ä¸€ä¸ªå¼‚å¸¸ï¼Œä½†æ˜¯ç»§æ‰¿äºNSObjectçš„å­ç±»å¯ä»¥é‡å†™è¯¥æ–¹æ³•å°±å¯ä»¥é¿å…å´©æºƒå¹¶åšå‡ºç›¸åº”æªæ–½ å››ã€è‡ªå®šä¹‰KVCæ–°å»ºä¸€ä¸ªNSObject+FXKVCçš„åˆ†ç±»ï¼Œ.hå¼€æ”¾ä¸¤ä¸ªæ–¹æ³•ï¼Œ.må¼•å…¥&lt;objc/runtime.h&gt; - (void)fx_setValue:(nullable id)value forKey:(NSString *)key; - (nullable id)fx_valueForKey:(NSString *)key; 1.è‡ªå®šä¹‰setteræ–¹æ³•1.éç©ºåˆ¤æ–­ 1if (key == nil || key.length == 0) return; 2.æ‰¾åˆ°ç›¸å…³æ–¹æ³•set&lt;Key&gt;ã€_set&lt;Key&gt;ã€setIs&lt;Key&gt;ï¼Œè‹¥å­˜åœ¨å°±ç›´æ¥è°ƒç”¨ 123456789101112131415NSString *Key = key.capitalizedString;NSString *setKey = [NSString stringWithFormat:@&quot;set%@:&quot;,Key];NSString *_setKey = [NSString stringWithFormat:@&quot;_set%@:&quot;,Key];NSString *setIsKey = [NSString stringWithFormat:@&quot;setIs%@:&quot;,Key];if ([self fx_performSelectorWithMethodName:setKey value:value]) { NSLog(@&quot;*********%@**********&quot;,setKey); return;} else if ([self fx_performSelectorWithMethodName:_setKey value:value]) { NSLog(@&quot;*********%@**********&quot;,_setKey); return;} else if ([self fx_performSelectorWithMethodName:setIsKey value:value]) { NSLog(@&quot;*********%@**********&quot;,setIsKey); return;} 3.åˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿç›´æ¥èµ‹å€¼å®ä¾‹å˜é‡ï¼Œä¸èƒ½çš„æƒ…å†µä¸‹å°±è°ƒç”¨setValue:forUndefinedKey:æˆ–æŠ›å‡ºå¼‚å¸¸ 1234567891011NSString *undefinedMethodName = @&quot;setValue:forUndefinedKey:&quot;;IMP undefinedIMP = class_getMethodImplementation([self class], NSSelectorFromString(undefinedMethodName));if (![self.class accessInstanceVariablesDirectly]) { if (undefinedIMP) { [self fx_performSelectorWithMethodName:undefinedMethodName value:value key:key]; } else { @throw [NSException exceptionWithName:@&quot;FXUnknownKeyException&quot; reason:[NSString stringWithFormat:@&quot;****[%@ %@]: this class is not key value coding-compliant for the key %@.&quot;, self, NSStringFromSelector(_cmd), key] userInfo:nil]; } return;} 4.æ‰¾ç›¸å…³å®ä¾‹å˜é‡è¿›è¡Œèµ‹å€¼ 123456789101112131415161718192021NSMutableArray *mArray = [self getIvarListName];NSString *_key = [NSString stringWithFormat:@&quot;_%@&quot;,key];NSString *_isKey = [NSString stringWithFormat:@&quot;_is%@&quot;,Key];NSString *isKey = [NSString stringWithFormat:@&quot;is%@&quot;,Key];if ([mArray containsObject:_key]) { Ivar ivar = class_getInstanceVariable([self class], _key.UTF8String); object_setIvar(self , ivar, value); return;} else if ([mArray containsObject:_isKey]) { Ivar ivar = class_getInstanceVariable([self class], _isKey.UTF8String); object_setIvar(self , ivar, value); return;} else if ([mArray containsObject:key]) { Ivar ivar = class_getInstanceVariable([self class], key.UTF8String); object_setIvar(self , ivar, value); return;} else if ([mArray containsObject:isKey]) { Ivar ivar = class_getInstanceVariable([self class], isKey.UTF8String); object_setIvar(self , ivar, value); return;} 5.è°ƒç”¨setValue:forUndefinedKey:æˆ–æŠ›å‡ºå¼‚å¸¸ 12345if (undefinedIMP) { [self fx_performSelectorWithMethodName:undefinedMethodName value:value key:key];} else { @throw [NSException exceptionWithName:@&quot;FXUnknownKeyException&quot; reason:[NSString stringWithFormat:@&quot;****[%@ %@]: this class is not key value coding-compliant for the key %@.&quot;, self, NSStringFromSelector(_cmd), key] userInfo:nil];} 2.è‡ªå®šä¹‰getteræ–¹æ³•1.éç©ºåˆ¤æ–­ 1if (key == nil || key.length == 0) return nil; 2.æ‰¾ç›¸å…³æ–¹æ³•get&lt;Key&gt;ã€&lt;key&gt;ï¼Œæ‰¾åˆ°å°±è¿”å›ï¼ˆè¿™é‡Œä½¿ç”¨-Warc-performSelector-leaksæ¶ˆé™¤è­¦å‘Šï¼‰ 1234567891011NSString *Key = key.capitalizedString;NSString *getKey = [NSString stringWithFormat:@&quot;get%@&quot;,Key]; #pragma clang diagnostic push#pragma clang diagnostic ignored &quot;-Warc-performSelector-leaks&quot;if ([self respondsToSelector:NSSelectorFromString(getKey)]) { return [self performSelector:NSSelectorFromString(getKey)];} else if ([self respondsToSelector:NSSelectorFromString(key)]) { return [self performSelector:NSSelectorFromString(key)];}#pragma clang diagnostic pop 3.å¯¹NSArrayè¿›è¡Œæ“ä½œï¼šæŸ¥æ‰¾countOf&lt;Key&gt;ã€objectIn&lt;Key&gt;AtIndexæ–¹æ³• 1234567891011121314151617181920NSString *countOfKey = [NSString stringWithFormat:@&quot;countOf%@&quot;,Key];NSString *objectInKeyAtIndex = [NSString stringWithFormat:@&quot;objectIn%@AtIndex:&quot;,Key];#pragma clang diagnostic push#pragma clang diagnostic ignored &quot;-Warc-performSelector-leaks&quot;if ([self respondsToSelector:NSSelectorFromString(countOfKey)]) { if ([self respondsToSelector:NSSelectorFromString(objectInKeyAtIndex)]) { int num = (int)[self performSelector:NSSelectorFromString(countOfKey)]; NSMutableArray *mArray = [NSMutableArray arrayWithCapacity:1]; for (int i = 0; i&lt;num-1; i++) { num = (int)[self performSelector:NSSelectorFromString(countOfKey)]; } for (int j = 0; j&lt;num; j++) { id objc = [self performSelector:NSSelectorFromString(objectInKeyAtIndex) withObject:@(num)]; [mArray addObject:objc]; } return mArray; }}#pragma clang diagnostic pop 4.åˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿç›´æ¥èµ‹å€¼å®ä¾‹å˜é‡ï¼Œä¸èƒ½çš„æƒ…å†µä¸‹å°±è°ƒç”¨valueForUndefinedKey:æˆ–æŠ›å‡ºå¼‚å¸¸ 123456789101112131415NSString *undefinedMethodName = @&quot;valueForUndefinedKey:&quot;;IMP undefinedIMP = class_getMethodImplementation([self class], NSSelectorFromString(undefinedMethodName));if (![self.class accessInstanceVariablesDirectly]) { if (undefinedIMP) { #pragma clang diagnostic push#pragma clang diagnostic ignored &quot;-Warc-performSelector-leaks&quot; return [self performSelector:NSSelectorFromString(undefinedMethodName) withObject:key];#pragma clang diagnostic pop } else { @throw [NSException exceptionWithName:@&quot;FXUnknownKeyException&quot; reason:[NSString stringWithFormat:@&quot;****[%@ %@]: this class is not key value coding-compliant for the key %@.&quot;, self, NSStringFromSelector(_cmd), key] userInfo:nil]; }} 5.æ‰¾ç›¸å…³å®ä¾‹å˜é‡ï¼Œæ‰¾åˆ°äº†å°±è¿”å› 1234567891011121314151617NSMutableArray *mArray = [self getIvarListName];NSString *_key = [NSString stringWithFormat:@&quot;_%@&quot;,key];NSString *_isKey = [NSString stringWithFormat:@&quot;_is%@&quot;,Key];NSString *isKey = [NSString stringWithFormat:@&quot;is%@&quot;,Key];if ([mArray containsObject:_key]) { Ivar ivar = class_getInstanceVariable([self class], _key.UTF8String); return object_getIvar(self, ivar);;} else if ([mArray containsObject:_isKey]) { Ivar ivar = class_getInstanceVariable([self class], _isKey.UTF8String); return object_getIvar(self, ivar);;} else if ([mArray containsObject:key]) { Ivar ivar = class_getInstanceVariable([self class], key.UTF8String); return object_getIvar(self, ivar);;} else if ([mArray containsObject:isKey]) { Ivar ivar = class_getInstanceVariable([self class], isKey.UTF8String); return object_getIvar(self, ivar);;} 6.è°ƒç”¨valueForUndefinedKey:æˆ–æŠ›å‡ºå¼‚å¸¸ 123456789if (undefinedIMP) { #pragma clang diagnostic push#pragma clang diagnostic ignored &quot;-Warc-performSelector-leaks&quot; return [self performSelector:NSSelectorFromString(undefinedMethodName) withObject:key];#pragma clang diagnostic pop} else { @throw [NSException exceptionWithName:@&quot;FXUnknownKeyException&quot; reason:[NSString stringWithFormat:@&quot;****[%@ %@]: this class is not key value coding-compliant for the key %@.&quot;, self, NSStringFromSelector(_cmd), key] userInfo:nil];} 3.å°è£…çš„æ–¹æ³•è¿™é‡Œç®€å•å°è£…äº†å‡ ä¸ªç”¨åˆ°çš„æ–¹æ³• fx_performSelectorWithMethodName:value:key:å®‰å…¨è°ƒç”¨æ–¹æ³•åŠä¼ ä¸¤ä¸ªå‚æ•° 123456789101112- (BOOL)fx_performSelectorWithMethodName:(NSString *)methodName value:(id)value key:(id)key { if ([self respondsToSelector:NSSelectorFromString(methodName)]) { #pragma clang diagnostic push#pragma clang diagnostic ignored &quot;-Warc-performSelector-leaks&quot; [self performSelector:NSSelectorFromString(methodName) withObject:value withObject:key];#pragma clang diagnostic pop return YES; } return NO;} fx_performSelectorWithMethodName:key:å®‰å…¨è°ƒç”¨æ–¹æ³•åŠä¼ å‚ 123456789101112- (BOOL)fx_performSelectorWithMethodName:(NSString *)methodName key:(id)key { if ([self respondsToSelector:NSSelectorFromString(methodName)]) { #pragma clang diagnostic push#pragma clang diagnostic ignored &quot;-Warc-performSelector-leaks&quot; [self performSelector:NSSelectorFromString(methodName) withObject:key];#pragma clang diagnostic pop return YES; } return NO;} getIvarListNameå–æˆå‘˜å˜é‡ 123456789101112131415- (NSMutableArray *)getIvarListName { NSMutableArray *mArray = [NSMutableArray arrayWithCapacity:1]; unsigned int count = 0; Ivar *ivars = class_copyIvarList([self class], &amp;count); for (int i = 0; i&lt;count; i++) { Ivar ivar = ivars[i]; const char *ivarNameChar = ivar_getName(ivar); NSString *ivarName = [NSString stringWithUTF8String:ivarNameChar]; NSLog(@&quot;ivarName == %@&quot;,ivarName); [mArray addObject:ivarName]; } free(ivars); return mArray;} äº”ã€KVCå¼‚å¸¸å°æŠ€å·§1.æŠ€å·§ä¸€ï¼šè‡ªåŠ¨è½¬æ¢ç±»å‹ ç”¨intç±»å‹èµ‹å€¼ä¼šè‡ªåŠ¨è½¬æˆ__NSCFNumber 1234[person setValue:@18 forKey:@&quot;age&quot;];[person setValue:@&quot;20&quot; forKey:@&quot;age&quot;];NSLog(@&quot;%@-%@&quot;, [person valueForKey:@&quot;age&quot;], [[person valueForKey:@&quot;age&quot;] class]); ç”¨ç»“æ„ä½“ç±»å‹ç±»å‹èµ‹å€¼ä¼šè‡ªåŠ¨è½¬æˆNSConcreteValue 12345ThreeFloats floats = {1.0, 2.0, 3.0};NSValue *value = [NSValue valueWithBytes:&amp;floats objCType:@encode(ThreeFloats)];[person setValue:value forKey:@&quot;threeFloats&quot;];NSLog(@&quot;%@-%@&quot;, [person valueForKey:@&quot;threeFloats&quot;], [[person valueForKey:@&quot;threeFloats&quot;] class]); 2.æŠ€å·§äºŒï¼šè®¾ç½®ç©ºå€¼æœ‰æ—¶å€™åœ¨è®¾å€¼æ—¶è®¾ç½®ç©ºå€¼ï¼Œå¯ä»¥é€šè¿‡é‡å†™setNilValueForKeyæ¥ç›‘å¬ï¼Œä½†åªå¯¹NSNumberç±»å‹æœ‰æ•ˆã€‚ 3.æŠ€å·§ä¸‰ï¼šæœªå®šä¹‰çš„keyå¯¹äºæœªå®šä¹‰çš„keyæˆ‘ä»¬å¯ä»¥é€šè¿‡é‡å†™setValue:forUndefinedKey:ã€valueForUndefinedKey:æ¥ç›‘å¬ 123456789101112@implementation FXPerson- (void)setValue:(id)value forUndefinedKey:(NSString *)key { NSLog(@&quot;æœªå®šä¹‰çš„keyâ€”â€”%@&quot;,key);}- (id)valueForUndefinedKey:(NSString *)key { NSLog(@&quot;æœªå®šä¹‰çš„keyâ€”â€”%@&quot;,key); return @&quot;æœªå®šä¹‰çš„key&quot;;}@end","link":"/2021/03/23/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/13-KVC%E5%8E%9F%E7%90%86/"},{"title":"14-KVOåŸç†","text":"ä¸€ã€KVOç®€è¿°KVOï¼ˆKey-Value Observingï¼‰æ˜¯ä¸€å¥—äº‹ä»¶è§‚å¯Ÿ &amp; é€šçŸ¥æœºåˆ¶ï¼Œå¼€å‘è€…å¯ä»¥ä½¿ç”¨å®ƒæ¥ç›‘æµ‹å¯¹è±¡å±æ€§çš„å˜åŒ–å¹¶åšå‡ºå“åº”ã€‚ åœ¨Documentation Archieveä¸­æåˆ°ä¸€å¥æƒ³è¦ç†è§£KVOï¼Œå¿…é¡»å…ˆç†è§£KVCï¼Œå› ä¸ºé”®å€¼è§‚å¯Ÿæ˜¯å»ºç«‹åœ¨é”®å€¼ç¼–ç çš„åŸºç¡€ä¸Šã€‚ è€ŒKVOå’ŒNSNotificatioCenteréƒ½æ˜¯ iOS è§‚å¯Ÿè€…æ¨¡å¼çš„ä¸€ç§å®ç°ï¼Œä¸¤è€…çš„åŒºåˆ«åœ¨äºï¼š ç›¸å¯¹äºè¢«è§‚å¯Ÿè€…å’Œè§‚å¯Ÿè€…ä¹‹é—´çš„å…³ç³»ï¼ŒKVOæ˜¯ä¸€å¯¹ä¸€çš„ï¼ŒNSNotificatioCenteræ˜¯ä¸€å¯¹å¤šçš„ KVOå¯¹è¢«ç›‘å¬å¯¹è±¡æ— ä¾µå…¥æ€§ï¼Œä¸éœ€è¦ä¿®æ”¹å…¶å†…éƒ¨ä»£ç å³å¯å®ç°ç›‘å¬ äºŒã€KVOä½¿ç”¨åŠæ³¨æ„ç‚¹2.1 åŸºæœ¬ä½¿ç”¨KVOä½¿ç”¨ä¸‰éƒ¨æ›²ï¼š æ³¨å†Œè§‚å¯Ÿè€… 1[self.person addObserver:self forKeyPath:@&quot;name&quot; options:(NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld) context:NULL]; å®ç°å›è°ƒ 123- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change context:(void *)context { if ([keyPath isEqualToString:@&quot;name&quot;]) NSLog(@&quot;%@&quot;, change);} ç§»é™¤è§‚å¯Ÿè€… 123- (void)dealloc { [self.person removeObserver:self forKeyPath:@&quot;name&quot;];} 2.2 context è¯´æ˜å¦‚æœçˆ¶ç±»ä¸­æœ‰ä¸ªnameå±æ€§ï¼Œå­ç±»ä¸­ä¹Ÿæœ‰ä¸ªnameå±æ€§ï¼Œä¸¤è€…éƒ½æ³¨å†Œå¯¹nameçš„è§‚å¯Ÿï¼Œé‚£ä¹ˆä»…é€šè¿‡keyPathå·²ç»åŒºåˆ†ä¸äº†æ˜¯å“ªä¸ªnameå‘ç”Ÿå˜åŒ–äº†ï¼Œç°æœ‰ä¸¤ä¸ªè§£å†³åŠæ³•ï¼š å¤šåŠ ä¸€å±‚åˆ¤æ–­ï¼šåˆ¤æ–­objectï¼Œä½†æ˜¯ä¼šå‡ºç°å¾ˆå¤š ifâ€¦elseâ€¦ ä½¿ç”¨contextä¼ é€’ä¿¡æ¯ï¼Œæ›´å®‰å…¨ã€æ›´å¯æ‰©å±• contextä½¿ç”¨æ€»ç»“: ä¸ä½¿ç”¨contextä½œä¸ºè§‚å¯Ÿå€¼ 12// contextæ˜¯ void * ç±»å‹ï¼Œåº”è¯¥å¡« NULL è€Œä¸æ˜¯ nil[self.person addObserver:self forKeyPath:@&quot;name&quot; options:(NSKeyValueObservingOptionNew) context:NULL]; ä½¿ç”¨contextä¼ é€’ä¿¡æ¯ 12345678910111213static void *PersonNameContext = &amp;PersonNameContext;static void *ChildNameContext = &amp;ChildNameContext;[self.person addObserver:self forKeyPath:@&quot;name&quot; options:(NSKeyValueObservingOptionNew) context:PersonNameContext];[self.child addObserver:self forKeyPath:@&quot;name&quot; options:(NSKeyValueObservingOptionNew) context:ChildNameContext];- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change context:(void *)context { if (context == PersonNameContext) { NSLog(@&quot;%@&quot;, change); } else if (context == ChildNameContext) { NSLog(@&quot;%@&quot;, change); }} 2.3 ç§»é™¤è§‚å¯Ÿçš„å¿…è¦æ€§ä¸ç§»é™¤ä¼šå¸¦æ¥æ½œåœ¨çš„éšæ‚£ï¼š å¦‚æœè§‚å¯Ÿè€…å¯¹è±¡ dealloc çš„æ—¶å€™æ²¡æœ‰ç§»é™¤å¯¹ç›®æ ‡å±æ€§çš„è§‚å¯Ÿï¼Œå½“ç›®æ ‡å±æ€§æ”¹å˜çš„æ—¶å€™ï¼Œè¿˜æ˜¯ä¼šé€šçŸ¥è¯¥è§‚å¯Ÿè€…ï¼Œä½†æ˜¯è¯¥è§‚å¯Ÿè€…æ­¤æ—¶å·²ç»é‡Šæ”¾äº†ï¼Œå°±ä¼šå‡ºç°é‡æŒ‡é’ˆçš„æƒ…å†µã€‚ ä¾‹å¦‚ï¼šLGPersonæ˜¯ä¸€ä¸ªå•ä¾‹å¯¹è±¡ï¼Œå®ƒæœ‰ä¸ªå±æ€§nameã€‚ç„¶ååœ¨FirstViewControllerå’ŒSecondViewControllerä¸­éƒ½å¯¹LGPersonå¯¹è±¡çš„nameå±æ€§è¿›è¡Œäº†KVOè§‚å¯Ÿã€‚ æ“ä½œé¡ºåºæ˜¯ä»FirstViewControllerpushåˆ°SecondViewControllerï¼Œç„¶åä»SecondViewControllerpop åˆ°FirstViewControllerã€‚ å‡å¦‚SecondViewControlleråœ¨ dealloc çš„æ—¶å€™æ²¡æœ‰ç§»é™¤è§‚å¯Ÿè€…ï¼Œä½†æ˜¯è¿™ä¸ªLGPersonå¯¹è±¡ç”±äºæ˜¯å•ä¾‹æ‰€ä»¥æ²¡æœ‰é”€æ¯ã€‚ç„¶ååœ¨FirstViewControllerä¸­nameå±æ€§è¢«æ”¹å˜äº†ã€‚æ­¤æ—¶å°±ä¼šé€šçŸ¥å®ƒçš„è§‚å¯Ÿè€…å³SecondViewControllerï¼Œä½†æ˜¯SecondViewControllerè¿™ä¸ªè§‚å¯Ÿè€…å·²ç»é‡Šæ”¾äº†ï¼Œå†æ¬¡è®¿é—®å®ƒå°±ä¼šé€ æˆè®¿é—®é‡æŒ‡é’ˆçš„æƒ…å†µã€‚ æ‰€ä»¥è¯´ï¼Œè¯¥ç§»é™¤è§‚å¯Ÿçš„æ—¶å€™å°±è¦ç§»é™¤ã€‚ è‹¹æœå®˜æ–¹æ¨èçš„æ–¹å¼æ˜¯â€”â€”åœ¨initçš„æ—¶å€™è¿›è¡ŒaddObserverï¼Œåœ¨deallocæ—¶removeObserverï¼Œè¿™æ ·å¯ä»¥ä¿è¯addå’Œremoveæ˜¯æˆå¯¹å‡ºç°çš„ï¼Œè¿™æ˜¯ä¸€ç§æ¯”è¾ƒç†æƒ³çš„ä½¿ç”¨æ–¹å¼ 2.4 æ‰‹åŠ¨è§¦å‘é”®å€¼è§‚å¯Ÿæœ‰æ—¶å€™ä¸šåŠ¡éœ€æ±‚éœ€è¦è§‚å¯ŸæŸä¸ªå±æ€§å€¼ï¼Œä¸€ä¼šå„¿è¦è§‚å¯Ÿäº†ï¼Œä¸€ä¼šåˆä¸è¦è§‚å¯Ÿäº†â€¦å¦‚æœæŠŠKVOä¸‰éƒ¨æ›²æ•´ä½“å»æ‰ã€å†æ•´ä½“æ·»ä¸Šï¼Œå¿…ç„¶åˆæ˜¯ä¸€é¡¿ç¹çè€Œåˆä¸å¿…è¦çš„å·¥ä½œï¼Œå¥½åœ¨KVOä¸­æœ‰ä¸¤ç§åŠæ³•å¯ä»¥æ‰‹åŠ¨è§¦å‘é”®å€¼è§‚å¯Ÿï¼š å°†è¢«è§‚å¯Ÿè€…çš„automaticallyNotifiesObserversForKeyè¿”å›NOï¼ˆå¯ä»¥åªå¯¹æŸä¸ªå±æ€§è®¾ç½®ï¼‰ï¼Œè¿™æ ·å°±ä¸ä¼šè‡ªåŠ¨è§‚å¯Ÿå±æ€§çš„å˜åŒ–äº†ï¼Œè€Œæ˜¯é€šè¿‡æ‰‹åŠ¨é€šçŸ¥çš„æ–¹å¼å»è§‚å¯Ÿã€‚ 123456+ (BOOL)automaticallyNotifiesObserversForKey:(NSString *)key { if ([key isEqualToString:@&quot;name&quot;]) { return NO; } return [super automaticallyNotifiesObserversForKey:key];} ä½¿ç”¨willChangeValueForKeyã€didChangeValueForKeyé‡å†™è¢«è§‚å¯Ÿè€…çš„å±æ€§çš„setteræ–¹æ³• è¿™ä¸¤ä¸ªæ–¹æ³•ç”¨äºé€šçŸ¥ç³»ç»Ÿè¯¥ key çš„å±æ€§å€¼å³å°†å’Œå·²ç»å˜æ›´äº† 12345- (void)setName:(NSString *)name { [self willChangeValueForKey:@&quot;name&quot;]; _name = name; [self didChangeValueForKey:@&quot;name&quot;];} ä¸¤ç§æ–¹å¼ä½¿ç”¨çš„æ’åˆ—ç»„åˆå¦‚ä¸‹ï¼Œå¯ä»¥è‡ªç”±ç»„åˆå¦‚ä½•ä½¿ç”¨ æƒ…å†µ å›è°ƒæ¬¡æ•° æ­£å¸¸æƒ…å†µ 1 automaticallyNotifiesObserversForKeyä¸ºNO 0 automaticallyNotifiesObserversForKeyä¸ºNOä¸”æ·»åŠ willChangeValueForKeyã€didChangeValueForKey 1 automaticallyNotifiesObserversForKeyä¸ºYESä¸”æ·»åŠ willChangeValueForKeyã€didChangeValueForKey 2 æœ€è¿‘å‘ç°[self willChangeValueForKey:name]å’Œ[self willChangeValueForKey:â€nameâ€]ä¸¤ç§å†™æ³•æ˜¯ä¸åŒçš„ç»“æœï¼šé‡å†™setteræ–¹æ³•å–å±æ€§å€¼æ“ä½œä¸ä¼šé¢å¤–å‘é€é€šçŸ¥ï¼›è€Œä½¿ç”¨â€œnameâ€ä¼šé¢å¤–å‘é€ä¸€æ¬¡é€šçŸ¥ 2.5 Key ä¾èµ–æƒ…å†µæ¯”å¦‚æœ‰ä¸€ä¸ªä¸‹è½½ä»»åŠ¡çš„éœ€æ±‚ï¼Œæ ¹æ®æ€»ä¸‹è½½é‡Totalå’Œå½“å‰å·²ä¸‹è½½é‡Currentæ¥å¾—åˆ°å½“å‰ä¸‹è½½è¿›åº¦progressï¼Œè¿™ä¸ªéœ€æ±‚å°±æœ‰ä¸¤ç§å®ç°ï¼š åˆ†åˆ«è§‚å¯Ÿæ€»ä¸‹è½½é‡Totalå’Œå½“å‰å·²ä¸‹è½½é‡Currentä¸¤ä¸ªå±æ€§ï¼Œå…¶ä¸­ä¸€ä¸ªå±æ€§å‘ç”Ÿå˜åŒ–æ—¶è®¡ç®—æ±‚å€¼å½“å‰ä¸‹è½½è¿›åº¦Processã€å¤ªéº»çƒ¦äº†ã€‘ å®ç°keyPathsForValuesAffectingValueForKeyæ–¹æ³•ï¼Œå¹¶è§‚å¯Ÿprogresså±æ€§ã€é‡‡ç”¨ã€‘ progresså±æ€§å—åˆ°currentå’Œtotalå±æ€§å˜åŒ–çš„å½±å“ï¼Œå¦‚æœæˆ‘ä»¬æƒ³åªç›‘å¬progressï¼Œåˆä¿è¯currentå’Œtotalå˜åŒ–æ—¶èƒ½æ”¶åˆ°KVOä¸­çš„å›è°ƒå‘Šè¯‰æˆ‘ä»¬progresså˜åŒ–äº†ï¼Œæˆ‘ä»¬éœ€è¦å®ç°+keyPathsForValuesAffectingValueForKey:æ–¹æ³•æ¥å…³è”ä¸¤ä¸ªå±æ€§åˆ°progressä¸Šï¼š 12345678+ (NSSet&lt;NSString *&gt; *)keyPathsForValuesAffectingValueForKey:(NSString *)key { NSSet *keyPaths = [super keyPathsForValuesAffectingValueForKey:key]; if ([key isEqualToString:@&quot;progress&quot;]) { NSArray *affectingKeys = @[@&quot;current&quot;, @&quot;total&quot;]; keyPaths = [keyPaths setByAddingObjectsFromArray:affectingKeys]; } return keyPaths;} Person ç±»ä¸­progesså—åˆ°ä¸¤ä¸ªå±æ€§å˜åŒ–çš„å½±å“ 123- (CGFloat)progress { return self.current / self.total;} æ·»åŠ ç›‘å¬ï¼š 123456Person *p = [Person new];self.person = p;p.current = 0;p.total = 100;[self.person addObserver:self forKeyPath:@&quot;progress&quot; options:(NSKeyValueObservingOptionNew) context:NULL]; ç›‘å¬å›è°ƒï¼š 123- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change context:(void *)context { NSLog(@&quot;%@&quot;, change);} è¿™æ ·ï¼Œcurrentå’Œtotalå˜åŒ–æ—¶ï¼Œå°±èƒ½ç›‘å¬åˆ°progressçš„å˜åŒ–äº†ï¼š 1234- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event { self.person.current += 10; self.person.total += 1;} 2.6 å¯å˜æ•°ç»„é¦–å…ˆæ·»åŠ å¯¹dataArrayè¿™ä¸ªå¯å˜æ•°ç»„çš„è§‚å¯Ÿï¼š 1[self.person addObserver:self forKeyPath:@&quot;dateArray&quot; options:(NSKeyValueObservingOptionNew) context:NULL]; ç„¶åè°ƒç”¨ä¸‹é¢ä»£ç ï¼Œå¯¹dateArrayæ•°ç»„æ·»åŠ å…ƒç´  1[self.person.dateArray addObject:@&quot;hello&quot;]; è¿™æ ·ä¼šä¸ä¼šè§¦å‘KVOé€šçŸ¥å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¸ä¼šçš„ï¼Œå› ä¸ºKVOæ˜¯ç»™äºˆsetæ–¹æ³•çš„ï¼Œè¿™æ ·ä¸ä¼šè§¦å‘setæ–¹æ³•ï¼Œæ‰€ä»¥å°±ä¸ä¼šè§¦å‘KVOé€šçŸ¥ã€‚æ­£ç¡®çš„åšæ³•åº”è¯¥æ˜¯ä¸‹é¢è¿™æ · 1[[self.person mutableArrayValueForKey:@&quot;dateArray&quot;] addObject:@&quot;hello&quot;]; ä¸‰ã€KVO åº•å±‚åŸç†â€”isa-swizzling3.1 å®˜æ–¹è§£é‡Š Key-Value Observing Programming Guideä¸­æœ‰ä¸€æ®µåº•å±‚å®ç°åŸç†çš„å™è¿° KVOæ˜¯ä½¿ç”¨isa-swizzlingæŠ€æœ¯å®ç°çš„ isaæŒ‡é’ˆæŒ‡å‘å¯¹è±¡çš„ç±» åœ¨ä¸ºå¯¹è±¡çš„å±æ€§æ³¨å†Œè§‚å¯Ÿè€…æ—¶ï¼Œå°†ä¿®æ”¹è§‚å¯Ÿå¯¹è±¡çš„isaæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸­é—´ç±»è€Œä¸æ˜¯çœŸå®ç±»ã€‚æ‰€ä»¥isaæŒ‡é’ˆçš„å€¼ä¸ä¸€å®šåæ˜ å¯¹è±¡çš„å®é™…ç±»ã€‚ æ‚¨æ°¸è¿œä¸åº”ä¾é isaæŒ‡é’ˆæ¥ç¡®å®šç±»æˆå‘˜èº«ä»½ã€‚ç›¸åï¼Œæ‚¨åº”è¯¥ä½¿ç”¨classæ–¹æ³•æ¥ç¡®å®šå¯¹è±¡å®ä¾‹çš„ç±» 3.2 ä»£ç æ¢ç´¢ æ³¨å†Œè§‚å¯Ÿè€…ä¹‹å‰ï¼šç±»å¯¹è±¡ä¸º FXPersonï¼Œå®ä¾‹å¯¹è±¡isaæŒ‡å‘FXPerson æ³¨å†Œè§‚å¯Ÿè€…ä¹‹åï¼šç±»å¯¹è±¡ä¸º FXPersonï¼Œå®ä¾‹å¯¹è±¡isaæŒ‡å‘NSKVONotifying_FXPerson ä»è¿™ä¸¤å›¾ä¸­å¯ä»¥å¾—å‡ºä¸€ä¸ªç»“è®ºï¼šè§‚å¯Ÿè€…æ³¨å†Œå‰åFXPersonç±»æ²¡å‘ç”Ÿå˜åŒ–ï¼Œä½†å®ä¾‹å¯¹è±¡çš„isaæŒ‡å‘å‘ç”Ÿäº†å˜åŒ– é‚£ä¹ˆè¿™ä¸ªåŠ¨æ€ç”Ÿæˆçš„ä¸­é—´ç±»NSKVONotifying_FXPersonå’ŒFXPersonæ˜¯ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ åœ¨æ³¨å†Œè§‚å¯Ÿè€…å‰ååˆ†åˆ«æ‰“å°å­ç±»â€”â€”å‘ç°NSKVONotifying_FXPersonæ˜¯FXPersonçš„å­ç±» 3.3 åŠ¨æ€å­ç±»æ¢ç´¢â‘ é¦–å…ˆå¾—æ˜ç™½åŠ¨æ€å­ç±»è§‚å¯Ÿçš„æ˜¯ä»€ä¹ˆï¼Ÿ ä¸‹é¢è§‚å¯Ÿå±æ€§å˜é‡nameå’Œæˆå‘˜å˜é‡nicknameæ¥æ‰¾åŒºåˆ«ï¼šä¸¤ä¸ªå˜é‡åŒæ—¶å‘ç”Ÿå˜åŒ–ï¼Œä½†åªæœ‰å±æ€§å˜é‡ç›‘å¬åˆ°å›è°ƒâ€”â€”è¯´æ˜åŠ¨æ€å­ç±»è§‚å¯Ÿçš„æ˜¯setteræ–¹æ³• â‘¡é€šè¿‡runtime-APIæ‰“å°ä¸€ä¸‹åŠ¨æ€å­ç±»å’Œè§‚å¯Ÿç±»çš„æ–¹æ³• 1234567891011- (void)printClassAllMethod:(Class)cls { unsigned int count = 0; Method *methodList = class_copyMethodList(cls, &amp;count); for (int i = 0; i&lt;count; i++) { Method method = methodList[i]; SEL sel = method_getName(method); IMP imp = class_getMethodImplementation(cls, sel); NSLog(@&quot;%@-%p&quot;,NSStringFromSelector(sel),imp); } free(methodList);} é€šè¿‡æ‰“å°å¯ä»¥çœ‹å‡ºï¼š FXPersonç±»ä¸­çš„æ–¹æ³•æ²¡æœ‰æ”¹å˜ï¼ˆimpå®ç°åœ°å€æ²¡æœ‰å˜åŒ–ï¼‰ NSKVONotifying_FXPersonç±»ä¸­é‡å†™äº†çˆ¶ç±»FXPersonçš„deallocæ–¹æ³• NSKVONotifying_FXPersonç±»ä¸­é‡å†™äº†åŸºç±»NSObjectçš„classæ–¹æ³•å’Œ_isKVOAæ–¹æ³• é‡å†™çš„classæ–¹æ³•å¯ä»¥æŒ‡å›FXPersonç±» NSKVONotifying_FXPersonç±»ä¸­é‡å†™äº†çˆ¶ç±»FXPersonçš„setNameæ–¹æ³• å› ä¸ºå­ç±»åªç»§æ‰¿ã€ä¸é‡å†™æ˜¯ä¸ä¼šæœ‰æ–¹æ³•impçš„ï¼ˆé‚£ä¹ˆè°ƒç”¨æ–¹æ³•æ—¶ä¼šé—®çˆ¶ç±»è¦æ–¹æ³•å®ç°ï¼‰ ä¸”ä¸¤ä¸ªsetNameçš„åœ°å€æŒ‡é’ˆä¸ä¸€æ · æ¯è§‚å¯Ÿä¸€ä¸ªå±æ€§å˜é‡å°±é‡å†™ä¸€ä¸ªsetteræ–¹æ³•ï¼ˆå¯è‡ªè¡Œè®ºè¯ï¼‰ â‘¢deallocä¹‹åisaæŒ‡å‘è°ï¼Ÿâ€”â€”æŒ‡å›åŸç±» â‘£deallocä¹‹ååŠ¨æ€å­ç±»ä¼šé”€æ¯å—ï¼Ÿâ€”â€”ä¸ä¼š é¡µé¢popåå†æ¬¡pushè¿›æ¥æ‰“å°FXPersonç±»çš„å­ç±»ï¼Œå­ç±»NSKVONotifying_FXPersonç±»ä¾æ—§å­˜åœ¨ â‘¤automaticallyNotifiesObserversForKeyæ˜¯å¦ä¼šå½±å“åŠ¨æ€å­ç±»ç”Ÿæˆâ€”â€”ä¼š åŠ¨æ€å­ç±»ä¼šæ ¹æ®è§‚å¯Ÿå±æ€§çš„automaticallyNotifiesObserversForKeyçš„å¸ƒå°”å€¼æ¥å†³å®šæ˜¯å¦ç”Ÿæˆ 3.4 æ€»ç»“ automaticallyNotifiesObserversForKeyä¸ºYESæ—¶æ³¨å†Œè§‚å¯Ÿå±æ€§ä¼šç”ŸæˆåŠ¨æ€å­ç±»NSKVONotifying_XXX åŠ¨æ€å­ç±»è§‚å¯Ÿçš„æ˜¯setteræ–¹æ³• åŠ¨æ€å­ç±»é‡å†™äº†è§‚å¯Ÿå±æ€§çš„setteræ–¹æ³•ã€deallocã€classã€_isKVOAæ–¹æ³• setteræ–¹æ³•ç”¨äºè§‚å¯Ÿé”®å€¼ deallocæ–¹æ³•ç”¨äºé‡Šæ”¾æ—¶å°†isaæŒ‡å‘åŸæ¥çš„ç±» classæ–¹æ³•ç”¨äºæŒ‡å›åŠ¨æ€å­ç±»çš„çˆ¶ç±» _isKVOAç”¨æ¥æ ‡è¯†æ˜¯å¦æ˜¯åœ¨è§‚å¯Ÿè€…çŠ¶æ€çš„ä¸€ä¸ªæ ‡å¿—ä½ deallocä¹‹åisaæŒ‡å‘åŸæ¥çš„ç±» deallocä¹‹ååŠ¨æ€å­ç±»ä¸ä¼šé”€æ¯ 3.5 åŸç†å›¾å‡è®¾æˆ‘ä»¬è¦è§‚å¯Ÿçš„æ˜¯ Person å®ä¾‹å¯¹è±¡çš„ age å±æ€§ã€‚ æ·»åŠ è§‚å¯Ÿè€…ä¹‹å‰ æ·»åŠ è§‚å¯Ÿè€…ä¹‹å å››ã€è‡ªå·±å®ç°KVOæˆ‘çš„å®Œæ•´ä»£ç å·²æ”¾åˆ° GitHubï¼šLinkğŸ”— 4.1 å‰è¨€ä¸‹é¢æˆ‘ä»¬æ ¹æ®ç³»ç»Ÿ KVO çš„åŸç†ï¼Œç®€å•å®ç°ä¸€ä¸‹ KVOã€‚ æ­¤è¿‡ç¨‹ä¸­ä¼šæœ‰ runtime-API çš„ä½¿ç”¨å’Œæ¥å£è®¾è®¡æ€è·¯çš„è®²è§£ï¼Œæœ€ç»ˆçš„è‡ªå®šä¹‰ KVO èƒ½æ»¡è¶³åŸºæœ¬ä½¿ç”¨çš„éœ€æ±‚ä½†ä»ä¸å®Œå–„ï¼Œä½†æ­¤è¿‡ç¨‹ä¸­æœ€é‡è¦çš„æ˜¯äº†è§£å¹¶æ¨¡ä»¿ç³»ç»Ÿå®ç°åŸç†ï¼Œä»¥åŠåŠ æ·±å¯¹ runtime çš„ç†è§£ã€‚ ç³»ç»Ÿçš„ KVO æ³¨å†Œã€å›è°ƒã€è‡ªåŠ¨ç§»é™¤è§‚å¯Ÿè€…åœ¨å†™æ³•ä¸Šéƒ½æ˜¯åˆ†ç¦»çš„ï¼Œä½¿ç”¨èµ·æ¥ç¨æ˜¾ä¸ç®€æ´ï¼Œæ‰€ä»¥æˆ‘ä»¬è‡ªå®šä¹‰çš„ KVO å°†ä½¿ç”¨ block å›è°ƒå’Œè‡ªåŠ¨é‡Šæ”¾æ¥ä¼˜åŒ–è¿™ä¸€ç‚¹ä¸è¶³ã€‚ è‡ªå®šä¹‰ KVO çš„ä¼˜åŒ–å…¶å®æ˜¯å‚è€ƒäº† FBKVOController çš„å®ç°ï¼Œä½† FBKVOController æ˜¯é€šè¿‡ä¸­é—´å±‚å¯¹ç›¸åº”å±æ€§è¿›è¡Œè§‚å¯Ÿï¼Œç„¶åå›è°ƒåˆ°è§‚å¯Ÿè€…ï¼Œå…¶åœ¨å†…å­˜ç®¡ç†ä¸Šæ›´åŠ å®‰å…¨ï¼›æˆ‘ä»¬çš„è‡ªå®šä¹‰ KVO æ˜¯ç›´æ¥è¿›è¡Œè§‚å¯Ÿï¼Œé€»è¾‘ä¸Šæ›´ç®€å•æ˜“æ‡‚ã€‚ é¦–å…ˆå›é¡¾ç³»ç»Ÿ KVO çš„é€»è¾‘ï¼š 1.automaticallyNotifiesObserversForKeyä¸ºYESæ—¶ï¼Œæ³¨å†Œè§‚å¯Ÿå±æ€§ä¼šç”ŸæˆåŠ¨æ€å­ç±»NSKVONotifying_XXX 2.åŠ¨æ€å­ç±»è§‚å¯Ÿçš„æ˜¯å¯¹åº”å±æ€§çš„setteræ–¹æ³• 3.åŠ¨æ€å­ç±»é‡å†™äº†è§‚å¯Ÿå±æ€§çš„setteræ–¹æ³•ã€deallocã€classã€_isKVOAæ–¹æ³• setteræ–¹æ³•ç”¨äºè§‚å¯Ÿé”®å€¼ deallocæ–¹æ³•ç”¨äºé‡Šæ”¾æ—¶å°†isaæŒ‡å‘åŸæ¥çš„ç±» classæ–¹æ³•ç”¨äºæŒ‡å›åŠ¨æ€å­ç±»çš„çˆ¶ç±» _isKVOAç”¨æ¥æ ‡è¯†æ˜¯å¦æ˜¯åœ¨è§‚å¯Ÿè€…çŠ¶æ€çš„ä¸€ä¸ªæ ‡å¿—ä½ã€è¿™ä¸ªæ²¡å®ç°ã€‘ 4.deallocä¹‹åisaæŒ‡å‘åŸæ¥çš„ç±» 5.deallocä¹‹ååŠ¨æ€å­ç±»ä¸ä¼šé”€æ¯ 4.2 åˆå§‹åŒ–åˆ›å»ºNSObjectçš„åˆ†ç±»ï¼šNSObject+JYKVOï¼Œæä¾›æ·»åŠ è§‚å¯Ÿè€…çš„æ¥å£ï¼š 1234567891011121314151617#import &lt;Foundation/Foundation.h&gt;NS_ASSUME_NONNULL_BEGINtypedef void(^JYKVOBlock)(id observer, NSString *keyPath, id oldValue,id newValue);@interface NSObject (JYKVO)/// å¯¹å±æ€§æ·»åŠ è§‚å¯Ÿ/// @param observer è§‚å¯Ÿè€…/// @param keyPath è§‚å¯Ÿçš„å±æ€§/// @param block å±æ€§æ”¹å˜åçš„å›è°ƒ- (void)jy_addObserver:(NSObject *)observer forKeyPath:(NSString *)keyPath block:(JYKVOBlock)block;@endNS_ASSUME_NONNULL_END ä¸‹é¢å¼€å§‹å®ç°jy_addObserver:forKeyPath:block:æ–¹æ³•ï¼š 4.3 éªŒè¯æ˜¯å¦å­˜åœ¨setteræ–¹æ³•ï¼Œåªè§‚å¯Ÿå±æ€§12// åˆ¤æ–­æ˜¯å¦æœ‰å¯¹åº”çš„ setter if (![self isContainSetterMethodFromKeyPath:keyPath]) return; isContainSetterMethodFromKeyPath:æ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼š 123456789101112/// åˆ¤æ–­æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ setter/// @param keyPath å±æ€§å- (BOOL)isContainSetterMethodFromKeyPath:(NSString *)keyPath { Class class = object_getClass(self); SEL setterSeletor = NSSelectorFromString(setterForKeyPath(keyPath)); Method setterMethod = class_getInstanceMethod(class, setterSeletor); if (!setterMethod) { NSLog(@&quot;æ²¡æ‰¾åˆ°å±æ€§:%@çš„setteræ–¹æ³•&quot;, keyPath); return NO; } return YES;} 4.4 åˆ¤æ–­automaticallyNotifiesObserversForKeyæ–¹æ³•è¿”å›çš„å¸ƒå°”å€¼12BOOL isAutomatically = [self jy_performSelectorWithMethodName:@&quot;automaticallyNotifiesObserversForKey:&quot; keyPath:keyPath];if (!isAutomatically) return; ä¸ºYESæ—¶æ‰ä¼šç»§ç»­ 4.5 åŠ¨æ€ç”Ÿæˆå­ç±»12// åŠ¨æ€ç”Ÿæˆå­ç±»Class newClass = [self createChildClassWithKeyPath:keyPath]; createChildClassWithKeyPath:æ–¹æ³•æ˜¯æˆ‘ä»¬çš„æ ¸å¿ƒæ–¹æ³•ï¼Œåˆ†æ­¥æ¥çœ‹ï¼š â‘´ æ ¹æ® keyPath æ‹¼æ¥ä¸­é—´ç±»çš„åç§°ï¼Œç„¶åå¦‚æœä¸å­˜åœ¨ä¸­é—´ç±»çš„è¯ï¼Œå°±åˆ›å»ºï¼Œå¦‚æœå·²ç»å­˜åœ¨ï¼Œä¸éœ€è¦é‡å¤åˆ›å»º 123456789101112131415161718// è·å–æ–°ç±»çš„ç±»å NSString *oldClassName = NSStringFromClass([self class]); NSString *newClassName = [NSString stringWithFormat:@&quot;%@%@&quot;, kJYKVOPrefix, oldClassName]; Class newClass = NSClassFromString(newClassName); // é˜²æ­¢é‡å¤åˆ›å»ºæ–°ç±» if (newClass) return newClass; /** * ç”³è¯·ç±» * å¦‚æœå†…å­˜ä¸­ä¸å­˜åœ¨, åˆ›å»ºç”Ÿæˆ * å‚æ•°ä¸€: çˆ¶ç±» * å‚æ•°äºŒ: æ–°ç±»çš„åå­— * å‚æ•°ä¸‰: æ–°ç±»çš„å¼€è¾Ÿçš„é¢å¤–ç©ºé—´ */ newClass = objc_allocateClassPair([self class], newClassName.UTF8String, 0); // æ³¨å†Œç±» objc_registerClassPair(newClass); â‘µ æ·»åŠ +classæ–¹æ³• 12345// æ·»åŠ  +class æ–¹æ³•SEL classSEL = NSSelectorFromString(@&quot;class&quot;);Method classMethod = class_getInstanceMethod([self class], classSEL);const char *classTypes = method_getTypeEncoding(classMethod);class_addMethod(newClass, classSEL, (IMP)jy_class, classTypes); â‘¶ æ·»åŠ å¯¹åº”å±æ€§çš„setteræ–¹æ³• 12345// æ·»åŠ  setterSEL setterSEL = NSSelectorFromString(setterForKeyPath(keyPath));Method setterMethod = class_getInstanceMethod([self class], setterSEL);const char *setterTypes = method_getTypeEncoding(setterMethod);class_addMethod(newClass, setterSEL, (IMP)jy_setter, setterTypes); å…¶ä¸­jy_setteræ˜¯æˆ‘ä»¬è‡ªå·±å¯¹setteræ–¹æ³•çš„å®ç°ï¼Œæ€è·¯å¦‚ä¸‹ï¼š â‘  å› ä¸ºæˆ‘ä»¬ä½¿ç”¨KVOæ—¶å€™ï¼Œæ˜¯å¯¹æ“ä½œçš„ç±»(ä¾‹å¦‚ LGPerson)çš„å±æ€§èµ‹å€¼ï¼Œè¿™é‡Œå› ä¸ºå°† isa æŒ‡å‘äº†æ–°åˆ›å»ºçš„ä¸­é—´å­ç±»(NSKVONotifying_LGPerson)ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦è°ƒç”¨çˆ¶ç±»(LGPerson)çš„setter æ–¹æ³•è¿›è¡Œå±æ€§èµ‹å€¼ã€‚æˆ‘ä»¬è¿™é‡Œé€šè¿‡objc_msgSendSuperå‘é€æ¶ˆæ¯æ¥å®ç°ã€‚ 1234567// 1ï¸âƒ£è½¬å‘ç»™çˆ¶ç±»ï¼Œæ”¹å˜çˆ¶ç±»çš„å€¼void (*jy_msgSendSuper)(void *, SEL, id) = (void *)objc_msgSendSuper;struct objc_super superStruct = { .receiver = self, .super_class = class_getSuperclass(object_getClass(self)),};jy_msgSendSuper(&amp;superStruct, _cmd, newValue); â‘¡ å–åŸæ¥çš„å€¼ï¼Œç”¨äºå›è°ƒ 123// 2ï¸âƒ£å–æ—§å€¼NSString *keyPath = getterForSetter(NSStringFromSelector(_cmd));id oldValue = [self valueForKey:keyPath]; â‘¢ å±æ€§æ”¹å˜åæˆ‘ä»¬è¿˜éœ€è¦é€šè¿‡ block çš„æ–¹å¼å›è°ƒåˆ°æ·»åŠ è§‚å¯Ÿçš„åœ°æ–¹ 12345678910// 3ï¸âƒ£é€šçŸ¥è§‚å¯Ÿè€…// 1.æ‹¿åˆ°è§‚å¯Ÿè€…ï¼Œåœ¨æ·»åŠ è§‚å¯Ÿè€…çš„æ—¶å€™é€šè¿‡å…³è”å¯¹è±¡å°† observer å­˜å‚¨äº†èµ·æ¥ã€‚NSMutableArray *mArray = objc_getAssociatedObject(self, (__bridge const void * _Nonnull)(kJYKVOAssiociateKey));// 2.æ¶ˆæ¯å‘é€ç»™è§‚å¯Ÿè€…for (JYKVOInfo *info in mArray) { if ([info.keyPath isEqualToString:keyPath] &amp;&amp; info.handleBlock) { info.handleBlock(info.observer, keyPath, oldValue, newValue); }} â‘· ç„¶åä¸ºäº†å®ç°è‡ªåŠ¨ç§»é™¤è§‚å¯Ÿè€…ï¼Œæˆ‘ä»¬è¿˜è¦äº¤æ¢ä¸€ä¸‹ dealloc æ–¹æ³•çš„å®ç°ï¼Œåœ¨é‡Œé¢åšä¸€äº›äº‹æƒ… 12345// äº¤æ¢ dealloc å®ç°static dispatch_once_t onceToken;dispatch_once(&amp;onceToken, ^{ [self JYMethodSwizzlingWithClass:[self class] oriSEL:NSSelectorFromString(@&quot;dealloc&quot;) swizzledSEL:@selector(jy_dealloc)];}); 123456// å½“å¯¹è±¡é”€æ¯çš„æ—¶å€™ä¼šè°ƒç”¨ deallocï¼Œåœ¨è¯¥æ–¹æ³•ä¸­å°† isa æŒ‡é’ˆé‡æ–°æŒ‡å‘åŸæ¥çš„ç±»- (void)jy_dealloc { Class superClass = [self class]; object_setClass(self, superClass); [self jy_dealloc];} 4.6 å°†isaæŒ‡å‘åˆ›å»ºå¥½çš„åŠ¨æ€å­ç±»12// isaæŒ‡å‘ä¿®æ”¹-&gt;æŒ‡å‘åŠ¨æ€å­ç±»object_setClass(self, newClass); 4.7 ä¿å­˜observerä¿¡æ¯ï¼Œåœ¨setteræ–¹æ³•ä¸­é€šçŸ¥observerçš„æ—¶å€™éœ€è¦ç”¨åˆ°è¯¥ä¿¡æ¯12345678// ä¿å­˜ä¿¡æ¯JYKVOInfo *info = [[JYKVOInfo alloc] initWitObserver:observer forKeyPath:keyPath handleBlock:block];NSMutableArray *mArray = objc_getAssociatedObject(self, (__bridge const void * _Nonnull)(kJYKVOAssiociateKey));if (!mArray) { mArray = [NSMutableArray arrayWithCapacity:1]; objc_setAssociatedObject(self, (__bridge const void * _Nonnull)(kJYKVOAssiociateKey), mArray, OBJC_ASSOCIATION_RETAIN_NONATOMIC);}[mArray addObject:info]; å…¶ä¸­ä½¿ç”¨JYKVOInfoè¿™ä¸ªmodelæ¥å­˜å‚¨observerä¿¡æ¯ï¼Œå› ä¸ºå¯èƒ½ä¼šè¿˜æœ‰å¤šä¸ªobserverï¼Œæ‰€ä»¥ä½¿ç”¨æ•°ç»„çš„å½¢å¼è¿›è¡Œå­˜å‚¨ã€‚ ç°åœ¨å¯ä»¥ç»™ä¸€ä¸ªå±æ€§æ·»åŠ è§‚å¯Ÿæµ‹è¯•ä¸€ä¸‹äº†ã€‚ 4.8 æµ‹è¯•ä¾æ—§æ˜¯Personç±»ï¼Œæœ‰ä¸€ä¸ªç®€å•çš„nameæˆå‘˜å±æ€§ã€‚ ä¸‹é¢åœ¨æ§åˆ¶å™¨ä¸­æ·»åŠ å¯¹nameå±æ€§çš„è§‚å¯Ÿï¼š 12345678self.person = [Person new];self.person.name = @&quot;æ—§åå­—&quot;;[self.person jy_addObserver:self forKeyPath:@&quot;name&quot; block:^(id _Nonnull observer, NSString * _Nonnull keyPath, id _Nonnull oldValue, id _Nonnull newValue) { NSLog(@&quot;æ—§å€¼ï¼š%@&quot;, oldValue); NSLog(@&quot;æ–°å€¼ï¼š%@&quot;, newValue); NSLog(@&quot;pathï¼š%@&quot;, keyPath);}]; ç‚¹å‡»å±å¹•çš„æ—¶å€™å»æ”¹å˜è¿™ä¸ªå¯¹è±¡çš„nameçš„å€¼ï¼š 123- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event { self.person.name = @&quot;æ–°åå­—&quot;;} ç„¶åå°† demo è¿è¡Œï¼Œç‚¹å‡»è¿™ä¸ªæ§åˆ¶å™¨ï¼ŒæŸ¥çœ‹æ‰“å°ï¼š 1232021-03-30 14:48:14.483797+0800 OCTest[13317:272742] æ—§å€¼ï¼šæ—§åå­—2021-03-30 14:48:14.483927+0800 OCTest[13317:272742] æ–°å€¼ï¼šæ–°åå­—2021-03-30 14:48:14.483983+0800 OCTest[13317:272742] pathï¼šname è‡³æ­¤å°±å®Œæˆäº† KVO çš„ç®€å•å®ç°ã€‚ PSè‹¹æœå¼€å‘æ–‡æ¡£- KVO åŸç†çš„ä»‹ç» FBKVOController æˆ‘çš„å®Œæ•´ä»£ç  å‚è€ƒfacebookarchive/KVOController KVOåŸç†åˆ†æ iOSæ¢ç´¢ KVOåŸç†åŠè‡ªå®šä¹‰ è‡ªå®šä¹‰KVO","link":"/2021/03/26/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/14-KVO%E5%8E%9F%E7%90%86/"},{"title":"06-åŠ¨æ€æ–¹æ³•è§£æå’Œæ¶ˆæ¯è½¬å‘æœºåˆ¶","text":"å‰è¨€OCä¸­æ–¹æ³•çš„è°ƒç”¨æ˜¯é€šè¿‡objc_msgSendï¼ˆæˆ–objc_msgSendSuperï¼Œæˆ–objc_msgSend_stretï¼Œæˆ–objc_msgSendSuper_stretï¼‰å‡½æ•°ï¼Œå‘è°ƒç”¨è€…å‘é€åä¸ºSELçš„æ¶ˆæ¯ï¼Œæ‰¾åˆ°å…·ä½“çš„å‡½æ•°åœ°å€IMPï¼Œè¿›è€Œæ‰§è¡Œè¯¥å‡½æ•°ã€‚ æ‰¾IMPæ—¶å…ˆå¿«é€ŸæŸ¥æ‰¾ï¼Œç„¶åæ…¢é€ŸæŸ¥æ‰¾ã€‚å¦‚æœæ…¢é€ŸæŸ¥æ‰¾åæ‰¾ä¸åˆ°IMPï¼Œä¼šè¿›è¡Œæ–¹æ³•çš„è§£æï¼Œè¿™ç›¸å½“äºæä¾›ä¸€æ¬¡å®¹é”™å¤„ç†ï¼›æ–¹æ³•è§£æä¹‹åï¼Œå¦‚æœä¾ç„¶æ‰¾ä¸åˆ°IMPï¼Œè¿˜æœ‰æœ€åä¸€æ¬¡æœºä¼šï¼Œé‚£å°±æ˜¯æ¶ˆæ¯çš„è½¬å‘ã€‚ æˆ‘ç”¨çš„æºç æ˜¯ objc4-756.2 ä¸€ã€æ¶ˆæ¯æŸ¥æ‰¾æµç¨‹æ¶ˆæ¯æŸ¥æ‰¾æµç¨‹éƒ¨åˆ†ä¸å†å±•å¼€è¯¦è¿°ï¼Œæ¶ˆæ¯æ…¢é€ŸæŸ¥æ‰¾ä¸»è¦ç»è¿‡ä»¥ä¸‹æµç¨‹ï¼š å…ˆæŸ¥æ‰¾æœ¬ç±»ç¼“å­˜ï¼Œå†æ‰¾æœ¬ç±»æ–¹æ³•åˆ—è¡¨ éå†çˆ¶ç±»ï¼šæŸ¥æ‰¾çˆ¶ç±»ç¼“å­˜ï¼Œå†æ‰¾çˆ¶ç±»æ–¹æ³•åˆ—è¡¨ éå†çˆ¶ç±»æ— æœåå°±æ¥åˆ°åŠ¨æ€æ–¹æ³•è§£æã€‚ äºŒã€åŠ¨æ€æ–¹æ³•è§£æåŠ¨æ€æ–¹æ³•è§£æï¼Œå³method resolverï¼ˆåˆåæ¶ˆæ¯çš„è§£æï¼Œä¹Ÿå«æ–¹æ³•å†³è®®ï¼‰ï¼Œæ–¹æ³•æŸ¥æ‰¾å¤±è´¥ä¹‹åå°±ä¼šè¿›è¡Œï¼Œæºç å¦‚ä¸‹ï¼š 12345678910// åœ¨ã€ç±»...æ ¹ç±»ã€‘çš„ã€ç¼“å­˜+æ–¹æ³•åˆ—è¡¨ã€‘ä¸­éƒ½æ²¡æ‰¾åˆ°IMPï¼Œè¿›è¡Œæ–¹æ³•è§£æif (resolver &amp;&amp; !triedResolver) { runtimeLock.unlock(); resolveMethod(cls, sel, inst); // âœ… runtimeLock.lock(); // Don't cache the result; we don't hold the lock so it may have // changed already. Re-do the search from scratch instead. triedResolver = YES; goto retry;} å®ƒä¸»è¦æ˜¯è°ƒç”¨äº†resolveMethodå‡½æ•°ã€‚resolveMethodå‡½æ•°å¤„ç†å®Œæ¯•ä¹‹åï¼Œè¿˜è¦é‡æ–°æ‰§è¡Œä¸€æ¬¡retryï¼ˆå†èµ°ä¸€éæ–¹æ³•çš„æŸ¥æ‰¾æµç¨‹ï¼‰ã€‚å…¶ä¸­ï¼ŒtriedResolverè¿™ä¸ªå˜é‡ä½¿å¾—æ¶ˆæ¯çš„è§£æåªè¿›è¡Œä¸€æ¬¡ã€‚ 2.1 resolveMethod å…¥å£æºç ï¼š 1234567891011121314151617181920212223static void resolveMethod(Class cls, SEL sel, id inst){ runtimeLock.assertUnlocked(); assert(cls-&gt;isRealized()); // åˆ¤æ–­å½“å‰æ˜¯å¦æ˜¯å…ƒç±» if (! cls-&gt;isMetaClass()) { // ç±»ï¼Œå°è¯•æ‰¾å®ä¾‹æ–¹æ³• // try [cls resolveInstanceMethod:sel] resolveInstanceMethod(cls, sel, inst); } else { // æ˜¯å…ƒç±»ï¼Œå…ˆæ‰¾ç±»æ–¹æ³• // try [nonMetaClass resolveClassMethod:sel] // and [cls resolveInstanceMethod:sel] resolveClassMethod(cls, sel, inst); if (!lookUpImpOrNil(cls, sel, inst, NO/*initialize*/, YES/*cache*/, NO/*resolver*/)) { resolveInstanceMethod(cls, sel, inst); } }} è¿™é‡Œæœ‰ä¸¤ä¸ªåˆ†æ”¯ï¼š éå…ƒç±»çš„è¯è¯´æ˜æ˜¯ç±»ï¼Œè°ƒç”¨å®ä¾‹æ–¹æ³•ï¼Œèµ°_class_resolveInstanceMethod clsæ˜¯å…ƒç±»çš„è¯è¯´æ˜è°ƒç”¨ç±»æ–¹æ³•ï¼Œèµ°_class_resolveClassMethod 2.2 å®ä¾‹æ–¹æ³•è§£æresolveInstanceMethodæºç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445static void resolveInstanceMethod(Class cls, SEL sel, id inst){ runtimeLock.assertUnlocked(); assert(cls-&gt;isRealized()); // å» cls æ‰¾æ˜¯å¦å®ç°äº† resolveInstanceMethod æ–¹æ³• // å¦‚æœæ²¡æœ‰å®ç°ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œå°±ä¸ä¼šç»™ cls å‘é€ resolveInstanceMethod æ¶ˆæ¯ï¼Œå°±ä¸ä¼šæŠ¥æ‰¾ä¸åˆ° resolveInstanceMethod if (! lookUpImpOrNil(cls-&gt;ISA(), SEL_resolveInstanceMethod, cls, NO/*initialize*/, YES/*cache*/, NO/*resolver*/)) { // Resolver not implemented. // NSObjectä¸­é»˜è®¤æœ‰å®ç°ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸ä¼šèµ°è¿™é‡Œã€‚ return; } // æœ¬ç±»å®ç°äº†ç±»æ–¹æ³• resolveInstanceMethod // å½“å¯¹è±¡æ‰¾ä¸åˆ°éœ€è¦è°ƒç”¨çš„æ–¹æ³•æ—¶ï¼Œç³»ç»Ÿå°±ä¼šä¸»åŠ¨å“åº” resolveInstanceMethod æ–¹æ³•ï¼Œå¯ä»¥åœ¨ resolveInstanceMethod è¿›è¡Œè‡ªå®šä¹‰å¤„ç† // å‘æœ¬ç±»å‘é€SEL_resolveInstanceMethodæ¶ˆæ¯ï¼Œå³è°ƒç”¨è¿™ä¸ªæ–¹æ³• BOOL (*msg)(Class, SEL, SEL) = (typeof(msg))objc_msgSend; bool resolved = msg(cls, SEL_resolveInstanceMethod, sel); // Cache the result (good or bad) so the resolver doesn't fire next time. // +resolveInstanceMethod adds to self a.k.a. cls // å†æ¬¡å»æŸ¥æ‰¾æ–¹æ³•ï¼Œæ‰¾åˆ°å°±ç¼“å­˜å¹¶ä¸”è¿”å›ï¼Œæ‰¾ä¸åˆ°å°±ç›´æ¥è¿”å› IMP imp = lookUpImpOrNil(cls, sel, inst, NO/*initialize*/, YES/*cache*/, NO/*resolver*/); // ä¸€äº›æŠ¥é”™ä¿¡æ¯ä»£ç  if (resolved &amp;&amp; PrintResolving) { if (imp) { _objc_inform(&quot;RESOLVE: method %c[%s %s] &quot; &quot;dynamically resolved to %p&quot;, cls-&gt;isMetaClass() ? '+' : '-', cls-&gt;nameForLogging(), sel_getName(sel), imp); } else { // Method resolver didn't add anything? _objc_inform(&quot;RESOLVE: +[%s resolveInstanceMethod:%s] returned YES&quot; &quot;, but no new implementation of %c[%s %s] was found&quot;, cls-&gt;nameForLogging(), sel_getName(sel), cls-&gt;isMetaClass() ? '+' : '-', cls-&gt;nameForLogging(), sel_getName(sel)); } }} æµç¨‹åˆ†æï¼š â‘ è°ƒç”¨lookUpImpOrNilæ–¹æ³•æ£€æŸ¥clsä¸­æ˜¯å¦æœ‰SEL_resolveInstanceMethod(resolveInstanceMethod)æ–¹æ³•ã€‚NSObjectç±»ä¸­æœ‰å®ç°è¿™ä¸ªç±»æ–¹æ³•ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¼šæ¥ç€å¾€ä¸‹èµ°ã€‚ lookUpImpOrNilå‡½æ•°æºç ï¼š 1234567IMP lookUpImpOrNil(Class cls, SEL sel, id inst, bool initialize, bool cache, bool resolver){ IMP imp = lookUpImpOrForward(cls, sel, inst, initialize, cache, resolver); if (imp == _objc_msgForward_impcache) return nil; else return imp;} NSObjectç±»ä¸­å®ç°äº†resolveInstanceMethodæ–¹æ³•ï¼š 12345678// å…·ä½“æœç´¢ NSObject.mm+ (BOOL)resolveClassMethod:(SEL)sel { return NO;}+ (BOOL)resolveInstanceMethod:(SEL)sel { return NO;} â‘¡å‘æœ¬ç±»å‘é€SEL_resolveInstanceMethodæ¶ˆæ¯ï¼Œå³è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚resolveInstanceMethod æ˜¯ç³»ç»Ÿç»™æˆ‘ä»¬çš„ä¸€æ¬¡æœºä¼šï¼Œè®©æˆ‘ä»¬å¯ä»¥é’ˆå¯¹æ²¡æœ‰å®ç°çš„ sel è¿›è¡Œè‡ªå®šä¹‰æ“ä½œã€‚ â‘¢lookUpImpOrNilå†æ¬¡æŸ¥æ‰¾å½“å‰å®ä¾‹æ–¹æ³•IMPï¼Œæ‰¾åˆ°å°±ç¼“å­˜å¹¶è¿”å›ï¼Œæ‰¾ä¸åˆ°å°±ç›´æ¥è¿”å›ã€‚ å‡å¦‚ä½ åœ¨+(BOOL)resolveInstanceMethod:(SEL)selä¸­æ·»åŠ äº†selçš„å‡½æ•°åœ°å€IMPï¼Œæ­¤æ—¶å†æ¬¡å»æŸ¥æ‰¾è¿™ä¸ªIMPå°±èƒ½æ‰¾åˆ°ã€‚ æ³¨æ„åˆ°ä¸¤æ¬¡è°ƒç”¨lookUpImpOrNilä¸­ï¼Œresolveréƒ½æ˜¯NOï¼Œå› æ­¤åœ¨å…¶è°ƒç”¨lookUpImpOrForwardæ—¶ä¸ä¼šè§¦å‘ åŠ¨æ€æ–¹æ³•è§£æï¼Œä»…ä»…æ˜¯ä»â€œç±»ã€çˆ¶ç±»ã€â€¦ã€æ ¹ç±»â€çš„ç¼“å­˜ä¸­å’Œæ–¹æ³•åˆ—è¡¨ä¸­æ‰¾IMPã€‚ â‘£ç»“æŸåŠ¨æ€æ–¹æ³•è§£æï¼Œå›åˆ°lookUpImpOrForwardæ–¹æ³•å°†triedResolverç½®YESå¹¶goto retryé‡æ–°æŸ¥æ‰¾ç¼“å­˜å’Œæ–¹æ³•åˆ—è¡¨ å®ä¾‹æ–¹æ³•è§£ææµç¨‹å›¾ï¼š 2.3 ç±»æ–¹æ³•è§£æresolveClassMethod å’Œ resolveInstanceMethod é€»è¾‘å·®ä¸å¤šï¼Œåªä¸è¿‡ç±»æ–¹æ³•æ˜¯å»å…ƒç±»é‡Œå¤„ç†ï¼Œæºç ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556// è¿™é‡Œçš„clsæ˜¯å…ƒç±»ï¼Œå› ä¸ºç±»æ–¹æ³•å­˜å‚¨åœ¨å…ƒç±»static void resolveClassMethod(Class cls, SEL sel, id inst){ runtimeLock.assertUnlocked(); assert(cls-&gt;isRealized()); assert(cls-&gt;isMetaClass()); if (! lookUpImpOrNil(cls, SEL_resolveClassMethod, inst, NO/*initialize*/, YES/*cache*/, NO/*resolver*/)) { // Resolver not implemented. // å¦‚æœä½ æ²¡æœ‰å®ç°ç±»æ–¹æ³• +(BOOL)resolveClassMethod:(SEL)selï¼Œ // NSObjectä¸­ä¹Ÿæœ‰å®ç°ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸ä¼šèµ°è¿™é‡Œ // æ³¨æ„è¿™é‡Œçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯clsï¼Œæ˜¯å…ƒç±» return; } Class nonmeta; { mutex_locker_t lock(runtimeLock); // è·å– å…ƒç±»çš„å¯¹è±¡ï¼Œå³ç±»ã€‚ nonmeta = getMaybeUnrealizedNonMetaClass(cls, inst); // +initialize path should have realized nonmeta already if (!nonmeta-&gt;isRealized()) { _objc_fatal(&quot;nonmeta class %s (%p) unexpectedly not realized&quot;, nonmeta-&gt;nameForLogging(), nonmeta); } } BOOL (*msg)(Class, SEL, SEL) = (typeof(msg))objc_msgSend; // è°ƒç”¨ç±»æ–¹æ³•ï¼š +(BOOL)resolveClassMethod:(SEL)sel bool resolved = msg(nonmeta, SEL_resolveClassMethod, sel); // Cache the result (good or bad) so the resolver doesn't fire next time. // +resolveClassMethod adds to self-&gt;ISA() a.k.a. cls // å†æ‰¾ä¸€æ¬¡imp IMP imp = lookUpImpOrNil(cls, sel, inst, NO/*initialize*/, YES/*cache*/, NO/*resolver*/); // ä¸€äº›æ‰“å° if (resolved &amp;&amp; PrintResolving) { if (imp) { _objc_inform(&quot;RESOLVE: method %c[%s %s] &quot; &quot;dynamically resolved to %p&quot;, cls-&gt;isMetaClass() ? '+' : '-', cls-&gt;nameForLogging(), sel_getName(sel), imp); } else { // Method resolver didn't add anything? _objc_inform(&quot;RESOLVE: +[%s resolveClassMethod:%s] returned YES&quot; &quot;, but no new implementation of %c[%s %s] was found&quot;, cls-&gt;nameForLogging(), sel_getName(sel), cls-&gt;isMetaClass() ? '+' : '-', cls-&gt;nameForLogging(), sel_getName(sel)); } }} æµç¨‹å¦‚ä¸‹ï¼š â‘ lookUpImpOrNilæŸ¥æ‰¾SEL_resolveClassMethod(resolveClassMethod)æ˜¯å¦å®ç° â‘¡è°ƒç”¨ç±»æ–¹æ³•ï¼š +(BOOL)resolveClassMethod:(SEL)sel â‘¢lookUpImpOrNilå†æ¬¡æŸ¥æ‰¾å½“å‰å®ä¾‹æ–¹æ³•impï¼Œæ‰¾åˆ°å°±å¡«å……ç¼“å­˜å¹¶è¿”å›ï¼Œæ‰¾ä¸åˆ°å°±ç›´æ¥è¿”å› â‘£ç»“æŸresolveClassMethodï¼Œè¿”å›åˆ°resolveMethodæ–¹æ³•ã€‚æ­¤æ—¶lookUpImpOrNilå†æ¬¡æŸ¥æ‰¾selçš„impï¼Œè‹¥æœ‰impåˆ™é€€å‡ºåŠ¨æ€æ–¹æ³•è§£æï¼Œè‹¥æ— åˆ™è¿›å…¥_class_resolveInstanceMethodå¼€å§‹å®ä¾‹æ–¹æ³•è§£æï¼Œè·Ÿä¹‹å‰çš„æµç¨‹ä¸€æ ·ã€‚ â‘¤ æ£€æŸ¥clsä¸­æ˜¯å¦æœ‰SEL_resolveInstanceMethod(resolveInstanceMethod)æ–¹æ³• â‘¥å‘æœ¬ç±»å‘é€SEL_resolveInstanceMethodæ¶ˆæ¯ â‘¦lookUpImpOrNilå†æ¬¡æŸ¥æ‰¾å½“å‰å®ä¾‹æ–¹æ³•IMPï¼Œæ‰¾åˆ°å°±ç¼“å­˜å¹¶è¿”å›ï¼Œæ‰¾ä¸åˆ°å°±ç›´æ¥è¿”å›ã€‚ â‘§ç»“æŸåŠ¨æ€æ–¹æ³•è§£æï¼Œå›åˆ°lookUpImpOrForwardæ–¹æ³•å°†triedResolverç½®å¦å¹¶goto retryé‡æ–°æŸ¥æ‰¾ç¼“å­˜å’Œæ–¹æ³•åˆ—è¡¨ ç±»æ–¹æ³•è§£ææµç¨‹å›¾ï¼š 2.4 åŠ¨æ€æ–¹æ³•å†³è®®resolveMethodä¸­è¿›è¡Œç±»æ–¹æ³•è§£æä¹‹åè¿˜è¦åœ¨è¿›è¡Œä¸€æ¬¡å®ä¾‹æ–¹æ³•è§£æï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ 123456789101112131415161718192021222324static void resolveMethod(Class cls, SEL sel, id inst){ runtimeLock.assertUnlocked(); assert(cls-&gt;isRealized()); // åˆ¤æ–­å½“å‰æ˜¯å¦æ˜¯å…ƒç±» if (! cls-&gt;isMetaClass()) { // ç±»ï¼Œå°è¯•æ‰¾å®ä¾‹æ–¹æ³• // try [cls resolveInstanceMethod:sel] resolveInstanceMethod(cls, sel, inst); } else { // æ˜¯å…ƒç±»ï¼Œå…ˆæ‰¾ç±»æ–¹æ³• // try [nonMetaClass resolveClassMethod:sel] // and [cls resolveInstanceMethod:sel] resolveClassMethod(cls, sel, inst); if (!lookUpImpOrNil(cls, sel, inst, NO/*initialize*/, YES/*cache*/, NO/*resolver*/)) { // âœ…ä¸ºä»€ä¹ˆè¿™é‡Œè¿˜è¦æŸ¥æ‰¾ä¸€æ¬¡å‘¢ï¼Ÿ resolveInstanceMethod(cls, sel, inst); } }} æ—¢ç„¶ä¸Šé¢çš„å¯¹è±¡æ–¹æ³•å†³è®®å’Œç±»æ–¹æ³•è§£æéƒ½ä¼šèµ° _class_resolveInstanceMethodï¼Œè€Œæœ€ç»ˆéƒ½ä¼šæ‰¾åˆ°çˆ¶ç±» NSObjecté‡Œé¢å»ï¼Œé‚£æˆ‘ä»¬ä¸å°±å¯ä»¥åœ¨ NSObject åˆ†ç±»é‡Œé¢é‡å†™ resolveInstanceMethod æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢å¯¹æ²¡æœ‰å®ç°çš„æ–¹æ³•(ä¸ç®¡æ˜¯ç±»æ–¹æ³•è¿˜æ˜¯å¯¹è±¡æ–¹æ³•)è¿›è¡ŒåŠ¨æ€æ·»åŠ  impï¼Œç„¶åå°±å¯ä»¥è¿›è¡Œè‡ªå®šä¹‰å¤„ç†ï¼Œæ¯”å¦‚å¼¹ä¸ªæ¡†è¯´ç½‘ç»œä¸ä½³ï¼Œæˆ–è€…åšbugæ”¶é›†ç­‰ã€‚ è¿™å…¶å®å°±æ˜¯Objective-Cæä¾›äº†ä¸€ç§åä¸ºåŠ¨æ€æ–¹æ³•å†³è®®çš„æ‰‹æ®µï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°ä¸ºä¸€ä¸ªselector æä¾›å®ç°ã€‚ ä¸¾ä¸ªä¾‹å­çœ‹çœ‹ï¼š 12345678910@interface Person : NSObject+ (void)personClassMethod1;- (void)personInstanceMethod1;@end@implementation Person@end ä¸€ä¸ªç®€å•çš„Personç±»ï¼Œé‡Œé¢åˆ†åˆ«æœ‰ä¸€ä¸ªç±»æ–¹æ³•å’Œä¸€ä¸ªå®ä¾‹æ–¹æ³•ï¼Œä½†æ˜¯éƒ½æ²¡æœ‰å®ç°ã€‚ æ¥ç€æ·»åŠ å¯¹è¿™ä¸¤ä¸ªæ–¹æ³•çš„è§£æï¼š 12345678910111213141516171819202122232425- (void)unimplementedMethod:(SEL)sel { NSLog(@&quot;æ²¡å®ç°ï¼Ÿæ²¡å…³ç³»ï¼Œç»ä¸å´©æºƒ&quot;);}+ (BOOL)resolveInstanceMethod:(SEL)sel { NSLog(@&quot;åŠ¨æ€å®ä¾‹æ–¹æ³•è§£æï¼š%@&quot;, NSStringFromSelector(sel)); if (sel == @selector(personInstanceMethod1)) { IMP methodIMP = class_getMethodImplementation(self, @selector(unimplementedMethod:)); Method method = class_getInstanceMethod(Person.class, @selector(unimplementedMethod:)); const char *methodType = method_getTypeEncoding(method); return class_addMethod(Person.class, sel, methodIMP, methodType); } return [super resolveInstanceMethod:sel];}+ (BOOL)resolveClassMethod:(SEL)sel { NSLog(@&quot;åŠ¨æ€ç±»æ–¹æ³•è§£æï¼š%@&quot;, NSStringFromSelector(sel)); if (sel == @selector(personClassMethod1)) { IMP methodIMP = class_getMethodImplementation(self, @selector(unimplementedMethod:)); Method method = class_getInstanceMethod(Person.class, @selector(unimplementedMethod:)); const char *methodType = method_getTypeEncoding(method); return class_addMethod(objc_getMetaClass(&quot;Person&quot;), sel, methodIMP, methodType); } return [super resolveClassMethod:sel];} è°ƒç”¨å¹¶æ‰“å°ï¼š åŠ¨æ€æ–¹æ³•å†³è®®æ€»ç»“ï¼š å®ä¾‹æ–¹æ³•å¯ä»¥é‡å†™resolveInstanceMethodæ·»åŠ imp ç±»æ–¹æ³•å¯ä»¥åœ¨æœ¬ç±»é‡å†™resolveClassMethodå¾€å…ƒç±»æ·»åŠ impï¼Œæˆ–è€…åœ¨NSObjectåˆ†ç±»é‡å†™resolveInstanceMethodæ·»åŠ imp åŠ¨æ€æ–¹æ³•è§£æåªè¦åœ¨ä»»æ„ä¸€æ­¥lookUpImpOrNilæŸ¥æ‰¾åˆ°impå°±ä¸ä¼šæŸ¥æ‰¾ä¸‹å»â€”â€”å³æœ¬ç±»åšäº†åŠ¨æ€æ–¹æ³•å†³è®®ï¼Œä¸ä¼šèµ°åˆ°NSObjctåˆ†ç±»çš„åŠ¨æ€æ–¹æ³•å†³è®® æ‰€æœ‰æ–¹æ³•éƒ½å¯ä»¥é€šè¿‡åœ¨NSObjectåˆ†ç±»é‡å†™resolveInstanceMethodæ·»åŠ impè§£å†³å´©æºƒ é‚£ä¹ˆæŠŠæ‰€æœ‰å´©æºƒéƒ½åœ¨NSObjctåˆ†ç±»ä¸­å¤„ç†ï¼ŒåŠ ä»¥å‰ç¼€åŒºåˆ†ä¸šåŠ¡é€»è¾‘ï¼Œå²‚ä¸æ˜¯ç¾æ»‹æ»‹ï¼Ÿé”™ï¼ ç»Ÿä¸€å¤„ç†èµ·æ¥è€¦åˆåº¦é«˜ é€»è¾‘åˆ¤æ–­å¤š å¯èƒ½åœ¨NSObjctåˆ†ç±»åŠ¨æ€æ–¹æ³•å†³è®®ä¹‹å‰å·²ç»åšäº†å¤„ç† SDKå°è£…çš„æ—¶å€™éœ€è¦ç»™ä¸€ä¸ªå®¹é”™ç©ºé—´ è¿™ä¹Ÿä¸è¡Œï¼Œé‚£ä¹Ÿä¸è¡Œï¼Œé‚£è¯¥æ€ä¹ˆåŠï¼Ÿæ”¾å¿ƒï¼Œè‹¹æœå·²ç»ç»™æˆ‘ä»¬å‡†å¤‡å¥½åè·¯äº†ï¼ ä¸‰ã€æ¶ˆæ¯è½¬å‘æ–¹æ³•çš„è°ƒç”¨ç»è¿‡äº†æŸ¥æ‰¾ã€è§£æï¼Œå¦‚æœè¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°IMPï¼Œå°±ä¼šæ¥åˆ°æ¶ˆæ¯è½¬å‘æµç¨‹ã€‚å®ƒçš„å…¥å£åœ¨lookUpImpOrForwardå‡½æ•°é åçš„ä½ç½®ï¼š 12345// No implementation found, and method resolver didn't help. // Use forwarding.// å¼€å§‹æ¶ˆæ¯è½¬å‘imp = (IMP)_objc_msgForward_impcache;cache_fill(cls, sel, imp, inst); ç»§ç»­è·Ÿè¿›ï¼Œæ¥åˆ°objc-msg-arm64.sæ–‡ä»¶ä¸­ï¼š __objc_msgForward_impcacheæ–¹æ³•ä¸­è°ƒç”¨__objc_msgForwardï¼Œæœ€åä¼šæ¥åˆ°c++ä¸­_objc_forward_handlerï¼š 123456789void *_objc_forward_handler = (void*)objc_defaultForwardHandler;objc_defaultForwardHandler(id self, SEL sel){ _objc_fatal(&quot;%c[%s %s]: unrecognized selector sent to instance %p &quot; &quot;(no message forward handler is installed)&quot;, class_isMetaClass(object_getClass(self)) ? '+' : '-', object_getClassName(self), sel_getName(sel), self);} å½“æˆ‘ä»¬è°ƒç”¨ä¸€ä¸ªæ²¡å®ç°çš„æ–¹æ³•æ—¶ï¼ŒæŠ¥çš„é”™å°±æ˜¯unrecognized selector sent to ... ä½†æ˜¯åˆ°è¿™é‡Œå¹¶æ²¡æœ‰ç»“æŸï¼Œæˆ‘ä»¬åˆ›é€ ä¸€ä¸ªå´©æºƒï¼Œç„¶åçœ‹æ‰“å°ä¿¡æ¯ï¼š å´©æºƒä¹‹å‰åº•å±‚è¿˜è°ƒç”¨äº†___forwarding___å’Œ_CF_forwarding_prep_0ç­‰æ–¹æ³•ï¼Œä½†æ˜¯CoreFoundationåº“ä¸å¼€æºï¼Œåœ¨æ— ä»ä¸‹æ‰‹ä¹‹é™…ï¼Œåªèƒ½æ ¹æ®å‰è¾ˆä»¬çš„ç»éªŒå¼€å§‹ç€æ‰‹â€”â€”ç„¶ååœ¨logMessageSendæ–¹æ³•ä¸­æ‰¾åˆ°äº†æ¢ç´¢æ–¹å‘(lookUpImpOrForward-&gt;log_and_fill_cache-&gt;logMessageSend) é€šè¿‡logMessageSendæ–¹æ³•æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ—¥å¿—ä¼šè®°å½•åœ¨/tmp/msgSendsç›®å½•ä¸‹ï¼Œå¹¶ä¸”é€šè¿‡objcMsgLogEnabledå˜é‡æ¥æ§åˆ¶æ˜¯å¦å­˜å‚¨æ—¥å¿—ï¼š 123456789101112131415161718192021222324252627282930313233343536bool logMessageSend(bool isClassMethod, const char *objectsClass, const char *implementingClass, SEL selector){ char buf[ 1024 ]; // Create/open the log file if (objcMsgLogFD == (-1)) { // æ—¥å¿—ä¼šè®°å½•åœ¨/tmp/msgSendsç›®å½•ä¸‹ snprintf (buf, sizeof(buf), &quot;/tmp/msgSends-%d&quot;, (int) getpid ()); objcMsgLogFD = secure_open (buf, O_WRONLY | O_CREAT, geteuid()); if (objcMsgLogFD &lt; 0) { // no log file - disable logging // é€šè¿‡objcMsgLogEnabledå˜é‡æ¥æ§åˆ¶æ˜¯å¦å­˜å‚¨æ—¥å¿— objcMsgLogEnabled = false; objcMsgLogFD = -1; return true; } } // Make the log entry snprintf(buf, sizeof(buf), &quot;%c %s %s %s\\n&quot;, isClassMethod ? '+' : '-', objectsClass, implementingClass, sel_getName(selector)); objcMsgLogLock.lock(); write (objcMsgLogFD, buf, strlen(buf)); objcMsgLogLock.unlock(); // Tell caller to not cache the method return false;} ç´§æ¥ç€ä»–ä¸‹é¢çš„instrumentObjcMessageSendsæ–¹æ³•å¯ä»¥æ”¹å˜objcMsgLogEnabledçš„å€¼ï¼š 123456789101112131415161718void instrumentObjcMessageSends(BOOL flag){ bool enable = flag; // Shortcut NOP if (objcMsgLogEnabled == enable) return; // If enabling, flush all method caches so we get some traces if (enable) _objc_flush_caches(Nil); // Sync our log file if (objcMsgLogFD != -1) fsync (objcMsgLogFD); objcMsgLogEnabled = enable;} æ‰€ä»¥ï¼Œè™½ç„¶æˆ‘ä»¬åˆ°è¿™é‡Œå°±ä¸èƒ½æŸ¥çœ‹CoreFoundationåº“çš„æºä»£ç äº†ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥æ ¹æ®ä»¥ä¸‹ä»£ç æ¥è®°å½•å¹¶æŸ¥çœ‹å´©æºƒæ—¥å¿—ï¼ˆä»¿ä½›ä¸èƒ½åœ¨æºç å·¥ç¨‹ä¸­æ“ä½œï¼‰ï¼š 1234567891011extern void instrumentObjcMessageSends(BOOL flag);int main(int argc, const char * argv[]) { @autoreleasepool { FXSon *son = [[FXSon alloc] init]; instrumentObjcMessageSends(true); [son doInstanceNoImplementation]; // è°ƒç”¨ä¸€ä¸ªå£°æ˜äº†ä½†æ˜¯æ²¡å®ç°çš„æ–¹æ³• instrumentObjcMessageSends(false); }} å´©æºƒåï¼Œåœ¨è®¿è¾¾ä¸­command+shift+Gå‰å¾€/tmp/msgSendsï¼Œæ‰¾åˆ°æœ€æ–°çš„ä¸€ä»½æ—¥å¿—æ–‡ä»¶ï¼ˆæ•°å­—æœ€å¤§ï¼‰ï¼š æ‰“å¼€æŸ¥çœ‹åå‘ç°ï¼Œåœ¨åŠ¨æ€æ–¹æ³•è§£æå’ŒdoesNotRecognizeSelectorå´©æºƒä¹‹é—´ï¼Œå°±æ˜¯æ¶ˆæ¯è½¬å‘æµç¨‹ï¼Œåˆ†ä¸ºï¼š å¿«é€Ÿè½¬å‘forwardingTargetForSelector æ…¢é€Ÿè½¬å‘methodSignatureForSelector 3.1 æ¶ˆæ¯çš„å¿«é€Ÿè½¬å‘forwardingTargetForSelector:å¯¹åº”çš„å°±æ˜¯æ¶ˆæ¯çš„å¿«é€Ÿè½¬å‘æµç¨‹ï¼Œå®ƒåœ¨æºç ä¸­åªæ˜¯ç®€å•çš„è¿”å›nilï¼ˆå¯åœ¨å­ç±»æˆ–åˆ†ç±»ä¸­é‡å†™ï¼‰ 1234567+ (id)forwardingTargetForSelector:(SEL)sel { return nil;}- (id)forwardingTargetForSelector:(SEL)sel { return nil;} ä¸è¿‡æˆ‘ä»¬å¯ä»¥åœ¨å¼€å‘æ–‡æ¡£ä¸­æ‰¾åˆ°è¯´æ˜ï¼ˆcmd + shift + 0ï¼‰ æ¦‚æ‹¬åœ°è¯´ï¼ŒforwardingTargetForSelector:ä¸»è¦æ˜¯è¿”å›ä¸€ä¸ªæ–°çš„receiverï¼Œå»å¤„ç†selè¿™ä¸ªå½“å‰ç±»æ— æ³•å¤„ç†çš„æ¶ˆæ¯ï¼Œå¦‚æœå¤„ç†ä¸äº†ï¼Œä¼šè½¬åˆ°æ•ˆç‡ä½ä¸‹çš„forwardInvocation:ã€‚ åœ¨æ•ˆç‡æ–¹é¢ï¼ŒforwardingTargetForSelector:é¢†å…ˆforwardInvocation:ä¸€ä¸ªæ•°é‡çº§ï¼Œå› æ­¤ï¼Œæœ€å¥½ä¸è¦ç”¨åè€…çš„æ–¹å¼å¤„ç†æ¶ˆæ¯çš„è½¬å‘é€»è¾‘ã€‚ å…³äºforwardingTargetForSelector:è¿”å›çš„æ–°çš„receiverï¼Œéœ€è¦æ³¨æ„ä¸€ä¸‹å‡ ç‚¹ï¼š ç»å¯¹ä¸èƒ½è¿”å›selfï¼Œå¦åˆ™ä¼šé™·å…¥æ— é™å¾ªç¯ï¼› ä¸å¤„ç†çš„è¯ï¼Œå¯ä»¥è¿”å›nilï¼Œæˆ–è€…[super forwardingTargetForSelector:sel]ï¼ˆéæ ¹ç±»çš„æƒ…å†µï¼‰ï¼Œæ­¤æ—¶ä¼šèµ°methodSignatureForSelector:æ…¢é€Ÿè½¬å‘æµç¨‹ï¼› å¦‚æœæœ‰è¿™ä¸ªreceiverï¼Œæ­¤æ—¶ç›¸å½“äºæ‰§è¡Œobjc_msgSend(newReceiver, sel, ...)ï¼Œé‚£ä¹ˆå®ƒå¿…é¡»æ‹¥æœ‰å’Œè¢«è°ƒç”¨çš„æ–¹æ³•ç›¸åŒæ–¹æ³•ç­¾åçš„æ–¹æ³•ï¼ˆæ–¹æ³•åã€å‚æ•°åˆ—è¡¨ã€è¿”å›å€¼ç±»å‹éƒ½å¿…é¡»ä¸€è‡´ï¼‰ã€‚ ä¸¾ä¾‹è¯´æ˜ï¼š Personç±»ä¸­ï¼š 1234567891011121314151617181920@interface Person : NSObject+ (void)personClassMethod1;- (void)personInstanceMethod1;@end@implementation Person- (id)forwardingTargetForSelector:(SEL)aSelector { NSLog(@&quot;å®ä¾‹æ–¹æ³•å¼€å§‹è½¬å‘&quot;); return [ForwardObject alloc];}+ (id)forwardingTargetForSelector:(SEL)sel { NSLog(@&quot;ç±»æ–¹æ³•å¼€å§‹è½¬å‘&quot;); return [ForwardObject class];}@end ForwardObjectç±»ä¸­ï¼š 123456789101112131415@interface ForwardObject : NSObject@end@implementation ForwardObject+ (void)personClassMethod1 { NSLog(@&quot;ç±»æ–¹æ³•è½¬å‘ç»™%@ï¼Œæ‰§è¡Œ%s&quot;, [self className], __FUNCTION__);}- (void)personInstanceMethod1 { NSLog(@&quot;å®ä¾‹æ–¹æ³•è½¬å‘ç»™%@ï¼Œæ‰§è¡Œ%s&quot;, [self className], __FUNCTION__);}@end æ˜¾ç„¶ï¼ŒForwardObjectä½œä¸ºæ¶ˆæ¯è½¬å‘åçš„å¤„ç†ç±»ï¼Œæ‹¥æœ‰Personç±»çš„åŒåç±»æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•ã€‚ç°åœ¨å¼€å§‹éªŒè¯ï¼Œç»“æœå¦‚ä¸‹ï¼š äº‹å®è¯æ˜ç¡®å®æœ‰æ•ˆï¼æ¥ä¸‹æ¥çœ‹æ¶ˆæ¯çš„æ…¢é€Ÿè½¬å‘æµç¨‹ã€‚ 3.2 æ¶ˆæ¯çš„æ…¢é€Ÿè½¬å‘å¦‚æœforwardingTargetForSelector:æ²¡æœ‰å¤„ç†æ¶ˆæ¯ï¼ˆå¦‚è¿”å›nilï¼‰ï¼Œå°±ä¼šå¯åŠ¨æ…¢é€Ÿè½¬å‘æµç¨‹ï¼Œä¹Ÿå°±æ˜¯methodSignatureForSelector:æ–¹æ³•ï¼ŒåŒæ ·éœ€è¦åœ¨å­ç±»æˆ–åˆ†ç±»ä¸­é‡å†™ 1234567891011// Replaced by CF (returns an NSMethodSignature)+ (NSMethodSignature *)methodSignatureForSelector:(SEL)sel { _objc_fatal(&quot;+[NSObject methodSignatureForSelector:] &quot; &quot;not available without CoreFoundation&quot;);}// Replaced by CF (returns an NSMethodSignature)- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel { _objc_fatal(&quot;-[NSObject methodSignatureForSelector:] &quot; &quot;not available without CoreFoundation&quot;);} é€šè¿‡é˜…è¯»å®˜æ–¹æ–‡æ¡£ï¼Œæˆ‘ä»¬å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š methodSignatureForSelector:æ–¹æ³•æ˜¯è·ŸforwardInvocation:æ–¹æ³•æ­é…ä½¿ç”¨çš„ï¼Œå‰è€…éœ€è¦æˆ‘ä»¬æ ¹æ®selè¿”å›ä¸€ä¸ªæ–¹æ³•ç­¾åï¼Œåè€…ä¼šæŠŠè¿™ä¸ªæ–¹æ³•ç­¾åå°è£…æˆä¸€ä¸ªNSInvocationå¯¹è±¡ï¼Œå¹¶å°†å…¶ä½œä¸ºå½¢å‚ã€‚ å¦‚æœæœ‰ç›®æ ‡å¯¹è±¡èƒ½å¤„ç†Invocationä¸­çš„selï¼ŒInvocationå¯ä»¥æŒ‡æ´¾è¿™ä¸ªå¯¹è±¡å¤„ç†ï¼›å¦åˆ™ä¸å¤„ç†ã€‚ Invocationå¯ä»¥æŒ‡æ´¾å¤šä¸ªå¯¹è±¡å¤„ç† æ³¨æ„ï¼šæ¶ˆæ¯çš„æ…¢é€Ÿè½¬å‘æµç¨‹æ€§èƒ½è¾ƒä½ï¼Œå¦‚æœå¯ä»¥çš„è¯ï¼Œä½ åº”è¯¥å°½å¯èƒ½æ—©åœ°å¤„ç†æ‰æ¶ˆæ¯ï¼ˆå¦‚åœ¨æ–¹æ³•è§£ææ—¶ï¼Œæˆ–åœ¨æ¶ˆæ¯çš„å¿«é€Ÿè½¬å‘æµç¨‹æ—¶ï¼Œé™¤éæœ‰ç‰¹æ®Šéœ€æ±‚ï¼‰ã€‚ ä¸¾ä¾‹è¯´æ˜: è¿™é‡ŒæŠŠå¿«é€Ÿè½¬å‘ä¾‹å­ä¸­çš„Personç±»ä¿®æ”¹ä¸€ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243@implementation Person// MARK: æ…¢é€Ÿè½¬å‘--ç±»æ–¹æ³•+ (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector { NSLog(@&quot;ç±»æ–¹æ³•æ…¢é€Ÿè½¬å‘ï¼š%s, selï¼š%@&quot;, __FUNCTION__, NSStringFromSelector(aSelector)); if (aSelector == @selector(personClassMethod1)) { return [NSMethodSignature signatureWithObjCTypes:&quot;v@:&quot;]; } return [super methodSignatureForSelector:aSelector];}+ (void)forwardInvocation:(NSInvocation *)anInvocation { SEL aSelector = [anInvocation selector]; NSLog(@&quot;ç±»æ–¹æ³•æ…¢é€Ÿè½¬å‘ï¼š%s, selï¼š%@&quot;, __FUNCTION__, NSStringFromSelector(aSelector)); id target = [ForwardObject class]; if ([target respondsToSelector:aSelector]) { [anInvocation invokeWithTarget:target]; } { else [super forwardInvocation:anInvocation]; }}// MARK: æ…¢é€Ÿè½¬å‘--å®ä¾‹æ–¹æ³•- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector { NSLog(@&quot;å®ä¾‹æ–¹æ³•æ…¢é€Ÿè½¬å‘ï¼š%s, selï¼š%@&quot;, __FUNCTION__, NSStringFromSelector(aSelector)); if (aSelector == @selector(personInstanceMethod1)) { return [NSMethodSignature signatureWithObjCTypes:&quot;v@:&quot;]; } return [super methodSignatureForSelector:aSelector];}- (void)forwardInvocation:(NSInvocation *)anInvocation { SEL aSelector = [anInvocation selector]; NSLog(@&quot;å®ä¾‹æ–¹æ³•æ…¢é€Ÿè½¬å‘ï¼š%s, selï¼š%@&quot;, __FUNCTION__, NSStringFromSelector(aSelector)); ForwardObject *obj = [ForwardObject alloc]; if ([obj respondsToSelector:aSelector]) { [anInvocation invokeWithTarget:obj]; } else { [super forwardInvocation:anInvocation]; } }@end ForwardObjectç±»ä¸­ï¼š 123456789101112131415@interface ForwardObject : NSObject@end@implementation ForwardObject+ (void)personClassMethod1 { NSLog(@&quot;ç±»æ–¹æ³•è½¬å‘ç»™%@ï¼Œæ‰§è¡Œ%s&quot;, [self className], __FUNCTION__);}- (void)personInstanceMethod1 { NSLog(@&quot;å®ä¾‹æ–¹æ³•è½¬å‘ç»™%@ï¼Œæ‰§è¡Œ%s&quot;, [self className], __FUNCTION__);}@end å…¶ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ˜¾ç„¶ä¹Ÿæ²¡æœ‰å´©æºƒ: å¯¹æ–¹æ³•ç­¾åç±»å‹ç¼–ç ä¸ç†Ÿæ‚‰çš„å¯ä»¥æŸ¥çœ‹ è‹¹æœå®˜æ–¹çš„ç±»å‹ç¼–ç ä»‹ç» 3.3 æ¶ˆæ¯è½¬å‘çš„åº”ç”¨ - NSProxy3.3.1 æ¨¡æ‹Ÿå®ç°å¤šç»§æ‰¿ã€å­¦ä¹ ä½¿ç”¨ã€‘TestProxyç»§æ‰¿è‡ªNSProxyï¼ŒTestProxy.hæ–‡ä»¶ï¼š 123456789101112#import &lt;Foundation/Foundation.h&gt;NS_ASSUME_NONNULL_BEGIN@interface TestProxy : NSProxy- (instancetype)initWithObject:(id)object;- (void)transformToObject:(id)object;@endNS_ASSUME_NONNULL_END TestProxy.mï¼š 1234567891011121314151617181920212223242526272829303132333435363738#import &quot;TestProxy.h&quot;@interface TestProxy ()// ä¸ºè¿™ä¸ªå¯¹è±¡è½¬å‘æ¶ˆæ¯@property (nonatomic, weak) id object;@end@implementation TestProxy- (instancetype)initWithObject:(id)object { self.object = object; return self;}- (void)transformToObject:(id)object { self.object = object;}// é‡å†™-methodSignatureForSelector:æ–¹æ³•è·å¾—æ–¹æ³•ç­¾å- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel { if (self.object &amp;&amp; [self.object respondsToSelector:sel]) { return [self.object methodSignatureForSelector:sel]; } return [super methodSignatureForSelector:sel];}// é‡å†™-forwardInvocation:ä¸ºè°ƒç”¨è®¾ç½®ç›®æ ‡- (void)forwardInvocation:(NSInvocation *)invocation { SEL sel = [invocation selector]; if (self.object &amp;&amp; [self.object respondsToSelector:sel]) { [invocation invokeWithTarget:self.object]; } else { [super forwardInvocation:invocation]; }}@end ClassAç±»ä¸­æœ‰funcAæ–¹æ³•ï¼ŒClassBç±»ä¸­æœ‰funcBæ–¹æ³•ï¼š 1234567891011121314151617181920212223#import &lt;Foundation/Foundation.h&gt;NS_ASSUME_NONNULL_BEGIN@interface ClassA : NSObject- (void)funcA;@endNS_ASSUME_NONNULL_END #import &quot;ClassA.h&quot;@implementation ClassA- (void)funcA { NSLog(@&quot;è°ƒç”¨äº†funcA*************&quot;);}@end 1234567891011121314151617181920212223#import &lt;Foundation/Foundation.h&gt;NS_ASSUME_NONNULL_BEGIN@interface ClassB : NSObject- (void)funcB;@endNS_ASSUME_NONNULL_END #import &quot;ClassB.h&quot;@implementation ClassB- (void)funcB { NSLog(@&quot;è°ƒç”¨äº†funcB*************&quot;);}@end ä½¿ç”¨ä¸€ä¸‹ï¼š 123456789101112131415- (void)test2 { // å˜ä¸ºclsAçš„ä»£ç†ï¼Œå³proxyæŠŠæ¶ˆæ¯è½¬å‘ç»™äº†clsA ClassA *clsA = [ClassA new];// TestProxy *proxy = [[TestProxy alloc] initWithObject:clsA];// [proxy performSelector:@selector(funcA)]; // å˜ä¸ºclsBçš„ä»£ç†ï¼Œå³proxy1æŠŠæ¶ˆæ¯è½¬å‘ç»™äº†clsB ClassB *clsB = [ClassB new]; TestProxy *proxy1 = [[TestProxy alloc] initWithObject:clsB]; [proxy1 performSelector:@selector(funcB)]; // åˆæŠŠæ¶ˆæ¯è½¬å‘ç»™äº†clsA [proxy1 transformToObject:clsA]; [proxy1 performSelector:@selector(funcA)];} æ‰“å°ï¼š 122021-01-04 17:51:33.533056+0800 Demo[62114:6062041] è°ƒç”¨äº†funcB*************2021-01-04 17:51:33.533094+0800 Demo[62114:6062041] è°ƒç”¨äº†funcA************* ç»“æœï¼š å°±æ˜¯proxy1è¿™ä¸ªå¯¹è±¡æ—¢èƒ½è°ƒç”¨ClassAä¸­çš„æ–¹æ³•ï¼Œåˆèƒ½è°ƒç”¨ClassBä¸­çš„æ–¹æ³•ï¼Œçœ‹èµ·æ¥å°±åƒæ˜¯ç»§æ‰¿è‡ªè¿™ä¸¤ä¸ªç±»ä¸€æ ·ã€‚ ä½†å®é™…ä¸Šproxy1åªæ˜¯æ¶ˆæ¯è½¬å‘çš„ä¸­é—´ç«™ï¼Œå®é™…ä¸Šè¿˜æ˜¯ClassAå’ŒClassBçš„å®ä¾‹å»è°ƒç”¨å„è‡ªçš„æ–¹æ³•ã€‚ 3.3.2 æ‹¦æˆªæ–¹æ³•çš„è°ƒç”¨ï¼Œä»ä¸­å®ç°ä¸€äº›æˆ‘ä»¬è‡ªå·±éœ€è¦çš„åŠŸèƒ½æ¯”å¦‚åŸ‹ç‚¹SDKä¸­éœ€è¦å®ç°çš„UITableViewç‚¹å‡»äº‹ä»¶å…¨åŸ‹ç‚¹ï¼Œå°±å¯ä»¥æŠŠNSProxyç±»ä½œä¸ºUITableViewçš„ä¸­é—´ä»£ç†ï¼Œä»¥å®ç°åœ¨ä¸­é—´æ‹¦æˆªä»£ç†æ–¹æ³•å¹¶åœ¨å…¶ä¸­æ·»åŠ åŸ‹ç‚¹äº‹ä»¶çš„åŠŸèƒ½ã€‚ è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨æ…¢é€Ÿæ¶ˆæ¯è½¬å‘ï¼ŒåŸå› æ˜¯è‹¹æœåœ¨å®˜æ–¹æ–‡æ¡£ä¸­å†™é“ï¼š 12DiscussionThis method is used in the implementation of protocols. This method is also used in situations where an NSInvocation object must be created, such as during message forwarding. If your object maintains a delegate or is capable of handling messages that it does not directly implement, you should override this method to return an appropriate method signature. 1è¯¥æ–¹æ³•ç”¨äºåè®®çš„å®ç°ã€‚åœ¨å¿…é¡»åˆ›å»ºNSInvocationå¯¹è±¡çš„æƒ…å†µä¸‹ï¼Œä¾‹å¦‚åœ¨æ¶ˆæ¯è½¬å‘æœŸé—´ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•ã€‚å¦‚æœå¯¹è±¡ç®¡ç†ä»£ç†æˆ–èƒ½å¤Ÿå¤„ç†å®ƒæ²¡æœ‰ç›´æ¥å®ç°çš„æ¶ˆæ¯ï¼Œåˆ™åº”é‡å†™æ­¤æ–¹æ³•ä»¥è¿”å›é€‚å½“çš„æ–¹æ³•ç­¾åã€‚ æˆ‘ä»¬åœ¨è¿™é‡Œéœ€è¦ç®¡ç†ä»£ç†ï¼Œæ‰€ä»¥ä½¿ç”¨æ…¢é€Ÿæ¶ˆæ¯è½¬å‘ã€‚ æ­¥éª¤ï¼š 1.è‡ªå®šä¸€ä¸ªXWTrackingAnalyticsDelegateProxyç±»ï¼Œç»§æ‰¿è‡ªNSProxyï¼Œå¹¶åœ¨å…¶ä¸­è¿›è¡Œæ‹¦æˆªå’Œæ¶ˆæ¯è½¬å‘ã€‚ XWTrackingAnalyticsDelegateProxy.hï¼š 1234567891011#import &lt;UIKit/UIKit.h&gt;NS_ASSUME_NONNULL_BEGIN@interface XWTrackingAnalyticsDelegateProxy : NSProxy &lt;UITableViewDelegate&gt;+ (instancetype)proxyWithTableViewDelegate:(id&lt;UITableViewDelegate&gt;)delegate;@endNS_ASSUME_NONNULL_END XWTrackingAnalyticsDelegateProxy.mï¼š 12345678910111213141516171819202122232425262728293031323334353637383940#import &quot;XWTrackingAnalyticsDelegateProxy.h&quot;#import &quot;XWTrackingAnalysisSDK.h&quot;@interface XWTrackingAnalyticsDelegateProxy ()@property (nonatomic, weak) id delegate;@end@implementation XWTrackingAnalyticsDelegateProxy+ (instancetype)proxyWithTableViewDelegate:(id&lt;UITableViewDelegate&gt;)delegate { XWTrackingAnalyticsDelegateProxy *proxy = [XWTrackingAnalyticsDelegateProxy alloc]; proxy.delegate = delegate; return proxy;}- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel { // è¿”å› delegate å¯¹è±¡ä¸­å¯¹åº”çš„æ–¹æ³•ç­¾å return [(NSObject *)self.delegate methodSignatureForSelector:sel];}- (void)forwardInvocation:(NSInvocation *)invocation { // å…ˆæ‰§è¡Œ delegate å¯¹è±¡ä¸­çš„æ–¹æ³• [invocation invokeWithTarget:self.delegate]; // åˆ¤æ–­æ˜¯å¦æ˜¯ cell çš„ç‚¹å‡»äº‹ä»¶çš„ä»£ç†æ–¹æ³• if (invocation.selector == @selector(tableView:didSelectRowAtIndexPath:)) { // å°†æ–¹æ³•ä¿®æ”¹ä¸ºè¿›è¡Œæ•°æ®é‡‡é›†çš„æ–¹æ³• invocation.selector = NSSelectorFromString(@&quot;xwtracking_tableView:didSelectRowAtIndexPath:&quot;); // æ‰§è¡Œæ•°æ®é‡‡é›†ç›¸å…³çš„æ–¹æ³• [invocation invokeWithTarget:self]; }}- (void)xwtracking_tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath { // æ•°æ®é‡‡é›†ç›¸å…³ [XWTrackingAnalysisSDK.shareInstance trackAppClickWithTableView:tableView didSelectRowAtIndexPath:indexPath properties:nil];}@end 2.ä½¿ç”¨æ–¹æ³•äº¤æ¢æŠŠä»£ç†è®¾ç½®ä¸ºproxy UITableView+XWTracking.mï¼š 123456789101112131415161718192021222324252627282930313233343536#import &quot;UITableView+XWTracking.h&quot;#import &quot;NSObject+XWSwizzler.h&quot;#import &lt;objc/message.h&gt;#import &quot;XWTrackingAnalysisSDK.h&quot;#import &quot;XWTrackingAnalyticsDelegateProxy.h&quot;#import &quot;UIScrollView+XWTracking.h&quot;@implementation UITableView (XWTracking)+ (void)load { [UITableView xwtracking_swizzleMethod:@selector(setDelegate:) withMethod:@selector(xwtracking_setDelegate:)];}- (void)xwtracking_setDelegate:(id&lt;UITableViewDelegate&gt;)delegate {// [self xwtracking_setDelegate:delegate]; // // æ–¹æ¡ˆä¸€ï¼šäº¤æ¢æ–¹æ³•// // äº¤æ¢ delegate ä¸­çš„ tableView:didSelectRowAtIndexPath: æ–¹æ³•// [self xwtracking_swizzleDidSelectRowAtIndexPathMethodWithDelegate:delegate]; // æ–¹æ¡ˆä¸‰ï¼šNSProxy æ¶ˆæ¯è½¬å‘ // é”€æ¯ä¿å­˜çš„å§”æ‰˜å¯¹è±¡ self.xwtracking_delegateProxy = nil; if (delegate) { XWTrackingAnalyticsDelegateProxy *proxy = [XWTrackingAnalyticsDelegateProxy proxyWithTableViewDelegate:delegate]; // ä¿å­˜å§”æ‰˜å¯¹è±¡ self.xwtracking_delegateProxy = proxy; // è°ƒç”¨åŸå§‹æ–¹æ³•ï¼Œå°†ä»£ç†è®¾ç½®ä¸ºå§”æ‰˜å¯¹è±¡ [self xwtracking_setDelegate:proxy]; } else { // è°ƒç”¨åŸå§‹æ–¹æ³•ï¼Œå°†ä»£ç†è®¾ç½®ä¸ºnil [self xwtracking_setDelegate:nil]; }}... 3.ä¸ºäº†è§£å†³proxyè¿™ä¸ªå±€éƒ¨å˜é‡å‡ºä»£ç å—è¢«é‡Šæ”¾ï¼Œç„¶åproxyè¿™ä¸ªä¸­é—´ä»£ç†ä¸å­˜åœ¨çš„æƒ…å†µä¸‹è¿˜å»è°ƒç”¨ä»£ç†æ–¹æ³•æ—¶çš„å´©æºƒï¼Œéœ€è¦åŠ ä¸€ä¸ªå¯¹è¿™ä¸ªå§”æ‰˜å¯¹è±¡åŠ ä¸€ä¸ªå¼ºå¼•ç”¨ã€‚ ä¸ºäº†å¯ä»¥åŒæ—¶æ”¯æŒUICollectionViewæ§ä»¶ï¼Œç›´æ¥åœ¨UIScrollViewä¸­æ‰©å±•xwtracking_delegateProxyè¿™ä¸ªå±æ€§ï¼š UIScrollView+XWTracking.hï¼š 12345678#import &lt;UIKit/UIKit.h&gt;#import &quot;XWTrackingAnalyticsDelegateProxy.h&quot;@interface UIScrollView (XWTracking)@property (nonatomic, strong) XWTrackingAnalyticsDelegateProxy *xwtracking_delegateProxy;@end UIScrollView+XWTracking.mï¼š 1234567891011121314#import &quot;UIScrollView+XWTracking.h&quot;#include &lt;objc/runtime.h&gt;@implementation UIScrollView (XWTracking)- (void)setXwtracking_delegateProxy:(XWTrackingAnalyticsDelegateProxy *)xwtracking_delegateProxy { objc_setAssociatedObject(self, @selector(setXwtracking_delegateProxy:), xwtracking_delegateProxy, OBJC_ASSOCIATION_RETAIN_NONATOMIC);}- (XWTrackingAnalyticsDelegateProxy *)xwtracking_delegateProxy { return objc_getAssociatedObject(self, @selector(xwtracking_delegateProxy));}@end è‡³æ­¤å°±å·²ç»èƒ½å¤Ÿæ‹¦æˆªåˆ°tableView:didSelectRowAtIndexPath:æ–¹æ³•å¹¶ä¸”åœ¨å…¶ä¸­åŸ‹ç‚¹äº†ã€‚ åŸç†å›¾ï¼š å››ã€æ€»ç»“ç»¼ä¸Šæ‰€è¿°ï¼Œå½“æˆ‘ä»¬è°ƒç”¨æ–¹æ³•æ—¶ï¼š â‘ é¦–å…ˆè¿›è¡Œæ–¹æ³•çš„æŸ¥æ‰¾ â‘¡å¦‚æœæŸ¥æ‰¾å¤±è´¥ï¼Œä¼šè¿›è¡ŒåŠ¨æ€æ–¹æ³•è§£æï¼Œæ­¤æ—¶OCä¼šç»™æˆ‘ä»¬ä¸€æ¬¡å¯¹selçš„å¤„ç†æœºä¼šï¼Œä½ å¯ä»¥åœ¨resolveInstanceMethod:ï¼ˆç±»æ–¹æ³•å¯¹åº”resolveClassMethod:ï¼‰ä¸­æ·»åŠ ä¸€ä¸ªIMP â‘¢å¦‚æœä½ æ²¡æŠŠæ¡ä½è¿™æ¬¡æœºä¼šï¼Œä¹Ÿå°±æ˜¯è§£æå¤±è´¥æ—¶ï¼Œä¼šæ¥åˆ°æ¶ˆæ¯è½¬å‘é˜¶æ®µï¼Œè¿™ä¸ªé˜¶æ®µæœ‰ä¸¤ä¸ªæœºä¼šå»å¤„ç†selï¼Œåˆ†åˆ«æ˜¯å¿«é€Ÿè½¬å‘çš„forwardingTargetForSelector:ï¼Œä»¥åŠæ…¢é€Ÿè½¬å‘çš„methodSignatureForSelector:ã€‚ æ¶ˆæ¯å¿«é€Ÿè½¬å‘é˜¶æ®µforwardingTargedForSelectorï¼Œå¦‚æœæœ‰å¤„ç†ï¼Œå°±äº¤ç»™å¤„ç†çš„å¯¹è±¡æ¥å®ç°ï¼Œæ²¡æœ‰å°±äº¤ç»™å…¶ä»–å¯¹è±¡å¤„ç†ï¼Œè¿›å…¥æ…¢é€Ÿè½¬å‘é˜¶æ®µã€‚ æ¶ˆæ¯æ…¢é€Ÿè½¬å‘é˜¶æ®µmethodSignatureForSelectorï¼Œè¿›è¡Œæ–¹æ³•ç­¾åï¼ŒæŠŠæ–¹æ³•ä¸¢å‡ºå»ï¼ŒforwardInvocationæ¥å¯¹æ¶ˆæ¯å¤„ç†ã€‚ â‘£å½“ç„¶ï¼Œå¦‚æœè¿™äº›æœºä¼šä½ éƒ½æ”¾å¼ƒäº†ï¼Œé‚£OCåªå¥½è®©ç¨‹åºå´©æºƒï¼Œå°±è¿›å…¥åˆ°äº†doesNotRecognizeSelectoræŠ¥é”™ã€‚ ä¸‹é¢ç”¨ä¸€å‰¯å›¾æ€»ç»“æ–¹æ³•çš„è§£æå’Œè½¬å‘æµç¨‹ï¼š äº”ã€é—®é¢˜è®¨è®ºä¸ºä»€ä¹ˆå¼•å…¥æ¶ˆæ¯è½¬å‘æœºåˆ¶ï¼Ÿåœ¨ä¸€ä¸ªæ–¹æ³•è¢«è°ƒç”¨ä¹‹å‰ï¼Œæˆ‘ä»¬æ˜¯æ²¡åŠæ³•ç¡®å®šå®ƒçš„å®ç°åœ°å€çš„ï¼Œç›´åˆ°è¿è¡Œæ—¶ï¼Œè¿™ä¸ªæ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ‰èƒ½çœŸæ­£çŸ¥é“å®ƒæ˜¯å¦æœ‰å®ç°ï¼Œä»¥åŠå…¶å…·ä½“çš„å®ç°åœ°å€ã€‚è¿™ä¹Ÿå°±æ˜¯æ‰€è°“çš„â€œåŠ¨æ€ç»‘å®šâ€ã€‚ åœ¨ç¼–è¯‘æœŸï¼Œå¦‚æœç¼–è¯‘å™¨å‘ç°æ–¹æ³•ä¸å­˜åœ¨ï¼Œä¼šç›´æ¥æŠ¥é”™ï¼›åŒæ ·ï¼Œåœ¨è¿è¡Œæ—¶ï¼Œä¹Ÿæœ‰doesNotRecognizeSelectorçš„å¤„ç†ã€‚ åœ¨æŠ›å‡ºdoesNotRecognizeSelectorè¿™ä¸ªå¼‚å¸¸ä¿¡æ¯ä¹‹å‰ï¼ŒOCåˆ©ç”¨å…¶åŠ¨æ€ç»‘å®šçš„ç‰¹æ€§ï¼Œå¼•å…¥äº†æ¶ˆæ¯è½¬å‘æœºåˆ¶ï¼Œç»™äºˆäº†æˆ‘ä»¬é¢å¤–çš„æœºä¼šå¤„ç†æ¶ˆæ¯ï¼ˆè§£æ or è½¬å‘ï¼‰ï¼Œè¿™æ ·çš„åšæ³•æ˜¾ç„¶æ›´åŠ å‘¨å…¨åˆç†ã€‚ å‚è€ƒOCæºç åˆ†æä¹‹æ–¹æ³•çš„è§£æä¸è½¬å‘åŸç†-çº¢é…’ç‰›æ’ iOSæ¢ç´¢ åŠ¨æ€æ–¹æ³•è§£æå’Œæ¶ˆæ¯è½¬å‘æœºåˆ¶-æˆ‘æ˜¯å¥½å®å® iOS åº•å±‚æ¢ç´¢ç¯‡ â€”â€” æ–¹æ³•çš„è½¬å‘æµç¨‹-Eating iOS å¸¦ä½ èµ°è¿›æ¶ˆæ¯è½¬å‘æµç¨‹åŠé˜²å´©æºƒå¤„ç†-æµå¹´åŒ†åŒ†i ã€ŠiOSå…¨åŸ‹ç‚¹è§£å†³æ–¹æ¡ˆã€‹","link":"/2021/01/03/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/06-%E5%8A%A8%E6%80%81%E6%96%B9%E6%B3%95%E8%A7%A3%E6%9E%90%E5%92%8C%E6%B6%88%E6%81%AF%E8%BD%AC%E5%8F%91%E6%9C%BA%E5%88%B6/"},{"title":"07ä¸‹-dyldåˆ†æ","text":"å‰è¨€æˆ‘ä»¬å¹³æ—¶ç¼–å†™çš„ç¨‹åºçš„å…¥å£å‡½æ•°éƒ½æ˜¯main.mæ–‡ä»¶é‡Œé¢çš„mainå‡½æ•°ï¼Œä½†æ˜¯è¿™å°±æ˜¯Appçš„ç”Ÿå‘½èµ·ç‚¹äº†å—ï¼Ÿ +loadæ–¹æ³•å…ˆäºmainå‡½æ•°æ‰§è¡Œï¼Œé‚£ä¹ˆmainå‡½æ•°ä¹‹å‰éƒ½å‘ç”Ÿäº†å“ªäº›æœ‰è¶£çš„äº‹å‘¢ï¼Ÿ ä¸€ã€é™æ€åº“ä¸åŠ¨æ€åº“1.ç¼–è¯‘è¿‡ç¨‹åœ¨æ—¥å¸¸å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¼€å‘è€…ä¼šä½¿ç”¨æˆåƒä¸Šä¸‡æ¬¡çš„Command + B/Rè¿›è¡Œå¼€å‘è°ƒè¯•ï¼Œä½†å¯èƒ½å¾ˆå°‘æœ‰äººå…³æ³¨è¿‡è¿™ä¸ªè¿‡ç¨‹ä¸­ Xcodeå¸®æˆ‘ä»¬åšäº†å“ªäº›äº‹æƒ… äº‹å®ä¸Šï¼Œè¿™ä¸ªè¿‡ç¨‹åˆ†è§£ä¸º4ä¸ªæ­¥éª¤ï¼Œåˆ†åˆ«æ˜¯é¢„å¤„ç†(Prepressing)ã€ç¼–è¯‘(Compilation)ã€æ±‡ç¼–(Assembly)å’Œé“¾æ¥(Linking)â€”â€”æ‘˜è‡ªã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»â€“ é“¾æ¥ã€è£…è½½ä¸åº“ã€‹ åœ¨ä»¥ä¸Š4ä¸ªæ­¥éª¤ä¸­ï¼ŒIDEä¸»è¦åšäº†ä»¥ä¸‹å‡ ä»¶äº‹: **é¢„ç¼–è¯‘**ï¼šå¤„ç†ä»£ç ä¸­çš„# å¼€å¤´çš„é¢„ç¼–è¯‘æŒ‡ä»¤ã€‚æ¯”å¦‚åˆ é™¤#defineå¹¶å±•å¼€å®å®šä¹‰ï¼Œå°†#includeåŒ…å«çš„æ–‡ä»¶æ’å…¥åˆ°è¯¥æŒ‡ä»¤ä½ç½®ç­‰ **ç¼–è¯‘**ï¼šå¯¹é¢„ç¼–è¯‘å¤„ç†è¿‡çš„æ–‡ä»¶è¿›è¡Œè¯æ³•åˆ†æã€è¯­æ³•åˆ†æå’Œè¯­ä¹‰åˆ†æï¼Œå¹¶è¿›è¡Œæºä»£ç ä¼˜åŒ–ï¼Œç„¶åç”Ÿæˆæ±‡ç¼–ä»£ç  **æ±‡ç¼–**ï¼šé€šè¿‡æ±‡ç¼–å™¨å°†æ±‡ç¼–ä»£ç è½¬æ¢ä¸ºæœºå™¨å¯ä»¥æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œå¹¶ç”Ÿæˆç›®æ ‡æ–‡ä»¶.oæ–‡ä»¶ **é“¾æ¥**ï¼šå°†ç›®æ ‡æ–‡ä»¶é“¾æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚è¿™ä¸€è¿‡ç¨‹ä¸­ï¼Œé“¾æ¥å™¨å°†ä¸åŒçš„ç›®æ ‡æ–‡ä»¶é“¾æ¥èµ·æ¥ï¼Œå› ä¸ºä¸åŒçš„ç›®æ ‡æ–‡ä»¶ä¹‹é—´å¯èƒ½æœ‰ç›¸äº’å¼•ç”¨çš„å˜é‡æˆ–è°ƒç”¨çš„å‡½æ•°ï¼Œå¦‚æˆ‘ä»¬ç»å¸¸è°ƒç”¨Foundationæ¡†æ¶å’ŒUIKitæ¡†æ¶ä¸­çš„æ–¹æ³•å’Œå˜é‡ï¼Œä½†æ˜¯è¿™äº›æ¡†æ¶è·Ÿæˆ‘ä»¬çš„ä»£ç å¹¶ä¸åœ¨ä¸€ä¸ªç›®æ ‡æ–‡ä»¶ä¸­ï¼Œè¿™å°±éœ€è¦é“¾æ¥å™¨å°†å®ƒä»¬ä¸æˆ‘ä»¬è‡ªå·±çš„ä»£ç é“¾æ¥èµ·æ¥ Foundationå’ŒUIKitè¿™ç§å¯ä»¥å…±äº«ä»£ç ã€å®ç°ä»£ç çš„å¤ç”¨ç»Ÿç§°ä¸ºåº“â€”â€”æ˜¯å¯æ‰§è¡Œä»£ç çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯ä»¥è¢«æ“ä½œç³»ç»Ÿå†™å…¥å†…å­˜ï¼Œå®ƒåˆåˆ†ä¸ºé™æ€åº“å’ŒåŠ¨æ€åº“ 2.é™æ€åº“é™æ€åº“æ˜¯æŒ‡é“¾æ¥æ—¶å®Œæ•´çš„æ‹·è´åˆ°å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¤šæ¬¡ä½¿ç”¨å¤šæ¬¡æ‹·è´ï¼Œé€ æˆå†—ä½™ï¼Œä½¿åŒ…å˜çš„æ›´å¤§ å¦‚.aã€.libéƒ½æ˜¯é™æ€åº“ 3.åŠ¨æ€åº“åŠ¨æ€åº“æ˜¯æŒ‡é“¾æ¥æ—¶ä¸å¤åˆ¶ï¼Œç¨‹åºè¿è¡Œæ—¶ç”±ç³»ç»ŸåŠ åœ¨åˆ°å†…å­˜ä¸­ï¼Œä¾›ç³»ç»Ÿè°ƒç”¨ï¼Œç³»ç»Ÿåªéœ€åŠ è½½ä¸€æ¬¡ï¼Œå¤šæ¬¡ä½¿ç”¨ï¼Œå…±ç”¨èŠ‚çœå†…å­˜ã€‚ å¦‚.dylibã€.frameworkéƒ½æ˜¯åŠ¨æ€åº“ ç³»ç»Ÿçš„frameworkæ˜¯åŠ¨æ€çš„ï¼Œå¼€å‘è€…åˆ›å»ºçš„frameworkæ˜¯é™æ€çš„ é‚£ä¹ˆé“¾æ¥å™¨åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå®ƒæ˜¯æ€ä¹ˆé“¾æ¥ä¸åŒçš„ç›®æ ‡æ–‡ä»¶çš„å‘¢ï¼Ÿ äºŒã€dyld1.dyldç®€ä»‹dyld(dynamic link editor / dynamic loader)æ˜¯è‹¹æœçš„åŠ¨æ€é“¾æ¥å™¨ï¼Œè´Ÿè´£ç¨‹åºçš„é“¾æ¥åŠåŠ è½½å·¥ä½œï¼Œæ˜¯è‹¹æœæ“ä½œç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå­˜åœ¨äºMacOSç³»ç»Ÿçš„(/usr/lib/dyld)ç›®å½•ä¸‹ã€‚ åœ¨åº”ç”¨è¢«ç¼–è¯‘æ‰“åŒ…æˆå¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼çš„Mach-Oæ–‡ä»¶ä¹‹å ï¼Œäº¤ç”±dyldè´Ÿè´£é“¾æ¥ï¼ŒåŠ è½½ç¨‹åºã€‚ 2.dyld_shared_cacheç”±äºä¸æ­¢ä¸€ä¸ªç¨‹åºéœ€è¦ä½¿ç”¨UIKitç³»ç»ŸåŠ¨æ€åº“ï¼Œæ‰€ä»¥ä¸å¯èƒ½åœ¨æ¯ä¸ªç¨‹åºåŠ è½½æ—¶éƒ½å»åŠ è½½æ‰€æœ‰çš„ç³»ç»ŸåŠ¨æ€åº“ã€‚ ä¸ºäº†ä¼˜åŒ–ç¨‹åºå¯åŠ¨é€Ÿåº¦å’Œåˆ©ç”¨åŠ¨æ€åº“ç¼“å­˜ï¼Œè‹¹æœä»iOS3.1ä¹‹åï¼Œå°†æ‰€æœ‰ç³»ç»Ÿåº“ï¼ˆç§æœ‰ä¸å…¬æœ‰ï¼‰ç¼–è¯‘æˆä¸€ä¸ªå¤§çš„ç¼“å­˜æ–‡ä»¶ï¼Œè¿™å°±æ˜¯dyld_shared_cacheï¼Œè¯¥ç¼“å­˜æ–‡ä»¶å­˜åœ¨iOSç³»ç»Ÿä¸‹çš„/System/Library/Caches/com.apple.dyld/ç›®å½•ä¸‹ ä¸‰ã€dyldåŠ è½½æµç¨‹æ–°å»ºç©ºå·¥ç¨‹ï¼Œå†™ä¸‹loadæ–¹æ³•ï¼Œå¹¶åœ¨mainæ–¹æ³•å’Œloadæ–¹æ³•åˆ†åˆ«ä¸‹æ–­ç‚¹ ç‚¹å‡»å‡½æ•°è°ƒç”¨æ ˆ/ä½¿ç”¨LLVMâ€”â€”btæŒ‡ä»¤æ‰“å°ï¼Œéƒ½èƒ½çœ‹åˆ°æœ€åˆçš„èµ·ç‚¹_dyld_start æ¥ä¸‹æ¥é€šè¿‡dyldæºç (ç‰ˆæœ¬ï¼šdyld-635.2)å±•å¼€åˆ†æ_dyld_startï¼š 1._dyld_startåœ¨æºç ä¸­å…¨å±€æœç´¢_dyld_startï¼Œä¼šå‘ç°å®ƒæ˜¯ç”±æ±‡ç¼–å®ç°çš„ åœ¨arm64ä¸­ï¼Œ_dyld_startè°ƒç”¨äº†ä¸€ä¸ªçœ‹ä¸æ‡‚çš„æ–¹æ³• ä»æ³¨é‡Šä¸­å¾—å‡ºå¯èƒ½æ˜¯dyldbootstrap::startæ–¹æ³•ï¼ˆå…¶å®åœ¨â€œå‡½æ•°è°ƒç”¨æ ˆâ€é‚£å¼ å›¾ä¸­æ±‡ç¼–ä»£ç å·²ç»æŠŠè¿™ä¸ªæ–¹æ³•æš´éœ²å‡ºæ¥äº†ï¼‰ 2.dyldbootstrap::startå…¨å±€æœç´¢dyldbootstrap::startå¹¶æ²¡æœ‰ä»»ä½•æœ‰æ„ä¹‰ç»“æœï¼Œé‚£ä¹ˆåªèƒ½æ ¹æ®ç»éªŒæ¥çè’™ä¸€ä¸‹äº†â€”â€”å…¨å±€æœç´¢ç©ºæ ¼start(â€œä¾¥å¹¸â€å¾—åˆ°äº†ç»“æœ å…¶å®dyldbootstrap::startæ˜¯æŒ‡dyldbootstrapè¿™ä¸ªå‘½åç©ºé—´ä½œç”¨åŸŸé‡Œçš„ startå‡½æ•° 1234567891011121314151617181920212223242526272829303132333435363738uintptr_t start(const struct macho_header* appsMachHeader, int argc, const char* argv[], intptr_t slide, const struct macho_header* dyldsMachHeader, uintptr_t* startGlue){ // if kernel had to slide dyld, we need to fix up load sensitive locations // we have to do this before using any global variables slide = slideOfMainExecutable(dyldsMachHeader); bool shouldRebase = slide != 0;#if __has_feature(ptrauth_calls) shouldRebase = true;#endif if ( shouldRebase ) { rebaseDyld(dyldsMachHeader, slide); } // allow dyld to use mach messaging mach_init(); // kernel sets up env pointer to be just past end of agv array const char** envp = &amp;argv[argc+1]; // kernel sets up apple pointer to be just past end of envp array const char** apple = envp; while(*apple != NULL) { ++apple; } ++apple; // set up random value for stack canary __guard_setup(apple);#if DYLD_INITIALIZER_SUPPORT // run all C++ initializers inside dyld runDyldInitializers(dyldsMachHeader, slide, argc, argv, envp, apple);#endif // now that we are done bootstrapping dyld, call dyld's main uintptr_t appsSlide = slideOfMainExecutable(appsMachHeader); return dyld::_main(appsMachHeader, appsSlide, argc, argv, envp, apple, startGlue);} åœ¨start()å‡½æ•°ä¸­ä¸»è¦åšäº†ä¸€ä¸‹å‡ ä»¶äº‹ï¼š æ ¹æ®dyldsMachHeaderè®¡ç®—å‡ºslideï¼Œ é€šè¿‡slideåˆ¤å®šæ˜¯å¦éœ€è¦é‡å®šä½ï¼›è¿™é‡Œçš„slideæ˜¯æ ¹æ®ASLRæŠ€æœ¯ è®¡ç®—å‡ºçš„ä¸€ä¸ªéšæœºå€¼ï¼Œä½¿å¾—ç¨‹åºæ¯ä¸€æ¬¡è¿è¡Œçš„åç§»å€¼éƒ½ä¸ä¸€æ ·ï¼Œé˜²æ­¢æ”»å‡»è€…é€šè¿‡å›ºå®šåœ°å€å‘èµ·æ¶æ„æ”»å‡» mach_init()åˆå§‹åŒ–ï¼ˆå…è®¸dyldä½¿ç”¨machæ¶ˆæ¯ä¼ é€’ï¼‰ æ ˆæº¢å‡ºä¿æŠ¤ è®¡ç®—appsMachHeaderçš„åç§»ï¼Œè°ƒç”¨dyld::_main()å‡½æ•° 3.dyld::_main()ç‚¹å‡»è¿›å…¥dyld::_main()å‡½æ•° 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514uintptr_t_main(const macho_header* mainExecutableMH, uintptr_t mainExecutableSlide, int argc, const char* argv[], const char* envp[], const char* apple[], uintptr_t* startGlue){ if (dyld3::kdebug_trace_dyld_enabled(DBG_DYLD_TIMING_LAUNCH_EXECUTABLE)) { launchTraceID = dyld3::kdebug_trace_dyld_duration_start(DBG_DYLD_TIMING_LAUNCH_EXECUTABLE, (uint64_t)mainExecutableMH, 0, 0); } // Grab the cdHash of the main executable from the environment uint8_t mainExecutableCDHashBuffer[20]; const uint8_t* mainExecutableCDHash = nullptr; // è·å–ä¸»ç¨‹åºhash if ( hexToBytes(_simple_getenv(apple, &quot;executable_cdhash&quot;), 40, mainExecutableCDHashBuffer) ) mainExecutableCDHash = mainExecutableCDHashBuffer; // Trace dyld's load // é€šçŸ¥kernalå†…æ ¸dyldæ–‡ä»¶å·²åŠ è½½ notifyKernelAboutImage((macho_header*)&amp;__dso_handle, _simple_getenv(apple, &quot;dyld_file&quot;));#if !TARGET_IPHONE_SIMULATOR // Trace the main executable's load // é€šçŸ¥kernalå†…æ ¸mach-oæ–‡ä»¶å·²åŠ è½½ notifyKernelAboutImage(mainExecutableMH, _simple_getenv(apple, &quot;executable_file&quot;));#endif uintptr_t result = 0; // ä¿å­˜ä¼ å…¥çš„å¯æ‰§è¡Œæ–‡ä»¶çš„å¤´éƒ¨ï¼ˆæ˜¯ä¸€ä¸ªstruct macho_headerç»“æ„ä½“ï¼‰ï¼Œåé¢æ ¹æ®å¤´éƒ¨è®¿é—®ä¿¡æ¯ sMainExecutableMachHeader = mainExecutableMH; sMainExecutableSlide = mainExecutableSlide;#if __MAC_OS_X_VERSION_MIN_REQUIRED // if this is host dyld, check to see if iOS simulator is being run const char* rootPath = _simple_getenv(envp, &quot;DYLD_ROOT_PATH&quot;); if ( (rootPath != NULL) ) { // look to see if simulator has its own dyld char simDyldPath[PATH_MAX]; strlcpy(simDyldPath, rootPath, PATH_MAX); strlcat(simDyldPath, &quot;/usr/lib/dyld_sim&quot;, PATH_MAX); int fd = my_open(simDyldPath, O_RDONLY, 0); if ( fd != -1 ) { const char* errMessage = useSimulatorDyld(fd, mainExecutableMH, simDyldPath, argc, argv, envp, apple, startGlue, &amp;result); if ( errMessage != NULL ) halt(errMessage); return result; } }#endif CRSetCrashLogMessage(&quot;dyld: launch started&quot;); // ä¸»è¦åŠŸèƒ½1âƒ£ï¸ï¼šæ ¹æ®å¯æ‰§è¡Œæ–‡ä»¶å¤´éƒ¨ï¼Œå‚æ•°ç­‰è®¾ç½®ä¸Šä¸‹æ–‡ä¿¡æ¯ setContext(mainExecutableMH, argc, argv, envp, apple); // Pickup the pointer to the exec path. // è·å–å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ sExecPath = _simple_getenv(apple, &quot;executable_path&quot;); // &lt;rdar://problem/13868260&gt; Remove interim apple[0] transition code from dyld if (!sExecPath) sExecPath = apple[0]; // mach-o ç»å¯¹è·¯å¾„ if ( sExecPath[0] != '/' ) { // have relative path, use cwd to make absolute char cwdbuff[MAXPATHLEN]; if ( getcwd(cwdbuff, MAXPATHLEN) != NULL ) { // maybe use static buffer to avoid calling malloc so early... char* s = new char[strlen(cwdbuff) + strlen(sExecPath) + 2]; strcpy(s, cwdbuff); strcat(s, &quot;/&quot;); strcat(s, sExecPath); sExecPath = s; } } // Remember short name of process for later logging // è·å–å¯æ‰§è¡Œæ–‡ä»¶çš„åå­— sExecShortName = ::strrchr(sExecPath, '/'); if ( sExecShortName != NULL ) ++sExecShortName; else sExecShortName = sExecPath; // ä¸»è¦åŠŸèƒ½1âƒ£ï¸ï¼šæ£€æµ‹è¿›ç¨‹æ˜¯å¦å—é™ configureProcessRestrictions(mainExecutableMH);#if __MAC_OS_X_VERSION_MIN_REQUIRED if ( !gLinkContext.allowEnvVarsPrint &amp;&amp; !gLinkContext.allowEnvVarsPath &amp;&amp; !gLinkContext.allowEnvVarsSharedCache ) { pruneEnvironmentVariables(envp, &amp;apple); // set again because envp and apple may have changed or moved setContext(mainExecutableMH, argc, argv, envp, apple); } else#endif { // ä¸»è¦åŠŸèƒ½2âƒ£ï¸ï¼šæ£€æŸ¥è®¾ç½®ç¯å¢ƒå˜é‡ checkEnvironmentVariables(envp); // å¦‚æœDYLD_FALLBACKä¸ºnilï¼Œå°†å…¶è®¾ç½®ä¸ºé»˜è®¤å€¼ defaultUninitializedFallbackPaths(envp); }#if __MAC_OS_X_VERSION_MIN_REQUIRED if ( ((dyld3::MachOFile*)mainExecutableMH)-&gt;supportsPlatform(dyld3::Platform::iOSMac) &amp;&amp; !((dyld3::MachOFile*)mainExecutableMH)-&gt;supportsPlatform(dyld3::Platform::macOS)) { gLinkContext.rootPaths = parseColonList(&quot;/System/iOSSupport&quot;, NULL); gLinkContext.marzipan = true; if ( sEnv.DYLD_FALLBACK_LIBRARY_PATH == sLibraryFallbackPaths ) sEnv.DYLD_FALLBACK_LIBRARY_PATH = sRestrictedLibraryFallbackPaths; if ( sEnv.DYLD_FALLBACK_FRAMEWORK_PATH == sFrameworkFallbackPaths ) sEnv.DYLD_FALLBACK_FRAMEWORK_PATH = sRestrictedFrameworkFallbackPaths; }#endif // å¦‚æœè®¾ç½®äº†DYLD_PRINT_OPTSç¯å¢ƒå˜é‡ï¼Œåˆ™æ‰“å°å‚æ•° if ( sEnv.DYLD_PRINT_OPTS ) printOptions(argv); // å¦‚æœè®¾ç½®äº†DYLD_PRINT_ENVç¯å¢ƒå˜é‡ï¼Œåˆ™æ‰“å°ç¯å¢ƒå˜é‡ if ( sEnv.DYLD_PRINT_ENV ) printEnvironmentVariables(envp); // ä¸»è¦åŠŸèƒ½2âƒ£ï¸ï¼šæ ¹æ®Mach-Oå¤´éƒ¨è·å–å½“å‰è¿è¡Œæ¶æ„ä¿¡æ¯ getHostInfo(mainExecutableMH, mainExecutableSlide); // load shared cache // ä¸»è¦åŠŸèƒ½3âƒ£ï¸ï¼šæ£€æŸ¥å…±äº«ç¼“å­˜æ˜¯å¦å¼€å¯ï¼ŒiOSä¸­å¿…é¡»å¼€å¯ checkSharedRegionDisable((dyld3::MachOLoaded*)mainExecutableMH, mainExecutableSlide);#if TARGET_IPHONE_SIMULATOR // &lt;HACK&gt; until &lt;rdar://30773711&gt; is fixed gLinkContext.sharedRegionMode = ImageLoader::kUsePrivateSharedRegion; // &lt;/HACK&gt;#endif if ( gLinkContext.sharedRegionMode != ImageLoader::kDontUseSharedRegion ) { // ä¸»è¦åŠŸèƒ½3âƒ£ï¸ï¼šåŠ è½½å…±äº«ç¼“å­˜åº“ mapSharedCache(); } bool cacheCompatible = (sSharedCacheLoadInfo.loadAddress == nullptr) || (sSharedCacheLoadInfo.loadAddress-&gt;header.formatVersion == dyld3::closure::kFormatVersion); if ( cacheCompatible &amp;&amp; (sEnableClosures || inWhiteList(sExecPath)) ) { const dyld3::closure::LaunchClosure* mainClosure = nullptr; dyld3::closure::LoadedFileInfo mainFileInfo; mainFileInfo.fileContent = mainExecutableMH; mainFileInfo.path = sExecPath; // FIXME: If we are saving this closure, this slice offset/length is probably wrong in the case of FAT files. mainFileInfo.sliceOffset = 0; mainFileInfo.sliceLen = std::numeric_limits&lt;__typeof(mainFileInfo.sliceLen)&gt;::max(); struct stat mainExeStatBuf; if ( ::stat(sExecPath, &amp;mainExeStatBuf) == 0 ) { mainFileInfo.inode = mainExeStatBuf.st_ino; mainFileInfo.mtime = mainExeStatBuf.st_mtime; } // check for closure in cache first if ( sSharedCacheLoadInfo.loadAddress != nullptr ) { mainClosure = sSharedCacheLoadInfo.loadAddress-&gt;findClosure(sExecPath); if ( gLinkContext.verboseWarnings &amp;&amp; (mainClosure != nullptr) ) dyld::log(&quot;dyld: found closure %p (size=%lu) in dyld shared cache\\n&quot;, mainClosure, mainClosure-&gt;size()); } #if !TARGET_IPHONE_SIMULATOR if ( (mainClosure == nullptr) || !closureValid(mainClosure, mainFileInfo, mainExecutableCDHash, true, envp) ) { mainClosure = nullptr; if ( sEnableClosures || isStagedApp((dyld3::MachOFile*)mainExecutableMH, sExecPath) ) { // if forcing closures, and no closure in cache, or it is invalid, check for cached closure mainClosure = findCachedLaunchClosure(mainExecutableCDHash, mainFileInfo, envp); if ( mainClosure == nullptr ) { // if no cached closure found, build new one mainClosure = buildLaunchClosure(mainExecutableCDHash, mainFileInfo, envp); } } } #endif // try using launch closure if ( mainClosure != nullptr ) { CRSetCrashLogMessage(&quot;dyld3: launch started&quot;); bool launched = launchWithClosure(mainClosure, sSharedCacheLoadInfo.loadAddress, (dyld3::MachOLoaded*)mainExecutableMH, mainExecutableSlide, argc, argv, envp, apple, &amp;result, startGlue); #if !TARGET_IPHONE_SIMULATOR if ( !launched ) { // closure is out of date, build new one mainClosure = buildLaunchClosure(mainExecutableCDHash, mainFileInfo, envp); if ( mainClosure != nullptr ) { launched = launchWithClosure(mainClosure, sSharedCacheLoadInfo.loadAddress, (dyld3::MachOLoaded*)mainExecutableMH, mainExecutableSlide, argc, argv, envp, apple, &amp;result, startGlue); } } #endif if ( launched ) {#if __has_feature(ptrauth_calls) // start() calls the result pointer as a function pointer so we need to sign it. result = (uintptr_t)__builtin_ptrauth_sign_unauthenticated((void*)result, 0, 0);#endif if (sSkipMain) result = (uintptr_t)&amp;fake_main; return result; } else { if ( gLinkContext.verboseWarnings ) dyld::log(&quot;dyld: unable to use closure %p\\n&quot;, mainClosure); } } } else { if ( gLinkContext.verboseWarnings ) dyld::log(&quot;dyld: not using closure because shared cache format version does not match dyld's\\n&quot;); } // could not use closure info, launch old way // install gdb notifier stateToHandlers(dyld_image_state_dependents_mapped, sBatchHandlers)-&gt;push_back(notifyGDB); stateToHandlers(dyld_image_state_mapped, sSingleHandlers)-&gt;push_back(updateAllImages); // make initial allocations large enough that it is unlikely to need to be re-alloced sImageRoots.reserve(16); sAddImageCallbacks.reserve(4); sRemoveImageCallbacks.reserve(4); sAddLoadImageCallbacks.reserve(4); sImageFilesNeedingTermination.reserve(16); sImageFilesNeedingDOFUnregistration.reserve(8);#if !TARGET_IPHONE_SIMULATOR#ifdef WAIT_FOR_SYSTEM_ORDER_HANDSHAKE // &lt;rdar://problem/6849505&gt; Add gating mechanism to dyld support system order file generation process WAIT_FOR_SYSTEM_ORDER_HANDSHAKE(dyld::gProcessInfo-&gt;systemOrderFlag);#endif#endif try { // add dyld itself to UUID list // ä¸»è¦åŠŸèƒ½4âƒ£ï¸ï¼šå°†dyldæœ¬èº«æ·»åŠ åˆ°UUIDåˆ—è¡¨ addDyldImageToUUIDList();#if SUPPORT_ACCELERATE_TABLES#if __arm64e__ // Disable accelerator tables when we have threaded rebase/bind, which is arm64e executables only for now. if (sMainExecutableMachHeader-&gt;cpusubtype == CPU_SUBTYPE_ARM64_E) sDisableAcceleratorTables = true;#endif bool mainExcutableAlreadyRebased = false; if ( (sSharedCacheLoadInfo.loadAddress != nullptr) &amp;&amp; !dylibsCanOverrideCache() &amp;&amp; !sDisableAcceleratorTables &amp;&amp; (sSharedCacheLoadInfo.loadAddress-&gt;header.accelerateInfoAddr != 0) ) { struct stat statBuf; if ( ::stat(IPHONE_DYLD_SHARED_CACHE_DIR &quot;no-dyld2-accelerator-tables&quot;, &amp;statBuf) != 0 ) sAllCacheImagesProxy = ImageLoaderMegaDylib::makeImageLoaderMegaDylib(&amp;sSharedCacheLoadInfo.loadAddress-&gt;header, sSharedCacheLoadInfo.slide, mainExecutableMH, gLinkContext); }reloadAllImages:#endif CRSetCrashLogMessage(sLoadingCrashMessage); // instantiate ImageLoader for main executable // ä¸»è¦åŠŸèƒ½5âƒ£ï¸ï¼šå®ä¾‹åŒ–ä¸»ç¨‹åº // åŠ è½½å¯æ‰§è¡Œæ–‡ä»¶å¹¶ç”Ÿæˆä¸€ä¸ªImageLoaderå®ä¾‹å¯¹è±¡ // è¿™é‡Œè°ƒç”¨æ¯”è¾ƒæ·±,åç»­å†çœ‹ sMainExecutable = instantiateFromLoadedImage(mainExecutableMH, mainExecutableSlide, sExecPath); gLinkContext.mainExecutable = sMainExecutable; gLinkContext.mainExecutableCodeSigned = hasCodeSignatureLoadCommand(mainExecutableMH);#if TARGET_IPHONE_SIMULATOR // check main executable is not too new for this OS { if ( ! isSimulatorBinary((uint8_t*)mainExecutableMH, sExecPath) ) { throwf(&quot;program was built for a platform that is not supported by this runtime&quot;); } uint32_t mainMinOS = sMainExecutable-&gt;minOSVersion(); // dyld is always built for the current OS, so we can get the current OS version // from the load command in dyld itself. uint32_t dyldMinOS = ImageLoaderMachO::minOSVersion((const mach_header*)&amp;__dso_handle); if ( mainMinOS &gt; dyldMinOS ) { #if TARGET_OS_WATCH throwf(&quot;app was built for watchOS %d.%d which is newer than this simulator %d.%d&quot;, mainMinOS &gt;&gt; 16, ((mainMinOS &gt;&gt; 8) &amp; 0xFF), dyldMinOS &gt;&gt; 16, ((dyldMinOS &gt;&gt; 8) &amp; 0xFF)); #elif TARGET_OS_TV throwf(&quot;app was built for tvOS %d.%d which is newer than this simulator %d.%d&quot;, mainMinOS &gt;&gt; 16, ((mainMinOS &gt;&gt; 8) &amp; 0xFF), dyldMinOS &gt;&gt; 16, ((dyldMinOS &gt;&gt; 8) &amp; 0xFF)); #else throwf(&quot;app was built for iOS %d.%d which is newer than this simulator %d.%d&quot;, mainMinOS &gt;&gt; 16, ((mainMinOS &gt;&gt; 8) &amp; 0xFF), dyldMinOS &gt;&gt; 16, ((dyldMinOS &gt;&gt; 8) &amp; 0xFF)); #endif } }#endif #if __MAC_OS_X_VERSION_MIN_REQUIRED // &lt;rdar://problem/22805519&gt; be less strict about old mach-o binaries uint32_t mainSDK = sMainExecutable-&gt;sdkVersion(); gLinkContext.strictMachORequired = (mainSDK &gt;= DYLD_MACOSX_VERSION_10_12) || gLinkContext.allowInsertFailures; #else // simulators, iOS, tvOS, and watchOS are always strict gLinkContext.strictMachORequired = true; #endif #if SUPPORT_ACCELERATE_TABLES sAllImages.reserve((sAllCacheImagesProxy != NULL) ? 16 : INITIAL_IMAGE_COUNT); #else sAllImages.reserve(INITIAL_IMAGE_COUNT); #endif // Now that shared cache is loaded, setup an versioned dylib overrides #if SUPPORT_VERSIONED_PATHS //æ£€æŸ¥åº“çš„ç‰ˆæœ¬æ˜¯å¦æœ‰æ›´æ–°ï¼Œæœ‰åˆ™è¦†ç›–åŸæœ‰çš„ checkVersionedPaths(); #endif // dyld_all_image_infos image list does not contain dyld // add it as dyldPath field in dyld_all_image_infos // for simulator, dyld_sim is in image list, need host dyld added#if TARGET_IPHONE_SIMULATOR // get path of host dyld from table of syscall vectors in host dyld void* addressInDyld = gSyscallHelpers;#else // get path of dyld itself void* addressInDyld = (void*)&amp;__dso_handle;#endif char dyldPathBuffer[MAXPATHLEN+1]; int len = proc_regionfilename(getpid(), (uint64_t)(long)addressInDyld, dyldPathBuffer, MAXPATHLEN); if ( len &gt; 0 ) { dyldPathBuffer[len] = '\\0'; // proc_regionfilename() does not zero terminate returned string if ( strcmp(dyldPathBuffer, gProcessInfo-&gt;dyldPath) != 0 ) gProcessInfo-&gt;dyldPath = strdup(dyldPathBuffer); } // load any inserted libraries // ä¸»è¦åŠŸèƒ½6âƒ£ï¸ï¼šæ’å…¥åŠ¨æ€åº“:åŠ è½½æ‰€æœ‰ DYLD_INSERT_LIBRARIES æŒ‡å®šçš„åº“ if ( sEnv.DYLD_INSERT_LIBRARIES != NULL ) { for (const char* const* lib = sEnv.DYLD_INSERT_LIBRARIES; *lib != NULL; ++lib) loadInsertedDylib(*lib); } // record count of inserted libraries so that a flat search will look at // inserted libraries, then main, then others. sInsertedDylibCount = sAllImages.size()-1; // link main executable gLinkContext.linkingMainExecutable = true;#if SUPPORT_ACCELERATE_TABLES if ( mainExcutableAlreadyRebased ) { // previous link() on main executable has already adjusted its internal pointers for ASLR // work around that by rebasing by inverse amount sMainExecutable-&gt;rebase(gLinkContext, -mainExecutableSlide); }#endif // ä¸»è¦åŠŸèƒ½7âƒ£ï¸ï¼šé“¾æ¥ä¸»ç¨‹åº // linkè°ƒç”¨æ¯”è¾ƒæ·±,åç»­æ¥çœ‹ link(sMainExecutable, sEnv.DYLD_BIND_AT_LAUNCH, true, ImageLoader::RPathChain(NULL, NULL), -1); sMainExecutable-&gt;setNeverUnloadRecursive(); if ( sMainExecutable-&gt;forceFlat() ) { gLinkContext.bindFlat = true; gLinkContext.prebindUsage = ImageLoader::kUseNoPrebinding; } // link any inserted libraries // do this after linking main executable so that any dylibs pulled in by inserted // dylibs (e.g. libSystem) will not be in front of dylibs the program uses // ä¸»è¦åŠŸèƒ½7âƒ£ï¸ï¼šé“¾æ¥ä¸»ç¨‹åºå’Œæ‰€æœ‰æ’å…¥çš„åŠ¨æ€åº“ if ( sInsertedDylibCount &gt; 0 ) { for(unsigned int i=0; i &lt; sInsertedDylibCount; ++i) { ImageLoader* image = sAllImages[i+1]; link(image, sEnv.DYLD_BIND_AT_LAUNCH, true, ImageLoader::RPathChain(NULL, NULL), -1); image-&gt;setNeverUnloadRecursive(); } // only INSERTED libraries can interpose // register interposing info after all inserted libraries are bound so chaining works for(unsigned int i=0; i &lt; sInsertedDylibCount; ++i) { ImageLoader* image = sAllImages[i+1]; // æ³¨å†Œç¬¦å·æ’å…¥ image-&gt;registerInterposing(gLinkContext); } } // &lt;rdar://problem/19315404&gt; dyld should support interposition even without DYLD_INSERT_LIBRARIES for (long i=sInsertedDylibCount+1; i &lt; sAllImages.size(); ++i) { ImageLoader* image = sAllImages[i]; if ( image-&gt;inSharedCache() ) continue; image-&gt;registerInterposing(gLinkContext); } #if SUPPORT_ACCELERATE_TABLES if ( (sAllCacheImagesProxy != NULL) &amp;&amp; ImageLoader::haveInterposingTuples() ) { // Accelerator tables cannot be used with implicit interposing, so relaunch with accelerator tables disabled ImageLoader::clearInterposingTuples(); // unmap all loaded dylibs (but not main executable) for (long i=1; i &lt; sAllImages.size(); ++i) { ImageLoader* image = sAllImages[i]; if ( image == sMainExecutable ) continue; if ( image == sAllCacheImagesProxy ) continue; image-&gt;setCanUnload(); ImageLoader::deleteImage(image); } // note: we don't need to worry about inserted images because if DYLD_INSERT_LIBRARIES was set we would not be using the accelerator table sAllImages.clear(); sImageRoots.clear(); sImageFilesNeedingTermination.clear(); sImageFilesNeedingDOFUnregistration.clear(); sAddImageCallbacks.clear(); sRemoveImageCallbacks.clear(); sAddLoadImageCallbacks.clear(); sDisableAcceleratorTables = true; sAllCacheImagesProxy = NULL; sMappedRangesStart = NULL; mainExcutableAlreadyRebased = true; gLinkContext.linkingMainExecutable = false; resetAllImages(); goto reloadAllImages; } #endif // apply interposing to initial set of images for(int i=0; i &lt; sImageRoots.size(); ++i) { //åº”ç”¨ç¬¦å·æ’å…¥ sImageRoots[i]-&gt;applyInterposing(gLinkContext); } ImageLoader::applyInterposingToDyldCache(gLinkContext); gLinkContext.linkingMainExecutable = false; // Bind and notify for the main executable now that interposing has been registered uint64_t bindMainExecutableStartTime = mach_absolute_time(); sMainExecutable-&gt;recursiveBindWithAccounting(gLinkContext, sEnv.DYLD_BIND_AT_LAUNCH, true); uint64_t bindMainExecutableEndTime = mach_absolute_time(); ImageLoaderMachO::fgTotalBindTime += bindMainExecutableEndTime - bindMainExecutableStartTime; gLinkContext.notifyBatch(dyld_image_state_bound, false); // Bind and notify for the inserted images now interposing has been registered if ( sInsertedDylibCount &gt; 0 ) { for(unsigned int i=0; i &lt; sInsertedDylibCount; ++i) { ImageLoader* image = sAllImages[i+1]; // é€’å½’ç»‘å®šç¬¦å·è¡¨ image-&gt;recursiveBind(gLinkContext, sEnv.DYLD_BIND_AT_LAUNCH, true); } } // &lt;rdar://problem/12186933&gt; do weak binding only after all inserted images linked // å¼±ç¬¦å·ç»‘å®š sMainExecutable-&gt;weakBind(gLinkContext); // If cache has branch island dylibs, tell debugger about them if ( (sSharedCacheLoadInfo.loadAddress != NULL) &amp;&amp; (sSharedCacheLoadInfo.loadAddress-&gt;header.mappingOffset &gt;= 0x78) &amp;&amp; (sSharedCacheLoadInfo.loadAddress-&gt;header.branchPoolsOffset != 0) ) { uint32_t count = sSharedCacheLoadInfo.loadAddress-&gt;header.branchPoolsCount; dyld_image_info info[count]; const uint64_t* poolAddress = (uint64_t*)((char*)sSharedCacheLoadInfo.loadAddress + sSharedCacheLoadInfo.loadAddress-&gt;header.branchPoolsOffset); // &lt;rdar://problem/20799203&gt; empty branch pools can be in development cache if ( ((mach_header*)poolAddress)-&gt;magic == sMainExecutableMachHeader-&gt;magic ) { for (int poolIndex=0; poolIndex &lt; count; ++poolIndex) { uint64_t poolAddr = poolAddress[poolIndex] + sSharedCacheLoadInfo.slide; info[poolIndex].imageLoadAddress = (mach_header*)(long)poolAddr; info[poolIndex].imageFilePath = &quot;dyld_shared_cache_branch_islands&quot;; info[poolIndex].imageFileModDate = 0; } // add to all_images list addImagesToAllImages(count, info); // tell gdb about new branch island images gProcessInfo-&gt;notification(dyld_image_adding, count, info); } } CRSetCrashLogMessage(&quot;dyld: launch, running initializers&quot;); // åˆå§‹åŒ–ä¸»ç¨‹åº #if SUPPORT_OLD_CRT_INITIALIZATION // Old way is to run initializers via a callback from crt1.o if ( ! gRunInitializersOldWay ) initializeMainExecutable(); #else // run all initializers // ä¸»è¦åŠŸèƒ½8âƒ£ï¸ï¼šæ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•ï¼ï¼ initializeMainExecutable(); #endif // notify any montoring proccesses that this process is about to enter main() if (dyld3::kdebug_trace_dyld_enabled(DBG_DYLD_TIMING_LAUNCH_EXECUTABLE)) { dyld3::kdebug_trace_dyld_duration_end(launchTraceID, DBG_DYLD_TIMING_LAUNCH_EXECUTABLE, 0, 0, 2); } notifyMonitoringDyldMain(); // find entry point for main executable // ä¸»è¦åŠŸèƒ½9âƒ£ï¸ï¼šå¯»æ‰¾ç›®æ ‡å¯æ‰§è¡Œæ–‡ä»¶å…¥å£å¹¶æ‰§è¡Œ // ä» mach-o ä¸­è¯»å–ç¨‹åºå…¥å£, ä¸»ç¨‹åºåˆ™è¯»å–LC_UNIXTHREAD, å°±æ˜¯ main.m result = (uintptr_t)sMainExecutable-&gt;getEntryFromLC_MAIN(); if ( result != 0 ) { // main executable uses LC_MAIN, we need to use helper in libdyld to call into main() if ( (gLibSystemHelpers != NULL) &amp;&amp; (gLibSystemHelpers-&gt;version &gt;= 9) ) *startGlue = (uintptr_t)gLibSystemHelpers-&gt;startGlueToCallExit; else halt(&quot;libdyld.dylib support not present for LC_MAIN&quot;); } else { // main executable uses LC_UNIXTHREAD, dyld needs to let &quot;start&quot; in program set up for main() // æ‰¾åˆ°çœŸæ­£ main å‡½æ•°å…¥å£ result = (uintptr_t)sMainExecutable-&gt;getEntryFromLC_UNIXTHREAD(); *startGlue = 0; }#if __has_feature(ptrauth_calls) // start() calls the result pointer as a function pointer so we need to sign it. result = (uintptr_t)__builtin_ptrauth_sign_unauthenticated((void*)result, 0, 0);#endif } catch(const char* message) { syncAllImages(); halt(message); } catch(...) { dyld::log(&quot;dyld: launch failed\\n&quot;); } CRSetCrashLogMessage(&quot;dyld2 mode&quot;); if (sSkipMain) { if (dyld3::kdebug_trace_dyld_enabled(DBG_DYLD_TIMING_LAUNCH_EXECUTABLE)) { dyld3::kdebug_trace_dyld_duration_end(launchTraceID, DBG_DYLD_TIMING_LAUNCH_EXECUTABLE, 0, 0, 2); } result = (uintptr_t)&amp;fake_main; *startGlue = (uintptr_t)gLibSystemHelpers-&gt;startGlueToCallExit; } // æ‰¾åˆ°çœŸæ­£ main å‡½æ•°å…¥å£åè¿”å› return result;} dyld::_main()ä¸»è¦æµç¨‹ä¸ºï¼š è®¾ç½®ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œæ£€æµ‹è¿›ç¨‹æ˜¯å¦å—é™ é…ç½®ç¯å¢ƒå˜é‡ï¼Œè·å–å½“å‰è¿è¡Œæ¶æ„ æ£€æŸ¥æ˜¯å¦å¼€å¯å…±äº«ç¼“å­˜ï¼Œå¹¶åŠ è½½å…±äº«ç¼“å­˜åº“ å°† dyld æœ¬èº«æ·»åŠ åˆ° UUID åˆ—è¡¨ å®ä¾‹åŒ–ä¸»ç¨‹åº åŠ è½½æ’å…¥åŠ¨æ€åº“ é“¾æ¥ä¸»ç¨‹åºå’Œæ’å…¥çš„åº“ï¼Œæ‰§è¡Œç¬¦å·æ›¿æ¢ æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³• å¯»æ‰¾ä¸»ç¨‹åºå…¥å£ 3.1 è®¾ç½®ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œæ£€æµ‹è¿›ç¨‹æ˜¯å¦å—é™ è°ƒç”¨setContextå‡½æ•°ï¼Œä¼ å…¥Mach-Oå¤´éƒ¨ä»¥åŠä¸€äº›å‚æ•°è®¾ç½®ä¸Šä¸‹æ–‡ configureProcessRestrictionsæ£€æµ‹è¿›ç¨‹æ˜¯å¦å—é™ï¼Œåœ¨ä¸Šä¸‹æ–‡ä¸­åšå‡ºå¯¹åº”å¤„ç† 1234/// _mainå‡½æ•°ä¸­setContext(mainExecutableMH, argc, argv, envp, apple);...configureProcessRestrictions(mainExecutableMH); 3.2 é…ç½®ç¯å¢ƒå˜é‡ï¼Œè·å–å½“å‰è¿è¡Œæ¶æ„ ä»ç¯å¢ƒå˜é‡ä¸­è·å–ä¸»è¦å¯æ‰§è¡Œæ–‡ä»¶çš„cdHash checkEnvironmentVariables(envp)æ£€æŸ¥è®¾ç½®ç¯å¢ƒå˜é‡ defaultUninitializedFallbackPaths(envp)åœ¨DYLD_FALLBACKä¸ºç©ºæ—¶è®¾ç½®é»˜è®¤å€¼ getHostInfo(mainExecutableMH, mainExecutableSlide)è·å–ç¨‹åºæ¶æ„ 1234567/// _mainå‡½æ•°ä¸­//å¦‚æœè®¾ç½®äº†DYLD_PRINT_OPTSç¯å¢ƒå˜é‡ï¼Œåˆ™æ‰“å°å‚æ•°if ( sEnv.DYLD_PRINT_OPTS ) printOptions(argv);//å¦‚æœè®¾ç½®äº†DYLD_PRINT_ENVç¯å¢ƒå˜é‡ï¼Œåˆ™æ‰“å°ç¯å¢ƒå˜é‡if ( sEnv.DYLD_PRINT_ENV ) printEnvironmentVariables(envp); åªè¦è®¾ç½®äº†è¿™ä¸¤ä¸ªç¯å¢ƒå˜é‡å‚æ•°ï¼Œåœ¨Appå¯åŠ¨æ—¶å°±ä¼šæ‰“å°ç›¸å…³å‚æ•°ã€ç¯å¢ƒå˜é‡ä¿¡æ¯ï¼ˆè‡ªè¡Œå°è¯•ï¼‰ 3.3 æ£€æŸ¥æ˜¯å¦å¼€å¯å…±äº«ç¼“å­˜ï¼Œå¹¶åŠ è½½å…±äº«ç¼“å­˜åº“ checkSharedRegionDisableæ£€æŸ¥æ˜¯å¦å¼€å¯å…±äº«ç¼“å­˜ï¼ˆiOS ä¸‹ä¸ä¼šè¢«ç¦ç”¨ï¼‰ mapSharedCacheåŠ è½½å…±äº«ç¼“å­˜åº“ï¼Œå…¶ä¸­è°ƒç”¨loadDyldCacheå‡½æ•°æœ‰è¿™ä¹ˆå‡ ç§æƒ…å†µï¼š ä»…åŠ è½½åˆ°å½“å‰è¿›ç¨‹mapCachePrivateï¼ˆæ¨¡æ‹Ÿå™¨ä»…æ”¯æŒåŠ è½½åˆ°å½“å‰è¿›ç¨‹ï¼‰ å…±äº«ç¼“å­˜æ˜¯ç¬¬ä¸€æ¬¡è¢«åŠ è½½ï¼Œå°±å»åšåŠ è½½æ“ä½œmapCacheSystemWide å…±äº«ç¼“å­˜ä¸æ˜¯ç¬¬ä¸€æ¬¡è¢«åŠ è½½ï¼Œé‚£ä¹ˆå°±ä¸åšä»»ä½•å¤„ç† 3.4 å°†dyldæœ¬èº«æ·»åŠ åˆ°UUIDåˆ—è¡¨addDyldImageToUUIDListå°†dyldæœ¬èº«æ·»åŠ åˆ°UUIDåˆ—è¡¨ 3.5 å®ä¾‹åŒ–ä¸»ç¨‹åº1sMainExecutable = instantiateFromLoadedImage(mainExecutableMH, mainExecutableSlide, sExecPath); å®ä¾‹åŒ–ä¸»ç¨‹åº , æ£€æµ‹å¯æ‰§è¡Œç¨‹åºæ ¼å¼ . 1234567891011static ImageLoaderMachO* instantiateFromLoadedImage(const macho_header* mh, uintptr_t slide, const char* path){ // try mach-o loader if ( isCompatibleMachO((const uint8_t*)mh, path) ) { ImageLoader* image = ImageLoaderMachO::instantiateMainExecutable(mh, slide, path, gLinkContext); addImage(image); return (ImageLoaderMachO*)image; } throw &quot;main executable not a known format&quot;;} isCompatibleMachO é‡Œå°±ä¼šé€šè¿‡ header é‡Œçš„ magic , cputype , cpusubtype å»æ£€æµ‹æ˜¯å¦å…¼å®¹ instantiateMainExecutableä¸­è°ƒç”¨ImageLoaderMachO::sniffLoadCommandsï¼Œè¿™æ‰æ˜¯çœŸæ­£å®ä¾‹åŒ–ä¸»ç¨‹åºçš„å‡½æ•° 1234567891011121314151617181920212223242526// determine if this mach-o file has classic or compressed LINKEDIT and number of segments it hasvoid ImageLoaderMachO::sniffLoadCommands(const macho_header* mh, const char* path, bool inCache, bool* compressed, unsigned int* segCount, unsigned int* libCount, const LinkContext&amp; context, const linkedit_data_command** codeSigCmd, const encryption_info_command** encryptCmd){ *compressed = false; *segCount = 0; *libCount = 0; *codeSigCmd = NULL; *encryptCmd = NULL; /* ... */ // fSegmentsArrayCount is only 8-bits if ( *segCount &gt; 255 ) dyld::throwf(&quot;malformed mach-o image: more than 255 segments in %s&quot;, path); // fSegmentsArrayCount is only 8-bits if ( *libCount &gt; 4095 ) dyld::throwf(&quot;malformed mach-o image: more than 4095 dependent libraries in %s&quot;, path); if ( needsAddedLibSystemDepency(*libCount, mh) ) *libCount = 1; ...} è¿™é‡Œå‡ ä¸ªå­—æ®µéƒ½ä¸MachOæœ‰å…³ï¼š compressedï¼šæ ¹æ®LC_DYLD_INFO_ONYLæ¥å†³å®š segCount: MachOæ–‡ä»¶ä¸­segmentæ•°é‡ï¼Œæœ€å¤šä¸è¶…è¿‡255ä¸ª libCount: MachOæ–‡ä»¶ä¸­ä¾èµ–çš„åŠ¨æ€åº“çš„æ•°é‡ codeSigCmd: ç­¾åä¿¡æ¯ encryptCmd: åŠ å¯†ä¿¡æ¯ï¼Œå¦‚cryptidç­‰ ç»è¿‡ä»¥ä¸Šæ­¥éª¤ , ä¸»ç¨‹åºçš„å®ä¾‹åŒ–å°±å·²ç»å®Œæˆäº† 3.6 åŠ è½½æ’å…¥åŠ¨æ€åº“123456/// _mainå‡½æ•°ä¸­// load any inserted librariesif ( sEnv.DYLD_INSERT_LIBRARIES != NULL ) { for (const char* const* lib = sEnv.DYLD_INSERT_LIBRARIES; *lib != NULL; ++lib) loadInsertedDylib(*lib);} éå†DYLD_INSERT_LIBRARIESç¯å¢ƒå˜é‡ï¼Œè°ƒç”¨loadInsertedDylibåŠ è½½ï¼Œé€šè¿‡è¯¥ç¯å¢ƒå˜é‡æˆ‘ä»¬å¯ä»¥æ³¨å…¥è‡ªå®šä¹‰çš„ä¸€äº›åŠ¨æ€åº“ä»£ç ä»è€Œå®Œæˆå®‰å…¨æ”»é˜²ï¼ŒloadInsertedDylibå†…éƒ¨ä¼šä»DYLD_ROOT_PATHã€LD_LIBRARY_PATHã€DYLD_FRAMEWORK_PATHç­‰è·¯å¾„æŸ¥æ‰¾dylibå¹¶ä¸”æ£€æŸ¥ä»£ç ç­¾åï¼Œæ— æ•ˆåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ 3.7 é“¾æ¥ä¸»ç¨‹åºå’Œæ’å…¥çš„åº“ï¼Œæ‰§è¡Œç¬¦å·æ›¿æ¢123456789101112131415161718192021// link main executablegLinkContext.linkingMainExecutable = true;link(sMainExecutable, sEnv.DYLD_BIND_AT_LAUNCH, true, ImageLoader::RPathChain(NULL, NULL), -1);sMainExecutable-&gt;setNeverUnloadRecursive();if ( sMainExecutable-&gt;forceFlat() ) { gLinkContext.bindFlat = true; gLinkContext.prebindUsage = ImageLoader::kUseNoPrebinding;}if ( sInsertedDylibCount &gt; 0 ) { for(unsigned int i=0; i &lt; sInsertedDylibCount; ++i) { ImageLoader* image = sAllImages[i+1]; link(image, sEnv.DYLD_BIND_AT_LAUNCH, true, ImageLoader::RPathChain(NULL, NULL), -1); image-&gt;setNeverUnloadRecursive(); } for(unsigned int i=0; i &lt; sInsertedDylibCount; ++i) { ImageLoader* image = sAllImages[i+1]; image-&gt;registerInterposing(gLinkContext); }} ç‚¹å‡»è¿›å…¥ link å‡½æ•° , link å‡½æ•°ä¸­æœ‰ä¸€ç³»åˆ— recursiveLoadLibraries , recursiveBindWithAccounting -&gt; recursiveBind , ä¹Ÿå°±æ˜¯é€’å½’è¿›è¡Œç¬¦å·ç»‘å®šçš„è¿‡ç¨‹ . link å‡½æ•°æ‰§è¡Œå®Œæ¯•ä¹‹å , dyld :: main ä¼šè°ƒç”¨ sMainExecutable-&gt;weakBind(gLinkContext); è¿›è¡Œå¼±ç»‘å®š , æ‡’åŠ è½½ç»‘å®š , ä¹Ÿå°±æ˜¯è¯´å¼±ç»‘å®šä¸€å®šå‘ç”Ÿåœ¨ å…¶ä»–åº“é“¾æ¥ç»‘å®šå®Œæˆä¹‹å . ç»‘å®šçš„è¿‡ç¨‹å°±æ˜¯æˆ‘ä»¬ä¹‹å‰åˆ†æçš„å…±äº«ç¼“å­˜ç»‘å®šçš„è¿‡ç¨‹ . èµ°åˆ°äº†è¿™é‡Œ , ä¸»ç¨‹åºå·²ç»å®ä¾‹åŒ–å®Œæ¯• , ä½†è¿˜æ²¡æœ‰åŠ è½½ , framework å·²ç»åŠ è½½å®Œæ¯•äº† , é‚£è®²åˆ°è¿™æ’ä¸€å¥é¢˜å¤–è¯ , ä¸åŒ framework , è°å…ˆä¼šè¢«åŠ è½½ ? å…¶å®æ ¹æ®äºŒè¿›åˆ¶é¡ºåºæœ‰å…³ , Xcode ä¸­å¯ä»¥è‡ªç”±è°ƒæ•´ : æ‹–åŠ¨å°±å¯ä»¥è‡ªå·±è°ƒæ•´é¡ºåºäº† , ç¼–è¯‘é¡ºåºå°±ä¼šæ ¹æ®è¿™ä¸ªé¡ºåºæ¥ , åŒæ ·ä½ å¯ä»¥ä½¿ç”¨ MachOView æ¥æŸ¥çœ‹äºŒè¿›åˆ¶é¡ºåº . è‡³æ­¤ , é…ç½®ç¯å¢ƒå˜é‡ -&gt; åŠ è½½å…±äº«ç¼“å­˜ -&gt; å®ä¾‹åŒ–ä¸»ç¨‹åº -&gt; åŠ è½½åŠ¨æ€åº“ -&gt; é“¾æ¥åŠ¨æ€åº“ å°±å·²ç»å®Œæˆäº† . æ¥ä¸‹æ¥æ˜¯é‡ä¸­ä¹‹é‡ 3.8 æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•å›é¡¾ä¸€ä¸‹å‡½æ•°è°ƒç”¨æ ˆï¼š â‘ initializeMainExecutableæ–¹æ³•è°ƒç”¨runInitializers 12345678910111213141516171819202122232425262728void initializeMainExecutable(){ // record that we've reached this step gLinkContext.startedInitializingMainExecutable = true; // run initialzers for any inserted dylibs ImageLoader::InitializerTimingList initializerTimes[allImagesCount()]; initializerTimes[0].count = 0; const size_t rootCount = sImageRoots.size(); if ( rootCount &gt; 1 ) { for(size_t i=1; i &lt; rootCount; ++i) { sImageRoots[i]-&gt;runInitializers(gLinkContext, initializerTimes[0]); } } // run initializers for main executable and everything it brings up sMainExecutable-&gt;runInitializers(gLinkContext, initializerTimes[0]); // register cxa_atexit() handler to run static terminators in all loaded images when this process exits if ( gLibSystemHelpers != NULL ) (*gLibSystemHelpers-&gt;cxa_atexit)(&amp;runAllStaticTerminators, NULL, NULL); // dump info if requested if ( sEnv.DYLD_PRINT_STATISTICS ) ImageLoader::printStatistics((unsigned int)allImagesCount(), initializerTimes[0]); if ( sEnv.DYLD_PRINT_STATISTICS_DETAILS ) ImageLoaderMachO::printStatisticsDetails((unsigned int)allImagesCount(), initializerTimes[0]);} â‘¡runInitializersè°ƒç”¨processInitializersä¸ºåˆå§‹åŒ–åšå‡†å¤‡ 12345678910111213void ImageLoader::runInitializers(const LinkContext&amp; context, InitializerTimingList&amp; timingInfo){ uint64_t t1 = mach_absolute_time(); mach_port_t thisThread = mach_thread_self(); ImageLoader::UninitedUpwards up; up.count = 1; up.images[0] = this; processInitializers(context, thisThread, timingInfo, up); context.notifyBatch(dyld_image_state_initialized, false); mach_port_deallocate(mach_task_self(), thisThread); uint64_t t2 = mach_absolute_time(); fgTotalInitTime += (t2 - t1);} â‘¢processInitializersä¸­éå†imageï¼ŒrecursiveInitializationé€’å½’åˆå§‹åŒ–é•œåƒ 12345678910111213141516void ImageLoader::processInitializers(const LinkContext&amp; context, mach_port_t thisThread, InitializerTimingList&amp; timingInfo, ImageLoader::UninitedUpwards&amp; images){ uint32_t maxImageCount = context.imageCount()+2; ImageLoader::UninitedUpwards upsBuffer[maxImageCount]; ImageLoader::UninitedUpwards&amp; ups = upsBuffer[0]; ups.count = 0; // Calling recursive init on all images in images list, building a new list of // uninitialized upward dependencies. for (uintptr_t i=0; i &lt; images.count; ++i) { images.images[i]-&gt;recursiveInitialization(context, thisThread, images.images[i]-&gt;getPath(), timingInfo, ups); } // If any upward dependencies remain, init them. if ( ups.count &gt; 0 ) processInitializers(context, thisThread, timingInfo, ups);} ç‚¹è¿›å»å´åªæœ‰å£°æ˜ï¼Œshift+cmd+Oæœç´¢recursiveInitialization â‘£recursiveInitializationè·å–åˆ°é•œåƒçš„åˆå§‹åŒ– 1234567891011121314151617void ImageLoader::recursiveInitialization(const LinkContext&amp; context, mach_port_t this_thread, const char* pathToInitialize, InitializerTimingList&amp; timingInfo, UninitedUpwards&amp; uninitUps){ ... uint64_t t1 = mach_absolute_time(); fState = dyld_image_state_dependents_initialized; oldState = fState; context.notifySingle(dyld_image_state_dependents_initialized, this, &amp;timingInfo); // initialize this image bool hasInitializers = this-&gt;doInitialization(context); // let anyone know we finished initializing this image fState = dyld_image_state_initialized; oldState = fState; context.notifySingle(dyld_image_state_initialized, this, NULL); ...} â‘¤notifySingleè·å–åˆ°é•œåƒçš„å›è°ƒ 1234567891011121314151617static void notifySingle(dyld_image_states state, const ImageLoader* image, ImageLoader::InitializerTimingList* timingInfo){ ... if ( (state == dyld_image_state_dependents_initialized) &amp;&amp; (sNotifyObjCInit != NULL) &amp;&amp; image-&gt;notifyObjC() ) { uint64_t t0 = mach_absolute_time(); dyld3::ScopedTimer timer(DBG_DYLD_TIMING_OBJC_INIT, (uint64_t)image-&gt;machHeader(), 0, 0); (*sNotifyObjCInit)(image-&gt;getRealPath(), image-&gt;machHeader()); uint64_t t1 = mach_absolute_time(); uint64_t t2 = mach_absolute_time(); uint64_t timeInObjC = t1-t0; uint64_t emptyTime = (t2-t1)*100; if ( (timeInObjC &gt; emptyTime) &amp;&amp; (timingInfo != NULL) ) { timingInfo-&gt;addTime(image-&gt;getShortName(), timeInObjC); } } ...} notifySingleä¸­å¹¶æ²¡æœ‰æ‰¾åˆ°å‡½æ•°è°ƒç”¨æ ˆä¸­çš„load_imagesï¼Œå…¶å®è¿™æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°çš„è°ƒç”¨ ã€â‘¥ã€‘sNotifyObjCInitåœ¨registerObjCNotifierså‡½æ•°ä¸­èµ‹å€¼ 1234567void registerObjCNotifiers(_dyld_objc_notify_mapped mapped, _dyld_objc_notify_init init, _dyld_objc_notify_unmapped unmapped){ // record functions to call sNotifyObjCMapped = mapped; sNotifyObjCInit = init; sNotifyObjCUnmapped = unmapped;} â‘¦registerObjCNotifiersåœ¨_dyld_objc_notify_registerå‡½æ•°ä¸­è¢«è°ƒç”¨ï¼Œè¿™ä¸ªå‡½æ•°åªåœ¨è¿è¡Œæ—¶æä¾›ç»™objcä½¿ç”¨ 1234567891011121314151617181920212223void _dyld_objc_notify_register(_dyld_objc_notify_mapped mapped, _dyld_objc_notify_init init, _dyld_objc_notify_unmapped unmapped){ dyld::registerObjCNotifiers(mapped, init, unmapped);}// _objc_init è°ƒç”¨`_dyld_objc_notify_register`ï¼Œå¹¶è°ƒç”¨`load_image`void _objc_init(void){ static bool initialized = false; if (initialized) return; initialized = true; // fixme defer initialization until an objc-using image is found? environ_init(); tls_init(); static_init(); lock_init(); exception_init(); _dyld_objc_notify_register(&amp;map_images, load_images, unmap_image);} â‘§context.notifySingleä¹‹åï¼Œè°ƒç”¨ImageLoaderMachO::doInitializationï¼Œå†…éƒ¨è°ƒç”¨ doImageInit ImageLoaderMachO::doModInitFunctions â‘¨doImageInit-&gt;libSystemInitialized-&gt;ã€æ ¹æ®libObjcæºç åˆ†æå¾—åˆ°ã€‘libdispatch_init-&gt;_os_object_initï¼Œå†…éƒ¨è°ƒç”¨_objc_init éªŒè¯ï¼š æˆ‘ä»¬ç›´æ¥é€šè¿‡ LLDB å¤§æ³•æ¥æ–­ç‚¹è°ƒè¯• libObjc æºç ä¸­çš„ _objc_initï¼Œç„¶åé€šè¿‡ bt å‘½ä»¤æ‰“å°å‡ºå½“å‰çš„è°ƒç”¨å †æ ˆï¼Œæ­¤åˆ»ä¸€åˆ‡çš„ä¸€åˆ‡éƒ½æ˜¯é‚£ä¹ˆçš„æ¸…æ™°æ˜äº†ï¼š â‘©doModInitFunctionså†…éƒ¨è°ƒç”¨__mod_init_funcs sectionï¼Œä¹Ÿå°±æ˜¯constructoræ–¹æ³•â€”â€”C++æ„é€ æ–¹æ³• initializeMainExecutableæ€»ç»“ï¼š runInitializers-&gt;processInitializersä¸­ï¼Œéå†recursiveInitialization ç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶ï¼Œè¿›è¡Œlibsystemåˆå§‹åŒ–â€”â€”doInitialization-&gt;doImageInit-&gt; libSystemInitialized libsystemçš„åˆå§‹åŒ–ï¼Œä¼šè°ƒç”¨èµ·libdispatch_initï¼Œlibdispatchåˆå§‹åŒ–ä¼šè°ƒç”¨_os_object_initï¼Œ å†…éƒ¨è°ƒç”¨äº†_objc_init _objc_initä¸­æ³¨å†Œå¹¶ä¿å­˜äº†map_imagesã€load_imagesã€unmap_imageå‡½æ•°åœ°å€ æ³¨å†Œå®Œæ¯•ç»§ç»­å›åˆ°recursiveInitializationé€’å½’ä¸‹ä¸€æ¬¡è°ƒç”¨ 3.9 å¯»æ‰¾ä¸»ç¨‹åºå…¥å£12// find entry point for main executableresult = (uintptr_t)sMainExecutable-&gt;getEntryFromLC_MAIN(); å››ã€dyldåŠ è½½è¿‡ç¨‹ç¤ºæ„å›¾ dyldåŠ è½½æµç¨‹ä»£ç è¾ƒå¤šï¼Œç¬¬ä¸€æ¬¡çœ‹å¤§æ¦‚äº†è§£è¿™ä¸ªè¿‡ç¨‹å³å¯ äº”ã€æ€»ç»“ PSæˆ‘çš„dyldæºç (ç‰ˆæœ¬ï¼šdyld-635.2) å‚è€ƒiOSæ¢ç´¢ æµ…å°è¾„æ­¢dyldåŠ è½½æµç¨‹ æ›´æ·±å…¥ï¼šiOS åº•å±‚ - ä»å¤´æ¢³ç† dyld åŠ è½½æµç¨‹ iOS åº•å±‚æ¢ç´¢ - åº”ç”¨åŠ è½½","link":"/2021/01/16/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/07%E4%B8%8B-dyld%E5%88%86%E6%9E%90/"},{"title":"09-åˆ†ç±»ã€ç±»æ‹“å±•çš„åŠ è½½è¿‡ç¨‹ &amp; loadã€initializeåˆ†æ","text":"å‰è¨€åœ¨å¼€å§‹æ­£æ–‡å‰ï¼Œå…ˆçœ‹ä¸€ä¸‹runtimeç›¸å…³çŸ¥è¯†çš„è¿ç”¨ roå’Œrwè¡ç”Ÿå‡ºæ¥çš„é—®é¢˜1.åŠ¨æ€åˆ›å»ºç±»çš„æ—¶å€™ï¼Œèƒ½å¦å…ˆæ³¨å†Œåˆ°å†…å­˜ç„¶åå†æ·»åŠ æˆå‘˜å˜é‡ï¼Ÿå³ä¸‹é¢2ã€3ä¸¤æ­¥èƒ½å¦è°ƒæ¢é¡ºåºï¼Ÿ 1234567// è¿™æ˜¯æ­£ç¡®é¡ºåºï¼š// 1: åŠ¨æ€åˆ›å»ºç±»Class LGPerson = objc_allocateClassPair([NSObject class], &quot;LGPerson&quot;, 0);// 2: æ·»åŠ æˆå‘˜å˜é‡ class_addIvar(LGPerson, &quot;lgName&quot;, sizeof(NSString *), log2(sizeof(NSString *)), &quot;@&quot;);// 3: æ³¨å†Œåˆ°å†…å­˜objc_registerClassPair(LGPerson); ç­”ï¼šä¸å¯ä»¥ åŸå› ï¼š æˆå‘˜å˜é‡å­˜å‚¨åœ¨roå½“ä¸­ï¼Œroåœ¨ç¼–è¯‘åå°±ä¸èƒ½æ”¹äº†ã€‚è·Ÿå±æ€§ä¸ä¸€æ · å¯ä»¥é€šè¿‡è·‘æºç æ–­ç‚¹è°ƒè¯•çœ‹ä¸€ä¸‹ï¼š æ³¨å†Œåˆ°å†…å­˜çš„objc_registerClassPairæ–¹æ³•ä¸­ä¼šè°ƒç”¨changeInfoæ–¹æ³•ï¼Œæ”¹å˜äº†ä¿¡æ¯ã€‚å¦‚æœåœ¨è¿™ä¹‹åè°ƒç”¨class_addIvaræ–¹æ³•ï¼Œä¼šèµ°åˆ°åˆ†æ”¯ä¸­ï¼Œç›´æ¥è¿”å›NOï¼Œå¯¼è‡´æ·»åŠ å¤±è´¥ã€‚å› æ­¤é¡ºåºä¸èƒ½è°ƒæ¢ã€‚ 2.æ³¨æ„ç‚¹ï¼šåŠ¨æ€æ·»åŠ property(æˆå‘˜å±æ€§)åï¼Œè®°å¾—è¦æ·»åŠ ç›¸åº”çš„getterå’Œsetteræ–¹æ³•ï¼Œå¦åˆ™ç»™å±æ€§è®¾å€¼ä¼šä¸æˆåŠŸã€‚ 123456789101112131415// 1.åŠ¨æ€åˆ›å»ºç±»Class LGPerson = objc_allocateClassPair([NSObject class], &quot;LGPerson&quot;, 0);// 2.æ³¨å†Œåˆ°å†…å­˜objc_registerClassPair(LGPerson);// 3.æ·»åŠ propertylg_class_addProperty(LGPerson, &quot;subject&quot;);// 4.æ·»åŠ setter + getter æ–¹æ³•class_addMethod(LGPerson, @selector(setSubject:), (IMP)lgSetter, &quot;v@:@&quot;);class_addMethod(LGPerson, @selector(subject), (IMP)lgName, &quot;@@:&quot;);// å¼€å§‹ä½¿ç”¨id person = [LGPerson alloc];[person setValue:@&quot;master&quot; forKey:@&quot;subject&quot;];NSLog(@&quot;%@&quot;,[person valueForKey:@&quot;subject&quot;]); ç•™æ„è¿™é‡Œçš„2ã€3ä¸¤æ­¥ï¼Œå…ˆæ³¨å†Œåˆ°å†…å­˜ï¼Œç„¶åå†æ·»åŠ çš„æˆå‘˜å±æ€§ï¼Œä¸ºä»€ä¹ˆè¿™é‡Œå°±å¯ä»¥äº†ï¼Ÿ å› ä¸ºpropertieså­˜å‚¨åœ¨rwå½“ä¸­ï¼Œæ˜¯å¯ä»¥åŠ¨æ€æ”¹å˜çš„ã€‚ 3.ç»ƒä¹ ä½¿ç”¨api-ç”¨runtimeåŠ¨æ€åˆ›å»ºç±» 12345678910111213141516171819202122232425// 1: åŠ¨æ€åˆ›å»ºç±»Class LGPerson = objc_allocateClassPair([NSObject class], &quot;LGPerson&quot;, 0);// 2: æ·»åŠ æˆå‘˜å˜é‡ class_addIvar(LGPerson, &quot;lgName&quot;, sizeof(NSString *), log2(sizeof(NSString *)), &quot;@&quot;);// 3: æ³¨å†Œåˆ°å†…å­˜objc_registerClassPair(LGPerson); // 3.1 æ·»åŠ property - rwlg_class_addProperty(LGPerson, &quot;subject&quot;);lg_printerProperty(LGPerson);// 3.2 æ·»åŠ setter + getter æ–¹æ³•class_addMethod(LGPerson, @selector(setSubject:), (IMP)lgSetter, &quot;v@:@&quot;);class_addMethod(LGPerson, @selector(subject), (IMP)lgName, &quot;@@:&quot;);// å¼€å§‹ä½¿ç”¨id person = [LGPerson alloc];[person setValue:@&quot;KC&quot; forKey:@&quot;lgName&quot;];NSLog(@&quot;%@&quot;,[person valueForKey:@&quot;lgName&quot;]);[person setValue:@&quot;master&quot; forKey:@&quot;subject&quot;];NSLog(@&quot;%@&quot;,[person valueForKey:@&quot;subject&quot;]); å¸¦æ³¨é‡Šçš„ç›¸å…³api 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758/** * åˆ›å»ºç±»å¯¹ *superClass: çˆ¶ç±»ï¼Œä¼ Nilä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ ¹ç±» *name: ç±»å *extraBytes: 0 *return:è¿”å›æ–°ç±»ï¼Œåˆ›å»ºå¤±è´¥è¿”å›Nilï¼Œå¦‚æœç±»åå·²ç»å­˜åœ¨ï¼Œåˆ™åˆ›å»ºå¤±è´¥ objc_allocateClassPair(&lt;#Class _Nullable __unsafe_unretained superclass#&gt;, &lt;#const char * _Nonnull name#&gt;, &lt;#size_t extraBytes#&gt;) *//** *æ·»åŠ æˆå‘˜å˜é‡ * *cls å¾€å“ªä¸ªç±»æ·»åŠ  *name æ·»åŠ çš„åå­— *size å¤§å° *alignment å¯¹é½å¤„ç†æ–¹å¼ *types ç­¾å * *è¿™ä¸ªå‡½æ•°åªèƒ½åœ¨objc_allocateClassPairå’Œobjc_registerClassPairä¹‹å‰è°ƒç”¨ã€‚ä¸æ”¯æŒå‘ç°æœ‰ç±»æ·»åŠ ä¸€ä¸ªå®ä¾‹å˜é‡ã€‚ *è¿™ä¸ªç±»ä¸èƒ½æ˜¯å…ƒç±»ã€‚ä¸æ”¯æŒåœ¨å…ƒç±»ä¸­æ·»åŠ ä¸€ä¸ªå®ä¾‹å˜é‡ã€‚ *å®ä¾‹å˜é‡çš„æœ€å°å¯¹é½ä¸º1 &lt;&lt; alignã€‚å®ä¾‹å˜é‡çš„æœ€å°å¯¹é½ä¾èµ–äºivarçš„ç±»å‹å’Œæœºå™¨æ¶æ„ã€‚å¯¹äºä»»ä½•æŒ‡é’ˆç±»å‹çš„å˜é‡ï¼Œè¯·é€šè¿‡log2(sizeof(pointer_type))ã€‚ class_addIvar(&lt;#Class _Nullable __unsafe_unretained cls#&gt;, &lt;#const char * _Nonnull name#&gt;, &lt;#size_t size#&gt;, &lt;#uint8_t alignment#&gt;, &lt;#const char * _Nullable types#&gt;) *//** *å¾€å†…å­˜æ³¨å†Œç±» * * cls è¦æ³¨å†Œçš„ç±» * * objc_registerClassPair(&lt;#Class _Nonnull __unsafe_unretained cls#&gt;) *//** *å¾€ç±»é‡Œé¢æ·»åŠ æ–¹æ³• * *cls è¦æ·»åŠ æ–¹æ³•çš„ç±» *sel æ–¹æ³•ç¼–å· *imp å‡½æ•°å®ç°æŒ‡é’ˆ *types ç­¾å * *class_addMethod(&lt;#Class _Nullable __unsafe_unretained cls#&gt;, &lt;#SEL _Nonnull name#&gt;, &lt;#IMP _Nonnull imp#&gt;, &lt;#const char * _Nullable types#&gt;) *//** *å¾€ç±»é‡Œé¢æ·»åŠ å±æ€§ * *cls è¦æ·»åŠ å±æ€§çš„ç±» *name å±æ€§åå­— *attributes å±æ€§çš„å±æ€§æ•°ç»„ã€‚ *attriCount å±æ€§ä¸­å±æ€§çš„æ•°é‡ã€‚ * *class_addProperty(&lt;#Class _Nullable __unsafe_unretained cls#&gt;, &lt;#const char * _Nonnull name#&gt;, &lt;#const objc_property_attribute_t * _Nullable attributes#&gt;, &lt;#unsigned int attributeCount#&gt;) */ ä¸€ã€åˆæ¢æ‡’åŠ è½½ç±»ä¸Šä¸€ç« æˆ‘ä»¬æ¢ç´¢äº† iOS ä¸­ç±»çš„åŠ è½½ï¼Œè®©æˆ‘ä»¬ç®€å•å›é¡¾ä¸€ä¸‹å¤§æ¦‚çš„æµç¨‹ã€‚ 1.1 ç±»çš„åŠ è½½å›é¡¾ libObjc å‘ dyld æ³¨å†Œäº†å›è°ƒ _dyld_objc_notify_registerï¼Œå½“ dyld æŠŠ App ä»¥åŠ App æ‰€ä¾èµ–çš„ä¸€ç³»åˆ— Mach-O é•œåƒåŠ è½½åˆ°å½“å‰ App è¢«åˆ†é…çš„å†…å­˜ç©ºé—´ä¹‹åï¼Œdyld ä¼šé€šè¿‡ _dyld_objc_notify_mapped ä¹Ÿå°±æ˜¯ map_imagesæ¥é€šçŸ¥ libObjc æ¥å®Œæˆå…·ä½“çš„åŠ è½½å·¥ä½œï¼Œmap_images è¢«è°ƒç”¨ä¹‹åä¼šæ¥åˆ° _read_images _read_images ä¸»è¦ä¼šè¿›è¡Œç±»çš„åŠ è½½å·¥ä½œï¼Œä¼šæ’å…¥ æ‰€æœ‰çš„ç±» åˆ° gdb_objc_realized_classes å“ˆå¸Œè¡¨ä¸­ï¼ˆæ’å…¥æ–¹å¼ä¸º ç±»åä¸º keyï¼Œç±»å¯¹è±¡ä¸ºvalue, ä¸åŒ…æ‹¬é€šè¿‡ å…±äº«ç¼“å­˜ é‡Œé¢çš„ç±»ï¼‰ï¼Œè¿™ä¸ªè¡¨çš„ç±»å‹ä¸º NXMapTableï¼Œå¯ä»¥ç±»æ¯”ä¸º NSDictionaryï¼›åŒæ—¶è¿˜ä¼šæŠŠç±»æ’å…¥åˆ° allocatedClasses è¿™ä¸ªé›†åˆé‡Œé¢ï¼Œé›†åˆçš„ç±»å‹ä¸º NXHashTableï¼Œå¯ä»¥ç±»æ¯”ä¸º NSSetã€‚ å¯¹æ‰€æœ‰çš„ç±»è¿›è¡Œé‡æ˜ å°„ å°†æ‰€æœ‰çš„ SEL æ’å…¥åˆ° namedSelectors å“ˆå¸Œè¡¨ä¸­(æ’å…¥æ–¹å¼ä¸ºï¼šSEL åç§°ä¸º keyï¼ŒSEL ä¸ºvalue) ä¿®å¤å‡½æ•°æŒ‡é’ˆé—ç•™ å°†æ‰€æœ‰çš„ Protocol æ’å…¥åˆ° readProtocol å“ˆå¸Œè¡¨ä¸­(æ’å…¥æ–¹å¼ä¸ºï¼šProtocol åç§°ä¸º keyï¼ŒProtocol ä¸º value) å¯¹æ‰€æœ‰çš„ Protocol åšé‡æ˜ å°„ åˆå§‹åŒ–æ‰€æœ‰çš„éæ‡’åŠ è½½ç±»ï¼ŒåŒ…æ‹¬ rw å’Œ ro çš„åˆå§‹åŒ–æ“ä½œ å¤„ç†æ‰€æœ‰çš„åˆ†ç±»(åŒ…æ‹¬ç±»çš„åˆ†ç±»å’Œå…ƒç±»çš„åˆ†ç±») 1.2 éªŒè¯ç±»çš„åŠ è½½æµç¨‹æˆ‘ä»¬å¤§è‡´æ˜ç™½äº†ç±»çš„åŠ è½½æµç¨‹ï¼Œæ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬åœ¨ _read_images æºç ä¸­æ‰“å°ä¸€ä¸‹ç±»åŠ è½½ä¹‹åçš„ç»“æœéªŒè¯ä¸€ä¸‹æ˜¯å¦åŠ è½½äº†æˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„ç±»ã€‚ å‡†å¤‡ä»£ç ï¼šæœ‰ä¸‰ä¸ªéå¸¸çº¯å‡€çš„ç±»ï¼š LGPerson ã€ LGStudent ã€ LGTeacher å…¶ä¸­ LGStudent å’Œ LGTeacher å†…éƒ¨å®ç°äº† +load æ–¹æ³•ã€‚è€Œ LGPerson æ²¡æœ‰å®ç° +load æ–¹æ³•ã€‚ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å¢åŠ ä¸€è¡Œä»£ç : 1printf(&quot;_getObjc2NonlazyClassList Class:%s\\n&quot;,cls-&gt;mangledName()); æ¥ç€æˆ‘ä»¬è§‚å¯Ÿæ‰“å°ç»“æœ: 1.3 æ‡’åŠ è½½ç±»çš„å‘ç°æˆ‘ä»¬è¿™ä¸ªæ—¶å€™è§‚å¯Ÿ _read_images æºç è¿™éƒ¨åˆ†çš„æ³¨é‡Š: Realize non-lazy classes (for +load methods and static instances) å®ç°éæ‡’åŠ è½½ç±»(å®ç°äº† +load æ–¹æ³•å’Œé™æ€å®ä¾‹) æ„æ€å°±æ˜¯æ²¡æœ‰å®ç° +load æ–¹æ³•çš„ç±»å°±æ˜¯**æ‡’åŠ è½½ç±»ï¼Œè¿™ç§ç±»å¹¶ä¸ä¼šåœ¨ **_read_images ç¯èŠ‚è¢«åŠ è½½ã€‚æˆ‘ä»¬è‡ªå·±å®ç°äº† +load æ–¹æ³•çš„ä¸¤ä¸ªç±»å’Œå…¶ä»–ç³»ç»Ÿå†…ç½®çš„ç±»ç”±äºæ˜¯éæ‡’åŠ è½½ç±»ï¼Œæ‰€ä»¥ä¼šåœ¨è¿™é‡Œæ‰“å°ã€‚ é‚£ä¹ˆæ‡’åŠ è½½ç±»åº”è¯¥æ˜¯åœ¨å“ªé‡ŒåŠ è½½å‘¢ï¼Ÿæˆ‘ä»¬ç¨å¾®æ€è€ƒä¸€ä¸‹ï¼Œæˆ‘ä»¬ä¸€èˆ¬ç¬¬ä¸€æ¬¡æ“ä½œä¸€ä¸ªç±»æ˜¯ä¸æ˜¯åœ¨åˆå§‹åŒ–è¿™ä¸ªç±»çš„æ—¶å€™ï¼Œè€Œåˆå§‹åŒ–ç±»ä¸å°±æ˜¯å‘é€ alloc æ¶ˆæ¯å—ï¼Œè€Œæ ¹æ®æˆ‘ä»¬å‰é¢æ¢ç´¢æ¶ˆæ¯æŸ¥æ‰¾çš„çŸ¥è¯†ï¼Œåœ¨ç¬¬ä¸€æ¬¡å‘é€æŸä¸ªæ¶ˆæ¯çš„æ—¶å€™ï¼Œæ˜¯æ²¡æœ‰ç¼“å­˜çš„ï¼Œæ‰€ä»¥ä¼šèµ°æ¶ˆæ¯çš„æ…¢é€ŸæŸ¥æ‰¾è¿‡ç¨‹ï¼Œç„¶åå°±æ¥åˆ°ä¸€ä¸ªéå¸¸é‡è¦çš„æ–¹æ³•ï¼šlookUpImpOrForward ï¼Œæˆ‘ä»¬åœ¨ main.m ä¸­ LGPerson ç±»åˆå§‹åŒ–çš„åœ°æ–¹å’Œ lookUpImpOrForward å…¥å£å¤„æ‰“ä¸Šæ–­ç‚¹: Tips: è¿™é‡Œæœ‰ä¸ªå°æŠ€å·§ï¼Œæˆ‘ä»¬å…ˆæ‰“å¼€ main.m æ–‡ä»¶ä¸­lookUpImpOrForward å¤„çš„æ–­ç‚¹çš„æ–­ç‚¹ï¼Œç­‰æ–­ç‚¹æ¥åˆ°äº†æˆ‘ä»¬æƒ³è¦æ¢ç´¢çš„ LGPerson åˆå§‹åŒ–çš„ä½ç½®çš„æ—¶å€™ï¼Œæˆ‘ä»¬å†æ‰“å¼€ lookUpImpOrForward å¤„çš„æ–­ç‚¹ï¼Œè¿™æ ·æ‰èƒ½ç¡®ä¿å½“å‰æ‰§è¡Œ lookUpImpOrForward çš„æ˜¯æˆ‘ä»¬çš„ç ”ç©¶å¯¹è±¡ LGPerson å› ä¸ºæˆ‘ä»¬æ–­ç‚¹çš„ä½ç½®æ˜¯ LGPerson ç±»å‘é€ alloc æ¶ˆæ¯ï¼Œè€Œæ˜¾ç„¶ alloc ä½œä¸ºç±»æ–¹æ³•æ˜¯å­˜å‚¨åœ¨å…ƒç±»ä¸Šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ lookUpImpOrForward çš„ cls å…¶å®æ˜¯ LGPerson å…ƒç±»ã€‚é‚£ä¹ˆ inst å°±åº”è¯¥æ˜¯çœŸæ­£çš„LGPersonç±»å¯¹è±¡ï¼Œå¯å®é™…å¦‚ä¸‹å›¾æ‰€ç¤ºï¼šï¼ˆæœªåˆå§‹åŒ–æ‰€ä»¥çœ‹ä¸å‡ºæ˜¯å“ªä¸ªç±»ï¼‰ æ­¤æ—¶çš„ inst åªæ˜¯ä¸€ä¸ªåœ°å€ï¼Œè¯´æ˜è¿˜æ²¡æœ‰åˆå§‹åŒ–ã€‚æˆ‘ä»¬è®©ç¨‹åºæ¥ç€ä¸‹é¢èµ°ï¼Œä¼šæ¥åˆ°è¿™æ ·ä¸€è¡Œä»£ç : è¿™é‡Œçš„ if åˆ¤æ–­é€šè¿‡æ–¹æ³•åæˆ‘ä»¬ä¸éš¾çœ‹å‡ºæ˜¯åªæœ‰å½“ cls æœªå®ç°çš„æ—¶å€™æ‰ä¼šèµ°é‡Œé¢çš„realizeClassMaybeSwiftAndLeaveLocked æ–¹æ³•ï¼Œé‚£ä¹Ÿå°±æ˜¯è¯´ LGPerson å…ƒç±»æ²¡æœ‰è¢«å®ç°ï¼Œä¹Ÿå°±æ˜¯ LGPerson ç±»æ²¡æœ‰å®ç°æˆ–è€…è¯´æ²¡æœ‰è¢«åŠ è½½ã€‚ æˆ‘ä»¬å°±é¡ºç€ realizeClassMaybeSwiftAndLeaveLocked æ–¹æ³•å¾€ä¸‹é¢èµ°èµ°çœ‹ï¼Œçœ‹åˆ°åº•æ˜¯åœ¨å“ªæŠŠæˆ‘ä»¬è¿™ä¸ªæ‡’åŠ è½½ç±»ç»™åŠ è½½å‡ºæ¥çš„: 123456789101112131415161718192021static ClassrealizeClassMaybeSwiftMaybeRelock(Class cls, mutex_t&amp; lock, bool leaveLocked){ lock.assertLocked(); if (!cls-&gt;isSwiftStable_ButAllowLegacyForNow()) { // Non-Swift class. Realize it now with the lock still held. // fixme wrong in the future for objc subclasses of swift classes realizeClassWithoutSwift(cls); if (!leaveLocked) lock.unlock(); } else { // Swift class. We need to drop locks and call the Swift // runtime to initialize it. lock.unlock(); cls = realizeSwiftClass(cls); assert(cls-&gt;isRealized()); // callback must have provoked realization if (leaveLocked) lock.lock(); } return cls;} æˆ‘ä»¬ä¸€è·¯è·Ÿéšæ–­ç‚¹æ¥åˆ°äº† realizeClassMaybeSwiftMaybeRelock æ–¹æ³•ï¼Œç„¶åæˆ‘ä»¬çœ‹åˆ°äº†æˆ‘ä»¬ç†Ÿæ‚‰çš„ä¸€ä¸ªæ–¹æ³• realizeClassWithoutSwift ï¼Œè¿™ä¸ªæ–¹æ³•å†…éƒ¨ä¼šè¿›è¡Œ ro/rw çš„èµ‹å€¼æ“ä½œä»¥åŠ category çš„ attatch ï¼Œå…³äºè¿™ä¸ªæ–¹æ³•æ›´å¤šå†…å®¹å¯ä»¥æŸ¥çœ‹ä¸Šä¸€ç¯‡æ–‡ç« ã€‚ æ¥ç€æˆ‘ä»¬è¿”å›åˆ° lookUpImpOrForward æ–¹æ³•ä¸­æ¥ï¼Œç„¶åè¿›è¡Œä¸€ä¸‹ LLDB æ‰“å°ï¼Œçœ‹ä¸€ä¸‹å½“å‰è¿™ä¸ª inst ä¹Ÿå°±æ˜¯ LGPerson å¯¹è±¡æ˜¯å¦å·²ç»è¢«åŠ è½½äº†ã€‚ é€šè¿‡ä¸Šé¢çš„æ‰“å°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° rw å·²ç»æœ‰å€¼äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ LGPerson ç±»è¢«åŠ è½½äº†ã€‚ æ€»ç»“ï¼š å¦‚æœç±»æ²¡æœ‰å®ç° load æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»å°±æ˜¯æ‡’åŠ è½½ç±»ï¼ˆç”¨åˆ°å†åŠ è½½ï¼‰ å¦‚æœç±»å®ç°äº† load æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»å°±æ˜¯éæ‡’åŠ è½½ç±»ï¼ˆæå‰åŠ è½½ï¼‰ã€‚ è°ƒç”¨å †æ ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š 1.4 æ‡’åŠ è½½ç±»çš„æµç¨‹å…³äºéæ‡’åŠ è½½ç±»çš„åŠ è½½æµç¨‹æˆ‘ä»¬å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œæˆ‘ä»¬æ€»ç»“ä¸‹æ‡’åŠ è½½ç±»çš„æµç¨‹ï¼š ç±»ç¬¬ä¸€æ¬¡å‘é€æ¶ˆæ¯çš„æ—¶å€™æ˜¯æ²¡æœ‰ç¼“å­˜çš„ï¼Œæ‰€ä»¥ä¼šæ¥åˆ° _class_lookupMethodAndLoadCache3 ï¼ˆè¿™ä¸ªæ–¹æ³•åœ¨05-æ–¹æ³•çš„æœ¬è´¨å’Œæ¶ˆæ¯æŸ¥æ‰¾æµç¨‹å·²ç»åˆ†æè¿‡äº†ï¼‰ _class_lookupMethodAndLoadCache3 ä¼šè°ƒç”¨ lookUpImpOrForward ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨å­¦ä¹  Runtime çš„è¿‡ç¨‹ä¸­éå¸¸é‡è¦ï¼ lookUpImpOrForward å†…éƒ¨ä¼šè¿›è¡Œä¸€ä¸‹åˆ¤æ–­ï¼Œå¦‚æœ cls æ²¡æœ‰è¢«å®ç°ï¼Œä¼šè°ƒç”¨ realizeClassMaybeSwiftAndLeaveLocked æ–¹æ³• realizeClassMaybeSwiftAndLeaveLocked æ–¹æ³•åˆä¼šè°ƒç”¨ realizeClassMaybeSwiftMaybeRelock æ–¹æ³• realizeClassMaybeSwiftMaybeRelock æ–¹æ³•å†…éƒ¨ä¼šè¿›è¡Œä¸€ä¸‹æ˜¯å¦æ˜¯ Swift çš„åˆ¤æ–­ï¼Œå¦‚æœä¸æ˜¯ Swift ç¯å¢ƒçš„è¯ï¼Œå°±ä¼šæ¥åˆ° realizeClassWithoutSwift ï¼Œæœ€ç»ˆæ‡’åŠ è½½çš„ç±»å°±åœ¨è¿™é‡ŒåŠ è½½ äºŒã€åˆ†ç±»çš„åº•å±‚å®ç°ç±»åˆ†ä¸ºæ‡’åŠ è½½ç±»å’Œéæ‡’åŠ è½½ç±»ï¼Œåˆ†ç±»åŒæ ·åˆ†ä¸ºæ‡’åŠ è½½åˆ†ç±»å’Œéæ‡’åŠ è½½åˆ†ç±»ã€‚åœ¨ç ”ç©¶åˆ†ç±»ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦äº†è§£ä¸‹åˆ†ç±»çš„åº•å±‚å®ç°ã€‚ 2.1 é‡å†™åˆ†ç±»æºæ–‡ä»¶é¦–å…ˆå‡†å¤‡ä¸€ä»½LGTeacher+test.mæ–‡ä»¶ï¼š åœ¨ç»ˆç«¯ä¸­ç”¨ clang å‘½ä»¤é‡å†™è¿™ä¸ªåˆ†ç±»æ–‡ä»¶ä¸ºc++æ–‡ä»¶ï¼š 1clang -rewrite-objc LGTeacher+test.m -o category.cpp ç„¶åæŸ¥çœ‹ category.cpp è¿™ä¸ªæ–‡ä»¶ï¼Œæ¥åˆ°æ–‡ä»¶å°¾éƒ¨å¯ä»¥çœ‹åˆ°: 123456789static struct _category_t _OBJC_$_CATEGORY_LGTeacher_$_test __attribute__ ((used, section (&quot;__DATA,__objc_const&quot;))) = { &quot;LGTeacher&quot;, 0, // &amp;OBJC_CLASS_$_LGTeacher, (const struct _method_list_t *)&amp;_OBJC_$_CATEGORY_INSTANCE_METHODS_LGTeacher_$_test, (const struct _method_list_t *)&amp;_OBJC_$_CATEGORY_CLASS_METHODS_LGTeacher_$_test, 0, (const struct _prop_list_t *)&amp;_OBJC_$_PROP_LIST_LGTeacher_$_test,}; å¯ä»¥çœ‹åˆ° LGTeacher+test åˆ†ç±»åœ¨åº•å±‚çš„å®ç°æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå…¶åå­—ä¸º _OBJC_$_CATEGORY_LGTeacher_$_test ï¼Œå¾ˆæ˜æ˜¾è¿™æ˜¯ä¸€ä¸ªæŒ‰è§„åˆ™ç”Ÿæˆçš„ç¬¦å·ï¼Œä¸­é—´çš„ LGTeacher æ˜¯ç±»åï¼Œåé¢çš„ test æ˜¯åˆ†ç±»çš„åå­—ã€‚ åŒæ—¶ï¼Œæˆ‘ä»¬åœ¨åé¢å¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„ä»£ç ï¼š 123static struct _category_t *L_OBJC_LABEL_CATEGORY_$ [1] __attribute__((used, section (&quot;__DATA, __objc_catlist,regular,no_dead_strip&quot;)))= { &amp;_OBJC_$_CATEGORY_LGTeacher_$_test,}; è¿™è¡¨æ˜åˆ†ç±»æ˜¯å­˜å‚¨åœ¨ __DATA æ®µçš„ __objc_catlist section é‡Œé¢çš„ã€‚ 2.2 åˆ†ç±»çš„å®šä¹‰æˆ‘ä»¬æ ¹æ® _category_t æ¥åˆ° libObjc æºç ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œä¸è¿‡æˆ‘ä»¬éœ€è¦å»æ‰ä¸€ä¸‹ _category_t çš„ä¸‹åˆ’çº¿ï¼Œç„¶åä¸éš¾æ‰¾åˆ°åˆ†ç±»çœŸæ­£çš„å®šä¹‰æ‰€åœ¨ï¼š 1234567891011121314151617struct category_t { const char *name; classref_t cls; struct method_list_t *instanceMethods; struct method_list_t *classMethods; struct protocol_list_t *protocols; struct property_list_t *instanceProperties; // Fields below this point are not always present on disk. struct property_list_t *_classProperties; method_list_t *methodsForMeta(bool isMeta) { if (isMeta) return classMethods; else return instanceMethods; } property_list_t *propertiesForMeta(bool isMeta, struct header_info *hi);}; æ ¹æ®åˆšæ‰ clang é‡å†™ä¹‹åçš„å†…å®¹ï¼Œæˆ‘ä»¬ä¸éš¾çœ‹å‡º name : æ˜¯åˆ†ç±»æ‰€å…³è”çš„ç±»ï¼Œä¹Ÿå°±æ˜¯ç±»çš„åå­—ï¼Œè€Œä¸æ˜¯åˆ†ç±»çš„åå­— cls : æˆ‘ä»¬åœ¨å‰é¢å¯ä»¥çœ‹åˆ° clang é‡å†™åè¿™ä¸ªå€¼ä¸º 0ï¼Œä½†æ˜¯åé¢æœ‰æ³¨é‡Šä¸º &amp;OBJC_CLASS_$_LGTeacher ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ç±»å¯¹è±¡çš„å®šä¹‰ï¼Œæ‰€ä»¥è¿™é‡Œå…¶å®å°±æ˜¯æˆ‘ä»¬è¦æ‰©å±•çš„ç±»å¯¹è±¡ï¼Œåªæ˜¯åœ¨ç¼–è¯‘æœŸè¿™ä¸ªå€¼å¹¶ä¸å­˜åœ¨ instanceMethods : åˆ†ç±»ä¸Šå­˜å‚¨çš„å®ä¾‹æ–¹æ³• classMethods ï¼šåˆ†ç±»ä¸Šå­˜å‚¨çš„ç±»æ–¹æ³• protocols ï¼šåˆ†ç±»æ‰€å®ç°çš„åè®® instanceProperties ï¼šåˆ†ç±»æ‰€å®šä¹‰çš„å®ä¾‹å±æ€§ï¼Œä¸è¿‡æˆ‘ä»¬ä¸€èˆ¬åœ¨åˆ†ç±»ä¸­æ·»åŠ å±æ€§éƒ½æ˜¯é€šè¿‡å…³è”å¯¹è±¡æ¥å®ç°çš„ _classProperties ï¼šåˆ†ç±»æ‰€å®šä¹‰çš„ç±»å±æ€§ã€‚ ä¸‰ã€åˆ†ç±»çš„åŠ è½½æˆ‘ä»¬ç°åœ¨çŸ¥é“äº†ç±»åˆ†ä¸ºäº† æ‡’åŠ è½½ç±» å’Œ éæ‡’åŠ è½½ç±» ï¼Œå®ƒä»¬çš„åŠ è½½æ—¶æœºæ˜¯ä¸ä¸€æ ·çš„ï¼Œåˆ†ç±»åŒæ ·åˆ†ä¸ºæ‡’åŠ è½½åˆ†ç±»å’Œéæ‡’åŠ è½½åˆ†ç±»ã€‚ åˆ†ç±»å¿…é¡»ä¾é™„äºç±»è€Œå­˜åœ¨ï¼Œå¦‚æœåªæœ‰åˆ†ç±»ï¼Œæ²¡æœ‰ç±»ï¼Œé‚£ä¹ˆä»é€»è¾‘ä¸Šæ˜¯è¯´ä¸é€šçš„ï¼Œå°±ç®—å®ç°äº†ï¼Œç¼–è¯‘å™¨ä¹Ÿä¼šå¿½ç•¥æ‰ã€‚ æ¥ä¸‹æ¥å¼€å§‹ç ”ç©¶ï¼š 3.1 æ‡’åŠ è½½åˆ†ç±»æ²¡æœ‰å®ç° load çš„åˆ†ç±»-&gt;æ²¡æœ‰æå‰åŠ è½½ï¼Œæ‰€ä»¥æ˜¯æ‡’åŠ è½½åˆ†ç±»ã€‚ 3.1.1 æ‡’åŠ è½½åˆ†ç±» + æ‡’åŠ è½½ç±»ä¹Ÿå°±æ˜¯ç±»å’Œåˆ†ç±»éƒ½ä¸å®ç° load æ–¹æ³•çš„æƒ…å†µã€‚ æ‡’åŠ è½½ç±»å‰é¢åˆ†æè¿‡äº†ï¼Œåœ¨å‘ç±»ç¬¬ä¸€æ¬¡å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œæ‡’åŠ è½½ç±»æ‰ä¼šå¼€å§‹åŠ è½½ã€‚ æ‡’åŠ è½½åˆ†ç±»æ¢ç´¢ï¼šåœ¨ realizeClassWithoutSwift æ–¹æ³•çš„æœ€åæœ‰ä¸€ä¸ª methodizeClass æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢ä¼šæœ‰ä¸€ä¸ª Attach categories çš„åœ°æ–¹ï¼ŒçŒœæµ‹æ‡’åŠ è½½åˆ†ç±»æ˜¯ä¸æ˜¯åœ¨è¿™é‡ŒåŠ è½½äº†ï¼Ÿ ä½†æ˜¯æˆ‘ä»¬æ–­ç‚¹ä¹‹åå‘ç°è¿™ä¸ªæ—¶å€™é€šè¿‡ unattachedCategoriesForClass æ–¹æ³•å¹¶æ²¡æœ‰å–åˆ°åˆ†ç±»ã€‚æ­¤æ—¶é€šè¿‡ LLDB æ‰“å°ä¸€ä¸‹å½“å‰ç±»é‡Œé¢æ˜¯å¦å·²ç»æŠŠåˆ†ç±»çš„å†…å®¹é™„åŠ ä¸Šäº†ã€‚å‰é¢çš„æµç¨‹å¤§å®¶éƒ½å¾ˆç†Ÿæ‚‰äº†ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹ cls çš„ rw ä¸­çš„ methods æ˜¯å¦æœ‰å†…å®¹ï¼š æ­¤æ—¶ LGTeacher ç±»é‡Œé¢æ˜¯æ²¡æœ‰æ–¹æ³•çš„ï¼Œè¿™é‡Œè¯»å– rw å´æœ‰ä¸€ä¸ªç»“æœï¼Œæˆ‘ä»¬ä¸éš¾çœ‹å‡ºè¿™æ˜¯ä½äº LGTeacher+test åˆ†ç±»ä¸­çš„ä¸€ä¸ª initialize æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯æˆ‘æ‰‹åŠ¨åŠ åˆ°è¿™ä¸ªåˆ†ç±»çš„ã€‚ è¿™æ ·è¿›ä¸€æ­¥è¯æ˜äº†ï¼Œå¦‚æœæ˜¯æ‡’åŠ è½½ç±»ï¼Œå¹¶ä¸”åˆ†ç±»ä¹Ÿæ˜¯æ‡’åŠ è½½ï¼Œé‚£ä¹ˆåˆ†ç±»çš„åŠ è½½å¹¶ä¸ä¼šæ¥åˆ° unattachedCategoriesForClass ï¼Œè€Œæ˜¯ç›´æ¥åœ¨ç¼–è¯‘æ—¶åŠ è½½åˆ°äº†ç±»çš„ ro é‡Œé¢ï¼Œç„¶ååœ¨è¿è¡Œæ—¶è¢«æ‹·è´åˆ°äº†ç±»çš„ rw é‡Œé¢ã€‚è¿™ä¸€ç‚¹å¯ä»¥é€šè¿‡ä¸‹é¢çš„ LLDB æ‰“å°æ¥è¯æ˜ã€‚ çªç„¶æƒ³èµ·æ¥ï¼Œä¸æ˜¯åœ¨ _read_images çš„æœ€åé‚£å—æœ‰ä¸€ä¸ª Discover categories å—ï¼Œä¸‡ä¸€æ‡’åŠ è½½åˆ†ç±»æ˜¯åœ¨è¿™é‡ŒåŠ è½½çš„å‘¢ï¼Ÿæˆ‘ä»¬ä¸€è¯•ä¾¿çŸ¥ï¼š è¿™é‡Œåœ¨ Discover categories å†…éƒ¨åšäº†ä¸€ä¸‹åˆ¤æ–­ï¼Œå¦‚æœæ˜¯ LGTeacher ç±»è¿›æ¥äº†ï¼Œå°±æ‰“å°ä¸€ä¸‹ï¼Œç»“æœå‘ç°å¹¶æ²¡æœ‰æ‰“å°ï¼Œè¯´æ˜åˆ†ç±»ä¹Ÿä¸æ˜¯åœ¨è¿™é‡Œè¢«åŠ è½½çš„ï¼Œæ˜¯åœ¨ç¼–è¯‘æ—¶ç›´æ¥åŠ è½½çš„ã€‚ 3.1.2 æ‡’åŠ è½½åˆ†ç±»+éæ‡’åŠ è½½ç±»éæ‡’åŠ è½½ç±»å½“ç±»ä¸ºéæ‡’åŠ è½½ç±»çš„æ—¶å€™ï¼ŒåŒæ ·æ˜¯èµ° _read_images =&gt;Realize non-lazy classes=&gt;realizeClassWithoutSwift=&gt;methodizeClassã€‚ æ‡’åŠ è½½åˆ†ç±»æˆ‘ä»¬ç›´æ¥åœ¨ methodizeClass æ–¹æ³•ä¸­æ‰“ä¸Šæ–­ç‚¹ï¼Œå¹¶åšäº†ä¸€ä¸‹ç®€å•çš„åˆ¤æ–­: 12345const char *cname = ro-&gt;name;const char *oname = &quot;LGTeacher&quot;;if (strcmp(cname, oname) == 0) { printf(&quot;methodizeClass :%s \\n&quot;,cname);} ç»“æœå¯ä»¥çœ‹åˆ°catsä¸ºç©ºï¼Œæ‰€ä»¥åˆ†ç±»ä¸åœ¨è¿™è¿›è¡Œæ·»åŠ ã€‚ åŒæ—¶é€šè¿‡ LLDB æ‰“å°ï¼Œå‘ç°åˆ†ç±»çš„æ–¹æ³•å·²ç»åœ¨ç±»çš„ ro é‡Œé¢äº†ï¼Œè¯´æ˜æ‡’åŠ è½½çš„åˆ†ç±»åœ¨ç¼–è¯‘æ—¶æœŸå°±è¢«åŠ è½½äº†ã€‚ 3.1.3 æ‡’åŠ è½½åˆ†ç±»æ€»ç»“ æ‡’åŠ è½½åˆ†ç±»çš„åˆå§‹åŒ–å…¶å®è·Ÿç±»çš„æ‡’åŠ è½½ä¸å¦å¹¶æ²¡æœ‰å…³ç³»ï¼Œä¹Ÿå°±æ˜¯è¯´æ‡’åŠ è½½çš„åˆ†ç±»éƒ½æ˜¯åœ¨ç¼–è¯‘æ—¶æœŸè¢«åŠ è½½çš„ã€‚ æ‡’åŠ è½½ç±»å’Œéæ‡’åŠ è½½ç±»è¿˜æ˜¯1.3ä¸­æ‰€è¿°çš„æµç¨‹ã€‚ 3.2 éæ‡’åŠ è½½åˆ†ç±»å®ç°äº† load çš„åˆ†ç±»-&gt;æå‰åŠ è½½ï¼Œæ‰€ä»¥æ˜¯éæ‡’åŠ è½½åˆ†ç±» ä»–å’Œç±»é…åˆåŠ è½½åˆ†ä¸‹é¢ä¸¤ç§æƒ…å†µï¼š éæ‡’åŠ è½½åˆ†ç±»ä¸æ‡’åŠ è½½ç±» éæ‡’åŠ è½½åˆ†ç±»å’Œéæ‡’åŠ è½½ç±» 3.2.1 éæ‡’åŠ è½½åˆ†ç±» + æ‡’åŠ è½½ç±»æ‡’åŠ è½½çš„ç±»æˆ‘ä»¬å‰é¢å·²ç»çŸ¥é“äº†ï¼Œæ˜¯åœ¨ç¬¬ä¸€æ¬¡å‘é€æ¶ˆæ¯çš„æ—¶å€™æ‰ä¼šè¢«åŠ è½½çš„ï¼Œé‚£æˆ‘ä»¬ç›´æ¥åœ¨lookupImpOrForward =&gt;realizeClassMaybeSwiftAndLeaveLocked =&gt; realizeClassMaybeSwiftMaybeRelock =&gt; realizeClassWithoutSwift =&gt; methodizeClass æµç¨‹ä¸­çš„ methodizeClass æ‰“ä¸Šæ–­ç‚¹ï¼Œçœ‹ä¸‹åœ¨è¿™é‡Œåˆ†ç±»ä¼šä¸ä¼šè¢«åŠ è½½ï¼š è¿™ä¸€æ¬¡é€šè¿‡ unattachedCategoriesForClass å–å‡ºæ¥å€¼äº†ï¼Œå¹¶ä¸”åœ¨è¿™ä¹‹å‰ cls çš„ ro ä¸­å¹¶æ²¡æœ‰åˆ†ç±»çš„ initialize æ–¹æ³•ï¼š ä½†æ˜¯æˆ‘ä»¬æ³¨æ„è§‚å¯Ÿæ­¤æ—¶çš„è°ƒç”¨å †æ ˆï¼š ä¸ºä»€ä¹ˆèµ°çš„æ˜¯ load_images é‡Œé¢çš„ prepare_load_methods æ–¹æ³•å‘¢ï¼Ÿæˆ‘ä»¬æ¥åˆ° prepare_load_methods æ–¹æ³•å¤„ï¼š å¯ä»¥çœ‹åˆ°ï¼Œå…¶å®åœ¨è¿™é‡Œè°ƒç”¨äº† realizeClassWithoutSwift æ–¹æ³•æ¥æå‰åŠ è½½ç±»ã€‚ è€Œä¸Šé¢çš„ _getObjc2NonlazyCategoryList æ–¹æ³•æ˜¾ç¤ºå°±æ˜¯è·å–åˆ°æ‰€æœ‰çš„éæ‡’åŠ è½½åˆ†ç±»ï¼Œç„¶åéå†è¿™äº›éæ‡’åŠ è½½åˆ†ç±»ï¼Œç„¶åå»åŠ è½½è¿™äº›åˆ†ç±»æ‰€ä¾èµ–çš„ç±»ã€‚ è¿™ä¸ªé€»è¾‘å¾ˆå¥½ç†è§£ï¼Œéæ‡’åŠ è½½åˆ†ç±»è®©æˆ‘ä»¬çš„æ‡’åŠ è½½ç±»å®ç°æå‰äº†ï¼Œæ‰€ä»¥è¯´æ‡’åŠ è½½ç±»å¹¶ä¸ä¸€å®šåªä¼šåœ¨ç¬¬ä¸€æ¬¡æ¶ˆæ¯å‘é€çš„æ—¶å€™åŠ è½½ï¼Œè¿˜è¦å–å†³äºæœ‰æ²¡æœ‰éæ‡’åŠ è½½çš„åˆ†ç±»ï¼Œå¦‚æœæœ‰éæ‡’åŠ è½½çš„åˆ†ç±»ï¼Œé‚£ä¹ˆç±»å°±æ˜¯åœ¨ load_images =&gt; prepare_load_methods =&gt; realizeClassWithoutSwift åŠ è½½çš„ã€‚ åˆ†ç±»çš„åŠ è½½åœ¨ç±»åŠ è½½ä¹‹åçš„ methodizeClassã€‚ 3.2.2 éæ‡’åŠ è½½åˆ†ç±» + éæ‡’åŠ è½½ç±»éæ‡’åŠ è½½ç±»çš„æµç¨‹æˆ‘ä»¬ä¹Ÿååˆ†ç†Ÿæ‚‰äº†ï¼Œåœ¨ _read_images é‡Œé¢è¿›è¡ŒåŠ è½½ã€‚è€Œæ­¤æ—¶ï¼Œåˆ†ç±»ä¹Ÿæ˜¯éæ‡’åŠ è½½ã€‚æˆ‘ä»¬è¿˜æ˜¯åœ¨ methodizeClass é‡Œé¢è¿›è¡Œæ–­ç‚¹ï¼š ç»“æœå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè¿™æ¬¡ä» unattachedCategoriesForClass æ–¹æ³•å–å‡ºæ¥çš„æ˜¯ NULL å€¼ï¼Œæ˜¾ç„¶åˆ†ç±»ä¸æ˜¯åœ¨è¿™ä¸ªåœ°æ–¹è¢«åŠ è½½çš„ï¼Œæˆ‘ä»¬å›åˆ° _read_images æ–¹æ³•ï¼Œè¿˜è®°å¾—é‚£ä¸ª Discover categories æµç¨‹å—ï¼Œæˆ‘ä»¬æ‰“å¼€é‡Œé¢çš„æ–­ç‚¹ï¼š å› ä¸ºå½“å‰ç±»å·²ç»åœ¨å‰é¢çš„éæ‡’åŠ è½½ç±»åŠ è½½æµç¨‹ä¸­è¢«åŠ è½½å®Œæˆï¼Œæ‰€ä»¥è¿™é‡Œä¼šæ¥åˆ° remethodizeClass æ–¹æ³•ï¼Œæˆ‘ä»¬è¿›å…¥å…¶å†…éƒ¨å®ç°ï¼š 1234567891011121314151617181920static void remethodizeClass(Class cls){ category_list *cats; bool isMeta; runtimeLock.assertLocked(); isMeta = cls-&gt;isMetaClass(); // Re-methodizing: check for more categories if ((cats = unattachedCategoriesForClass(cls, false/*not realizing*/))) { if (PrintConnecting) { _objc_inform(&quot;CLASS: attaching categories to class '%s' %s&quot;, cls-&gt;nameForLogging(), isMeta ? &quot;(meta)&quot; : &quot;&quot;); } attachCategories(cls, cats, true /*flush caches*/); free(cats); }} å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ª attachCategories æ–¹æ³•ï¼Œæ–­ç‚¹ä¹Ÿç¡®å®æ¥åˆ°äº†è¿™ä¸ªåœ°æ–¹ï¼Œæ‰€ä»¥éæ‡’åŠ è½½åˆ†ç±»åœ¨è¿™é‡ŒåŠ è½½ã€‚ 3.2.3 éæ‡’åŠ è½½åˆ†ç±»æ€»ç»“ éæ‡’åŠ è½½åˆ†ç±» + æ‡’åŠ è½½ç±» ç±»çš„åŠ è½½åœ¨ load_images å¤„ ï¼Œåˆ†ç±»çš„åŠ è½½åœ¨ç±»åŠ è½½ä¹‹åçš„ methodizeClass éæ‡’åŠ è½½åˆ†ç±» + éæ‡’åŠ è½½ç±» ç±»çš„åŠ è½½åœ¨ _read_images å¤„ï¼Œåˆ†ç±»çš„åŠ è½½åœ¨ç±»åŠ è½½ä¹‹åçš„ reMethodizeClass 3.3 æ€»ç»“åˆ†ç±»çš„åŠ è½½å…¶å®å¯ä»¥ç¬¼ç»Ÿçš„åˆ†ä¸ºå®ç° load æ–¹æ³•å’Œæ²¡æœ‰å®ç° load æ–¹æ³•ï¼š æ²¡æœ‰å®ç° load æ–¹æ³•çš„åˆ†ç±»ï¼ˆä¸éœ€æå‰åŠ è½½-æ‡’åŠ è½½åˆ†ç±»ï¼‰ç”±ç¼–è¯‘æ—¶ç¡®å®š å®ç°äº† load æ–¹æ³•çš„åˆ†ç±»ï¼ˆéœ€æå‰åŠ è½½-éæ‡’åŠ è½½åˆ†ç±»ï¼‰ç”±è¿è¡Œæ—¶å»ç¡®å®š è¿™ä¹Ÿè¯´æ˜åˆ†ç±»çš„åŠ è½½å’Œç±»çš„åŠ è½½æ˜¯ä¸ä¸€æ ·çš„ï¼Œè€Œç»“åˆç€ç±»çš„æ‡’åŠ è½½ä¸å¦ï¼Œæˆ‘ä»¬æœ‰ä»¥ä¸‹çš„ç»“è®ºï¼š æ‡’åŠ è½½åˆ†ç±» + æ‡’åŠ è½½ç±» ç±»çš„åŠ è½½åœ¨ç¬¬ä¸€æ¬¡æ¶ˆæ¯å‘é€çš„æ—¶å€™ï¼Œè€Œåˆ†ç±»çš„åŠ è½½åˆ™åœ¨ç¼–è¯‘æ—¶ æ‡’åŠ è½½åˆ†ç±» + éæ‡’åŠ è½½ç±» ç±»çš„åŠ è½½åœ¨ _read_images å¤„ï¼Œåˆ†ç±»çš„åŠ è½½è¿˜æ˜¯åœ¨ç¼–è¯‘æ—¶ éæ‡’åŠ è½½åˆ†ç±» + æ‡’åŠ è½½ç±» ç±»çš„åŠ è½½åœ¨ load_images å†…éƒ¨ï¼Œåˆ†ç±»çš„åŠ è½½åœ¨ç±»åŠ è½½ä¹‹åçš„ methodizeClass éæ‡’åŠ è½½åˆ†ç±» + éæ‡’åŠ è½½ç±» ç±»çš„åŠ è½½åœ¨ _read_images å¤„ï¼Œåˆ†ç±»çš„åŠ è½½åœ¨ç±»åŠ è½½ä¹‹åçš„ reMethodizeClass å››ã€ç±»æ‹“å±•çš„åŠ è½½ç±»æ‹“å±•extensionåˆç§°ä½œåŒ¿åçš„åˆ†ç±»ï¼Œä¸ºäº†ç»™å½“å‰ç±»å¢åŠ å±æ€§å’Œæ–¹æ³• å…·ä½“æœ‰ä¸¤ç§å½¢å¼ï¼š ç›´æ¥åœ¨.mæ–‡ä»¶ä¸­æ–°å¢ç±»æ‹“å±• æ–°å»ºç±»æ‹“å±•çš„.hæ–‡ä»¶ 4.1 ç±»æ‹“å±•çš„åŠ è½½æ•°æ®å¾ˆæ—©çš„æ—¶å€™éƒ½ä¼šæ¥åˆ°_read_imageï¼Œåœ¨è¿™é‡Œæ–­ç‚¹åˆ†æä¸€ä¸‹ï¼š ä½†æ˜¯ä»”ç»†ä¸€æƒ³ä¸å¯¹å‘€ï¼Œå·²ç»åœ¨ç±»ä¸­æœ‰äº†æ–¹æ³•å®ç°äº†ï¼Œæ­¤æ—¶çš„do_hExtensionä¸è¶³ä»¥è¯´æ˜é—®é¢˜ é‚£ä¹ˆå¯ä»¥é€šè¿‡æŸ¥çœ‹å±æ€§çš„setterå’Œgetteræ–¹æ³•æ¥éªŒè¯ åœ¨æ¥åˆ°_read_imageæ–¹æ³•ä¹‹å‰å°±æœ‰äº†ç›¸åº”çš„getterå’Œsetterï¼Œè¯´æ˜ ç±»æ‹“å±•åœ¨ç¼–è¯‘æ—¶ä¾¿ä½œä¸ºç±»çš„ä¸€éƒ¨åˆ†è¿›è¡Œç¼–è¯‘ï¼Œå­˜åˆ°ç±»çš„roä¸­ 4.2 ç±»æ‹“å±•çš„ç»†èŠ‚ç‚¹å¦‚æœç±»æ‹“å±•æ²¡æœ‰è¢«å¼•ç”¨ï¼ˆ#importï¼‰-åœ¨ä»£ç ä¸­æ²¡æœ‰è¢«ç”¨åˆ°ï¼Œå°±ä¸ä¼šç¼–è¯‘åˆ°åˆ°å†…å­˜ä¸­ äº”ã€load_imageåˆ†æä¸Šç¯‡æ–‡ç« è®²åˆ°dyldåˆå§‹åŒ–imageä¼šè§¦å‘load_imageï¼Œæœ¬æ–‡åˆæåˆ°äº†æ‡’åŠ è½½ç±»å’Œéæ‡’åŠ è½½åˆ†ç±»æƒ…å†µä¸‹ï¼Œåˆ†ç±»åŠ è½½åˆ°å†…å­˜æ—¶çš„è°ƒç”¨æ ˆä¸­æœ‰load_imageï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨è¯¥ç§æƒ…å†µä¸‹è¿›è¡Œæ¢ç´¢ã€‚ åœ¨load_imageå®ç°å¤„æ‰“ä¸‹æ–­ç‚¹ï¼Œå‘ç°ç±»å’Œåˆ†ç±»éƒ½æ²¡æœ‰æ‰“å°+loadæ–¹æ³•â€”â€”load_imageå…ˆäº+loadæ–¹æ³• æ¥ç€æŠŠç›®å…‰ç§»å‘ä¸¤æ¡æ³¨é‡Šï¼š Discover load methodsâ€”â€”prepare_load_methods Call +load methodsâ€”â€”call_load_methods 5.1 prepare_load_methodså‘ç°å¹¶å‡†å¤‡+loadæ–¹æ³• 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879void prepare_load_methods(const headerType *mhdr){ size_t count, i; runtimeLock.assertLocked(); classref_t *classlist = _getObjc2NonlazyClassList(mhdr, &amp;count); for (i = 0; i &lt; count; i++) { schedule_class_load(remapClass(classlist[i])); } category_t **categorylist = _getObjc2NonlazyCategoryList(mhdr, &amp;count); for (i = 0; i &lt; count; i++) { category_t *cat = categorylist[i]; Class cls = remapClass(cat-&gt;cls); if (!cls) continue; // category for ignored weak-linked class if (cls-&gt;isSwiftStable()) { _objc_fatal(&quot;Swift class extensions and categories on Swift &quot; &quot;classes are not allowed to have +load methods&quot;); } realizeClassWithoutSwift(cls); assert(cls-&gt;ISA()-&gt;isRealized()); add_category_to_loadable_list(cat); }}/************************************************************************ prepare_load_methods* Schedule +load for classes in this image, any un-+load-ed * superclasses in other images, and any categories in this image.**********************************************************************/// Recursively schedule +load for cls and any un-+load-ed superclasses.// cls must already be connected.static void schedule_class_load(Class cls){ if (!cls) return; assert(cls-&gt;isRealized()); // _read_images should realize if (cls-&gt;data()-&gt;flags &amp; RW_LOADED) return; // Ensure superclass-first ordering schedule_class_load(cls-&gt;superclass); add_class_to_loadable_list(cls); cls-&gt;setInfo(RW_LOADED); }/************************************************************************ add_class_to_loadable_list* Class cls has just become connected. Schedule it for +load if* it implements a +load method.**********************************************************************/void add_class_to_loadable_list(Class cls){ IMP method; loadMethodLock.assertLocked(); method = cls-&gt;getLoadMethod(); if (!method) return; // Don't bother if cls has no +load method if (PrintLoading) { _objc_inform(&quot;LOAD: class '%s' scheduled for +load&quot;, cls-&gt;nameForLogging()); } if (loadable_classes_used == loadable_classes_allocated) { loadable_classes_allocated = loadable_classes_allocated*2 + 16; loadable_classes = (struct loadable_class *) realloc(loadable_classes, loadable_classes_allocated * sizeof(struct loadable_class)); } loadable_classes[loadable_classes_used].cls = cls; loadable_classes[loadable_classes_used].method = method; loadable_classes_used++;} prepare_load_methodsåˆ†æï¼š é€šè¿‡_getObjc2NonlazyClassListè·å–éæ‡’åŠ è½½ç±»åˆ—è¡¨ é€šè¿‡schedule_class_loadéå†è¿™äº›ç±» é€’å½’è°ƒç”¨éå†çˆ¶ç±»çš„+loadæ–¹æ³•ï¼Œç¡®ä¿çˆ¶ç±»çš„+loadæ–¹æ³•é¡ºåºæ’åœ¨å­ç±»çš„å‰é¢ è°ƒç”¨add_class_to_loadable_listæŠŠç±»çš„+loadæ–¹æ³•å­˜åœ¨loadable_classesé‡Œé¢ è°ƒç”¨_getObjc2NonlazyCategoryListå–å‡ºéæ‡’åŠ è½½åˆ†ç±»åˆ—è¡¨ éå†åˆ†ç±»åˆ—è¡¨ é€šè¿‡realizeClassWithoutSwiftæ¥é˜²æ­¢ç±»æ²¡æœ‰åˆå§‹åŒ–ï¼ˆè‹¥å·²ç»åˆå§‹åŒ–äº†åˆ™ä¸å½±å“ï¼‰ è°ƒç”¨add_category_to_loadable_liståŠ è½½åˆ†ç±»ä¸­çš„+loadæ–¹æ³•åˆ°loadable_categories æ­¤æ—¶å°±èƒ½çœ‹æ‡‚ä¹‹å‰æ‡’åŠ è½½ç±»å’Œéæ‡’åŠ è½½åˆ†ç±»çš„å‡½æ•°è°ƒç”¨æ ˆäº† 5.2 call_load_methodså”¤é†’+loadæ–¹æ³• 1234567891011121314151617181920212223242526272829void call_load_methods(void){ static bool loading = NO; bool more_categories; loadMethodLock.assertLocked(); // Re-entrant calls do nothing; the outermost call will finish the job. if (loading) return; loading = YES; void *pool = objc_autoreleasePoolPush(); do { // 1. Repeatedly call class +loads until there aren't any more while (loadable_classes_used &gt; 0) { call_class_loads(); } // 2. Call category +loads ONCE more_categories = call_category_loads(); // 3. Run more +loads if there are classes OR more untried categories } while (loadable_classes_used &gt; 0 || more_categories); objc_autoreleasePoolPop(pool); loading = NO;} é€šè¿‡objc_autoreleasePoolPushå‹æ ˆä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ±  do-whileå¾ªç¯å¼€å§‹ å¾ªç¯è°ƒç”¨ç±»çš„+loadæ–¹æ³•ç›´åˆ°æ‰¾ä¸åˆ°ä¸ºæ­¢ è°ƒç”¨ä¸€æ¬¡åˆ†ç±»ä¸­çš„+loadæ–¹æ³• é€šè¿‡objc_autoreleasePoolPopå‡ºæ ˆä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ±  5.3 å…³äºloadæ–¹æ³•æˆ‘ä»¬éœ€è¦çŸ¥é“çš„ loadæ–¹æ³•åœ¨mainå‡½æ•°å‰è°ƒç”¨ å¦‚æœä¸€ä¸ªç±»å®ç°äº†loadæ–¹æ³•ï¼Œåœ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•å‰ä¼šå…ˆè°ƒç”¨çˆ¶ç±»çš„loadæ–¹æ³• å› ä¸ºåŠ è½½æ—¶é—´ç‰¹åˆ«æ—©ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨è¿™ä¸ªç‰¹æ€§è¿›è¡Œä¸€äº›ç‰¹æ®Šå¤„ç† å…­ã€initalizeåˆ†æå…³äºinitalizeè‹¹æœæ–‡æ¡£æ˜¯è¿™ä¹ˆæè¿°çš„ 1.åœ¨ç±»æˆ–è€…å…¶å­ç±»çš„ç¬¬ä¸€ä¸ªæ–¹æ³•è¢«è°ƒç”¨å‰ï¼ˆå‘é€æ¶ˆæ¯å‰ï¼‰è°ƒç”¨2.çˆ¶ç±»çš„è°ƒç”¨åœ¨å­ç±»ä¹‹å‰è¡¥å……ï¼šé€šå¸¸åº”è¯¥åœ¨é‡Œé¢åˆ¤æ–­å½“å‰è¦åˆå§‹åŒ–çš„ç±»ï¼Œé˜²æ­¢å¤šæ¬¡è°ƒç”¨ ç„¶åæˆ‘ä»¬åœ¨objcæºç ä¸­lookUpImpOrForwardæ‰¾åˆ°äº†å®ƒçš„è¸ªè¿¹ lookUpImpOrForward-&gt;initializeAndLeaveLocked-&gt;initializeAndMaybeRelock-&gt;initializeNonMetaClass 1234567891011121314151617181920212223IMP lookUpImpOrForward(Class cls, SEL sel, id inst, bool initialize, bool cache, bool resolver){ ... if (initialize &amp;&amp; !cls-&gt;isInitialized()) { cls = initializeAndLeaveLocked(cls, inst, runtimeLock); ... } ...}static Class initializeAndLeaveLocked(Class cls, id obj, mutex_t&amp; lock){ return initializeAndMaybeRelock(cls, obj, lock, true);}static Class initializeAndMaybeRelock(Class cls, id inst, mutex_t&amp; lock, bool leaveLocked){ Â·Â·Â· initializeNonMetaClass(nonmeta); Â·Â·Â·} åœ¨initializeNonMetaClassé€’å½’è°ƒç”¨çˆ¶ç±»çš„initializeï¼Œç„¶åè°ƒç”¨callInitialize 12345678910111213141516171819202122/************************************************************************ class_initialize. Send the '+initialize' message on demand to any* uninitialized class. Force initialization of superclasses first.**********************************************************************/void initializeNonMetaClass(Class cls){ ... supercls = cls-&gt;superclass; if (supercls &amp;&amp; !supercls-&gt;isInitialized()) { initializeNonMetaClass(supercls); } ... { callInitialize(cls); if (PrintInitializing) { _objc_inform(&quot;INITIALIZE: thread %p: finished +[%s initialize]&quot;, pthread_self(), cls-&gt;nameForLogging()); } } ...} callInitializeæ˜¯ä¸€ä¸ªæ™®é€šçš„æ¶ˆæ¯å‘é€ 12345void callInitialize(Class cls){ ((void(*)(Class, SEL))objc_msgSend)(cls, SEL_initialize); asm(&quot;&quot;);} æ€»ç»“ initializeåœ¨ç±»æˆ–è€…å…¶å­ç±»çš„ç¬¬ä¸€ä¸ªæ–¹æ³•è¢«è°ƒç”¨å‰ï¼ˆå‘é€æ¶ˆæ¯å‰ï¼‰è°ƒç”¨ åªåœ¨ç±»ä¸­æ·»åŠ initializeä½†ä¸ä½¿ç”¨çš„æƒ…å†µä¸‹ï¼Œæ˜¯ä¸ä¼šè°ƒç”¨initialize çˆ¶ç±»çš„initializeæ–¹æ³•ä¼šæ¯”å­ç±»å…ˆæ‰§è¡Œ å½“å­ç±»æœªå®ç°initializeæ–¹æ³•æ—¶ï¼Œä¼šè°ƒç”¨çˆ¶ç±»initializeæ–¹æ³•ï¼›å­ç±»å®ç°initializeæ–¹æ³•æ—¶ï¼Œä¼šè¦†ç›–çˆ¶ç±»initializeæ–¹æ³• å½“æœ‰å¤šä¸ªåˆ†ç±»éƒ½å®ç°äº†initializeæ–¹æ³•ï¼Œä¼šè¦†ç›–ç±»ä¸­çš„æ–¹æ³•ï¼Œåªæ‰§è¡Œä¸€ä¸ª(ä¼šæ‰§è¡Œæœ€åè¢«åŠ è½½åˆ°å†…å­˜ä¸­çš„åˆ†ç±»çš„æ–¹æ³•) ä¸ƒã€ç›¸å…³é¢è¯•é¢˜7.1 ç±»æ‹“å±•å’Œåˆ†ç±»çš„åŒºåˆ«â‘ åŒºåˆ«ï¼š ç±»æ‹“å±•å¯ä»¥æ·»åŠ å±æ€§(ç¼–è¯‘å™¨ä¼šå¸®åŠ©æˆ‘ä»¬ç”Ÿæˆå±æ€§å¯¹åº”çš„getå’Œsetæ–¹æ³•)ï¼Œæ–¹æ³• åˆ†ç±»åªèƒ½æ·»åŠ æ–¹æ³•ï¼Œé€šå¸¸ä¸èƒ½æ·»åŠ å±æ€§ï¼ˆæ·»åŠ çš„è¯éœ€è¦ä½¿ç”¨å…³è”å¯¹è±¡ï¼‰ åŸå› ï¼š ç±»æ‹“å±•åœ¨ç¼–è¯‘æ—¶å®ŒæˆåŠ è½½ï¼Œæ•°æ®å†™å…¥åˆ°roä¸­ï¼› è€Œåˆ†ç±»åœ¨è¿è¡Œæ—¶åŠ è½½ï¼Œæ‰€ä»¥æ•°æ®å†™å…¥åˆ°rwä¸­ï¼Œæ²¡æœ‰å®ç°å¯¹åº”çš„setå’Œgetæ–¹æ³•ï¼Œæ‰€ä»¥æ— æ³•å°†å±æ€§çš„å€¼èµ‹å€¼è¿›å»ï¼Œä¹Ÿæ— æ³•å–åˆ°ã€‚ â‘¡ç±»æ‹“å±•åœ¨ä»£ç å®ç°å½¢å¼æœ‰2ç§æ–¹å¼ï¼Œç¬¬ä¸€ç§å†™åˆ°æ‰€åœ¨æœ¬ç±»çš„.mæ–‡ä»¶ä¸­ï¼Œç¬¬äºŒç§å¦ä¸€ä¸ªå•å†™ä¸€ä¸ª.hæ–‡ä»¶ã€‚ å¸¸ç”¨ç¬¬ä¸€ç§ï¼š ç¬¬äºŒç§ï¼š **â‘¢åŠ è½½æ—¶æœºçš„åŒºåˆ«ï¼š ** åœ¨ç±»çš„åŠ è½½è¿‡ç¨‹ä¸­â€”read_imageså¤„è®¾ç½®æ–­ç‚¹ï¼Œè¿è¡Œè¿›å…¥æ–­ç‚¹ï¼Œæ‰“å°å‘ç°roä¸­åŒ…å«ç±»æ‹“å±•çš„å±æ€§å’Œç›¸åº”çš„getï¼Œsetæ–¹æ³•ï¼Œå¯ä»¥åˆ¤æ–­å‡ºç±»æ‹“å±•åœ¨ç¼–è¯‘æ—¶å°±åŠ è½½äº†ã€‚è€Œæ­¤æ—¶ç±»åŠ è½½åæ²¡æœ‰åˆ†ç±»çš„ä¿¡æ¯ï¼Œç”±æ­¤å¯ä»¥åˆ¤æ–­åˆ†ç±»æ˜¯åœ¨è¿è¡Œæ—¶åŠ è½½è¿›æ¥çš„ã€‚ ä¸‹å›¾æ–­ç‚¹ä¿¡æ¯å›¾ï¼š ä¸‹å›¾roä¸­æŸ¥æ‰¾ä¿¡æ¯å›¾ï¼š â‘£ç±»æ‹“å±•å’Œåˆ†ç±»çš„åŒºåˆ« ç ”ç©¶å¯¹è±¡ åŠ è½½æ—¶æœº æ“ä½œå¯¹è±¡ èƒ½å¦é€šè¿‡@propertyå£°æ˜å±æ€§ç”Ÿæˆ getter å’Œ setter åˆ†ç±»(å®ç°äº†loadæ–¹æ³•) è¿è¡Œæ—¶ rw ä¸èƒ½ï¼Œéœ€è¦å€ŸåŠ©å…³è”å¯¹è±¡æ¥å®ç° åˆ†ç±»(æ²¡æœ‰å®ç°loadæ–¹æ³•) ç¼–è¯‘æ—¶ ro ä¸èƒ½ï¼Œéœ€è¦å€ŸåŠ©å…³è”å¯¹è±¡æ¥å®ç° ç±»æ‹“å±• ç¼–è¯‘æ—¶ ro å¯ä»¥ 7.2 åˆ†ç±»ä¸­å¯ä»¥é€šè¿‡å…³è”å¯¹è±¡æ·»åŠ å±æ€§7.2.1 å…³è”å¯¹è±¡çš„å®šä¹‰å’ŒåŸºæœ¬ä½¿ç”¨ é€šè¿‡ä½¿ç”¨å…³è”å¼•ç”¨ï¼Œä½ å¯ä»¥åœ¨ä¸ä¿®æ”¹ç±»å£°æ˜çš„å‰æä¸‹ä¸ºå¯¹è±¡æ·»åŠ å†…å®¹ã€‚å¦‚æœä½ æ— æƒè®¿é—®è¯¥ç±»çš„æºä»£ç ï¼Œæˆ–è€…ç”±äºäºŒè¿›åˆ¶å…¼å®¹æ€§åŸå› è€Œæ— æ³•æ›´æ”¹è¯¥å¯¹è±¡çš„å¸ƒå±€ï¼Œåˆ™è¿™å¯èƒ½å¾ˆæœ‰ç”¨ã€‚ å…³è”å¼•ç”¨æœºåˆ¶åŸºäº keyã€‚å¯¹äºä»»ä½•å¯¹è±¡ï¼Œä½ éƒ½å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ ä»»æ„æ•°é‡çš„å…³è”å¼•ç”¨ï¼Œæ¯ä¸ªå…³è”éƒ½ä½¿ç”¨ä¸åŒçš„ keyã€‚ ä»è‹¹æœå®˜æ–¹æ–‡æ¡£å¯ä»¥çœ‹åˆ°ï¼Œå…³è”å¼•ç”¨å…¶å®ä¸æ˜¯åªèƒ½åœ¨åˆ†ç±»ä¸­ä½¿ç”¨ï¼Œåªä¸è¿‡å¯¹äºæˆ‘ä»¬æ—¥å¸¸å¼€å‘æ¥è¯´ï¼Œåˆ†ç±»ä¸­ä½¿ç”¨å…³è”å¼•ç”¨è¿˜æ˜¯æ›´å¸¸ç”¨çš„åœºæ™¯ã€‚å…³è”å¯¹è±¡ä½¿ç”¨èµ·æ¥å¾ˆç®€å•ï¼Œä¸å¤–ä¹ä¸¤ä¸ªæ–¹æ³•ï¼š 12345// è®¾ç½®å…³è”å¯¹è±¡objc_setAssociatedObject()// è·å–å…³è”å¯¹è±¡objc_getAssociatedObject() æˆ‘ä»¬å¦‚æœè¦ç»™ä¸€ä¸ªåˆ†ç±»ä¸­çš„å±æ€§è®¾ç½®å…³è”å¯¹è±¡ï¼Œéœ€è¦é‡å†™å±æ€§çš„ setter æ–¹æ³•ï¼Œç„¶åä½¿ç”¨ objc_setAssociatedObjectï¼š 123- (void)setXXX:(å…³è”å€¼æ•°æ®ç±»å‹)å…³è”å€¼ objc_setAssociatedObject(self, å…³è”çš„key, å…³è”å€¼, å…³è”å¯¹è±¡å†…å­˜ç®¡ç†ç­–ç•¥);} ç„¶åè¿˜éœ€è¦é‡å†™ getter æ–¹æ³•ï¼Œç„¶åä½¿ç”¨ objc_getAssociatedObjectï¼š 123- (å…³è”å€¼æ•°æ®ç±»å‹)å…³è”å€¼{ return objc_getAssociatedObject(self, å…³è”çš„key);} è¿™å…¶ä¸­çš„å…³è”å¯¹è±¡å†…å­˜ç®¡ç†ç­–ç•¥å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š å…³è”ç­–ç•¥ ç­‰åŒçš„ @property æè¿° OBJC_ASSOCIATION_ASSIGN @property (assign) æˆ– @property (unsafe_unretained) æŒ‡å®šä¸€ä¸ªå…³è”å¯¹è±¡çš„å¼±å¼•ç”¨ã€‚ æŒ‡å®šä¸€ä¸ªå…³è”å¯¹è±¡çš„å¼±å¼•ç”¨ã€‚ OBJC_ASSOCIATION_RETAIN_NONATOMIC @property (nonatomic, strong) æŒ‡å®šä¸€ä¸ªå…³è”å¯¹è±¡çš„å¼ºå¼•ç”¨ï¼Œä¸èƒ½è¢«åŸå­åŒ–ä½¿ç”¨ã€‚ OBJC_ASSOCIATION_COPY_NONATOMIC @property (nonatomic, copy) æŒ‡å®šä¸€ä¸ªå…³è”å¯¹è±¡çš„copyå¼•ç”¨ï¼Œä¸èƒ½è¢«åŸå­åŒ–ä½¿ç”¨ã€‚ OBJC_ASSOCIATION_RETAIN @property (atomic, strong) æŒ‡å®šä¸€ä¸ªå…³è”å¯¹è±¡çš„å¼ºå¼•ç”¨ï¼Œèƒ½è¢«åŸå­åŒ–ä½¿ç”¨ã€‚ OBJC_ASSOCIATION_COPY @property (atomic, copy) æŒ‡å®šä¸€ä¸ªå…³è”å¯¹è±¡çš„copyå¼•ç”¨ï¼Œèƒ½è¢«åŸå­åŒ–ä½¿ç”¨ã€‚ 7.2.3 å…³è”å¯¹è±¡çš„åº•å±‚åŸç†æ€»ç»“å›¾ï¼š objc_setAssociatedObject1234// objc-runtime.mmvoid objc_setAssociatedObject(id object, const void *key, id value, objc_AssociationPolicy policy) { _object_set_associative_reference(object, (void *)key, value, policy);} objc_setAssociatedObject æ–¹æ³•çš„å®ç°åˆåŒ…è£¹äº†ä¸€å±‚ï¼Œå…¶å®ç°ä¸º _object_set_associative_reference åˆ†æ_object_set_associative_referenceæ–¹æ³•ï¼Œç›´æ¥çœ‹æ·»åŠ æ³¨é‡Šåçš„ä»£ç å°±èƒ½æ˜ç™½ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970void _object_set_associative_reference(id object, void *key, id value, uintptr_t policy) { // This code used to work when nil was passed for object and key. Some code // probably relies on that to not crash. Check and handle it explicitly. // rdar://problem/44094390 // å®¹é”™å¤„ç† if (!object &amp;&amp; !value) return; assert(object); // åˆ¤æ–­è¦è¿›è¡Œå…³è”çš„å¯¹è±¡æ˜¯å¦ç¦ç”¨æ‰äº†å…³è”å¼•ç”¨ if (object-&gt;getIsa()-&gt;forbidsAssociatedObjects()) _objc_fatal(&quot;objc_setAssociatedObject called on instance (%p) of class %s which does not allow associated objects&quot;, object, object_getClassName(object)); // retain the new value (if any) outside the lock. // åˆå§‹åŒ–ä¸€ä¸ª ObjcAssociation å¯¹è±¡ï¼Œç”¨äºæŒæœ‰åŸæœ‰çš„å…³è”å¯¹è±¡ ObjcAssociation old_association(0, nil); // åˆ¤æ–­ä¼ å…¥çš„å…³è”å¯¹è±¡å€¼æ˜¯å¦å­˜åœ¨ id new_value = value ? acquireValue(value, policy) : nil; { // å…³è”å¯¹è±¡çš„ç®¡ç†ç±» AssociationsManager manager; // è·å–å…³è”çš„ HashMap -&gt; å­˜å‚¨å½“å‰å…³è”å¯¹è±¡ AssociationsHashMap &amp;associations(manager.associations()); // å¯¹å½“å‰å¯¹è±¡çš„åœ°å€åšæŒ‰ä½å–åæ“ä½œ - å°±æ˜¯ HashMap çš„key (å“ˆå¸Œå‡½æ•°) disguised_ptr_t disguised_object = DISGUISE(object); if (new_value) { // break any existing association. // è·å– AssociationsHashMap çš„è¿­ä»£å™¨ - (å¯¹è±¡çš„) è¿›è¡Œéå† AssociationsHashMap::iterator i = associations.find(disguised_object); if (i != associations.end()) { // secondary table exists ObjectAssociationMap *refs = i-&gt;second; // æ ¹æ®keyå»è·å–å…³è”å±æ€§çš„è¿­ä»£å™¨ ObjectAssociationMap::iterator j = refs-&gt;find(key); if (j != refs-&gt;end()) { old_association = j-&gt;second; // æ›¿æ¢è®¾ç½®æ–°å€¼ j-&gt;second = ObjcAssociation(policy, new_value); } else { // åˆ°æœ€åäº†â€”â€”ç›´æ¥è®¾ç½®æ–°å€¼ (*refs)[key] = ObjcAssociation(policy, new_value); } } else { // create the new association (first time). // å¦‚æœAssocistionsHashMapæ²¡æœ‰å¯¹è±¡çš„å…³è”ä¿¡æ¯è¡¨ // é‚£ä¹ˆå°±åˆ›å»ºä¸€ä¸ªmapå¹¶é€šè¿‡ä¼ å…¥çš„keyæŠŠvalueå­˜è¿›å» ObjectAssociationMap *refs = new ObjectAssociationMap; associations[disguised_object] = refs; (*refs)[key] = ObjcAssociation(policy, new_value); object-&gt;setHasAssociatedObjects(); } } else { // setting the association to nil breaks the association. // å¦‚æœä¼ å…¥çš„valueæ˜¯nilï¼Œå¹¶ä¸”ä¹‹å‰ä½¿ç”¨ç›¸åŒçš„keyå­˜å‚¨è¿‡å…³è”å¯¹è±¡ï¼Œ // é‚£ä¹ˆå°±æŠŠè¿™ä¸ªå…³è”çš„valueç§»é™¤ï¼ˆè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¼ å…¥nilå¯¹è±¡èƒ½å¤ŸæŠŠå¯¹è±¡çš„å…³è”valueç§»é™¤ï¼‰ AssociationsHashMap::iterator i = associations.find(disguised_object); if (i != associations.end()) { ObjectAssociationMap *refs = i-&gt;second; ObjectAssociationMap::iterator j = refs-&gt;find(key); if (j != refs-&gt;end()) { old_association = j-&gt;second; refs-&gt;erase(j); } } } } // release the old value (outside of the lock). // æœ€åæŠŠä¹‹å‰ä½¿ç”¨ä¼ å…¥çš„è¿™ä¸ªkeyå­˜å‚¨çš„å…³è”çš„valueé‡Šæ”¾ï¼ˆOBJC_ASSOCIATION_SETTER_RETAINç­–ç•¥å­˜å‚¨çš„ï¼‰ if (old_association.hasValue()) ReleaseValue()(old_association);} objc_getAssociatedObject123id objc_getAssociatedObject(id object, const void *key) { return _object_get_associative_reference(object, (void *)key);} åŒæ ·ä¹Ÿæ˜¯åŒ…è£…äº†ä¸€å±‚ï¼Œåˆ†æ_object_get_associative_referenceæ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132id _object_get_associative_reference(id object, void *key) { id value = nil; uintptr_t policy = OBJC_ASSOCIATION_ASSIGN; { // å…³è”å¯¹è±¡çš„ç®¡ç†ç±» AssociationsManager manager; AssociationsHashMap &amp;associations(manager.associations()); // ç”Ÿæˆä¼ªè£…åœ°å€ã€‚å¤„ç†å‚æ•° object åœ°å€ disguised_ptr_t disguised_object = DISGUISE(object); // æ‰€æœ‰å¯¹è±¡çš„é¢è¿­ä»£å™¨ AssociationsHashMap::iterator i = associations.find(disguised_object); if (i != associations.end()) { // è¿˜æ²¡åˆ°æœ€åå°±æ‰¾åˆ°äº† ObjectAssociationMap *refs = i-&gt;second; // å†…éƒ¨å¯¹è±¡çš„è¿­ä»£å™¨ ObjectAssociationMap::iterator j = refs-&gt;find(key); if (j != refs-&gt;end()) { // æ‰¾åˆ° - æŠŠå€¼å’Œç­–ç•¥è¯»å–å‡ºæ¥ ObjcAssociation &amp;entry = j-&gt;second; value = entry.value(); policy = entry.policy(); // å¦‚æœç­–ç•¥æ˜¯ OBJC_ASSOCIATION_GETTER_RETAIN - å°±ä¼šæŒæœ‰ä¸€ä¸‹ if (policy &amp; OBJC_ASSOCIATION_GETTER_RETAIN) { objc_retain(value); } } } } if (value &amp;&amp; (policy &amp; OBJC_ASSOCIATION_GETTER_AUTORELEASE)) { objc_autorelease(value); } return value;} objc_removeAssociatedObjectsobjc_removeAssociatedObjects æ–¹æ³•æˆ‘ä»¬å¹³æ—¶å¯èƒ½ç”¨çš„ä¸å¤šï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥åˆ é™¤å…³è”å¯¹è±¡ã€‚æˆ‘ä»¬æ¥åˆ°å®ƒçš„å®šä¹‰å¤„ï¼š 123456void objc_removeAssociatedObjects(id object) { if (object &amp;&amp; object-&gt;hasAssociatedObjects()) { _object_remove_assocations(object); }} åˆ†æ_object_remove_assocationsæ–¹æ³•ï¼š 123456789101112131415161718192021222324252627void _object_remove_assocations(id object) { vector&lt; ObjcAssociation,ObjcAllocator&lt;ObjcAssociation&gt; &gt; elements; { // å…³è”å¯¹è±¡çš„ç®¡ç†ç±» AssociationsManager manager; // è·å–å…³è”çš„ HashMap -&gt; å­˜å‚¨å½“å‰å…³è”å¯¹è±¡ AssociationsHashMap &amp;associations(manager.associations()); if (associations.size() == 0) return; // å¯¹å½“å‰å¯¹è±¡çš„åœ°å€åšæŒ‰ä½å–åæ“ä½œ disguised_ptr_t disguised_object = DISGUISE(object); // è·å– AssociationsHashMap çš„è¿­ä»£å™¨ - (å¯¹è±¡çš„) è¿›è¡Œéå† AssociationsHashMap::iterator i = associations.find(disguised_object); if (i != associations.end()) { // è¿˜æ²¡åˆ°æœ€åæ‰¾åˆ°äº† // copy all of the associations that need to be removed. ObjectAssociationMap *refs = i-&gt;second; for (ObjectAssociationMap::iterator j = refs-&gt;begin(), end = refs-&gt;end(); j != end; ++j) { elements.push_back(j-&gt;second); } // remove the secondary table. delete refs; associations.erase(i); } } // the calls to releaseValue() happen outside of the lock. // è¿™é‡Œä¼šå°†å¯¹è±¡åŒ…å«çš„æ‰€æœ‰å…³è”å¯¹è±¡åŠ å…¥åˆ°ä¸€ä¸ª `vector` ä¸­ï¼Œç„¶åå¯¹æ‰€æœ‰çš„ `ObjcAssociation` å¯¹è±¡è°ƒç”¨ `ReleaseValue()` æ–¹æ³•ï¼Œé‡Šæ”¾ä¸å†è¢«éœ€è¦çš„å€¼ for_each(elements.begin(), elements.end(), ReleaseValue());} PSobjc4-756.2æºç æœ¬æ–‡ä½¿ç”¨ï¼šobjc4-756.2æºç  è¿›è¡Œåˆ†æ å‚è€ƒiOS åº•å±‚æ¢ç´¢ - åˆ†ç±»çš„åŠ è½½ iOSæ¢ç´¢ åˆ†ç±»ã€ç±»æ‹“å±•çš„åŠ è½½è¿‡ç¨‹ iOS åº•å±‚æ¢ç´¢ - ç±»æ‹“å±•å’Œå…³è”å¯¹è±¡","link":"/2021/01/25/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/09-%E5%88%86%E7%B1%BB%E3%80%81%E7%B1%BB%E6%8B%93%E5%B1%95%E7%9A%84%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B/"},{"title":"ã€Šæ©˜å­ä¸æ˜¯å”¯ä¸€çš„æ°´æœã€‹è¯»ä¹¦ç¬”è®°","text":"è¿™æœ¬ä¹¦å‰åŠéƒ¨åˆ†è¿˜æŒºå…·æœ‰è‹±å¼å¹½é»˜çš„ï¼Œå½“åˆåœ¨ä¹¦åº—çœ‹åˆ°ä¸€äº›ç‰‡æ®µçš„æ—¶å€™éƒ½æœ‰ç‚¹å¿ä¸ä½ã€‚ä¸è¿‡åœ¨ååŠéƒ¨åˆ†ï¼Œå½“ä½œè€…ç»å†äº†ä¸€äº›å˜æ•…åï¼Œæ›´å¤šæ˜¯å¸¦æœ‰ä¸€ç§å¿§éƒå’Œæ·¡ç„¶çš„å¿ƒæ€åœ¨è®²è¿°ã€‚æˆ‘è¾¹è¯»è¾¹æƒ³è±¡ä½œè€…çå¦®ç‰¹Â·æ¸©ç‰¹æ£®çš„æ ·å­ï¼Œæˆ‘å¯¹äºä½œè€…æœ¬äººçš„å¹»æƒ³æ˜¯è¿™æ ·çš„ï¼š ä¸€åŒå¿§éƒåˆå¸¦æœ‰è´¨ç–‘çš„çœ¼ç›ï¼Œä»¥åŠåˆ©è½ä¸åŠ ä¿®é¥°å°±é€éœ²å‡ºæ¥çš„è¿·äººæ°”æ¯ã€‚ åæ¥æœäº†ä¸‹æœ¬äººç…§ç‰‡ï¼š æƒ³è±¡ä¸å‡ºå¥¹èƒ½å†™å‡ºæƒ…æ„Ÿå˜åŒ–å¦‚æ­¤ç»†è…»çš„æ–‡å­—ã€‚ æ¢—æ¦‚ï¼šä½œè€…å‡ºç”Ÿåè¢«ä¸€ä¸ªä¿¡æ•™çš„å®¶åº­æ”¶å…»ï¼Œåœ¨æ¯äº²çš„æ•™è‚²ä¸‹ï¼Œè™”è¯šçš„æ•™å¾’æ€æƒ³æ„ç­‘äº†å¥¹çš„åŸºæœ¬ä¸–ç•Œè§‚ã€‚ç„¶è€Œä¸Šå¸å¹¶ä¸èƒ½å¸®å¥¹ä»å¤–ç•Œè®¤ä¸ºçš„â€œç½ªæ¶â€å’Œä¸å¯æŠ‘åˆ¶çš„çˆ±ä¸Šä¸€ä¸ªå¥³å­©çš„çœŸå®æƒ…æ„«ä¸­è§£è„±ï¼Œç”šè‡³å¯¼è‡´è¢«æ¯äº²é€å‡ºå®¶é—¨ã€‚ä½œè€…å°±æ˜¯åœ¨è¿™ç§çŸ›ç›¾å’Œå¯¹ä¸–ç•Œçš„æ‰¹åˆ¤ä¸­è—åŒ¿ã€æˆé•¿ã€‚å¤šå¹´åå†å›å®¶ï¼Œæ¯äº²å·²å®Œå…¨é‡Šç„¶ï¼Œæ­¤æ—¶çš„ä½œè€…åˆæ˜¯å¦ä¸€ç§ä¸åŒçš„å¿ƒå¢ƒã€‚ ä½œè€…ä»å°åŸºæœ¬ä¸Šå°±åªåƒæ©˜å­è¿™ä¸€ç§æ°´æœï¼Œç‚¹ç›ä¹‹ç¬”ä¹Ÿæ­£æ˜¯é¢˜ç›®è¿™å¥ä»æ¯äº²å£ä¸­è¯´å‡ºçš„â€œæ©˜å­ä¸æ˜¯å”¯ä¸€çš„æ°´æœâ€ï¼Œæ„æ€æ˜¯è¿™ä¸–ç•Œä¸Šæ¯ä¸ªäººéƒ½æ˜¯ä¸åŒçš„å­˜åœ¨ï¼Œä¸èƒ½ç”¨åŒæ ·çš„è§‚ç‚¹å»å®¡è§†å’Œè¯„ä»·ä¸€ä¸ªäººï¼Œä½ ä¸ç†è§£å¹¶ä¸ä»£è¡¨åˆ«äººçš„äººç”Ÿå°±æ˜¯ç½ªæ¶çš„ï¼Œè¿™ä¹Ÿæ˜¯ä¸–ç•Œä¸°å¯Œå¤šå½©çš„åŸå› ã€‚ è¿™æœ¬ä¹¦çªå‡ºäº†å®¶åº­å¯¹ä¸ªäººæˆé•¿çš„é‡è¦ä½œç”¨ï¼Œè¿™æ˜¯ä½ æ— æ³•æ‘†è„±çš„æ—¢å®šäº‹å®ï¼Œä¸ªäººçœ‹å¾…è¿™ä¸ªä¸–ç•Œçš„æ–¹å¼ä¹Ÿä¸€å®šä¼šå—åˆ°å…¶å½±å“ã€‚åŒæ—¶å‘Šè¯«æˆ‘ä»¬ä¸å¿…å¯¹è¿™ä¸ªä¸–ç•Œå®Œå…¨å±ˆä»ï¼Œå¯ä»¥æŒæœ‰ä½ è‡ªå·±çš„æ€€ç–‘å’Œåå›ï¼Œè™½ç„¶ç»“æœä¸ä¸€å®šå®Œç¾ï¼Œä½†è¿™å°±æ˜¯ä½ çœŸå®çš„è‡ªå·±ã€‚ä½œè€…æ•æ‰äº†ç‰¹åˆ«å¤šå¾®å°çš„ç»†èŠ‚ï¼Œè®©æˆ‘æ„Ÿè§‰å¥¹çš„å¿ƒæ€éå¸¸ç»†è…»ã€‚ é¢˜å¤–è¯ï¼š æ–‡ä¸­æåˆ°äº†å†°æ·‡æ·‹è–„è„†ï¼Œå¬åå­—åº”è¯¥æŒºå¥½åƒçš„ã€‚ ä½œè€…èƒ½æ­¥è¡Œå¥½å‡ è‹±é‡Œå»æ‰¾æ¢…å…°å¦®ã€‚å¥¹éšä¾¿ä¸€èµ°å°±æ˜¯å‡ è‹±é‡Œè®©æˆ‘è§‰å¾—ç°ä»£äººçš„è¿åŠ¨é‡çœŸçš„æ˜¯å¤ªå°‘äº†ï¼ˆè¿™é‡Œçš„ç°ä»£äººä¹ŸåŒ…å«æˆ‘è‡ªå·±ï¼‰ã€‚","link":"/2021/05/10/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E3%80%8A%E6%A9%98%E5%AD%90%E4%B8%8D%E6%98%AF%E5%94%AF%E4%B8%80%E7%9A%84%E6%B0%B4%E6%9E%9C%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"},{"title":"15-å¤šçº¿ç¨‹ä¹‹åŸºç¡€åŸç†","text":"ä¸€ã€è¿›ç¨‹ã€çº¿ç¨‹ã€é˜Ÿåˆ—1.1 è¿›ç¨‹è¿›ç¨‹æ˜¯æŒ‡åœ¨ç³»ç»Ÿä¸­æ­£åœ¨è¿è¡Œçš„ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œæ¯ä¸ªè¿›ç¨‹ä¹‹é—´æ˜¯ç‹¬ç«‹çš„ï¼Œæ¯ä¸ªè¿›ç¨‹å‡è¿è¡Œåœ¨å…¶ä¸“ç”¨ä¸”å—ä¿æŠ¤çš„å†…å­˜ç©ºé—´å†…ã€‚ 1.2 çº¿ç¨‹çº¿ç¨‹ï¼ˆThreadï¼‰ï¼Œæ˜¯ç¨‹åºæ‰§è¡Œæµçš„æœ€å°å•ä½ã€‚ ä¸€ä¸ªæ ‡å‡†çš„çº¿ç¨‹ç”±çº¿ç¨‹IDã€å½“å‰æŒ‡ä»¤æŒ‡é’ˆï¼ˆPCï¼‰ã€å¯„å­˜å™¨é›†åˆå’Œå †æ ˆç»„æˆã€‚é€šå¸¸ä¸€ä¸ªè¿›ç¨‹ç”±ä¸€ä¸ªåˆ°å¤šä¸ªçº¿ç¨‹ç»„æˆï¼Œå„ä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«ç¨‹åºçš„å†…å­˜ç©ºé—´ï¼ˆåŒ…æ‹¬ä»£ç æ®µã€æ•°æ®æ®µã€å †ç­‰ï¼‰åŠä¸€äº›è¿›ç¨‹çº§ç­‰èµ„æºï¼ˆå¦‚æ‰“å¼€æ–‡ä»¶å’Œä¿¡å·ï¼‰ã€‚ä¸€ä¸ªç»å…¸çš„çº¿ç¨‹ä¸è¿›ç¨‹å…³ç³»å¦‚å›¾æ‰€ç¤ºï¼š 1.3 è¿›ç¨‹ä¸çº¿ç¨‹çš„å…³ç³» åœ°å€ç©ºé—´ï¼š åŒä¸€è¿›ç¨‹çš„çº¿ç¨‹å…±äº«æœ¬è¿›ç¨‹çš„åœ°å€ç©ºé—´ è¿›ç¨‹ä¹‹é—´æ˜¯ç‹¬ç«‹çš„åœ°å€ç©ºé—´ èµ„æºæ‹¥æœ‰ï¼š åŒä¸€è¿›ç¨‹å†…çš„çº¿ç¨‹å…±äº«æœ¬è¿›ç¨‹çš„èµ„æºå¦‚å†…å­˜ã€I/Oã€cpu ç­‰ è¿›ç¨‹ä¹‹é—´çš„èµ„æºæ˜¯ç‹¬ç«‹çš„ å¥å£®æ€§ï¼š ä¸€ä¸ªè¿›ç¨‹å´©æºƒåï¼Œåœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ä¸ä¼šå¯¹å…¶ä»–è¿›ç¨‹äº§ç”Ÿå½±å“ ä½†æ˜¯ä¸€ä¸ªçº¿ç¨‹å´©æºƒæ•´ä¸ªè¿›ç¨‹éƒ½æ­»æ‰ï¼Œæ‰€ä»¥å¤šè¿›ç¨‹è¦æ¯”å¤šçº¿ç¨‹å¥å£® èµ„æºæ¶ˆè€—ï¼š è¿›ç¨‹åˆ‡æ¢æ—¶ï¼Œæ¶ˆè€—çš„èµ„æºå¤§ã€‚ çº¿ç¨‹æ— æ³•åˆ‡æ¢ï¼Œåªèƒ½äº’ç›¸é€šä¿¡ï¼Œæ¶ˆè€—çš„èµ„æºè¾ƒå° æ‰§è¡Œè¿‡ç¨‹ï¼š æ¯ä¸ªç‹¬ç«‹çš„è¿›ç¨‹æœ‰ä¸€ä¸ªç¨‹åºè¿è¡Œçš„å…¥å£ã€é¡ºåºæ‰§è¡Œåºåˆ—å’Œç¨‹åºå…¥å£ã€‚ ä½†æ˜¯çº¿ç¨‹ä¸èƒ½ç‹¬ç«‹æ‰§è¡Œï¼Œå¿…é¡»ä¾å­˜åœ¨åº”ç”¨ç¨‹åºä¸­ï¼Œç”±åº”ç”¨ç¨‹åºæä¾›å¤šä¸ªçº¿ç¨‹æ‰§è¡Œæ§åˆ¶ çº¿ç¨‹æ˜¯å¤„ç†å™¨è°ƒåº¦çš„åŸºæœ¬å•ä½ï¼Œä½†è¿›ç¨‹ä¸æ˜¯ 1.4 é˜Ÿåˆ—é˜Ÿåˆ—ï¼Œæ˜¯å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼š First-In-First-Outï¼‰çš„çº¿æ€§è¡¨ï¼Œåœ¨å…·ä½“åº”ç”¨ä¸­é€šå¸¸ç”¨é“¾è¡¨æˆ–è€…æ•°ç»„æ¥å®ç°ã€‚è£…è½½çº¿ç¨‹ä»»åŠ¡çš„é˜Ÿå½¢ç»“æ„ã€‚é˜Ÿåˆ—åªå…è®¸åœ¨åç«¯è¿›è¡Œæ’å…¥æ“ä½œï¼Œåœ¨å‰ç«¯è¿›è¡Œåˆ é™¤æ“ä½œã€‚é˜Ÿåˆ—çš„æ“ä½œæ–¹å¼å’Œå †æ ˆç±»ä¼¼ï¼Œå”¯ä¸€çš„åŒºåˆ«åœ¨äºé˜Ÿåˆ—åªå…è®¸æ–°æ•°æ®åœ¨åç«¯è¿›è¡Œæ·»åŠ  é˜Ÿåˆ—è´Ÿè´£è°ƒåº¦ä»»åŠ¡ï¼Œçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ 1.5 çº¿ç¨‹å’Œ runloop çš„å…³ç³» runloop ä¸çº¿ç¨‹æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼šä¸€ä¸ªrunloopå¯¹åº”ä¸€ä¸ªæ ¸å¿ƒçš„çº¿ç¨‹ï¼Œä¸ºä»€ä¹ˆè¯´æ˜¯æ ¸å¿ƒçš„ï¼Œæ˜¯å› ä¸º runloop æ˜¯å¯ä»¥åµŒå¥—çš„ï¼Œä½†æ˜¯æ ¸å¿ƒçš„åªèƒ½æœ‰ä¸€ä¸ªï¼Œä»–ä»¬çš„å…³ç³»ä¿å­˜åœ¨ä¸€ä¸ªå…¨å±€çš„å­—å…¸é‡Œ runloop æ˜¯æ¥ç®¡ç†çº¿ç¨‹çš„ï¼šå½“çº¿ç¨‹çš„runloopè¢«å¼€å¯åï¼Œçº¿ç¨‹ä¼šåœ¨æ‰§è¡Œå®Œä»»åŠ¡åè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œæœ‰äº†ä»»åŠ¡å°±ä¼šè¢«å”¤é†’å»æ‰§è¡Œä»»åŠ¡ runloopåœ¨ç¬¬ä¸€æ¬¡è·å–æ—¶è¢«åˆ›å»ºï¼Œåœ¨çº¿ç¨‹ç»“æŸæ—¶è¢«é”€æ¯ å¯¹äºä¸»çº¿ç¨‹æ¥è¯´ï¼Œrunloopåœ¨ç¨‹åºä¸€å¯åŠ¨å°±é»˜è®¤åˆ›å»ºå¥½äº† å¯¹äºå­çº¿ç¨‹æ¥è¯´ï¼Œrunloopæ˜¯æ‡’åŠ è½½çš„â€”â€”åªæœ‰å½“æˆ‘ä»¬ä½¿ç”¨çš„æ—¶å€™æ‰ä¼šåˆ›å»ºï¼Œæ‰€ä»¥åœ¨å­çº¿ç¨‹ç”¨å®šæ—¶å™¨è¦æ³¨æ„ï¼šç¡®ä¿å­çº¿ç¨‹çš„runloopè¢«åˆ›å»ºï¼Œä¸ç„¶å®šæ—¶å™¨ä¸ä¼šå›è°ƒ äºŒã€å¤šçº¿ç¨‹2.1 å¤šçº¿ç¨‹åŸç† åŒä¸€æ—¶é—´ï¼ŒCPU åªèƒ½å¤„ç†ä¸€æ¡çº¿ç¨‹ï¼Œåªæœ‰ä¸€æ¡çº¿ç¨‹åœ¨æ‰§è¡Œ å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œï¼Œå…¶å®å°±æ˜¯ CPU æ‰§è¡Œå¿«é€Ÿåœ°åœ¨å¤šæ¡çº¿ç¨‹ä¹‹é—´åˆ‡æ¢ 2.2 å¤šçº¿ç¨‹æ„ä¹‰ ä¼˜ç‚¹ èƒ½é€‚å½“æé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ èƒ½é€‚å½“æé«˜èµ„æºçš„åˆ©ç”¨ç‡ï¼ˆCPUã€å†…å­˜ï¼‰ çº¿ç¨‹ä¸Šçš„ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œçº¿ç¨‹ä¼šè‡ªåŠ¨é”€æ¯ ç¼ºç‚¹ å¼€å¯çº¿ç¨‹éœ€è¦å ç”¨ä¸€å®šçš„å†…å­˜ç©ºé—´ï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½å 512KBï¼Œåˆ›å»ºçº¿ç¨‹å¤§çº¦éœ€è¦90æ¯«ç§’çš„åˆ›å»ºæ—¶é—´ï¼‰ å¦‚æœå¼€å¯å¤§é‡çš„çº¿ç¨‹ï¼Œä¼šå ç”¨å¤§é‡çš„å†…å­˜ç©ºé—´ï¼Œé™ä½ç¨‹åºçš„æ€§èƒ½ çº¿ç¨‹è¶Šå¤šï¼ŒCPUåœ¨è°ƒç”¨çº¿ç¨‹ä¸Šçš„å¼€é”€å°±è¶Šå¤§ ç¨‹åºè®¾è®¡æ›´åŠ å¤æ‚ï¼Œæ¯”å¦‚çº¿ç¨‹é—´çš„é€šä¿¡ã€å¤šçº¿ç¨‹çš„æ•°æ®å…±äº« 2.3 å¤šçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ å¤šçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ï¼šæ–°å»º - å°±ç»ª - è¿è¡Œ - é˜»å¡ - æ­»äº¡ æ–°å»ºï¼šå®ä¾‹åŒ–çº¿ç¨‹å¯¹è±¡ å°±ç»ªï¼šå‘çº¿ç¨‹å¯¹è±¡å‘é€ start æ¶ˆæ¯ï¼Œçº¿ç¨‹å¯¹è±¡è¢«åŠ å…¥å¯è°ƒåº¦çº¿ç¨‹æ± ç­‰å¾… CPU è°ƒåº¦ã€‚ è¿è¡Œï¼šCPU è´Ÿè´£è°ƒåº¦å¯è°ƒåº¦çº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„æ‰§è¡Œã€‚çº¿ç¨‹æ‰§è¡Œå®Œæˆä¹‹å‰ï¼ŒçŠ¶æ€å¯èƒ½ä¼šåœ¨å°±ç»ªå’Œè¿è¡Œä¹‹é—´æ¥å›åˆ‡æ¢ã€‚å°±ç»ªå’Œè¿è¡Œä¹‹é—´çš„çŠ¶æ€å˜åŒ–ç”± CPU è´Ÿè´£ï¼Œç¨‹åºå‘˜ä¸èƒ½å¹²é¢„ã€‚ é˜»å¡ï¼šå½“æ»¡è¶³æŸä¸ªé¢„å®šæ¡ä»¶æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ä¼‘çœ æˆ–é”ï¼Œé˜»å¡çº¿ç¨‹æ‰§è¡Œã€‚sleepForTimeIntervalï¼ˆä¼‘çœ æŒ‡å®šæ—¶é•¿ï¼‰ï¼ŒsleepUntilDateï¼ˆä¼‘çœ åˆ°æŒ‡å®šæ—¥æœŸï¼‰ï¼Œ@synchronized(self)ï¼šï¼ˆäº’æ–¥é”ï¼‰ã€‚ æ­»äº¡ï¼šæ­£å¸¸æ­»äº¡ï¼Œçº¿ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚éæ­£å¸¸æ­»äº¡ï¼Œå½“æ»¡è¶³æŸä¸ªæ¡ä»¶åï¼Œåœ¨çº¿ç¨‹å†…éƒ¨ä¸­æ­¢æ‰§è¡Œ/åœ¨ä¸»çº¿ç¨‹ä¸­æ­¢çº¿ç¨‹å¯¹è±¡ 2.4 çº¿ç¨‹æ± çš„åŸç† è‹¥çº¿ç¨‹æ± å¤§å°å°äºæ ¸å¿ƒçº¿ç¨‹æ± å¤§å°æ—¶ åˆ›å»ºçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ è‹¥çº¿ç¨‹æ± å¤§å°å¤§äºç­‰äºæ ¸å¿ƒçº¿ç¨‹æ± å¤§å°æ—¶ å…ˆåˆ¤æ–­çº¿ç¨‹æ± å·¥ä½œé˜Ÿåˆ—æ˜¯å¦å·²æ»¡ è‹¥æ²¡æ»¡å°±å°†ä»»åŠ¡pushè¿›é˜Ÿåˆ— è‹¥å·²æ»¡æ—¶ï¼Œä¸”maximumPoolSize&gt;corePoolSizeï¼Œå°†åˆ›å»ºæ–°çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ åä¹‹åˆ™äº¤ç»™é¥±å’Œç­–ç•¥å»å¤„ç† å‚æ•°å ä»£è¡¨æ„ä¹‰ corePoolSize çº¿ç¨‹æ± çš„åŸºæœ¬å¤§å°ï¼ˆæ ¸å¿ƒçº¿ç¨‹æ± å¤§å°ï¼‰ maximumPool çº¿ç¨‹æ± çš„æœ€å¤§å¤§å° keepAliveTime çº¿ç¨‹æ± ä¸­è¶…è¿‡corePoolSizeæ ‘æœ¨çš„ç©ºé—²çº¿ç¨‹çš„æœ€å¤§å­˜æ´»æ—¶é—´ unit keepAliveTimeå‚æ•°çš„æ—¶é—´å•ä½ workQueue ä»»åŠ¡é˜»å¡é˜Ÿåˆ— threadFactory æ–°å»ºçº¿ç¨‹çš„å·¥å‚ handler å½“æäº¤çš„ä»»åŠ¡æ•°è¶…è¿‡maxmumPoolSizeä¸workQueueä¹‹å’Œæ—¶ï¼Œ ä»»åŠ¡ä¼šäº¤ç»™RejectedExecutionHandleræ¥å¤„ç† é¥±å’Œç­–ç•¥æœ‰å¦‚ä¸‹å››ä¸ªï¼š AbortPolicyç›´æ¥æŠ›å‡ºRejectedExecutionExeceptionå¼‚å¸¸æ¥é˜»æ­¢ç³»ç»Ÿæ­£å¸¸è¿è¡Œ CallerRunsPolicyå°†ä»»åŠ¡å›é€€åˆ°è°ƒç”¨è€… DisOldestPolicyä¸¢æ‰ç­‰å¾…æœ€ä¹…çš„ä»»åŠ¡ DisCardPolicyç›´æ¥ä¸¢å¼ƒä»»åŠ¡ 2.5 iOS ä¸­çš„å¤šçº¿ç¨‹æ–¹æ¡ˆ æŠ€æœ¯æ–¹æ¡ˆ ç®€ä»‹ è¯­è¨€ çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ ä½¿ç”¨é¢‘ç‡ pthread ä¸€å¥—é€šç”¨çš„å¤šçº¿ç¨‹API é€‚ç”¨äºUnix/Linux/Windowsç­‰ç³»ç»Ÿ è·¨å¹³å°/å¯ç§»æ¤ ä½¿ç”¨éš¾åº¦å¤§ C ç¨‹åºå‘˜ç®¡ç† å‡ ä¹ä¸ç”¨ NSThread ä½¿ç”¨æ›´åŠ é¢å‘å¯¹è±¡ ç®€å•æ˜“ç”¨ï¼Œå¯ç›´æ¥æ“ä½œçº¿ç¨‹å¯¹è±¡ OC ç¨‹åºå‘˜ç®¡ç† å¶å°”ä½¿ç”¨ GCD æ—¨åœ¨æ›¿ä»£NSThreadç­‰çº¿ç¨‹æŠ€æœ¯ å……åˆ†åˆ©ç”¨è®¾å¤‡çš„å¤šæ ¸ C è‡ªåŠ¨ç®¡ç† ç»å¸¸ä½¿ç”¨ NSOperation åŸºäºGCDï¼ˆåº•å±‚æ˜¯GCDï¼‰ æ¯”GCDå¤šäº†ä¸€äº›æ›´ç®€å•å®ç”¨çš„åŠŸèƒ½ ä½¿ç”¨æ›´åŠ é¢å‘å¯¹è±¡ OC è‡ªåŠ¨ç®¡ç† ç»å¸¸ä½¿ç”¨ å¸¸ç”¨çš„å°±æ˜¯ GCD å’Œ NSOperationï¼ŒåŒºåˆ«ï¼š GCDä»…ä»…æ”¯æŒFIFOé˜Ÿåˆ—ï¼Œä¸æ”¯æŒå¼‚æ­¥æ“ä½œä¹‹é—´çš„ä¾èµ–å…³ç³»è®¾ç½®ã€‚è€ŒNSOperationä¸­çš„é˜Ÿåˆ—å¯ä»¥è¢«é‡æ–°è®¾ç½®ä¼˜å…ˆçº§ï¼Œä»è€Œå®ç°ä¸åŒæ“ä½œçš„æ‰§è¡Œé¡ºåºè°ƒæ•´ NSOperationæ”¯æŒKVOï¼Œå¯ä»¥è§‚å¯Ÿä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€ GCDæ›´æ¥è¿‘åº•å±‚ï¼ŒGCDåœ¨è¿½æ±‚æ€§èƒ½çš„åº•å±‚æ“ä½œæ¥è¯´ï¼Œæ˜¯é€Ÿåº¦æœ€å¿«çš„ ä»å¼‚æ­¥æ“ä½œä¹‹é—´çš„äº‹åŠ¡æ€§ï¼Œé¡ºåºè¡Œï¼Œä¾èµ–å…³ç³»ã€‚GCDéœ€è¦è‡ªå·±å†™æ›´å¤šçš„ä»£ç æ¥å®ç°ï¼Œè€ŒNSOperationå·²ç»å†…å»ºäº†è¿™äº›æ”¯æŒ å¦‚æœå¼‚æ­¥æ“ä½œçš„è¿‡ç¨‹éœ€è¦æ›´å¤šçš„è¢«äº¤äº’å’ŒUIå‘ˆç°å‡ºæ¥ï¼ŒNSOperationæ›´å¥½ï¼›åº•å±‚ä»£ç ä¸­ï¼Œä»»åŠ¡ä¹‹é—´ä¸å¤ªäº’ç›¸ä¾èµ–ï¼Œè€Œéœ€è¦æ›´é«˜çš„å¹¶å‘èƒ½åŠ›ï¼ŒGCDåˆ™æ›´æœ‰ä¼˜åŠ¿ 2.6 çº¿ç¨‹é—´é€šè®¯è‹¹æœå®˜æ–¹ çº¿ç¨‹ç›¸å…³çš„æ–‡æ¡£æ˜¯è¿™æ ·ä»‹ç»çš„ï¼š ç›´æ¥æ¶ˆæ¯ä¼ é€’: é€šè¿‡performSelectorçš„ä¸€ç³»åˆ—æ–¹æ³•ï¼Œå¯ä»¥å®ç°ç”±æŸä¸€çº¿ç¨‹æŒ‡å®šåœ¨å¦å¤–çš„çº¿ç¨‹ä¸Šæ‰§è¡Œä»»åŠ¡ã€‚ å…¨å±€å˜é‡ã€å…±äº«å†…å­˜å—å’Œå¯¹è±¡: å°½ç®¡å…±äº«å˜é‡æ—¢å¿«é€Ÿåˆç®€å•ï¼Œä½†æ˜¯å®ƒä»¬æ¯”ç›´æ¥æ¶ˆæ¯ä¼ é€’æ›´è„†å¼±ã€‚ä½†æ˜¯å¿…é¡»ä½¿ç”¨é”æˆ–å…¶ä»–åŒæ­¥æœºåˆ¶ä¿æŠ¤å…±äº«å˜é‡ï¼Œå¦åˆ™å¯èƒ½ä¼šå¯¼è‡´æ•°æ®æŸåæˆ–å´©æºƒã€‚ æ¡ä»¶æ‰§è¡Œ: æ¡ä»¶æ˜¯ä¸€ç§åŒæ­¥å·¥å…·ï¼Œå¯ç”¨äºæ§åˆ¶çº¿ç¨‹ä½•æ—¶æ‰§è¡Œä»£ç çš„ç‰¹å®šéƒ¨åˆ†ã€‚ Runloop èµ„æº: ä¸€ä¸ªè‡ªå®šä¹‰çš„ Runloop source é…ç½®å¯ä»¥è®©ä¸€ä¸ªçº¿ç¨‹ä¸Šæ”¶åˆ°ç‰¹å®šçš„åº”ç”¨ç¨‹åºæ¶ˆæ¯ã€‚ç”±äº Runloop source æ˜¯äº‹ä»¶é©±åŠ¨çš„ï¼Œå› æ­¤åœ¨æ— äº‹å¯åšæ—¶ï¼Œçº¿ç¨‹ä¼šè‡ªåŠ¨è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œä»è€Œæé«˜äº†çº¿ç¨‹çš„æ•ˆç‡ ç«¯å£å’Œå¥—æ¥å­—:åŸºäºç«¯å£çš„é€šä¿¡æ˜¯åœ¨ä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´è¿›è¡Œé€šä¿¡çš„ä¸€ç§æ›´ä¸ºå¤æ‚çš„æ–¹æ³•ï¼Œä½†å®ƒä¹Ÿæ˜¯ä¸€ç§éå¸¸å¯é çš„æŠ€æœ¯ã€‚ æ¶ˆæ¯é˜Ÿåˆ—: ä¼ ç»Ÿçš„å¤šå¤„ç†æœåŠ¡å®šä¹‰äº†å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰é˜Ÿåˆ—æŠ½è±¡ï¼Œç”¨äºç®¡ç†ä¼ å…¥å’Œä¼ å‡ºæ•°æ®ã€‚å°½ç®¡æ¶ˆæ¯é˜Ÿåˆ—æ—¢ç®€å•åˆæ–¹ä¾¿ï¼Œä½†æ˜¯å®ƒä»¬ä¸å¦‚å…¶ä»–ä¸€äº›é€šä¿¡æŠ€æœ¯é«˜æ•ˆ å¯¹è±¡åˆ†å‘: å¯¹è±¡åˆ†å‘æ˜¯ä¸€ç§Cocoa æŠ€æœ¯ï¼Œæä¾›äº†åŸºäºç«¯å£é«˜çº§å®ç°ã€‚å°½ç®¡åœ¨çº¿ç¨‹å†…ä½¿ç”¨è¿™é—¨æŠ€æœ¯ä¹Ÿèƒ½ç”¨ï¼Œä½†é‰´äºä½¿ç”¨å®ƒä¼šå¸¦æ¥çš„æ€§èƒ½å¼€æ”¯ï¼Œé«˜åº¦ä¸å»ºè®®ä½¿ç”¨ã€‚åˆ†å‘å¯¹è±¡æ›´é€‚åˆäºè¿›ç¨‹é—´çš„é€šä¿¡ï¼Œå°¤å…¶æ˜¯å½“è¿›ç¨‹æ¶ˆè€—å·²ç»å¾ˆé«˜çš„æƒ…å†µä¸‹ 2.7 çº¿ç¨‹çš„å…³é—­å»ºè®®åœ¨åˆ›å»ºçº¿ç¨‹çš„æ—¶å€™ï¼Œå°±è®¾è®¡å¥½å“åº”å–æ¶ˆå’Œé€€å‡ºçº¿ç¨‹çš„æ¶ˆæ¯ã€‚å¦‚æœç¡®å®æœ‰æ¶ˆæ¯è¿›æ¥â€”â€”è¦æ±‚çº¿ç¨‹é€€å‡ºï¼Œçº¿ç¨‹å¯èƒ½æ¥ä¸‹æ¥å¯ä»¥å®ç°ä¸€äº›å¿…é¡»çš„æ¸…ç†å·¥ä½œï¼Œç„¶åä¼˜é›…çš„é€€å‡ºã€‚ å“åº”å–æ¶ˆæ¶ˆæ¯çš„æ–¹æ³•æ˜¯ä½¿ç”¨Runloopï¼Œçœ‹çœ‹ä¸‹é¢çš„ä»£ç ï¼š 12345678910111213141516171819202122232425- (void)threadMainRoutine{ BOOL moreWorkToDo = YES; BOOL exitNow = NO; NSRunLoop* runLoop = [NSRunLoop currentRunLoop]; // Add the exitNow BOOL to the thread dictionary. NSMutableDictionary* threadDict = [[NSThread currentThread] threadDictionary]; [threadDict setValue:[NSNumber numberWithBool:exitNow] forKey:@&quot;ThreadShouldExitNow&quot;]; // Install an input source. [self myInstallCustomInputSource]; while (moreWorkToDo &amp;&amp; !exitNow) { // Do one chunk of a larger body of work here. // Change the value of the moreWorkToDo Boolean when done. // Run the run loop but timeout immediately if the input source isn't waiting to fire. [runLoop runUntilDate:[NSDate date]]; // Check to see if an input source handler changed the exitNow value. exitNow = [[threadDict valueForKey:@&quot;ThreadShouldExitNow&quot;] boolValue]; }} ä¸‰ã€å¤šçº¿ç¨‹æ–¹æ¡ˆè„‘å›¾ è¡¥å……atomic ä¸ nonatomic çš„åŒºåˆ«nonatomicï¼šéåŸå­æ€§ï¼Œéçº¿ç¨‹å®‰å…¨ï¼Œé€‚åˆå†…å­˜å°çš„ç§»åŠ¨è®¾å¤‡ atomicï¼šåŸå­å±æ€§ï¼Œé’ˆå¯¹å¤šçº¿ç¨‹è®¾è®¡çš„ï¼Œæ˜¯å±æ€§çš„é»˜è®¤å€¼ï¼Œä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿå†™å…¥ï¼ˆä½†æ˜¯åŒä¸€æ—¶é—´èƒ½æœ‰å¤šä¸ªçº¿ç¨‹å–å€¼ï¼‰ï¼Œatomicæœ¬èº«å°±æœ‰ä¸€æŠŠé”ï¼ˆè‡ªæ—‹é”ï¼‰ï¼Œæ‰€ä»¥æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯éœ€è¦æ¶ˆè€—å¤§é‡èµ„æº å¼€å‘å»ºè®®ï¼š æ‰€æœ‰å±æ€§éƒ½å£°æ˜ä¸º nonatomic å°½é‡é¿å…å¤šçº¿ç¨‹æŠ¢å¤ºåŒä¸€å¿«èµ„æº å°½é‡å°†åŠ é”ã€èµ„æºæŠ¢å¤ºçš„ä¸šåŠ¡é€»è¾‘äº¤ç»™æœåŠ¡å™¨æ¥å¤„ç†ï¼Œå‡å°ç§»åŠ¨å®¢æˆ·ç«¯çš„å‹åŠ› å‚è€ƒiOSåº•å±‚å­¦ä¹  - å¤šçº¿ç¨‹ä¹‹åŸºç¡€åŸç†ç¯‡ iOSæ¢ç´¢ å¤šçº¿ç¨‹åŸç† å¤šçº¿ç¨‹","link":"/2021/04/06/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/15-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8B%E5%9F%BA%E7%A1%80%E5%8E%9F%E7%90%86/"},{"title":"16-å¤šçº¿ç¨‹ä¹‹GCDåˆæ¢","text":"ä¸€ã€GCDç®€ä»‹1.1 å®šä¹‰GCDå…¨ç¨‹ä¸ºGrand Central Dispatchï¼Œç”±Cè¯­è¨€å®ç°ï¼Œæ˜¯è‹¹æœä¸ºå¤šæ ¸çš„å¹¶è¡Œè¿ç®—æå‡ºçš„è§£å†³æ–¹æ¡ˆï¼ŒCGDä¼šè‡ªåŠ¨åˆ©ç”¨æ›´å¤šçš„CPUå†…æ ¸ï¼Œè‡ªåŠ¨ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼Œç¨‹åºå‘˜åªéœ€è¦å‘Šè¯‰GCDéœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæ— éœ€ç¼–å†™ä»»ä½•ç®¡ç†çº¿ç¨‹çš„ä»£ç ã€‚GCDä¹Ÿæ˜¯iOSä½¿ç”¨é¢‘ç‡æœ€é«˜çš„å¤šçº¿ç¨‹æŠ€æœ¯ã€‚ ä¼˜åŠ¿ï¼š GCD æ˜¯è‹¹æœå…¬å¸ä¸ºå¤šæ ¸çš„å¹¶è¡Œè¿ç®—æå‡ºçš„è§£å†³æ–¹æ¡ˆ GCD ä¼šè‡ªåŠ¨åˆ©ç”¨æ›´å¤šçš„CPUå†…æ ¸ï¼ˆæ¯”å¦‚åŒæ ¸ã€å››æ ¸ï¼‰ GCD ä¼šè‡ªåŠ¨ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼ˆåˆ›å»ºçº¿ç¨‹ã€è°ƒåº¦ä»»åŠ¡ã€é”€æ¯çº¿ç¨‹ï¼‰ ç¨‹åºå‘˜åªéœ€è¦å‘Šè¯‰ GCD æƒ³è¦æ‰§è¡Œä»€ä¹ˆä»»åŠ¡ï¼Œä¸éœ€è¦ç¼–å†™ä»»ä½•çº¿ç¨‹ç®¡ç†ä»£ç  1.2 åŒæ­¥å‡½æ•°å’Œå¼‚æ­¥å‡½æ•°åŒæ­¥å‡½æ•°ï¼š 12//queueï¼šé˜Ÿåˆ— blockï¼šä»»åŠ¡dispatch_sync(dispatch_queue_t queue, dispatch_block_t block); å¼‚æ­¥å‡½æ•°ï¼š 12//queueï¼šé˜Ÿåˆ— blockï¼šä»»åŠ¡dispatch_async(dispatch_queue_t queue, dispatch_block_t block); 1.3 ä»»åŠ¡é€šè¿‡æŸ¥çœ‹å…¶å®šä¹‰å¯å¾—ï¼Œè¯¥å‚æ•°å…¶å®å°±æ˜¯ä¸€ä¸ªæ²¡æœ‰å‚æ•°çš„blockå›è°ƒï¼Œç”¨æ¥æ‰§è¡Œä»»åŠ¡çš„ã€‚ 1typedef void (^dispatch_block_t)(void); 1.4 é˜Ÿåˆ—ä¸»é˜Ÿåˆ—ç”±ç³»ç»Ÿåˆ›å»ºçš„ä¸²è¡Œé˜Ÿåˆ—ã€‚ è·å–æ–¹å¼ï¼šdispatch_get_main_queue() è‡ªå®šä¹‰çš„ä¸²è¡Œé˜Ÿåˆ—è·å–æ–¹å¼ï¼šdispatch_queue_create(@&quot;é˜Ÿåˆ—å&quot;,DISPATCH_QUEUE_SERIAL) å…¨å±€é˜Ÿåˆ—å¹¶å‘ç”±ç³»ç»Ÿåˆ›å»ºçš„å¹¶å‘é˜Ÿåˆ— è·å–æ–¹å¼ï¼šdispatch_get_global_queue(long identifier, unsigned long flags); è‡ªå®šä¹‰çš„å¹¶å‘é˜Ÿåˆ—è·å–æ–¹å¼ï¼šdispatch_queue_create(@&quot;é˜Ÿåˆ—å&quot;,DISPATCH_QUEUE_CONCURRENT); å…¶ä¸­ï¼Œå…¨å±€é˜Ÿåˆ—æ ¹æ®å…¥å‚çš„ä¸åŒï¼Œä¼šè·å–åˆ°ä¸åŒçš„é˜Ÿåˆ—ï¼Œåœ¨æ—¥å¸¸çš„å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬å…¥å‚0,æ¥è·å–åˆ°ä¸»å¹¶å‘é˜Ÿåˆ—ã€‚ è‡ªå®šä¹‰çš„é˜Ÿåˆ—éƒ½æ˜¯è°ƒç”¨dispatch_queue_create(const char *_Nullable label,dispatch_queue_attr_t _Nullable attr)æ–¹æ³•æ¥è¿›è¡Œåˆ›å»ºï¼Œä¸¤ä¸ªå‚æ•°åˆ†åˆ«ä¸ºè‡ªå®šä¹‰é˜Ÿåˆ—åç§°å’Œé˜Ÿåˆ—ç±»å‹ã€‚ å…¶ä¸­ä¸²è¡Œé˜Ÿåˆ—DISPATCH_QUEUE_SERIALä¸ºå®å®šä¹‰çš„NULLï¼Œæ‰€ä»¥ä¼ NULLä¹Ÿè¡¨ç¤ºä¸ºä¸²è¡Œé˜Ÿåˆ—ã€‚ äºŒã€GCDçš„ä½¿ç”¨2.1 å¸¸è§„ä½¿ç”¨åŒæ­¥ + ä¸»é˜Ÿåˆ—ã€æ­»é”ã€‘1234567891011- (void)viewDidLoad { [super viewDidLoad]; NSLog(@&quot;ä»»åŠ¡1:%@&quot;,[NSThread currentThread]); dispatch_queue_t queue = dispatch_get_main_queue(); dispatch_sync(queue, ^{ NSLog(@&quot;ä»»åŠ¡2&quot;,[NSThread currentThread]); }); NSLog(@&quot;ä»»åŠ¡3:%@&quot;,[NSThread currentThread]);} è¿è¡Œç»“æœï¼š 1æ‰“å°å‡ºä»»åŠ¡1åï¼Œç¨‹åºæ­»é”å´©æºƒ åŸå› ï¼š ä¸²å‹é˜Ÿåˆ—çš„ç‰¹ç‚¹æ˜¯FIFOï¼Œä¸»é˜Ÿåˆ—ä¸­å·²ç»å­˜åœ¨ä»»åŠ¡viewDidLoadï¼Œå¾€ä¸»é˜Ÿåˆ—åŠ å…¥ä»»åŠ¡2ï¼Œå°±éœ€è¦æ‰§è¡Œå®ŒviewDidLoadæ‰èƒ½æ‰§è¡Œä»»åŠ¡2ã€‚ä½†æ˜¯æƒ³è¦æ‰§è¡Œå®ŒviewDidLoadåˆå¿…é¡»å…ˆæ‰§è¡ŒviewDidLoadå†…çš„ä»»åŠ¡2å’Œä»»åŠ¡3ã€‚è¿™å°±é€ æˆäº†æ­»é”ã€‚ å¼‚æ­¥ +ï¼ˆä¸»é˜Ÿåˆ— / è‡ªå®šä¹‰ä¸²è¡Œé˜Ÿåˆ—ï¼‰å¼‚æ­¥å‡½æ•° + ä¸»é˜Ÿåˆ—ï¼š 1234567891011121314151617- (void)viewDidLoad { [super viewDidLoad]; NSLog(@&quot;ä»»åŠ¡1:%@&quot;,[NSThread currentThread]); dispatch_queue_t queue = dispatch_get_main_queue(); dispatch_async(queue, ^{ sleep(3); NSLog(@&quot;ä»»åŠ¡2:%@&quot;,[NSThread currentThread]); }); dispatch_async(queue, ^{ NSLog(@&quot;ä»»åŠ¡3:%@&quot;,[NSThread currentThread]); }); NSLog(@&quot;ä»»åŠ¡4:%@&quot;,[NSThread currentThread]);} è¿è¡Œç»“æœï¼š 1234ä»»åŠ¡1:&lt;NSThread: 0x600003a10500&gt;{number = 1, name = main}ä»»åŠ¡4:&lt;NSThread: 0x600003a10500&gt;{number = 1, name = main}ä»»åŠ¡2:&lt;NSThread: 0x600003a10500&gt;{number = 1, name = main}ä»»åŠ¡3:&lt;NSThread: 0x600003a10500&gt;{number = 1, name = main} å¯ä»¥çœ‹åˆ°ï¼š æ²¡æœ‰é€ æˆå µå¡ï¼Œæ²¡æœ‰å¼€å¯æ–°çš„çº¿ç¨‹ï¼Œä¸²å‹çš„æ‰§è¡Œä»»åŠ¡ å¼‚æ­¥å‡½æ•° + è‡ªå®šä¹‰ä¸²å‹é˜Ÿåˆ—ï¼š 1234567891011121314151617- (void)viewDidLoad { [super viewDidLoad]; NSLog(@&quot;ä»»åŠ¡1:%@&quot;,[NSThread currentThread]); dispatch_queue_t queue = dispatch_queue_create(&quot;aa&quot;, DISPATCH_QUEUE_SERIAL); dispatch_async(queue, ^{ sleep(3); NSLog(@&quot;ä»»åŠ¡2:%@&quot;,[NSThread currentThread]); }); dispatch_async(queue, ^{ NSLog(@&quot;ä»»åŠ¡3:%@&quot;,[NSThread currentThread]); }); NSLog(@&quot;ä»»åŠ¡4:%@&quot;,[NSThread currentThread]);} è¿è¡Œç»“æœï¼š 1234ä»»åŠ¡1:&lt;NSThread: 0x600000a7c500&gt;{number = 1, name = main}ä»»åŠ¡4:&lt;NSThread: 0x600000a7c500&gt;{number = 1, name = main}ä»»åŠ¡2:&lt;NSThread: 0x600000a0b700&gt;{number = 5, name = (null)}ä»»åŠ¡3:&lt;NSThread: 0x600000a0b700&gt;{number = 5, name = (null)} å¯ä»¥çœ‹åˆ°ï¼š æ²¡æœ‰é€ æˆå µå¡ï¼Œå¼€å¯æ–°çº¿ç¨‹ï¼Œä¸²å‹æ‰§è¡Œä»»åŠ¡ã€‚ åŒæ­¥ +ï¼ˆå…¨å±€é˜Ÿåˆ— / è‡ªå®šä¹‰å¹¶å‘é˜Ÿåˆ—ï¼‰12345678910111213141516- (void)viewDidLoad { [super viewDidLoad]; dispatch_queue_t queue = dispatch_get_global_queue(0, 0); dispatch_sync(queue, ^{ for (int i = 0; i&lt;3; i++) { NSLog(@&quot;ä»»åŠ¡ä¸€ï¼š%@&quot;,[NSThread currentThread]); } }); dispatch_sync(queue, ^{ for (int i = 0; i&lt;3; i++) { NSLog(@&quot;ä»»åŠ¡äºŒï¼š%@&quot;,[NSThread currentThread]); } });} è¿è¡Œç»“æœï¼š æˆ‘ä»¬åœ¨å…¨å±€é˜Ÿåˆ—ä¸­åŒæ­¥æ‰§è¡Œä»»åŠ¡1å’Œä»»åŠ¡2ï¼Œé€šè¿‡æ‰“å°å¯ä»¥çœ‹å‡ºï¼ŒåŒæ­¥æ‰§è¡Œæ˜¯æŒ‰é¡ºåºæ‰§è¡Œä»»åŠ¡ï¼Œæ‰§è¡Œå®Œä»»åŠ¡1å†æ‰§è¡Œä»»åŠ¡2ã€‚å¹¶ä¸”æ‰“å°å½“å‰çº¿ç¨‹ï¼ŒåŒæ­¥æ‰§è¡Œæ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œæ²¡æœ‰å¼€å¯æ–°çº¿ç¨‹ã€‚ä¸”ç”±äºé˜Ÿåˆ—æ˜¯å¹¶å‘çš„ï¼Œå¹¶ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚ å¼‚æ­¥ +ï¼ˆå…¨å±€é˜Ÿåˆ— / è‡ªå®šä¹‰å¹¶å‘é˜Ÿåˆ—ï¼‰12345678910111213141516- (void)viewDidLoad { [super viewDidLoad]; dispatch_queue_t queue = dispatch_get_global_queue(0, 0); dispatch_async(queue, ^{ for (int i = 0; i&lt;3; i++) { NSLog(@&quot;ä»»åŠ¡ä¸€ï¼š%@&quot;,[NSThread currentThread]); } }); dispatch_async(queue, ^{ for (int i = 0; i&lt;3; i++) { NSLog(@&quot;ä»»åŠ¡äºŒï¼š%@&quot;,[NSThread currentThread]); } });} è¿è¡Œç»“æœï¼š å¯ä»¥çœ‹å‡ºä»»åŠ¡1å’Œä»»åŠ¡2äº¤é”™æ‰§è¡Œï¼Œå¹¶éåŒæ­¥æ‰§è¡Œé‚£æ ·æ‰§è¡Œå®Œä»»åŠ¡1å†æ‰§è¡Œä»»åŠ¡2ã€‚è€Œä¸”é€šè¿‡çº¿ç¨‹ç¼–å·å¯ä»¥çœ‹å‡ºï¼Œçš„ç¡®å¼€å¯äº†æ–°çš„çº¿ç¨‹ã€‚è¯´æ˜å¼‚æ­¥æ‰§è¡Œå…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ã€‚ 2.2 éå¸¸è§„ä½¿ç”¨ï¼Œå‘ç‚¹åŒä¸€ä¸²è¡Œé˜Ÿåˆ—åµŒå¥—12345678910111213141516171819- (void)viewDidLoad { [super viewDidLoad]; NSLog(@&quot;ä»»åŠ¡1&quot;); // è‡ªå®šä¹‰ä¸²å‹é˜Ÿåˆ— dispatch_queue_t queue = dispatch_queue_create(&quot;myQueue&quot;, DISPATCH_QUEUE_SERIAL); dispatch_async(queue, ^{ NSLog(@&quot;ä»»åŠ¡2&quot;); dispatch_sync(queue, ^{ NSLog(@&quot;ä»»åŠ¡3&quot;); }); NSLog(@&quot;ä»»åŠ¡4&quot;); }); NSLog(@&quot;ä»»åŠ¡5&quot;);} è¿è¡Œç»“æœ 1ä»»åŠ¡1ï¼Œä»»åŠ¡5ï¼Œä»»åŠ¡2ï¼Œç„¶åç¨‹åºå´©æºƒ è¿™é‡Œé€ æˆæ­»é”å´©æºƒçš„åŸå› å’Œä¸Šé¢åŒæ­¥+ä¸²è¡Œé˜Ÿåˆ—çš„åŸå› ä¸€æ ·ã€‚ ä¸åŒä¸²è¡Œé˜Ÿåˆ—åµŒå¥—1234567891011121314151617181920- (void)viewDidLoad { [super viewDidLoad]; NSLog(@&quot;ä»»åŠ¡1&quot;); dispatch_queue_t queue = dispatch_queue_create(&quot;myQueue&quot;, DISPATCH_QUEUE_SERIAL); dispatch_queue_t queue2 = dispatch_queue_create(&quot;myQueue2&quot;, DISPATCH_QUEUE_SERIAL); dispatch_async(queue, ^{ NSLog(@&quot;ä»»åŠ¡2&quot;); dispatch_sync(queue2, ^{ NSLog(@&quot;ä»»åŠ¡3&quot;); }); NSLog(@&quot;ä»»åŠ¡4&quot;); }); NSLog(@&quot;ä»»åŠ¡5&quot;);} è¿è¡Œç»“æœ 1ä»»åŠ¡1ï¼Œä»»åŠ¡5ï¼Œä»»åŠ¡2ï¼Œä»»åŠ¡3ï¼Œä»»åŠ¡4 é€šè¿‡è¿è¡Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå½“åµŒå¥—æ‰§è¡Œæ—¶ï¼ŒåŒæ­¥å¼‚æ­¥åœ¨ä¸åŒçš„ä¸²è¡Œé˜Ÿåˆ—æ‰§è¡Œï¼Œå¹¶ä¸ä¼šé€ æˆæ­»é”å´©æºƒã€‚è€Œæ˜¯æŒ‰ç…§ä¸²è¡Œçš„é¡ºåºï¼Œæ‰§è¡Œä»£ç ã€‚è¿™äº‹å› ä¸ºdispatch_syncé˜»å¡çš„å¹¶ä¸æ˜¯å½“å‰çš„çº¿ç¨‹ï¼Œè€Œæ˜¯å…¶ä»–çš„çº¿ç¨‹ï¼Œæ‰€ä»¥ä¸ä¼šé€ æˆæ­»é”ç­‰å¾…ã€‚ åŒä¸€å¹¶å‘é˜Ÿåˆ—åµŒå¥—1234567891011121314151617181920- (void)viewDidLoad { [super viewDidLoad]; NSLog(@&quot;ä»»åŠ¡1&quot;); // è‡ªå®šä¹‰å¹¶å‘é˜Ÿåˆ— dispatch_queue_t queue = dispatch_queue_create(&quot;myQueue&quot;, DISPATCH_QUEUE_CONCURRENT); dispatch_async(queue, ^{ NSLog(@&quot;ä»»åŠ¡2&quot;); dispatch_sync(queue, ^{ NSLog(@&quot;ä»»åŠ¡3&quot;); }); NSLog(@&quot;ä»»åŠ¡4&quot;); }); NSLog(@&quot;ä»»åŠ¡5&quot;);} è¿è¡Œç»“æœï¼š 1ä»»åŠ¡1ï¼Œä»»åŠ¡5ï¼Œä»»åŠ¡2ï¼Œä»»åŠ¡3ï¼Œä»»åŠ¡4 ä¸åŒå¹¶å‘é˜Ÿåˆ—åµŒå¥—1234567891011121314151617181920- (void)viewDidLoad { [super viewDidLoad]; NSLog(@&quot;ä»»åŠ¡1&quot;); dispatch_queue_t queue = dispatch_queue_create(&quot;myQueue&quot;, DISPATCH_QUEUE_SERIAL); dispatch_queue_t queue2 = dispatch_queue_create(&quot;myQueue2&quot;, DISPATCH_QUEUE_CONCURRENT); dispatch_async(queue, ^{ NSLog(@&quot;ä»»åŠ¡2&quot;); dispatch_sync(queue2, ^{ NSLog(@&quot;ä»»åŠ¡3&quot;); }); NSLog(@&quot;ä»»åŠ¡4&quot;); }); NSLog(@&quot;ä»»åŠ¡5&quot;);} è¿è¡Œç»“æœï¼š ä»»åŠ¡1ï¼Œä»»åŠ¡5ï¼Œä»»åŠ¡2ï¼Œä»»åŠ¡3ï¼Œä»»åŠ¡4 è¿™ä¸ªä»£ç çš„åˆ†æå’Œä¸åŒä¸²è¡Œé˜Ÿåˆ—åµŒå¥—çš„ç±»ä¼¼ï¼Œåˆ›å»ºäº†æ–°çš„é˜Ÿåˆ—ï¼Œæ‰€ä»¥æ˜¯ä¸ä¼šé€ æˆå½“å‰é˜Ÿåˆ—çš„é˜»å¡çš„ã€‚ ä¸‰ã€æ€»ç»“ åŒæ­¥å‡½æ•°æ²¡æœ‰å¼€è¾Ÿçº¿ç¨‹èƒ½åŠ›ï¼Œä¸”ä»£ç é¡ºåºæ‰§è¡Œï¼Œä¼šäº§ç”Ÿå µå¡ åŒæ­¥æ‰§è¡Œåœ¨åŒä¸€ä¸²è¡Œé˜Ÿåˆ—æ—¶ï¼Œä¼šé€ æˆæ­»é”ç­‰å¾… å¼‚æ­¥å‡½æ•°å…·æœ‰å¼€è¾Ÿæ–°çº¿ç¨‹çš„èƒ½åŠ›ï¼Œåœ¨å¹¶å‘é˜Ÿåˆ—æ‰§è¡Œæ—¶ï¼Œæ‰§è¡Œé¡ºåºä¸ç¡®å®šï¼Œåœ¨ä¸²è¡Œé˜Ÿåˆ—æ‰§è¡Œæ—¶ï¼ŒæŒ‰ç…§é¡ºåºæ‰§è¡Œï¼Œä¸”ä¸»é˜Ÿåˆ—æ—¶ä¸ä¼šå¼€è¾Ÿæ–°çº¿ç¨‹ å‚è€ƒè‹¹æœå¤šçº¿ç¨‹å¼€æºä»£ç  [iOSåº•å±‚åŸç†æ¢ç´¢â€”å¤šçº¿ç¨‹çš„æœ¬è´¨](","link":"/2021/05/18/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/16-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BGCD%E5%88%9D%E6%8E%A2/"},{"title":"ã€Šè´¢åŠ¡è‡ªç”±ä¹‹è·¯ã€‹è¯»ä¹¦ç¬”è®°","text":"","link":"/2021/05/15/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E3%80%8A%E8%B4%A2%E5%8A%A1%E8%87%AA%E7%94%B1%E4%B9%8B%E8%B7%AF%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"},{"title":"17-å¤šçº¿ç¨‹ä¹‹GCDåº”ç”¨","text":"ä¸€ã€å‰è¨€GCDé™¤äº†åŸºæœ¬çš„dispatch_syncå’Œdispatch_asyncç”¨æ³•å¤–ï¼Œè¿˜æœ‰ä¿¡å·é‡ï¼Œè°ƒåº¦ç»„ï¼Œå»¶æ—¶æ‰§è¡Œç­‰ç­‰ã€‚ äºŒã€ä¿¡å·é‡ dispatch_semaphore2.1 å¼•è¨€çœ‹ä¸‹é¢˜ï¼Œé—®ï¼šå¤–é¢ a çš„å€¼ä¸ºå¤šå°‘ï¼Ÿé‡Œé¢ a çš„å€¼åˆä¸ºå¤šå°‘ï¼Ÿ 123456789101112- (void)viewDidLoad { [super viewDidLoad]; __block int a = 0; while (a &lt; 5) { dispatch_async(dispatch_get_global_queue(0, 0), ^{ NSLog(@&quot;é‡Œé¢açš„å€¼ï¼š%d -- %@&quot;, a, [NSThread currentThread]); a++; }); } NSLog(@&quot;å¤–é¢açš„å€¼ï¼š%d&quot;, a);} åˆ†æï¼š ä¸»é˜Ÿåˆ—ä¸­æœ‰whileä»»åŠ¡å’ŒNSLogä»»åŠ¡ï¼Œä¸²å‹æ‰§è¡Œï¼Œæ‰€ä»¥ä¸€å®šæ˜¯æ‰§è¡Œå®Œwhileä¹‹åå†æ‰§è¡ŒNSLogï¼Œæ‰€ä»¥å¤–é¢æ‰“å°çš„ a çš„å€¼ä¸€å®šæ˜¯5ã€‚ ä½†æ˜¯æˆ‘ä»¬çŸ¥é“dispatch_asyncæ˜¯å¼‚æ­¥æ‰§è¡Œçš„å¹¶å‘é˜Ÿåˆ—ï¼Œæ‰€ä»¥ä¼šå¼€è¾Ÿå­çº¿ç¨‹è¿›è¡Œa++æ“ä½œï¼Œä¸”è¿™äº›çº¿ç¨‹æ“ä½œçš„éƒ½æ˜¯ a çš„åŒä¸€ç‰‡å†…å­˜ç©ºé—´ï¼Œä¹Ÿå°±è¡¨ç¤ºå½“ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ¯•åï¼Œæ­¤æ—¶åªåœ¨æ‰§è¡Œçš„çº¿ç¨‹ä¸Šçš„ a å€¼éƒ½ä¼šå˜åŒ–ï¼Œæ‰€ä»¥é‡Œé¢çš„ a ä¸€å®šæ˜¯å¤§äº5çš„ã€‚ æ‰“å°éªŒè¯ï¼š 123456789101112131415161718192021-05-12 14:58:14.253962+0800 Test03[10963:187541] é‡Œé¢açš„å€¼ï¼š0 -- &lt;NSThread: 0x600002380f80&gt;{number = 3, name = (null)}2021-05-12 14:58:14.253989+0800 Test03[10963:187540] é‡Œé¢açš„å€¼ï¼š0 -- &lt;NSThread: 0x6000023be2c0&gt;{number = 4, name = (null)}2021-05-12 14:58:14.253996+0800 Test03[10963:187516] é‡Œé¢açš„å€¼ï¼š0 -- &lt;NSThread: 0x600002380f40&gt;{number = 5, name = (null)}2021-05-12 14:58:14.254001+0800 Test03[10963:187541] é‡Œé¢açš„å€¼ï¼š1 -- &lt;NSThread: 0x600002380f80&gt;{number = 3, name = (null)}2021-05-12 14:58:14.254020+0800 Test03[10963:187540] é‡Œé¢açš„å€¼ï¼š2 -- &lt;NSThread: 0x6000023be2c0&gt;{number = 4, name = (null)}2021-05-12 14:58:14.254049+0800 Test03[10963:187541] é‡Œé¢açš„å€¼ï¼š5 -- &lt;NSThread: 0x600002380f80&gt;{number = 3, name = (null)}2021-05-12 14:58:14.254050+0800 Test03[10963:187084] å¤–é¢açš„å€¼ï¼š52021-05-12 14:58:14.254055+0800 Test03[10963:187560] é‡Œé¢açš„å€¼ï¼š5 -- &lt;NSThread: 0x600002381600&gt;{number = 6, name = (null)}2021-05-12 14:58:14.254074+0800 Test03[10963:187541] é‡Œé¢açš„å€¼ï¼š6 -- &lt;NSThread: 0x600002380f80&gt;{number = 3, name = (null)}2021-05-12 14:58:14.254073+0800 Test03[10963:187561] é‡Œé¢açš„å€¼ï¼š5 -- &lt;NSThread: 0x6000023a19c0&gt;{number = 7, name = (null)}2021-05-12 14:58:14.254080+0800 Test03[10963:187516] é‡Œé¢açš„å€¼ï¼š6 -- &lt;NSThread: 0x600002380f40&gt;{number = 5, name = (null)}2021-05-12 14:58:14.254095+0800 Test03[10963:187517] é‡Œé¢açš„å€¼ï¼š6 -- &lt;NSThread: 0x6000023dc000&gt;{number = 8, name = (null)}2021-05-12 14:58:14.254110+0800 Test03[10963:187540] é‡Œé¢açš„å€¼ï¼š6 -- &lt;NSThread: 0x6000023be2c0&gt;{number = 4, name = (null)}2021-05-12 14:58:14.254166+0800 Test03[10963:187563] é‡Œ\\3512021-05-12 14:58:14.254258+0800 Test03[10963:187567] é‡Œé¢açš„å€¼ï¼š8 -- &lt;NSThread: 0x6000023a2280&gt;{number = 14, name = (null)}... 2021-05-12 14:58:14.260581+0800 Test03[10963:187578] é‡Œé¢açš„å€¼ï¼š55 -- &lt;NSThread: 0x6000023a3240&gt;{number = 25, name = (null)}2021-05-12 14:58:14.391239+0800 Test03[10963:187084] [Lifecycle] Scene state change error: the scene is no longer connected. (NSMenuBarScene_0BD7D9C8-B162-41DB-AB90-B4B866250478) è¿™æ ·çš„å†™æ³•å¿…ç„¶æ˜¯æµªè´¹çº¿ç¨‹èµ„æºçš„ï¼Œéå¸¸ä¸åˆç†ï¼Œé€šå¸¸æˆ‘ä»¬è¿›è¡ŒI/Oæ“ä½œæ—¶ï¼Œéƒ½æ˜¯éœ€è¦åŠ é”æ¥ä¿è¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè¿™æ ·æ•°æ®æ‰ä¸ä¼šå‡ºé”™ã€‚ è¿™é‡Œå¯ä»¥é‡‡ç”¨ä¿¡å·é‡è¿›è¡Œå¤„ç†ã€‚ 2.2 ç”¨é€”ä¿¡å·é‡æ˜¯ç”¨äºå¤šçº¿ç¨‹åŒæ­¥çš„ï¼Œè·Ÿä¸€èˆ¬çš„é”ä¸ä¸€æ ·çš„æ˜¯ï¼Œä¿¡å·é‡ä¸æ˜¯é”å®šæŸä¸€ä¸ªèµ„æºï¼Œè€Œæ˜¯é”å®šæµç¨‹ã€‚æ¯”å¦‚ï¼šæœ‰ Aï¼ŒB ä¸¤ä¸ªçº¿ç¨‹ï¼ŒB çº¿ç¨‹è¦ç­‰ A çº¿ç¨‹å®ŒæˆæŸä¸€ä»»åŠ¡ä»¥åå†è¿›è¡Œè‡ªå·±ä¸‹é¢çš„æ­¥éª¤ï¼Œè¿™å°±æ˜¯é”å®šæµç¨‹ã€‚ é”å®šèµ„æºæŒ‡çš„æ˜¯è¢«é”ä½çš„èµ„æºæ— æ³•è¢«å…¶ä½™çš„çº¿ç¨‹è®¿é—®ï¼Œä»è€Œå®ç°çº¿ç¨‹å®‰å…¨ã€‚ 2.3 ç›¸å…³API1dispatch_semaphore_create(M) åˆ›å»ºä¸€ä¸ªå€¼ä¸º M çš„ä¿¡å·é‡ï¼Œå¦‚æœç”¨äºåŠ é”ï¼Œæ­¤æ—¶ M= 0ã€‚ 1dispatch_semaphore_wait(ä¿¡å·é‡ï¼Œç­‰å¾…æ—¶é—´) å¦‚æœè¯¥ä¿¡å·é‡çš„å€¼å¤§äº0ï¼Œåˆ™ä½¿å…¶ä¿¡å·é‡çš„å€¼-1ï¼Œç„¶åç»§ç»­æ‰§è¡Œåé¢çš„ä»£ç ã€‚ å¦‚æœå°äºç­‰äº0ï¼Œåˆ™é˜»å¡çº¿ç¨‹ç›´åˆ°è¯¥ä¿¡å·é‡çš„å€¼å¤§äº0æˆ–è€…è¾¾åˆ°ç­‰å¾…æ—¶é—´ã€‚ 1dispatch_semaphore_signal(ä¿¡å·é‡) é‡Šæ”¾ä¿¡å·é‡ï¼Œä½¿å¾—è¯¥ä¿¡å·é‡çš„å€¼åŠ 1ã€‚ 2.4 ä½¿ç”¨åœºæ™¯2.4.1 é™åˆ¶çº¿ç¨‹çš„æœ€å¤§å¹¶å‘æ•°12345678dispatch_semaphore_t sema = dispatch_semaphore_create(M);for (NSInteger i = 0;i&lt;N;i++ï¼‰ { dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{ dispatch_semaphore_wait(sema, DISPATCH_TIME_FOREVER); // è€—æ—¶æ“ä½œ dispatch_semaphore_signal(sema); });} å¦‚ä¸Šè¿°ä»£ç å¯çŸ¥ï¼Œæ€»å…±å¼‚æ­¥æ‰§è¡ŒNä¸ªä»»åŠ¡ï¼Œä½†æ˜¯ç”±äºæˆ‘ä»¬è®¾ç½®äº†å€¼ä¸º M çš„ä¿¡å·é‡ï¼Œæ¯ä¸€æ¬¡æ‰§è¡Œä»»åŠ¡çš„æ—¶å€™éƒ½ä¼šå¯¼è‡´ä¿¡å·é‡çš„å‡1ï¼Œè€Œåœ¨ä»»åŠ¡ç»“æŸåä½¿ä¿¡å·é‡åŠ 1ï¼Œå½“ä¿¡å·é‡å‡åˆ°0çš„æ—¶å€™ï¼Œè¯´æ˜æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡æœ‰ M ä¸ªï¼Œè¿™ä¸ªæ—¶å€™å…¶å®ƒä»»åŠ¡å°±ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰ä»»åŠ¡è¢«å®Œæˆæ—¶ï¼Œè¿™äº›ä»»åŠ¡æ‰ä¼šæ‰§è¡Œã€‚ 2.4.2 é˜»å¡å‘è¯·æ±‚çš„çº¿ç¨‹æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦==é˜»å¡==å‘é€è¯·æ±‚çš„çº¿ç¨‹ï¼Œæ¯”å¦‚åœ¨å¤šä¸ªè¯·æ±‚å›è°ƒåç»Ÿä¸€æ“ä½œçš„éœ€æ±‚ï¼Œè€Œè¿™äº›è¯·æ±‚ä¹‹é—´å¹¶æ²¡æœ‰é¡ºåºå…³ç³»ï¼Œä¸”è¿™äº›æ¥å£éƒ½ä¼šå¦å¼€çº¿ç¨‹è¿›è¡Œç½‘ç»œè¯·æ±‚çš„ã€‚ä¸€èˆ¬åœ°ï¼Œè¿™ç§å¤šçº¿ç¨‹å®Œæˆåè¿›è¡Œç»Ÿä¸€æ“ä½œçš„éœ€æ±‚éƒ½ä¼šä½¿ç”¨é˜Ÿåˆ—ç»„(dispatch_group_t)æ¥å®Œæˆï¼Œä½†æ˜¯ç”±äºæ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œæ²¡ç­‰å…¶å¼‚æ­¥å›è°ƒä¹‹åï¼Œè¯·æ±‚çš„çº¿ç¨‹å°±ç»“æŸäº†ï¼Œä¸ºæ­¤ï¼Œå°±éœ€è¦ä½¿ç”¨ä¿¡å·é‡æ¥é˜»å¡ä½å‘è¯·æ±‚çš„çº¿ç¨‹ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š 12345678dispatch_async(queue, 0), ^{ dispatch_semaphore_t sema = dispatch_semaphore_create(0); [ç½‘ç»œè¯·æ±‚:^{ //è¯·æ±‚å›è°ƒ dispatch_semaphore_signal(sema); }]; dispatch_semaphore_wait(sema, DISPATCH_TIME_FOREVER);}); è¿™æ ·ï¼Œè¯·æ±‚çš„çº¿ç¨‹å°±å¯ä»¥ç­‰åˆ°å›è°ƒç»“æŸåå†ç»“æŸäº†ï¼Œå†é…åˆé˜Ÿåˆ—ç»„å°±èƒ½å®Œæˆä¸Šè¿°çš„éœ€æ±‚ã€‚è¿™ç§æŠ€å·§å¯ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š å¤šä¸ªè¯·æ±‚ç»“æŸåç»Ÿä¸€æ“ä½œ å¤šä¸ªè¯·æ±‚é¡ºåºæ‰§è¡Œ 2.5 å¯¹äºå¼•è¨€ä¸­ä¾‹å­çš„å¤„ç†äº†è§£äº†ä¿¡å·é‡å¦‚ä½•ä½¿ç”¨åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹å¼•è¨€ä¸­çš„ä¾‹å­è¿›è¡Œä¸‹é¢çš„å¤„ç†ï¼š 123456789101112131415161718- (void)viewDidLoad { [super viewDidLoad]; dispatch_semaphore_t sem = dispatch_semaphore_create(0); __block int a = 0; while (a &lt; 5) { dispatch_async(dispatch_get_global_queue(0, 0), ^{ NSLog(@&quot;é‡Œé¢açš„å€¼ï¼š%d -- %@&quot;, a, [NSThread currentThread]); a++; // ä»»åŠ¡æ‰§è¡Œå®Œäº†æ‰+1 dispatch_semaphore_signal(sem); }); // é”ä½ dispatch_semaphore_wait(sem, DISPATCH_TIME_FOREVER); } NSLog(@&quot;å¤–é¢açš„å€¼ï¼š%d&quot;, a);} ä½¿ç”¨çš„æ˜¯é˜»å¡å½“å‰çº¿ç¨‹çš„æ–¹å¼ï¼Œå¦‚æœä»»åŠ¡ä¸æ‰§è¡Œå®Œï¼Œå°±ä¸ä¼šæ‰§è¡Œä¸‹æ¬¡çš„å¾ªç¯ï¼Œä»è€Œè¾¾åˆ°äº†a++è·Ÿéšwhileå¾ªç¯æ‰§è¡Œ5æ¬¡çš„æ•ˆæœã€‚ æ‰“å°éªŒè¯ï¼š 1234562021-05-12 15:40:26.677802+0800 Test03[11206:214126] é‡Œé¢açš„å€¼ï¼š0 -- &lt;NSThread: 0x60000368a780&gt;{number = 5, name = (null)}2021-05-12 15:40:26.677857+0800 Test03[11206:214126] é‡Œé¢açš„å€¼ï¼š1 -- &lt;NSThread: 0x60000368a780&gt;{number = 5, name = (null)}2021-05-12 15:40:26.677898+0800 Test03[11206:214126] é‡Œé¢açš„å€¼ï¼š2 -- &lt;NSThread: 0x60000368a780&gt;{number = 5, name = (null)}2021-05-12 15:40:26.677938+0800 Test03[11206:214126] é‡Œé¢açš„å€¼ï¼š3 -- &lt;NSThread: 0x60000368a780&gt;{number = 5, name = (null)}2021-05-12 15:40:26.677970+0800 Test03[11206:214126] é‡Œé¢açš„å€¼ï¼š4 -- &lt;NSThread: 0x60000368a780&gt;{number = 5, name = (null)}2021-05-12 15:40:26.677994+0800 Test03[11206:213710] å¤–é¢açš„å€¼ï¼š5 ä¸‰ã€æ …æ å‡½æ•°dispatch_barrier3.1 ç”¨é€”ä½¿ç”¨æ …æ å‡½æ•°å¯ä»¥è®©ä¸¤ç»„å¼‚æ­¥ä»»åŠ¡æœ‰å…ˆåé¡ºåºçš„æ‰§è¡Œã€‚ 3.2 ç›¸å…³API1dispatch_barrier_async ä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ 1dispatch_barrier_sync ä¼šé˜»å¡å½“å‰çº¿ç¨‹ ç®€å•æ¥è¯´dispatch_barrier_asyncæˆ–dispatch_barrier_syncå°†å¼‚æ­¥ä»»åŠ¡åˆ†æˆäº†ä¸¤ç»„ï¼Œæ‰§è¡Œå®Œç¬¬ä¸€ç»„åï¼Œå†æ‰§è¡Œè‡ªå·±ï¼Œç„¶åæ‰§è¡Œé˜Ÿåˆ—ä¸­å‰©ä½™çš„ä»»åŠ¡ã€‚ ç¤ºæ„å›¾ï¼š 3.3 ä½¿ç”¨åœºæ™¯é€šè¿‡ä¾‹å­æ¥çœ‹ä¸€ä¸‹æ …æ å‡½æ•°çš„ä½¿ç”¨ã€‚ 123456789101112131415161718dispatch_queue_t concurrentQueue = dispatch_queue_create(&quot;com.imo.barrier1&quot;, DISPATCH_QUEUE_CONCURRENT);NSLog(@&quot;å¼€å§‹&quot;);dispatch_async(concurrentQueue, ^{ NSLog(@&quot;ä»»åŠ¡1-%@&quot;,[NSThread currentThread]);});// æ …æ dispatch_barrier_async(concurrentQueue, ^{ NSLog(@&quot;--------------æ …æ ---------------&quot;);});NSLog(@&quot;ä¸­æ­¢&quot;);dispatch_async(concurrentQueue, ^{ NSLog(@&quot;ä»»åŠ¡2-%@&quot;,[NSThread currentThread]);});NSLog(@&quot;ç»“æŸ&quot;); æ‰“å°ç»“æœï¼š 123456å¼€å§‹ä¸­æ­¢ç»“æŸä»»åŠ¡1-&lt;NSThread: 0x6000022d0a00&gt;{number = 4, name = (null)}--------------æ …æ ---------------ä»»åŠ¡2-&lt;NSThread: 0x6000022d0a00&gt;{number = 4, name = (null)} å¦‚æœå°†ä¾‹å­ä¸­çš„dispatch_barrier_asyncæ¢æˆdispatch_barrier_syncã€‚é€šè¿‡ä¸‹é¢çš„æ‰“å°ç»“æœè¿‡å¯ä»¥çœ‹å‡ºï¼Œdispatch_barrier_syncä¸ä»…é˜»å¡äº†ä»»åŠ¡çš„æ‰§è¡Œï¼Œä¹Ÿé˜»å¡äº†çº¿ç¨‹ã€‚æ•´ä¸ªä»»åŠ¡éƒ½æŒ‰ç…§é¡ºåºæ¥æ‰§è¡Œäº†ï¼ˆé˜»å¡ä¸»çº¿ç¨‹çš„æ“ä½œè¿˜æ˜¯è¦å°½é‡é¿å…ï¼‰ã€‚ 123456å¼€å§‹ä»»åŠ¡1-&lt;NSThread: 0x600001e96d00&gt;{number = 5, name = (null)}--------------æ …æ ---------------ä¸­æ­¢ç»“æŸä»»åŠ¡2-&lt;NSThread: 0x600001e96d00&gt;{number = 5, name = (null)} æ³¨æ„äº‹é¡¹âš ï¸ï¼š æ …æ å‡½æ•°æœ€ç›´æ¥çš„ä½œç”¨: æ§åˆ¶ä»»åŠ¡æ‰§è¡Œé¡ºåºï¼ŒåŒæ­¥ dispatch_barrier_async å‰é¢çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•æ‰ä¼šæ¥åˆ°è¿™é‡Œ dispatch_barrier_sync ä½œç”¨ç›¸åŒï¼Œä½†æ˜¯è¿™ä¸ªä¼šå µå¡çº¿ç¨‹ï¼Œå½±å“åé¢ä»»åŠ¡çš„æ‰§è¡Œ æ …æ å‡½æ•°åªèƒ½æ§åˆ¶åŒä¸€å¹¶å‘é˜Ÿåˆ— å››ã€è°ƒåº¦ç»„/é˜Ÿåˆ—ç»„dispatch_group4.1 ç”¨é€”ä¹Ÿæ˜¯ä¸ºäº†è§£å†³å¤šçº¿ç¨‹ä¸­å¤šä¸ªå¼‚æ­¥ä»»åŠ¡é¡ºåºæ‰§è¡Œçš„é—®é¢˜ã€‚ 4.2 ç›¸å…³API1dispatch_group_create ç”¨æ¥åˆ›å»ºä¸€ä¸ªè°ƒåº¦ç»„ 1dispatch_group_async å…ˆæŠŠä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œç„¶åå°†é˜Ÿåˆ—æ”¾åˆ°è°ƒåº¦ç»„ä¸­ 1dispatch_group_enter 1dispatch_group_leave è¿›ç»„å’Œå‡ºç»„ï¼Œå¿…é¡»æˆå¯¹ä½¿ç”¨ï¼Œå’Œdispatch_group_asyncä½œç”¨ç›¸åŒ 1dispatch_group_wait è¿›ç»„ä»»åŠ¡æ‰§è¡Œç­‰å¾… 1dispatch_group_notify æ‰§è¡Œè°ƒåº¦ç»„ç»“æŸåæ¥ä¸‹æ¥çš„ä»»åŠ¡ 4.3 å¸¸è§ç”¨æ³•4.3.1 ä½¿ç”¨ dispatch_group_asyncã€æ¨èã€‘åœ¨æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œè°ƒç”¨dispatch_group_notifyæ–¹æ³•é€šçŸ¥åˆ°æˆ‘ä»¬ã€‚ä¸€èˆ¬åœ¨æ­¤æ–¹æ³•ä¸­è·å–åˆ°dispatch_get_main_queueä¸»çº¿ç¨‹ï¼Œç”¨æ¥åˆ·æ–°UIç­‰æ“ä½œã€‚å…·ä½“ä½¿ç”¨çš„ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920 //åˆ›å»ºè°ƒåº¦ç»„ dispatch_group_t group = dispatch_group_create();// å…¨å±€å¹¶å‘é˜Ÿåˆ— dispatch_queue_t queue = dispatch_get_global_queue(0, 0);// è‡ªå·±åˆ›å»ºçš„å¹¶å‘é˜Ÿåˆ— dispatch_queue_t queue1 = dispatch_queue_create(&quot;com.imo.group&quot;, DISPATCH_QUEUE_CONCURRENT); dispatch_group_async(group, queue, ^{ NSLog(@&quot;ä»»åŠ¡ä¸€&quot;); }); dispatch_group_async(group, queue1, ^{ sleep(2); NSLog(@&quot;ä»»åŠ¡äºŒ&quot;); }); dispatch_group_notify(group, dispatch_get_main_queue(), ^{ NSLog(@&quot;ä»»åŠ¡æ‰§è¡Œå®Œæˆ&quot;); }); æ‰“å°ç»“æœï¼š 123ä»»åŠ¡ä¸€ä»»åŠ¡äºŒä»»åŠ¡æ‰§è¡Œå®Œæˆ 4.3.2 ä½¿ç”¨è¿›ç»„å‡ºç»„ä½¿ç”¨è¿›å‡ºç»„çš„æ–¹å¼å’Œdispatch_group_asyncæ•ˆæœç›¸åŒï¼Œåªä¸è¿‡æ˜¯æœ‰äº†è¿›å‡ºç»„çš„ä»£ç ï¼Œé€»è¾‘æ›´åŠ æ¸…æ™°æ˜äº†ï¼Œä½†æ˜¯å†™æ³•è¾ƒéº»çƒ¦ï¼Œæ¨èä½¿ç”¨ä¸Šä¸€ç§æ–¹å¼ã€‚ dispatch_group_enterå’Œdispatch_group_leaveæ˜¯æˆå¯¹ä½¿ç”¨çš„ï¼Œå¿…é¡»å…ˆè¿›ç»„å†å‡ºç»„ï¼Œç¼ºä¸€ä¸å¯ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚ 123456789101112131415161718192021 // å…¨å±€å¹¶å‘é˜Ÿåˆ—dispatch_queue_t queue = dispatch_get_global_queue(0, 0); // é˜Ÿåˆ—ç»„ dispatch_group_t group = dispatch_group_create(); dispatch_group_enter(group); dispatch_async(queue, ^{ sleep(2); NSLog(@&quot;ä»»åŠ¡ä¸€&quot;); dispatch_group_leave(group); }); dispatch_group_enter(group); dispatch_async(queue, ^{ NSLog(@&quot;ä»»åŠ¡äºŒ&quot;); dispatch_group_leave(group); }); dispatch_group_notify(group, dispatch_get_main_queue(), ^{ NSLog(@&quot;æ‰€æœ‰ä»»åŠ¡å®Œæˆ,å¯ä»¥æ›´æ–°UI&quot;); }); æ‰“å°ç»“æœï¼š 123ä»»åŠ¡äºŒä»»åŠ¡ä¸€æ‰€æœ‰ä»»åŠ¡å®Œæˆ,å¯ä»¥æ›´æ–°UI 4.3.3 ä½¿ç”¨ dispatch_group_waitå¯ä»¥ç†è§£ä¸ºä¸€ç§æ …æ ã€‚ 1dispatch_group_wait(è°ƒåº¦ç»„, ç­‰å¾…æ—¶é—´) ç­‰å¾…æ—¶é—´ï¼š DISPATCH_TIME_FOREVERï¼šæ°¸ä¹…ç­‰å¾… DISPATCH_TIME_NOWï¼šä¸ç­‰å¾…ï¼Œç«‹åˆ»åˆ¤å®šDispatch Groupçš„å¤„ç†æ˜¯å¦å…¨éƒ¨æ‰§è¡Œç»“æŸ å‡½æ•°è¿”å›å€¼ï¼š è¿”å›å€¼ä¸º0ï¼Œå°±æ„å‘³ç€Dispatch Groupä¸­çš„æ“ä½œå…¨éƒ¨æ‰§è¡Œå®Œæ¯• è¿”å›å€¼ä¸ä¸º0ï¼Œå°±æ„å‘³ç€è™½ç„¶ç»è¿‡äº†æŒ‡å®šçš„æ—¶é—´ï¼Œä½†Dispatch Groupä¸­çš„æ“ä½œå¹¶æœªå…¨éƒ¨æ‰§è¡Œå®Œæ¯• ä¸¾ä¾‹ï¼š 1234567891011121314151617181920212223242526dispatch_queue_t queue = dispatch_get_global_queue(0, 0);dispatch_group_t group = dispatch_group_create();dispatch_group_enter(group);dispatch_async(queue, ^{ sleep(2); NSLog(@&quot;ä»»åŠ¡ä¸€&quot;); dispatch_group_leave(group);});long timeout = dispatch_group_wait(group, dispatch_time(DISPATCH_TIME_FOREVER, 0));if (timeout == 0) { NSLog(@&quot;å›æ¥äº†&quot;);}else{ NSLog(@&quot;ç­‰å¾…ä¸­&quot;);}dispatch_group_enter(group);dispatch_async(queue, ^{ NSLog(@&quot;ä»»åŠ¡äºŒ&quot;); dispatch_group_leave(group);});dispatch_group_notify(group, dispatch_get_main_queue(), ^{ NSLog(@&quot;æ‰€æœ‰ä»»åŠ¡å®Œæˆ,å¯ä»¥æ›´æ–°UI&quot;);}); æ‰“å°ç»“æœï¼š 1234ä»»åŠ¡ä¸€å›æ¥äº†ä»»åŠ¡äºŒæ‰€æœ‰ä»»åŠ¡å®Œæˆ,å¯ä»¥æ›´æ–°UI å¦‚æœæˆ‘ä»¬æŠŠè¶…æ—¶æ—¶é—´è®¾ç½®çš„çŸ­ä¸€ç‚¹ï¼Œæ¯”å¦‚1ç§’ï¼Œlong timeout = dispatch_group_wait(group, dispatch_time(DISPATCH_TIME_NOW,1 * NSEC_PER_SEC));å¯ä»¥å‘ç°æ‰“å°ç»“æœä¸åŒï¼Œå’Œæ²¡æœ‰è¿›è¡Œwaitæ—¶çš„æ‰“å°ç»“æœæ˜¯ç›¸åŒçš„ï¼š 1234ç­‰å¾…ä¸­ä»»åŠ¡äºŒä»»åŠ¡ä¸€æ‰€æœ‰ä»»åŠ¡å®Œæˆ,å¯ä»¥æ›´æ–°UI æ³¨æ„äº‹é¡¹âš ï¸ï¼š dispatch_group_enterå’Œdispatch_group_leaveæ˜¯æˆå¯¹ä½¿ç”¨çš„ï¼Œå¿…é¡»å…ˆè¿›ç»„å†å‡ºç»„ï¼Œç¼ºä¸€ä¸å¯ dispatch_group_waitå¯ä»¥è®¾ç½®ç­‰å¾…æ—¶é—´ï¼Œç”¨æ¥åŒºåˆ†å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œ dispatch_group_notifyä¸ºç»„ä»»åŠ¡å…¨éƒ¨å®Œæˆåæ‰§è¡Œçš„å›è°ƒï¼Œä¸€èˆ¬åœ¨å¤„ç†ä¸»çº¿ç¨‹é€»è¾‘ äº”ã€å»¶è¿Ÿå‡½æ•°dispatch_afteréœ€è¦æ³¨æ„çš„æ˜¯ï¼šdispatch_afteræ–¹æ³•å¹¶ä¸æ˜¯åœ¨æŒ‡å®šæ—¶é—´ä¹‹åæ‰å¼€å§‹æ‰§è¡Œå¤„ç†ï¼Œè€Œæ˜¯åœ¨æŒ‡å®šæ—¶é—´ä¹‹åå°†ä»»åŠ¡è¿½åŠ åˆ°ä¸»é˜Ÿåˆ—ä¸­ã€‚ ä¸¥æ ¼æ¥è¯´ï¼Œè¿™ä¸ªæ—¶é—´å¹¶ä¸æ˜¯ç»å¯¹å‡†ç¡®çš„ï¼Œä½†æƒ³è¦å¤§è‡´å»¶è¿Ÿæ‰§è¡Œä»»åŠ¡ï¼Œdispatch_after æ–¹æ³•è¿˜æ˜¯å¾ˆæ–¹ä¾¿çš„ã€‚ 123456-(void)afterTask{ NSLog(@&quot;å¼€å§‹&quot;); dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(3.0*NSEC_PER_SEC)), dispatch_get_main_queue(), ^{ NSLog(@&quot;æ‰§è¡Œ---%@&quot;,[NSThread currentThread]); });} å…­ã€å•æ¬¡å‡½æ•°dispatch_oncedispatch_onceæ–¹æ³•å¯ä»¥ä¿è¯ä¸€æ®µä»£ç åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­åªè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œè€Œä¸”åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚ 12345678+ (instancetype)shareInstance{ static JYManager *instance = nil; static dispatch_once_t onceToken; dispatch_once(&amp;onceToken, ^{ instance = [JYManager alloc] init]; }); return instance;} ä¸ƒã€äº‹ä»¶æºdispatch_source7.1 ç”¨é€”å¯ä»¥ç”¨æ¥ç›‘å¬ä¸€äº›åº•å±‚çš„ç³»ç»Ÿäº‹ä»¶ã€‚åœ¨æ—¥å¸¸çš„å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä½¿ç”¨å®ƒæ¥åˆ›å»ºä¸€ä¸ªåŸºäºGCDçš„Timerã€‚ä½†æ˜¯å®ƒè¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„ç›‘å¬ç±»å‹ï¼Œé€šè¿‡æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£æˆ‘ä»¬å¯å¾—ä»¥ä¸‹ç›‘å¬ï¼š Timer Dispatch Sourceï¼šå®šæ—¶è°ƒåº¦æºã€‚ Signal Dispatch Sourceï¼šç›‘å¬UNIXä¿¡å·è°ƒåº¦æºï¼Œæ¯”å¦‚ç›‘å¬ä»£è¡¨æŒ‚èµ·æŒ‡ä»¤çš„SIGSTOPä¿¡å·ã€‚ Descriptor Dispatch Sourceï¼šç›‘å¬æ–‡ä»¶ç›¸å…³æ“ä½œå’ŒSocketç›¸å…³æ“ä½œçš„è°ƒåº¦æºã€‚ Process Dispatch Sourceï¼šç›‘å¬è¿›ç¨‹ç›¸å…³çŠ¶æ€çš„è°ƒåº¦æºã€‚ Mach port Dispatch Sourceï¼šç›‘å¬Machç›¸å…³äº‹ä»¶çš„è°ƒåº¦æºã€‚ Custom Dispatch Sourceï¼šç›‘å¬è‡ªå®šä¹‰äº‹ä»¶çš„è°ƒåº¦æº 7.2 ç›¸å…³API dispatch_source_create: åˆ›å»ºäº‹ä»¶æº dispatch_source_set_event_handler: è®¾ç½®æ•°æ®æºå›è°ƒ dispatch_source_merge_data: è®¾ç½®äº‹ä»¶æºæ•°æ® dispatch_source_get_dataï¼šè·å–äº‹ä»¶æºæ•°æ® dispatch_resume: ç»§ç»­ dispatch_suspend: æŒ‚èµ· dispatch_cancle: å–æ¶ˆ 7.3 ä½¿ç”¨å¦‚ä½•ä½¿ç”¨ï¼š â‘ æŒ‡å®šä¸€ä¸ªå¸Œæœ›ç›‘å¬çš„ç³»ç»Ÿäº‹ä»¶ç±»å‹ â‘¡æŒ‡å®šä¸€ä¸ªæ•è·åˆ°äº‹ä»¶åè¿›è¡Œé€»è¾‘å¤„ç†çš„å›è°ƒå‡½æ•° â‘¢å†æŒ‡å®šä¸€ä¸ªè¯¥å›è°ƒå‡½æ•°æ‰§è¡Œçš„é˜Ÿåˆ—å³å¯ ç„¶åå½“ç›‘å¬åˆ°äº‹ä»¶åå°±ä¼šè§¦å‘æŒ‡å®šé˜Ÿåˆ—ä¸­çš„å›è°ƒã€‚ è¿™é‡Œä¸é€šå¸¸çš„æ‰‹åŠ¨æ·»åŠ ä»»åŠ¡çš„æ¨¡å¼ä¸åŒï¼Œä¸€æ—¦dispatch_sourceä¸é˜Ÿåˆ—å…³è”åï¼Œåªè¦ç›‘å¬åˆ°ç³»ç»Ÿäº‹ä»¶ï¼Œdispatch_sourceå°±ä¼šè‡ªåŠ¨å°†ä»»åŠ¡ï¼ˆå›è°ƒå‡½æ•°ï¼‰æ·»åŠ åˆ°å…³è”çš„é˜Ÿåˆ—ä¸­ï¼Œç›´åˆ°æˆ‘ä»¬è°ƒç”¨å‡½æ•°å–æ¶ˆç›‘å¬ã€‚ ä¸ºäº†ä¿è¯ç›‘å¬åˆ°äº‹ä»¶åå›è°ƒå‡½æ•°èƒ½å¤Ÿéƒ½åˆ°æ‰§è¡Œï¼Œå·²å…³è”çš„é˜Ÿåˆ—ä¼šè¢«dispatch_sourceå¼ºå¼•ç”¨ã€‚ 7.4 åº”ç”¨â€”è‡ªå®šä¹‰GCDTimeråœ¨iOSå¼€å‘ä¸­ä¸€èˆ¬ä½¿ç”¨NSTimeræ¥å¤„ç†å®šæ—¶é€»è¾‘ï¼Œä½†NSTimeræ˜¯ä¾èµ–Runloopçš„ï¼Œè€ŒRunloopå¯ä»¥è¿è¡Œåœ¨ä¸åŒçš„æ¨¡å¼ä¸‹ã€‚å¦‚æœNSTimeræ·»åŠ åœ¨ä¸€ç§æ¨¡å¼ä¸‹ï¼Œå½“Runloopè¿è¡Œåœ¨å…¶ä»–æ¨¡å¼ä¸‹çš„æ—¶å€™ï¼Œå®šæ—¶å™¨å°±æŒ‚æœºäº†ï¼›åˆå¦‚æœRunloopåœ¨é˜»å¡çŠ¶æ€ï¼ŒNSTimerè§¦å‘æ—¶é—´å°±ä¼šæ¨è¿Ÿåˆ°ä¸‹ä¸€ä¸ªRunloopå‘¨æœŸã€‚å› æ­¤NSTimeråœ¨è®¡æ—¶ä¸Šä¼šæœ‰è¯¯å·®ï¼Œå¹¶ä¸æ˜¯ç‰¹åˆ«ç²¾ç¡®ï¼Œè€ŒGCDå®šæ—¶å™¨ä¸ä¾èµ–Runloopï¼Œè®¡æ—¶ç²¾åº¦è¦é«˜å¾ˆå¤š ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä»£ç ï¼Œä½¿ç”¨dispatch_sourceæ¥å°è£…ä¸€ä¸ªGCDTimerï¼š Demoåœ°å€ï¼šLink JYTimer.h 123456789101112131415161718192021222324#import &lt;Foundation/Foundation.h&gt;typedef void(^JYTimerBlock)(void);@interface JYTimer : NSObject/// åˆ›å»ºä¸€ä¸ªåŸºäº GCD çš„å®šæ—¶å™¨ï¼Œé»˜è®¤æŒ‚èµ·ï¼Œéœ€è¦æ‰‹åŠ¨å¼€å¯/// @param interval é‡å¤æ—¶é—´é—´éš”/// @param repeat æ˜¯å¦é‡å¤/// @param completion äº‹ä»¶å›è°ƒ+ (instancetype)timerWithInterval:(NSTimeInterval)interval repeat:(BOOL)repeat completion:(JYTimerBlock)completion;/// å¼€å§‹å’Œç»§ç»­å®šæ—¶å™¨- (void)resumeTimer;/// ç»ˆæ­¢å®šæ—¶å™¨- (void)invalidTimer;/// æš‚åœå®šæ—¶å™¨- (void)pauseTimer;@end JYTimer.m 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768#import &quot;JYTimer.h&quot;@interface JYTimer ()// GCDTimer éœ€è¦å¼ºæŒæœ‰ï¼Œå¦åˆ™å‡ºäº†ä½œç”¨åŸŸç«‹å³é‡Šæ”¾ï¼Œä¹Ÿå°±æ²¡æœ‰äº†äº‹ä»¶å›è°ƒ@property (nonatomic, strong) dispatch_source_t timer;@property (nonatomic, assign) BOOL isRuning;@end@implementation JYTimer+ (JYTimer *)timerWithInterval:(NSTimeInterval)interval repeat:(BOOL)repeat completion:(JYTimerBlock)completion { JYTimer *timer = [[JYTimer alloc] initWithInterval:interval repeat:repeat completion:completion]; return timer;}- (instancetype)initWithInterval:(NSTimeInterval)interval repeat:(BOOL)repeat completion:(JYTimerBlock)completion { if (self = [super init]) { self.isRuning = NO; // åˆå§‹åŒ– timer self.timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, dispatch_get_global_queue(0, 0)); // è®¾ç½® timer çš„é¦–æ¬¡æ‰§è¡Œæ—¶é—´ï¼Œé—´éš”ï¼Œç²¾ç¡®åº¦ dispatch_source_set_timer(self.timer, DISPATCH_TIME_NOW, interval * NSEC_PER_SEC, 0 * NSEC_PER_SEC); // è®¾ç½® timer äº‹ä»¶å›è°ƒ __weak typeof(self) weakSelf = self; dispatch_source_set_event_handler(self.timer, ^{ if (completion) { completion(); } if (!repeat) { dispatch_source_cancel(weakSelf.timer); weakSelf.isRuning = NO; weakSelf.timer = nil; } }); } return self;}- (void)resumeTimer { if (self.timer &amp;&amp; !self.isRuning) { dispatch_resume(self.timer); self.isRuning = YES; }}- (void)invalidTimer { if (self.timer) { dispatch_source_cancel(self.timer); self.isRuning = NO; self.timer = nil; }}- (void)pauseTimer { if (self.timer &amp;&amp; self.isRuning) { dispatch_suspend(self.timer); self.isRuning = NO; }}@end æµ‹è¯•ä»£ç ï¼š ViewController.m 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465#import &quot;ViewController.h&quot;#import &quot;JYTimer.h&quot;@interface ViewController ()@property (nonatomic, strong) JYTimer *timer;@end@implementation ViewController- (void)viewDidLoad { [super viewDidLoad]; self.view.backgroundColor = [UIColor whiteColor]; __block int a = 0; JYTimer *timer = [JYTimer timerWithInterval:1.0 repeat:YES completion:^{ a++; NSLog(@&quot;%d&quot;, a); }]; self.timer = timer; [self setupUI];}- (void)setupUI { UIButton *btn = [UIButton new]; [btn setTitle:@&quot;å¼€å§‹&quot; forState:UIControlStateNormal]; btn.frame = CGRectMake(10, 90, 100, 80); btn.backgroundColor = [UIColor systemBlueColor]; [self.view addSubview:btn]; [btn addTarget:self action:@selector(start:) forControlEvents:UIControlEventTouchUpInside]; UIButton *btn1 = [UIButton new]; [btn1 setTitle:@&quot;ç»ˆæ­¢&quot; forState:UIControlStateNormal]; btn1.frame = CGRectMake(10, 190, 100, 80); btn1.backgroundColor = [UIColor systemBlueColor]; [self.view addSubview:btn1]; [btn1 addTarget:self action:@selector(invalid:) forControlEvents:UIControlEventTouchUpInside]; UIButton *btn2 = [UIButton new]; [btn2 setTitle:@&quot;æš‚åœ&quot; forState:UIControlStateNormal]; btn2.frame = CGRectMake(10, 290, 100, 80); btn2.backgroundColor = [UIColor systemBlueColor]; [self.view addSubview:btn2]; [btn2 addTarget:self action:@selector(pause:) forControlEvents:UIControlEventTouchUpInside];}#pragma mark - Event- (void)start:(UIButton *)btn { [self.timer resumeTimer];}- (void)invalid:(UIButton *)btn { [self.timer invalidTimer];}- (void)pause:(UIButton *)btn { [self.timer pauseTimer];}@end ä½¿ç”¨dispatch_sourceè‡ªå®šä¹‰å®šæ—¶å™¨æ³¨æ„ç‚¹ï¼š GCDTimeréœ€è¦å¼ºæŒæœ‰ï¼Œå¦åˆ™å‡ºäº†ä½œç”¨åŸŸç«‹å³é‡Šæ”¾ï¼Œä¹Ÿå°±æ²¡æœ‰äº†äº‹ä»¶å›è°ƒ GCDTimeré»˜è®¤æ˜¯æŒ‚èµ·çŠ¶æ€ï¼Œéœ€è¦æ‰‹åŠ¨æ¿€æ´» GCDTimeræ²¡æœ‰repeatï¼Œéœ€è¦å°è£…æ¥å¢åŠ æ ‡å¿—ä½æ§åˆ¶ GCDTimerå¦‚æœå­˜åœ¨å¾ªç¯å¼•ç”¨ï¼Œä½¿ç”¨weak+strongæˆ–è€…æå‰è°ƒç”¨dispatch_source_cancelå–æ¶ˆtimer dispatch_resumeå’Œdispatch_suspendè°ƒç”¨æ¬¡æ•°éœ€è¦å¹³è¡¡ sourceåœ¨æŒ‚èµ·çŠ¶æ€ä¸‹ï¼Œå¦‚æœç›´æ¥è®¾ç½®source = nilæˆ–è€…é‡æ–°åˆ›å»ºsourceéƒ½ä¼šé€ æˆcrashã€‚æ­£ç¡®çš„æ–¹å¼æ˜¯åœ¨æ¿€æ´»çŠ¶æ€ä¸‹è°ƒç”¨dispatch_source_cancel(source)é‡Šæ”¾å½“å‰çš„source PSæˆ‘å°è£…çš„GCDTimer å‚è€ƒIOS GCDä¸­çš„ä¿¡å·é‡ iOSæ¢ç´¢ å¤šçº¿ç¨‹ä¹‹GCDåº”ç”¨","link":"/2021/05/18/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/17-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BGCD%E5%BA%94%E7%94%A8/"},{"title":"18-å¤šçº¿ç¨‹ä¹‹GCDåº•å±‚åŸç†","text":"å¦‚ä½•å®šä½æºç å·²çŸ¥è¦ç ”ç©¶GCDï¼Œæ‰€ä»¥æœ‰ä»¥ä¸‹å‡ ç§é€‰æ‹©æºç çš„æ–¹æ³•ï¼š Baidu/Google ä¸‹ç¬¦å·æ–­ç‚¹dispatch_queue_create é¦–å…ˆå†™ä¸‹æµ‹è¯•ä»£ç ï¼š 1dispatch_queue_t aaqueue = dispatch_queue_create(&quot;aa&quot;, NULL); ç„¶åæ·»åŠ ç¬¦å·æ–­ç‚¹ï¼š ä»…ä½¿ç”¨Debug-&gt;Debug Workflow-&gt;Always show Disassemblyï¼Œæ–­ç‚¹åˆ°ä¸Šé¢çš„æµ‹è¯•ä»£ç ï¼ŒæŸ¥çœ‹æ±‡ç¼–ä¹Ÿèƒ½çœ‹åˆ°å®šä½åœ¨libdispatch.dylib è‹¹æœå®˜ç½‘çš„ï¼šlibdispatchæºç  ä¸€ã€å¼€å§‹ç ”ç©¶ GCDé¦–å…ˆåˆ›å»ºä¸¤ä¸ªå¸¸è§çš„é˜Ÿåˆ—ï¼Œä¸²è¡Œé˜Ÿåˆ—å’Œå¹¶å‘é˜Ÿåˆ—ï¼Œç„¶ååˆ†åˆ« po ä¸€ä¸‹ï¼Œå†é¡ºä¾¿æŠŠä¸»é˜Ÿåˆ—å’Œå…¨å±€é˜Ÿåˆ—åˆ†åˆ«ä¸€èµ·ç»™çœ‹äº†ã€‚ å‘ç°ä¸»é˜Ÿåˆ—çš„ width å’Œä¸²è¡Œé˜Ÿåˆ—çš„ width æ˜¯ä¸€æ ·çš„ï¼Œå…¶ä»–çš„ä¹Ÿæœ‰å¾ˆå¤šç›¸åŒçš„ï¼Œéš¾æ€ªè¯´ä¸»é˜Ÿåˆ—æ˜¯ç‰¹æ®Šçš„ä¸²è¡Œé˜Ÿåˆ—ã€‚ ä½†æ˜¯å¹¶å‘é˜Ÿåˆ—å’Œå…¨å±€é˜Ÿåˆ—çš„ width å´ç›¸å·® 1ï¼Œæœ‰ç‚¹å¥‡æ€ªã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±åˆ°æºç ä¸­ä¸€æ¢ç©¶ç«Ÿå§ã€‚ äºŒã€åˆ›å»ºé˜Ÿåˆ—åœ¨åº•å±‚æ˜¯æ€æ ·å®ç°çš„å…ˆä¸Šç»“è®ºï¼š è‡ªå®šä¹‰å¹¶å‘é˜Ÿåˆ—å’Œä¸²è¡Œé˜Ÿåˆ—ï¼Œæ˜¯ä»æ ¹é˜Ÿåˆ—æ•°ç»„ä¸­å–å‡ºæ¨¡æ¿å±æ€§ï¼Œç„¶åç»è¿‡äº†ä¸€ç³»åˆ—çš„å¼€è¾Ÿç©ºé—´ã€æ„é€ ã€èµ‹å€¼ç­‰æ“ä½œåˆ›å»ºå‡ºæ¥çš„ã€‚ æ ¹é˜Ÿåˆ—æ•°ç»„æ˜¯åœ¨libdispatch_initä¹‹åè°ƒç”¨_dispatch_introspection_initï¼Œé€šè¿‡ for å¾ªç¯ï¼Œè°ƒç”¨_dispatch_trace_queue_createï¼Œå†å–å‡º_dispatch_root_queuesé‡Œçš„åœ°å€æŒ‡é’ˆä¸€ä¸ªä¸ªåˆ›å»ºå‡ºæ¥çš„ã€‚ 2.1 è‡ªå®šä¹‰é˜Ÿåˆ—çš„åˆ›å»ºæ ¹æ®æˆ‘ä»¬çš„è°ƒç”¨ï¼šdispatch_queue_create(&quot;aa&quot;, NULL);ï¼Œå…¨å±€æœç´¢dispatch_queue_createã€‚ä½†æ˜¯ä¼šå‡ºç°æœç´¢ç»“æœå·¨å¤šçš„æƒ…å†µï¼ˆ66 results in 17 filesï¼‰ï¼Œæ­¤æ—¶æˆ‘ä»¬åº”è¯¥ä¿®æ”¹æœç´¢æ¡ä»¶ï¼š ç”±äºåˆ›å»ºé˜Ÿåˆ—ä»£ç ä¸ºdispatch_queue_create(&quot;&quot;, NULL)ï¼Œæ‰€ä»¥æœç´¢dispatch_queue_create(â€”â€”å°†ç­›é€‰ç»“æœé™è‡³ï¼ˆ21 results in 6 filesï¼‰ ç”±äºç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå­—ç¬¦ä¸²ï¼Œåœ¨cè¯­è¨€ä¸­ç”¨constä¿®é¥°ï¼Œæ‰€ä»¥æœç´¢dispatch_queue_create(constâ€”â€”å°†ç­›é€‰ç»“æœé™è‡³ï¼ˆ2 results in 2 filesï¼‰ï¼Œç”±æ­¤æ‰¾åˆ°äº†æˆ‘ä»¬éœ€è¦çœ‹çš„åº•å±‚ä»£ç  2.1.1 dispatch_queue_create123456dispatch_queue_tdispatch_queue_create(const char *label, dispatch_queue_attr_t attr){ return _dispatch_lane_create_with_target(label, attr, DISPATCH_TARGET_QUEUE_DEFAULT, true);} å‘ç°å»è°ƒç”¨äº† _dispatch_lane_create_with_targetæ–¹æ³•ï¼Œå¸¸è§„çš„æ¥å£éš”ç¦»æ“ä½œã€‚ 2.1.2 _dispatch_lane_create_with_target123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135DISPATCH_NOINLINEstatic dispatch_queue_t_dispatch_lane_create_with_target(const char *label, dispatch_queue_attr_t dqa, dispatch_queue_t tq, bool legacy){ // âœ…2.3 dispatch_queue_attr_info_t dqai = _dispatch_queue_attr_to_info(dqa); // // Step 1: Normalize arguments (qos, overcommit, tq) // dispatch_qos_t qos = dqai.dqai_qos;#if !HAVE_PTHREAD_WORKQUEUE_QOS if (qos == DISPATCH_QOS_USER_INTERACTIVE) { dqai.dqai_qos = qos = DISPATCH_QOS_USER_INITIATED; } if (qos == DISPATCH_QOS_MAINTENANCE) { dqai.dqai_qos = qos = DISPATCH_QOS_BACKGROUND; }#endif // !HAVE_PTHREAD_WORKQUEUE_QOS _dispatch_queue_attr_overcommit_t overcommit = dqai.dqai_overcommit; if (overcommit != _dispatch_queue_attr_overcommit_unspecified &amp;&amp; tq) { if (tq-&gt;do_targetq) { DISPATCH_CLIENT_CRASH(tq, &quot;Cannot specify both overcommit and &quot; &quot;a non-global target queue&quot;); } } if (tq &amp;&amp; dx_type(tq) == DISPATCH_QUEUE_GLOBAL_ROOT_TYPE) { // Handle discrepancies between attr and target queue, attributes win if (overcommit == _dispatch_queue_attr_overcommit_unspecified) { if (tq-&gt;dq_priority &amp; DISPATCH_PRIORITY_FLAG_OVERCOMMIT) { // å¹¶å‘é˜Ÿåˆ— overcommit = _dispatch_queue_attr_overcommit_enabled; } else { // ä¸²è¡Œé˜Ÿåˆ— overcommit = _dispatch_queue_attr_overcommit_disabled; } } if (qos == DISPATCH_QOS_UNSPECIFIED) { qos = _dispatch_priority_qos(tq-&gt;dq_priority); } tq = NULL; } else if (tq &amp;&amp; !tq-&gt;do_targetq) { // target is a pthread or runloop root queue, setting QoS or overcommit // is disallowed if (overcommit != _dispatch_queue_attr_overcommit_unspecified) { DISPATCH_CLIENT_CRASH(tq, &quot;Cannot specify an overcommit attribute &quot; &quot;and use this kind of target queue&quot;); } } else { if (overcommit == _dispatch_queue_attr_overcommit_unspecified) { // Serial queues default to overcommit! overcommit = dqai.dqai_concurrent ? _dispatch_queue_attr_overcommit_disabled : _dispatch_queue_attr_overcommit_enabled; // å¹¶å‘æ˜¯...disableï¼Œä¸²è¡Œæ˜¯...enable } } if (!tq) { // âœ…ä¸€å®šä¼šèµ°è¿™é‡Œ // 2.7 ä»æ ¹é˜Ÿåˆ—è·å– tq tq = _dispatch_get_root_queue( qos == DISPATCH_QOS_UNSPECIFIED ? DISPATCH_QOS_DEFAULT : qos, // 4 overcommit == _dispatch_queue_attr_overcommit_enabled)-&gt;_as_dq; // å¹¶å‘ä¸º0 ä¸²è¡Œä¸º1 if (unlikely(!tq)) { DISPATCH_CLIENT_CRASH(qos, &quot;Invalid queue attribute&quot;); } } // // Step 2: Initialize the queue // if (legacy) { // if any of these attributes is specified, use non legacy classes if (dqai.dqai_inactive || dqai.dqai_autorelease_frequency) { legacy = false; } } const void *vtable; dispatch_queue_flags_t dqf = legacy ? DQF_MUTABLE : 0; if (dqai.dqai_concurrent) { vtable = DISPATCH_VTABLE(queue_concurrent); } else { vtable = DISPATCH_VTABLE(queue_serial); } switch (dqai.dqai_autorelease_frequency) { case DISPATCH_AUTORELEASE_FREQUENCY_NEVER: dqf |= DQF_AUTORELEASE_NEVER; break; case DISPATCH_AUTORELEASE_FREQUENCY_WORK_ITEM: dqf |= DQF_AUTORELEASE_ALWAYS; break; } if (label) { const char *tmp = _dispatch_strdup_if_mutable(label); if (tmp != label) { dqf |= DQF_LABEL_NEEDS_FREE; label = tmp; } } // 2.4 å¼€è¾Ÿå†…å­˜ - ç”Ÿæˆç›¸åº”çš„å¯¹è±¡ queue dispatch_lane_t dq = _dispatch_object_alloc(vtable, sizeof(struct dispatch_lane_s)); // 2.5 æ„é€ æ–¹æ³• _dispatch_queue_init(dq, dqf, dqai.dqai_concurrent ? DISPATCH_QUEUE_WIDTH_MAX : 1, DISPATCH_QUEUE_ROLE_INNER | (dqai.dqai_inactive ? DISPATCH_QUEUE_INACTIVE : 0)); // æ ‡ç­¾ dq-&gt;dq_label = label; // ä¼˜å…ˆçº§ dq-&gt;dq_priority = _dispatch_priority_make((dispatch_qos_t)dqai.dqai_qos, dqai.dqai_relpri); if (overcommit == _dispatch_queue_attr_overcommit_enabled) { dq-&gt;dq_priority |= DISPATCH_PRIORITY_FLAG_OVERCOMMIT; } if (!dqai.dqai_inactive) { _dispatch_queue_priority_inherit_from_target(dq, tq); _dispatch_lane_inherit_wlh_from_target(dq, tq); } _dispatch_retain(tq); // âœ…2.6 dq-&gt;do_targetq = tq; _dispatch_object_debug(dq, &quot;%s&quot;, __func__); return _dispatch_trace_queue_create(dq)._dq;} è¿™ä¸ªæ–¹æ³•è¾ƒé•¿ï¼Œæˆ‘ä»¬æ‹†å¼€é‡ç‚¹ä»£ç è¿›è¡Œåˆ†æã€‚ 2.1.3 _dispatch_queue_attr_to_info1dispatch_queue_attr_info_t dqai = _dispatch_queue_attr_to_info(dqa); å…¶ä¸­ä¼ å…¥è¿™ä¸ªæ–¹æ³•çš„å‚æ•°dqaä¸ºdispatch_queue_attr_tç±»å‹çš„ï¼Œä¸²è¡Œé˜Ÿåˆ—ä¼ å…¥çš„æ˜¯NULLï¼Œå¹¶å‘ä¼ å…¥çš„æ˜¯DISPATCH_QUEUE_CONCURRENTã€‚ å°†dqaå‚æ•°ä¼ å…¥åï¼Œç”Ÿæˆäº†dispatch_queue_attr_info_tå¯¹è±¡dqaiã€‚ æˆ‘ä»¬å¯ä»¥å‘ç°dispatch_queue_attr_info_tæ˜¯ä¸€ä¸ªç»“æ„ä½“ä½åŸŸçš„å½¢å¼ï¼Œé‡Œé¢åŒ…å«äº†ä¸€äº›dispatch_qos_tç­‰ä¼˜å…ˆçº§çš„å€¼ã€‚ 12345678typedef struct dispatch_queue_attr_info_s { dispatch_qos_t dqai_qos : 8; int dqai_relpri : 8; uint16_t dqai_overcommit:2; uint16_t dqai_autorelease_frequency:2; uint16_t dqai_concurrent:1; uint16_t dqai_inactive:1;} dispatch_queue_attr_info_t; è¿›å…¥æ–¹æ³•æŸ¥çœ‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748dispatch_queue_attr_info_t_dispatch_queue_attr_to_info(dispatch_queue_attr_t dqa){ // åˆå§‹åŒ– dispatch_queue_attr_info_t dqai = { }; // ä¸²è¡Œé˜Ÿåˆ—ç›´æ¥è¿”å›ç©ºç»“æ„ä½“ã€‚åç»­ä»£ç éƒ½æ˜¯å¯¹å¹¶å‘é˜Ÿåˆ—è¿›è¡Œçš„æ“ä½œ if (!dqa) return dqai;#if DISPATCH_VARIANT_STATIC if (dqa == &amp;_dispatch_queue_attr_concurrent) { dqai.dqai_concurrent = true; return dqai; }#endif if (dqa &lt; _dispatch_queue_attrs || dqa &gt;= &amp;_dispatch_queue_attrs[DISPATCH_QUEUE_ATTR_COUNT]) { DISPATCH_CLIENT_CRASH(dqa-&gt;do_vtable, &quot;Invalid queue attribute&quot;); } // è‹¹æœçš„ç®—æ³• size_t idx = (size_t)(dqa - _dispatch_queue_attrs); // å¹¶å‘é˜Ÿåˆ—ç»“æ„ä½“ä½åŸŸçš„é»˜è®¤é…ç½®å’Œèµ‹å€¼ dqai.dqai_inactive = (idx % DISPATCH_QUEUE_ATTR_INACTIVE_COUNT); idx /= DISPATCH_QUEUE_ATTR_INACTIVE_COUNT; // å¹¶å‘æ•°ã€‚âœ…é‡ç‚¹å…³æ³¨ã€‚åªæœ‰å¹¶å‘é˜Ÿåˆ—æ‰æœ‰è¿™ä¸ªå€¼ dqai.dqai_concurrent = !(idx % DISPATCH_QUEUE_ATTR_CONCURRENCY_COUNT); idx /= DISPATCH_QUEUE_ATTR_CONCURRENCY_COUNT; dqai.dqai_relpri = -(int)(idx % DISPATCH_QUEUE_ATTR_PRIO_COUNT); idx /= DISPATCH_QUEUE_ATTR_PRIO_COUNT; // ä¼˜å…ˆçº§ dqai.dqai_qos = idx % DISPATCH_QUEUE_ATTR_QOS_COUNT; idx /= DISPATCH_QUEUE_ATTR_QOS_COUNT; dqai.dqai_autorelease_frequency = idx % DISPATCH_QUEUE_ATTR_AUTORELEASE_FREQUENCY_COUNT; idx /= DISPATCH_QUEUE_ATTR_AUTORELEASE_FREQUENCY_COUNT; dqai.dqai_overcommit = idx % DISPATCH_QUEUE_ATTR_OVERCOMMIT_COUNT; idx /= DISPATCH_QUEUE_ATTR_OVERCOMMIT_COUNT; return dqai;} å½“ä¸ºä¸²è¡Œé˜Ÿåˆ—çš„æ—¶å€™ï¼Œä¼ å…¥çš„å‚æ•°ä¸ºNULLï¼Œç›´æ¥è¿”å›ä¸€ä¸ªç©ºç»“æ„ä½“ã€‚æ‰€ä»¥ä»£ç åç»­å¯¹dqaiçš„æ“ä½œéƒ½æ˜¯åŸºäºå¹¶å‘é˜Ÿåˆ—çš„ï¼Œå¹¶é€šè¿‡æ­¤æ¥è¿›è¡Œåˆ¤æ–­å–å€¼ã€‚ é‚£ä¹ˆå¯¹äºå¹¶å‘é˜Ÿåˆ—ï¼Œä¼šæ ¹æ®ä¼ å…¥çš„å®å®šä¹‰å‚æ•°ï¼Œé€šè¿‡ä½è¿ç®—ï¼Œæ¥ç»™dqaiè¿›è¡Œèµ‹å€¼ï¼Œæ¯”è¾ƒä¸»è¦çš„æœ‰å¹¶å‘æ•°ï¼ˆdqai_concurrentï¼‰ï¼Œä¼˜å…ˆçº§ï¼ˆdqai_qosï¼‰ç­‰ã€‚ 2.1.4 _dispatch_object_allocè™½ç„¶åœ¨ä¸Šä¸€æ­¥è·å–åˆ°äº†dispatch_queue_attr_info_tç›¸å…³çš„å€¼ï¼Œä½†æ˜¯å®ƒå¹¶ä¸æ˜¯æœ€ç»ˆè¿”å›çš„çº¿ç¨‹ï¼Œåªæ˜¯æˆ‘ä»¬ç”¨æ¥è·å–ä¸€äº›é…ç½®çš„ä¸´æ—¶å˜é‡è€Œå·²ã€‚ çœ‹_dispatch_lane_create_with_targetæ–¹æ³•æœ€åä¸€è¡Œï¼Œå‘ç°æœ€ç»ˆè¿”å›çš„æ˜¯ä¸€ä¸ªdispatch_lane_tç±»å‹çš„dqçš„å¯¹è±¡ï¼Œæ‰€ä»¥dispatch_lane_tåº”è¯¥æ˜¯æœ€ç»ˆç”Ÿæˆçš„é˜Ÿåˆ—ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°å®ƒæ˜¯ç”±_dispatch_object_allocæ–¹æ³•åˆ›å»ºå‡ºæ¥çš„ã€‚ ä½†æ˜¯_dispatch_object_allocæ–¹æ³•å¹¶æ²¡æœ‰å¼€æºï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸çŸ¥é“é‡Œé¢æ˜¯å¦‚ä½•å®ç°çš„ã€‚ ä¸è¿‡_dispatch_objectå¾ˆåƒOCä¸­çš„NSObjectã€‚ 12dispatch_lane_t dq = _dispatch_object_alloc(vtable, sizeof(struct dispatch_lane_s)); dispatch_object_t é€šè¿‡æœç´¢dispatch_objectï¼Œå‘ç°å¹¶æ‰¾ä¸åˆ°æˆ‘ä»¬éœ€è¦çš„å¤šçº¿ç¨‹æŠ½è±¡ç±»ï¼Œä¸è¿‡æˆ‘ä»¬å‘ç°ï¼Œä¸€èˆ¬å¤šçº¿ç¨‹çš„å¯¹è±¡åé¢éƒ½æœ‰_tï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰¾åˆ°äº†dispatch_object_tè¿™ä¸ªå¤šçº¿ç¨‹çš„æŠ½è±¡ç±»ã€‚ æˆ‘ä»¬å¯ä»¥å‘ç°å…¶æ˜¯ä¸€ä¸ªè”åˆä½“ï¼Œå’Œæˆ‘ä»¬isaçš„ç»“æœæå…¶ç±»ä¼¼ï¼Œé‡Œé¢åŒ…å«äº†æˆ‘ä»¬å¸¸ç”¨çš„å¾ˆå¤šä¿¡æ¯ã€‚å› ä¸ºè”åˆä½“äº’æ–¥ï¼Œè¿™æ ·åšæœ‰åˆ©äºå†…å­˜çš„ä¼˜åŒ–ï¼Œå’Œæ›´å¥½çš„å®ç°å¤šæ€ã€‚ 1234567891011121314typedef union { struct _os_object_s *_os_obj; // ç»“æ„ä½“æŒ‡é’ˆ struct dispatch_object_s *_do; struct dispatch_queue_s *_dq; // é˜Ÿåˆ— struct dispatch_queue_attr_s *_dqa; // å‚æ•°å€¼ struct dispatch_group_s *_dg; // ç»„ struct dispatch_source_s *_ds; struct dispatch_channel_s *_dch; struct dispatch_mach_s *_dm; struct dispatch_mach_msg_s *_dmsg; struct dispatch_semaphore_s *_dsema; // ä¿¡å·é‡ struct dispatch_data_s *_ddata; struct dispatch_io_s *_dchannel;} dispatch_object_t DISPATCH_TRANSPARENT_UNION; 2.1.5 _dispatch_queue_initå½“æˆ‘ä»¬åˆ›å»ºå‡ºdispatch_lane_tå¯¹è±¡dqåï¼Œç´§æ¥ç€å°±æ‰§è¡Œ_dispatch_queue_initæ„é€ æ–¹æ³•ã€‚ 123_dispatch_queue_init(dq, dqf, dqai.dqai_concurrent ? DISPATCH_QUEUE_WIDTH_MAX : 1, DISPATCH_QUEUE_ROLE_INNER | (dqai.dqai_inactive ? DISPATCH_QUEUE_INACTIVE : 0)); æŸ¥çœ‹æ–¹æ³•å†…éƒ¨å®ç°ï¼Œå‘ç°é€šè¿‡dispatch_queue_t dq = dqu._dq;å–å‡ºaé˜Ÿåˆ—åï¼Œå¯¹é˜Ÿåˆ—åˆè¿›è¡Œäº†ä¸€ç³»åˆ—çš„èµ‹å€¼ï¼Œç„¶ååˆè¿”å›äº† 1234567891011121314151617181920212223242526272829static inline dispatch_queue_class_t_dispatch_queue_init(dispatch_queue_class_t dqu, dispatch_queue_flags_t dqf, uint16_t width, uint64_t initial_state_bits){ uint64_t dq_state = DISPATCH_QUEUE_STATE_INIT_VALUE(width); // å–å‡ºé˜Ÿåˆ— dispatch_queue_t dq = dqu._dq; dispatch_assert((initial_state_bits &amp; ~(DISPATCH_QUEUE_ROLE_MASK | DISPATCH_QUEUE_INACTIVE)) == 0); if (initial_state_bits &amp; DISPATCH_QUEUE_INACTIVE) { dq-&gt;do_ref_cnt += 2; // rdar://8181908 see _dispatch_lane_resume if (dx_metatype(dq) == _DISPATCH_SOURCE_TYPE) { dq-&gt;do_ref_cnt++; // released when DSF_DELETED is set } } // è¿›è¡Œäº†ä¸€ç³»åˆ—èµ‹å€¼ dq_state |= initial_state_bits; dq-&gt;do_next = DISPATCH_OBJECT_LISTLESS; dqf |= DQF_WIDTH(width); os_atomic_store2o(dq, dq_atomic_flags, dqf, relaxed); dq-&gt;dq_state = dq_state; dq-&gt;dq_serialnum = os_atomic_inc_orig(&amp;_dispatch_queue_serial_numbers, relaxed); // åˆè¿”å›äº† return dqu;} å…³æ³¨ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•ä¸­çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œæ˜¯ä¸€ä¸ªåˆ¤æ–­ï¼š 12dqai.dqai_concurrent ? DISPATCH_QUEUE_WIDTH_MAX : 1 åˆ¤æ–­äº†dqai.dqai_concurrentï¼Œæˆ‘ä»¬çŸ¥é“ä¸²è¡Œæ˜¯æ²¡æœ‰dqai_concurrentçš„ï¼Œæ‰€ä»¥ä¸²è¡Œé˜Ÿåˆ—çš„è¿™ä¸ªå±æ€§ä¸º1ï¼Œå°±è¡¨ç¤ºä¸²è¡Œé˜Ÿåˆ—çš„å¹¶å‘æ•°ä¸º1ã€‚ é‚£ä¹ˆå¹¶å‘é˜Ÿåˆ—çš„è¿™ä¸ªå±æ€§å°±ä¸ºï¼šDISPATCH_QUEUE_WIDTH_MAXã€‚ æŸ¥çœ‹DISPATCH_QUEUE_WIDTH_MAXå®å®šä¹‰ï¼Œæˆ‘ä»¬å‘ç°å®ƒçš„å€¼ä¸ºDISPATCH_QUEUE_WIDTH_FULL-2ï¼Œå³0xFFEï¼Œæ‰€ä»¥å¹¶å‘é˜Ÿåˆ—çš„æœ€å¤§å¹¶å‘æ•°ä¸º0xFFE(4094)ã€‚ è‡³äº-2åˆ™æ˜¯å› ä¸º-1æ˜¯ä¸ºäº†ä¸é¥±å’Œï¼Œå†-1æ˜¯å› ä¸ºDISPATCH_QUEUE_WIDTH_POOLä¸ºåˆ›å»ºå…¨å±€é˜Ÿåˆ—æ—¶å€™æ‰€ä½¿ç”¨çš„ï¼Œé¿å…ç›¸åŒã€‚ 2.1.6 dq-&gt;do_targetq = tq;æ‰§è¡Œå®Œæ„é€ å‡½æ•°ä¹‹åï¼Œæ¥ç€åˆå¯¹dqè¿›è¡Œäº†ä¸€äº›åˆ—èµ‹å€¼ã€‚ ä½†æ˜¯å¦‚æœæ¯æ¬¡åˆ›å»ºçº¿ç¨‹ï¼Œæ‰€æœ‰çš„å±æ€§éƒ½è¦é‡æ–°èµ‹å€¼çš„è¯ï¼Œæ˜¯æ¯”è¾ƒè€—æ€§èƒ½çš„ã€‚æ‰€ä»¥è‹¹æœè®¾è®¡äº†åŸºäºâ€œæ¨¡æ¿â€çš„é˜Ÿåˆ—åˆ›å»ºæ–¹å¼ï¼Œè¿™ä¸ªâ€æ¨¡æ¿â€å°±æ˜¯æˆ‘ä»¬çš„do_targetqå±æ€§ã€‚ 12345678910111213141516171819// æ ‡ç­¾dq-&gt;dq_label = label;// ä¼˜å…ˆçº§dq-&gt;dq_priority = _dispatch_priority_make((dispatch_qos_t)dqai.dqai_qos, dqai.dqai_relpri);if (overcommit == _dispatch_queue_attr_overcommit_enabled) { dq-&gt;dq_priority |= DISPATCH_PRIORITY_FLAG_OVERCOMMIT;}if (!dqai.dqai_inactive) { _dispatch_queue_priority_inherit_from_target(dq, tq); _dispatch_lane_inherit_wlh_from_target(dq, tq);}_dispatch_retain(tq);// âœ…2.6dq-&gt;do_targetq = tq;_dispatch_object_debug(dq, &quot;%s&quot;, __func__);return _dispatch_trace_queue_create(dq)._dq; åœ¨æ–¹æ³•ä¸­å¯»æ‰¾ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°tqçš„åˆ›å»ºæ˜¯é€šè¿‡_dispatch_get_root_queueæ–¹æ³•ï¼Œå³åœ¨æ ¹é˜Ÿåˆ—çš„åŸºç¡€ä¸Šåˆ›å»ºï¼Œç„¶åèµ‹å€¼äº†ä¼˜å…ˆçº§qoså’Œovercommitã€‚ 12345678910if (!tq) { // âœ…ä¸€å®šä¼šèµ°è¿™é‡Œ // 2.7 ä»æ ¹é˜Ÿåˆ—è·å– tq tq = _dispatch_get_root_queue( qos == DISPATCH_QOS_UNSPECIFIED ? DISPATCH_QOS_DEFAULT : qos, // 4 overcommit == _dispatch_queue_attr_overcommit_enabled)-&gt;_as_dq; // å¹¶å‘ä¸º0 ä¸²è¡Œä¸º1 if (unlikely(!tq)) { DISPATCH_CLIENT_CRASH(qos, &quot;Invalid queue attribute&quot;); }} é¦–å…ˆçœ‹qosçš„å€¼ï¼Œæˆ‘ä»¬å‘ç°DISPATCH_QOS_UNSPECIFIEDä¸º0ï¼Œä¸”ä¹‹å‰æˆ‘ä»¬å¹¶æ²¡æœ‰èµ‹å€¼ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹å³æ‰§è¡ŒDISPATCH_QOS_DEFAULTï¼Œä¸º4ï¼Œæ‰€ä»¥qosæ²¡æŒ‡å®šçš„æƒ…å†µä¸‹ä¸º4ã€‚ æ¥ç€çœ‹overcommitçš„å€¼ï¼Œæ ¹æ®ä¸Šé¢dqaiå¯ä»¥åˆ¤æ–­å‡ºï¼Œä¸²è¡Œä¸º1ï¼Œå¹¶å‘ä¸º0 2.1.7 _dispatch_get_root_queue12345678910static inline dispatch_queue_global_t_dispatch_get_root_queue(dispatch_qos_t qos, bool overcommit){ if (unlikely(qos &lt; DISPATCH_QOS_MIN || qos &gt; DISPATCH_QOS_MAX)) { DISPATCH_CLIENT_CRASH(qos, &quot;Corrupted priority&quot;); } // 4 - 1 = 3 // 2 * 3 + 0/1 = 6/7 return &amp;_dispatch_root_queues[2 * (qos - 1) + overcommit];} æˆ‘ä»¬å‘ç°ï¼Œæœ€ç»ˆå°±æ˜¯ä»==æ ¹é˜Ÿåˆ—æ•°ç»„==é‡Œé€šè¿‡ä¸‹æ ‡æ¥å–å‡ºé˜Ÿåˆ—ã€‚ æ ¹æ®å…¥å‚å¯ä»¥çŸ¥é“ï¼Œä¸‹æ ‡ä¸º6æˆ–è€…7ã€‚ä¹Ÿå°±æ˜¯è¯´ä»æ ¹é˜Ÿåˆ—æ•°ç»„ä¸­å–å‡ºç¬¬å…­ä¸ªå’Œç¬¬ä¸ƒä¸ªé˜Ÿåˆ—ã€‚ 2.1.8 _dispatch_root_queues[]123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566struct dispatch_queue_global_s _dispatch_root_queues[] = {#define _DISPATCH_ROOT_QUEUE_IDX(n, flags) \\ ((flags &amp; DISPATCH_PRIORITY_FLAG_OVERCOMMIT) ? \\ DISPATCH_ROOT_QUEUE_IDX_##n##_QOS_OVERCOMMIT : \\ DISPATCH_ROOT_QUEUE_IDX_##n##_QOS)#define _DISPATCH_ROOT_QUEUE_ENTRY(n, flags, ...) \\ [_DISPATCH_ROOT_QUEUE_IDX(n, flags)] = { \\ DISPATCH_GLOBAL_OBJECT_HEADER(queue_global), \\ .dq_state = DISPATCH_ROOT_QUEUE_STATE_INIT_VALUE, \\ .do_ctxt = _dispatch_root_queue_ctxt(_DISPATCH_ROOT_QUEUE_IDX(n, flags)), \\ .dq_atomic_flags = DQF_WIDTH(DISPATCH_QUEUE_WIDTH_POOL), \\ .dq_priority = flags | ((flags &amp; DISPATCH_PRIORITY_FLAG_FALLBACK) ? \\ _dispatch_priority_make_fallback(DISPATCH_QOS_##n) : \\ _dispatch_priority_make(DISPATCH_QOS_##n, 0)), \\ __VA_ARGS__ \\ } _DISPATCH_ROOT_QUEUE_ENTRY(MAINTENANCE, 0, .dq_label = &quot;com.apple.root.maintenance-qos&quot;, .dq_serialnum = 4, ), _DISPATCH_ROOT_QUEUE_ENTRY(MAINTENANCE, DISPATCH_PRIORITY_FLAG_OVERCOMMIT, .dq_label = &quot;com.apple.root.maintenance-qos.overcommit&quot;, .dq_serialnum = 5, ), _DISPATCH_ROOT_QUEUE_ENTRY(BACKGROUND, 0, .dq_label = &quot;com.apple.root.background-qos&quot;, .dq_serialnum = 6, ), _DISPATCH_ROOT_QUEUE_ENTRY(BACKGROUND, DISPATCH_PRIORITY_FLAG_OVERCOMMIT, .dq_label = &quot;com.apple.root.background-qos.overcommit&quot;, .dq_serialnum = 7, ), _DISPATCH_ROOT_QUEUE_ENTRY(UTILITY, 0, .dq_label = &quot;com.apple.root.utility-qos&quot;, .dq_serialnum = 8, ), _DISPATCH_ROOT_QUEUE_ENTRY(UTILITY, DISPATCH_PRIORITY_FLAG_OVERCOMMIT, .dq_label = &quot;com.apple.root.utility-qos.overcommit&quot;, .dq_serialnum = 9, // è‡ªå®šä¹‰ä¸²è¡Œé˜Ÿåˆ—ç”¨è¿™ä¸ª ), _DISPATCH_ROOT_QUEUE_ENTRY(DEFAULT, DISPATCH_PRIORITY_FLAG_FALLBACK, .dq_label = &quot;com.apple.root.default-qos&quot;, .dq_serialnum = 10, // è‡ªå®šä¹‰å¹¶å‘é˜Ÿåˆ—ç”¨è¿™ä¸ª ), _DISPATCH_ROOT_QUEUE_ENTRY(DEFAULT, DISPATCH_PRIORITY_FLAG_FALLBACK | DISPATCH_PRIORITY_FLAG_OVERCOMMIT, .dq_label = &quot;com.apple.root.default-qos.overcommit&quot;, .dq_serialnum = 11, ), _DISPATCH_ROOT_QUEUE_ENTRY(USER_INITIATED, 0, .dq_label = &quot;com.apple.root.user-initiated-qos&quot;, .dq_serialnum = 12, ), _DISPATCH_ROOT_QUEUE_ENTRY(USER_INITIATED, DISPATCH_PRIORITY_FLAG_OVERCOMMIT, .dq_label = &quot;com.apple.root.user-initiated-qos.overcommit&quot;, .dq_serialnum = 13, ), _DISPATCH_ROOT_QUEUE_ENTRY(USER_INTERACTIVE, 0, .dq_label = &quot;com.apple.root.user-interactive-qos&quot;, .dq_serialnum = 14, ), _DISPATCH_ROOT_QUEUE_ENTRY(USER_INTERACTIVE, DISPATCH_PRIORITY_FLAG_OVERCOMMIT, .dq_label = &quot;com.apple.root.user-interactive-qos.overcommit&quot;, .dq_serialnum = 15, ),}; é€šè¿‡ä¸‹æ ‡ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºå¦‚ä¸‹ç»“è®ºã€‚ è‡ªå®šä¹‰å¹¶å‘é˜Ÿåˆ—targeté˜Ÿåˆ—ä¸ºcom.apple.root.default-qos è‡ªå®šä¹‰ä¸²è¡Œé˜Ÿåˆ—targeté˜Ÿåˆ—ä¸ºcom.apple.root.default-qos.overcommit è‡³æ­¤ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„ä¸€ä¸ªä¸²è¡Œæˆ–è€…å¹¶å‘é˜Ÿåˆ—å°±å·²ç»æ ¹æ®æ¨¡æ¿åˆ›å»ºå®Œæˆäº† 2.1.9 éªŒè¯ å›çœ‹æˆ‘ä»¬å¼€å¤´æ‰“å°çš„ä¸€äº›å…³äºå„ç§é˜Ÿåˆ—çš„ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°ï¼š ä¸²è¡Œé˜Ÿåˆ—ã€å¹¶å‘é˜Ÿåˆ—çš„targetç¡®å®å¯¹åº”æ¨¡æ¿ä¸­çš„å€¼ ä¸²è¡Œé˜Ÿåˆ—ã€å¹¶å‘é˜Ÿåˆ—ã€ä¸»é˜Ÿåˆ—ã€å…¨å±€é˜Ÿåˆ—çš„widthï¼ˆwidthè¡¨ç¤ºé˜Ÿåˆ—ä¸­çš„æœ€å¤§å¹¶å‘æ•°ï¼‰éƒ½ä¸æˆ‘ä»¬çš„åˆ†æä¸€è‡´ï¼Œå³ï¼š ä¸²è¡Œé˜Ÿåˆ—å’Œä¸»é˜Ÿåˆ—çš„widthä¸º1 è‡ªå®šä¹‰å¹¶å‘é˜Ÿåˆ—çš„widthä¸ºDISPATCH_QUEUE_WIDTH_MAXï¼Œæ˜¯æ»¡å€¼-2ï¼Œ0xffeï¼ˆ4094ï¼‰ å…¨å±€é˜Ÿåˆ—çš„widthä¸ºDISPATCH_QUEUE_WIDTH_POOLï¼Œæ˜¯æ»¡å€¼-1 ç”±æ­¤å¯è§ï¼Œæˆ‘ä»¬å¯¹äºåº•å±‚çš„åˆ†ææ˜¯æ­£ç¡®çš„ã€‚ 2.2 æ ¹é˜Ÿåˆ—æ•°ç»„çš„åˆå§‹åŒ–é™¤äº†dispatch_get_main_queueï¼Œå…¶ä»–é˜Ÿåˆ—éƒ½æ˜¯é€šè¿‡_dispatch_root_queuesåˆ›å»ºçš„ï¼Œé‚£ä¹ˆ _dispatch_root_queues åˆæ˜¯åœ¨å“ªåˆ›å»ºçš„å‘¢ï¼Ÿ ç»“è®ºï¼š libdispatch_initä¹‹åè°ƒç”¨_dispatch_introspection_initï¼Œé€šè¿‡ for å¾ªç¯ï¼Œè°ƒç”¨_dispatch_trace_queue_createï¼Œå†å–å‡º_dispatch_root_queuesé‡Œçš„åœ°å€æŒ‡é’ˆä¸€ä¸ªä¸ªåˆ›å»ºå‡ºæ¥çš„ 2.3 ä¸€å¼ å›¾æ€»ç»“è‡ªå®šä¹‰é˜Ÿåˆ—çš„åˆ›å»ºè¿‡ç¨‹ ä¸‰ã€åŒæ­¥æ‰§è¡Œ dispatch_sync3.1 æ­»é”çš„äº§ç”Ÿæ­»é”çš„äº§ç”Ÿæ˜¯ç”±äºä»»åŠ¡çš„ç›¸äº’ç­‰å¾…ï¼Œé‚£ä¹ˆåº•å±‚åˆæ˜¯æ€ä¹ˆå®ç°æ­»é”çš„ï¼Ÿæˆ–è€…è¯´åº•å±‚æ˜¯æ€ä¹ˆåˆ¤æ–­äº§ç”Ÿäº†æ­»é”ï¼Ÿ è¿™éƒ¨åˆ†åº•å±‚ä»£ç è¦è·³è½¬10å±‚ä»¥ä¸Šï¼ŒæŠ“ä½ä¸»çº¿æ€ç»´ï¼Œç†è§£èµ·æ¥å°±ä¸ç®—éš¾ã€‚ 3.1.1 dispatch_syncå…¨å±€æœç´¢dispatch_sync(dispatchï¼Œå¿½ç•¥unlikelyå°æ¦‚ç‡äº‹ä»¶ 123456789101112DISPATCH_NOINLINEvoiddispatch_sync(dispatch_queue_t dq, dispatch_block_t work){ uintptr_t dc_flags = DC_FLAG_BLOCK; if (unlikely(_dispatch_block_has_private_data(work))) { return _dispatch_sync_block_with_privdata(dq, work, dc_flags); } // âœ… _dispatch_sync_f(dq, work, _dispatch_Block_invoke(work), dc_flags);}#endif // __BLOCKS__ 3.1.2 _dispatch_sync_fè¿˜æ˜¯å¸¸è§„çš„ä¸­é—´å±‚å°è£…ï¼š 1234567DISPATCH_NOINLINEstatic void_dispatch_sync_f(dispatch_queue_t dq, void *ctxt, dispatch_function_t func, uintptr_t dc_flags){ _dispatch_sync_f_inline(dq, ctxt, func, dc_flags);} 3.1.3 _dispatch_sync_f_inline123456789101112131415161718192021222324252627DISPATCH_ALWAYS_INLINEstatic inline void_dispatch_sync_f_inline(dispatch_queue_t dq, void *ctxt, dispatch_function_t func, uintptr_t dc_flags){ if (likely(dq-&gt;dq_width == 1)) { return _dispatch_barrier_sync_f(dq, ctxt, func, dc_flags); } if (unlikely(dx_metatype(dq) != _DISPATCH_LANE_TYPE)) { DISPATCH_CLIENT_CRASH(0, &quot;Queue type doesn't support dispatch_sync&quot;); } dispatch_lane_t dl = upcast(dq)._dl; // Global concurrent queues and queues bound to non-dispatch threads // always fall into the slow case, see DISPATCH_ROOT_QUEUE_STATE_INIT_VALUE if (unlikely(!_dispatch_queue_try_reserve_sync_width(dl))) { return _dispatch_sync_f_slow(dl, ctxt, func, 0, dl, dc_flags); } if (unlikely(dq-&gt;do_targetq-&gt;do_targetq)) { return _dispatch_sync_recurse(dl, ctxt, func, dc_flags); } _dispatch_introspection_sync_begin(dl); _dispatch_sync_invoke_and_complete(dl, ctxt, func DISPATCH_TRACE_ARG( _dispatch_trace_item_sync_push_pop(dq, ctxt, func, dc_flags)));} å·²çŸ¥ä¸²è¡Œé˜Ÿåˆ—çš„widthæ˜¯1ï¼Œæ‰€ä»¥ä¸²è¡Œé˜Ÿåˆ—æ»¡è¶³dq-&gt;dq_width == 1ï¼Œé‚£ä¹ˆä¸²å‹é˜Ÿåˆ—ä¼šèµ°ï¼š 1return _dispatch_barrier_sync_f(dq, ctxt, func, dc_flags); å¹¶å‘é˜Ÿåˆ—ä¼šç»§ç»­å¾€ä¸‹èµ°ã€‚ 3.1.4 _dispatch_barrier_sync_få› ä¸ºæ­»é”äº§ç”Ÿåœ¨ä¸²å‹é˜Ÿåˆ—ï¼Œæ‰€ä»¥çœ‹ä¸²å‹é˜Ÿåˆ—èµ°çš„åˆ†æ”¯ï¼Œä¸²è¡Œé˜Ÿåˆ—å’Œæ …æ å‡½æ•°çš„æ¯”è¾ƒç›¸ä¼¼ï¼Œæ‰€ä»¥è·³è½¬åˆ°è¿™é‡Œï¼Œè¿˜æ˜¯ä¸­é—´å±‚å°è£… 1234567DISPATCH_NOINLINEstatic void_dispatch_barrier_sync_f(dispatch_queue_t dq, void *ctxt, dispatch_function_t func, uintptr_t dc_flags){ _dispatch_barrier_sync_f_inline(dq, ctxt, func, dc_flags);} 3.1.5 _dispatch_barrier_sync_f_inline12345678910111213141516171819202122232425262728293031323334353637DISPATCH_ALWAYS_INLINEstatic inline void_dispatch_barrier_sync_f_inline(dispatch_queue_t dq, void *ctxt, dispatch_function_t func, uintptr_t dc_flags){ dispatch_tid tid = _dispatch_tid_self(); if (unlikely(dx_metatype(dq) != _DISPATCH_LANE_TYPE)) { DISPATCH_CLIENT_CRASH(0, &quot;Queue type doesn't support dispatch_sync&quot;); } dispatch_lane_t dl = upcast(dq)._dl; // The more correct thing to do would be to merge the qos of the thread // that just acquired the barrier lock into the queue state. // // However this is too expensive for the fast path, so skip doing it. // The chosen tradeoff is that if an enqueue on a lower priority thread // contends with this fast path, this thread may receive a useless override. // // Global concurrent queues and queues bound to non-dispatch threads // always fall into the slow case, see DISPATCH_ROOT_QUEUE_STATE_INIT_VALUE // æ­»é”ä¼šäº§ç”Ÿçš„ä½ç½® if (unlikely(!_dispatch_queue_try_acquire_barrier_sync(dl, tid))) { return _dispatch_sync_f_slow(dl, ctxt, func, DC_FLAG_BARRIER, dl, DC_FLAG_BARRIER | dc_flags); } if (unlikely(dl-&gt;do_targetq-&gt;do_targetq)) { return _dispatch_sync_recurse(dl, ctxt, func, DC_FLAG_BARRIER | dc_flags); } _dispatch_introspection_sync_begin(dl); _dispatch_lane_barrier_sync_invoke_and_complete(dl, ctxt, func DISPATCH_TRACE_ARG(_dispatch_trace_item_sync_push_pop( dq, ctxt, func, dc_flags | DC_FLAG_BARRIER)));} 3.1.5.1 _dispatch_tid_self_dispatch_tid_selfæ˜¯ä¸ªå®å®šä¹‰ï¼Œæœ€ç»ˆè°ƒç”¨_dispatch_thread_getspecificæ¥è·å–å½“å‰çº¿ç¨‹idï¼ˆçº¿ç¨‹æ˜¯ä»¥key-valueçš„å½¢å¼å­˜åœ¨çš„ï¼‰ 123456789101112#define _dispatch_tid_self() ((dispatch_tid)_dispatch_thread_port())#if TARGET_OS_WIN32#define _dispatch_thread_port() ((mach_port_t)0)#elif !DISPATCH_USE_THREAD_LOCAL_STORAGE#if DISPATCH_USE_DIRECT_TSD#define _dispatch_thread_port() ((mach_port_t)(uintptr_t)\\ _dispatch_thread_getspecific(_PTHREAD_TSD_SLOT_MACH_THREAD_SELF))#else#define _dispatch_thread_port() pthread_mach_thread_np(_dispatch_thread_self())#endif#endif æ¥ä¸‹æ¥å°±æ˜¯æ­»é”çš„æ ¸å¿ƒåˆ†æï¼ 3.1.5.2 _dispatch_queue_try_acquire_barrier_sync_dispatch_queue_try_acquire_barrier_syncä¼šä»osåº•å±‚è·å–åˆ°ä¸€ä¸ªçŠ¶æ€ 123456DISPATCH_ALWAYS_INLINE DISPATCH_WARN_RESULTstatic inline bool_dispatch_queue_try_acquire_barrier_sync(dispatch_queue_class_t dq, uint32_t tid){ return _dispatch_queue_try_acquire_barrier_sync_and_suspend(dq._dl, tid, 0);} 12345678910111213141516171819DISPATCH_ALWAYS_INLINE DISPATCH_WARN_RESULTstatic inline bool_dispatch_queue_try_acquire_barrier_sync_and_suspend(dispatch_lane_t dq, uint32_t tid, uint64_t suspend_count){ uint64_t init = DISPATCH_QUEUE_STATE_INIT_VALUE(dq-&gt;dq_width); uint64_t value = DISPATCH_QUEUE_WIDTH_FULL_BIT | DISPATCH_QUEUE_IN_BARRIER | _dispatch_lock_value_from_tid(tid) | (suspend_count * DISPATCH_QUEUE_SUSPEND_INTERVAL); uint64_t old_state, new_state; // ä»åº•å±‚è·å–ä¿¡æ¯ -- çŠ¶æ€ä¿¡æ¯ - å½“å‰é˜Ÿåˆ— - çº¿ç¨‹ return os_atomic_rmw_loop2o(dq, dq_state, old_state, new_state, acquire, { uint64_t role = old_state &amp; DISPATCH_QUEUE_ROLE_MASK; if (old_state != (init | role)) { os_atomic_rmw_loop_give_up(break); } new_state = value | role; });} 3.1.5.3 _dispatch_sync_f_slowä¸Šä¸€æ­¥è·å–åˆ°new_stateåå°±ä¼šæ¥åˆ°è¿™é‡Œï¼ˆæ­»é”å´©æºƒæ—¶çš„è°ƒç”¨æ ˆä¸­å°±å‡ºç°è¿‡è¿™ä¸ªå‡½æ•°ï¼‰ 12345678910111213141516171819202122232425262728293031323334353637383940DISPATCH_NOINLINEstatic void_dispatch_sync_f_slow(dispatch_queue_class_t top_dqu, void *ctxt, dispatch_function_t func, uintptr_t top_dc_flags, dispatch_queue_class_t dqu, uintptr_t dc_flags){ dispatch_queue_t top_dq = top_dqu._dq; dispatch_queue_t dq = dqu._dq; if (unlikely(!dq-&gt;do_targetq)) { return _dispatch_sync_function_invoke(dq, ctxt, func); } pthread_priority_t pp = _dispatch_get_priority(); struct dispatch_sync_context_s dsc = { .dc_flags = DC_FLAG_SYNC_WAITER | dc_flags, .dc_func = _dispatch_async_and_wait_invoke, .dc_ctxt = &amp;dsc, .dc_other = top_dq, .dc_priority = pp | _PTHREAD_PRIORITY_ENFORCE_FLAG, .dc_voucher = _voucher_get(), .dsc_func = func, .dsc_ctxt = ctxt, .dsc_waiter = _dispatch_tid_self(), }; // å‹æ ˆæ“ä½œ _dispatch_trace_item_push(top_dq, &amp;dsc); // å´©æºƒæ ˆä¸­å‡ºç°çš„æœ€åä¸€ä¸ªå‡½æ•° __DISPATCH_WAIT_FOR_QUEUE__(&amp;dsc, dq); if (dsc.dsc_func == NULL) { dispatch_queue_t stop_dq = dsc.dc_other; return _dispatch_sync_complete_recurse(top_dq, stop_dq, top_dc_flags); } _dispatch_introspection_sync_begin(top_dq); _dispatch_trace_item_pop(top_dq, &amp;dsc); _dispatch_sync_invoke_and_complete_recurse(top_dq, ctxt, func,top_dc_flags DISPATCH_TRACE_ARG(&amp;dsc));} _dispatch_trace_item_pushå‹æ ˆæ“ä½œï¼Œå°†æ‰§è¡Œä»»åŠ¡pushåˆ°é˜Ÿåˆ—ä¸­ï¼ŒæŒ‰ç…§FIFOæ‰§è¡Œ __DISPATCH_WAIT_FOR_QUEUE__æ˜¯å´©æºƒæ ˆçš„æœ€åä¸€ä¸ªå‡½æ•° 1234567891011121314DISPATCH_NOINLINEstatic void__DISPATCH_WAIT_FOR_QUEUE__(dispatch_sync_context_t dsc, dispatch_queue_t dq){ // è·å–é˜Ÿåˆ—çš„çŠ¶æ€ï¼Œçœ‹æ˜¯å¦æ˜¯å¤„äºç­‰å¾…çŠ¶æ€ uint64_t dq_state = _dispatch_wait_prepare(dq); if (unlikely(_dq_state_drain_locked_by(dq_state, dsc-&gt;dsc_waiter))) { // æ­»é”æŠ¥é”™ DISPATCH_CLIENT_CRASH((uintptr_t)dq_state, &quot;dispatch_sync called on queue &quot; &quot;already owned by current thread&quot;); } ...} 3.1.5.4 _dq_state_drain_locked_byåˆ¤æ–­é˜Ÿåˆ—å’Œçº¿ç¨‹çš„ç­‰å¾…çŠ¶æ€ï¼Œå¦‚æœä¸¤è€…éƒ½åœ¨ç­‰å¾…ï¼Œé‚£ä¹ˆå°±ä¼šè¿”å›YESï¼Œä»è€Œé€ æˆæ­»é”çš„å´©æºƒã€‚ 123456789101112131415DISPATCH_ALWAYS_INLINEstatic inline bool_dq_state_drain_locked_by(uint64_t dq_state, dispatch_tid tid){ return _dispatch_lock_is_locked_by((dispatch_lock)dq_state, tid);}DISPATCH_ALWAYS_INLINEstatic inline bool_dispatch_lock_is_locked_by(dispatch_lock lock_value, dispatch_tid tid){ // equivalent to _dispatch_lock_owner(lock_value) == tid // ^ (å¼‚æˆ–è¿ç®—æ³•) ä¸¤ä¸ªç›¸åŒå°±ä¼šå‡ºç° 0 å¦åˆ™ä¸º1 return ((lock_value ^ tid) &amp; DLOCK_OWNER_MASK) == 0;} 3.1.6 ä¸€å›¾æ€»ç»“æ­»é”è¿‡ç¨‹ _dispatch_syncé¦–å…ˆè·å–å½“å‰çº¿ç¨‹çš„tid è·å–åˆ°ç³»ç»Ÿåº•å±‚è¿”å›çš„status è·å–åˆ°é˜Ÿåˆ—çš„ç­‰å¾…çŠ¶æ€å’Œtidæ¯”è¾ƒï¼Œå¦‚æœç›¸åŒï¼Œåˆ™è¡¨ç¤ºæ­£åœ¨æ­»é”ï¼Œä»è€Œå´©æºƒ 3.2 block ä»»åŠ¡çš„æ‰§è¡Œåœ¨dispatch_blockå¤„æ‰“ä¸‹æ–­ç‚¹ï¼ŒLLDB è°ƒè¯•æ‰“å°å‡ºå‡½æ•°è°ƒç”¨æ ˆ ![image-20210519113421454](../../../../Library/Application Support/typora-user-images/image-20210519113421454.png) å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªé‡è¦çš„å‡½æ•°ï¼š _dispatch_lane_barrier_sync_invoke_and_complete _dispatch_client_callout æ¥ä¸‹æ¥è¿›è¡Œæºç è·Ÿè¸ªï¼š 3.2.1 dispatch_syncå¯¹äºåŒæ­¥ä»»åŠ¡blockçš„æ‰§è¡Œï¼ŒåŒæ ·æ˜¯ä»dispatch_syncå¼€å§‹è·Ÿè¿›ï¼š 123456789101112DISPATCH_NOINLINEvoiddispatch_sync(dispatch_queue_t dq, dispatch_block_t work){ uintptr_t dc_flags = DC_FLAG_BLOCK; if (unlikely(_dispatch_block_has_private_data(work))) { return _dispatch_sync_block_with_privdata(dq, work, dc_flags); } // âœ… _dispatch_sync_f(dq, work, _dispatch_Block_invoke(work), dc_flags);}#endif // __BLOCKS__ 3.2.2 _dispatch_sync_f1234567DISPATCH_NOINLINEstatic void_dispatch_sync_f(dispatch_queue_t dq, void *ctxt, dispatch_function_t func, uintptr_t dc_flags){ _dispatch_sync_f_inline(dq, ctxt, func, dc_flags);} 3.2.3 _dispatch_sync_f_inline123456789101112DISPATCH_ALWAYS_INLINEstatic inline void_dispatch_sync_f_inline(dispatch_queue_t dq, void *ctxt, dispatch_function_t func, uintptr_t dc_flags){ if (likely(dq-&gt;dq_width == 1)) { // ä¸²è¡Œé˜Ÿåˆ—èµ°è¿™é‡Œ return _dispatch_barrier_sync_f(dq, ctxt, func, dc_flags); } ...} 3.2.4 _dispatch_barrier_sync_f1234567DISPATCH_NOINLINEstatic void_dispatch_barrier_sync_f(dispatch_queue_t dq, void *ctxt, dispatch_function_t func, uintptr_t dc_flags){ _dispatch_barrier_sync_f_inline(dq, ctxt, func, dc_flags);} 3.2.5 _dispatch_barrier_sync_f_inline1234567891011DISPATCH_ALWAYS_INLINEstatic inline void_dispatch_barrier_sync_f_inline(dispatch_queue_t dq, void *ctxt, dispatch_function_t func, uintptr_t dc_flags){ ... _dispatch_lane_barrier_sync_invoke_and_complete(dl, ctxt, func DISPATCH_TRACE_ARG(_dispatch_trace_item_sync_push_pop( dq, ctxt, func, dc_flags | DC_FLAG_BARRIER)));} 3.2.6 _dispatch_lane_barrier_sync_invoke_and_complete è¿™ä¸ªå‡½æ•°å‡ºç°åœ¨æ‰“å°ä¸­ 12345678DISPATCH_NOINLINEstatic void_dispatch_lane_barrier_sync_invoke_and_complete(dispatch_lane_t dq, void *ctxt, dispatch_function_t func DISPATCH_TRACE_ARG(void *dc)){ _dispatch_sync_function_invoke_inline(dq, ctxt, func); ...} 3.2.7 _dispatch_sync_function_invoke_inline1234567891011DISPATCH_ALWAYS_INLINEstatic inline void_dispatch_sync_function_invoke_inline(dispatch_queue_class_t dq, void *ctxt, dispatch_function_t func){ dispatch_thread_frame_s dtf; _dispatch_thread_frame_push(&amp;dtf, dq); _dispatch_client_callout(ctxt, func); _dispatch_perfmon_workitem_inc(); _dispatch_thread_frame_pop(&amp;dtf);} 3.2.8 _dispatch_client_callout è¿™ä¸ªå‡½æ•°å‡ºç°åœ¨æ‰“å°ä¸­ 12345678910111213DISPATCH_NOINLINEvoid_dispatch_client_callout(void *ctxt, dispatch_function_t f){ _dispatch_get_tsd_base(); void *u = _dispatch_get_unwind_tsd(); if (likely(!u)) return f(ctxt); _dispatch_set_unwind_tsd(NULL); // âœ… f(ctxt); _dispatch_free_unwind_tsd(); _dispatch_set_unwind_tsd(u);} f(ctxt);å°±æ˜¯å›è°ƒå‡½æ•°çš„è°ƒç”¨ï¼Œè‡³æ­¤åŒæ­¥å‡½æ•°çš„blockè°ƒç”¨å®Œæˆã€‚ 3.2.9 æ€»ç»“åŒæ­¥å‡½æ•°blockä»»åŠ¡çš„æ‰§è¡Œ12345678dispatch_syncâ””â”€â”€_dispatch_sync_f â””â”€â”€_dispatch_sync_f_inline â””â”€â”€_dispatch_barrier_sync_f â””â”€â”€_dispatch_barrier_sync_f_inline â””â”€â”€_dispatch_lane_barrier_sync_invoke_and_complete â””â”€â”€_dispatch_sync_function_invoke_inline â””â”€â”€_dispatch_client_callout å››ã€å¼‚æ­¥æ‰§è¡Œ dispatch_async4.1 ä»»åŠ¡çš„ä¿å­˜è¿˜æ˜¯ä¸€æ ·çš„æ€è·¯ï¼Œè·Ÿåˆ°dispatch_asyncçš„æºç ä¸­ 4.1.1 dispatch_async12345678910voiddispatch_async(dispatch_queue_t dq, dispatch_block_t work){ dispatch_continuation_t dc = _dispatch_continuation_alloc(); uintptr_t dc_flags = DC_FLAG_CONSUME; dispatch_qos_t qos; qos = _dispatch_continuation_init(dc, dq, work, 0, dc_flags); _dispatch_continuation_async(dq, dc, qos, dc-&gt;dc_flags);} 4.1.2 _dispatch_continuation_init1234567891011121314151617181920212223DISPATCH_ALWAYS_INLINEstatic inline dispatch_qos_t_dispatch_continuation_init(dispatch_continuation_t dc, dispatch_queue_class_t dqu, dispatch_block_t work, dispatch_block_flags_t flags, uintptr_t dc_flags){ void *ctxt = _dispatch_Block_copy(work); dc_flags |= DC_FLAG_BLOCK | DC_FLAG_ALLOCATED; if (unlikely(_dispatch_block_has_private_data(work))) { dc-&gt;dc_flags = dc_flags; dc-&gt;dc_ctxt = ctxt; // will initialize all fields but requires dc_flags &amp; dc_ctxt to be set return _dispatch_continuation_init_slow(dc, dqu, flags); } // å°†ä»»åŠ¡è¿›è¡Œç»Ÿä¸€æ ¼å¼åŒ– dispatch_function_t func = _dispatch_Block_invoke(work); if (dc_flags &amp; DC_FLAG_CONSUME) { func = _dispatch_call_block_and_release; } return _dispatch_continuation_init_f(dc, dqu, ctxt, func, flags, dc_flags);} _dispatch_Block_invokeå°†ä»»åŠ¡è¿›è¡Œç»Ÿä¸€æ ¼å¼åŒ– 4.1.3 _dispatch_continuation_init_f123456789101112131415161718DISPATCH_ALWAYS_INLINEstatic inline dispatch_qos_t_dispatch_continuation_init_f(dispatch_continuation_t dc, dispatch_queue_class_t dqu, void *ctxt, dispatch_function_t f, dispatch_block_flags_t flags, uintptr_t dc_flags){ pthread_priority_t pp = 0; dc-&gt;dc_flags = dc_flags | DC_FLAG_ALLOCATED; dc-&gt;dc_func = f; dc-&gt;dc_ctxt = ctxt; // in this context DISPATCH_BLOCK_HAS_PRIORITY means that the priority // should not be propagated, only taken from the handler if it has one if (!(flags &amp; DISPATCH_BLOCK_HAS_PRIORITY)) { pp = _dispatch_priority_propagate(); } _dispatch_continuation_voucher_set(dc, flags); return _dispatch_continuation_priority_set(dc, dqu, pp, flags);} dc-&gt;dc_func = få°†blockä»»åŠ¡ ä¿å­˜ä¸‹æ¥ å¼‚æ­¥å‡½æ•°çš„ä»»åŠ¡ä¿å­˜æ‰¾åˆ°äº†ï¼Œé‚£å®ƒçš„ä»»åŠ¡åˆæ˜¯ä½•æ—¶æ‰§è¡Œçš„å‘¢ï¼Ÿä»¥åŠçº¿ç¨‹æ˜¯ä½•æ—¶åˆ›å»ºçš„ï¼Ÿ 4.2 çº¿ç¨‹çš„åˆ›å»º4.2.1 dispatch_async12345678910voiddispatch_async(dispatch_queue_t dq, dispatch_block_t work){ dispatch_continuation_t dc = _dispatch_continuation_alloc(); uintptr_t dc_flags = DC_FLAG_CONSUME; dispatch_qos_t qos; qos = _dispatch_continuation_init(dc, dq, work, 0, dc_flags); _dispatch_continuation_async(dq, dc, qos, dc-&gt;dc_flags);} 4.2.2 _dispatch_continuation_async1234567891011121314DISPATCH_ALWAYS_INLINEstatic inline void_dispatch_continuation_async(dispatch_queue_class_t dqu, dispatch_continuation_t dc, dispatch_qos_t qos, uintptr_t dc_flags){#if DISPATCH_INTROSPECTION if (!(dc_flags &amp; DC_FLAG_NO_INTROSPECTION)) { _dispatch_trace_item_push(dqu, dc); }#else (void)dc_flags;#endif return dx_push(dqu._dq, dc, qos);} 4.2.3 dx_pushæŸ¥çœ‹å…¶ä»£ç ï¼Œå‘ç°ä¸ºå®å®šä¹‰ï¼Œæ‰§è¡Œäº†dq_push 1#define dx_push(x, y, z) dx_vtable(x)-&gt;dq_push(x, y, z) é‚£ä¹ˆdq_pushåˆæ˜¯æ€ä¹ˆèµ‹å€¼çš„å‘¢ï¼Œç”±äºå…¶æ˜¯ä¸€ä¸ªå±æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æœç´¢.dq_pusæ¥æŸ¥çœ‹å…¶èµ‹å€¼ã€‚æˆ‘ä»¬å‘ç°å…¶èµ‹å€¼çš„åœ°æ–¹éå¸¸å¤šï¼Œä½†æ˜¯å¤§ä½“çš„æ„æ€æˆ‘ä»¬å¯ä»¥ç†è§£ï¼Œå°±æ˜¯ä¸»è¦åœ¨æ ¹é˜Ÿåˆ—ï¼Œè‡ªå®šä¹‰é˜Ÿåˆ—ï¼Œä¸»é˜Ÿåˆ—ç­‰ç­‰è¿›è¡Œpushæ“ä½œçš„æ—¶å€™è°ƒç”¨ã€‚ æˆ‘ä»¬çŸ¥é“çº¿ç¨‹çš„åˆ›å»ºä¸€èˆ¬éƒ½æ˜¯åœ¨æ ¹é˜Ÿåˆ—ä¸Šè¿›è¡Œåˆ›å»ºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥æ‰¾æ ¹é˜Ÿåˆ—çš„dq_pushèµ‹å€¼ï¼Œå³_dispatch_root_queue_pushï¼Œå› ä¸ºå®ƒæœ€åŸºæœ¬ï¼Œçœå»äº†æ—ææœ«èŠ‚ã€‚ é‚£ä¹ˆæ¥ä¸‹æ¥çš„æµç¨‹å°±æ˜¯ï¼š 123_dispatch_root_queue_push-&gt; _dispatch_root_queue_poke -&gt; _dispatch_root_queue_poke_slow 4.2.4 _dispatch_root_queue_push123456789101112131415161718192021222324252627282930313233343536373839404142DISPATCH_NOINLINEvoid_dispatch_root_queue_push(dispatch_queue_global_t rq, dispatch_object_t dou, dispatch_qos_t qos){#if DISPATCH_USE_KEVENT_WORKQUEUE dispatch_deferred_items_t ddi = _dispatch_deferred_items_get(); if (unlikely(ddi &amp;&amp; ddi-&gt;ddi_can_stash)) { dispatch_object_t old_dou = ddi-&gt;ddi_stashed_dou; dispatch_priority_t rq_overcommit; rq_overcommit = rq-&gt;dq_priority &amp; DISPATCH_PRIORITY_FLAG_OVERCOMMIT; if (likely(!old_dou._do || rq_overcommit)) { dispatch_queue_global_t old_rq = ddi-&gt;ddi_stashed_rq; dispatch_qos_t old_qos = ddi-&gt;ddi_stashed_qos; ddi-&gt;ddi_stashed_rq = rq; ddi-&gt;ddi_stashed_dou = dou; ddi-&gt;ddi_stashed_qos = qos; _dispatch_debug(&quot;deferring item %p, rq %p, qos %d&quot;, dou._do, rq, qos); if (rq_overcommit) { ddi-&gt;ddi_can_stash = false; } if (likely(!old_dou._do)) { return; } // push the previously stashed item qos = old_qos; rq = old_rq; dou = old_dou; } }#endif#if HAVE_PTHREAD_WORKQUEUE_QOS if (_dispatch_root_queue_push_needs_override(rq, qos)) { return _dispatch_root_queue_push_override(rq, dou, qos); }#else (void)qos;#endif _dispatch_root_queue_push_inline(rq, dou, dou, 1);} 4.2.5 _dispatch_root_queue_push_inline12345678910DISPATCH_ALWAYS_INLINEstatic inline void_dispatch_root_queue_push_inline(dispatch_queue_global_t dq, dispatch_object_t _head, dispatch_object_t _tail, int n){ struct dispatch_object_s *hd = _head._do, *tl = _tail._do; if (unlikely(os_mpsc_push_list(os_mpsc(dq, dq_items), hd, tl, do_next))) { return _dispatch_root_queue_poke(dq, n, 0); }} 4.2.6 _dispatch_root_queue_poke123456789101112131415161718192021DISPATCH_NOINLINEvoid_dispatch_root_queue_poke(dispatch_queue_global_t dq, int n, int floor){ if (!_dispatch_queue_class_probe(dq)) { return; }#if !DISPATCH_USE_INTERNAL_WORKQUEUE#if DISPATCH_USE_PTHREAD_POOL if (likely(dx_type(dq) == DISPATCH_QUEUE_GLOBAL_ROOT_TYPE))#endif { if (unlikely(!os_atomic_cmpxchg2o(dq, dgq_pending, 0, n, relaxed))) { _dispatch_root_queue_debug(&quot;worker thread request still pending &quot; &quot;for global queue: %p&quot;, dq); return; } }#endif // !DISPATCH_USE_INTERNAL_WORKQUEUE return _dispatch_root_queue_poke_slow(dq, n, floor);} 4.2.7 _dispatch_root_queue_poke_slow123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118DISPATCH_NOINLINEstatic void_dispatch_root_queue_poke_slow(dispatch_queue_global_t dq, int n, int floor){ int remaining = n; int r = ENOSYS; // âœ…é˜Ÿåˆ—åˆå§‹åŒ–ï¼Œruntimeå¼ºè½¬ç­‰æ“ä½œï¼Œé˜²æ­¢ç±»å‹æ— æ³•åŒ¹é…ç­‰æƒ…å†µ _dispatch_root_queues_init(); _dispatch_debug_root_queue(dq, __func__); _dispatch_trace_runtime_event(worker_request, dq, (uint64_t)n);#if !DISPATCH_USE_INTERNAL_WORKQUEUE#if DISPATCH_USE_PTHREAD_ROOT_QUEUES if (dx_type(dq) == DISPATCH_QUEUE_GLOBAL_ROOT_TYPE)#endif { _dispatch_root_queue_debug(&quot;requesting new worker thread for global &quot; &quot;queue: %p&quot;, dq); r = _pthread_workqueue_addthreads(remaining, _dispatch_priority_to_pp_prefer_fallback(dq-&gt;dq_priority)); (void)dispatch_assume_zero(r); return; }#endif // !DISPATCH_USE_INTERNAL_WORKQUEUE#if DISPATCH_USE_PTHREAD_POOL dispatch_pthread_root_queue_context_t pqc = dq-&gt;do_ctxt; if (likely(pqc-&gt;dpq_thread_mediator.do_vtable)) { while (dispatch_semaphore_signal(&amp;pqc-&gt;dpq_thread_mediator)) { _dispatch_root_queue_debug(&quot;signaled sleeping worker for &quot; &quot;global queue: %p&quot;, dq); if (!--remaining) { return; } } } bool overcommit = dq-&gt;dq_priority &amp; DISPATCH_PRIORITY_FLAG_OVERCOMMIT; if (overcommit) { os_atomic_add2o(dq, dgq_pending, remaining, relaxed); } else { if (!os_atomic_cmpxchg2o(dq, dgq_pending, 0, remaining, relaxed)) { _dispatch_root_queue_debug(&quot;worker thread request still pending for &quot; &quot;global queue: %p&quot;, dq); return; } } int can_request, t_count; // seq_cst with atomic store to tail &lt;rdar://problem/16932833&gt; // âœ…è·å–çº¿ç¨‹æ± çš„å¤§å° t_count = os_atomic_load2o(dq, dgq_thread_pool_size, ordered); do { // âœ…è®¡ç®—å¯ä»¥è¯·æ±‚çš„æ•°é‡ can_request = t_count &lt; floor ? 0 : t_count - floor; if (remaining &gt; can_request) { _dispatch_root_queue_debug(&quot;pthread pool reducing request from %d to %d&quot;, remaining, can_request); os_atomic_sub2o(dq, dgq_pending, remaining - can_request, relaxed); remaining = can_request; } if (remaining == 0) { // çº¿ç¨‹æ± æ— å¯ç”¨å°†ä¼šæŠ¥é”™ _dispatch_root_queue_debug(&quot;pthread pool is full for root queue: &quot; &quot;%p&quot;, dq); return; } } while (!os_atomic_cmpxchgvw2o(dq, dgq_thread_pool_size, t_count, t_count - remaining, &amp;t_count, acquire));#if !defined(_WIN32) pthread_attr_t *attr = &amp;pqc-&gt;dpq_thread_attr; pthread_t tid, *pthr = &amp;tid;#if DISPATCH_USE_MGR_THREAD &amp;&amp; DISPATCH_USE_PTHREAD_ROOT_QUEUES if (unlikely(dq == &amp;_dispatch_mgr_root_queue)) { pthr = _dispatch_mgr_root_queue_init(); }#endif do { _dispatch_retain(dq); // released in _dispatch_worker_thread // âœ…å¼€è¾Ÿçº¿ç¨‹âœ… while ((r = pthread_create(pthr, attr, _dispatch_worker_thread, dq))) { if (r != EAGAIN) { (void)dispatch_assume_zero(r); } _dispatch_temporary_resource_shortage(); } } while (--remaining);#else // defined(_WIN32)#if DISPATCH_USE_MGR_THREAD &amp;&amp; DISPATCH_USE_PTHREAD_ROOT_QUEUES if (unlikely(dq == &amp;_dispatch_mgr_root_queue)) { _dispatch_mgr_root_queue_init(); }#endif do { _dispatch_retain(dq); // released in _dispatch_worker_thread#if DISPATCH_DEBUG unsigned dwStackSize = 0;#else unsigned dwStackSize = 64 * 1024;#endif uintptr_t hThread = 0; while (!(hThread = _beginthreadex(NULL, dwStackSize, _dispatch_worker_thread_thunk, dq, STACK_SIZE_PARAM_IS_A_RESERVATION, NULL))) { if (errno != EAGAIN) { (void)dispatch_assume(hThread); } _dispatch_temporary_resource_shortage(); } if (_dispatch_mgr_sched.prio &gt; _dispatch_mgr_sched.default_prio) { (void)dispatch_assume_zero(SetThreadPriority((HANDLE)hThread, _dispatch_mgr_sched.prio) == TRUE); } CloseHandle((HANDLE)hThread); } while (--remaining);#endif // defined(_WIN32)#else (void)floor;#endif // DISPATCH_USE_PTHREAD_POOL} ç¬¬ä¸€ä¸ªdo-whileæ˜¯å¯¹æ ¸å¿ƒçº¿ç¨‹æ•°çš„åˆ¤æ–­ã€æ“ä½œç­‰ç­‰ ç¬¬äºŒä¸ªdo-whileè°ƒç”¨pthread_createåˆ›å»ºçº¿ç¨‹ï¼ˆåº•å±‚è¿˜æ˜¯ç”¨äº†pthreadï¼‰ 4.3 ä»»åŠ¡çš„æ‰§è¡Œ_dispatch_root_queue_poke_slowä¸­è°ƒç”¨äº†_dispatch_root_queues_init(); _dispatch_root_queues_init 12345678DISPATCH_STATIC_GLOBAL(dispatch_once_t _dispatch_root_queues_pred);DISPATCH_ALWAYS_INLINEstatic inline void_dispatch_root_queues_init(void){ dispatch_once_f(&amp;_dispatch_root_queues_pred, NULL, _dispatch_root_queues_init_once);} ä»»åŠ¡çš„æ‰§è¡Œå…¶å®åˆšæ‰å·²ç»è®²è¿‡äº† 1-&gt;dispatch_once_f-&gt;_dispatch_once_callout-&gt;_dispatch_client_callout åªä¸è¿‡ä»»åŠ¡åœ¨ç­‰å¾…çº¿ç¨‹çš„çŠ¶æ€ï¼Œè€Œçº¿ç¨‹æ€ä¹ˆæ‰§è¡Œä»»åŠ¡å°±ä¸å¾—è€ŒçŸ¥äº† 4.4 ä¸€å›¾æ€»ç»“å¼‚æ­¥å‡½æ•°æ‰§è¡Œæµç¨‹ äº”ã€ä¿¡å·é‡çš„åŸç†ä¿¡å·é‡çš„åŸºæœ¬ä½¿ç”¨æ˜¯è¿™æ ·çš„ï¼Œåº•å±‚åˆæ˜¯æ€ä¹ˆä¸ªåŸç†å‘¢ï¼Ÿ 12345dispatch_semaphore_t sem = dispatch_semaphore_create(M);dispatch_semaphore_signal(sem);dispatch_semaphore_wait(sem, DISPATCH_TIME_FOREVER); 5.1 dispatch_semaphore_createåªæ˜¯åˆå§‹åŒ–dispatch_semaphore_tï¼Œå†…éƒ¨è¿›è¡Œä¼ å€¼ä¿å­˜ï¼ˆvalueå¿…é¡»å¤§äº0ï¼‰ 123456789101112131415161718192021dispatch_semaphore_tdispatch_semaphore_create(long value){ dispatch_semaphore_t dsema; // If the internal value is negative, then the absolute of the value is // equal to the number of waiting threads. Therefore it is bogus to // initialize the semaphore with a negative value. if (value &lt; 0) { return DISPATCH_BAD_INPUT; } dsema = _dispatch_object_alloc(DISPATCH_VTABLE(semaphore), sizeof(struct dispatch_semaphore_s)); dsema-&gt;do_next = DISPATCH_OBJECT_LISTLESS; dsema-&gt;do_targetq = _dispatch_get_default_queue(false); dsema-&gt;dsema_value = value; _dispatch_sema4_init(&amp;dsema-&gt;dsema_sema, _DSEMA4_POLICY_FIFO); dsema-&gt;dsema_orig = value; return dsema;} 5.2 dispatch_semaphore_signalç±»ä¼¼KVCå½¢å¼ä»åº•å±‚å–å¾—å½“å‰ä¿¡å·é‡çš„valueå€¼ï¼Œå¹¶ä¸”è¿™ä¸ªå‡½æ•°æ˜¯æœ‰è¿”å›å€¼çš„ 12345678910111213longdispatch_semaphore_signal(dispatch_semaphore_t dsema){ long value = os_atomic_inc2o(dsema, dsema_value, release); if (likely(value &gt; 0)) { return 0; } if (unlikely(value == LONG_MIN)) { DISPATCH_CLIENT_CRASH(value, &quot;Unbalanced call to dispatch_semaphore_signal()&quot;); } return _dispatch_semaphore_signal_slow(dsema);} 12345678DISPATCH_NOINLINElong_dispatch_semaphore_signal_slow(dispatch_semaphore_t dsema){ _dispatch_sema4_create(&amp;dsema-&gt;dsema_sema, _DSEMA4_POLICY_FIFO); _dispatch_sema4_signal(&amp;dsema-&gt;dsema_sema, 1); return 1;} å…¶å®æœ€æ ¸å¿ƒçš„ç‚¹åœ¨äºos_atomic_inc2oè¿›è¡Œäº†++æ“ä½œ 123456#define os_atomic_inc2o(p, f, m) \\ os_atomic_add2o(p, f, 1, m)#define os_atomic_add2o(p, f, v, m) \\ os_atomic_add(&amp;(p)-&gt;f, (v), m)#define os_atomic_add(p, v, m) \\ _os_atomic_c11_op((p), (v), m, add, +) 5.3 dispatch_semaphore_waitåŒç†dispatch_semaphore_waitä¹Ÿæ˜¯å–valueå€¼ï¼Œå¹¶è¿”å›å¯¹åº”ç»“æœ value&gt;=0å°±ç«‹åˆ»è¿”å› value&lt;0æ ¹æ®ç­‰å¾…æ—¶é—´timeoutä½œå‡ºä¸åŒæ“ä½œ DISPATCH_TIME_NOWå°†valueåŠ ä¸€(ä¹Ÿå°±æ˜¯å˜ä¸º0)â€”â€”ä¸ºäº†æŠµæ¶ˆ wait å‡½æ•°ä¸€å¼€å§‹çš„å‡ä¸€æ“ä½œï¼Œå¹¶è¿”å›KERN_OPERATION_TIMED_OUTè¡¨ç¤ºç”±äºç­‰å¾…æ—¶é—´è¶…æ—¶ DISPATCH_TIME_FOREVERè°ƒç”¨ç³»ç»Ÿçš„semaphore_waitæ–¹æ³•ç»§ç»­ç­‰å¾…ï¼Œç›´åˆ°æ”¶åˆ°signalè°ƒç”¨ é»˜è®¤æƒ…å†µä¸DISPATCH_TIME_FOREVERç±»ä¼¼ï¼Œä¸è¿‡éœ€è¦æŒ‡å®šä¸€ä¸ªç­‰å¾…æ—¶é—´ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849longdispatch_semaphore_wait(dispatch_semaphore_t dsema, dispatch_time_t timeout){ long value = os_atomic_dec2o(dsema, dsema_value, acquire); if (likely(value &gt;= 0)) { return 0; } return _dispatch_semaphore_wait_slow(dsema, timeout);}DISPATCH_NOINLINEstatic long_dispatch_semaphore_wait_slow(dispatch_semaphore_t dsema, dispatch_time_t timeout){ long orig; _dispatch_sema4_create(&amp;dsema-&gt;dsema_sema, _DSEMA4_POLICY_FIFO); switch (timeout) { default: if (!_dispatch_sema4_timedwait(&amp;dsema-&gt;dsema_sema, timeout)) { break; } // Fall through and try to undo what the fast path did to // dsema-&gt;dsema_value case DISPATCH_TIME_NOW: orig = dsema-&gt;dsema_value; while (orig &lt; 0) { if (os_atomic_cmpxchgvw2o(dsema, dsema_value, orig, orig + 1, &amp;orig, relaxed)) { return _DSEMA4_TIMEOUT(); } } // Another thread called semaphore_signal(). // Fall through and drain the wakeup. case DISPATCH_TIME_FOREVER: _dispatch_sema4_wait(&amp;dsema-&gt;dsema_sema); break; } return 0;}// os_atomic_dec2o`è¿›è¡Œäº†`--æ“ä½œ#define os_atomic_dec2o(p, f, m) \\ os_atomic_sub2o(p, f, 1, m)#define os_atomic_sub2o(p, f, v, m) \\ os_atomic_sub(&amp;(p)-&gt;f, (v), m)#define os_atomic_sub(p, v, m) \\ _os_atomic_c11_op((p), (v), m, sub, -) å…­ã€è°ƒåº¦ç»„çš„åŸç†è°ƒåº¦ç»„çš„åŸºæœ¬ä½¿ç”¨å¦‚ä¸‹ 12345dispatch_group_t group = dispatch_group_create();dispatch_group_enter(group);dispatch_group_leave(group);dispatch_group_async(group, queue, ^{});dispatch_group_notify(group, queue, ^{}); 6.1 dispatch_group_createè·Ÿå…¶ä»–GCDå¯¹è±¡ä¸€æ ·ä½¿ç”¨_dispatch_object_allocç”Ÿæˆdispatch_group_tï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯å¼€è¾Ÿäº†å†…å­˜ç©ºé—´ã€‚ ä»os_atomic_store2oå¯ä»¥çœ‹å‡ºgroupåº•å±‚ä¹Ÿç»´æŠ¤äº†ä¸€ä¸ªvalueå€¼ 123456789101112131415161718192021dispatch_group_tdispatch_group_create(void){ return _dispatch_group_create_with_count(0);}DISPATCH_ALWAYS_INLINEstatic inline dispatch_group_t_dispatch_group_create_with_count(uint32_t n){ dispatch_group_t dg = _dispatch_object_alloc(DISPATCH_VTABLE(group), sizeof(struct dispatch_group_s)); dg-&gt;do_next = DISPATCH_OBJECT_LISTLESS; dg-&gt;do_targetq = _dispatch_get_default_queue(false); if (n) { os_atomic_store2o(dg, dg_bits, -n * DISPATCH_GROUP_VALUE_INTERVAL, relaxed); os_atomic_store2o(dg, do_ref_cnt, 1, relaxed); // &lt;rdar://22318411&gt; } return dg;} 6.2 dispatch_group_enter &amp; dispatch_group_leaveè¿™ä¸¤ä¸ªAPIä¸ä¿¡å·é‡çš„ä½¿ç”¨å¤§åŒå¼‚ï¼Œos_atomic_sub_orig2oã€os_atomic_add_orig2oè´Ÿè´£--ã€++æ“ä½œï¼Œå¦‚æœä¸æˆå¯¹ä½¿ç”¨åˆ™ä¼šå‡ºé”™ dispatch_group_leaveå‡ºç»„ä¼šå¯¹stateè¿›è¡Œæ›´æ–° å…¨éƒ¨å‡ºç»„äº†ä¼šè°ƒç”¨_dispatch_group_wake 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950voiddispatch_group_enter(dispatch_group_t dg){ // âœ…-- æ“ä½œ uint32_t old_bits = os_atomic_sub_orig2o(dg, dg_bits, DISPATCH_GROUP_VALUE_INTERVAL, acquire); uint32_t old_value = old_bits &amp; DISPATCH_GROUP_VALUE_MASK; if (unlikely(old_value == 0)) { _dispatch_retain(dg); // &lt;rdar://problem/22318411&gt; } if (unlikely(old_value == DISPATCH_GROUP_VALUE_MAX)) { DISPATCH_CLIENT_CRASH(old_bits, &quot;Too many nested calls to dispatch_group_enter()&quot;); }}voiddispatch_group_leave(dispatch_group_t dg){ // âœ…++ æ“ä½œ uint64_t new_state, old_state = os_atomic_add_orig2o(dg, dg_state, DISPATCH_GROUP_VALUE_INTERVAL, release); uint32_t old_value = (uint32_t)(old_state &amp; DISPATCH_GROUP_VALUE_MASK); if (unlikely(old_value == DISPATCH_GROUP_VALUE_1)) { old_state += DISPATCH_GROUP_VALUE_INTERVAL; do { new_state = old_state; if ((old_state &amp; DISPATCH_GROUP_VALUE_MASK) == 0) { new_state &amp;= ~DISPATCH_GROUP_HAS_WAITERS; new_state &amp;= ~DISPATCH_GROUP_HAS_NOTIFS; } else { // If the group was entered again since the atomic_add above, // we can't clear the waiters bit anymore as we don't know for // which generation the waiters are for new_state &amp;= ~DISPATCH_GROUP_HAS_NOTIFS; } if (old_state == new_state) break; } while (unlikely(!os_atomic_cmpxchgv2o(dg, dg_state, old_state, new_state, &amp;old_state, relaxed))); return _dispatch_group_wake(dg, old_state, true); } if (unlikely(old_value == 0)) { DISPATCH_CLIENT_CRASH((uintptr_t)old_value, &quot;Unbalanced call to dispatch_group_leave()&quot;); }} 6.3 dispatch_group_asyncdispatch_group_async å°±æ˜¯å¯¹ enter å’Œ leave çš„å°è£…ï¼Œå½“ block è°ƒç”¨å®Œæˆä¹‹åè¿›è¡Œ callout ä¹‹åå°±å‡ºç»„äº†ã€‚ 1234567891011121314151617181920212223242526272829303132333435voiddispatch_group_async(dispatch_group_t dg, dispatch_queue_t dq, dispatch_block_t db){ dispatch_continuation_t dc = _dispatch_continuation_alloc(); uintptr_t dc_flags = DC_FLAG_CONSUME | DC_FLAG_GROUP_ASYNC; dispatch_qos_t qos; // ä¿å­˜ä»»åŠ¡ qos = _dispatch_continuation_init(dc, dq, db, 0, dc_flags); _dispatch_continuation_group_async(dg, dq, dc, qos);}static inline void_dispatch_continuation_group_async(dispatch_group_t dg, dispatch_queue_t dq, dispatch_continuation_t dc, dispatch_qos_t qos){ // è¿›ç»„ dispatch_group_enter(dg); dc-&gt;dc_data = dg; _dispatch_continuation_async(dq, dc, qos, dc-&gt;dc_flags);}static inline void_dispatch_continuation_with_group_invoke(dispatch_continuation_t dc){ struct dispatch_object_s *dou = dc-&gt;dc_data; unsigned long type = dx_type(dou); if (type == DISPATCH_GROUP_TYPE) { _dispatch_client_callout(dc-&gt;dc_ctxt, dc-&gt;dc_func); _dispatch_trace_item_complete(dc); // å‡ºç»„ dispatch_group_leave((dispatch_group_t)dou); } else { DISPATCH_INTERNAL_CRASH(dx_type(dou), &quot;Unexpected object type&quot;); }} 6.4 dispatch_group_waitè¿™ä¸ªæ–¹æ³•ç”¨äºç­‰å¾… group ä¸­æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œå¯ä»¥ç†è§£ä¸ºä¿¡å·é‡ wait çš„å°è£…: 1234567891011121314151617181920longdispatch_group_wait(dispatch_group_t dg, dispatch_time_t timeout){ uint64_t old_state, new_state; os_atomic_rmw_loop2o(dg, dg_state, old_state, new_state, relaxed, { if ((old_state &amp; DISPATCH_GROUP_VALUE_MASK) == 0) { os_atomic_rmw_loop_give_up_with_fence(acquire, return 0); } if (unlikely(timeout == 0)) { os_atomic_rmw_loop_give_up(return _DSEMA4_TIMEOUT()); } new_state = old_state | DISPATCH_GROUP_HAS_WAITERS; if (unlikely(old_state &amp; DISPATCH_GROUP_HAS_WAITERS)) { os_atomic_rmw_loop_give_up(break); } }); return _dispatch_group_wait_slow(dg, _dg_state_gen(new_state), timeout);} å¦‚æœå½“å‰ value å’ŒåŸå§‹ value ç›¸åŒï¼Œè¡¨æ˜ä»»åŠ¡å·²ç»å…¨éƒ¨å®Œæˆï¼Œç›´æ¥è¿”å› 0ï¼Œå¦‚æœ timeout ä¸º 0 ä¹Ÿä¼šç«‹åˆ»è¿”å›ï¼Œå¦åˆ™è°ƒç”¨ _dispatch_group_wait_slowã€‚ åœ¨ _dispatch_group_wait_slow ä¼šä¸€ç›´ç­‰åˆ°ä»»åŠ¡å®Œæˆè¿”å› 0 ï¼Œå½“ç„¶å¦‚æœä¸€ç›´æ²¡æœ‰å®Œæˆå°±ä¼šè¿”å› timeoutã€‚ 6.5 dispatch_group_notifyç­‰å¾…_dispatch_group_wakeå›è°ƒï¼ˆå…¨éƒ¨å‡ºç»„ä¼šè°ƒç”¨ï¼‰ 1234567891011121314151617181920212223242526DISPATCH_ALWAYS_INLINEstatic inline void_dispatch_group_notify(dispatch_group_t dg, dispatch_queue_t dq, dispatch_continuation_t dsn){ uint64_t old_state, new_state; dispatch_continuation_t prev; dsn-&gt;dc_data = dq; _dispatch_retain(dq); prev = os_mpsc_push_update_tail(os_mpsc(dg, dg_notify), dsn, do_next); if (os_mpsc_push_was_empty(prev)) _dispatch_retain(dg); os_mpsc_push_update_prev(os_mpsc(dg, dg_notify), prev, dsn, do_next); if (os_mpsc_push_was_empty(prev)) { os_atomic_rmw_loop2o(dg, dg_state, old_state, new_state, release, { new_state = old_state | DISPATCH_GROUP_HAS_NOTIFS; if ((uint32_t)old_state == 0) { os_atomic_rmw_loop_give_up({ // âœ… return _dispatch_group_wake(dg, new_state, false); }); } }); }} 6.6 dispatch_group_wakeè¿™ä¸ªå‡½æ•°ä¸»è¦åšçš„å°±æ˜¯å¾ªç¯è°ƒç”¨ dispatch_async_f å¼‚æ­¥æ‰§è¡Œåœ¨ notify å‡½æ•°ä¸­æ³¨å†Œçš„å›è°ƒã€‚ 12345678910111213141516171819202122232425static void_dispatch_group_wake(dispatch_group_t dg, uint64_t dg_state, bool needs_release){ uint16_t refs = needs_release ? 1 : 0; // &lt;rdar://problem/22318411&gt; if (dg_state &amp; DISPATCH_GROUP_HAS_NOTIFS) { dispatch_continuation_t dc, next_dc, tail; // Snapshot before anything is notified/woken dc = os_mpsc_capture_snapshot(os_mpsc(dg, dg_notify), &amp;tail); do { dispatch_queue_t dsn_queue = (dispatch_queue_t)dc-&gt;dc_data; next_dc = os_mpsc_pop_snapshot_head(dc, tail, do_next); _dispatch_continuation_async(dsn_queue, dc, _dispatch_qos_from_pp(dc-&gt;dc_priority), dc-&gt;dc_flags); _dispatch_release(dsn_queue); } while ((dc = next_dc)); refs++; } if (dg_state &amp; DISPATCH_GROUP_HAS_WAITERS) { _dispatch_wake_by_address(&amp;dg-&gt;dg_gen); } if (refs) _dispatch_release_n(dg, refs);} ä¸ƒã€å•ä¾‹çš„åŸç†123456789101112131415161718192021222324252627282930#define DLOCK_ONCE_UNLOCKED ((uintptr_t)0)voiddispatch_once_f(dispatch_once_t *val, void *ctxt, dispatch_function_t func){ // å¦‚æœä½ æ¥è¿‡ä¸€æ¬¡ -- ä¸‹æ¬¡å°±ä¸æ¥ dispatch_once_gate_t l = (dispatch_once_gate_t)val; #if !DISPATCH_ONCE_INLINE_FASTPATH || DISPATCH_ONCE_USE_QUIESCENT_COUNTER uintptr_t v = os_atomic_load(&amp;l-&gt;dgo_once, acquire); if (likely(v == DLOCK_ONCE_DONE)) { return; } #if DISPATCH_ONCE_USE_QUIESCENT_COUNTER if (likely(DISPATCH_ONCE_IS_GEN(v))) { return _dispatch_once_mark_done_if_quiesced(l, v); } #endif #endif if (_dispatch_once_gate_tryenter(l)) { return _dispatch_once_callout(l, ctxt, func); } return _dispatch_once_wait(l);}DISPATCH_ALWAYS_INLINEstatic inline bool_dispatch_once_gate_tryenter(dispatch_once_gate_t l){ return os_atomic_cmpxchg(&amp;l-&gt;dgo_once, DLOCK_ONCE_UNLOCKED, (uintptr_t)_dispatch_lock_value_for_self(), relaxed);} ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶å¤–éƒ¨ä¼ è¿›æ¥çš„onceTokenä¸ºç©ºï¼Œæ‰€ä»¥valä¸ºNULL _dispatch_once_gate_tryenter(l)åˆ¤æ–­l-&gt;dgo_onceæ˜¯å¦æ ‡è®°ä¸ºDLOCK_ONCE_UNLOCKEDï¼ˆæ˜¯å¦å­˜å‚¨è¿‡ï¼‰ DLOCK_ONCE_UNLOCKED=0ï¼Œæ‰€ä»¥if åˆ¤æ–­æ˜¯æˆç«‹çš„ï¼Œå°±ä¼šè¿›è¡Œblockå›è°ƒ å†é€šè¿‡_dispatch_once_gate_broadcastå°†l-&gt;dgo_onceæ ‡è®°ä¸ºDLOCK_ONCE_DONE ç¬¬äºŒæ¬¡è¿›æ¥å°±ä¼šç›´æ¥è¿”å›ï¼Œä¿è¯ä»£ç åªæ‰§è¡Œä¸€æ¬¡ å…«ã€æ€»ç»“æœ¬æ–‡ä¸»è¦æ•´ç†äº† GCD ä¸­å¸¸è§çš„ API ä»¥åŠåº•å±‚çš„å®ç°åŸç†ã€‚ dispatch_sync å°†ä»»åŠ¡ block é€šè¿‡ push åˆ°é˜Ÿåˆ—ä¸­ï¼Œç„¶åæŒ‰ç…§ FIFO å»æ‰§è¡Œã€‚ dispatch_async ä¼šæŠŠä»»åŠ¡åŒ…è£…å¹¶ä¿å­˜ï¼Œä¹‹åå°±ä¼šå¼€è¾Ÿç›¸åº”çº¿ç¨‹å»æ‰§è¡Œå·²ä¿å­˜çš„ä»»åŠ¡ã€‚ semaphore ä¸»è¦ä½¿ç”¨ signal å’Œ wait è¿™ä¸¤ä¸ªæ¥å£ï¼Œåº•å±‚åˆ†åˆ«è°ƒç”¨äº†å†…æ ¸æä¾›çš„æ–¹æ³•ã€‚åœ¨è°ƒç”¨ signal æ–¹æ³•åï¼Œå…ˆå°† value å‡ä¸€ï¼Œå¦‚æœå¤§äºé›¶ç«‹åˆ»è¿”å›ï¼Œå¦åˆ™é™·å…¥ç­‰å¾…ã€‚signal æ–¹æ³•å°†ä¿¡å·é‡åŠ ä¸€ï¼Œå¦‚æœ value å¤§äºé›¶ç«‹åˆ»è¿”å›ï¼Œå¦åˆ™è¯´æ˜å”¤é†’äº†æŸä¸€ä¸ªç­‰å¾…çº¿ç¨‹ï¼Œæ­¤æ—¶ç”±ç³»ç»Ÿå†³å®šå“ªä¸ªçº¿ç¨‹çš„ç­‰å¾…æ–¹æ³•å¯ä»¥è¿”å›ã€‚ dispatch_group åº•å±‚ä¹Ÿæ˜¯ç»´æŠ¤äº†ä¸€ä¸ª value çš„å€¼ï¼Œç­‰å¾… group å®Œæˆå®é™…ä¸Šå°±æ˜¯ç­‰å¾… value æ¢å¤åˆå§‹å€¼ã€‚è€Œ notify çš„ä½œç”¨æ˜¯å°†æ‰€æœ‰æ³¨å†Œçš„å›è°ƒç»„è£…æˆä¸€ä¸ªé“¾è¡¨ï¼Œåœ¨ dispatch_async å®Œæˆæ—¶åˆ¤æ–­ value æ˜¯ä¸æ˜¯æ¢å¤åˆå§‹å€¼ï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨ dispatch_async å¼‚æ­¥æ‰§è¡Œæ‰€æœ‰æ³¨å†Œçš„å›è°ƒã€‚ dispatch_once é€šè¿‡ä¸€ä¸ªé™æ€å˜é‡æ¥æ ‡è®° block æ˜¯å¦å·²è¢«æ‰§è¡Œï¼ŒåŒæ—¶ä½¿ç”¨åŠ é”ç¡®ä¿åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œï¼Œæ‰§è¡Œå®Œ block åä¼šå”¤é†’å…¶ä»–æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ã€‚ PSæˆ‘ç”¨çš„libdispatchæºç  è‹¹æœå®˜ç½‘çš„libdispatchæºç  å‚è€ƒiOS GCDæºç æµ…æ iOSåº•å±‚å­¦ä¹  - å¤šçº¿ç¨‹ä¹‹GCDé˜Ÿåˆ—åŸç†ç¯‡","link":"/2021/05/18/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/18-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BGCD%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/"},{"title":"ã€Šä¹Œåˆä¹‹ä¼—ã€‹è¯»ä¹¦ç¬”è®°","text":"","link":"/2021/07/03/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E3%80%8A%E4%B9%8C%E5%90%88%E4%B9%8B%E4%BC%97%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"},{"title":"19-é”","text":"ä¸€ã€é”1.1 çº¿ç¨‹å®‰å…¨å½“ä¸€ä¸ªçº¿ç¨‹è®¿é—®æ•°æ®çš„æ—¶å€™ï¼Œå…¶ä»–çš„çº¿ç¨‹ä¸èƒ½å¯¹å…¶è¿›è¡Œè®¿é—®ï¼Œç›´åˆ°è¯¥çº¿ç¨‹è®¿é—®å®Œæ¯•ã€‚ æ¢å¥è¯è¯´å°±æ˜¯åœ¨åŒä¸€æ—¶åˆ»ï¼Œå¯¹åŒä¸€ä¸ªæ•°æ®æ“ä½œçš„çº¿ç¨‹åªæœ‰ä¸€ä¸ªã€‚ è€Œçº¿ç¨‹ä¸å®‰å…¨ï¼Œåˆ™æ˜¯åœ¨åŒä¸€æ—¶åˆ»å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹å¯¹è¯¥æ•°æ®è¿›è¡Œè®¿é—®ï¼Œä»è€Œå¾—ä¸åˆ°é¢„æœŸçš„ç»“æœ 1.2 æ£€æµ‹å®‰å…¨ 1.3 é”çš„ä½œç”¨é”ä½œä¸ºä¸€ç§éå¼ºåˆ¶çš„æœºåˆ¶ï¼Œè¢«ç”¨æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚æ¯ä¸€ä¸ªçº¿ç¨‹åœ¨è®¿é—®æ•°æ®æˆ–è€…èµ„æºå‰ï¼Œè¦å…ˆè·å–ï¼ˆAcquireï¼‰é”ï¼Œå¹¶åœ¨è®¿é—®ç»“æŸä¹‹åé‡Šæ”¾ï¼ˆReleaseï¼‰é”ã€‚å¦‚æœé”å·²ç»è¢«å ç”¨ï¼Œå…¶å®ƒè¯•å›¾è·å–é”çš„çº¿ç¨‹ä¼šç­‰å¾…ï¼Œç›´åˆ°é”é‡æ–°å¯ç”¨ 1.4 é”çš„åˆ†ç±»åœ¨iOSä¸­é”çš„åŸºæœ¬ç§ç±»åªæœ‰ä¸¤ç§ï¼šè‡ªæ—‹é”ã€äº’æ–¥é”ï¼Œå…¶ä»–çš„æ¯”å¦‚æ¡ä»¶é”ã€é€’å½’é”ã€ä¿¡å·é‡éƒ½æ˜¯ä¸Šå±‚çš„å°è£…å’Œå®ç° 1.5 è‡ªæ—‹é”è‡ªæ—‹é”ï¼šçº¿ç¨‹==åå¤æ£€æŸ¥==é”å˜é‡æ˜¯å¦å¯â½¤ã€‚â¼€æ—¦è·å–äº†â¾ƒæ—‹é”ï¼Œçº¿ç¨‹ä¼šâ¼€ç›´ä¿æŒè¯¥é”ï¼Œç›´â¾„æ˜¾å¼é‡Šæ”¾â¾ƒæ—‹é” 1.6 äº’æ–¥é”äº’æ–¥é”(Mutual exclusionï¼Œç¼©å†™Mutex)é˜²æ­¢ä¸¤æ¡çº¿ç¨‹åŒæ—¶å¯¹åŒä¸€å…¬å…±èµ„æº(æ¯”å¦‚å…¨å±€å˜é‡)è¿›è¡Œè¯»å†™çš„æœºåˆ¶ã€‚å½“è·å–é”æ“ä½œå¤±è´¥æ—¶ï¼Œçº¿ç¨‹ä¼šè¿›å…¥==ç¡çœ ==ï¼Œç­‰å¾…é”é‡Šæ”¾æ—¶è¢«å”¤é†’ äº’æ–¥é”åˆåˆ†ä¸ºï¼š é€’å½’é”ï¼šå¯é‡å…¥ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹åœ¨é”é‡Šæ”¾å‰å¯å†æ¬¡è·å–é”ï¼Œå³å¯ä»¥é€’å½’è°ƒç”¨ éé€’å½’é”ï¼šä¸å¯é‡å…¥ï¼Œå¿…é¡»ç­‰é”é‡Šæ”¾åæ‰èƒ½å†æ¬¡è·å–é” 1.7 è‡ªæ—‹é”å’Œäº’æ–¥é”çš„åŒºåˆ« è‡ªæ—‹é”åœ¨çº¿ç¨‹è·å–é”ä½†æ²¡æœ‰è·å–åˆ°æ—¶ï¼Œçº¿ç¨‹åˆ™ä¼šä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ï¼ˆå¿™ç­‰å¾…ï¼‰ï¼Œä¸ä¼šè¿›å…¥ä¼‘çœ  äº’æ–¥é”åœ¨çº¿ç¨‹è·å–é”ä½†æ²¡æœ‰è·å–åˆ°æ—¶ï¼Œçº¿ç¨‹ä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œç­‰é”è¢«é‡Šæ”¾æ—¶çº¿ç¨‹ä¼šè¢«å”¤é†’ äºŒã€è‡ªæ—‹é”2.1 OSSpinLockï¼ˆåºŸå¼ƒï¼‰è‡ªä»OSSpinLockå‡ºç°äº†å®‰å…¨é—®é¢˜ä¹‹åå°±åºŸå¼ƒäº†ã€‚ 2.2 atomic2.2.1 atomicåŸç†åœ¨13-KVCåŸç†ä¸­æåˆ°è‡ªåŠ¨ç”Ÿæˆçš„ setter æ–¹æ³•ä¼šæ ¹æ®ä¿®é¥°ç¬¦ä¸åŒè°ƒç”¨ä¸åŒæ–¹æ³•ï¼Œæœ€åç»Ÿä¸€è°ƒç”¨reallySetPropertyæ–¹æ³•ï¼Œå…¶ä¸­å°±æœ‰ä¸€æ®µå…³äºatomicä¿®é¥°è¯çš„ä»£ç  1234567891011121314151617181920212223242526272829303132static inline void reallySetProperty(id self, SEL _cmd, id newValue, ptrdiff_t offset, bool atomic, bool copy, bool mutableCopy){ if (offset == 0) { object_setClass(self, newValue); return; } id oldValue; id *slot = (id*) ((char*)self + offset); if (copy) { newValue = [newValue copyWithZone:nil]; } else if (mutableCopy) { newValue = [newValue mutableCopyWithZone:nil]; } else { if (*slot == newValue) return; newValue = objc_retain(newValue); } if (!atomic) { // nonatomic ä¿®é¥°çš„å±æ€§ä¸ä¼šåŠ é”ï¼Œç›´æ¥èµ‹å€¼ oldValue = *slot; *slot = newValue; } else { // atomic ä¿®é¥°çš„å±æ€§ä¼šåŠ é” spinlock_t&amp; slotlock = PropertyLocks[slot]; slotlock.lock(); oldValue = *slot; *slot = newValue; slotlock.unlock(); } objc_release(oldValue);} æ¯”å¯¹ä¸€ä¸‹atomicçš„é€»è¾‘åˆ†æ”¯ï¼š åŸå­æ€§ä¿®é¥°çš„å±æ€§è¿›è¡Œäº†spinlockåŠ é”å¤„ç† éåŸå­æ€§çš„å±æ€§é™¤äº†æ²¡åŠ é”ï¼Œå…¶ä»–é€»è¾‘ä¸atomicä¸€èˆ¬æ— äºŒ getteræ–¹æ³•äº¦æ˜¯å¦‚æ­¤ï¼šå¯¹ atomic ä¿®é¥°çš„å±æ€§è¿›è¡ŒåŠ é”å¤„ç† 123456789101112131415161718id objc_getProperty(id self, SEL _cmd, ptrdiff_t offset, BOOL atomic) { if (offset == 0) { return object_getClass(self); } // Retain release world id *slot = (id*) ((char*)self + offset); if (!atomic) return *slot; // Atomic retain release world spinlock_t&amp; slotlock = PropertyLocks[slot]; slotlock.lock(); id value = objc_retain(*slot); slotlock.unlock(); // for performance, we (safely) issue the autorelease OUTSIDE of the spinlock. return objc_autoreleaseReturnValue(value);} 2.2.2 atomicä¿®é¥°çš„å±æ€§ç»å¯¹å®‰å…¨å—ï¼Ÿatomicåªèƒ½ä¿è¯ setterã€getter æ–¹æ³•çš„çº¿ç¨‹å®‰å…¨ï¼Œå¹¶ä¸èƒ½ä¿è¯æ•°æ®å®‰å…¨ã€‚ä¾‹ï¼š å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè¢«atomicä¿®é¥°çš„indexå˜é‡åˆ†åˆ«åœ¨ä¸¤æ¬¡å¹¶å‘å¼‚æ­¥forå¾ªç¯10000æ¬¡åè¾“å‡ºçš„ç»“æœå¹¶ä¸ç­‰äº20000ï¼Œå‡ºç°äº†çº¿ç¨‹ä¸å®‰å…¨çš„æƒ…å†µã€‚ æ‰€ä»¥ï¼š atomicä¿è¯å˜é‡ setterã€getter æ–¹æ³•çš„çº¿ç¨‹å®‰å…¨ ä½†ä¸èƒ½ä¿è¯self.index+1ä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„ ä½¿ç”¨æ—¶è¿˜æ˜¯è¦éå¸¸å°å¿ƒçš„ï¼Œä¸è¦å¤©çœŸçš„ä»¥ä¸ºå±æ€§åŠ äº†atomicåå°±å®‰å…¨çš„ä¸è¡Œäº† 2.3 è¯»å†™é”è¯»å†™é”å®é™…æ˜¯ä¸€ç§ç‰¹æ®Šçš„è‡ªæ—‹é”ï¼Œå®ƒæŠŠå¯¹å…±äº«èµ„æºçš„è®¿é—®è€…åˆ’åˆ†æˆè¯»è€…å’Œå†™è€…ã€‚ è¯»è€…åªå¯¹å…±äº«èµ„æºè¿›è¡Œè¯»è®¿é—®ï¼Œå†™è€…åˆ™éœ€è¦å¯¹å…±äº«èµ„æºè¿›è¡Œå†™æ“ä½œã€‚ ä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å æœ‰å†™æ¨¡å¼ï¼Œä½†æ˜¯å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶å æœ‰è¯»æ¨¡å¼çš„è¯»å†™é”ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„å¤šè¯»å•å†™ã€‚å³è¯»è€…ä¹‹é—´æ˜¯å¹¶å‘çš„ï¼Œå†™è€…ä¸å…¶ä»–å†™è€…ã€è¯»è€…ä¹‹é—´æ˜¯äº’æ–¥çš„ 12345678910111213- (id)readDataForKey:(NSString*)key { __block id result; dispatch_sync(_concurrentQueue, ^{ result = [self valueForKey:key]; }); return result;}- (void)writeData:(id)data forKey:(NSString*)key { dispatch_barrier_async(_concurrentQueue, ^{ [self setValue:data forKey:key]; });} è¯»ï¼šå¹¶å‘åŒæ­¥è·å–åˆ°å€¼åè¿”å›ç»™è¯»è€… è‹¥ä½¿ç”¨å¹¶å‘å¼‚æ­¥åˆ™ä¼šå…ˆè¿”å›ç©ºçš„result 0x0ï¼Œå†é€šè¿‡getteræ–¹æ³•è·å–åˆ°å€¼ å†™ï¼šå†™çš„é‚£ä¸ªæ—¶é—´æ®µï¼Œä¸èƒ½æœ‰ä»»ä½•è¯»è€…+å…¶ä»–å†™è€… dispatch_barrier_asyncæ»¡è¶³ï¼šç­‰é˜Ÿåˆ—ä¸­å‰é¢çš„è¯»å†™ä»»åŠ¡éƒ½æ‰§è¡Œå®Œäº†å†æ¥æ‰§è¡Œå½“å‰ä»»åŠ¡ ä¸‰ã€äº’æ–¥é”3.1 pthread_mutexå½“é”è¢«å ç”¨ï¼Œè€Œå…¶ä»–çº¿ç¨‹ç”³è¯·é”æ—¶ï¼Œä¸æ˜¯ä½¿ç”¨å¿™ç­‰ï¼Œè€Œæ˜¯é˜»å¡çº¿ç¨‹å¹¶ç¡çœ ã€‚ ä½¿ç”¨å¦‚ä¸‹ï¼š 1234567891011121314151617181920// å¯¼å…¥å¤´æ–‡ä»¶#import &lt;pthread.h&gt;// å…¨å±€å£°æ˜äº’æ–¥é”pthread_mutex_t _lock;// åˆå§‹åŒ–äº’æ–¥é”pthread_mutex_init(&amp;_lock, NULL);// åŠ é”pthread_mutex_lock(&amp;_lock);// è¿™é‡Œåšéœ€è¦çº¿ç¨‹å®‰å…¨æ“ä½œ// ...// è§£é” pthread_mutex_unlock(&amp;_lock);// é‡Šæ”¾é”pthread_mutex_destroy(&amp;_lock); YYKitçš„YYMemoryCachæœ‰ä½¿ç”¨åˆ°pthread_mutex 3.2 @synchronized@synchronizedå¯èƒ½æ˜¯æ—¥å¸¸å¼€å‘ä¸­ç”¨çš„æ¯”è¾ƒå¤šçš„ä¸€ç§äº’æ–¥é”ï¼Œå› ä¸ºå®ƒçš„ä½¿ç”¨æ¯”è¾ƒç®€å•ï¼Œä½†å¹¶ä¸æ˜¯åœ¨ä»»æ„åœºæ™¯ä¸‹éƒ½èƒ½ä½¿ç”¨@synchronizedï¼Œä¸”å®ƒçš„æ€§èƒ½è¾ƒä½ 123@synchronized (obj) { // è¿™é‡Œåšéœ€è¦çº¿ç¨‹å®‰å…¨çš„æ“ä½œ} æ¥ä¸‹æ¥å°±é€šè¿‡æºç æ¢ç´¢æ¥çœ‹ä¸€ä¸‹@synchronizedåœ¨ä½¿ç”¨ä¸­çš„æ³¨æ„äº‹é¡¹ é€šè¿‡æ±‡ç¼–èƒ½èƒ½å®šä½åˆ°objc_sync_enterå’Œobjc_sync_exitä¸¤ä¸ªæ–¹æ³• 3.2.1 æºç åˆ†æåœ¨objcæºç ä¸­æ‰¾åˆ°objc_sync_enterå’Œobjc_sync_exit 1234567891011121314151617181920212223242526272829303132333435363738394041424344// Begin synchronizing on 'obj'. // Allocates recursive mutex associated with 'obj' if needed.// Returns OBJC_SYNC_SUCCESS once lock is acquired. int objc_sync_enter(id obj){ int result = OBJC_SYNC_SUCCESS; if (obj) { SyncData* data = id2data(obj, ACQUIRE); assert(data); data-&gt;mutex.lock(); } else { // @synchronized(nil) does nothing if (DebugNilSync) { _objc_inform(&quot;NIL SYNC DEBUG: @synchronized(nil); set a breakpoint on objc_sync_nil to debug&quot;); } objc_sync_nil(); } return result;}// End synchronizing on 'obj'. // Returns OBJC_SYNC_SUCCESS or OBJC_SYNC_NOT_OWNING_THREAD_ERRORint objc_sync_exit(id obj){ int result = OBJC_SYNC_SUCCESS; if (obj) { SyncData* data = id2data(obj, RELEASE); if (!data) { result = OBJC_SYNC_NOT_OWNING_THREAD_ERROR; } else { bool okay = data-&gt;mutex.tryUnlock(); if (!okay) { result = OBJC_SYNC_NOT_OWNING_THREAD_ERROR; } } } else { // @synchronized(nil) does nothing } return result;} é¦–å…ˆä»å®ƒçš„æ³¨é‡Šä¸­recursive mutexå¯ä»¥å¾—å‡º@synchronizedæ˜¯é€’å½’é” å¦‚æœé”çš„å¯¹è±¡objä¸å­˜åœ¨æ—¶åˆ†åˆ«ä¼šèµ°objc_sync_nil()å’Œä¸åšä»»ä½•æ“ä½œ è¿™ä¹Ÿæ˜¯@synchronizedä½œä¸ºé€’å½’é”ä½†èƒ½é˜²æ­¢æ­»é”çš„åŸå› æ‰€åœ¨ï¼šåœ¨ä¸æ–­é€’å½’çš„è¿‡ç¨‹ä¸­å¦‚æœå¯¹è±¡ä¸å­˜åœ¨äº†å°±ä¼šåœæ­¢é€’å½’ä»è€Œé˜²æ­¢æ­»é” 123BREAKPOINT_FUNCTION( void objc_sync_nil(void)); æ­£å¸¸æƒ…å†µä¸‹ï¼ˆobj å­˜åœ¨ï¼‰ä¼šé€šè¿‡id2dataæ–¹æ³•ç”Ÿæˆä¸€ä¸ªSyncDataå¯¹è±¡ 123456typedef struct alignas(CacheLineSize) SyncData { struct SyncData* nextData; // é“¾è¡¨ä¸­ä¸‹ä¸€ä¸ª SyncData DisguisedPtr&lt;objc_object&gt; object; // å½“å‰åŠ é”çš„å¯¹è±¡ int32_t threadCount; // ä½¿ç”¨è¯¥å¯¹è±¡è¿›è¡ŒåŠ é”çš„çº¿ç¨‹æ•° recursive_mutex_t mutex; // å¯¹è±¡æ‰€å…³è”çš„é”} SyncData; 3.2.2 id2dataæ–¹æ³•å‡†å¤‡SyncData1234567static SyncData* id2data(id object, enum usage why){ spinlock_t *lockp = &amp;LOCK_FOR_OBJ(object); SyncData **listp = &amp;LIST_FOR_OBJ(object); SyncData* result = NULL; // å‡†å¤‡æ•°æ®ï¼Œåç»­è¿›è¡Œå¡«å…… ...} id2dataå…ˆå°†è¿”å›å¯¹è±¡SyncDataç±»å‹çš„resultå‡†å¤‡å¥½ï¼Œåç»­è¿›è¡Œæ•°æ®å¡«å……ã€‚ çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•å¼€å¤´çš„ä¸¤ä¸ªå®ï¼š 1234567891011#define LOCK_FOR_OBJ(obj) sDataLists[obj].lock#define LIST_FOR_OBJ(obj) sDataLists[obj].datastatic StripedMap&lt;SyncList&gt; sDataLists;struct SyncList { SyncData *data; spinlock_t lock; constexpr SyncList() : data(nil), lock(fork_unsafe_lock) { }}; å…¶ä¸­é€šè¿‡ä¸¤ä¸ªå®å®šä¹‰å»å–å¾—SyncListä¸­çš„dataå’Œlockã€‚ æ—¢ç„¶@synchronizedèƒ½åœ¨ä»»æ„åœ°æ–¹ï¼ˆVCã€Viewã€Modelç­‰ï¼‰ä½¿ç”¨ï¼Œé‚£ä¹ˆåº•å±‚å¿…ç„¶ç»´æŠ¤ç€ä¸€å¼ å…¨å±€çš„è¡¨ï¼ˆç±»ä¼¼äº weak è¡¨ï¼‰ã€‚è€Œä»SyncListå’ŒSyncDataçš„ç»“æ„å¯ä»¥è¯å®ç³»ç»Ÿç¡®å®åœ¨åº•å±‚ç»´æŠ¤ç€ä¸€å¼ å“ˆå¸Œè¡¨ï¼Œé‡Œé¢å­˜å‚¨ç€SyncListç»“æ„çš„æ•°æ®ã€‚sDataListsè¡¨ç»“æ„ï¼š 3.2.3 ä½¿ç”¨å¿«é€Ÿç¼“å­˜123456789101112131415161718192021222324252627282930313233343536373839404142434445464748static SyncData* id2data(id object, enum usage why){ ...#if SUPPORT_DIRECT_THREAD_KEYS // Check per-thread single-entry fast cache for matching object // æ£€æŸ¥æ¯çº¿ç¨‹å•é¡¹å¿«é€Ÿç¼“å­˜ä¸­æ˜¯å¦æœ‰åŒ¹é…çš„å¯¹è±¡ bool fastCacheOccupied = NO; SyncData *data = (SyncData *)tls_get_direct(SYNC_DATA_DIRECT_KEY); if (data) { fastCacheOccupied = YES; if (data-&gt;object == object) { // Found a match in fast cache. uintptr_t lockCount; result = data; lockCount = (uintptr_t)tls_get_direct(SYNC_COUNT_DIRECT_KEY); if (result-&gt;threadCount &lt;= 0 || lockCount &lt;= 0) { _objc_fatal(&quot;id2data fastcache is buggy&quot;); } switch(why) { case ACQUIRE: { lockCount++; tls_set_direct(SYNC_COUNT_DIRECT_KEY, (void*)lockCount); break; } case RELEASE: lockCount--; tls_set_direct(SYNC_COUNT_DIRECT_KEY, (void*)lockCount); if (lockCount == 0) { // remove from fast cache tls_set_direct(SYNC_DATA_DIRECT_KEY, NULL); // atomic because may collide with concurrent ACQUIRE OSAtomicDecrement32Barrier(&amp;result-&gt;threadCount); } break; case CHECK: // do nothing break; } return result; } }#endif ...} è¿™é‡Œæœ‰ä¸ªé‡è¦çš„çŸ¥è¯†ç‚¹â€”â€”TLSï¼šTLSå…¨ç§°ä¸ºThread Local Storageï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰è‡ªå·±çš„TLSï¼Œè´Ÿè´£ä¿å­˜æœ¬çº¿ç¨‹çš„ä¸€äº›å˜é‡ï¼Œ ä¸”TLSæ— éœ€é”ä¿æŠ¤ å¿«é€Ÿç¼“å­˜çš„å«ä¹‰ä¸ºï¼šå®šä¹‰ä¸¤ä¸ªå˜é‡SYNC_DATA_DIRECT_KEY/SYNC_COUNT_DIRECT_KEYï¼Œä¸tsl_get_direct/ls_set_directé…åˆå¯ä»¥ä»çº¿ç¨‹å±€éƒ¨ç¼“å­˜ä¸­å¿«é€Ÿå–å¾—SyncCacheItem.dataå’ŒSyncCacheItem.lockCount å¦‚æœåœ¨ç¼“å­˜ä¸­æ‰¾åˆ°å½“å‰å¯¹è±¡ï¼Œå°±æ‹¿å‡ºå½“å‰è¢«é”çš„æ¬¡æ•°lockCountï¼Œå†æ ¹æ®ä¼ å…¥å‚æ•°ç±»å‹(è·å–ã€é‡Šæ”¾ã€æŸ¥çœ‹)å¯¹lockCountåˆ†åˆ«è¿›è¡Œæ“ä½œ è·å–èµ„æºACQUIREï¼šlockCount++å¹¶æ ¹æ®keyå€¼å­˜å…¥è¢«é”æ¬¡æ•° é‡Šæ”¾èµ„æºRELEASEï¼šlockCount--å¹¶æ ¹æ®keyå€¼å­˜å…¥è¢«é”æ¬¡æ•°ã€‚å¦‚æœæ¬¡æ•°å˜ä¸º0ï¼Œæ­¤æ—¶é”ä¹Ÿä¸å¤å­˜åœ¨ï¼Œéœ€è¦ä»å¿«é€Ÿç¼“å­˜ç§»é™¤å¹¶æ¸…ç©ºçº¿ç¨‹æ•°threadCount æŸ¥çœ‹èµ„æºcheckï¼šä¸æ“ä½œ lockCount è¡¨ç¤ºè¢«é”çš„æ¬¡æ•°ï¼Œæ„å‘³ç€èƒ½å¤šæ¬¡è¿›å…¥ï¼Œä»ä¾§é¢è¡¨ç°å‡ºäº†@synchronizedçš„é€’å½’æ€§ 3.2.4 è·å–è¯¥çº¿ç¨‹ä¸‹çš„ SyncCacheè¿™ä¸ªé€»è¾‘åˆ†æ”¯æ˜¯æ‰¾ä¸åˆ°ç¡®åˆ‡çš„çº¿ç¨‹æ ‡è®°åªèƒ½==éå†æ‰€æœ‰çš„ç¼“å­˜== 123456789101112131415161718192021222324252627282930313233343536373839static SyncData* id2data(id object, enum usage why){ ... SyncCache *cache = fetch_cache(NO); if (cache) { unsigned int i; for (i = 0; i &lt; cache-&gt;used; i++) { SyncCacheItem *item = &amp;cache-&gt;list[i]; if (item-&gt;data-&gt;object != object) continue; // Found a match. result = item-&gt;data; if (result-&gt;threadCount &lt;= 0 || item-&gt;lockCount &lt;= 0) { _objc_fatal(&quot;id2data cache is buggy&quot;); } switch(why) { case ACQUIRE: item-&gt;lockCount++; break; case RELEASE: item-&gt;lockCount--; if (item-&gt;lockCount == 0) { // remove from per-thread cache cache-&gt;list[i] = cache-&gt;list[--cache-&gt;used]; // atomic because may collide with concurrent ACQUIRE OSAtomicDecrement32Barrier(&amp;result-&gt;threadCount); } break; case CHECK: // do nothing break; } return result; } } ...} è¿™é‡Œä»‹ç»ä¸€ä¸‹SyncCacheå’ŒSyncCacheItem 12345678910typedef struct { SyncData *data; // è¯¥ç¼“å­˜æ¡ç›®å¯¹åº”çš„SyncData unsigned int lockCount; // è¯¥å¯¹è±¡åœ¨è¯¥çº¿ç¨‹ä¸­è¢«åŠ é”çš„æ¬¡æ•°} SyncCacheItem;typedef struct SyncCache { unsigned int allocated; // è¯¥ç¼“å­˜æ­¤æ—¶å¯¹åº”çš„ç¼“å­˜å¤§å° unsigned int used; // è¯¥ç¼“å­˜æ­¤æ—¶å¯¹åº”çš„å·²ä½¿ç”¨ç¼“å­˜å¤§å° SyncCacheItem list[0]; // SyncCacheItemæ•°ç»„} SyncCache; SyncCacheItemç”¨æ¥è®°å½•æŸä¸ªSyncDataåœ¨æŸä¸ªçº¿ç¨‹ä¸­è¢«åŠ é”çš„è®°å½•ï¼Œä¸€ä¸ªSyncDataå¯ä»¥è¢«å¤šä¸ªSyncCacheItemæŒæœ‰ SyncCacheç”¨æ¥è®°å½•æŸä¸ªçº¿ç¨‹ä¸­æ‰€æœ‰SyncCacheItemï¼Œå¹¶ä¸”è®°å½•äº†ç¼“å­˜å¤§å°ä»¥åŠå·²ä½¿ç”¨ç¼“å­˜å¤§å° 3.2.5 å…¨å±€å“ˆå¸Œè¡¨æŸ¥æ‰¾å¿«é€Ÿã€æ…¢é€Ÿæµç¨‹éƒ½æ²¡æ‰¾åˆ°ç¼“å­˜å°±ä¼šæ¥åˆ°è¿™æ­¥â€”â€”åœ¨ç³»ç»Ÿä¿å­˜çš„å“ˆå¸Œè¡¨è¿›è¡Œé“¾å¼æŸ¥æ‰¾ 1234567891011121314151617181920212223242526272829303132static SyncData* id2data(id object, enum usage why){ ... lockp-&gt;lock(); { SyncData* p; SyncData* firstUnused = NULL; for (p = *listp; p != NULL; p = p-&gt;nextData) { if ( p-&gt;object == object ) { result = p; // atomic because may collide with concurrent RELEASE OSAtomicIncrement32Barrier(&amp;result-&gt;threadCount); goto done; } if ( (firstUnused == NULL) &amp;&amp; (p-&gt;threadCount == 0) ) firstUnused = p; } // no SyncData currently associated with object if ( (why == RELEASE) || (why == CHECK) ) goto done; // an unused one was found, use it if ( firstUnused != NULL ) { result = firstUnused; result-&gt;object = (objc_object *)object; result-&gt;threadCount = 1; goto done; } } ...} 1.lockp-&gt;lock()å¹¶ä¸æ˜¯åœ¨åº•å±‚å¯¹é”è¿›è¡Œäº†å°è£…ï¼Œè€Œæ˜¯åœ¨æŸ¥æ‰¾è¿‡ç¨‹å‰åè¿›è¡Œäº†åŠ é”æ“ä½œ 2.forå¾ªç¯éå†é“¾è¡¨ï¼Œå¦‚æœæœ‰ç¬¦åˆçš„å°± goto done 3.å¦‚æœæ˜¯RELEASEæˆ–CHECKç›´æ¥goto done 4.å¦‚æœç¬¬äºŒæ­¥ä¸­æœ‰å‘ç°ç¬¬ä¸€æ¬¡ä½¿ç”¨çš„çš„å¯¹è±¡å°±å°†threadCountæ ‡è®°ä¸º1ä¸”goto done 3.2.6 ç”Ÿæˆæ–°æ•°æ®å¹¶å†™å…¥ç¼“å­˜1234567891011121314151617181920212223242526272829303132333435363738394041static SyncData* id2data(id object, enum usage why){ ... posix_memalign((void **)&amp;result, alignof(SyncData), sizeof(SyncData)); result-&gt;object = (objc_object *)object; result-&gt;threadCount = 1; new (&amp;result-&gt;mutex) recursive_mutex_t(fork_unsafe_lock); result-&gt;nextData = *listp; *listp = result; done: lockp-&gt;unlock(); if (result) { // Only new ACQUIRE should get here. // All RELEASE and CHECK and recursive ACQUIRE are // handled by the per-thread caches above. if (why == RELEASE) { // Probably some thread is incorrectly exiting // while the object is held by another thread. return nil; } if (why != ACQUIRE) _objc_fatal(&quot;id2data is buggy&quot;); if (result-&gt;object != object) _objc_fatal(&quot;id2data is buggy&quot;);#if SUPPORT_DIRECT_THREAD_KEYS if (!fastCacheOccupied) { // Save in fast thread cache tls_set_direct(SYNC_DATA_DIRECT_KEY, result); tls_set_direct(SYNC_COUNT_DIRECT_KEY, (void*)1); } else #endif { // Save in thread cache if (!cache) cache = fetch_cache(YES); cache-&gt;list[cache-&gt;used].data = result; cache-&gt;list[cache-&gt;used].lockCount = 1; cache-&gt;used++; } } ...} 1.å‰ä¸‰æ­¥æƒ…å†µå‡ä¸æ»¡è¶³ï¼ˆå³é“¾è¡¨ä¸å­˜åœ¨â€”â€”å¯¹è±¡å¯¹äºå…¨éƒ¨çº¿ç¨‹æ¥è¯´æ˜¯ç¬¬ä¸€æ¬¡åŠ é”ï¼‰å°±ä¼šåˆ›å»ºSyncDataå¹¶å­˜åœ¨resulté‡Œï¼Œæ–¹ä¾¿ä¸‹æ¬¡è¿›è¡Œå­˜å‚¨ 2.doneåˆ†æï¼š å…ˆå°†å‰é¢çš„ lock é”è§£å¼€ å¦‚æœæ˜¯RELEASEç±»å‹ç›´æ¥è¿”å› nil å¯¹ACQUIREç±»å‹å’Œå¯¹è±¡çš„æ–­è¨€åˆ¤æ–­ !fastCacheOccupiedåˆ†æ”¯è¡¨ç¤ºæ”¯æŒå¿«é€Ÿç¼“å­˜ä¸”å¿«é€Ÿç¼“å­˜è¢«å ç”¨äº†ï¼Œå°†è¯¥SyncCacheItemæ•°æ®å†™å…¥å¿«é€Ÿç¼“å­˜ä¸­ å¦åˆ™å°†è¯¥SyncCacheItemå­˜å…¥è¯¥çº¿ç¨‹å¯¹åº”çš„SyncCacheä¸­ 3.2.7 ç–‘éš¾è§£ç­” ä¸èƒ½ä½¿ç”¨éOCå¯¹è±¡ä½œä¸ºåŠ é”æ¡ä»¶â€”â€”id2dataä¸­æ¥æ”¶å‚æ•°ä¸ºidç±»å‹ å¤šæ¬¡é”åŒä¸€ä¸ªå¯¹è±¡ä¼šæœ‰ä»€ä¹ˆåæœå—â€”â€”ä¸ä¼šå‡ºé—®é¢˜ï¼Œå› ä¸ºä¼šä»é«˜é€Ÿç¼“å­˜ä¸­æ‹¿åˆ° dataï¼Œæ‰€ä»¥åªä¼šé”ä¸€æ¬¡å¯¹è±¡ éƒ½è¯´@synchronizedæ€§èƒ½ä½â€”â€”æ˜¯å› ä¸ºåœ¨åº•å±‚å¢åˆ æ”¹æŸ¥æ¶ˆè€—äº†å¤§é‡æ€§èƒ½ åŠ é”å¯¹è±¡ä¸èƒ½ä¸ºnilï¼Œå¦åˆ™åŠ é”æ— æ•ˆï¼Œå°±ä¸èƒ½ä¿è¯çº¿ç¨‹å®‰å…¨äº†ã€‚æ‰€ä»¥è¦å°å¿ƒé¿å…åŠ é”å¯¹è±¡åœ¨ä»£ç æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸º nil çš„æƒ…å†µã€‚ çœ‹ä¸€ä¸ªå‘ç‚¹ï¼š 12345678910- (void)test { _testArray = [NSMutableArray array]; for (int i = 0; i &lt; 200000; i++) { dispatch_async(dispatch_get_global_queue(0, 0), ^{ @synchronized (self.testArray) { self.testArray = [NSMutableArray array]; } }); }} ä¸Šé¢ä»£ç ä¸€è¿è¡Œå°±ä¼šå´©æºƒï¼ŒåŸå› æ˜¯å› ä¸ºåœ¨æŸä¸€ç¬é—´testArrayé‡Šæ”¾äº†ä¸ºnilï¼Œæ‰€ä»¥å¯¼è‡´@synchronizedåŠ é”å¤±æ•ˆï¼Œçº¿ç¨‹ä¸å®‰å…¨äº†ï¼Œç„¶åå°±ä¼šå‡ºç°å¤šä¸ªçº¿ç¨‹åŒæ—¶é‡Šæ”¾ self.testArray å’Œç»™ self.testArray èµ‹å€¼çš„æƒ…å†µï¼Œé‚£ä¹ˆå°±ä¼šæœ‰ä¸€ä¸ªç¬é—´ï¼šä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ç»™ self.testArray è¿›è¡Œé‡Šæ”¾ï¼Œå› ä¸ºå½“å‰å¯¹è±¡å·²ç»é‡Šæ”¾è¿‡äº†ï¼Œå†æ¬¡é‡Šæ”¾å°±ä¼šå¯¼è‡´å´©æºƒäº†ã€‚ è§£å†³æ–¹æ¡ˆï¼š å¯¹selfè¿›è¡ŒåŒæ­¥é”ï¼Œè¿™ä¸ªä¼¼ä¹å¤ªè‡ƒè‚¿äº† ä½¿ç”¨NSLock 3.3 NSLock3.3.1 ä½¿ç”¨NSLockæ˜¯å¯¹äº’æ–¥é”çš„ç®€å•å°è£…ï¼Œä½¿ç”¨å¦‚ä¸‹ï¼š 1234567891011- (void)test { self.testArray = [NSMutableArray array]; NSLock *lock = [[NSLock alloc] init]; for (int i = 0; i &lt; 200000; i++) { dispatch_async(dispatch_get_global_queue(0, 0), ^{ [lock lock]; self.testArray = [NSMutableArray array]; [lock unlock]; }); }} NSLockåœ¨AFNetworkingçš„AFURLSessionManager.mä¸­æœ‰ä½¿ç”¨åˆ° æƒ³è¦äº†è§£ä¸€ä¸‹NSLockçš„åº•å±‚åŸç†ï¼Œä½†å‘ç°å…¶æ˜¯åœ¨æœªå¼€æºçš„ OC Foundationæºç ä¸‹é¢çš„ï¼Œä½†æ˜¯ Swift å¯¹Foundationå´å¼€æºäº†ï¼Œå¯ä»¥åœ¨swift-corelibs-foundationä¸‹è½½åˆ°æºç æ¥ä¸€æ¢ç©¶ç«Ÿ ä»æºç æ¥çœ‹å°±æ˜¯å¯¹äº’æ–¥é”çš„ç®€å•å°è£… 3.3.2 æ³¨æ„äº‹é¡¹ä½¿ç”¨äº’æ–¥é”NSLockå¼‚æ­¥å¹¶å‘è°ƒç”¨ block å—ï¼Œblock å—å†…éƒ¨é€’å½’è°ƒç”¨è‡ªå·±ï¼Œé—®æ‰“å°ä»€ä¹ˆï¼Ÿ 123456789101112131415161718- (void)test { NSLock *lock = [[NSLock alloc] init]; dispatch_async(dispatch_get_global_queue(0, 0), ^{ static void (^block)(int); block = ^(int value) { NSLog(@&quot;åŠ é”å‰&quot;); [lock lock]; NSLog(@&quot;åŠ é”å&quot;); if (value &gt; 0) { NSLog(@&quot;valueâ€”â€”%d&quot;, value); block(value - 1); } [lock unlock]; }; block(10); });} è¾“å‡ºç»“æœå¹¶æ²¡æœ‰æŒ‰ç…§æˆ‘ä»¬æƒ³è±¡çš„å»èµ°ï¼šé€’å½’åˆ°æœ€åè¿›è¡Œè§£é”ç„¶åä»å†…åˆ°å¤–ä¾æ¬¡è§£é”ï¼Œè€Œæ˜¯åªæ‰“å°äº†ä¸€æ¬¡valueå€¼ä¹‹åå°±å¡ä½äº†ï¼š 1234åŠ é”å‰åŠ é”åvalueâ€”â€”10åŠ é”å‰ // å¡åœ¨è¿™ åŸå› ï¼š äº’æ–¥é”åœ¨é€’å½’è°ƒç”¨æ—¶ä¼šé€ æˆå µå¡ï¼Œå¹¶éæ­»é”â€”â€”è¿™é‡Œçš„é—®é¢˜æ˜¯åé¢çš„ä»£ç æ— æ³•æ‰§è¡Œä¸‹å» ç¬¬ä¸€æ¬¡åŠ å®Œé”ä¹‹åè¿˜æ²¡å‡ºé”å°±è¿›è¡Œé€’å½’è°ƒç”¨ ç¬¬äºŒæ¬¡åŠ é”å°±å µå¡äº†çº¿ç¨‹ï¼ˆå› ä¸ºä¸ä¼šæŸ¥è¯¢ç¼“å­˜ï¼‰ è§£å†³æ–¹æ¡ˆï¼š ä½¿ç”¨é€’å½’é”NSRecursiveLockæ›¿æ¢NSLock å µå¡ï¼šç”±äºèµ„æºä¸è¶³å¼•èµ·çš„æ’é˜Ÿç­‰å¾…ç°è±¡ æ­»é”ï¼šäº’ç›¸ç­‰å¾… 3.4 NSRecursiveLock3.4.1 ä½¿ç”¨NSRecursiveLockä½¿ç”¨å’ŒNSLockç±»ä¼¼ï¼Œå¦‚ä¸‹ä»£ç å°±èƒ½è§£å†³ä¸Šä¸ªé—®é¢˜ 12345678910111213141516- (void)test { NSRecursiveLock *lock = [[NSRecursiveLock alloc] init]; dispatch_async(dispatch_get_global_queue(0, 0), ^{ static void (^block)(int); block = ^(int value) { [lock lock]; if (value &gt; 0) { NSLog(@&quot;valueâ€”â€”%d&quot;, value); block(value - 1); } [lock unlock]; }; block(10); });} NSRecursiveLockåœ¨YYKitä¸­YYWebImageOperation.mä¸­æœ‰ç”¨åˆ° 3.4.2 æ³¨æ„äº‹é¡¹é€’å½’é”åœ¨ä½¿ç”¨æ—¶éœ€è¦æ³¨æ„==æ­»é”==é—®é¢˜â€”â€”å‰åä»£ç ç›¸äº’ç­‰å¾…ä¾¿ä¼šäº§ç”Ÿæ­»é” ä¸Šè¿°ä»£ç åœ¨å¤–å±‚åŠ ä¸ªforå¾ªç¯ï¼Œé—®è¾“å‡ºç»“æœï¼Ÿ 123456789101112131415161718- (void)test { NSRecursiveLock *lock = [[NSRecursiveLock alloc] init]; for (int i = 0; i &lt; 10; i++) { dispatch_async(dispatch_get_global_queue(0, 0), ^{ static void (^block)(int); block = ^(int value) { [lock lock]; if (value &gt; 0) { NSLog(@&quot;valueâ€”â€”%d&quot;, value); block(value - 1); } [lock unlock]; }; block(10); }); }} è¿è¡Œä»£ç ä¼šå´©æºƒï¼Œå¹¶ä¼šæç¤ºé‡æŒ‡é’ˆé”™è¯¯ åŸå› ï¼š for å¾ªç¯åœ¨ block å†…éƒ¨å¯¹åŒä¸€ä¸ªå¯¹è±¡è¿›è¡Œäº†å¤šæ¬¡é”æ“ä½œï¼Œç›´åˆ°è¿™ä¸ªèµ„æºèº«ä¸ŠæŒ‚ç€NæŠŠé”ï¼Œæœ€åå¤§å®¶éƒ½æ— æ³•ä¸€æ¬¡æ€§è§£é”â€”â€”æ‰¾ä¸åˆ°è§£é”çš„å‡ºå£ å³ çº¿ç¨‹1ä¸­åŠ é”1ã€åŒæ—¶çº¿ç¨‹2ä¸­åŠ é”2-&gt; è§£é”1ç­‰å¾…è§£é”2 -&gt; è§£é”2ç­‰å¾…è§£é”1 -&gt; æ— æ³•ç»“æŸè§£é”â€”â€”å½¢æˆæ­»é” è§£å†³ï¼š å¯ä»¥é‡‡ç”¨ä½¿ç”¨ç¼“å­˜çš„@synchronizedï¼Œå› ä¸ºå®ƒå¯¹å¯¹è±¡è¿›è¡Œé”æ“ä½œï¼Œä¼šå…ˆä»ç¼“å­˜æŸ¥æ‰¾æ˜¯å¦æœ‰é”syncDataå­˜åœ¨ã€‚å¦‚æœæœ‰ï¼Œç›´æ¥è¿”å›è€Œä¸åŠ é”ï¼Œä¿è¯é”çš„å”¯ä¸€æ€§ 3.5 dispatch_semaphoreåœ¨17-å¤šçº¿ç¨‹ä¹‹GCDåº”ç”¨å·²ç»å¯¹ä¿¡å·é‡è¿›è¡Œè¿‡è®²è§£ã€‚ä¸¥æ ¼æ¥è¯´ï¼Œä¿¡å·é‡ä¸æ˜¯ä¸€ç§é”ï¼Œä½†æ˜¯å¯ä»¥å®ç°é”çš„æ•ˆæœã€‚ 3.6 NSConditionNSConditionæ˜¯ä¸€ä¸ªæ¡ä»¶é”ï¼Œå¯èƒ½å¹³æ—¶ç”¨çš„ä¸å¤šï¼Œä½†ä¸ä¿¡å·é‡ç›¸ä¼¼ï¼šçº¿ç¨‹1éœ€è¦ç­‰åˆ°æ¡ä»¶1æ»¡è¶³æ‰ä¼šå¾€ä¸‹èµ°ï¼Œå¦åˆ™å°±ä¼šå µå¡ç­‰å¾…ï¼Œç›´è‡³æ¡ä»¶æ»¡è¶³ã€‚ åŒæ ·çš„èƒ½åœ¨Swiftæºç ä¸­æ‰¾åˆ°å…³äºNSConditionéƒ¨åˆ† 12345678910111213141516171819202122232425262728293031323334353637383940414243open class NSCondition: NSObject, NSLocking { internal var mutex = _MutexPointer.allocate(capacity: 1) internal var cond = _ConditionVariablePointer.allocate(capacity: 1) public override init() { pthread_mutex_init(mutex, nil) pthread_cond_init(cond, nil) } deinit { pthread_mutex_destroy(mutex) pthread_cond_destroy(cond) } open func lock() { pthread_mutex_lock(mutex) } open func unlock() { pthread_mutex_unlock(mutex) } open func wait() { pthread_cond_wait(cond, mutex) } open func wait(until limit: Date) -&gt; Bool { guard var timeout = timeSpecFrom(date: limit) else { return false } return pthread_cond_timedwait(cond, mutex, &amp;timeout) == 0 } open func signal() { pthread_cond_signal(cond) } open func broadcast() { pthread_cond_broadcast(cond) // wait signal } open var name: String?} ä»ä¸Šè¿°ç²¾ç®€åçš„ä»£ç å¯ä»¥å¾—å‡ºä»¥ä¸‹å‡ ç‚¹ï¼š NSConditionæ˜¯å¯¹mutexå’Œcondçš„ä¸€ç§å°è£…ï¼ˆcondå°±æ˜¯ç”¨äºè®¿é—®å’Œæ“ä½œç‰¹å®šç±»å‹æ•°æ®çš„æŒ‡é’ˆï¼‰ waitæ“ä½œä¼šé˜»å¡çº¿ç¨‹ï¼Œä½¿å…¶è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œç›´è‡³è¶…æ—¶ signalæ“ä½œæ˜¯å”¤é†’ä¸€ä¸ªæ­£åœ¨ä¼‘çœ ç­‰å¾…çš„çº¿ç¨‹ broadcastä¼šå”¤é†’æ‰€æœ‰æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹ 3.7 NSConditionLocké¡¾åæ€ä¹‰ï¼Œå°±æ˜¯NSCondition + Lock é‚£ä¹ˆå’ŒNSConditionçš„åŒºåˆ«åœ¨äºå“ªé‡Œå‘¢ï¼Ÿæ¥ä¸‹æ¥çœ‹ä¸€ä¸‹NSConditionLockæºç  12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576open class NSConditionLock : NSObject, NSLocking { internal var _cond = NSCondition() internal var _value: Int internal var _thread: _swift_CFThreadRef? public convenience override init() { self.init(condition: 0) } public init(condition: Int) { _value = condition } open func lock() { let _ = lock(before: Date.distantFuture) } open func unlock() { _cond.lock() _thread = nil _cond.broadcast() _cond.unlock() } open var condition: Int { return _value } open func lock(whenCondition condition: Int) { let _ = lock(whenCondition: condition, before: Date.distantFuture) } open func `try`() -&gt; Bool { return lock(before: Date.distantPast) } open func tryLock(whenCondition condition: Int) -&gt; Bool { return lock(whenCondition: condition, before: Date.distantPast) } open func unlock(withCondition condition: Int) { _cond.lock() _thread = nil _value = condition _cond.broadcast() _cond.unlock() } open func lock(before limit: Date) -&gt; Bool { _cond.lock() while _thread != nil { if !_cond.wait(until: limit) { _cond.unlock() return false } } _thread = pthread_self() _cond.unlock() return true } open func lock(whenCondition condition: Int, before limit: Date) -&gt; Bool { _cond.lock() while _thread != nil || _value != condition { if !_cond.wait(until: limit) { _cond.unlock() return false } } _thread = pthread_self() _cond.unlock() return true } open var name: String?} ä»ä¸Šè¿°ä»£ç å¯ä»¥å¾—å‡ºä»¥ä¸‹å‡ ç‚¹ï¼š NSConditionLockæ˜¯NSConditionåŠ çº¿ç¨‹æ•°çš„å°è£… NSConditionLockå¯ä»¥è®¾ç½®é”æ¡ä»¶ï¼Œè€ŒNSConditionåªæ˜¯æ— è„‘çš„é€šçŸ¥ä¿¡å· 3.8 os_unfair_lockç”±äºOSSpinLockè‡ªæ—‹é”çš„bugï¼Œæ›¿ä»£æ–¹æ¡ˆæ˜¯å†…éƒ¨å°è£…äº†os_unfair_lockï¼Œè€Œos_unfair_lockåœ¨åŠ é”æ—¶ä¼šå¤„äºä¼‘çœ çŠ¶æ€ï¼Œè€Œä¸æ˜¯è‡ªæ—‹é”çš„å¿™ç­‰çŠ¶æ€ 3.9 äº’æ–¥é”æ€§èƒ½å¯¹æ¯” å››ã€æ€»ç»“ OSSpinLockä¸å†å®‰å…¨ï¼Œåº•å±‚ç”¨os_unfair_lockæ›¿ä»£ å±æ€§çš„atomicä¿®é¥°ç¬¦åªèƒ½ä¿è¯setterã€getteræ–¹æ³•çš„çº¿ç¨‹å®‰å…¨ï¼Œä¸èƒ½ä¿è¯å…¶ä»–æ“ä½œçš„çº¿ç¨‹å®‰å…¨ï¼Œæ‰€ä»¥æ›´å¤šçš„ä½¿ç”¨nonatomicæ¥ä¿®é¥° è¯»å†™é”æ›´å¤šä½¿ç”¨æ …æ å‡½æ•°æ¥å®ç° @synchronizedåœ¨åº•å±‚ç»´æŠ¤äº†ä¸€ä¸ªå“ˆå¸Œé“¾è¡¨è¿›è¡Œdataçš„å­˜å‚¨ï¼Œä½¿ç”¨recursive_mutex_tè¿›è¡ŒåŠ é” äº’æ–¥é”åˆ†ä¸ºé€’å½’é”å’Œéé€’å½’é”ã€‚ é€’å½’é”ï¼šNSRecursiveLockï¼›å¯¹è±¡é”@synchronizedã€‚ éé€’å½’é”ï¼špthread_mutexï¼›NSLockï¼›æ¡ä»¶é”NSConditionã€NSConditionLockã€‚ NSLockã€NSRecursiveLockã€NSConditionå’ŒNSConditionLockåº•å±‚éƒ½æ˜¯å¯¹pthread_mutexçš„å°è£… NSConditionå’ŒNSConditionLockæ˜¯æ¡ä»¶é”ï¼Œå½“æ»¡è¶³æŸä¸€ä¸ªæ¡ä»¶æ—¶æ‰èƒ½è¿›è¡Œæ“ä½œï¼Œå’Œä¿¡å·é‡dispatch_semaphoreç±»ä¼¼ ä½¿ç”¨æ—¶ï¼š æ™®é€šåœºæ™¯ä¸‹æ¶‰åŠåˆ°çº¿ç¨‹å®‰å…¨ï¼Œå¯ä»¥ç”¨NSLock å¾ªç¯è°ƒç”¨æ—¶ç”¨NSRecursiveLock å¾ªç¯è°ƒç”¨ä¸”æœ‰çº¿ç¨‹å½±å“æ—¶ï¼Œè¯·æ³¨æ„æ­»é”ï¼Œå¦‚æœæœ‰æ­»é”é—®é¢˜çš„è¯ä½¿ç”¨@synchronizedè§£å†³ æ—¥å¸¸å¼€å‘ä¸­è‹¥éœ€è¦ä½¿ç”¨çº¿ç¨‹é”æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œè¯·å¤šè€ƒè™‘ä¸€ä¸‹å†é€‰æ‹©ä½¿ç”¨å“ªä¸ªé”ï¼Œ@synchronizedå¹¶ä¸æ˜¯æœ€ä¼˜çš„é€‰æ‹©ã€‚ PSobjc æºç  Swift Foundation æºç  å‚è€ƒèµ„æ–™iOSæ¢ç´¢ ç»†æ•°iOSä¸­çš„é‚£äº›é” iOS -é” synchronizedå®ç°åŸç†åŠç¼ºé™·åˆ†æ iOSåº•å±‚å­¦ä¹  - å¤šçº¿ç¨‹ä¹‹ä¸­çš„é” iOSå¼€å‘ä¸­çš„11ç§é”ä»¥åŠæ€§èƒ½å¯¹æ¯”","link":"/2021/07/04/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/19-%E9%94%81/"},{"title":"20-Blockçš„ä½¿ç”¨åŠåŸç†","text":"ä¸€ã€Block åŸºç¡€çŸ¥è¯†åˆ›å»ºä¸€ä¸ªtest.cçš„æ–‡ä»¶ï¼š 1234567891011#include &quot;stdio.h&quot;int main() { int a = 5; void(^block)(void) = ^{ printf(&quot;BLOCK_TEST==%d&quot;, a); }; block(); return 0;} è¿›å…¥åˆ°test.cæ–‡ä»¶æ‰€åœ¨è·¯å¾„ï¼Œä½¿ç”¨ clang å°†ä¸Šè¿°ä»£ç è¾“å‡ºæˆ c++ æ–‡ä»¶ï¼š 1clang -rewrite-objc test.c -o test.cpp ä½¿ç”¨clangæŒ‡ä»¤è¿›è¡Œè½¬æ¢å‰ï¼Œæ³¨æ„ä¸è¦åœ¨ä¸Šè¿°ä»£ç ä¸­ä½¿ç”¨å­—é¢é‡ï¼Œå¦åˆ™è½¬æ¢å¤±è´¥ï¼ˆç³»ç»Ÿbugï¼‰ test.cppï¼š 12345678910111213141516171819202122232425262728293031323334struct __main_block_impl_0 { struct __block_impl impl; struct __main_block_desc_0* Desc; int a; __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int _a, int flags=0) : a(_a) { impl.isa = &amp;_NSConcreteStackBlock; impl.Flags = flags; impl.FuncPtr = fp; Desc = desc; }};// Block çš„å®ç°static void __main_block_func_0(struct __main_block_impl_0 *__cself) { int a = __cself-&gt;a; // bound by copy printf(&quot;BLOCK_TEST==%d&quot;, a);}static struct __main_block_desc_0 { size_t reserved; size_t Block_size;} __main_block_desc_0_DATA = { 0, sizeof(struct __main_block_impl_0)};int main(){ int a = 5; // Block çš„å£°æ˜ void(*block)(void) = ((void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA, a)); // Block çš„è°ƒç”¨ ((void (*)(__block_impl *))((__block_impl *)block)-&gt;FuncPtr)((__block_impl *)block); return 0;} 1.1 Block çš„æœ¬è´¨å°† Block çš„å£°æ˜å’Œè°ƒç”¨ç®€åŒ–åï¼ˆå»æ‰ç±»å‹å¼ºè½¬ï¼‰ï¼š 123void (*block)(void) = &amp;__main_block_impl_0(__main_block_func_0, &amp;__main_block_desc_0_DATA)); (block)-&gt;FuncPtr)(block); å¯è§ Block æ˜¯ä¸€ä¸ª__main_block_impl_0ç»“æ„ä½“ï¼š 1234567891011struct __main_block_impl_0 { struct __block_impl impl; // block å®ç° struct __main_block_desc_0* Desc; // block æè¿°ä¿¡æ¯ int a; __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int _a, int flags=0) : a(_a) { // å†…éƒ¨æ„é€ å‡½æ•° impl.isa = &amp;_NSConcreteStackBlock; impl.Flags = flags; impl.FuncPtr = fp; Desc = desc; }}; æŸ¥çœ‹ __block_implçš„ç±»å‹ï¼š 123456struct __block_impl { void *isa; int Flags; int Reserved; void *FuncPtr;}; å› ä¸ºæœ‰ä»£è¡¨å¯¹è±¡çš„isa å­˜åœ¨ï¼Œå¯çŸ¥å…¶ä¹Ÿç®—ä¸ªå¯¹è±¡ã€‚ æ‰€ä»¥ï¼š Block æ˜¯ä¸€ç§åŒ¿åå‡½æ•° Block ç±»å‹æ˜¯å¯¹è±¡ Block æœ¬è´¨æ˜¯ç»“æ„ä½“ï¼ˆå¯¹è±¡çš„æœ¬è´¨å°±æ˜¯ç»“æ„ä½“ï¼‰ 1.2 Block åˆ†ç±»å¸¸è§çš„æœ‰3ç§ï¼Œä¸€å…±æœ‰6ç§ã€‚ å…·ä½“æ“ä½œï¼šè¿›å…¥æˆ‘Githubä¸Šçš„libclosure-78æºç ï¼Œæœç´¢NSBlockå¾—çŸ¥å…·ä½“6ç§å¦‚ä¸‹ï¼š 123456void * _NSConcreteStackBlock[32] = { 0 }; // æ ˆåŒº Blockvoid * _NSConcreteMallocBlock[32] = { 0 }; // å †åŒº Blockvoid * _NSConcreteAutoBlock[32] = { 0 };void * _NSConcreteFinalizingBlock[32] = { 0 };void * _NSConcreteGlobalBlock[32] = { 0 }; // å…¨å±€åŒº Blockvoid * _NSConcreteWeakBlockVariable[32] = { 0 }; é™¤æ ˆåŒºã€å †åŒºã€å…¨å±€åŒºçš„ Blockï¼Œå…¶ä½™3ç§ä¸ºç³»ç»Ÿçº§åˆ«ï¼Œå®é™…å¼€å‘è¾ƒå°‘ä¼šç”¨åˆ°ï¼Œæ‰€ä»¥å…ˆä¸å±•å¼€è¯´æ˜ã€‚ 1.2.1 NSGlobalBlockâ€”å…¨å±€Blockå½“ç”Ÿæˆçš„ block æ˜¯ç‹¬ç«‹çš„ï¼Œä¸å¼•ç”¨å¤–éƒ¨å˜é‡æˆ–è€…ä½œä¸ºå‚æ•°å‚ä¸å…¶ä»–å‡½æ•°ï¼Œå¤„äºå…¨å±€åŒºï¼Œæ˜¯å…¨å±€block 1234void (^block)(void) = ^{ NSLog(@&quot;hello world!&quot;);};NSLog(@&quot;%@&quot;, block); 1&lt;__NSGlobalBlock__: 0x10e714050&gt; 1.2.2 NSStackBlockâ€”æ ˆåŒºBlockå½“block è¢«copy å‰ï¼Œä¼šå¤„äºæ ˆåŒº 123NSLog(@&quot;%@&quot;,^{ NSLog(@&quot;1233 - %d&quot;,a);}); 1&lt;_NSStackBlock__: 0x7ffeeb763440&gt; 1.2.3 NSMallocBlockâ€”å †åŒºBlockå¦‚æœå°† block èµ‹å€¼ç»™ block å˜é‡åï¼Œæ ˆ block å°±ä¼šè¢«æ‹·è´åˆ°å †ä¸Šï¼Œæˆä¸ºäº†å †block 12345int a = 10;void (^block)(void) = ^{ NSLog(@&quot;1233 - %d&quot;,a);};NSLog(@&quot;%@&quot;, block); 1&lt;__NSMallocBlock__: 0x600002cd8090&gt; 1.3 Block çš„å¸¸è§ç”¨æ³•ä½œä¸ºå±€éƒ¨å˜é‡ 123returnType (^blockName)(parameterTypes) = ^returnType(parameters) { // do sth..}; ä½œä¸ºå±æ€§ 1@property (nonatomic, copy) returnType (^blockName)(parameterTypes); ä½œä¸ºå‡½æ•°å£°æ˜ä¸­çš„å‚æ•° 1- (void)someMethodThatTakesABlock:(returnType (^)(parameterTypes))blockName; ä½œä¸ºå‡½æ•°è°ƒç”¨ä¸­çš„å‚æ•° 123[someObject someMethodThatTakesABlock:^returnType (parameters) { // do sth}]; ç”¨åœ¨ typedef ä¸­ 1234typedef returnType (^TypeName)(parameterTypes);TypeName blockName = ^returnType(parameters) { // DO STH}; äºŒã€å¾ªç¯å¼•ç”¨åŠè§£å†³å¾ªç¯å¼•ç”¨ï¼šæŒ‡ä¸¤ä¸ªæˆ–å¤šä¸ªå¯¹è±¡ä¹‹é—´äº§ç”Ÿäº†äº’ç›¸å¼ºå¼•ç”¨è€Œå¯¼è‡´è¿™äº›å¯¹è±¡å› ä¸ºå¼•ç”¨è®¡æ•°å§‹ç»ˆå¤§äºç­‰äº1è€Œä¸ä¼šé‡Šæ”¾ï¼Œæœ€åå¯¼è‡´å†…å­˜æ³„æ¼çš„çŠ¶å†µã€‚ 2.1 å¾ªç¯å¼•ç”¨çš„äº§ç”Ÿä¸¾ä¸€ä¸ªå¸¸è§çš„å¾ªç¯å¼•ç”¨çš„ä¾‹å­ï¼š 1234567891011121314- (void)viewDidLoad { [super viewDidLoad]; // â‘  self æŒæœ‰block self.block = ^{ // â‘¡ block åˆæŒæœ‰self NSLog(@&quot;__name %@&quot;, self.name); }; self.block();}-(void)dealloc{ NSLog(@&quot;è¿›å…¥dealloc&quot;);} self å’Œ blockï¼Œç›¸äº’å¼ºå¼•ç”¨äº†å¯¹æ–¹ï¼Œåªæœ‰å½“è‡ªå·±é”€æ¯æ—¶ï¼Œæ‰ä¼šå°†å¯¹æ–¹çš„å¼•ç”¨è®¡æ•°å‡1ï¼Œè¿™å°±å¯¼è‡´äº† self çš„é”€æ¯ä¾èµ–äº block çš„é”€æ¯ï¼ŒåŒæ · block çš„é”€æ¯ä¾èµ–äº self çš„é”€æ¯ï¼Œè¿™æ ·å°±é€ æˆäº†å¾ªç¯å¼•ç”¨é—®é¢˜ï¼Œè‡´ä½¿æ— æ³•æ­£å¸¸ deallocã€‚ 2.2 å¾ªç¯å¼•ç”¨çš„è§£å†³æˆ‘ä»¬åªè®¨è®ºç”± block å¼•èµ·çš„å¾ªç¯å¼•ç”¨ã€‚ 2.2.1 ä½¿ç”¨weak ä¿®é¥°å¯ä»¥è€ƒè™‘å¯¹å½“å‰æŒæœ‰ block çš„å¯¹è±¡ï¼Œè¿›è¡Œ weak ä¿®é¥°ï¼Œåˆ›å»ºä¸€ä¸ªå¼±å¼•ç”¨æŒ‡å‘å®ƒï¼ˆåŸç†ä¸ºåŠ å…¥åˆ°å¼±å¼•ç”¨è®¡æ•°è¡¨ï¼Œè€Œéå¼•ç”¨è®¡æ•°è¡¨ï¼‰ï¼Œä½†æ˜¯å¹¶ä¸ä¼šå¢åŠ å¼•ç”¨è®¡æ•°ã€‚ å½“å‰æ¡ˆä¾‹ä¸­ï¼Œå¼•ç”¨block çš„æ˜¯selfï¼Œæ‰€ä»¥åˆ›å»ºä¸€ä¸ª weak å¯¹è±¡ weakSelfã€‚ å¦‚ä¸‹æ‰€ç¤ºï¼Œå³å¯è·³å‡º self - block - self çš„å¾ªç¯å¼•ç”¨ 12345__weak typeof(self) weakSelf = self;self.block = ^{ NSLog(@&quot;__name %@&quot;, weakSelf.name);};self.block(); 2.2.2 weak-strong-danceã€å¸¸ç”¨ã€‘åœ¨å¤šçº§ block çš„åœºæ™¯ä¸‹ï¼Œå¼±å¼•ç”¨ä¼šé€ æˆä¸€äº›æ„å¤–çš„æƒ…å†µã€‚ å¯¹ä¸Šé¢çš„ä¾‹å­åšä¸€äº›å°æ”¹åŠ¨ï¼Œå¯¹ blockä»£ç å—æ‰§è¡Œçš„NSLog å‡½æ•°ï¼Œåšä¸€ä¸ªå»¶è¿Ÿ3ç§’æ‰§è¡Œæ“ä½œï¼Œå¹¶è®©è¿™ä¸ªæ‰§è¡Œåœ¨é¡µé¢æ¶ˆå¤±ä¹‹åï¼Œä¹Ÿå°±æ˜¯ dealloc ä¹‹åï¼Œçœ‹çœ‹æ˜¯å¦è¿˜èƒ½æ‰“å° weakSelf.nameã€‚ æ–°çš„ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415- (void)viewDidLoad { [super viewDidLoad]; __weak typeof(self) weakSelf = self; self.block = ^{ dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(3.0 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{ NSLog(@&quot;__name %@&quot;, weakSelf.name); }); }; self.block();}-(void)dealloc{ NSLog(@&quot;è¿›å…¥dealloc&quot;);} æ‰“å°ï¼š 122020-05-25 12:43:05.876909+0800 DDD[14542:686386] è¿›å…¥dealloc2020-05-25 12:43:06.475894+0800 DDD[14542:686386] __name (null) å¯è§ï¼Œåœ¨è¿›å…¥dealloc ä¹‹åï¼Œself å·²ç»è¢«é‡Šæ”¾æ‰äº†ï¼Œè€Œè®¾è®¡çš„3ç§’åæ‰§è¡Œ weakSelf.name ä¹Ÿå› ä¸º weakSelf ä¸º nil äº†ï¼Œæ‰€ä»¥æ‰“å°ä¸ºnullã€‚ è§£å†³ï¼šåœ¨ä»£ç å—å†…ï¼Œæ·»åŠ ä¸´æ—¶çš„å¼ºå¼•ç”¨ï¼Œå°†weakSelf æ·»åŠ åˆ°å¼ºå¼•ç”¨è¡¨é‡Œï¼Œä¼šè®©dealloc å»¶è¿Ÿæ‰§è¡Œï¼Œè€Œå½“æ‰§è¡Œå®Œä¹‹å block ä¼šå¯¹ä¸´æ—¶çš„å¼ºå¼•ç”¨è¿›è¡Œé‡Šæ”¾ï¼Œé¿å…äº†å¾ªç¯å¼•ç”¨çš„äº§ç”Ÿã€‚ æ­¤æ—¶çš„å¼•ç”¨å°±å˜æˆäº†strongself -&gt; weakself -&gt; self -&gt; block -&gt; strongself çœ‹ä¸Šå»åˆæ˜¯ä¸€ä¸ªå¾ªç¯å¼•ç”¨ï¼Œä½†å®é™…ä¸ŠstrongSelfæ˜¯ä¸ªä¸´æ—¶å˜é‡ï¼Œå½“blockä½œç”¨åŸŸç»“æŸåå°±ä¼šé‡Šæ”¾ï¼Œä»è€Œæ‰“ç ´å¾ªç¯å¼•ç”¨è¿›è¡Œé‡Šæ”¾ï¼ˆè®©é‡Šæ”¾å»¶åäº†3ç§’ï¼‰ 123456789101112131415161718192021- (void)viewDidLoad { [super viewDidLoad]; self.view.backgroundColor = [UIColor purpleColor]; self.name = @&quot;hello&quot;; NSLog(@&quot;åˆå§‹name %@&quot;, self.name); __weak typeof(self) weakSelf = self; self.block = ^{ __strong typeof(self) strongSelf = weakSelf; dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(3 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{ NSLog(@&quot;__name %@&quot;, strongSelf.name); }); }; self.block();}-(void)dealloc{ NSLog(@&quot;è¿›å…¥dealloc&quot;);} æ‰“å°ï¼š 123åˆå§‹name hello__name helloè¿›å…¥dealloc 2.2.3 ç”¨ä¸´æ—¶ VC å˜é‡æ›¿ä»£åœ¨ä¸Šæ–‡ä¸­ï¼Œéƒ½æ˜¯é€šè¿‡ weak å¯¹ self ä¿®é¥°ï¼Œæ¥é¿å…å¾ªç¯å¼•ç”¨ï¼Œå®é™…ä¸Šï¼Œè¿˜å¯ä»¥å¯¹ self æ‰€ä»£æ›¿çš„ Controller å¼•å…¥ä¸´æ—¶å˜é‡ï¼Œæ¥è§£å†³å¾ªç¯å¼•ç”¨ï¼Œè¯ä¸å¤šè¯´ï¼Œå®æˆ˜ä¸€ä¸‹ã€‚ 123456789__block SecViewController *vc = self;self.block = ^{ dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(5 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{ NSLog(@&quot;__name %@&quot;, vc.name); vc = nil; });};self.block(); ä¸Šè¿°ä»£ç ä¹Ÿæ˜¯ä½¿ç”¨ ä¸­ä»‹è€…æ¨¡å¼ æ‰“ç ´å¾ªç¯å¼•ç”¨çš„â€”â€”ä½¿ç”¨vcä½œä¸ºä¸­ä»‹è€…ä»£æ›¿selfä»è€Œæ‰“ç ´å¾ªç¯å¼•ç”¨ æ­¤æ—¶çš„å¼•ç”¨æƒ…å†µä¸ºvc -&gt; self -&gt; block -&gt; vc (vcåœ¨ç”¨å®Œä¹‹åæ‰‹åŠ¨ç½®ç©ºï¼‰ ä½†æ˜¯åªè¦ä¸è°ƒç”¨blockï¼Œä»ç„¶å­˜åœ¨ç€å¾ªç¯åº”ç”¨ 2.2.4 å°† VC ä½œä¸ºblock å˜é‡æ›¿ä»£å¦‚æœ block æ˜¯å¯ä»¥å¼•å…¥å‚æ•°çš„ï¼Œå¯ä»¥å°†æ§åˆ¶å™¨ self ä¼ å…¥è¿›å»ï¼Œä½œä¸ºä¸´æ—¶å˜é‡ï¼Œæ‰“å°åblock ä¼šè‡ªåŠ¨é”€æ¯ï¼Œæ— éœ€æ‹…å¿ƒå¾ªç¯å¼•ç”¨ï¼Œå…·ä½“å¦‚ä¸‹ï¼š åˆ›å»º block ï¼Œå¼•å…¥å½“å‰ VC çš„å¼•ç”¨ï¼Œçš„ä»£ç å¦‚ä¸‹ 1@property (copy, nonatomic) void (^block)(SecViewController *); 123456self.block = ^(SecViewController *vc){ dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(5 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{ NSLog(@&quot;__name %@&quot;, vc.name); });};self.block(self); æ­¤æ—¶é€šè¿‡self.block(self) ä¼ å…¥self çš„å¼•ç”¨ï¼Œblock å†…éƒ¨ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„ä¸´æ—¶å˜é‡æŒ‡å‘selfï¼Œè¯¥ä¸´æ—¶å˜é‡ä½¿ç”¨åä¼šé”€æ¯ã€‚ 2.3 å¾ªç¯å¼•ç”¨çš„è¡¥å……è¯´æ˜ Masonryä¸­æ˜¯å¦å­˜åœ¨å¾ªç¯å¼•ç”¨ï¼Ÿ Monsaryä½¿ç”¨çš„ block æ˜¯å½“åšå‚æ•°ä¼ é€’çš„ï¼Œå³ä¾¿ block å†…éƒ¨æŒæœ‰ selfï¼Œè®¾ç½®å¸ƒå±€çš„view æŒæœ‰ blockï¼Œä½†æ˜¯ block ä¸æŒæœ‰ viewï¼Œå½“ block æ‰§è¡Œå®Œåå°±é‡Šæ”¾äº†ï¼Œæ‰€ä»¥ä¸ä¼šå¯¼è‡´å¾ªç¯å¼•ç”¨ [UIView animateWithDuration: animations:]ä¸­æ˜¯å¦å­˜åœ¨å¾ªç¯å¼•ç”¨ï¼Ÿ UIViewåŠ¨ç”»æ˜¯ç±»æ–¹æ³•ï¼Œä¸è¢« self æŒæœ‰ï¼Œæ‰€ä»¥ä¸ä¼šå¾ªç¯å¼•ç”¨ ä½¿ç”¨ Facebook çš„å¼€æºæ¡†æ¶èƒ½æ£€æµ‹æ˜¯å¦å­˜åœ¨å¾ªç¯å¼•ç”¨ 123456- (void)checkLeaks { FBRetainCycleDetector *detector = [FBRetainCycleDetector new]; [detector addCandidate:self]; NSSet *retainCycles = [detector findRetainCycles]; NSLog(@&quot;%@&quot;, retainCycles);} ä¸‰ã€Block åº•å±‚æ¢ç´¢3.1 Block è‡ªåŠ¨æ•è·å¤–éƒ¨å˜é‡3.1.1 æ•è·å±€éƒ¨å˜é‡==å±€éƒ¨å˜é‡çš„æ•è·ï¼Œæ˜¯å€¼çš„æ•è·== åœ¨ block ä¸­å¯¹å±€éƒ¨å˜é‡ a è¿›è¡Œå¼•ç”¨ï¼š 12345int a = 10;void (^block)(void) = ^{ NSLog(@&quot;%d&quot;, a);};block(); ç¼–è¯‘æˆ cppï¼Œç²¾ç®€åå¦‚ä¸‹ï¼š 12345int a = 10;block = &amp;__main_block_impl_0(__main_block_func_0, &amp;__main_block_desc_0_DATA, a));block-&gt;FuncPtr(block); å¯è§__main_block_impl_0ä¼ å…¥äº†æ–°çš„å‚æ•°aï¼Œæ¥ä¸‹æ¥çœ‹å¦‚ä½•å®ç°ï¼Œæ–°çš„ main_block_impl_0 ç»“æ„ä½“å¦‚ä¸‹ï¼š 1234567891011struct __main_block_impl_0 { struct __block_impl impl; struct __main_block_desc_0* Desc; int a; // æ–°ç”Ÿæˆçš„ __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int _a, int flags=0) : a(_a) { impl.isa = &amp;_NSConcreteStackBlock; impl.Flags = flags; impl.FuncPtr = fp; Desc = desc; }}; å¯è§è¿™é‡Œæ¯”èµ·ä¹‹å‰çš„ç»“æ„ä½“ï¼Œç”Ÿæˆäº†ä¸€ä¸ªæ–°çš„å±æ€§a ï¼Œåœ¨æ„é€ å‡½æ•°é‡Œï¼Œå‘ç°äº†__main_block_impl_0ä¸­ä¹Ÿå¤šäº†ä¸€å¥a(_a) çš„ä»£ç ï¼Œå¯ä»¥çŒœæµ‹æ˜¯ç”Ÿæˆäº†ä¸€ä¸ªæ–°çš„aï¼Œå°†ä¼ å…¥çš„å†…éƒ¨å±æ€§ _a èµ‹å€¼ç»™ a ç»§ç»­çœ‹main_block_func_0 çš„å®ç°å¦‚ä¸‹ï¼š 12345static void __main_block_func_0(struct __main_block_impl_0 *__cself) { int a = __cself-&gt;a; // bound by copy NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_kh_ym1km6hs1_510g123chch8bm0000gp_T_main_b68344_mi_0, a);} æ³¨æ„è¿™è¡Œä»£ç ï¼š 1int a = __cself-&gt;a; // bound by copy æ­¤æ—¶é™æ€å‡½æ•°__main_block_func_0çš„å†…éƒ¨å¯¹ä¼ å…¥çš„ block è¿›è¡Œäº†å¤„ç†â€”â€”æ¥å—äº†å…¶å†…éƒ¨çš„å˜é‡aâ€”â€”é€šè¿‡è‡ªèº«æ–°ç”Ÿæˆä¸€ä¸ªa __cselfæ˜¯__main_block_impl_0çš„æŒ‡é’ˆï¼Œå³ block æœ¬èº« int a = __cself-&gt;aå³int a = block-&gt;a è‡ªåŠ¨ç”Ÿæˆçš„æ³¨é‡Šå¾ˆæ¸…æ™°çš„è¯´æ˜äº†åŸç†ï¼šé€šè¿‡copyç»‘å®šæ–°çš„å€¼ï¼Œæ‰€ä»¥è¯´æ˜¯==å€¼æ•è·==ã€‚ 3.1.2 æ•è·å±€éƒ¨é™æ€å˜é‡==å±€éƒ¨é™æ€å˜é‡çš„æ•è·ï¼Œæ˜¯æŒ‡é’ˆæ•è·== 123456789static NSInteger num = 3;NSInteger (^block)(NSInteger) = ^(NSInteger n){ return n * num; // 2 * 1 = 2};num = 1;NSLog(@&quot;%ld&quot;, (long)block(2)); ç¼–è¯‘ä¸ºcppï¼š 123456789101112131415161718192021222324252627282930313233343536373839struct __main_block_impl_0 { struct __block_impl impl; struct __main_block_desc_0* Desc; NSInteger *num; // âœ…æ–°ç”Ÿæˆçš„ __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, NSInteger *_num, int flags=0) : num(_num) { impl.isa = &amp;_NSConcreteStackBlock; impl.Flags = flags; impl.FuncPtr = fp; Desc = desc; }};static long __main_block_func_0(struct __main_block_impl_0 *__cself, NSInteger n) { NSInteger *num = __cself-&gt;num; // bound by copy return n * (*num);}static struct __main_block_desc_0 { size_t reserved; size_t Block_size;} __main_block_desc_0_DATA = { 0, sizeof(struct __main_block_impl_0)};int main(int argc, char * argv[]) { NSString * appDelegateClassName; /* @autoreleasepool */ { __AtAutoreleasePool __autoreleasepool; static NSInteger num = 3; NSInteger (*block)(NSInteger) = ((long (*)(NSInteger))&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA, &amp;num)); // ç²¾ç®€ä¸º *block = __main_block_impl_0(&amp;__main_block_func_0, &amp;__main_block_desc_0_DATA, &amp;num); num = 1; NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_kh_ym1km6hs1_510g123chch8bm0000gp_T_main_ef866b_mi_0, (long)((NSInteger (*)(__block_impl *, NSInteger))((__block_impl *)block)-&gt;FuncPtr)((__block_impl *)block, 2)); appDelegateClassName = NSStringFromClass(((Class (*)(id, SEL))(void *)objc_msgSend)((id)objc_getClass(&quot;AppDelegate&quot;), sel_registerName(&quot;class&quot;))); } return UIApplicationMain(argc, argv, __null, appDelegateClassName);} å˜åŒ–ï¼š ç”Ÿæˆäº†æ–°çš„æ•´å½¢æŒ‡é’ˆNSInteger *num; å°†ä¼ å…¥çš„numèµ‹å€¼ç»™NSInteger *_num ä»£ç å—è°ƒç”¨æœ‰æ‰€ä¸åŒï¼Œå¦‚ä¸‹ï¼š 12345// åŸå‡½æ•° NSInteger (*block)(NSInteger) = ((long (*)(NSInteger))&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA, &amp;num));// ç²¾ç®€å__main_block_impl_0(&amp;__main_block_func_0, &amp;__main_block_desc_0_DATA, &amp;num) å¯ä»¥æ¸…æ™°çš„çœ‹å‡ºæ¥ï¼Œæ­¤æ—¶ä¼ å…¥çš„numæ˜¯ä¸€ä¸ªåœ°å€ï¼Œå¯è§ï¼Œæ˜¯è¿›è¡Œäº†==æŒ‡é’ˆæ‹·è´==ï¼Œè€Œä¸æ˜¯å€¼æ‹·è´ã€‚ 3.1.3 æ•è·å…¨å±€å˜é‡å’Œå…¨å±€é™æ€å˜é‡==å…¨å±€å˜é‡ã€å…¨å±€é™æ€å˜é‡çš„æ•è·æ˜¯ç›´æ¥å–å€¼== 123456789101112131415161718static NSInteger num3 = 300; // å…¨å±€é™æ€å˜é‡NSInteger num4 = 3000; // å…¨å±€å˜é‡int main(int argc, char * argv[]) { NSString *appDelegateClassName; @autoreleasepool { void(^block)(void) = ^{ NSLog(@&quot;%ld&quot;, (long)num3); NSLog(@&quot;%ld&quot;, (long)num4); }; block(); appDelegateClassName = NSStringFromClass([AppDelegate class]); } return UIApplicationMain(argc, argv, nil, appDelegateClassName);} ç¼–è¯‘ä¸ºc++ï¼š 1234567...// num3ã€num4åªåœ¨è¿™ä¸ªæ–¹æ³•ä¸­å‡ºç°äº†static void __main_block_func_0(struct __main_block_impl_0 *__cself) { NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_kh_ym1km6hs1_510g123chch8bm0000gp_T_main_8fd68e_mi_2, (long)num3); NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_kh_ym1km6hs1_510g123chch8bm0000gp_T_main_8fd68e_mi_3, (long)num4);}... æ²¡æœ‰åšä»»ä½•å¤„ç†ï¼Œåœ¨ block å‡½æ•°å†…éƒ¨ï¼Œé€šè¿‡ NSLog ç›´æ¥å–å€¼ ç»“è®ºï¼šé™æ€å˜é‡ã€å…¨å±€é™æ€å˜é‡ï¼Œå› ä¸ºä»–ä»¬å­˜åœ¨å…¨å±€å­˜å‚¨åŒºï¼Œå ç”¨é™æ€çš„å•å…ƒï¼Œæ‰€ä»¥block è°ƒç”¨æ—¶æ˜¯ç›´æ¥æŠŠå€¼å–è¿‡æ¥ç”¨ï¼Œå¹¶ä¸éœ€è¦æŒ‡é’ˆå¼•ç”¨ã€‚ 3.2 __block çš„åŸç†1234567891011121314151617#import &lt;UIKit/UIKit.h&gt;#import &quot;AppDelegate.h&quot;int main(int argc, char * argv[]) { NSString * appDelegateClassName; @autoreleasepool { // Setup code that might create autoreleased objects goes here. appDelegateClassName = NSStringFromClass([AppDelegate class]); __block NSString *name = [NSString stringWithFormat:@&quot;Felix&quot;]; void (^fxBlock)(void) = ^{ // ç¬¬ä¸€å±‚ block copy name = @&quot;Feng Felix&quot;; }; fxBlock(); } return UIApplicationMain(argc, argv, nil, appDelegateClassName);} 3.2.1 ç¬¬ä¸€å±‚æ‹·è´ï¼ˆblockï¼‰blockä¸­çš„ç¬¬ä¸€å±‚æ‹·è´å…¶å®å·²ç»è®²è¿‡äº†â€”â€”_Block_copyå°† block ä»æ ˆæ‹·è´åˆ°å † 3.2.2 ç¬¬äºŒå±‚æ‹·è´ï¼ˆæ•è·å˜é‡çš„å†…å­˜ç©ºé—´ï¼‰ åœ¨å‡½æ•°å£°æ˜æ—¶ä¼šä¼ __main_block_desc_0_DATAç»“æ„ä½“çš„åœ°å€ï¼Œåœ¨é‡Œé¢åˆä¼šå»è°ƒç”¨__main_block_copy_0å‡½æ•°ï¼Œé‡Œé¢ä¼šè°ƒç”¨_Block_object_assignâ€”â€”è¿™å°±æ˜¯ç¬¬äºŒå±‚æ‹·è´çš„è°ƒç”¨å…¥å£ æ¥ä¸‹æ¥å°±æ¥çœ‹çœ‹_Block_object_assignåœ¨åº•å±‚éƒ½åšäº†ä»€ä¹ˆï¼ˆæ³¨æ„ä¼ å‚ï¼‰ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768void _Block_object_assign(void *destArg, const void *object, const int flags) { const void **dest = (const void **)destArg; switch (os_assumes(flags &amp; BLOCK_ALL_COPY_DISPOSE_FLAGS)) { case BLOCK_FIELD_IS_OBJECT: /******* id object = ...; [^{ object; } copy]; ********/ _Block_retain_object(object); *dest = object; break; case BLOCK_FIELD_IS_BLOCK: /******* void (^object)(void) = ...; [^{ object; } copy]; ********/ *dest = _Block_copy(object); break; case BLOCK_FIELD_IS_BYREF | BLOCK_FIELD_IS_WEAK: case BLOCK_FIELD_IS_BYREF: // âœ…èµ°è¿™é‡Œ /******* // copy the onstack __block container to the heap // Note this __weak is old GC-weak/MRC-unretained. // ARC-style __weak is handled by the copy helper directly. __block ... x; __weak __block ... x; [^{ x; } copy]; ********/ *dest = _Block_byref_copy(object); break; case BLOCK_BYREF_CALLER | BLOCK_FIELD_IS_OBJECT: case BLOCK_BYREF_CALLER | BLOCK_FIELD_IS_BLOCK: /******* // copy the actual field held in the __block container // Note this is MRC unretained __block only. // ARC retained __block is handled by the copy helper directly. __block id object; __block void (^object)(void); [^{ object; } copy]; ********/ *dest = object; break; case BLOCK_BYREF_CALLER | BLOCK_FIELD_IS_OBJECT | BLOCK_FIELD_IS_WEAK: case BLOCK_BYREF_CALLER | BLOCK_FIELD_IS_BLOCK | BLOCK_FIELD_IS_WEAK: /******* // copy the actual field held in the __block container // Note this __weak is old GC-weak/MRC-unretained. // ARC-style __weak is handled by the copy helper directly. __weak __block id object; __weak __block void (^object)(void); [^{ object; } copy]; ********/ *dest = object; break; default: break; }} æ ¹æ®flags &amp; BLOCK_ALL_COPY_DISPOSE_FLAGSçš„ç»“æœè¿›åˆ°ä¸åŒåˆ†æ”¯æ¥å¤„ç†æ•è·åˆ°çš„å˜é‡ æšä¸¾å€¼ æ•°å€¼ å«ä¹‰ BLOCK_FIELD_IS_OBJECT 3 å¯¹è±¡ BLOCK_FIELD_IS_BLOCK 7 blockå˜é‡ BLOCK_FIELD_IS_BYREF 8 __blockä¿®é¥°çš„ç»“æ„ä½“ BLOCK_FIELD_IS_WEAK 16 __weakä¿®é¥°çš„å˜é‡ BLOCK_BYREF_CALLER 128 å¤„ç†block_byrefå†…éƒ¨å¯¹è±¡å†…å­˜çš„æ—¶å€™ ä¼šåŠ çš„ä¸€ä¸ªé¢å¤–çš„æ ‡è®°ï¼Œé…åˆä¸Šé¢çš„æšä¸¾ä¸€èµ·ä½¿ç”¨ æ­¤æ—¶æ•è·åˆ°çš„å˜é‡æ˜¯__Block_byref_name_0ï¼Œæ˜¯BLOCK_FIELD_IS_BYREFç±»å‹ï¼Œå°±ä¼šè°ƒç”¨*dest = _Block_byref_copy(object); 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647static struct Block_byref *_Block_byref_copy(const void *arg) { // ä¸´æ—¶å˜é‡çš„ä¿å­˜ struct Block_byref *src = (struct Block_byref *)arg; if ((src-&gt;forwarding-&gt;flags &amp; BLOCK_REFCOUNT_MASK) == 0) { // src points to stack // ç”¨åŸç›®æ ‡çš„å¤§å°åœ¨å †åŒºç”Ÿæˆä¸€ä¸ªBlock_byref struct Block_byref *copy = (struct Block_byref *)malloc(src-&gt;size); copy-&gt;isa = NULL; // byref value 4 is logical refcount of 2: one for caller, one for stack copy-&gt;flags = src-&gt;flags | BLOCK_BYREF_NEEDS_FREE | 4; // åŸæ¥çš„åŒºåŸŸå’Œæ–°çš„åŒºåŸŸéƒ½æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼Œä½¿å¾— block å…·å¤‡äº†ä¿®æ”¹èƒ½åŠ› copy-&gt;forwarding = copy; // patch heap copy to point to itself src-&gt;forwarding = copy; // patch stack to point to heap copy copy-&gt;size = src-&gt;size; if (src-&gt;flags &amp; BLOCK_BYREF_HAS_COPY_DISPOSE) { // Trust copy helper to copy everything of interest // If more than one field shows up in a byref block this is wrong XXX struct Block_byref_2 *src2 = (struct Block_byref_2 *)(src+1); struct Block_byref_2 *copy2 = (struct Block_byref_2 *)(copy+1); copy2-&gt;byref_keep = src2-&gt;byref_keep; copy2-&gt;byref_destroy = src2-&gt;byref_destroy; if (src-&gt;flags &amp; BLOCK_BYREF_LAYOUT_EXTENDED) { struct Block_byref_3 *src3 = (struct Block_byref_3 *)(src2+1); struct Block_byref_3 *copy3 = (struct Block_byref_3*)(copy2+1); copy3-&gt;layout = src3-&gt;layout; } (*src2-&gt;byref_keep)(copy, src); // âœ…å¼€å§‹ç¬¬ä¸‰å±‚æ‹·è´ } else { // Bitwise copy. // This copy includes Block_byref_3, if any. memmove(copy+1, src+1, src-&gt;size - sizeof(*src)); } } // already copied to heap else if ((src-&gt;forwarding-&gt;flags &amp; BLOCK_BYREF_NEEDS_FREE) == BLOCK_BYREF_NEEDS_FREE) { latching_incr_int(&amp;src-&gt;forwarding-&gt;flags); } return src-&gt;forwarding;} ç”¨åŸç›®æ ‡nameçš„å¤§å°åœ¨å †åŒºç”Ÿæˆä¸€ä¸ªBlock_byref copy-&gt;forwarding = copy; &amp; src-&gt;forwarding = copy;â€”â€”åŸæ¥çš„åŒºåŸŸå’Œæ–°çš„åŒºåŸŸéƒ½æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼Œä½¿å¾— block å…·å¤‡äº†ä¿®æ”¹èƒ½åŠ› (*src2-&gt;byref_keep)(copy, src)å¼€å§‹ç¬¬ä¸‰å±‚æ‹·è´ 3.2.3 ç¬¬ä¸‰å±‚æ‹·è´ï¼ˆæ‹·è´å¯¹è±¡ï¼‰(*src2-&gt;byref_keep)(copy, src)è·Ÿè¿›å»ä¼šæ¥åˆ°Block_byrefç»“æ„ï¼Œè€Œbyref_keepæ˜¯Block_byrefçš„ç¬¬5ä¸ªå±æ€§ 1234567891011121314151617struct Block_byref { void *isa; struct Block_byref *forwarding; volatile int32_t flags; // contains ref count uint32_t size;};struct Block_byref_2 { // requires BLOCK_BYREF_HAS_COPY_DISPOSE BlockByrefKeepFunction byref_keep; // âœ… BlockByrefDestroyFunction byref_destroy;};struct Block_byref_3 { // requires BLOCK_BYREF_LAYOUT_EXTENDED const char *layout;}; __blockä¿®é¥°çš„å˜é‡åœ¨åº•å±‚å…¶å®è°ƒç”¨äº†å¦‚ä¸‹çš„æ„é€ æ–¹æ³• æ­¤æ—¶çš„ç¬¬5ä½å°±æ˜¯byref_keepï¼Œæ‰€ä»¥åœ¨ç¬¬äºŒå±‚æ‹·è´æ—¶ä¼šè°ƒç”¨__Block_byref_id_object_copy_131 123456static void __Block_byref_id_object_copy_131(void *dst, void *src) { _Block_object_assign((char*)dst + 40, *(void * *) ((char*)src + 40), 131);}static void __Block_byref_id_object_dispose_131(void *src) { _Block_object_dispose(*(void * *) ((char*)src + 40), 131);} è¿™ä¸ªå‡½æ•°ä¼šå»è°ƒç”¨_Block_object_assignå‡½æ•°ã€‚ è€Œ_Block_object_assignåœ¨å¯¹BLOCK_FIELD_IS_OBJECTæƒ…å†µæ—¶ä¼šåšå‡ºå¦‚ä¸‹æ“ä½œï¼š 123456789case BLOCK_FIELD_IS_OBJECT: /******* id object = ...; [^{ object; } copy]; ********/ _Block_retain_object(object); *dest = object; break; _Block_retain_objectæ˜¯ä¸ªç©ºå‡½æ•°ï¼Œå› ä¸ºblockæ•è·çš„å¤–æ¥å˜é‡ç”±ARCè‡ªåŠ¨ç®¡ç† æ•è·åˆ°nameè¿›è¡Œæ‹·è´ 3.2.4 _Block_object_disposeçœ‹å®Œäº†ä¸‰å±‚æ‹·è´ï¼Œå†æ¥çœ‹ä¸€ä¸‹é‡Šæ”¾å‡½æ•°_Block_object_dispose 1234567891011121314151617181920212223242526272829303132333435363738394041void _Block_object_dispose(const void *object, const int flags) { switch (os_assumes(flags &amp; BLOCK_ALL_COPY_DISPOSE_FLAGS)) { case BLOCK_FIELD_IS_BYREF | BLOCK_FIELD_IS_WEAK: case BLOCK_FIELD_IS_BYREF: // get rid of the __block data structure held in a Block _Block_byref_release(object); // å¦‚æœæ˜¯`__block`ä¿®é¥°ï¼Œå°±å°†æŒ‡é’ˆæŒ‡å›åŸæ¥çš„åŒºåŸŸå¹¶ä½¿ç”¨`free`é‡Šæ”¾ break; case BLOCK_FIELD_IS_BLOCK: _Block_release(object); break; case BLOCK_FIELD_IS_OBJECT: _Block_release_object(object); // å¦‚æœæ˜¯é‡Šæ”¾å¯¹è±¡å°±ä»€ä¹ˆä¹Ÿä¸åšï¼ˆè‡ªåŠ¨é‡Šæ”¾ï¼‰ break; case BLOCK_BYREF_CALLER | BLOCK_FIELD_IS_OBJECT: case BLOCK_BYREF_CALLER | BLOCK_FIELD_IS_BLOCK: case BLOCK_BYREF_CALLER | BLOCK_FIELD_IS_OBJECT | BLOCK_FIELD_IS_WEAK: case BLOCK_BYREF_CALLER | BLOCK_FIELD_IS_BLOCK | BLOCK_FIELD_IS_WEAK: break; default: break; }}static void _Block_byref_release(const void *arg) { struct Block_byref *byref = (struct Block_byref *)arg; // dereference the forwarding pointer since the compiler isn't doing this anymore (ever?) byref = byref-&gt;forwarding; if (byref-&gt;flags &amp; BLOCK_BYREF_NEEDS_FREE) { int32_t refcount = byref-&gt;flags &amp; BLOCK_REFCOUNT_MASK; os_assert(refcount); if (latching_decr_int_should_deallocate(&amp;byref-&gt;flags)) { if (byref-&gt;flags &amp; BLOCK_BYREF_HAS_COPY_DISPOSE) { struct Block_byref_2 *byref2 = (struct Block_byref_2 *)(byref+1); (*byref2-&gt;byref_destroy)(byref); } free(byref); } }} å¦‚æœæ˜¯é‡Šæ”¾å¯¹è±¡å°±ä»€ä¹ˆä¹Ÿä¸åšï¼ˆè‡ªåŠ¨é‡Šæ”¾ï¼‰ å¦‚æœæ˜¯__blockä¿®é¥°ï¼Œå°±å°†æŒ‡å‘æŒ‡å›åŸæ¥çš„åŒºåŸŸå¹¶ä½¿ç”¨freeé‡Šæ”¾ 3.3 Block ç­¾å3.3.1 è¡¥ä¹ ï¼šæ–¹æ³•ç­¾ååœ¨OCä¸­æ‰€æœ‰çš„æ–¹æ³•éƒ½æœ‰ç­¾åä¿¡æ¯ï¼Œç­¾åä¿¡æ¯åŒ…å«äº†æ–¹æ³•çš„==å‚æ•°ç±»å‹==ã€==å‚æ•°ä¸ªæ•°==å’Œ==è¿”å›å€¼ç±»å‹==ç­‰ã€‚ è·å–å®ä¾‹æ–¹æ³•çš„æ–¹æ³•ç­¾åï¼š 123Method method = class_getInstanceMethod([NSObject class], @selector(performSelector:withObject:));const char *types = method_getTypeEncoding(method);printf(&quot;types == %s\\n&quot;, types); æ‰“å°ï¼š 1types == @32@0:8:16@24 è·å–ç±»æ–¹æ³•çš„æ–¹æ³•ç­¾å: 123Method method = class_getClassMethod([NSObject class], @selector(copyWithZone:));const char *types = method_getTypeEncoding(method);printf(&quot;types == %s\\n&quot;, types); æ‰“å°ï¼š 1types == @24@0:8^{_NSZone=}16 è·å–åˆ°æ–¹æ³•çš„ç­¾åå°±å¯ä»¥çŸ¥é“æ‰§è¡Œæ–¹æ³•æ‰€éœ€è¦çš„å‚æ•°ä¸ªæ•°ï¼Œå„ä¸ªå‚æ•°çš„ç±»å‹ä»¥åŠè¿”å›ç»“æœç±»å‹ï¼Œæ‰§è¡Œæ–¹æ³•æ‰€éœ€è¦çš„æ¡ä»¶ä¹Ÿå°±éšä¹‹ç¡®å®šï¼Œå°±å¯ä»¥å¯¹æ–¹æ³•è¿›è¡Œå„ç§å„æ ·çš„æ“ä½œï¼Œä¾‹å¦‚å°†æ–¹æ³•æ·»åŠ åˆ°æŒ‡å®šçš„ç±»ä¸­ã€‚ Block åœ¨ OC ä¸­æ˜¯ä¸€ä¸ªéå¸¸ç¥å¥‡çš„å­˜åœ¨ï¼Œå³å…·å¤‡äº†å¯¹è±¡çš„ç‰¹æ€§(å…·å¤‡ isa æŒ‡é’ˆ)ï¼Œåˆå…·å¤‡äº†æ–¹æ³•çš„ç‰¹æ€§(å…·æœ‰è‡ªå·±çš„å®ç°å‡½æ•°)ï¼Œè¿™å°±æ³¨å®šäº† Block ä¼šä¸ä¼—ä¸åŒã€‚é‚£ä¹ˆæ—¢ç„¶ Blockæ˜¯â€æ–¹æ³•â€ï¼Œæ–¹æ³•ç¼–ç è‚¯å®šæ˜¯æœ‰çš„ï¼Œä¸‹é¢è®²è¿°å¦‚ä½•è·å–ä¹‹ã€‚ 3.3.2 Block ç»“æ„åˆ†æè¿›å…¥æˆ‘Githubä¸Šçš„libclosure-78æºç  é¦–å…ˆæ¥çœ‹ block ç»“æ„ä½“å¯¹è±¡Block_layout 12345678910111213141516171819202122232425262728#define BLOCK_DESCRIPTOR_1 1struct Block_descriptor_1 { uintptr_t reserved; uintptr_t size;};#define BLOCK_DESCRIPTOR_2 1struct Block_descriptor_2 { // requires BLOCK_HAS_COPY_DISPOSE BlockCopyFunction copy; BlockDisposeFunction dispose;};#define BLOCK_DESCRIPTOR_3 1struct Block_descriptor_3 { // requires BLOCK_HAS_SIGNATURE const char *signature; const char *layout; // contents depend on BLOCK_HAS_EXTENDED_LAYOUT};struct Block_layout { void *isa; volatile int32_t flags; // contains ref count int32_t reserved; BlockInvokeFunction invoke; struct Block_descriptor_1 *descriptor; // // imported variables}; æŸ¥çœ‹ flagsï¼š 12345678910111213// Values for Block_layout-&gt;flags to describe block objectsenum { BLOCK_DEALLOCATING = (0x0001), // runtime BLOCK_REFCOUNT_MASK = (0xfffe), // runtime BLOCK_NEEDS_FREE = (1 &lt;&lt; 24), // runtime BLOCK_HAS_COPY_DISPOSE = (1 &lt;&lt; 25), // compiler BLOCK_HAS_CTOR = (1 &lt;&lt; 26), // compiler: helpers have C++ code BLOCK_IS_GC = (1 &lt;&lt; 27), // runtime BLOCK_IS_GLOBAL = (1 &lt;&lt; 28), // compiler BLOCK_USE_STRET = (1 &lt;&lt; 29), // compiler: undefined if !BLOCK_HAS_SIGNATURE BLOCK_HAS_SIGNATURE = (1 &lt;&lt; 30), // compiler BLOCK_HAS_EXTENDED_LAYOUT=(1 &lt;&lt; 31) // compiler}; å¯ä»¥çœ‹å‡ºåœ¨ Block çš„ç»“æ„ä¸­ï¼š isa: ä¹‹æ‰€ä»¥ Block èƒ½å…·å¤‡å¯¹è±¡çš„ç‰¹æ€§ä¹Ÿæ˜¯ç”±äº Block çš„ç»“æ„ä¸­å…·å¤‡äº† isa æŒ‡é’ˆ flagsï¼šæ ‡è¯†ä½ï¼Œä¿å­˜äº†ç›¸å…³çš„æ ‡è¯†ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ˜¯å¦é‡Šæ”¾Blockçš„å¼•ç”¨è®¡æ•°ä¿¡æ¯,æ˜¯å¦éœ€è¦é‡Šæ”¾Blockï¼Œæ˜¯å¦åŒ…å«copyï¼Œdisposeå‡½æ•°,æ˜¯å¦å…·å¤‡ç­¾åç­‰ä¿¡æ¯ reservedï¼šé¢„ç•™ä¿¡æ¯ä½ï¼Œé»˜è®¤ä¸º0 invokeï¼šå‡½æ•°å®ç°çš„åœ°å€ Block_descriptor_1ï¼šBlock çš„æè¿°ä¿¡æ¯ç»“æ„ä½“ï¼Œè¯¥ç»“æ„æ˜¯åŠ¨æ€ç”Ÿæˆçš„ã€‚ä¸€èˆ¬æ¥è¯´éƒ½åŒ…å«BLOCK_DESCRIPTOR_1ï¼Œä½†æ˜¯æ˜¯å¦åŒ…å«BLOCK_DESCRIPTOR_2å’ŒBLOCK_DESCRIPTOR_3éœ€è¦æ ¹æ®å®é™…çš„éœ€æ±‚æ¥ç¡®å®šã€‚è€Œflagsä¸­è®°å½• Block å®ç°ä¸­æ˜¯å¦åŒ…å«è¿™æ ·çš„æè¿°ç»“æ„ï¼š(flags &amp; BLOCK_HAS_COPY_DISPOSE)ä¸ºçœŸåˆ™è¯æ˜åŒ…å«BLOCK_DESCRIPTOR_2ï¼›(flags &amp; BLOCK_HAS_SIGNATURE)ä¸ºçœŸåˆ™è¯æ˜åŒ…å«äº†BLOCK_DESCRIPTOR_3 3.3.3 è·å– Block ç­¾åé¦–å…ˆä½¿ç”¨å…¨å±€ block æµ‹è¯•ï¼š 1234void(^block)(void) = ^{ NSLog(@&quot;aa&quot;);};block(); è¿æ¥çœŸæœºã€‚é…ç½®æ±‡ç¼–ç›‘æ§æ‰“å¼€ï¼šXcodeâ€”â€”Debugâ€”â€”Debug Workflowâ€”â€”Always show Dissembly å¯¹ block ä»£ç å—æ‰“æ–­ç‚¹ï¼Œè¿è¡Œç¨‹åº ä¼šè·³è½¬åˆ°æ±‡ç¼–çš„ main æ­¥éª¤ï¼Œé€šè¿‡Step Overé”®è¿›å…¥åˆ° objc_retainBlockå‡½æ•°ä¸‹ æ‰“å°å½“å‰ x0 å¯„å­˜å™¨ï¼šregister read x0å¾—åˆ°å½“å‰è¿è¡Œçš„ block å‡½æ•°çš„ä½ç½® æ‰“å°åœ°å€ä¸­å­˜çš„ä¿¡æ¯ï¼Œå¾—åˆ° block çš„ç±»å‹ã€ç­¾åå’Œå†…éƒ¨å®ç°åœ°å€ è¯¦æƒ…çœ‹ä¸‹å›¾ï¼š è®¿é—® Block_descriptor_2 1234567static struct Block_descriptor_2 * _Block_descriptor_2(struct Block_layout *aBlock){ if (! (aBlock-&gt;flags &amp; BLOCK_HAS_COPY_DISPOSE)) return NULL; uint8_t *desc = (uint8_t *)aBlock-&gt;descriptor; desc += sizeof(struct Block_descriptor_1); return (struct Block_descriptor_2 *)desc;} å¦‚æœaBlock-&gt;flags &amp; BLOCK_HAS_COPY_DISPOSEæ»¡è¶³ï¼Œåˆ™_Block_descriptor_2å­˜åœ¨ï¼Œåä¹‹åˆ™ block æ²¡æœ‰_Block_descriptor_2è¿™ä¸ªç»“æ„ _Block_descriptor_2å¯ä»¥é€šè¿‡Block_descriptor_1å†…å­˜åç§»å¾—åˆ° è®¿é—® Block_descriptor_3 12345678910static struct Block_descriptor_3 * _Block_descriptor_3(struct Block_layout *aBlock){ if (! (aBlock-&gt;flags &amp; BLOCK_HAS_SIGNATURE)) return NULL; uint8_t *desc = (uint8_t *)aBlock-&gt;descriptor; desc += sizeof(struct Block_descriptor_1); if (aBlock-&gt;flags &amp; BLOCK_HAS_COPY_DISPOSE) { desc += sizeof(struct Block_descriptor_2); } return (struct Block_descriptor_3 *)desc;} åŒç†ï¼ŒaBlock-&gt;flags &amp; BLOCK_HAS_SIGNATUREæ»¡è¶³ï¼Œ_Block_descriptor_3å­˜åœ¨ _Block_descriptor_3å¯ä»¥é€šè¿‡Block_descriptor_2å†…å­˜åç§»å¾—åˆ° 3.4 æ€»ç»“ blockçš„æ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶åº•å±‚å®ç°æ˜¯ä¸ª__main_block_impl_0çš„ç»“æ„ä½“ï¼Œæ‰€ä»¥èƒ½ç”¨%@æ‰“å° blockå£°æ˜åªæ˜¯å°†blockå®ç°ä¿å­˜èµ·æ¥ï¼Œå…·ä½“çš„å‡½æ•°å®ç°éœ€è¦è‡ªè¡Œè°ƒç”¨ blockä¹Ÿæœ‰ç­¾åï¼Œå’Œæ–¹æ³•ç­¾åç•¥æœ‰ä¸åŒ blockæ•è·å¤–ç•Œå˜é‡æ—¶blockç»“æ„ä½“ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªå±æ€§æ¥ä¿å­˜å˜é‡ __blockä¿®é¥°çš„å¤–éƒ¨å˜é‡åœ¨blockå†…éƒ¨èƒ½å¤Ÿä¿®æ”¹çš„åŸå› åœ¨äº3æ¬¡æ‹·è´ï¼š blockçš„æ‹·è´ï¼Œä»æ ˆå†…å­˜åˆ°å †å†…å­˜ å°†ä¿®é¥°çš„å¯¹è±¡è½¬åŒ–ä¸ºä¸€ä¸ªç»“æ„ä½“ï¼Œå°†å…¶æ‹·è´åˆ°å †å†…å­˜ å°†ä¿®é¥°çš„å¯¹è±¡çš„å†…å­˜åœ°å€ä¹Ÿè¿›è¡Œäº†æ‹·è´ç”¨ä»¥ä¿®æ”¹ PSæˆ‘Githubä¸Šçš„libclosure-78æºç  å‚è€ƒBlockä½¿ç”¨åŠåŸç†æ¢ç©¶ iOSæ¢ç´¢ å…¨æ–¹ä½è§£è¯»Block Blockæ¢ç´¢ Block ç­¾åä¿¡æ¯çš„ä½¿ç”¨ iOS-block(äºŒ)-åº•å±‚åˆ†æ","link":"/2021/07/06/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/20-Block%E7%9A%84%E4%BD%BF%E7%94%A8%E5%8F%8A%E5%8E%9F%E7%90%86/"},{"title":"21-LLVMåˆæ¢","text":"ä¸€ã€å‰è¨€è®¡ç®—æœºæ˜¯åªèƒ½ç›´æ¥ç†è§£æœºå™¨è¯­è¨€ï¼Œè€Œä¸èƒ½ç›´æ¥ç†è§£é«˜çº§è¯­è¨€çš„ï¼Œæ‰€ä»¥è®¡ç®—æœºè¦æ‰§è¡Œé«˜çº§è¯­è¨€ç¼–å†™çš„ç¨‹åºï¼Œå°±å¿…é¡»è¦æŠŠé«˜çº§è¯­è¨€ç¿»è¯‘æˆæœºå™¨è¯­è¨€ã€‚ç¿»è¯‘æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€æ˜¯ç¼–è¯‘ï¼Œä¸€æ˜¯è§£é‡Šã€‚æ‰€ä»¥ä¸èƒ½è¢«è®¡ç®—æœºç›´æ¥è¯†åˆ«çš„ç¼–ç¨‹è¯­è¨€ä¹Ÿå¯ä»¥åˆ†ä¸ºè§£é‡Šå‹è¯­è¨€å’Œç¼–è¯‘å‹è¯­è¨€ã€‚ 1.1 è§£é‡Šå‹è¯­è¨€ç¨‹åºä¸éœ€è¦æå‰ç¼–è¯‘ï¼Œåªéœ€è¦åœ¨è¿è¡Œæ—¶ä½¿ç”¨ä¸“é—¨çš„è§£é‡Šå™¨å¯¹æºç¨‹åºé€è¡Œè§£é‡Šæˆç‰¹å®šå¹³å°çš„æœºå™¨ç å¹¶æ‰§è¡Œã€‚ä¸€èˆ¬ç”¨äºè„šæœ¬ã€è¾…åŠ©å¼€å‘ç­‰ã€‚å¸¸è§çš„è§£é‡Šå‹è¯­è¨€æœ‰Pythonã€JavaScriptã€VBScriptã€Perlã€Rubyã€MATLABç­‰ç­‰ã€‚ ç‰¹ç‚¹ï¼š æ¯æ¬¡æ‰§è¡Œéƒ½éœ€è¦å°†æºä»£ç é€è¡Œè¿›è¡Œè§£é‡Šï¼Œæ•ˆç‡è¾ƒä½ 1.2 ç¼–è¯‘å‹è¯­è¨€ç¨‹åºåœ¨æ‰§è¡Œä¹‹å‰éœ€è¦ä¸€ä¸ªä¸“é—¨çš„ç¼–è¯‘è¿‡ç¨‹ï¼Œä½¿ç”¨ä¸“é—¨çš„ç¼–è¯‘å™¨ï¼Œé’ˆå¯¹ç‰¹å®šçš„å¹³å°ï¼Œå°†æºä»£ç ä¸€æ¬¡æ€§çš„ç¼–è¯‘æˆå¯è¢«è¯¥å¹³å°ç¡¬ä»¶æ‰§è¡Œçš„ä»£ç ï¼Œå¹¶åŒ…è£…æˆè¯¥å¹³å°æ‰€èƒ½è¯†åˆ«çš„å¯æ‰§è¡Œæ€§ç¨‹åºçš„æ ¼å¼ã€‚åœ¨è¿è¡Œæ—¶ä¸éœ€è¦é‡æ–°ç¿»è¯‘ï¼Œç›´æ¥ä½¿ç”¨ç¼–è¯‘çš„ç»“æœå³å¯ã€‚å¸¸è§çš„ç¼–è¯‘å‹è¯­è¨€æœ‰Cã€C++ã€Objective-Cç­‰ç­‰ã€‚ ç‰¹ç‚¹ï¼š åœ¨æ‰§è¡Œå‰æœ‰ä¸€ä¸ªä¸“é—¨çš„ç¼–è¯‘è¿‡ç¨‹ï¼Œå°†ç¼–ç ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ è¿è¡Œæ—¶ä¸éœ€è¦ç¼–è¯‘ï¼Œæ‰§è¡Œæ•ˆç‡é«˜ äºŒã€iOSæŒ‡ä»¤æ¶æ„2.1 ä¸åŒæœºå‹çš„æŒ‡ä»¤é›†çœŸæœºçš„æŒ‡ä»¤é›†ï¼š iPhone5SåŠä»¥ä¸Šæœºå‹ä½¿ç”¨arm64æŒ‡ä»¤é›† æ—©æœŸçš„æœºå‹ä½¿ç”¨çš„æ˜¯armv7sã€armv7 æ¨¡æ‹Ÿå™¨æŒ‡ä»¤é›†ï¼š 32ä½å¤„ç†å™¨æ˜¯i386æ¶æ„ 64ä½å¤„ç†å™¨æ˜¯x86_64æ¶æ„ M1 Chip æ¨¡æ‹Ÿå™¨æ˜¯arm64æ¶æ„ 2.2 Xcodeä¸­æŒ‡ä»¤é›†ç›¸å…³Build Setting ä¸­ï¼š Architecturesï¼šé¡¹ç›®å¯æ”¯æŒå“ªäº›æŒ‡ä»¤é›†ç±»å‹ã€‚ Valid Architecturesï¼šé™åˆ¶å¯èƒ½è¢«æ”¯æŒçš„æŒ‡ä»¤é›†çš„èŒƒå›´ã€‚ä¹Ÿå°±æ˜¯Xcodeç¼–è¯‘å‡ºæ¥çš„äºŒè¿›åˆ¶åŒ…ç±»å‹æœ€ç»ˆä»è¿™äº›ç±»å‹äº§ç”Ÿï¼Œè€Œç¼–è¯‘å‡ºå“ªç§æŒ‡ä»¤é›†çš„åŒ…ï¼Œåˆ™ç”±Architecturesä¸Valid Architecturesçš„äº¤é›†æ¥ç¡®å®šã€‚å› æ­¤è¿™ä¸ªé€‰é¡¹ä¸èƒ½ä¸ºç©ºã€‚ Build Active Architecture Onlyï¼šæŒ‡å®šæ˜¯å¦åªå¯¹å½“å‰è¿æ¥è®¾å¤‡æ‰€æ”¯æŒçš„æŒ‡ä»¤é›†ç¼–è¯‘ã€‚å½“å…¶å€¼è®¾ç½®ä¸ºYESï¼Œæ˜¯ä¸ºäº†debugçš„æ—¶å€™ç¼–è¯‘é€Ÿåº¦æ›´å¿«ï¼Œå®ƒåªç¼–è¯‘å½“å‰è®¾å¤‡çš„Architectureç‰ˆæœ¬ï¼Œè€Œè®¾ç½®ä¸ºNOæ—¶ï¼Œä¼šç¼–è¯‘æ‰€æœ‰çš„ç‰ˆæœ¬ã€‚æ‰€ä»¥ï¼Œä¸€èˆ¬debugçš„æ—¶å€™è®¾ç½®ä¸ºYESï¼Œreleaseçš„æ—¶å€™è®¾ç½®ä¸ºNOã€‚ ä¸‰ã€ä¸€èˆ¬ç¼–è¯‘å™¨è®¾è®¡ç®€å•çš„è¯´ï¼Œç¼–è¯‘å™¨å°±æ˜¯å°†ä¸€ç§è¯­è¨€ï¼ˆé€šå¸¸ä¸ºé«˜çº§è¯­è¨€ï¼‰ç¿»è¯‘ä¸ºå¦ä¸€ç§è¯­è¨€ï¼ˆé€šå¸¸ä¸ºä½çº§è¯­è¨€ï¼‰çš„ç¨‹åºã€‚ ä¼ ç»Ÿç¼–è¯‘å™¨è®¾è®¡ï¼š 3.1 ç¼–è¯‘å™¨å‰ç«¯(Frontend)è§£ææºä»£ç ã€‚å®ƒä¼šè¿›è¡Œï¼šè¯æ³•åˆ†æï¼Œè¯­æ³•åˆ†æï¼Œè¯­ä¹‰åˆ†æï¼Œæ£€æŸ¥æºä»£ç æ˜¯å¦å­˜åœ¨é”™è¯¯ï¼Œç„¶åæ„å»ºæŠ½è±¡è¯­æ³•æ ‘(Abstract Syntax Treeï¼ŒAST)ï¼ŒLLVM çš„å‰ç«¯è¿˜ä¼šç”Ÿæˆä¸­é—´ä»£ç IRã€‚ 3.2 ä¼˜åŒ–å™¨(Optimizer)ä¼˜åŒ–å™¨è´Ÿè´£å„ç§ä¼˜åŒ–ã€‚æ”¹å–„ä»£ç çš„è¿è¡Œæ—¶é—´ï¼Œä¾‹å¦‚æ¶ˆé™¤å†—ä½™è®¡ç®—ç­‰ã€‚ ä¼˜åŒ–å™¨ä¼˜åŒ–éƒ¨åˆ†æˆ‘ä»¬å¯ä»¥è°ƒèŠ‚ï¼š 3.3 åç«¯(Backend)/ä»£ç ç”Ÿæˆå™¨(CodeGenerator)å°†ä»£ç æ˜ å°„åˆ°ç›®æ ‡æŒ‡ä»¤é›†ï¼Œç”Ÿæˆæœºå™¨è¯­è¨€ï¼Œå¹¶ä¸”è¿›è¡Œæœºå™¨ç›¸å…³çš„ä»£ç ä¼˜åŒ–ã€‚ å››ã€iOS çš„ç¼–è¯‘å™¨æ¶æ„Objective C/C/C++ ä½¿ç”¨çš„ç¼–è¯‘å™¨å‰ç«¯æ˜¯ Clangï¼Œswift æ˜¯ Swiftã€‚åç«¯éƒ½æ˜¯ LLVMã€‚LLVM æ˜¯ç¼–è¯‘å™¨çš„æ¡†æ¶ç³»ç»Ÿï¼Œclang åªæ˜¯ç¼–è¯‘å™¨çš„å‰ç«¯éƒ¨åˆ†ã€‚ äº”ã€LLVMæ¦‚è¿°å…¶ä»–çš„ç¼–è¯‘å™¨å¦‚ GCCï¼Œä½œä¸ºäº†ä¸€ä¸ªæ•´ä½“çš„ç¨‹åºè¿›è¡Œè®¾è®¡ï¼Œæ‰€ä»¥ä¸å¤Ÿçµæ´»ã€‚LLVM æœ€é‡è¦çš„è®¾è®¡å°±æ˜¯ï¼Œä½¿ç”¨çš„é€šç”¨çš„ä»£ç è¡¨ç¤ºå½¢å¼IRã€‚æ‰€ä»¥ LLVM å¯ä»¥çµæ´»çš„å¢åŠ å‰ç«¯å’Œåç«¯ï¼Œåªè¦å¢åŠ çš„å‰ç«¯å’Œåç«¯ä½¿ç”¨åŒä¸€çš„è§„åˆ™IRå°±å¯ä»¥ã€‚ å…­ã€ClangClang å±äº LLVM æ¶æ„ä¸­çš„å‰ç«¯ï¼Œå®ƒçš„è¯ç”Ÿæ˜¯ä¸ºäº†æ›¿ä»£ GCCã€‚ ä¸ƒã€LLVM æ•´ä¸ªç¼–è¯‘æµç¨‹å…ˆè¯´ç»“è®ºï¼Œæ•´ä¸ªç¼–è¯‘æµç¨‹åŒ…æ‹¬ï¼š 0ï¼šè¾“å…¥åŸæ–‡ä»¶ 1ï¼šé¢„å¤„ç†è¿‡ç¨‹ï¼ŒåŒ…æ‹¬å®çš„æ›¿æ¢ï¼Œå¤´æ–‡ä»¶çš„å¯¼å…¥ç­‰ 2ï¼šç¼–è¯‘é˜¶æ®µï¼Œè¯æ³•åˆ†æã€è¯­æ³•åˆ†æï¼Œæœ€ç»ˆç”ŸæˆIRä»£ç  3ï¼šåç«¯ï¼Œä»£ç ä¼˜åŒ–å¤„ç†ï¼Œæœ€ç»ˆç”Ÿæˆæ±‡ç¼– 4ï¼šæ±‡ç¼–ç”Ÿæˆç›®æ ‡æ–‡ä»¶ 5ï¼šé“¾æ¥éœ€è¦çš„åŠ¨æ€åº“å’Œé™æ€åº“ï¼Œç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ 6ï¼šé€šè¿‡ä¸åŒçš„æ¶æ„ï¼Œç”Ÿæˆå¯¹è±¡çš„å¯æ‰§è¡Œæ–‡ä»¶ 7.1 å‘ç°ç¼–è¯‘æµç¨‹é¦–å…ˆæˆ‘ä»¬åœ¨main.mä¸­å®ç°å¦‚ä¸‹ä»£ç ï¼š 123456789#import &lt;stdio.h&gt;#define C 30int main(int argc, const char * argv[]) { int a = 10; int b = 20; printf(&quot;%d&quot;, a + b + C); return 0;} é€šè¿‡clangå‘½ä»¤å¯ä»¥æ‰“å°ä»£ç çš„ç¼–è¯‘æµç¨‹ï¼š 1clang -ccc-print-phases main.m æ‰“å°ç»“æœå¦‚ä¸‹ï¼š 12345670: input, &quot;main.m&quot;, objective-c1: preprocessor, {0}, objective-c-cpp-output2: compiler, {1}, ir3: backend, {2}, assembler4: assembler, {3}, object5: linker, {4}, image6: bind-arch, &quot;x86_64&quot;, {5}, image ä¸Šé¢è¿‡ç¨‹çš„è§£é‡Šï¼š 0ï¼šè¾“å…¥åŸæ–‡ä»¶ï¼› 1ï¼šé¢„å¤„ç†è¿‡ç¨‹ï¼ŒåŒ…æ‹¬å®çš„æ›¿æ¢ï¼Œå¤´æ–‡ä»¶çš„å¯¼å…¥ç­‰ï¼› 2ï¼šç¼–è¯‘é˜¶æ®µï¼Œè¯æ³•åˆ†æã€è¯­æ³•åˆ†æï¼Œæœ€ç»ˆç”ŸæˆIRä»£ç ã€‚ 3ï¼šåç«¯ï¼Œä»£ç ä¼˜åŒ–å¤„ç†ï¼Œæœ€ç»ˆç”Ÿæˆæ±‡ç¼–ï¼› 4ï¼šæ±‡ç¼–ç”Ÿæˆç›®æ ‡æ–‡ä»¶ï¼› 5ï¼šé“¾æ¥éœ€è¦çš„åŠ¨æ€åº“å’Œé™æ€åº“ï¼Œç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼› 6ï¼šé€šè¿‡ä¸åŒçš„æ¶æ„ï¼Œç”Ÿæˆå¯¹è±¡çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼› 7.2 é¢„å¤„ç†é˜¶æ®µä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼Œå°±å¯ä»¥æŸ¥çœ‹é¢„å¤„ç†é˜¶æ®µåšäº†ä»€ä¹ˆï¼š 1clang -E main.m &gt;&gt; mian2.m æ‰“å¼€main2.mï¼š 123456int main(int argc, const char * argv[]) { int a = 10; int b = 20; printf(&quot;%d&quot;, a + b + 30); return 0;} å¯ä»¥çœ‹å‡ºå¤´æ–‡ä»¶ç›¸å…³çš„ä¿¡æ¯éƒ½è¢«å¯¼å…¥ï¼Œè€Œä¸”å®å®šä¹‰ä¹Ÿè¢«æ›¿æ¢äº†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯typedefä¸æ˜¯é¢„å¤„ç†é˜¶æ®µå¤„ç†çš„ã€‚ 7.3 ç¼–è¯‘é˜¶æ®µ7.3.1 è¯æ³•åˆ†æé¢„å¤„ç†é˜¶æ®µå®Œæˆä¹‹åå°±ä¼šè¿›å…¥è¯æ³•åˆ†æï¼Œè¿™é‡Œä¼šæŠŠä»£ç åˆ‡æˆä¸€ä¸ªä¸ªTokenï¼Œæ¯”å¦‚å¤§å°æ‹¬å·ã€å­—ç¬¦ä¸²ç­‰ç­‰ã€‚ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼Œå°±å¯ä»¥æŸ¥çœ‹è¯æ³•åˆ†æåšäº†ä»€ä¹ˆï¼š 1clang -fmodules -fsyntax-only -Xclang -dump-tokens main.m ç»“æœï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445annot_module_include '#import &lt;stdio.h&gt;#define C 30int main(int argc, const char * argv[]) { int a' Loc=&lt;main.m:8:1&gt;int 'int' [StartOfLine] Loc=&lt;main.m:11:1&gt;identifier 'main' [LeadingSpace] Loc=&lt;main.m:11:5&gt;l_paren '(' Loc=&lt;main.m:11:9&gt;int 'int' Loc=&lt;main.m:11:10&gt;identifier 'argc' [LeadingSpace] Loc=&lt;main.m:11:14&gt;comma ',' Loc=&lt;main.m:11:18&gt;const 'const' [LeadingSpace] Loc=&lt;main.m:11:20&gt;char 'char' [LeadingSpace] Loc=&lt;main.m:11:26&gt;star '*' [LeadingSpace] Loc=&lt;main.m:11:31&gt;identifier 'argv' [LeadingSpace] Loc=&lt;main.m:11:33&gt;l_square '[' Loc=&lt;main.m:11:37&gt;r_square ']' Loc=&lt;main.m:11:38&gt;r_paren ')' Loc=&lt;main.m:11:39&gt;l_brace '{' [LeadingSpace] Loc=&lt;main.m:11:41&gt;int 'int' [StartOfLine] [LeadingSpace] Loc=&lt;main.m:12:5&gt;identifier 'a' [LeadingSpace] Loc=&lt;main.m:12:9&gt;equal '=' [LeadingSpace] Loc=&lt;main.m:12:11&gt;numeric_constant '10' [LeadingSpace] Loc=&lt;main.m:12:13&gt;semi ';' Loc=&lt;main.m:12:15&gt;int 'int' [StartOfLine] [LeadingSpace] Loc=&lt;main.m:13:5&gt;identifier 'b' [LeadingSpace] Loc=&lt;main.m:13:9&gt;equal '=' [LeadingSpace] Loc=&lt;main.m:13:11&gt;numeric_constant '20' [LeadingSpace] Loc=&lt;main.m:13:13&gt;semi ';' Loc=&lt;main.m:13:15&gt;identifier 'printf' [StartOfLine] [LeadingSpace] Loc=&lt;main.m:14:5&gt;l_paren '(' Loc=&lt;main.m:14:11&gt;string_literal '&quot;%d&quot;' Loc=&lt;main.m:14:12&gt;comma ',' Loc=&lt;main.m:14:16&gt;identifier 'a' [LeadingSpace] Loc=&lt;main.m:14:18&gt;plus '+' [LeadingSpace] Loc=&lt;main.m:14:20&gt;identifier 'b' [LeadingSpace] Loc=&lt;main.m:14:22&gt;plus '+' [LeadingSpace] Loc=&lt;main.m:14:24&gt;numeric_constant '30' [LeadingSpace] Loc=&lt;main.m:14:26 &lt;Spelling=main.m:9:11&gt;&gt;r_paren ')' Loc=&lt;main.m:14:27&gt;semi ';' Loc=&lt;main.m:14:28&gt;return 'return' [StartOfLine] [LeadingSpace] Loc=&lt;main.m:15:5&gt;numeric_constant '0' [LeadingSpace] Loc=&lt;main.m:15:12&gt;semi ';' Loc=&lt;main.m:15:13&gt;r_brace '}' [StartOfLine] Loc=&lt;main.m:16:1&gt;eof '' Loc=&lt;main.m:16:2&gt; ä»ç»“æœå¯ä»¥çœ‹å‡ºï¼Œè¯æ³•åˆ†ææ˜¯æŠŠä»£ç ä¸€ä¸ªè¯ä¸€ä¸ªè¯çš„åˆ†å¼€ï¼Œæ ‡è®°äº†å…·ä½“çš„ä½ç½®ï¼Œå¦‚è¡Œå·å’Œç¬¬ä¸€ä¸ªå­—ç¬¦çš„ä½ç½®ã€‚ 7.3.2 è¯­æ³•åˆ†æè¯æ³•åˆ†æä¹‹åå°±æ˜¯è¯­æ³•åˆ†æï¼Œè¯­æ³•åˆ†ææ‰€åšçš„äº‹æƒ…å°±æ˜¯æ£€æŸ¥è¯­æ³•æ˜¯å¦æ­£ç¡®ã€‚å®ƒæ˜¯åœ¨è¯æ³•åˆ†æçš„åŸºç¡€ä¸Šå°†æ‹†åˆ†çš„å•è¯ç»„åˆæˆçŸ­è¯­ï¼Œç„¶åå°†æ‰€æœ‰èŠ‚ç‚¹ç»„åˆæˆæŠ½è±¡è¯­æ³•æ ‘(AST abstract syntax tree)ã€‚ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼Œå°±å¯ä»¥æŸ¥çœ‹è¯­æ³•åˆ†æåšäº†ä»€ä¹ˆï¼š 1clang -fmodules -fsyntax-only -Xclang -ast-dump main.m ç»“æœï¼š ç»“åˆåŸæ¥çš„ä»£ç ï¼Œå¯ä»¥çœ‹å‡ºFunctionDeclè¿™å°±æ˜¯mainå‡½æ•°çš„æ ‡è¯†ã€‚DeclStmtå°±æ˜¯å‚æ•°èŠ‚ç‚¹ã€‚CallExpræ˜¯è°ƒç”¨å‡½æ•°çš„è¿”å›å€¼ï¼ŒImplicitCastExpræ˜¯å‡½æ•°çš„å‚æ•°æŒ‡é’ˆï¼ŒBinaryOperatoræ˜¯è¿ç®—ç¬¦ã€‚ReturnStmtåˆ™æ˜¯è¿”å›å€¼ã€‚ 7.4 ç”Ÿæˆä¸­é—´ä»£ç â€”IRè¿™æ˜¯LLVMæœ€ç‹¬ç‰¹çš„ä¸€ç‚¹ã€‚è¯­æ³•åˆ†æä¹‹åï¼Œä»£ç ç”Ÿæˆå™¨å°±ä¼šæ ¹æ®è¯­æ³•æ ‘ç”ŸæˆIRã€‚ IRçš„è¯­æ³•ï¼š @ å…¨å±€æ ‡è¯† % å±€éƒ¨æ ‡è¯† alloca å¼€è¾Ÿç©ºé—´ align å†…å­˜å¯¹é½ i32 4å­—èŠ‚ store å†™å…¥å†…å­˜ load è¯»å–æ•°æ® call è°ƒç”¨æ•°æ® ret è¿”å› ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼Œå°±å¯ä»¥æŸ¥çœ‹ç”Ÿæˆçš„IRï¼š 1clang -S -fobjc-arc -emit-llvm main.m æ‰“å¼€main.llæ–‡ä»¶ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445; ModuleID = 'main.m'source_filename = &quot;main.m&quot;target datalayout = &quot;e-m:o-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;target triple = &quot;x86_64-apple-macosx11.3.0&quot;@.str = private unnamed_addr constant [3 x i8] c&quot;%d\\00&quot;, align 1; Function Attrs: noinline optnone ssp uwtabledefine i32 @main(i32 %0, i8** %1) #0 { %3 = alloca i32, align 4 %4 = alloca i32, align 4 %5 = alloca i8**, align 8 %6 = alloca i32, align 4 %7 = alloca i32, align 4 store i32 0, i32* %3, align 4 store i32 %0, i32* %4, align 4 store i8** %1, i8*** %5, align 8 store i32 10, i32* %6, align 4 store i32 20, i32* %7, align 4 %8 = load i32, i32* %6, align 4 %9 = load i32, i32* %7, align 4 %10 = add nsw i32 %8, %9 %11 = add nsw i32 %10, 30 %12 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([3 x i8], [3 x i8]* @.str, i64 0, i64 0), i32 %11) ret i32 0}declare i32 @printf(i8*, ...) #1attributes #0 = { noinline optnone ssp uwtable &quot;correctly-rounded-divide-sqrt-fp-math&quot;=&quot;false&quot; &quot;darwin-stkchk-strong-link&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;min-legal-vector-width&quot;=&quot;0&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-jump-tables&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;true&quot; &quot;probe-stack&quot;=&quot;___chkstk_darwin&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;penryn&quot; &quot;target-features&quot;=&quot;+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; }attributes #1 = { &quot;correctly-rounded-divide-sqrt-fp-math&quot;=&quot;false&quot; &quot;darwin-stkchk-strong-link&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;true&quot; &quot;probe-stack&quot;=&quot;___chkstk_darwin&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;penryn&quot; &quot;target-features&quot;=&quot;+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; }!llvm.module.flags = !{!0, !1, !2, !3, !4, !5, !6, !7}!llvm.ident = !{!8}!0 = !{i32 2, !&quot;SDK Version&quot;, [2 x i32] [i32 11, i32 3]}!1 = !{i32 1, !&quot;Objective-C Version&quot;, i32 2}!2 = !{i32 1, !&quot;Objective-C Image Info Version&quot;, i32 0}!3 = !{i32 1, !&quot;Objective-C Image Info Section&quot;, !&quot;__DATA,__objc_imageinfo,regular,no_dead_strip&quot;}!4 = !{i32 1, !&quot;Objective-C Garbage Collection&quot;, i8 0}!5 = !{i32 1, !&quot;Objective-C Class Properties&quot;, i32 64}!6 = !{i32 1, !&quot;wchar_size&quot;, i32 4}!7 = !{i32 7, !&quot;PIC Level&quot;, i32 2}!8 = !{!&quot;Apple clang version 12.0.5 (clang-1205.0.22.11)&quot;} å¯ä»¥çœ‹åˆ° main å‡½æ•°å½“ä¸­ç”Ÿæˆäº†å¾ˆå¤šå¥‡æ€ªçš„ä¸­é—´å˜é‡å¦‚ï¼š%3ã€%4ã€%5ã€%6ã€%7ï¼Œè¿™æ˜¯ç³»ç»Ÿåšçš„ä»£ç æ··æ·†ã€‚ IRçš„ä¼˜åŒ–çº§åˆ«ï¼šO0ã€O1ã€O2ã€O3ã€Osï¼Œç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯è‹±æ–‡å¤§å†™å­—æ¯çš„Oã€‚ å…¶ä¸­O0è¡¨ç¤ºNone O1è¡¨ç¤ºFast O2è¡¨ç¤ºFaster O3è¡¨ç¤ºFastest Osè¡¨ç¤ºFastest Samllest ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹ä¸åŒä¼˜åŒ–ç¨‹åº¦çš„IRä»£ç ï¼Œæˆ‘ä»¬ä»¥æœ€å¿«æœ€å°æ¨¡å¼ç¤ºèŒƒï¼š 1clang -Os -S -fobjc-arc -emit-llvm main.m -o main.m æ‰“å¼€main.llæ–‡ä»¶ï¼š 12345678910111213141516171819202122232425262728293031323334; ModuleID = 'main.m'source_filename = &quot;main.m&quot;target datalayout = &quot;e-m:o-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;target triple = &quot;x86_64-apple-macosx11.3.0&quot;@.str = private unnamed_addr constant [3 x i8] c&quot;%d\\00&quot;, align 1; Function Attrs: nofree nounwind optsize ssp uwtabledefine i32 @main(i32 %0, i8** nocapture readnone %1) local_unnamed_addr #0 { %3 = tail call i32 (i8*, ...) @printf(i8* nonnull dereferenceable(1) getelementptr inbounds ([3 x i8], [3 x i8]* @.str, i64 0, i64 0), i32 60) #2, !clang.arc.no_objc_arc_exceptions !9 ret i32 0}; Function Attrs: nofree nounwind optsizedeclare i32 @printf(i8* nocapture readonly, ...) local_unnamed_addr #1attributes #0 = { nofree nounwind optsize ssp uwtable &quot;correctly-rounded-divide-sqrt-fp-math&quot;=&quot;false&quot; &quot;darwin-stkchk-strong-link&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;min-legal-vector-width&quot;=&quot;0&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-jump-tables&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;true&quot; &quot;probe-stack&quot;=&quot;___chkstk_darwin&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;penryn&quot; &quot;target-features&quot;=&quot;+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; }attributes #1 = { nofree nounwind optsize &quot;correctly-rounded-divide-sqrt-fp-math&quot;=&quot;false&quot; &quot;darwin-stkchk-strong-link&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;true&quot; &quot;probe-stack&quot;=&quot;___chkstk_darwin&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;penryn&quot; &quot;target-features&quot;=&quot;+cx16,+cx8,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; }attributes #2 = { optsize }!llvm.module.flags = !{!0, !1, !2, !3, !4, !5, !6, !7}!llvm.ident = !{!8}!0 = !{i32 2, !&quot;SDK Version&quot;, [2 x i32] [i32 11, i32 3]}!1 = !{i32 1, !&quot;Objective-C Version&quot;, i32 2}!2 = !{i32 1, !&quot;Objective-C Image Info Version&quot;, i32 0}!3 = !{i32 1, !&quot;Objective-C Image Info Section&quot;, !&quot;__DATA,__objc_imageinfo,regular,no_dead_strip&quot;}!4 = !{i32 1, !&quot;Objective-C Garbage Collection&quot;, i8 0}!5 = !{i32 1, !&quot;Objective-C Class Properties&quot;, i32 64}!6 = !{i32 1, !&quot;wchar_size&quot;, i32 4}!7 = !{i32 7, !&quot;PIC Level&quot;, i32 2}!8 = !{!&quot;Apple clang version 12.0.5 (clang-1205.0.22.11)&quot;}!9 = !{} å¯ä»¥çœ‹å‡ºä»£ç è¿›è¡Œäº†å¾ˆå¤§å¹…åº¦çš„ä¼˜åŒ–ï¼Œå°¤å…¶æ˜¯ main å‡½æ•°éƒ¨åˆ†ï¼Œå¤§éƒ¨åˆ†å†—ä½™ä»£ç éƒ½è¢«å»æ‰äº†ã€‚ è¿˜å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å°†IRä»£ç ç”ŸæˆbitCode: 1clang -emit-llvm -c main.ll -o main.bc 7.5 ç”Ÿæˆæ±‡ç¼–ä»£ç æˆ‘ä»¬å¯ä»¥å°†IRä»£ç ã€bitCodeã€æˆ–è€…æ˜¯æºç ç”Ÿæˆæ±‡ç¼–ä»£ç ï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€å±•ç¤ºäº†ã€‚ 123clang -S -fobjc-arc main.bc -o main.s clang -S -fobjc-arc main.ll -o main.sclang -Os -S -fobjc-arc main.m -o main.s 1234567891011121314151617181920212223242526272829303132333435363738 .section __TEXT,__text,regular,pure_instructions .build_version macos, 11, 3 sdk_version 11, 3 .globl _main ## -- Begin function main_main: ## @main .cfi_startproc## %bb.0: pushq %rbp .cfi_def_cfa_offset 16 .cfi_offset %rbp, -16 movq %rsp, %rbp .cfi_def_cfa_register %rbp subq $32, %rsp leaq L_.str(%rip), %rax movl %edi, -4(%rbp) ## 4-byte Spill movq %rax, %rdi movl $60, %ecx movq %rsi, -16(%rbp) ## 8-byte Spill movl %ecx, %esi movb $0, %al callq _printf xorl %ecx, %ecx movl %eax, -20(%rbp) ## 4-byte Spill movl %ecx, %eax addq $32, %rsp popq %rbp retq .cfi_endproc ## -- End function .section __TEXT,__cstring,cstring_literalsL_.str: ## @.str .asciz &quot;%d&quot; .section __DATA,__objc_imageinfo,regular,no_dead_stripL_OBJC_IMAGE_INFO: .long 0 .long 64.subsections_via_symbols 7.6 ç”Ÿæˆç›®æ ‡æ–‡ä»¶ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å°†æ±‡ç¼–ä»£ç ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼š 1clang -fmodules -c main.s -o main.o æˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹main.oæ–‡ä»¶çš„å†…å®¹ï¼š 1xcrun nm -nm main.o ç»“æœå¦‚ä¸‹ï¼š 12 (undefined) external _printf0000000000000000 (__TEXT,__text) external _main å…¶ä¸­externalè¡¨ç¤ºå¤–éƒ¨å¯ä»¥è®¿é—®ç¬¦å·ï¼Œundefinedè¡¨ç¤ºå½“å‰æ–‡ä»¶æœªæ‰¾åˆ°ç¬¦å·ã€‚è¿™é‡Œçš„æ„æ€å°±æ˜¯è¯´printfè¿™ä¸ªå‡½æ•°åœ¨å½“å‰æ‰¾ä¸åˆ°ï¼ˆå› ä¸ºä¸æ˜¯åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­å®šä¹‰çš„ï¼‰ï¼Œmainå‡½æ•°æ˜¯å¯ä»¥æ‰¾åˆ°çš„ã€‚ 7.7 ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶é“¾æ¥å™¨æŠŠ.oæ–‡ä»¶å’ŒåŠ¨æ€åº“ã€é™æ€åº“è¿›è¡Œé“¾æ¥ï¼Œç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚ é€šè¿‡å¦‚ä¸‹å‘½ä»¤å³å¯ï¼š 1clang main.o -o main å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤ï¼ŒæŸ¥çœ‹ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶çš„ç¬¦å·ã€‚ 1xcrun nm -nm main ç»“æœå¦‚ä¸‹ï¼š 12345 (undefined) external _printf (from libSystem) (undefined) external dyld_stub_binder (from libSystem)0000000100000000 (__TEXT,__text) [referenced dynamically] external __mh_execute_header0000000100003f5e (__TEXT,__text) external _main0000000100008008 (__DATA,__data) non-external __dyld_private (undefined) external _printf (from libSystem)è¡¨ç¤º_printfè¿™ä¸ªç¬¦å·æ¥è‡ªäºlibSystemã€‚ å…«ã€æ€»ç»“llvmç¼–è¯‘ç¨‹åºçš„æµç¨‹å¦‚ä¸‹ï¼š 0ï¼šè¾“å…¥åŸæ–‡ä»¶ 1ï¼šé¢„å¤„ç†è¿‡ç¨‹ï¼ŒåŒ…æ‹¬å®çš„æ›¿æ¢ï¼Œå¤´æ–‡ä»¶çš„å¯¼å…¥ç­‰ 2ï¼šç¼–è¯‘é˜¶æ®µï¼Œè¯æ³•åˆ†æã€è¯­æ³•åˆ†æï¼Œæœ€ç»ˆç”ŸæˆIRä»£ç  3ï¼šåç«¯ï¼Œä»£ç ä¼˜åŒ–å¤„ç†ï¼Œæœ€ç»ˆç”Ÿæˆæ±‡ç¼– 4ï¼šæ±‡ç¼–ç”Ÿæˆç›®æ ‡æ–‡ä»¶ 5ï¼šé“¾æ¥éœ€è¦çš„åŠ¨æ€åº“å’Œé™æ€åº“ï¼Œç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ 6ï¼šé€šè¿‡ä¸åŒçš„æ¶æ„ï¼Œç”Ÿæˆå¯¹è±¡çš„å¯æ‰§è¡Œæ–‡ä»¶ å‚è€ƒiOS-LLVMåˆæ¢ LLVM","link":"/2021/07/09/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/21-LLVM%E5%88%9D%E6%8E%A2/"},{"title":"22-iOS App å¯åŠ¨ä¼˜åŒ–","text":"ä¸€ã€èƒŒæ™¯å†·å¯åŠ¨æ—¶é•¿æ˜¯ App æ€§èƒ½çš„é‡è¦æŒ‡æ ‡ï¼Œå†³å®šç€ç”¨æˆ·å¯¹ App çš„ç¬¬ä¸€å°è±¡ã€‚æœ¬æ–‡å°†é‡ç‚¹æ¢ç©¶å¦‚ä½•ç¼©çŸ­ App çš„å†·å¯åŠ¨æ—¶é•¿ã€‚ äºŒã€å†·å¯åŠ¨å®šä¹‰ æˆ‘ä»¬æŠŠå†·å¯åŠ¨è¿‡ç¨‹å®šä¹‰ä¸ºï¼šä»ç”¨æˆ·ç‚¹å‡» App å›¾æ ‡å¼€å§‹åˆ°ç”¨æˆ·èƒ½çœ‹åˆ° App ä¸»ç•Œé¢å†…å®¹ä¸ºæ­¢è¿™ä¸ªè¿‡ç¨‹ï¼Œå³ T1+T2+T3ã€‚åœ¨Appå†·å¯åŠ¨è¿‡ç¨‹å½“ä¸­ï¼Œè¿™ä¸‰ä¸ªé˜¶æ®µä¸­çš„æ¯ä¸ªé˜¶æ®µéƒ½å­˜åœ¨å¾ˆå¤šå¯ä»¥è¢«ä¼˜åŒ–çš„ç‚¹ã€‚ ä¸‰ã€pre-main é˜¶æ®µåˆ†æpre-main é˜¶æ®µçš„æµç¨‹å›¾ï¼š åŠ è½½è¿‡ç¨‹ä» exec( ) å‡½æ•°å¼€å§‹ï¼Œexec( ) æ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œä¸ºè¿›ç¨‹åˆ†é…ä¸€æ®µå†…å­˜ç©ºé—´ã€‚ ç„¶åçœ‹å‰©ä¸‹çš„é˜¶æ®µå¹¶åˆ†æå¯ä¼˜åŒ–ç‚¹ï¼š Load dylibs è¿™ä¸€é˜¶æ®µ dyld ä¼šåˆ†æåº”ç”¨ä¾èµ–çš„ dylibï¼Œæ‰¾åˆ°å…¶ Mach-O æ–‡ä»¶ï¼Œæ‰“å¼€å’Œè¯»å–è¿™äº›æ–‡ä»¶å¹¶éªŒè¯å…¶æœ‰æ•ˆæ€§ï¼Œæ¥ç€ä¼šæ‰¾åˆ°ä»£ç ç­¾åæ³¨å†Œåˆ°å†…æ ¸ï¼Œæœ€åå¯¹ dylib çš„æ¯ä¸€ä¸ª segment è°ƒç”¨ mmap( )ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¼šåŠ è½½100-400ä¸ª dylibsï¼Œå…¶ä¸­å¤§éƒ¨åˆ†æ˜¯ç³»ç»Ÿåº“ï¼Œè¿™éƒ¨åˆ† dylib çš„åŠ è½½ç³»ç»Ÿå·²ç»åšäº†ä¼˜åŒ–ã€‚ æˆ‘ä»¬å¯ä¼˜åŒ–é¡¹ï¼š å‡å°‘æˆ–è€…åˆå¹¶ dylibsï¼Œå°†åŠ¨æ€åº“æ¢æˆé™æ€åº“ Rebase &amp; Bind åœ¨ dylib çš„åŠ è½½è¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿä¸ºäº†å®‰å…¨è€ƒè™‘ï¼Œå¼•å…¥äº†ASLRï¼ˆAddress Space Layout Randomizationï¼‰æŠ€æœ¯å’Œä»£ç ç­¾åã€‚ç”±äº ASLR çš„å­˜åœ¨ï¼Œé•œåƒï¼ˆImageï¼ŒåŒ…æ‹¬å¯æ‰§è¡Œæ–‡ä»¶ã€dylib å’Œ bundleï¼‰ä¼šåœ¨éšæœºçš„åœ°å€ä¸ŠåŠ è½½ï¼Œå’Œä¹‹å‰æŒ‡é’ˆæŒ‡å‘çš„åœ°å€ä¼šæœ‰ä¸€ä¸ªåå·®ï¼Œdyld éœ€è¦ä¿®æ­£è¿™ä¸ªåå·®ï¼Œæ¥æŒ‡å‘æ­£ç¡®çš„åœ°å€ã€‚ Rebase åœ¨å‰ï¼ŒBind åœ¨åï¼ŒRebase åœ¨ Image å†…éƒ¨è°ƒæ•´æŒ‡é’ˆçš„æŒ‡å‘ï¼ŒBindæ˜¯æŠŠæŒ‡é’ˆæ­£ç¡®åœ°æŒ‡å‘ Image å¤–éƒ¨çš„å†…å®¹ã€‚ Objc setup å¤§éƒ¨åˆ† ObjC åˆå§‹åŒ–å·¥ä½œå·²ç»åœ¨ Rebase &amp; Bind é˜¶æ®µåšå®Œäº†ï¼Œè¿™ä¸€æ­¥ dyld ä¼šæ³¨å†Œæ‰€æœ‰å£°æ˜è¿‡çš„ ObjC ç±»ï¼Œå°†åˆ†ç±»çš„å®šä¹‰æ’å…¥åˆ°ç±»çš„æ–¹æ³•åˆ—è¡¨é‡Œï¼Œå†æ£€æŸ¥æ¯ä¸ª selector çš„å”¯ä¸€æ€§ã€‚ æ‰€ä»¥ï¼ŒæŒ‡é’ˆæ•°é‡è¶Šå°‘è¶Šå¥½ï¼Œæˆ‘ä»¬å¯ä¼˜åŒ–é¡¹ï¼š å‡å°‘ç±»ã€æ–¹æ³•ã€åˆ†ç±»æ•°é‡ Initializers è°ƒç”¨ Objc çš„ +load() å‡½æ•°ï¼Œè°ƒç”¨ C++ çš„æ„é€ å‡½æ•°å±æ€§å‡½æ•°ï¼Œåˆ›å»ºéåŸºæœ¬ç±»å‹çš„ C++ é™æ€å…¨å±€å˜é‡(é€šå¸¸æ˜¯ç±»æˆ–ç»“æ„ä½“)ã€‚ æˆ‘ä»¬å¯ä¼˜åŒ–é¡¹ï¼š å°‘åœ¨ç±»çš„ +load æ–¹æ³•é‡Œåšäº‹æƒ…ï¼Œå°½é‡æŠŠè¿™äº›äº‹æƒ…æ¨è¿Ÿåˆ° +initiailize å‡å°‘æ„é€ å™¨å‡½æ•°ï¼ˆconstructorï¼‰ï¼Œåœ¨æ„é€ å™¨å‡½æ•°é‡Œå°‘åšäº›äº‹æƒ… å‡å°‘ C++ é™æ€å…¨å±€å˜é‡ ä¸€å¼ å›¾æ€»ç»“ã€çœ‹è¿™ä¸ªå°±å¤Ÿäº†ã€‘ å››ã€pre-main é˜¶æ®µä¼˜åŒ–æƒ³è¦ä¼˜åŒ–ï¼Œé¦–å…ˆè¦çŸ¥é“å¦‚ä½•æµ‹é‡è¿™ä¸ªè¿‡ç¨‹çš„æ—¶é•¿ã€‚ 4.1 æ—¶é•¿æµ‹é‡4.1.1 ä½¿ç”¨ Xcode è‡ªå¸¦çš„é™æ€æ‰“å°åŠŸèƒ½ åœ¨å¼€å‘ç¯å¢ƒä¸‹ï¼ŒXcode ä¸­ Edit scheme -&gt; Run -&gt; Auguments å°†ç¯å¢ƒå˜é‡ DYLD_PRINT_STATISTICSè®¾ç½®ä¸º1ä¼šæ‰“å° pre-main é˜¶æ®µè€—æ—¶çš„ç®€è¦ä¿¡æ¯ï¼š 1234567891011Total pre-main time: 341.32 milliseconds (100.0%) dylib loading time: 154.88 milliseconds (45.3%) rebase/binding time: 37.20 milliseconds (10.8%) ObjC setup time: 52.62 milliseconds (15.4%) initializer time: 96.50 milliseconds (28.2%) slowest intializers : libSystem.dylib : 4.07 milliseconds (1.1%) libMainThreadChecker.dylib : 30.75 milliseconds (9.0%) AFNetworking : 19.08 milliseconds (5.5%) LDXLog : 10.06 milliseconds (2.9%) Bigger : 7.05 milliseconds (2.0%) å°†DYLD_PRINT_STATISTICS_DETAILSè®¾ç½®ä¸º1ï¼Œä¼šæ‰“å° pre-main é˜¶æ®µè€—æ—¶çš„è¯¦ç»†ä¿¡æ¯ã€‚ è¿™ç§æ–¹å¼ç®€å•ã€å‡†ç¡®ï¼Œä½†åªé€‚åˆå¼€å‘é˜¶æ®µä½¿ç”¨ï¼Œçº¿ä¸Šæƒ³ç»Ÿè®¡æ—¶é•¿çš„è¯ï¼Œéœ€è¦ä½¿ç”¨ä¸‹é¢çš„çº¯ä»£ç æ–¹å¼ã€‚ 4.1.2 ä½¿ç”¨çº¯ä»£ç æ–¹å¼æˆ‘ä»¬å¯ä»¥é€šè¿‡ sysctl å‡½æ•°è·å¾—è¿›ç¨‹çš„æœ‰å…³ä¿¡æ¯ï¼Œå…¶ä¸­å°±åŒ…æ‹¬è¿›ç¨‹åˆ›å»ºçš„æ—¶é—´æˆ³(å³ exec å‡½æ•°æ‰§è¡Œçš„æ—¶é—´æˆ³)ï¼Œè¿™ä¸ªæ—¶é—´æˆ³å°±æ˜¯ pre-main é˜¶æ®µçš„èµ·å§‹ç‚¹ï¼Œç„¶åå†åœ¨é¡¹ç›®ä¸­ çš„ main å‡½æ•°å¤„è·å–æ­¤æ—¶çš„æ—¶é—´æˆ³ï¼Œmainå‡½æ•°ä¸­çš„æ—¶é—´æˆ³ - è¿›ç¨‹åˆ›å»ºçš„æ—¶é—´æˆ³å³æ˜¯ç”¨ä»£ç æ–¹å¼å¾—åˆ°çš„ pre-main æ—¶é•¿ã€‚ main.m ä¸­ï¼š 12345678910111213#import &lt;sys/time.h&gt;int main(int argc, char *argv[]){ @autoreleasepool { struct timeval tv; gettimeofday(&amp;tv, NULL); long timeStamp = tv.tv_sec * 1000 + tv.tv_usec / 1000; printf(&quot;mainå‡½æ•°ä¸­çš„æ—¶é—´æˆ³ï¼š%ld\\n&quot;, timeStamp); return UIApplicationMain(argc, argv, nil, NSStringFromClass([EcmcAppDelegate class])); }} AppDelegate.m ä¸­ï¼š 12345678910111213141516171819202122232425262728#import &lt;sys/sysctl.h&gt;#import &lt;mach/mach.h&gt;- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions{ long start = [self processStartTime]; NSLog(@&quot;è¿›ç¨‹åˆ›å»ºçš„æ—¶é—´æˆ³ï¼š%ld\\n&quot;, start); ... return YES;}- (BOOL)processInfoForPID:(int)pid procInfo:(struct kinfo_proc*)procInfo { int cmd[4] = {CTL_KERN, KERN_PROC, KERN_PROC_PID, pid}; size_t size = sizeof(*procInfo); return sysctl(cmd, sizeof(cmd)/sizeof(*cmd), procInfo, &amp;size, NULL, 0) == 0;}- (long)processStartTime { struct kinfo_proc kProcInfo; if ([self processInfoForPID:[[NSProcessInfo processInfo] processIdentifier] procInfo:&amp;kProcInfo]) { return kProcInfo.kp_proc.p_un.__p_starttime.tv_sec * 1000.0 + kProcInfo.kp_proc.p_un.__p_starttime.tv_usec / 1000.0; } else { NSAssert(NO, @&quot;æ— æ³•å–å¾—è¿›ç¨‹çš„ä¿¡æ¯&quot;); return 0; }} 4.2 ä¼˜åŒ–æˆ‘ä»¬å¯ä»¥åˆ†æå‡ºä¸€äº›å½±å“ T1 æ—¶é—´çš„å› ç´ ï¼š åŠ¨æ€åº“åŠ è½½è¶Šå¤šï¼Œå¯åŠ¨è¶Šæ…¢ã€‚ ObjC ç±»ï¼Œæ–¹æ³•è¶Šå¤šï¼Œå¯åŠ¨è¶Šæ…¢ã€‚ ObjC çš„ +load è¶Šå¤šï¼Œå¯åŠ¨è¶Šæ…¢ã€‚ C çš„ constructor å‡½æ•°è¶Šå¤šï¼Œå¯åŠ¨è¶Šæ…¢ã€‚ C++ é™æ€å¯¹è±¡è¶Šå¤šï¼Œå¯åŠ¨è¶Šæ…¢ã€‚ é‚£ä¹ˆæ€»ç»“ä¸€ä¸‹ pre-main é˜¶æ®µæˆ‘ä»¬èƒ½åšçš„äº‹æƒ…ï¼š Load dylibs é˜¶æ®µï¼šå‡å°‘æˆ–è€…åˆå¹¶ dylibsï¼Œå°†åŠ¨æ€åº“æ¢æˆé™æ€åº“ Rebase &amp; Bind é˜¶æ®µï¼šå‡å°‘ç±»ã€æ–¹æ³•ã€åˆ†ç±»æ•°é‡ Objc setup é˜¶æ®µï¼šæ— äº‹å¯åš Initializers é˜¶æ®µï¼šâ‘ å°‘åœ¨ç±»çš„ +load æ–¹æ³•é‡Œåšäº‹æƒ…ï¼Œå°½é‡æŠŠè¿™äº›äº‹æƒ…æ¨è¿Ÿåˆ° +initiailizeï¼›â‘¡å‡å°‘æ„é€ å™¨å‡½æ•°ï¼ˆconstructorï¼‰ï¼›â‘¢å‡å°‘ C++ é™æ€å…¨å±€å˜é‡ 4.2.1 ä¼˜åŒ–åº“æ¨åŠ¨æŠŠé¡¹ç›®ä¸­ä½¿ç”¨çš„åŠ¨æ€åº“æ”¹ä¸ºé™æ€åº“ã€‚ å»æ‰ä¸€äº›ä¸å¿…è¦çš„åº“ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å·¥ç¨‹ï¼Œä½¿ç”¨ pod å°†ä¸»é¡¹ç›®ä¸­çš„æ¯ä¸ªåº“é€ä¸ªå¯¼å…¥è¿›æ–°é¡¹ç›®ï¼Œç„¶åä½¿ç”¨å‰é¢æåˆ°çš„ä¸¤ç§æ—¶é•¿æµ‹é‡æ–¹å¼ç»Ÿè®¡æ¯ä¸ªåº“å¸¦æ¥çš„ pre-main è€—æ—¶ï¼Œå¯¹äºé‚£äº›ä¸é‡è¦çš„ï¼Œä½†æ˜¯å´åœ¨ pre-main é˜¶æ®µè€—æ—¶è¾¾å‡ åæ¯«ç§’çš„åº“å°±å¯ä»¥ç§»é™¤å¹¶è‡ªå·±æ‰‹å†™ã€‚ 4.2.2 å®‰è£…åŒ…ç˜¦èº«å®‰è£…åŒ…ï¼ˆIPAï¼‰ä¸»è¦ç”±å¯æ‰§è¡Œæ–‡ä»¶ã€èµ„æºæ–‡ä»¶ç»„æˆã€‚ â‘ å¯æ‰§è¡Œæ–‡ä»¶ç˜¦èº« ç¼–è¯‘å™¨ä¼˜åŒ– Strip Linked Productã€Make Strings Read-Onlyã€Symbols Hidden by Defaultè®¾ç½®ä¸ºYES å»æ‰å¼‚å¸¸æ”¯æŒï¼ŒEnable C++ Exceptionã€Enable Objective-C Extensionsè®¾ç½®ä¸ºNOï¼ŒOther C Flagæ·»åŠ -fno-exceptions ç­›æŸ¥é‡å¤ã€æœªè¢«è°ƒç”¨ä»£ç  ä½¿ç”¨ App Code è½¯ä»¶(www.jetbrains.com/objc/) æ“ä½œï¼šèœå•æ  -&gt; Code -&gt; Inspect Code ç¼–å†™ LLVM æ’ä»¶æ£€æµ‹é‡å¤ä»£ç ã€æœªè¢«è°ƒç”¨ä»£ç  â‘¡èµ„æºæ–‡ä»¶ç˜¦èº« æ— æŸå‹ç¼© å»é™¤æ²¡ç”¨ç”¨åˆ°çš„èµ„æºï¼šhttps://github.com/tinymind/LSUnusedResources 4.2.3 äºŒè¿›åˆ¶é‡æ’â‘ å‰è¨€è¦å®æ–½äºŒè¿›åˆ¶é‡æ’ï¼Œé¦–å…ˆè¦äº†è§£è™šæ‹Ÿå†…å­˜ï¼š åº”ç”¨ç¨‹åºçš„å¯æ‰§è¡Œæ–‡ä»¶æ˜¯è£…åœ¨ç£ç›˜ä¸Šçš„ï¼Œå¯åŠ¨åº”ç”¨ï¼Œåˆ™éœ€è¦å°†å¯æ‰§è¡Œæ–‡ä»¶åŠ è½½è¿›å†…å­˜,æ—©æœŸè®¡ç®—æœºæ˜¯æ²¡æœ‰è™šæ‹Ÿå†…å­˜çš„ï¼Œä¸€æ—¦åŠ è½½ï¼Œå°±ä¼šå…¨éƒ¨åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶ä¸”è¿›ç¨‹éƒ½æ˜¯æŒ‰ç…§é¡ºåºåœ¨ç‰©ç†å†…å­˜ä¸Šæ’åˆ—çš„ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´ä¸¤ä¸ªé—®é¢˜ï¼š 1.ç”±äºåœ°å€è¿ç»­ï¼Œæ‰€ä»¥ä¸Šä¸€ä¸ªè¿›ç¨‹çš„åœ°å€åŠ ä¸€äº›åœ°å€å°±èƒ½è®¿é—®åˆ°ä¸‹ä¸€ä¸ªè¿›ç¨‹ï¼Œå®‰å…¨æ€§å¾ˆä½ã€‚ 2.è½¯ä»¶è¶Šæ¥è¶Šå¤§ï¼Œå¼€å¯å¤šä¸ªè½¯ä»¶æ—¶ç›´æ¥å…¨éƒ¨åŠ è½½è¿›å†…å­˜ä¼šå¯¼è‡´å†…å­˜ä¸å¤Ÿç”¨ï¼Œè€Œä¸”æˆ‘ä»¬ä½¿ç”¨è½¯ä»¶çš„æ—¶å€™åªä½¿ç”¨å…¶ä¸­ä¸€éƒ¨åˆ†çš„åŠŸèƒ½ï¼Œå¦‚æœè½¯ä»¶ä¸€æ‰“å¼€å°±å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ï¼Œä¼šå¾ˆæµªè´¹å†…å­˜ç©ºé—´ã€‚åŸºäºä»¥ä¸Šä¸¤ä¸ªåŸå› ï¼Œè™›æ‹Ÿå†…å­˜æŠ€æœ¯å‡ºç°äº†ã€‚ æ¯ä¸ªè¿›ç¨‹åœ¨åˆ›å»ºåŠ è½½æ—¶ï¼Œä¼šè¢«åˆ†é…ä¸€ä¸ª1-2å€çœŸå®å†…å­˜å¤§å°çš„è¿ç»­çš„è™›æ‹Ÿåœ°å€ç©ºé—´ï¼Œè®©å½“å‰è½¯ä»¶è®¤ä¸ºè‡ªå·±æœ‰æ‹¥æœ‰ä¸€å¤§ç‰‡å†…å­˜ç©ºé—´ï¼Œå®é™…ä¸Šæ˜¯æŠŠç£ç›˜çš„ä¸€éƒ¨åˆ†ä½œä¸ºå‡æƒ³å†…å­˜æ¥ä½¿ç”¨ã€‚ è™šæ‹Ÿå†…å­˜å’Œå®é™…å†…å­˜æ˜¯é€šè¿‡ä¸€å¼ é¡µè¡¨æ¥å…³è”çš„ã€‚ç¨‹åºåœ¨åŠ è½½æ—¶ï¼Œä¼šæ ¹æ® page å¤§å°ï¼ˆ16kbï¼‰å°†ç¨‹åºåˆ†å‰²æˆä¸€é¡µä¸€é¡µçš„ï¼Œå¯åŠ¨æ—¶éƒ¨åˆ†çš„é¡µåŠ è½½è¿›çœŸå®å†…å­˜ï¼Œéƒ¨åˆ†é¡µåœ¨è™šæ‹Ÿå†…å­˜ï¼ˆç£ç›˜ï¼‰ä¸­ï¼Œä¸­é—´çš„è°ƒåº¦è®°å½•åœ¨ä¸€å¼ é¡µè¡¨å†…ï¼Œè¿™ä¸ªé¡µè¡¨çš„ä½œç”¨ä¸»è¦æ˜¯ç”¨æ¥è°ƒåº¦ç£ç›˜ä¸å†…å­˜ä¸¤è€…ä¹‹é—´æ•°æ®çš„äº¤æ¢ï¼Œå¦‚ä¸‹å›¾ï¼š ç³»ç»Ÿä½¿ç”¨æŸä¸€é¡µå†…å­˜æ—¶ï¼Œå…ˆå»é¡µè¡¨ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœé¡µè¡¨çš„æ ‡è®°ä¸º1ï¼Œä»£è¡¨è¯¥é¡µæ•°æ®å·²ç»åœ¨å†…å­˜ä¸­ï¼Œå°±å¯ä»¥ç›´æ¥è®¿é—®å¯¹åº”çš„ç‰©ç†å†…å­˜ï¼›å¦‚æœé¡µè¡¨æ ‡è®°ä¸º0ï¼Œè¯´æ˜æ•°æ®æœªåœ¨ç‰©ç†å†…å­˜ä¸Šï¼Œè¿™æ—¶å€™ç³»ç»Ÿä¼šé˜»å¡è¿›ç¨‹ï¼Œè¿™ä¸ªè¡Œä¸ºå«åš**ç¼ºé¡µä¸­æ–­ (page fault )**ï¼Œç­‰å°†å¯¹åº”çš„ page ä»è™šæ‹Ÿå†…å­˜ï¼ˆç£ç›˜ï¼‰åŠ è½½è¿›ç‰©ç†å†…å­˜ä¹‹åå†è¿›è¡Œè®¿é—®ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸º page inï¼Œå¦‚æœæ­¤æ—¶å†…å­˜ä¸å¤Ÿç”¨ï¼Œç³»ç»Ÿä¼šé€šè¿‡åˆ¤æ–­è¦†ç›–æ‰ä¸æ´»è·ƒçš„éƒ¨åˆ†ã€‚å¦‚ä¸‹å›¾ï¼š å› ä¸ºç£ç›˜çš„è®¿é—®é€Ÿåº¦è¾ƒæ…¢ï¼Œpage fault å‘ç”Ÿåçš„ page in è¿™ä¸ªæ“ä½œæ¯”è¾ƒè€—æ—¶ï¼Œå¹¶ä¸” iOS ä¸ä»…ä»…æ˜¯å°†æ•°æ®åŠ è½½åˆ°å†…å­˜ï¼Œè¿˜è¦å¯¹è¿™é¡µåšç­¾åè®¤è¯ï¼Œæ‰€ä»¥ iOS è€—æ—¶æ›´é•¿ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬æŠŠæ‰€æœ‰å¯åŠ¨æ—¶å€™çš„ä»£ç éƒ½æ”¾åœ¨å‰ä¸€ä¸¤é¡µï¼Œè¿™æ ·å°±ä¸ä¼šé¢‘ç¹å‡ºç° page faultï¼Œå‡å°‘äº† page in çš„æ¬¡æ•°ï¼Œè¿™æ ·å°±èƒ½ä¸€å®šç¨‹åº¦ä¸Šä¼˜åŒ–å¯åŠ¨é€Ÿåº¦ï¼Œè¿™ç§æ–¹æ³•å°±å«åšäºŒè¿›åˆ¶é‡æ’ã€‚ â‘¡ä½¿ç”¨Instrumentå¾—åˆ°åº”ç”¨å¯åŠ¨æ—¶çš„page inå¯åŠ¨ Instrumentï¼Œé€‰ä¸­ System Traceï¼Œè°ƒè¯•åº”ç”¨çš„å¯åŠ¨é˜¶æ®µï¼Œç„¶åé€‰åº”ç”¨çš„ MainThreadï¼Œç„¶åä¸‹é¢é€‰æ‹© Summary:Virtual Memoryï¼Œç„¶åå°±èƒ½çœ‹åˆ°æœªè¿›è¡ŒäºŒè¿›åˆ¶é‡æ’æ—¶åº”ç”¨å¯åŠ¨çš„ Page In çš„æ¬¡æ•°å’Œè€—æ—¶ã€‚ æ³¨æ„ï¼šå¦‚æœæˆ‘ä»¬çš„åº”ç”¨å¯åŠ¨ä¸€æ¬¡åï¼Œæ€æ­»åº”ç”¨ï¼Œç„¶åæ¥ç€é‡æ–°å¯åŠ¨ï¼Œå†æ¬¡æµ‹è¯•ï¼Œå‘ç°è¿™æ¬¡çš„ Page In çš„æ•°é‡ä¼šå‡å°‘ã€‚è¿™æ˜¯å› ä¸ºæ‰‹æœºå†…å­˜ä¸­å­˜åœ¨ä¸Šæ¬¡å¯åŠ¨çš„ç¼“å­˜ã€‚åœ¨è¿™é‡Œéœ€è¦åº”ç”¨å†·å¯åŠ¨è¿›è¡Œæµ‹è¯•ï¼Œè¦ä¹ˆé‡è£…ï¼Œè¦ä¹ˆå¤šå¼€å‡ ä¸ªå…¶ä»–åº”ç”¨ç­‰ç³»ç»Ÿæ€æ‰è¿™ä¸ªåº”ç”¨çš„è¿›ç¨‹ã€‚ â‘¢æŸ¥çœ‹æ•´ä¸ªé¡¹ç›®çš„ç¬¦å·é¡ºåºåœ¨ Xcode çš„ Build Setting è®¾ç½®ä¸­æœç´¢ Link Mapï¼ŒLink Map å°±æ˜¯æˆ‘ä»¬é“¾æ¥çš„ç¬¦å·è¡¨ï¼Œç„¶åå°† Write Link Map FIle è®¾ç½®ä¸º YESï¼Œè¿™æ ·ç¼–è¯‘çš„æ—¶å€™å°±ä¼šæŠŠé“¾æ¥çš„ç¬¦å·è¡¨ç»™æˆ‘ä»¬å†™å‡ºæ¥ é‡æ–° build ä¸€ä¸‹ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥åˆ°å¯¹è±¡çš„ç›®å½•ä¸‹å»æŸ¥æ‰¾ link map æ–‡ä»¶äº†ã€‚æ–‡ä»¶ç›®å½•ä½äº Products åŒçº§ç›®å½• Intermediates.noindex/é¡¹ç›®å.build/Debug-Debug-iphoneos/é¡¹ç›®å.build/LinkMap.text æ–‡ä»¶ã€‚ LinkMap æ–‡ä»¶å†…å®¹ä¸»è¦æ˜¯é“¾æ¥çš„æ–‡ä»¶ã€å‡½æ•°ç­‰ç›¸å…³å†…å®¹ã€‚ ä¸»è¦åŒ…å«ä¸‰éƒ¨åˆ†ï¼š # Object files:ç”Ÿæˆçš„.oæ–‡ä»¶ï¼ŒæŒ‰ç…§é¡ºåºæ’åˆ—ï¼› # Sections: ä»£ç å—ã€æ•°æ®å—çš„åœ°å€ä»¥åŠå¤§å°ï¼› # Symbols:å‡½æ•°çš„åœ°å€ã€å ç”¨å¤§å°ã€æ‰€å±çš„æ–‡ä»¶ä»¥åŠå‡½æ•°åï¼ŒæŒ‰ç…§ç¼–è¯‘çš„é¡ºåºæ’åˆ—ã€‚ æˆ‘ä»¬è¦æ‰¾çš„ç¬¦å·é¡ºåºï¼š 12345678910111213141516# Symbols:# Address Size File Name0x100007AC0 0x0000020C [ 2] -[NSData(WTProtectedAdditionsAES) wt_AES256EncryptWithKey:]0x100007CCC 0x00000210 [ 2] -[NSData(WTProtectedAdditionsAES) wt_AES256DecryptWithKey:]0x100007EDC 0x000001FC [ 2] -[NSData(WTProtectedAdditionsAES) initVectorWithLength:]0x1000080D8 0x00000280 [ 2] -[NSData(WTProtectedAdditionsAES) getUniqueId]0x100008358 0x00000044 [ 3] -[NSDate(WTProtectedAdditions) wt_timestamp]0x10000839C 0x000000B8 [ 3] -[NSDate(WTProtectedAdditions) wt_timestampString]0x100008454 0x0000004C [ 3] +[NSDate(WTProtectedAdditions) wt_dateWithWTTimestamp:]0x1000084A0 0x00000090 [ 4] +[UIResponder(WTAutomatics) load]0x100008530 0x000000B4 [ 4] +[UIResponder(WTAutomatics) swizzleAppDelegateMethods]0x1000085E4 0x000002E4 [ 4] ___54+[UIResponder(WTAutomatics) swizzleAppDelegateMethods]_block_invoke0x1000088C8 0x00000014 [ 4] ___copy_helper_block_0x1000088DC 0x00000010 [ 4] ___destroy_helper_block_0x1000088EC 0x00000208 [ 4] +[UIResponder(WTAutomatics) wt_swizzleAppDelegate:with:forProtocol:]... ä»ä¸Šé¢çš„ Symbols å¯ä»¥çœ‹å‡ºï¼Œå‡½æ•°åŠ è½½çš„é¡ºåºæ˜¯æŒ‰ç…§æ–‡ä»¶é¡ºåºæ¥æ’åˆ—çš„ã€‚æˆ‘ä»¬äºŒè¿›åˆ¶é‡æ’å°±éœ€è¦æŠŠè¿™é‡Œé¢çš„é¡ºåºæ”¹ä¸ºåº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨æ–¹æ³•çš„ç¬¦å·é¡ºåºï¼Œä½†æ˜¯æˆ‘ä»¬æ€ä¹ˆçŸ¥é“åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨äº†å“ªäº›æ–¹æ³•å‘¢ï¼Ÿ â‘£è·å¾—åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨æ–¹æ³•çš„ç¬¦å·æˆ‘ä»¬å¯ä»¥åœ¨ Xcode è¿›è¡ŒäºŒè¿›åˆ¶é‡æ’çš„æ“ä½œï¼ŒXcode ä½¿ç”¨çš„é“¾æ¥å™¨å«åš ldï¼Œld æœ‰ä¸ªä¸å¸¸ç”¨çš„å‚æ•°å« order_fileï¼Œè¿™ä¸ªæ–‡ä»¶ä¸­çš„ç¬¦å·ä¼šæŒ‰ç…§é¡ºåºæ’åˆ—åœ¨å¯¹åº” section çš„å¼€å§‹ï¼ŒäºŒè¿›åˆ¶é‡æ’æ’çš„å°±æ˜¯è¿™é‡Œé¢çš„ç¬¦å·é¡ºåºã€‚ æˆ‘ä»¬å¯ä»¥å°†æ–‡ä»¶çš„è·¯å¾„å‘Šè¯‰ Xcodeï¼Œåœ¨ order_file æ–‡ä»¶ä¸­æŠŠç¬¦å·çš„é¡ºåºå†™è¿›å»ï¼Œä¹‹å Xcode ç¼–è¯‘çš„æ—¶å€™å°±ä¼šæŒ‰ç…§æ–‡ä»¶ä¸­çš„ç¬¦å·é¡ºåºæ‰“åŒ…æˆäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ã€‚ ç°åœ¨æˆ‘ä»¬éœ€è¦è·å–åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨æ–¹æ³•çš„é¡ºåºä½œä¸ºç¬¦å·é¡ºåºï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼š æ–¹å¼ä¸€ï¼šé€šè¿‡ fishhook æ‹¦æˆª objc_msgSend() å‡½æ•° fishhook å¯ä»¥ hook ç³»ç»Ÿå‡½æ•°ï¼Œè€Œæ‰€æœ‰çš„ OC æ–¹æ³•è°ƒç”¨éƒ½ä¼šæ‰§è¡Œ objc_msgSend() è¿™ä¸ªæ–¹æ³•ï¼Œæ‰€æœ‰é€šè¿‡æ‹¦æˆª objc_msgSend() å°±å¯ä»¥ hook æ‰€æœ‰çš„ OC æ–¹æ³•ã€‚ä½†æ˜¯å› ä¸º objc_msgSend() çš„å‚æ•°æ˜¯å¯å˜çš„ï¼Œæ‰€ä»¥æ— æ³•ç›´æ¥è¿‡å»åˆ°ç¬¬äºŒä¸ªå‚æ•°(ä¹Ÿå°±æ˜¯ OC æ–¹æ³•çš„ SEL)ï¼Œåªèƒ½é€šè¿‡å¯„å­˜å™¨è·å–ï¼Œé‚£ä¹ˆå°±éœ€è¦ä½¿ç”¨æ±‡ç¼–ä»£ç äº†ã€‚å¯ä»¥å‚è€ƒæŠ–éŸ³å›¢é˜Ÿçš„æ–‡ç« ï¼šhttps://mp.weixin.qq.com/s/Drmmx5JtjG3UtTFksL6Q8Q é€šè¿‡ä¸Šé¢çš„åŠ¨æ€ hook çš„æ–¹å¼ï¼Œæˆ‘ä»¬åªèƒ½æ‹¦æˆª OC çš„æ–¹æ³•ã€‚è€Œé€šè¿‡ clang æ’æ¡©çš„æ–¹å¼ä¸ä»…å¯ä»¥ Hook OC æ–¹æ³•ï¼Œå¯ä»¥ hook å‡½æ•°ã€block ç­‰ï¼Œå®ç°å…¨éƒ¨çš„ hookã€‚ æ–¹å¼äºŒï¼šclangæ’æ¡©ã€é‡‡ç”¨ã€‘ å®˜æ–¹æ–‡æ¡£ï¼šclang LLVM æœ‰ä¸ªä»£ç è¦†ç›–çš„å·¥å…·åœ¨ SanitizerCoverage ä¸­ï¼Œå®ƒå¯ä»¥è¦†ç›–æˆ‘ä»¬è‡ªå®šä¹‰çš„æ‰€æœ‰çš„æ–¹æ³•ã€blocã€å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯åœ¨æˆ‘ä»¬æ‰€æœ‰çš„è‡ªå®šä¹‰æ–¹æ³•ä¸­æ’å…¥ä¸€ä¸ªå›è°ƒæ–¹æ³•ï¼Œè¿™æ ·ä»»ä½•è‡ªå®šä¹‰æ–¹æ³•çš„è°ƒç”¨éƒ½ä¼šè°ƒç”¨å›è°ƒå‡½æ•°ã€‚ ä½¿ç”¨æ–¹å¼ï¼š é¦–å…ˆåœ¨ Build Setting ä¸­çš„ Other C Flag ä¸­æ·»åŠ -fsanitize-coverage=func,trace-pc-guard ç„¶ååœ¨ä»»æ„çš„ç±»ä¸­å®ç°ä¸‹é¢ä¸¤ä¸ªæ–¹æ³•ï¼š 12345678void __sanitizer_cov_trace_pc_guard_init(uint32_t *start, uint32_t *stop) { static uint64_t N; // Counter for the guards. if (start == stop || *start) return; // Initialize only once. printf(&quot;INIT: %p %p\\n&quot;, start, stop); for (uint32_t *x = start; x &lt; stop; x++) *x = ++N; // Guards should start from 1.} 12345void __sanitizer_cov_trace_pc_guard(uint32_t *guard) { if (!*guard) return; // Duplicate the guard check. void *PC = __builtin_return_address(0);} æˆ‘ä»¬é€šè¿‡æ–­ç‚¹æŸ¥çœ‹æ±‡ç¼–ä»£ç å‘ç°ï¼Œç¼–è¯‘å™¨ä¼šåœ¨æ‰€æœ‰è‡ªå®šä¹‰æ–¹æ³•ä¸­æ’å…¥__sanitizer_cov_trace_pc_guardå‡½æ•°çš„è°ƒç”¨ï¼š ç”±äºåº•å±‚å®ç°ä¸­æ¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨å®Œæˆåéƒ½ä¼šè¿”å›ä¸‹ä¸€ä¸ªéœ€è¦è°ƒç”¨çš„å‡½æ•°çš„åœ°å€ï¼Œæ‰€ä»¥__sanitizer_cov_trace_pc_guardä¸­çš„ 1void *PC = __builtin_return_address(0); æ‹¿åˆ°çš„å°±æ˜¯ä¸‹ä¸€ä¸ªè¦è°ƒç”¨çš„å‡½æ•°çš„åœ°å€ï¼Œåˆå› ä¸º__sanitizer_cov_trace_pc_guardå‡½æ•°éƒ½æ˜¯åœ¨ hook å‡½æ•°å‰æ‰§è¡Œçš„ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œé¢æ‹¿åˆ°çš„å‡½æ•°åœ°å€å°±æ˜¯æˆ‘ä»¬ hook çš„å‡½æ•°åœ°å€ã€‚æ—¢ç„¶èƒ½æ‹¿åˆ°å‡½æ•°åœ°å€ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¿™ä¸ªå‡½æ•°å»æ‹¿åˆ°å‡½æ•°åç§°ç­‰ä¸€ç³»åˆ—çš„ä¿¡æ¯ï¼Œè¿™æ ·å°±æ‹¿åˆ°äº†æˆ‘ä»¬éœ€è¦çš„ç¬¦å·ã€‚æ‹¿åˆ°ç¬¦å·ä¹‹åå°±éœ€è¦ç»Ÿä¸€ä¿å­˜èµ·æ¥ï¼Œå®Œæ•´ä»£ç ï¼š â‘¤æ‹¿å¯åŠ¨æ—¶å‡½æ•°ç¬¦å·å¹¶ä¿å­˜çš„å®Œæ•´ä»£ç 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071#import &lt;dlfcn.h&gt;//åŸå­é˜Ÿåˆ—static OSQueueHead symbolList = OS_ATOMIC_QUEUE_INIT;//å®šä¹‰ç¬¦å·ç»“æ„ä½“typedef struct { void *pc; void *next;}SYNode;void __sanitizer_cov_trace_pc_guard_init(uint32_t *start, uint32_t *stop) { static uint64_t N; // Counter for the guards. if (start == stop || *start) return; // Initialize only once. printf(&quot;INIT: %p %p\\n&quot;, start, stop); for (uint32_t *x = start; x &lt; stop; x++) *x = ++N; // Guards should start from 1.}void __sanitizer_cov_trace_pc_guard(uint32_t *guard) {// if (!*guard) return; /*åœ¨è¿™é‡Œåšåˆ¤æ–­ï¼Œå“ªé‡Œå¼€å§‹ åˆ°å“ªé‡Œç»“æŸ*/ void *PC = __builtin_return_address(0); SYNode *node = malloc(sizeof(SYNode)); *node = (SYNode){PC,NULL}; OSAtomicEnqueue(&amp;symbolList, node, offsetof(SYNode, next));}- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions{ ... NSMutableArray &lt;NSString *&gt; * symbolNames = [NSMutableArray array]; while (YES) { SYNode * node = OSAtomicDequeue(&amp;symbolList, offsetof(SYNode, next)); if (node == NULL) { break; } Dl_info info; dladdr(node-&gt;pc, &amp;info); NSString * name = @(info.dli_sname); BOOL isObjc = [name hasPrefix:@&quot;+[&quot;] || [name hasPrefix:@&quot;-[&quot;]; NSString * symbolName = isObjc ? name: [@&quot;_&quot; stringByAppendingString:name]; [symbolNames addObject:symbolName]; } //å–å NSEnumerator * emt = [symbolNames reverseObjectEnumerator]; //å»é‡ NSMutableArray&lt;NSString *&gt; *funcs = [NSMutableArray arrayWithCapacity:symbolNames.count]; NSString * name; while (name = [emt nextObject]) { if (![funcs containsObject:name]) { [funcs addObject:name]; } } // æ’é™¤å½“å‰å‡½æ•°// [funcs removeObject:[NSString stringWithFormat:@&quot;%s&quot;,__FUNCTION__]]; //å°†æ•°ç»„å˜æˆå­—ç¬¦ä¸² NSString * funcStr = [funcs componentsJoinedByString:@&quot;\\n&quot;]; // å†™å…¥æ–‡ä»¶åˆ°æœ¬åœ° NSString * filePath = [NSTemporaryDirectory() stringByAppendingPathComponent:@&quot;test.order&quot;]; NSData * fileContents = [funcStr dataUsingEncoding:NSUTF8StringEncoding]; [[NSFileManager defaultManager] createFileAtPath:filePath contents:fileContents attributes:nil]; NSLog(@&quot;orderæ–‡ä»¶è·¯å¾„ï¼š%@&quot;, filePath);// NSLog(@&quot;%@&quot;,funcStr); return YES;} è¿è¡Œåº”ç”¨ï¼Œæ‰“å°å‡º test.order æ–‡ä»¶çš„è·¯å¾„ï¼Œå‰å¾€æŸ¥çœ‹æ­¤æ–‡ä»¶ï¼š 123456789101112131415161718192021222324252627282930313233343536+[XWDevice load]+[XWConfigNavigationBar load]+[UIColor(extend) getColor:]+[UIImage(extend) createImageWithColor:]_CGRectMake_UIOffsetMake+[BaseModel load]___copy_helper_block_e8____copy_helper_block_e8_32w___copy_helper_block_e8_32s40b___copy_helper_block_e8_32b___destroy_helper_block_e8_32s40s+[UIButton(UITableViewRowAction) load]+[NSObject(AOP) aop_changeMethod:newMethod:]+[UITextField(padding) load]___28+[UITextField(padding) load]_block_invoke+[UINavigationController(AOP) load]__ZNSt3__127__tree_balance_after_insertIPNS_16__tree_node_baseIPvEEEEvT_S5___ZNKSt3__116__tree_node_baseIPvE15__parent_unsafeEv__ZNSt3__1L20__tree_is_left_childIPNS_16__tree_node_baseIPvEEEEbT___ZNSt3__119__tree_right_rotateIPNS_16__tree_node_baseIPvEEEEvT___ZNSt3__116__tree_node_baseIPvE12__set_parentEPS2___ZNSt3__118__tree_left_rotateIPNS_16__tree_node_baseIPvEEEEvT___ZN2VA4Json5ValueC1ENS0_9ValueTypeE__ZN2VA4Json5ValueC2ENS0_9ValueTypeE__ZN2VA4Json5Value9initBasicENS0_9ValueTypeEb_main-[UIButton(UITableViewRowAction) aop_setTitle:forState:]___copy_helper_block_e8_32s40s-[EcmcAppDelegate application:didFinishLaunchingWithOptions:]-[EcmcAppDelegate setWindow:]-[EcmcAppDelegate window]-[EcmcAppDelegate root]-[EcmcAppDelegate application:supportedInterfaceOrientationsForWindow:]-[EcmcAppDelegate keyWindow]... â‘¥è®©é¡¹ç›®ä½¿ç”¨æˆ‘ä»¬çš„ order fileåœ¨é¡¹ç›®çš„ Build setting ä¸­æœç´¢ order fileï¼Œç„¶åå°† test.order è·¯å¾„æ·»åŠ è¿›å»ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å†™çš„æ˜¯é¡¹ç›®çš„æ ¹ç›®å½•ï¼Œå³./test.order ç„¶åæŠŠä¸Šä¸€æ­¥å¾—åˆ°çš„ test.order æ”¾åˆ°é¡¹ç›®çš„æ ¹ç›®å½•ä¸­ï¼š è¿™æ · Xcode åœ¨ç¼–è¯‘æ—¶å€™å°±ä¼šæŒ‰ç…§ test.order æ–‡ä»¶ä¸­çš„ç¬¦å·é¡ºåºé“¾æ¥ä»£ç äº†ï¼Œæˆ‘ä»¬ç¼–è¯‘ä¸€ä¸‹ï¼Œå†çœ‹ä¸€ä¸‹ LinkMap-normal-arm64.txt æ–‡ä»¶: 123456789101112131415161718192021222324252627282930313233343536# Symbols:# Address Size File Name0x100005D00 0x0000009C [266] +[XWDevice load]0x100005D9C 0x00000380 [306] +[XWConfigNavigationBar load]0x10000611C 0x000002C4 [686] +[UIColor(extend) getColor:]0x1000063E0 0x0000011C [826] +[UIImage(extend) createImageWithColor:]0x1000064FC 0x00000084 [ 78] _CGRectMake0x100006580 0x00000054 [306] _UIOffsetMake0x1000065D4 0x00000074 [1207] +[BaseModel load]0x100006648 0x0000003C [320] ___copy_helper_block_e8_0x100006684 0x00000050 [ 79] ___copy_helper_block_e8_32w0x1000066D4 0x00000074 [274] ___copy_helper_block_e8_32s40b0x100006748 0x00000054 [136] ___copy_helper_block_e8_32b0x10000679C 0x0000005C [ 78] ___destroy_helper_block_e8_32s40s0x1000067F8 0x0000005C [563] +[UIButton(UITableViewRowAction) load]0x100006854 0x0000009C [158] +[NSObject(AOP) aop_changeMethod:newMethod:]0x1000068F0 0x000000BC [700] +[UITextField(padding) load]0x1000069AC 0x00000228 [700] ___28+[UITextField(padding) load]_block_invoke0x100006BD4 0x00000060 [1143] +[UINavigationController(AOP) load]0x100006C34 0x0000024C [614] __ZNSt3__127__tree_balance_after_insertIPNS_16__tree_node_baseIPvEEEEvT_S5_0x100006E80 0x00000038 [614] __ZNKSt3__116__tree_node_baseIPvE15__parent_unsafeEv0x100006EB8 0x0000004C [614] __ZNSt3__1L20__tree_is_left_childIPNS_16__tree_node_baseIPvEEEEbT_0x100006F04 0x000000C8 [614] __ZNSt3__119__tree_right_rotateIPNS_16__tree_node_baseIPvEEEEvT_0x100006FCC 0x00000048 [614] __ZNSt3__116__tree_node_baseIPvE12__set_parentEPS2_0x100007014 0x000000CC [614] __ZNSt3__118__tree_left_rotateIPNS_16__tree_node_baseIPvEEEEvT_0x1000070E0 0x00000050 [614] __ZN2VA4Json5ValueC1ENS0_9ValueTypeE0x100007130 0x000000DC [614] __ZN2VA4Json5ValueC2ENS0_9ValueTypeE0x10000720C 0x00000094 [614] __ZN2VA4Json5Value9initBasicENS0_9ValueTypeEb0x1000072A0 0x00000098 [185] _main0x100007338 0x00000258 [563] -[UIButton(UITableViewRowAction) aop_setTitle:forState:]0x100007590 0x00000074 [ 78] ___copy_helper_block_e8_32s40s0x100007604 0x00000820 [930] -[EcmcAppDelegate application:didFinishLaunchingWithOptions:]0x100007E24 0x00000060 [930] -[EcmcAppDelegate setWindow:]0x100007E84 0x0000004C [930] -[EcmcAppDelegate window]0x100007ED0 0x000000E8 [930] -[EcmcAppDelegate root]... æˆ‘ä»¬å‘ç°æ˜¯æŒ‰ç…§ test.order çš„ç¬¦å·é¡ºåºæ¥çš„ï¼Œè€Œä¸”å¦‚æœ order é‡Œé¢å†™äº†é¡¹ç›®ä¸­ä¸å­˜åœ¨çš„æ–¹æ³•ç¬¦å·ï¼ŒXCode ä¼šè‡ªåŠ¨è¿‡æ»¤æ‰ï¼Œä¸å½±å“ã€‚ â‘¦(swiftçš„å¤„ç†)é¡¹ç›®å¦‚æœæ˜¯ç”¨çš„ swift çš„è¯ï¼Œæˆ‘ä»¬éœ€åœ¨ Building Setting ä¸­çš„ Other Swift Flags ä¸­æ·»åŠ -sanitize-coverage=funcå’Œ-sanitize=undefined å› ä¸ºswiftçš„å‘½åç©ºé—´çš„åŸå› ï¼Œswiftå‡½æ•°çš„åå­—æ˜¾ç¤ºä¸å¤ªå‹å¥½ï¼Œä¾‹å¦‚ï¼š 1234_$s9TraceDemo9SwiftTestC05swiftD4LoadyyFZTo_$s9TraceDemo9SwiftTestC05swiftD4LoadyyFZ_$ss5print_9separator10terminatoryypd_S2StFfA0__$ss5print_9separator10terminatoryypd_S2StFfA1_ â‘§è¿˜åŸOther C Flagsè®¾ç½®å‰é¢çš„æ­¥éª¤éƒ½å®Œæˆåï¼Œè¦å°† Other C Flags å’Œ Other Swift Flags ä¸­åšçš„é…ç½®å»æ‰ 123OC é…ç½®çš„æ˜¯ -fsanitize-coverage=func,trace-pc-guardSwift é…ç½®çš„æ˜¯ -sanitize-coverage=func å’Œ -sanitize=undefined å› ä¸ºåªè¦å­˜åœ¨è¿™ä¸ªé…ç½®ï¼Œç¼–è¯‘å™¨æ¯æ¬¡ç¼–è¯‘çš„æ—¶å€™éƒ½ä¼šè¿›è¡Œæ’æ¡©ï¼Œä¼šå½±å“å¯åŠ¨é€Ÿåº¦ã€‚ â‘¨é‡æ–°å†·å¯åŠ¨ï¼Œå†æ¬¡æŸ¥çœ‹page in ä¸ä¹‹å‰çš„è¿›è¡Œå¯¹æ¯”ï¼š å‡å°‘äº†795æ¬¡ page inï¼Œå°‘äº†0.15sï¼Œç•¥æœ‰æˆæ•ˆï¼Œè¿™æ ·æˆ‘ä»¬å°±å®Œæˆäº†äºŒè¿›åˆ¶é‡æ’ã€‚ äº”ã€å‡†å¤‡å’Œæ¸²æŸ“é¦–é¡µé˜¶æ®µåˆ†æè¿™ä¸€é˜¶æ®µçš„ä¼˜åŒ–ä¸»è¦æ˜¯å‡å°‘didFinishLaunchingWithOptionsæ–¹æ³•é‡Œçš„å·¥ä½œï¼Œåœ¨æ­¤æ–¹æ³•é‡Œï¼Œæˆ‘ä»¬ä¼šåˆ›å»ºåº”ç”¨çš„ windowï¼ŒæŒ‡å®šå…¶ rootViewControllerï¼Œè°ƒç”¨ window çš„makeKeyAndVisibleæ–¹æ³•è®©å…¶å¯è§ã€‚ç”±äºä¸šåŠ¡éœ€è¦ï¼Œæˆ‘ä»¬ä¼šåˆå§‹åŒ–å„ä¸ªç¬¬äºŒæ–¹/ä¸‰æ–¹åº“ï¼Œè®¾ç½®ç³»ç»Ÿ UI é£æ ¼ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºå¼•å¯¼é¡µã€æ˜¯å¦éœ€è¦ç™»å½•ã€æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬ç­‰ã€‚è¿™é‡Œçš„ä»£ç å®¹æ˜“å˜å¾—æ¯”è¾ƒåºå¤§ï¼Œå¯åŠ¨è€—æ—¶éš¾ä»¥æ§åˆ¶ã€‚ æ‰€ä»¥ï¼Œæ»¡è¶³ä¸šåŠ¡éœ€è¦çš„å‰æä¸‹ï¼ŒdidFinishLaunchingWithOptionsåœ¨ä¸»çº¿ç¨‹é‡Œåšçš„äº‹æƒ…è¶Šå°‘è¶Šå¥½ã€‚æˆ‘ä»¬å¯ä¼˜åŒ–é¡¹ï¼š æ¢³ç†å„ä¸ªç¬¬äºŒæ–¹/ä¸‰æ–¹åº“ï¼Œæ‰¾åˆ°å¯ä»¥å»¶è¿ŸåŠ è½½çš„åº“ï¼Œåšå»¶è¿ŸåŠ è½½å¤„ç†ï¼Œæ¯”å¦‚æ”¾åˆ°é¦–é¡µæ§åˆ¶å™¨çš„viewDidAppearæ–¹æ³•é‡Œã€‚ æ¢³ç†ä¸šåŠ¡é€»è¾‘ï¼ŒæŠŠå¯ä»¥å»¶è¿Ÿæ‰§è¡Œçš„é€»è¾‘ï¼Œåšå»¶è¿Ÿæ‰§è¡Œå¤„ç†ã€‚æ¯”å¦‚æ£€æŸ¥æ–°ç‰ˆæœ¬ã€æ³¨å†Œæ¨é€é€šçŸ¥ç­‰é€»è¾‘ã€‚ é¿å…å¤æ‚/å¤šä½™çš„è®¡ç®—ã€‚ é‡‡ç”¨æ€§èƒ½æ›´å¥½çš„ APIã€‚ é¿å…åœ¨é¦–é¡µæ§åˆ¶å™¨çš„viewDidLoadå’ŒviewWillAppearåšå¤ªå¤šäº‹æƒ…ï¼Œè¿™2ä¸ªæ–¹æ³•æ‰§è¡Œå®Œï¼Œé¦–é¡µæ§åˆ¶å™¨æ‰èƒ½æ˜¾ç¤ºï¼Œéƒ¨åˆ†å¯ä»¥å»¶è¿Ÿåˆ›å»ºçš„è§†å›¾åº”åšå»¶è¿Ÿåˆ›å»º/æ‡’åŠ è½½å¤„ç†ã€‚ å…­ã€å‡†å¤‡å’Œæ¸²æŸ“é¦–é¡µé˜¶æ®µé˜¶æ®µä¼˜åŒ–6.1 æ—¶é•¿æµ‹é‡æ–¹å¼ä¸€ï¼šä»£ç æ‰“ç‚¹ä½¿ç”¨æ’æ¡©æ‰“ç‚¹çš„æ–¹å¼é€šè¿‡ NSLog ç»Ÿè®¡æ¯ä¸ªæ–¹æ³•æ‰§è¡Œçš„æ—¶é—´ï¼Œå¯¹è€—æ—¶é«˜çš„è¿›è¡Œè€—æ—¶ç»†åˆ†ï¼Œå¯å»¶åçš„è¿›è¡Œå»¶åã€‚ 123456789101112131415// é€šè¿‡è¿™ä¸ªæ–¹å¼æ¥ç»Ÿè®¡æ¯ä¸ªæ–¹æ³•åŒæ­¥çš„è€—æ—¶CFAbsoluteTime start = CFAbsoluteTimeGetCurrent();[self doSomething];NSLog(@&quot;doSomething : %f&quot;,CFAbsoluteTimeGetCurrent() - start);// å¯ä»¥åœ¨mainå‡½æ•°è°ƒç”¨çš„æ—¶å€™è®¾ç½®ä¸€ä¸ªå…¨å±€å¼€å§‹æ—¶é—´ï¼Œ// åœ¨å…¶ä»–ç±»é‡Œé¢é€šè¿‡externå…³é”®å­—å–mainçš„æ—¶é—´ï¼Œå¦‚åœ¨main.må†…:CFAbsoluteTime kAppStartTime;int main(int argc, char *argv[]){ kAppStartTime = CFAbsoluteTimeGetCurrent();}// someClass.mextern CFAbsoluteTime kAppStartTime;CFAbsoluteTime duration = (CFAbsoluteTimeGetCurrent() - kAppStartTime); æ–¹å¼äºŒï¼šApp Launch å·¥å…· é¦–å…ˆåœ¨ Xcode çš„ build settings ä¸­ Debug Information Format è®¾ç½®ä¸º DWARF with dsYM File (ç”¨äºç¬¦å·åŒ–åœ°å€) command + i â€“&gt; Instruments â€“&gt; APP Launch å¯åŠ¨åº”ç”¨ å¦‚æœå¾—åˆ°çš„åˆ†ææ•°æ®æ²¡æœ‰ç¬¦å·åŒ–ï¼Œåœ¨APP Launché€‰æ‹©å±å¹•å·¦ä¸Šè§’çš„file â€“&gt; Symbols é€‰æ‹©äº®ç»¿ç¯çš„ç¬¦å·, é‡æ–°åœ¨åœ¨APP Launchè¿è¡Œé¡¹ç›®ã€‚ å¾—å‡ºä¸»çº¿ç¨‹çš„æ‰€æœ‰ä»»åŠ¡è€—æ—¶æ—¶é—´ï¼Œæ¯ä¸ªä»»åŠ¡æ ¹æ®å›¾å³ä¾§çš„å †æ ˆæŒ¨ä¸ªæ’æŸ¥æ˜¯å¦æ˜¯å¯åŠ¨é“¾è·¯ä¸­å¯ä¼˜åŒ–çš„ï¼ˆå‡ æ¯«ç§’çš„ä¹Ÿåˆ«æ”¾è¿‡ï¼‰ã€‚ 6.2 ä¼˜åŒ–ä¸²è¡Œæ“ä½œåœ¨å†·å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œæœ‰å¾ˆå¤šæ“ä½œæ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œè‹¥å¹²ä¸ªä»»åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œæ—¶é—´å¿…ç„¶æ¯”è¾ƒé•¿ã€‚å¦‚æœèƒ½å˜ä¸²è¡Œä¸ºå¹¶è¡Œï¼Œé‚£ä¹ˆå†·å¯åŠ¨æ—¶é—´å°±èƒ½å¤Ÿå¤§å¤§ç¼©çŸ­ã€‚ 6.2.1 å¯åŠ¨é¡µçš„ä½¿ç”¨ç°åœ¨è®¸å¤šAppåœ¨å¯åŠ¨æ—¶å¹¶ä¸ç›´æ¥è¿›å…¥é¦–é¡µï¼Œè€Œæ˜¯ä¼šå‘ç”¨æˆ·å±•ç¤ºä¸€ä¸ªæŒç»­ä¸€å°æ®µæ—¶é—´çš„å¯åŠ¨é¡µï¼Œå¦‚æœä½¿ç”¨æ°å½“ï¼Œè¿™ä¸ªå¯åŠ¨é¡µå°±èƒ½å¸®æˆ‘ä»¬èŠ‚çœä¸€äº›å¯åŠ¨æ—¶é—´ã€‚å› ä¸ºå½“ä¸€ä¸ªAppæ¯”è¾ƒå¤æ‚çš„æ—¶å€™ï¼Œå¯åŠ¨æ—¶é¦–æ¬¡æ„å»ºAppçš„UIå°±æ˜¯ä¸€ä¸ªæ¯”è¾ƒè€—æ—¶çš„è¿‡ç¨‹ï¼Œå‡å®šè¿™ä¸ªæ—¶é—´æ˜¯0.2ç§’ï¼Œå¦‚æœæˆ‘ä»¬æ˜¯å…ˆæ„å»ºé¦–é¡µUIï¼Œç„¶åå†åœ¨Windowä¸ŠåŠ ä¸Šè¿™ä¸ªå¯åŠ¨é¡µï¼Œé‚£ä¹ˆå†·å¯åŠ¨æ—¶ï¼ŒAppå°±ä¼šå®å®åœ¨åœ¨åœ°å¡ä½0.2ç§’ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬æ˜¯å…ˆæŠŠå¯åŠ¨é¡µä½œä¸ºAppçš„RootViewControllerï¼Œé‚£ä¹ˆè¿™ä¸ªæ„å»ºè¿‡ç¨‹å°±ä¼šå¾ˆå¿«ã€‚å› ä¸ºå¯åŠ¨é¡µåªæœ‰ä¸€ä¸ªç®€å•çš„ImageViewï¼Œè€Œè¿™ä¸ªImageViewåˆ™ä¼šå‘ç”¨æˆ·å±•ç¤ºä¸€å°æ®µæ—¶é—´ï¼Œè¿™æ—¶æˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨è¿™ä¸€æ®µæ—¶é—´æ¥æ„å»ºé¦–é¡µUIäº†ï¼Œä¸€ä¸¾ä¸¤å¾—ã€‚ 6.2.2 ç¼“å­˜å®šä½&amp;é¦–é¡µé¢„è¯·æ±‚å†·å¯åŠ¨è¿‡ç¨‹ä¸­ä¸€ä¸ªé‡è¦çš„ä¸²è¡Œæµç¨‹å°±æ˜¯ï¼šé¦–é¡µå®šä½â€“&gt;é¦–é¡µè¯·æ±‚â€“&gt;é¦–é¡µæ¸²æŸ“è¿‡ç¨‹ï¼Œè¿™ä¸‰ä¸ªæ“ä½œå äº†æ•´ä¸ªé¦–é¡µåŠ è½½æ—¶é—´çš„77%å·¦å³ï¼Œæ‰€ä»¥æƒ³è¦ç¼©çŸ­å†·å¯åŠ¨æ—¶é—´ï¼Œå°±ä¸€å®šè¦ä»è¿™ä¸‰ç‚¹å‡ºå‘è¿›è¡Œä¼˜åŒ–ã€‚ ä¹‹å‰ä¸²è¡Œæ“ä½œæµç¨‹å¦‚ä¸‹ï¼š ä¼˜åŒ–åçš„è®¾è®¡ï¼Œåœ¨å‘èµ·å®šä½çš„åŒæ—¶ï¼Œä½¿ç”¨å®¢æˆ·ç«¯ç¼“å­˜å®šä½ï¼Œè¿›è¡Œé¦–é¡µæ•°æ®çš„é¢„è¯·æ±‚ï¼Œä½¿å®šä½å’Œè¯·æ±‚å¹¶è¡Œè¿›è¡Œã€‚ç„¶åå½“ç”¨æˆ·çœŸå®å®šä½æˆåŠŸåï¼Œåˆ¤æ–­çœŸå®å®šä½æ˜¯å¦å‘½ä¸­ç¼“å­˜å®šä½ï¼Œå¦‚æœå‘½ä¸­ï¼Œåˆ™åˆšæ‰çš„é¢„è¯·æ±‚æ•°æ®æœ‰æ•ˆï¼Œè¿™æ ·å¯ä»¥èŠ‚çœå¤§æ¦‚40%çš„æ—¶é—´é¦–é¡µåŠ è½½æ—¶é—´ï¼Œæ•ˆæœéå¸¸æ˜æ˜¾ï¼›å¦‚æœæœªå‘½ä¸­ï¼Œåˆ™å¼ƒç”¨é¢„è¯·æ±‚æ•°æ®ï¼Œé‡æ–°è¯·æ±‚ã€‚ PSæˆ‘ Github ä¸Šæ£€æµ‹é¡¹ç›®æœªä½¿ç”¨åˆ°çš„æ–¹æ³• å‚è€ƒiOS Appå†·å¯åŠ¨æ²»ç†ï¼šæ¥è‡ªç¾å›¢å¤–å–çš„å®è·µ iOS è„šæœ¬æŸ¥çœ‹é¡¹ç›®æœªä½¿ç”¨åˆ°çš„æ–¹æ³• æŠ–éŸ³ç ”å‘å®è·µï¼šåŸºäºäºŒè¿›åˆ¶æ–‡ä»¶é‡æ’çš„è§£å†³æ–¹æ¡ˆï¼ŒAPP å¯åŠ¨é€Ÿåº¦æå‡è¶… 15% appå¯åŠ¨ä¼˜åŒ– iOSåŸºäºäºŒè¿›åˆ¶é‡æ’çš„å¯åŠ¨ä¼˜åŒ– iOS å¯åŠ¨ä¼˜åŒ– + ç›‘æ§å®è·µ","link":"/2021/07/13/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/22-iOS%20App%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96/"},{"title":"23-å†…å­˜ç®¡ç†","text":"ä¸€ã€å†…å­˜å¸ƒå±€ 1.1 äº”å¤§åŒºä»é«˜åœ°å€åˆ°ä½åœ°å€ä¾æ¬¡ä¸ºï¼š æ ˆåŒºï¼šç¼–è¯‘å™¨è‡ªåŠ¨åˆ†é…ï¼Œç”±ç³»ç»Ÿç®¡ç†ï¼Œåœ¨ä¸éœ€è¦çš„æ—¶å€™è‡ªåŠ¨æ¸…é™¤ã€‚å±€éƒ¨å˜é‡ã€å‡½æ•°å‚æ•°å­˜å‚¨åœ¨è¿™é‡Œã€‚æ ˆåŒºçš„å†…å­˜åœ°å€ä¸€èˆ¬æ˜¯0x7å¼€å¤´ã€‚ å †åŒºï¼šé‚£äº›ç”±newï¼Œallocã€block copyåˆ›å»ºçš„å¯¹è±¡å­˜å‚¨åœ¨è¿™é‡Œï¼Œæ˜¯ç”±å¼€å‘è€…ç®¡ç†çš„ï¼Œéœ€è¦å‘Šè¯‰ç³»ç»Ÿä»€ä¹ˆæ—¶å€™é‡Šæ”¾å†…å­˜ã€‚ARCä¸‹ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨åœ¨åˆé€‚çš„æ—¶å€™é‡Šæ”¾å†…å­˜ï¼Œè€Œåœ¨MRCä¸‹éœ€è¦å¼€å‘è€…æ‰‹åŠ¨é‡Šæ”¾ã€‚å †åŒºçš„å†…å­˜åœ°å€ä¸€èˆ¬æ˜¯0x6å¼€å¤´ã€‚ BSSæ®µï¼šBSSæ®µåˆç§°é™æ€åŒºï¼Œæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼Œé™æ€å˜é‡å­˜æ”¾åœ¨è¿™é‡Œã€‚ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­å†…å­˜ä¸­çš„æ•°æ®ä¸€ç›´å­˜åœ¨ï¼Œç¨‹åºç»“æŸåç”±ç³»ç»Ÿé‡Šæ”¾ã€‚ æ•°æ®æ®µï¼šæ•°æ®æ®µåˆç§°å¸¸é‡åŒºï¼Œä¸“é—¨å­˜æ”¾å¸¸é‡ï¼Œç¨‹åºç»“æŸåç”±ç³»ç»Ÿé‡Šæ”¾ã€‚ ä»£ç æ®µï¼šç”¨äºå­˜æ”¾ç¨‹åºè¿è¡Œæ—¶çš„ä»£ç ï¼Œä»£ç ä¼šè¢«ç¼–è¯‘æˆäºŒè¿›åˆ¶å­˜è¿›å†…å­˜çš„ç¨‹åºä»£ç åŒºã€‚ é™¤äº†äº”å¤§åŒºä¹‹å¤–ï¼Œå†…å­˜ä¸­è¿˜æœ‰ä¿ç•™å­—æ®µå’Œå†…æ ¸åŒº å†…æ ¸åŒºï¼šåœ¨4gbå†…å­˜ä¸­åªç”¨åˆ°äº†3gbï¼Œè¿˜æœ‰1gbç»™å†…æ ¸åŒºå¤„ç† ä¿ç•™å­—æ®µï¼šä¿ç•™ä¸€å®šçš„åŒºåŸŸç»™ä¿ç•™å­—æ®µï¼Œè¿›è¡Œä¸€äº›å­˜å‚¨ æ¥ä¸‹æ¥å°±ç”¨LLDBæ¥æ‰“å°ä¸€ä¸‹å †åŒºå’Œæ ˆåŒºä¸­çš„ä¸€äº›å†…å®¹ 1.2 å†…å­˜å¸ƒå±€é¢è¯•é¢˜1.å…¨å±€å˜é‡å’Œå±€éƒ¨å˜é‡åœ¨å†…å­˜ä¸­æ˜¯å¦æœ‰åŒºåˆ«ï¼Ÿ å…¨å±€å˜é‡å­˜æ”¾åœ¨ç›¸åº”çš„å…¨å±€å‚¨å­˜åŒºï¼Œè€Œå±€éƒ¨å˜é‡å­˜æ”¾åœ¨æ ˆåŒº ä¸¤è€…è®¿é—®çš„æƒé™ä¸ä¸€æ · 2.blockæ˜¯å¦å¯ä»¥ä¿®æ”¹å…¨å±€å˜é‡ å¯ä»¥ï¼Œå› ä¸ºå…¨å±€å˜é‡çš„ä½œç”¨åŸŸå¾ˆå¤§ï¼ˆå¯ä»¥ç†è§£ä¸ºå…¬å…±åŒºåŸŸï¼‰ï¼Œblockå¯ä»¥è®¿é—®åˆ° 3.å…³äºå…¨å±€é™æ€å˜é‡ å…¨å±€é™æ€å˜é‡æ˜¯å¯å˜çš„ï¼Œæ˜¯ static ä¸æ˜¯ const å…¨å±€é™æ€å˜é‡çš„å€¼åªé’ˆå¯¹å½“å‰æ–‡ä»¶è€Œè¨€ï¼Œä¸åŒæ–‡ä»¶ä¸­çš„å…¨å±€é™æ€å˜é‡çš„å†…å­˜åœ°å€æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ‰€ä»¥å€¼ä¹Ÿä¸ä¸€æ · å‡è®¾æœ‰ä¸ªå…¨å±€é™æ€å˜é‡ num=10 vcä¸­ä¿®æ”¹num=20å¹¶åœ¨vcä¸­æ‰“å°ä¼šè¾“å‡º20 viewä¸­ä¿®æ”¹num=num+1å¹¶åœ¨viewä¸­ä¼šè¾“å‡º11 modelä¸­ä¿®æ”¹num=0å¹¶åœ¨modelä¸­ä¼šè¾“å‡º0 åœ¨modelçš„åˆ†ç±»ä¸­ä¿®æ”¹num=1000å¹¶åœ¨modelåˆ†ç±»ä¸­ä¼šè¾“å‡º1000 æ€»ç»“ï¼š å…¨å±€é™æ€å˜é‡åªé’ˆå¯¹æ–‡ä»¶è€Œè¨€ï¼Œæ— è®ºåˆ«çš„æ–‡ä»¶æ€ä¹ˆä¿®æ”¹ï¼Œæœ¬æ–‡ä»¶ä½¿ç”¨æ—¶éƒ½æ‹¿åŸæœ‰å€¼/æœ¬æ–‡ä»¶ä¿®æ”¹åçš„å€¼ äºŒã€å†…å­˜ç®¡ç†æ–¹æ¡ˆ2.1 taggedPointer ç®€ä»‹åœ¨ 2013 å¹´ 9 æœˆï¼Œè‹¹æœæ¨å‡ºäº† iPhone5sï¼Œä¸æ­¤åŒæ—¶ï¼ŒiPhone5s é…å¤‡äº†é¦–ä¸ªé‡‡ç”¨ 64 ä½æ¶æ„çš„ A7 åŒæ ¸å¤„ç†å™¨ï¼Œä¸ºäº†èŠ‚çœå†…å­˜å’Œæé«˜æ‰§è¡Œæ•ˆç‡ï¼Œè‹¹æœæå‡ºäº†Tagged Pointerã€‚ Tagged Pointeræ˜¯ä¸“â»”â½¤æ¥å­˜å‚¨â¼©çš„å¯¹è±¡ï¼Œä¾‹å¦‚NSNumberï¼ŒNSStringï¼ŒNSDateç­‰ã€‚ Tagged PointeræŒ‡é’ˆçš„å€¼ä¸å†æ˜¯åœ°å€äº†ï¼Œâ½½æ˜¯çœŸæ­£çš„å€¼ã€‚æ‰€ä»¥ï¼Œå®é™…ä¸Šå®ƒä¸å†æ˜¯â¼€ä¸ªå¯¹è±¡äº†ï¼Œå®ƒåªæ˜¯â¼€ä¸ªæŠ«ç€å¯¹è±¡â½ªçš„æ™®é€šå˜é‡â½½å·²ã€‚æ‰€ä»¥ï¼Œå®ƒçš„å†…å­˜å¹¶ä¸å­˜å‚¨åœ¨å †ä¸­ï¼Œä¹Ÿä¸éœ€è¦mallocå’Œfreeã€‚ åœ¨å†…å­˜è¯»å–ä¸Šæœ‰ç€3å€çš„æ•ˆç‡ï¼Œåˆ›å»ºæ—¶â½ä»¥å‰å¿«106å€ã€‚ é‚£ä¹ˆTagged Ponterå¯¹äºå†…å­˜ä¼˜åŒ–çš„ç‚¹åœ¨å“ªé‡Œå‘¢ï¼Ÿ æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ª NSIntegerçš„æ™®é€šå˜é‡ï¼Œé‚£ä¹ˆå®ƒåœ¨32ä½CPUä¸‹å  4 ä¸ªå­—èŠ‚ï¼Œåœ¨ 64 ä½CPUä¸‹å  8 ä¸ªå­—èŠ‚çš„ã€‚è€ŒNSNumberå¯¹è±¡è¿˜æœ‰ä¸€ä¸ªisaæŒ‡é’ˆï¼Œå®ƒåœ¨32ä½CPUä¸‹ä¸º4ä¸ªå­—èŠ‚ï¼Œåœ¨ 64 ä½ CPU ä¸‹æ˜¯ 8 ä¸ªå­—èŠ‚ã€‚æ‰€ä»¥ä»32ä½æœºå™¨è¿ç§»åˆ°64ä½æœºå™¨ä¸­åï¼Œè™½ç„¶é€»è¾‘æ²¡æœ‰ä»»ä½•å˜åŒ–ï¼Œä½†è¿™ç§ NSNumberã€NSDate ä¸€ç±»çš„å¯¹è±¡æ‰€å ç”¨çš„å†…å­˜ä¼šç¿»å€ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š è€Œå®é™…ä¸Šä¸€ä¸ªNSNumberã€NSDateè¿™ä¸€ç±»çš„å˜é‡çš„å€¼éœ€è¦çš„å†…å­˜ç©ºé—´å¸¸å¸¸ä¸éœ€è¦8ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆå¦‚ä¸Šè¿°æ¥è¿›è¡Œæ•°æ®çš„å­˜å‚¨ï¼Œå†…å­˜ç©ºé—´çš„æµªè´¹æ˜¯å¾ˆå¤§çš„ã€‚Tagged Ponterè§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚ Tagged Ponterå°†ä¸€ä¸ªå¯¹è±¡çš„æŒ‡é’ˆæ‹†æˆä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†ç›´æ¥ä¿å­˜æ•°æ®ï¼Œå¦ä¸€éƒ¨åˆ†ä½œä¸ºç‰¹æ®Šæ ‡è®°ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªç‰¹åˆ«çš„æŒ‡é’ˆï¼Œä¸æŒ‡å‘ä»»ä½•ä¸€ä¸ªåœ°å€ã€‚æ‰€ä»¥ï¼Œå¼•å…¥äº†Tagged Pointerå¯¹è±¡ä¹‹åï¼Œ64ä½CPUä¸‹ NSNumber çš„å†…å­˜å›¾å˜æˆäº†ä»¥ä¸‹è¿™æ ·ï¼š 2.2 taggedPointer åº•å±‚æ¢ç´¢123456789101112131415static voidinitializeTaggedPointerObfuscator(void){ if (sdkIsOlderThan(10_14, 12_0, 12_0, 5_0, 3_0) || // Set the obfuscator to zero for apps linked against older SDKs, // in case they're relying on the tagged pointer representation. DisableTaggedPointerObfuscation) { objc_debug_taggedpointer_obfuscator = 0; } else { // Pull random data into the variable, then shift away all non-payload bits. arc4random_buf(&amp;objc_debug_taggedpointer_obfuscator, sizeof(objc_debug_taggedpointer_obfuscator)); objc_debug_taggedpointer_obfuscator &amp;= ~_OBJC_TAG_MASK; }} åº•å±‚ä¹Ÿåšäº†å¯¹objc_debug_taggedpointer_obfuscatorè¿›è¡Œå¼‚æˆ–çš„æ“ä½œã€‚æˆ‘ä»¬éƒ½çŸ¥é“å°†aå’Œbå¼‚æˆ–æ“ä½œå¾—åˆ°cå†å’Œaè¿›è¡Œå¼‚æˆ–æ“ä½œä¾¿å¯ä»¥é‡æ–°å¾—åˆ°açš„å€¼ï¼Œé€šå¸¸å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹å¼æ¥å®ç°ä¸ç”¨ä¸­é—´å˜é‡å®ç°ä¸¤ä¸ªå€¼çš„äº¤æ¢ï¼ŒTagged Pointeræ­£æ˜¯ä½¿ç”¨äº†è¿™ç§åŸç†ã€‚ 12345678910111213extern uintptr_t objc_debug_taggedpointer_obfuscator;static inline void * _Nonnull_objc_encodeTaggedPointer(uintptr_t ptr){ return (void *)(objc_debug_taggedpointer_obfuscator ^ ptr);}static inline uintptr_t_objc_decodeTaggedPointer(const void * _Nullable ptr){ return (uintptr_t)ptr ^ objc_debug_taggedpointer_obfuscator;} æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ç±»ä¼¼çš„æ–¹æ³•å¯¹taggedPointerè¿›è¡Œè§£ç ï¼š 12345678910111213141516171819202122232425262728293031323334extern uintptr_t objc_debug_taggedpointer_obfuscator;uintptr_t_objc_decodeTaggedPointer_(id ptr){ return (uintptr_t)ptr ^ objc_debug_taggedpointer_obfuscator;}- (void)viewDidLoad { [super viewDidLoad]; NSString *str1 = [NSString stringWithFormat:@&quot;a&quot;]; NSString *str2 = [NSString stringWithFormat:@&quot;ab&quot;]; NSString *str3 = [NSString stringWithFormat:@&quot;abc&quot;]; NSString *str4 = [NSString stringWithFormat:@&quot;abcd&quot;]; NSString *str5 = [NSString stringWithFormat:@&quot;abcde&quot;]; NSString *str6 = [NSString stringWithFormat:@&quot;abcdef&quot;]; NSString *str7 = [NSString stringWithFormat:@&quot;abcdefg&quot;]; NSString *str8 = [NSString stringWithFormat:@&quot;abcdefgh&quot;]; NSString *str9 = [NSString stringWithFormat:@&quot;abcdefghi&quot;]; NSString *str10 = [NSString stringWithFormat:@&quot;abcdefghij&quot;]; NSLog(@&quot;%@ %p 0x%lx&quot;, str1, str1, _objc_decodeTaggedPointer_(str1)); NSLog(@&quot;%@ %p 0x%lx&quot;, str2, str2, _objc_decodeTaggedPointer_(str2)); NSLog(@&quot;%@ %p 0x%lx&quot;, str3, str3, _objc_decodeTaggedPointer_(str3)); NSLog(@&quot;%@ %p 0x%lx&quot;, str4, str4, _objc_decodeTaggedPointer_(str4)); NSLog(@&quot;%@ %p 0x%lx&quot;, str5, str5, _objc_decodeTaggedPointer_(str5)); NSLog(@&quot;%@ %p 0x%lx&quot;, str6, str6, _objc_decodeTaggedPointer_(str6)); NSLog(@&quot;%@ %p 0x%lx&quot;, str7, str7, _objc_decodeTaggedPointer_(str7)); NSLog(@&quot;%@ %p 0x%lx&quot;, str8, str8, _objc_decodeTaggedPointer_(str8)); NSLog(@&quot;%@ %p 0x%lx&quot;, str9, str9, _objc_decodeTaggedPointer_(str9)); NSLog(@&quot;%@ %p 0x%lx&quot;, str10, str10, _objc_decodeTaggedPointer_(str10)); } è¾“å‡ºç»“æœï¼š ç»“æœå°±æ˜¯ï¼š NSStringä¸è¶…è¿‡9ä¸ªå­—ç¬¦æ˜¯NSTaggedPointerStringç±»å‹ï¼Œè¶…è¿‡9ä¸ªå­—ç¬¦æ˜¯__NSCFStringç±»å‹ NSStringç”¨å­—é¢é‡åˆå§‹åŒ–ä¼šæ˜¯__NSCFConstantStringç±»å‹è€Œä¸æ˜¯NSTaggedPointerStringç±»å‹ 2.3 taggedPointer æ€»ç»“ taggedPointerä¸“é—¨ç”¨æ¥å­˜å‚¨å°çš„å¯¹è±¡ï¼Œä¾‹å¦‚NSNumberã€NSStirngã€NSDate taggedPointeræŒ‡é’ˆçš„å€¼ä¸å†æ˜¯åœ°å€äº†ï¼Œè€Œæ˜¯çœŸæ­£çš„å€¼ã€‚æ‰€ä»¥ä»–ä¸å†æ˜¯ä¸€ä¸ªå¯¹è±¡äº†ï¼Œä»–åªæ˜¯ä¸€ä¸ªâ€æŠ«ç€å¯¹è±¡å¤–çš®â€çš„æ™®é€šå˜é‡è€Œå·²â€”â€”å®ƒçš„å†…å­˜å¹¶ä¸åœ¨å †ä¸­ï¼Œä¹Ÿä¸éœ€è¦mallocå’Œfree taggedPointerä¸åƒåœ°å€æŒ‡é’ˆä¸€æ ·ï¼Œç›´æ¥ä»æŒ‡é’ˆä¸­æ‹¿åˆ°å€¼â€”â€”ç¼–è¯‘è¯»å–çš„æ—¶å€™æ›´åŠ ç›´æ¥äº† ä¸‰ã€NONPOINTER_ISANONPOINTER_ISAåŒæ ·æ˜¯è‹¹æœå…¬å¸å¯¹äºå†…å­˜ä¼˜åŒ–çš„ä¸€ç§æ–¹æ¡ˆã€‚isaæ˜¯ä¸ª8å­—èŠ‚ï¼ˆ64ä½ï¼‰çš„æŒ‡é’ˆï¼Œä»…ç”¨æ¥isaæŒ‡å‘æ¯”è¾ƒæµªè´¹ï¼Œæ‰€ä»¥isaä¸­å°±æºæ‚äº†ä¸€äº›å…¶ä»–æ•°æ®æ¥èŠ‚çœå†…å­˜ã€‚isa æŒ‡é’ˆç¬¬ä¸€ä½ä¸º 1 å³è¡¨ç¤ºä½¿ç”¨ä¼˜åŒ–çš„ isa æŒ‡é’ˆï¼šNONPOINTER_ISA arm64 æ¶æ„ä¸‹ isa æŒ‡é’ˆçš„ç»“æ„ï¼š 1234567891011121314151617181920union isa_t { isa_t() { } isa_t(uintptr_t value) : bits(value) { } Class cls; uintptr_t bits;#if defined(ISA_BITFIELD) struct { uintptr_t nonpointer : 1; uintptr_t has_assoc : 1; uintptr_t has_cxx_dtor : 1; uintptr_t shiftcls : 33; uintptr_t magic : 6; uintptr_t weakly_referenced : 1; uintptr_t deallocating : 1; uintptr_t has_sidetable_rc : 1; uintptr_t extra_rc : 19 };#endif}; å››ã€SideTableSideTableåœ¨OCä¸­æ‰®æ¼”è¿™ä¸€ä¸ªå¾ˆé‡è¦çš„è§’è‰²ã€‚åœ¨runtimeä¸­ï¼Œé€šè¿‡SideTableæ¥ç®¡ç†å¯¹è±¡çš„==å¼•ç”¨è®¡æ•°==ä»¥åŠ==weakå¼•ç”¨==ã€‚åŒæ—¶ï¼Œç³»ç»Ÿä¸­ç»´æŠ¤äº†ä¸€ä¸ªå…¨å±€çš„SideTablesï¼Œè¿™æ˜¯ä¸€ä¸ªSideTableçš„é›†åˆã€‚ æ¥çœ‹çœ‹SideTableçš„å®šä¹‰ï¼š 12345struct SideTable { spinlock_t slock; RefcountMap refcnts; weak_table_t weak_table;} SideTableçš„å®šä¹‰å¾ˆæ¸…æ™°ï¼Œæœ‰ä¸‰ä¸ªæˆå‘˜: spinlock_t slockï¼šè‡ªæ—‹é”ï¼Œç”¨äºä¸Šé”/è§£é” SideTableã€‚ RefcountMap refcntsï¼šç”¨æ¥å­˜å‚¨OCå¯¹è±¡çš„å¼•ç”¨è®¡æ•°çš„ hashè¡¨(ä»…åœ¨æœªå¼€å¯isaä¼˜åŒ–æˆ–åœ¨isaä¼˜åŒ–æƒ…å†µä¸‹isa_tçš„å¼•ç”¨è®¡æ•°æº¢å‡ºæ—¶æ‰ä¼šç”¨åˆ°)ã€‚ weak_table_t weak_tableï¼šå­˜å‚¨å¯¹è±¡å¼±å¼•ç”¨æŒ‡é’ˆçš„hashè¡¨ã€‚æ˜¯OCä¸­weakåŠŸèƒ½å®ç°çš„æ ¸å¿ƒæ•°æ®ç»“æ„ã€‚ äº”ã€ARC &amp; MRC ARCæ˜¯LLVMå’ŒRuntimeé…åˆçš„ç»“æœ ARCä¸­ç¦æ­¢æ‰‹åŠ¨è°ƒç”¨retain/release/retainCount/dealloc ARCæ–°åŠ äº†weakã€strongå…³é”®å­— 5.1 allocä¹‹å‰å·²ç»å¯¹allocæµç¨‹æœ‰äº†ä¸€ä¸ªè¯¦ç»†çš„ä»‹ç»ã€‚æ€»ç»“ä¸€å¥è¯å°±æ˜¯allocåˆ›å»ºäº†å¯¹è±¡å¹¶ä¸”ç”³è¯·äº†ä¸€å—ä¸å°‘äº16å­—èŠ‚çš„å†…å­˜ç©ºé—´ã€‚ 5.2 retainä½¿ç”¨æˆ‘çš„objc4-756.2æºç è¿›è¡Œæºç è¿½è¸ªï¼š å…¥å£ï¼š 1234567id objc_retain(id obj){ if (!obj) return obj; if (obj-&gt;isTaggedPointer()) return obj; //TaggedPointerå¯¹è±¡ä¸åšå¼•ç”¨è®¡æ•°å¤„ç† return obj-&gt;retain();} 1234567891011inline id objc_object::retain(){ assert(!isTaggedPointer()); if (fastpath(!ISA()-&gt;hasCustomRR())) { return rootRetain(); // å¤§æ¦‚ç‡èµ°è¿™é‡Œ } return ((id(*)(objc_object *, SEL))objc_msgSend)(this, SEL_retain);} retainæ–¹æ³•å†…éƒ¨å…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªåˆ¤æ–­ï¼Œç„¶åè°ƒç”¨rootRetainæ–¹æ³•ã€‚å…¶ä¸­fastpathæ˜¯å¤§æ¦‚ç‡å‘ç”Ÿçš„æ„æ€ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960objc_object::rootRetain(bool tryRetain, bool handleOverflow){ if (isTaggedPointer()) return (id)this; bool sideTableLocked = false; bool transcribeToSideTable = false; isa_t oldisa; isa_t newisa; do { transcribeToSideTable = false; oldisa = LoadExclusive(&amp;isa.bits); newisa = oldisa; if (slowpath(!newisa.nonpointer)) { //å¦‚æœä¸æ˜¯ nonpointer isaï¼Œç›´æ¥æ“ä½œæ•£åˆ—è¡¨sidetable ClearExclusive(&amp;isa.bits); if (!tryRetain &amp;&amp; sideTableLocked) sidetable_unlock(); if (tryRetain) return sidetable_tryRetain() ? (id)this : nil; else return sidetable_retain(); //å¼•ç”¨è®¡æ•°å­˜å‚¨äºSideTableä¸­ } // don't check newisa.fast_rr; we already called any RR overrides // æ£€æŸ¥å¯¹è±¡æ˜¯å¦æ­£åœ¨é‡Šæ”¾ï¼Œå¦‚æœæ­£åœ¨é‡Šæ”¾ï¼Œåˆ™æ‰§è¡Œdeallocæµç¨‹ if (slowpath(tryRetain &amp;&amp; newisa.deallocating)) { ClearExclusive(&amp;isa.bits); if (!tryRetain &amp;&amp; sideTableLocked) sidetable_unlock(); return nil; } // å¦‚æœæ˜¯nonpointer_isaï¼Œå¤§æ¦‚ç‡äº‹ä»¶ uintptr_t carry; // è®°å½•å¼•ç”¨è®¡æ•°æ˜¯å¦è¶…è´Ÿè· // isaçš„bitsä¸­çš„extra_rcè¿›è¡ŒåŠ 1 newisa.bits = addc(newisa.bits, RC_ONE, 0, &amp;carry); // extra_rc++ // å¦‚æœbitsçš„extra_rcå·²ç»å­˜æ»¡äº†ï¼Œåˆ™extra_rcç½®ç©ºä¸€åŠçš„æ•°å€¼ if (slowpath(carry)) { // å°æ¦‚ç‡å‘ç”Ÿ // newisa.extra_rc++ overflowed if (!handleOverflow) { ClearExclusive(&amp;isa.bits); return rootRetain_overflow(tryRetain); } // Leave half of the retain counts inline and // prepare to copy the other half to the side table. if (!tryRetain &amp;&amp; !sideTableLocked) sidetable_lock(); sideTableLocked = true; transcribeToSideTable = true; newisa.extra_rc = RC_HALF; // extra_rcç½®ç©ºä¸€åŠçš„æ•°å€¼ newisa.has_sidetable_rc = true; } } while (slowpath(!StoreExclusive(&amp;isa.bits, oldisa.bits, newisa.bits))); if (slowpath(transcribeToSideTable)) { // Copy the other half of the retain counts to the side table. // å¦‚æœbitsçš„extra_rcå·²ç»å­˜æ»¡äº†ï¼Œå°†å¦å¤–çš„ä¸€åŠå¼•ç”¨è®¡æ•°å­˜å‚¨åˆ°sidetableä¸­ sidetable_addExtraRC_nolock(RC_HALF); } if (slowpath(!tryRetain &amp;&amp; sideTableLocked)) sidetable_unlock(); return (id)this;} ã€ç¬¬ä¸€æ­¥ã€‘åˆ¤æ–­æ˜¯å¦ä¸ºNonpointer_isa ã€ç¬¬äºŒæ­¥ã€‘æ“ä½œå¼•ç”¨è®¡æ•° 1.å¦‚æœä¸æ˜¯Nonpointer_isaï¼Œåˆ™ç›´æ¥æ“ä½œSideTablesæ•£åˆ—è¡¨ï¼Œæ­¤æ—¶çš„æ•£åˆ—è¡¨å¹¶ä¸æ˜¯åªæœ‰ä¸€å¼ ï¼Œè€Œæ˜¯æœ‰å¾ˆå¤šå¼  2.åˆ¤æ–­æ˜¯å¦æ­£åœ¨é‡Šæ”¾ï¼Œå¦‚æœæ­£åœ¨é‡Šæ”¾ï¼Œåˆ™æ‰§è¡Œdeallocæµç¨‹ 3.æ‰§è¡Œextra_rc+1ï¼Œå³å¼•ç”¨è®¡æ•°+1æ“ä½œï¼Œå¹¶ç»™ä¸€ä¸ªå¼•ç”¨è®¡æ•°çš„çŠ¶æ€æ ‡è¯†carryï¼Œç”¨äºè¡¨ç¤ºextra_rcæ˜¯å¦æ»¡äº† 4.å¦‚æœcarrayçš„çŠ¶æ€è¡¨ç¤ºextra_rcçš„å¼•ç”¨è®¡æ•°æ»¡äº†ï¼Œæ­¤æ—¶éœ€è¦æ“ä½œæ•£åˆ—è¡¨ï¼Œå°†æ»¡çŠ¶æ€çš„ä¸€åŠæ‹¿å‡ºæ¥å­˜åˆ°extra_rcï¼Œå¦ä¸€åŠå­˜åœ¨ æ•£åˆ—è¡¨çš„rc_halfã€‚è¿™ä¹ˆåšçš„åŸå› æ˜¯å› ä¸ºå¦‚æœéƒ½å­˜å‚¨åœ¨æ•£åˆ—è¡¨ï¼Œæ¯æ¬¡å¯¹æ•£åˆ—è¡¨æ“ä½œéƒ½éœ€è¦å¼€è§£é”ï¼Œæ“ä½œè€—æ—¶ï¼Œæ¶ˆè€—æ€§èƒ½å¤§ï¼Œè¿™ä¹ˆå¯¹åŠåˆ†æ“ä½œçš„ç›®çš„åœ¨äºæé«˜æ€§èƒ½ æ€»ç»“ï¼šretain å®Œæ•´å›ç­” retainåœ¨åº•å±‚é¦–å…ˆä¼šåˆ¤æ–­æ˜¯å¦æ˜¯ Nonpointer isaï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™ç›´æ¥æ“ä½œæ•£åˆ—è¡¨ è¿›è¡Œ+1æ“ä½œ å¦‚æœæ˜¯Nonpointer isaï¼Œè¿˜éœ€è¦åˆ¤æ–­æ˜¯å¦æ­£åœ¨é‡Šæ”¾ï¼Œå¦‚æœæ­£åœ¨é‡Šæ”¾ï¼Œåˆ™æ‰§è¡Œdeallocæµç¨‹ï¼Œé‡Šæ”¾å¼±å¼•ç”¨è¡¨å’Œå¼•ç”¨æŠ€æœ¯è¡¨ï¼Œæœ€åfreeé‡Šæ”¾å¯¹è±¡å†…å­˜ å¦‚æœä¸æ˜¯æ­£åœ¨é‡Šæ”¾ï¼Œåˆ™å¯¹Nonpointer isaè¿›è¡Œå¸¸è§„çš„å¼•ç”¨è®¡æ•°+1.è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹çš„æ˜¯ï¼Œextra_rcåœ¨çœŸæœºä¸Šåªæœ‰8ä½ç”¨äºå­˜å‚¨å¼•ç”¨è®¡æ•°çš„å€¼ï¼Œå½“å­˜å‚¨æ»¡äº†æ—¶ï¼Œéœ€è¦å€ŸåŠ©æ•£åˆ—è¡¨ç”¨äºå­˜å‚¨ã€‚éœ€è¦å°†æ»¡äº†çš„extra_rcå¯¹åŠåˆ†ï¼Œä¸€åŠï¼ˆå³2^7ï¼‰å­˜å‚¨åœ¨æ•£åˆ—è¡¨ä¸­ã€‚å¦ä¸€åŠè¿˜æ˜¯å­˜å‚¨åœ¨extra_rcä¸­ï¼Œç”¨äºå¸¸è§„çš„å¼•ç”¨è®¡æ•°çš„+1æˆ–è€…-1æ“ä½œï¼Œç„¶åå†è¿”å› 5.3 releaseé€šè¿‡setProperty -&gt; reallySetProperty -&gt; objc_release -&gt; release -&gt; rootRelease -&gt; rootReleaseé¡ºåºï¼Œè¿›å…¥rootReleaseæºç : 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134objc_object::rootRelease(bool performDealloc, bool handleUnderflow){ // åˆ¤æ–­æ˜¯å¦æ˜¯TaggedPointer if (isTaggedPointer()) return false; bool sideTableLocked = false; isa_t oldisa; isa_t newisa; retry: do { oldisa = LoadExclusive(&amp;isa.bits); newisa = oldisa; // åˆ¤æ–­æ˜¯å¦æ˜¯Nonpointer isa if (slowpath(!newisa.nonpointer)) { // å¦‚æœä¸æ˜¯ï¼Œåˆ™ç›´æ¥æ“ä½œæ•£åˆ—è¡¨-1 ClearExclusive(&amp;isa.bits); if (sideTableLocked) sidetable_unlock(); return sidetable_release(performDealloc); } // å¦‚æœæ˜¯NONPOINTER_ISA // don't check newisa.fast_rr; we already called any RR overrides uintptr_t carry; // isaçš„bitsçš„extra_rcå‡1 newisa.bits = subc(newisa.bits, RC_ONE, 0, &amp;carry); // extra_rc-- // å¦‚æœæ­¤æ—¶extra_rcçš„å€¼ä¸º0äº†ï¼Œåˆ™èµ°åˆ°underflow if (slowpath(carry)) { // don't ClearExclusive() goto underflow; } } while (slowpath(!StoreReleaseExclusive(&amp;isa.bits, oldisa.bits, newisa.bits))); if (slowpath(sideTableLocked)) sidetable_unlock(); return false; underflow: // newisa.extra_rc-- underflowed: borrow from side table or deallocate // abandon newisa to undo the decrement newisa = oldisa; //åˆ¤æ–­isaæ˜¯å¦æœ‰è¾…åŠ©çš„å¼•ç”¨è®¡æ•°æ•£åˆ—è¡¨ if (slowpath(newisa.has_sidetable_rc)) { if (!handleUnderflow) { ClearExclusive(&amp;isa.bits); return rootRelease_underflow(performDealloc); } // Transfer retain count from side table to inline storage. if (!sideTableLocked) { ClearExclusive(&amp;isa.bits); sidetable_lock(); sideTableLocked = true; // Need to start over to avoid a race against // the nonpointer -&gt; raw pointer transition. goto retry; } // Try to remove some retain counts from the side table. //ä»æ•£åˆ—è¡¨ä¸­å–å‡ºå­˜å‚¨çš„ä¸€åŠå¼•ç”¨è®¡æ•° size_t borrowed = sidetable_subExtraRC_nolock(RC_HALF); // To avoid races, has_sidetable_rc must remain set // even if the side table count is now zero. if (borrowed &gt; 0) { // Side table retain count decreased. // Try to add them to the inline count. //è¿›è¡Œ-1æ“ä½œï¼Œç„¶åå­˜å‚¨åˆ°extra_rcä¸­ newisa.extra_rc = borrowed - 1; // redo the original decrement too bool stored = StoreReleaseExclusive(&amp;isa.bits, oldisa.bits, newisa.bits); if (!stored) { // Inline update failed. // Try it again right now. This prevents livelock on LL/SC // architectures where the side table access itself may have // dropped the reservation. isa_t oldisa2 = LoadExclusive(&amp;isa.bits); isa_t newisa2 = oldisa2; if (newisa2.nonpointer) { uintptr_t overflow; newisa2.bits = addc(newisa2.bits, RC_ONE * (borrowed-1), 0, &amp;overflow); if (!overflow) { stored = StoreReleaseExclusive(&amp;isa.bits, oldisa2.bits, newisa2.bits); } } } if (!stored) { // Inline update failed. // Put the retains back in the side table. sidetable_addExtraRC_nolock(borrowed); goto retry; } // Decrement successful after borrowing from side table. // This decrement cannot be the deallocating decrement - the side // table lock and has_sidetable_rc bit ensure that if everyone // else tried to -release while we worked, the last one would block. sidetable_unlock(); return false; } else { // Side table is empty after all. Fall-through to the dealloc path. } } //æ­¤æ—¶extra_rcä¸­å€¼ä¸º0ï¼Œæ•£åˆ—è¡¨ä¸­ä¹Ÿæ˜¯ç©ºçš„ï¼Œåˆ™ç›´æ¥è¿›è¡Œææ„ï¼Œå³è‡ªåŠ¨è§¦å‘deallocæµç¨‹ // Really deallocate. //è§¦å‘deallocçš„æ—¶æœº if (slowpath(newisa.deallocating)) { ClearExclusive(&amp;isa.bits); if (sideTableLocked) sidetable_unlock(); return overrelease_error(); // does not actually return } newisa.deallocating = true; if (!StoreExclusive(&amp;isa.bits, oldisa.bits, newisa.bits)) goto retry; if (slowpath(sideTableLocked)) sidetable_unlock(); __sync_synchronize(); if (performDealloc) { //å‘é€ä¸€ä¸ªdeallocæ¶ˆæ¯ ((void(*)(objc_object *, SEL))objc_msgSend)(this, SEL_dealloc); } return true;} ã€ç¬¬ä¸€æ­¥ã€‘åˆ¤æ–­æ˜¯å¦æ˜¯Nonpointer isaï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™ç›´æ¥å¯¹æ•£åˆ—è¡¨è¿›è¡Œ-1æ“ä½œ ã€ç¬¬äºŒæ­¥ã€‘å¦‚æœæ˜¯Nonpointer isaï¼Œåˆ™å¯¹extra_rcä¸­çš„å¼•ç”¨è®¡æ•°å€¼è¿›è¡Œ-1æ“ä½œï¼Œå¹¶å­˜å‚¨æ­¤æ—¶çš„extra_rcçŠ¶æ€åˆ°carryä¸­ å¦‚æœæ­¤æ—¶çš„çŠ¶æ€carrayä¸º0ï¼Œåˆ™èµ°åˆ°underflowæµç¨‹ underflowæµç¨‹æœ‰ä»¥ä¸‹å‡ æ­¥ï¼š åˆ¤æ–­æ•£åˆ—è¡¨ä¸­æ˜¯å¦å­˜å‚¨äº†ä¸€åŠçš„å¼•ç”¨è®¡æ•° å¦‚æœæ˜¯ï¼Œåˆ™ä»æ•£åˆ—è¡¨ä¸­å–å‡ºå­˜å‚¨çš„ä¸€åŠå¼•ç”¨è®¡æ•°ï¼Œè¿›è¡Œ-1æ“ä½œï¼Œç„¶åå­˜å‚¨åˆ°extra_rcä¸­ å¦‚æœæ­¤æ—¶extra_rcæ²¡æœ‰å€¼ï¼Œæ•£åˆ—è¡¨ä¸­ä¹Ÿæ˜¯ç©ºçš„ï¼Œåˆ™ç›´æ¥è¿›è¡Œææ„ï¼Œå³deallocæ“ä½œï¼Œå±äºè‡ªåŠ¨è§¦å‘ 5.4 retainCountå‰é¢è¯´äº†è¿™ä¹ˆå¤šå¼•ç”¨è®¡æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹çœ‹retainCountå’Œå¼•ç”¨è®¡æ•°æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ 12NSObject *objc = [[NSObject alloc] init];NSLog(@&quot;%ld&quot;, CFGetRetainCount((__bridge CFTypeRef)objc)); ä¸Šè¿°ä»£ç ä¼šè¾“å‡º1ï¼Œç„¶è€Œåœ¨allocæµç¨‹ä¸­å¹¶æ²¡æœ‰çœ‹åˆ°ä»»ä½•ä¸retainCountç›¸å…³çš„å†…å®¹ï¼Œè¿™åˆæ˜¯æ€ä¹ˆä¸€å›äº‹å‘¢ï¼Ÿæ¥ä¸‹æ¥å°±æ¥çœ‹çœ‹retainCountçš„åº•å±‚å®ç° retainCount-&gt;rootRetainCount 12345678910111213141516171819objc_object::rootRetainCount(){ if (isTaggedPointer()) return (uintptr_t)this; sidetable_lock(); isa_t bits = LoadExclusive(&amp;isa.bits); ClearExclusive(&amp;isa.bits); if (bits.nonpointer) { uintptr_t rc = 1 + bits.extra_rc; // è¿™é‡Œå°±æ˜¯1+0=1 if (bits.has_sidetable_rc) { rc += sidetable_getExtraRC_nolock(); } sidetable_unlock(); return rc; } sidetable_unlock(); return sidetable_retainCount();} å…ˆåˆ¤æ–­æ˜¯å¦ä¸ºisTaggedPointer å†åˆ¤æ–­æ˜¯å¦ä¸º nonpointerï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå½“å‰å¼•ç”¨è®¡æ•°=1+extrac_rc è¿™è¡Œä»£ç å°±èƒ½è¯´æ˜allocå‡ºæ¥çš„å¯¹è±¡å¼•ç”¨è®¡æ•°ä¸º0ï¼Œæ˜¯è‹¹æœäººå‘˜ä¸ºäº†ä¸ç»™å¼€å‘äººå‘˜é€ æˆå¼•ç”¨è®¡æ•°ä¸º0æ—¶å°±é”€æ¯é€ æˆé”™è§‰æ‰é»˜è®¤åŠ ä¸€ æ¥ç€åˆ¤æ–­ has_sidetable_rc æ˜¯å¦æœ‰é¢å¤–çš„æ•£åˆ—è¡¨ æœ‰çš„è¯å¼•ç”¨è®¡æ•°å†åŠ ä¸Šå¼•ç”¨è®¡æ•°è¡¨ä¸­çš„æ•°é‡ æ‰€ä»¥å¼•ç”¨è®¡æ•°=1 + extrac_rc + sidetable_getExtraRC_nolock 5.5 deallocç¬¬3å°èŠ‚å·²ç»æåˆ°äº†deallocâ€”â€”åœ¨releaseåº•å±‚ä¼šåˆ¤æ–­å½“å‰extra_rcå’Œå¼•ç”¨è®¡æ•°è¡¨æ˜¯å¦éƒ½ä¸º0ï¼Œå¦‚æœæ»¡è¶³æ¡ä»¶å°±ä¼šé€šè¿‡æ¶ˆæ¯å‘é€è°ƒç”¨dealloc è¿›å…¥ dealloc -&gt; _objc_rootDealloc -&gt; rootDeallocï¼š 12345678910111213141516171819202122232425262728inline voidobjc_object::rootDealloc(){ // âœ…å¦‚æœæ˜¯Tagged Pointerï¼Œå°±ç›´æ¥è¿”å› if (isTaggedPointer()) return; // fixme necessary? /* âœ…å¦‚æœåŒæ—¶æ»¡è¶³ 1. æ˜¯ä¼˜åŒ–è¿‡çš„isaã€ 2. æ²¡æœ‰è¢«weakæŒ‡é’ˆå¼•ç”¨è¿‡ã€ 3. æ²¡æœ‰å…³è”å¯¹è±¡ã€ 4. æ²¡æœ‰C++ææ„å‡½æ•°ã€ 5. æ²¡æœ‰sideTableå¼•ç”¨è®¡æ•° å°±å¯ä»¥ç›´æ¥é‡Šæ”¾å†…å­˜free() */ if (fastpath(isa.nonpointer &amp;&amp; !isa.weakly_referenced &amp;&amp; !isa.has_assoc &amp;&amp; !isa.has_cxx_dtor &amp;&amp; !isa.has_sidetable_rc)) { assert(!sidetable_present()); free(this); } else { //å¦åˆ™çš„è¯å°±éœ€è¦é€šè¿‡ä¸‹é¢çš„å‡½æ•°å¤„ç† object_dispose((id)this); }} é¦–å…ˆåˆ¤æ–­å¯¹è±¡æ˜¯å¦æ˜¯Tagged Pointerï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥è¿”å›ã€‚ å¦‚æœå¯¹è±¡æ˜¯é‡‡ç”¨äº†ä¼˜åŒ–çš„isaè®¡æ•°æ–¹å¼ï¼Œä¸”åŒæ—¶æ»¡è¶³ï¼šå¯¹è±¡æ²¡æœ‰è¢«weakå¼•ç”¨!isa.weakly_referencedã€æ²¡æœ‰å…³è”å¯¹è±¡!isa.has_assocã€æ²¡æœ‰è‡ªå®šä¹‰çš„C++ææ„æ–¹æ³•!isa.has_cxx_dtorã€æ²¡æœ‰ç”¨åˆ°SideTableæ¥å¼•ç”¨è®¡æ•°!isa.has_sidetable_rcï¼Œåˆ™ç›´æ¥å¿«é€Ÿé‡Šæ”¾ã€‚ å¦‚æœä¸èƒ½æ»¡è¶³ä¸Šé¢çš„æ¡ä»¶ï¼Œåˆ™ä¼šè°ƒç”¨object_disposeæ–¹æ³•ã€‚ object_dispose -&gt; objc_destructInstanceï¼š 123456789101112131415161718void *objc_destructInstance(id obj) { if (obj) { // Read all of the flags at once for performance. bool cxx = obj-&gt;hasCxxDtor(); bool assoc = obj-&gt;hasAssociatedObjects(); // This order is important. // å¦‚æœæœ‰C++ææ„å‡½æ•°ï¼Œåˆ™è¿è¡Œç›¸å…³å‡½æ•° if (cxx) object_cxxDestruct(obj); // å¦‚æœæœ‰å…³è”å¯¹è±¡ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„å…³è”å¯¹è±¡ï¼Œå¹¶å°†å…¶è‡ªèº«ä»Association Managerçš„mapä¸­ç§»é™¤ if (assoc) _object_remove_assocations(obj); // æ¸…é™¤å¯¹è±¡çš„ç›¸å…³å¼•ç”¨ obj-&gt;clearDeallocating(); } return obj;} å¦‚æœæœ‰è‡ªå®šä¹‰çš„C++ææ„æ–¹æ³•ï¼Œåˆ™è°ƒç”¨C++ææ„å‡½æ•°ã€‚å¦‚æœæœ‰å…³è”å¯¹è±¡ï¼Œåˆ™ç§»é™¤å…³è”å¯¹è±¡å¹¶å°†å…¶è‡ªèº«ä»AssociationManagerçš„mapä¸­ç§»é™¤ã€‚è°ƒç”¨clearDeallocatingæ–¹æ³•æ¸…é™¤å¯¹è±¡çš„ç›¸å…³å¼•ç”¨ã€‚ clearDeallocating: 12345678910111213141516inline void objc_object::clearDeallocating(){ if (slowpath(!isa.nonpointer)) { // Slow path for raw pointer isa. // å¦‚æœè¦é‡Šæ”¾çš„å¯¹è±¡æ²¡æœ‰é‡‡ç”¨äº†ä¼˜åŒ–è¿‡çš„isaå¼•ç”¨è®¡æ•°ï¼Œåˆ™æ¸…ç†å¯¹è±¡å­˜å‚¨åœ¨SideTableä¸­çš„å¼•ç”¨è®¡æ•° sidetable_clearDeallocating(); } else if (slowpath(isa.weakly_referenced || isa.has_sidetable_rc)) { // Slow path for non-pointer isa with weak refs and/or side table data. // âœ… å¦‚æœè¦é‡Šæ”¾çš„å¯¹è±¡é‡‡ç”¨äº†ä¼˜åŒ–è¿‡çš„isaå¼•ç”¨è®¡æ•°ï¼Œå¹¶ä¸”æœ‰å¼±å¼•ç”¨æˆ–è€…ä½¿ç”¨äº†sideTableçš„è¾…åŠ©å¼•ç”¨è®¡æ•°ï¼ˆç°åœ¨ä¸€èˆ¬éƒ½æ˜¯ä¼˜åŒ–è¿‡çš„ isaï¼‰ clearDeallocating_slow(); } assert(!sidetable_present());} åˆ¤æ–­å¯¹è±¡æ˜¯å¦é‡‡ç”¨äº†ä¼˜åŒ–isaå¼•ç”¨è®¡æ•°ï¼Œå¦‚æœæ²¡æœ‰çš„è¯åˆ™éœ€è¦æ¸…ç†å¯¹è±¡å­˜å‚¨åœ¨SideTableä¸­çš„å¼•ç”¨è®¡æ•°æ•°æ®ã€‚ å¦‚æœå¯¹è±¡é‡‡ç”¨äº†ä¼˜åŒ–isaå¼•ç”¨è®¡æ•°ï¼Œåˆ™åˆ¤æ–­æ˜¯éƒ½æœ‰ä½¿ç”¨SideTableçš„è¾…åŠ©å¼•ç”¨è®¡æ•°(isa.has_sidetable_rc)æˆ–è€…æœ‰weakå¼•ç”¨(isa.weakly_referenced)ï¼Œç¬¦åˆè¿™ä¸¤ç§æƒ…å†µä¸­ä¸€ç§çš„ï¼Œè°ƒç”¨clearDeallocating_slowæ–¹æ³•ã€‚ clearDeallocating_slow: 123456789101112131415161718NEVER_INLINE voidobjc_object::clearDeallocating_slow(){ assert(isa.nonpointer &amp;&amp; (isa.weakly_referenced || isa.has_sidetable_rc)); // åœ¨å…¨å±€çš„SideTablesä¸­ï¼Œä»¥thisæŒ‡é’ˆ(è¦é‡Šæ”¾çš„å¯¹è±¡)ä¸ºkeyï¼Œæ‰¾åˆ°å¯¹åº”çš„SideTable SideTable&amp; table = SideTables()[this]; table.lock(); if (isa.weakly_referenced) { // âœ… è¦é‡Šæ”¾çš„å¯¹è±¡è¢«å¼±å¼•ç”¨äº†ï¼Œé€šè¿‡weak_clear_no_lockå‡½æ•°å°†æŒ‡å‘è¯¥å¯¹è±¡çš„å¼±å¼•ç”¨æŒ‡é’ˆç½®ä¸ºnil weak_clear_no_lock(&amp;table.weak_table, (id)this); } // ä½¿ç”¨äº†sideTableçš„è¾…åŠ©å¼•ç”¨è®¡æ•°,ç›´æ¥åœ¨SideTableä¸­æ“¦é™¤è¯¥å¯¹è±¡çš„å¼•ç”¨è®¡æ•° if (isa.has_sidetable_rc) { table.refcnts.erase(this); } table.unlock();} å¦‚æœå¯¹è±¡è¢«å¼±å¼•ç”¨ï¼Œåˆ™è°ƒç”¨weak_clear_no_lockå‡½æ•°å°†æŒ‡å‘è¯¥å¯¹è±¡çš„å¼±å¼•ç”¨æŒ‡é’ˆç½®ä¸ºnil å¦‚æœé‡‡ç”¨äº†SideTableåšå¼•ç”¨è®¡æ•°ï¼Œåˆ™åœ¨ SideTableçš„å¼•ç”¨è®¡æ•°ä¸­ç§»é™¤å¯¹è±¡çš„å¼•ç”¨è®¡æ•° å…­ã€NSTimer å¾ªç¯å¼•ç”¨6.1 åŸå› ä¸€ä¸ªå¸¸å‡ºç°çš„å¾ªç¯å¼•ç”¨ï¼š 123456789101112131415161718192021222324static int num = 0;@interface TimerViewController ()@property (nonatomic, strong) NSTimer *timer;@end@implementation TimerViewController- (void)viewDidLoad { [super viewDidLoad]; self.timer = [NSTimer scheduledTimerWithTimeInterval:1 target:self selector:@selector(fireHome) userInfo:nil repeats:YES];}- (void)fireHome { num++; NSLog(@&quot;current - %d&quot;,num);}- (void)dealloc { [self.timer invalidate]; self.timer = nil; NSLog(@&quot;%s&quot;, __FUNCTION__);} è¿™æ®µä»£ç è¿è¡Œèµ·æ¥æ‰€å‘ç”Ÿçš„é—®é¢˜å°±æ˜¯å½“å‰VCpopåˆ°å‰ä¸€é¡µæ—¶ä¸ä¼šè§¦å‘deallocå‡½æ•°ï¼Œé‚£ä¹ˆå°±æ˜¯äº§ç”Ÿäº†å¾ªç¯å¼•ç”¨ã€‚ æŸ¥çœ‹è‹¹æœ API è¯´æ˜ï¼š timer ä¼šå¯¹ä»–çš„ target è¿›è¡Œå¼ºæŒæœ‰ï¼Œæ‰€ä»¥é€ æˆäº†å¦‚ä¸‹ç°è±¡ï¼š è¿™ä¸ª API è¯´æ˜åŒæ—¶æåˆ°ï¼Œåœ¨ timer ä¸ç”¨çš„æ—¶å€™éœ€è¦ invalidateã€‚ é‚£ä¹ˆèƒ½ä¸èƒ½åƒblockä¸€æ ·ä½¿ç”¨å¼±å¼•ç”¨æ¥è§£å†³å¾ªç¯å¼•ç”¨å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¸èƒ½çš„ï¼ 123// å‡è®¾æˆ‘ä»¬å°è¯•è§£å†³ï¼š__weak typeof(self) weakSelf = self;self.timer = [NSTimer scheduledTimerWithTimeInterval:1 target:weakSelf selector:@selector(fireHome) userInfo:nil repeats:YES]; ç”±äº weakSelf å’Œ self éƒ½æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ vcï¼Œæ‰€ä»¥æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªä¸œè¥¿ï¼Œåªæ˜¯æŒ‡é’ˆçš„åœ°å€ä¸ä¸€æ ·ï¼Œé‚£ä¹ˆå°±ä¼šé€ æˆï¼š ç»“æœè¿˜æ˜¯å¾ªç¯å¼•ç”¨ã€‚ é‚£ä¹ˆä¸ºä»€ä¹ˆå¯ä»¥ä½¿ç”¨__weak typeof(self) weakSelf = self;è§£å†³ block çš„å¾ªç¯å¼•ç”¨å‘¢ï¼Ÿ çœ‹blockæºç ï¼š blockæŒæœ‰çš„æ˜¯weakSelfçš„æŒ‡é’ˆåœ°å€ã€‚ timeræŒæœ‰çš„æ˜¯weakSelfçš„æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ï¼Œè¿™é‡Œé—´æ¥æŒæœ‰äº†selfï¼Œæ‰€ä»¥ä»ç„¶å­˜åœ¨å¾ªç¯å¼•ç”¨å¯¼è‡´é‡Šæ”¾ä¸æ‰ 6.2 è§£å†³æ–¹æ¡ˆæ–¹æ¡ˆä¸€ï¼šæå‰ invalidateã€æ¨èã€‘ æ—¢ç„¶deallocä¸èƒ½æ¥ï¼Œå°±åœ¨deallocå‡½æ•°è°ƒç”¨å‰è§£å†³æ‰è¿™å±‚å¼ºå¼•ç”¨ å¯ä»¥åœ¨viewWillDisappearã€viewDidDisappearä¸­å¤„ç†NSTimerï¼Œä½†è¿™æ ·å¤„ç†æ•ˆæœå¹¶ä¸å¥½ï¼Œå› ä¸ºè·³è½¬åˆ°ä¸‹ä¸€é¡µå®šæ—¶å™¨ä¹Ÿä¼šåœæ­¢å·¥ä½œï¼Œä¸ä¸šåŠ¡ä¸ç¬¦ ä½¿ç”¨didMoveToParentViewControllerå¯ä»¥å¾ˆå¥½åœ°è§£å†³è¿™å±‚å¼ºå¼•ç”¨ 1234567// è¿™ä¸ªæ–¹æ³•åœ¨å½“å‰æ§åˆ¶å™¨ push å’Œ pop çš„æ—¶å€™éƒ½ä¼šè°ƒç”¨- (void)didMoveToParentViewController:(UIViewController *)parent { if (parent == nil) { [self.timer invalidate]; self.timer = nil; }} æ–¹æ¡ˆäºŒï¼šä¸­ä»‹è€…æ¨¡å¼åŸç†ï¼š ä½¿ç”¨ä¸­ä»‹è€…è§£é™¤å¾ªç¯å¼•ç”¨ åŒæ—¶åœ¨è°ƒç”¨ proxy çš„ timerTest æ–¹æ³•æ—¶ï¼Œä½¿ç”¨æ¶ˆæ¯è½¬å‘ï¼Œè½¬å‘åˆ°è®© self å»è°ƒç”¨ä»–è‡ªå·±çš„ timerTest æ–¹æ³•ï¼Œä¿è¯äº†åŠŸèƒ½çš„æ­£å¸¸å®ç°ã€‚ JYProxy.h 123456@interface JYProxy : NSObject + (instancetype)proxyWithTarget:(id)target;@property (weak, nonatomic) id target;@end JYProxy.m 123456789101112131415161718#import &quot;JYProxy.h&quot;@implementation JYProxy+ (instancetype)proxyWithTarget:(id)target{ JYProxy *proxy = [[JYProxy alloc] init]; proxy.target = target; return proxy;}// æ¶ˆæ¯è½¬å‘ï¼Œå³è®©è°å»è°ƒç”¨æ–¹æ³•- (id)forwardingTargetForSelector:(SEL)aSelector{ return self.target;}@end ViewController.m 1234567891011121314151617181920212223242526#import &quot;JYProxy.h&quot;@interface ViewController ()@property (strong, nonatomic) NSTimer *timer;@end@implementation ViewController- (void)viewDidLoad { [super viewDidLoad]; self.timer = [NSTimer scheduledTimerWithTimeInterval:1.0 target:[JYProxy proxyWithTarget:self] selector:@selector(timerTest) userInfo:nil repeats:YES];}- (void)timerTest{ NSLog(@&quot;%s&quot;, __func__);}- (void)dealloc{ NSLog(@&quot;%s&quot;, __func__); [self.timer invalidate];}@end è¿è¡Œï¼Œtimer åŠŸèƒ½ä¸€åˆ‡æ­£å¸¸ï¼Œå¹¶ä¸”æ²¡æœ‰å¾ªç¯å¼•ç”¨ã€‚ æ–¹æ¡ˆä¸‰ï¼šä½¿ç”¨ NSProxyã€æ¨èã€‘åŸç†è·Ÿä¸­ä»‹è€…æ¨¡å¼ä¸€æ ·ï¼Œåªä¸è¿‡è¿™ä¸ª NSProxy ç±»æ›´ä¸“ä¸šï¼Œåªç”¨æ¥åšä¸­ä»‹ï¼Œæ•ˆç‡æ›´é«˜ã€‚ ä¸Šä¸€èŠ‚æåˆ°çš„ä¸­ä»‹è€…åªæ˜¯ä¸€ä¸ªæ™®é€šçš„ NSObjectï¼Œè°ƒç”¨ä»–çš„ timerTest æ–¹æ³•æ—¶ä¼šèµ°æ­£å¸¸çš„æ¶ˆæ¯å‘é€æµç¨‹ï¼ŒåŒ…æ‹¬ç¼“å­˜æŸ¥æ‰¾ã€éå†çˆ¶ç±»è¿›è¡ŒæŸ¥æ‰¾ã€æ¶ˆæ¯è½¬å‘ç­‰ï¼Œæµç¨‹å¤šã€‚ NSProxy åªç”¨æ¥åšæ¶ˆæ¯è½¬å‘ï¼Œæ²¡æœ‰å¤æ‚çš„æµç¨‹ï¼Œæ•ˆç‡é«˜ï¼Œåšä¸­ä»‹è€…å°±æ‰¾ä»– MJProxy.h 123456@interface MJProxy : NSProxy + (instancetype)proxyWithTarget:(id)target;@property (weak, nonatomic) id target;@end MJProxy.m 12345678910111213141516171819202122232425#import &quot;MJProxy.h&quot;@implementation MJProxy+ (instancetype)proxyWithTarget:(id)target{ // NSProxyå¯¹è±¡ä¸éœ€è¦è°ƒç”¨initï¼Œå› ä¸ºå®ƒæœ¬æ¥å°±æ²¡æœ‰initæ–¹æ³• MJProxy *proxy = [MJProxy alloc]; proxy.target = target; return proxy;}// è·Ÿ NSObject åšæ¶ˆæ¯è½¬å‘è¦å®ç°ä¸€ä¸ªæ–¹æ³•ä¸åŒï¼Œè¿™é‡Œè¦å®ç°ä¸‹é¢è¿™ä¸¤ä¸ªæ–¹æ³•// è¿”å›æ–¹æ³•ç­¾å- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel{ return [self.target methodSignatureForSelector:sel];}// æ¶ˆæ¯è½¬å‘ï¼Œå³è®©è°å»è°ƒç”¨æ–¹æ³•- (void)forwardInvocation:(NSInvocation *)invocation{ [invocation invokeWithTarget:self.target];}@end ViewController.m 1234567891011121314151617181920212223242526#import &quot;MJProxy1.h&quot;@interface ViewController ()@property (strong, nonatomic) NSTimer *timer;@end@implementation ViewController- (void)viewDidLoad { [super viewDidLoad]; self.timer = [NSTimer scheduledTimerWithTimeInterval:1.0 target:[MJProxy proxyWithTarget:self] selector:@selector(timerTest) userInfo:nil repeats:YES];}- (void)timerTest{ NSLog(@&quot;%s&quot;, __func__);}- (void)dealloc{ NSLog(@&quot;%s&quot;, __func__); [self.timer invalidate];}@end è¿è¡Œï¼Œä¸€åˆ‡æ­£å¸¸ã€‚ PSæˆ‘çš„objc4-756.2æºç  å‚è€ƒæ·±å…¥ç†è§£Tagged Pointer iOSå†…å­˜ç®¡ç†ä¸€ï¼šTagged Pointer&amp;å¼•ç”¨è®¡æ•° iOS-åº•å±‚åŸç† 33ï¼šå†…å­˜ç®¡ç†ï¼ˆä¸€ï¼‰ iOSæ¢ç´¢ å†…å­˜ç®¡ç†ç¯‡","link":"/2021/07/17/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/23-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"},{"title":"24-AutoReleasePool &amp; NSRunLoop","text":"ä¸€ã€AutoReleasePoolè‡ªåŠ¨é‡Šæ”¾æ± æ˜¯OCä¸­çš„ä¸€ç§å†…å­˜è‡ªåŠ¨å›æ”¶æœºåˆ¶ï¼Œå®ƒå¯ä»¥å°†åŠ å…¥AutoreleasePoolä¸­çš„å˜é‡releaseçš„æ—¶æœºå»¶è¿Ÿï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯å½“åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œå˜é‡ä¼šåœ¨è¶…å‡ºå…¶ä½œç”¨åŸŸçš„æ—¶ç«‹å³releaseã€‚å¦‚æœå°†å¯¹è±¡åŠ å…¥åˆ°äº†è‡ªåŠ¨é‡Šæ”¾æ± ä¸­ï¼Œè¿™ä¸ªå¯¹è±¡å¹¶ä¸ä¼šç«‹å³é‡Šæ”¾ï¼Œä¼šç­‰åˆ°runloopä¼‘çœ /è¶…å‡ºautoreleasepoolä½œç”¨åŸŸ{}ä¹‹åæ‰ä¼šè¢«é‡Šæ”¾ã€‚å…¶æœºåˆ¶å¦‚ä¸‹å›¾æ‰€ç¤º 1ã€ä»ç¨‹åºå¯åŠ¨åˆ°åŠ è½½å®Œæˆï¼Œä¸»çº¿ç¨‹å¯¹åº”çš„runloopä¼šå¤„äºä¼‘çœ çŠ¶æ€ï¼Œç­‰å¾…ç”¨æˆ·äº¤äº’æ¥å”¤é†’runloop 2ã€ç”¨æˆ·çš„æ¯ä¸€æ¬¡äº¤äº’éƒ½ä¼šå¯åŠ¨ä¸€æ¬¡runloopï¼Œç”¨äºå¤„ç†ç”¨æˆ·çš„æ‰€æœ‰ç‚¹å‡»ã€è§¦æ‘¸äº‹ä»¶ç­‰ 3ã€runloopåœ¨ç›‘å¬åˆ°äº¤äº’äº‹ä»¶åï¼Œå°±ä¼šåˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œå¹¶å°†æ‰€æœ‰å»¶è¿Ÿé‡Šæ”¾çš„å¯¹è±¡æ·»åŠ åˆ°è‡ªåŠ¨é‡Šæ”¾æ± ä¸­ 4ã€åœ¨ä¸€æ¬¡å®Œæ•´çš„runloopç»“æŸä¹‹å‰ï¼Œä¼šå‘è‡ªåŠ¨é‡Šæ”¾æ± ä¸­æ‰€æœ‰å¯¹è±¡å‘é€releaseæ¶ˆæ¯ï¼Œç„¶åé”€æ¯è‡ªåŠ¨é‡Šæ”¾æ±  Clangåˆ†æ é€šè¿‡clangå‘½ä»¤å¯¹ç©ºç™½çš„main.mè¾“å‡ºä¸€ä»½main.cppæ–‡ä»¶æ¥æŸ¥çœ‹@autoreleasepoolçš„åº•å±‚ç»“æ„ å®šä¹‰å¦‚ä¸‹ä»£ç  1234int main(int argc, const char * argv[]) { @autoreleasepool { }} é€šè¿‡clangç¼–è¯‘æˆåº•å±‚å®ç°ï¼Œå‘½ä»¤ä¸ºï¼šxcrun -sdk iphonesimulator clang -arch x86_64 -rewrite-objc main.m 12345678910111213141516171819struct __AtAutoreleasePool { //æ„é€ å‡½æ•° __AtAutoreleasePool() { atautoreleasepoolobj = objc_autoreleasePoolPush(); } //ææ„å‡½æ•° ~__AtAutoreleasePool() { objc_autoreleasePoolPop(atautoreleasepoolobj); } void * atautoreleasepoolobj;};int main(int argc, const char * argv[]) { { //æ˜¯ä¸€ä¸ªç»“æ„ä½“ __AtAutoreleasePool __autoreleasepool; } return 0;} ç®€å•æ¥è¯´ï¼Œè‡ªåŠ¨é‡Šæ”¾æ± å…¶æœ¬è´¨ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ 12345@autoreleasepool { }//ç­‰ä»·äº{__AtAutoreleasePool __autoreleasepool; } __AtAutoreleasePoolæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œæœ‰æ„é€ å‡½æ•° + ææ„å‡½æ•°ï¼Œç»“æ„ä½“å®šä¹‰çš„å¯¹è±¡åœ¨ä½œç”¨åŸŸç»“æŸåï¼Œä¼šè‡ªåŠ¨è°ƒç”¨ææ„å‡½æ•° å…¶ä¸­{} æ˜¯ ä½œç”¨åŸŸ ï¼Œä¼˜ç‚¹æ˜¯ç»“æ„æ¸…æ™°ï¼Œå¯è¯»æ€§å¼ºï¼Œå¯ä»¥åŠæ—¶åˆ›å»ºé”€æ¯ å…³äºæ¶‰åŠçš„æ„é€ å’Œææ„å‡½æ•°çš„è°ƒç”¨æ—¶æœºï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢ä¸€ä¸ªæ¡ˆä¾‹æ¥éªŒè¯ 123456789101112131415161718struct CJLTest{ CJLTest(){ printf(&quot;åˆ›å»º - %s\\n&quot;, __func__); } ~CJLTest(){ printf(&quot;é”€æ¯ - %s\\n&quot;, __func__); }};int main(int argc, const char * argv[]) { { CJLTest test; }}//**********è¿è¡Œç»“æœ**********åˆ›å»º - CJLTesté”€æ¯ - ~CJLTest ä»è€Œå¯ä»¥å¾—å‡ºï¼Œåœ¨CJLTeståˆ›å»ºå¯¹è±¡æ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨æ„é€ å‡½æ•°ï¼Œåœ¨å‡ºäº†{}ä½œç”¨åŸŸåï¼Œä¼šè‡ªåŠ¨è°ƒç”¨ææ„å‡½æ•° æ±‡ç¼–åˆ†æ 123456int main(int argc, char * argv[]) { @autoreleasepool { NSObject *obj = [NSObject alloc]; } return 0;} åœ¨mainä»£ç éƒ¨åˆ†åŠ æ–­ç‚¹ï¼Œè¿è¡Œç¨‹åºï¼Œå¹¶å¼€å¯æ±‡ç¼–è°ƒè¯• å‘ç°ï¼š autoreleasepoolåœ¨åŠ å…¥è¦é‡Šæ”¾çš„å¯¹è±¡æ—¶ï¼Œåº•å±‚è°ƒç”¨çš„æ˜¯objc_autoreleasePoolPushæ–¹æ³• autoreleasepoolåœ¨è°ƒç”¨ææ„å‡½æ•°é‡Šæ”¾æ—¶ï¼Œåº•å±‚è°ƒç”¨objc_autoreleasePoolPopæ–¹æ³• 1.1 æºç åˆ†ææˆ‘çš„autoreleaseæºç  åœ¨objcæºç ä¸­ï¼Œå¯¹AutoreleasePoolçš„è§£é‡Šå¦‚ä¸‹ 12345678910111213141516Autorelease pool implementation- A thread's autorelease pool is a stack of pointers. çº¿ç¨‹çš„è‡ªåŠ¨é‡Šæ”¾æ± æ˜¯æŒ‡é’ˆçš„å †æ ˆ- Each pointer is either an object to release, or POOL_BOUNDARY which is an autorelease pool boundary.æ¯ä¸ªæŒ‡é’ˆéƒ½æ˜¯è¦é‡Šæ”¾çš„å¯¹è±¡ï¼Œæˆ–è€…æ˜¯POOL_BOUNDARYï¼Œå®ƒæ˜¯è‡ªåŠ¨é‡Šæ”¾æ± çš„è¾¹ç•Œã€‚- A pool token is a pointer to the POOL_BOUNDARY for that pool. When the pool is popped, every object hotter than the sentinel is released.æ± ä»¤ç‰Œæ˜¯æŒ‡å‘è¯¥æ± çš„POOL_BOUNDARYçš„æŒ‡é’ˆã€‚å¼¹å‡ºæ± åï¼Œå°†é‡Šæ”¾æ¯”å“¨ç‚¹æ›´çƒ­çš„æ¯ä¸ªå¯¹è±¡ã€‚- The stack is divided into a doubly-linked list of pages. Pages are added and deleted as necessary. å †æ ˆåˆ†ä¸ºä¸¤ä¸ªåŒå‘é“¾æ¥çš„é¡µé¢åˆ—è¡¨ã€‚æ ¹æ®éœ€è¦æ·»åŠ å’Œåˆ é™¤é¡µé¢ã€‚- Thread-local storage points to the hot page, where newly autoreleased objects are stored. çº¿ç¨‹æœ¬åœ°å­˜å‚¨æŒ‡å‘çƒ­é¡µé¢ï¼Œè¯¥é¡µé¢å­˜å‚¨æ–°è‡ªåŠ¨é‡Šæ”¾çš„å¯¹è±¡ã€‚ é€šè¿‡æè¿°ï¼Œæœ‰ä»¥ä¸‹å‡ ç‚¹è¯´æ˜ 1ã€è‡ªåŠ¨é‡Šæ”¾æ±  æ˜¯ä¸€ä¸ª å…³äºæŒ‡é’ˆçš„æ ˆç»“æ„ 2ã€å…¶ä¸­çš„æŒ‡é’ˆæ˜¯æŒ‡è¦é‡Šæ”¾çš„å¯¹è±¡æˆ–è€… pool_boundary å“¨å…µï¼ˆç°åœ¨ç»å¸¸è¢«ç§°ä¸º è¾¹ç•Œï¼‰ 3ã€è‡ªåŠ¨é‡Šæ”¾æ± æ˜¯ä¸€ä¸ªé¡µçš„ç»“æ„ï¼ˆè™šæ‹Ÿå†…å­˜ä¸­æåŠè¿‡ï¼‰ ï¼Œè€Œä¸”è¿™ä¸ªé¡µæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼ˆè¡¨ç¤ºæœ‰çˆ¶èŠ‚ç‚¹ å’Œ å­èŠ‚ç‚¹ï¼Œåœ¨ç±»ä¸­æåŠè¿‡ï¼Œå³ç±»çš„ç»§æ‰¿é“¾ï¼‰ 4ã€è‡ªåŠ¨é‡Šæ”¾æ± å’Œçº¿ç¨‹æœ‰å…³ç³» å¯¹äºè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œæˆ‘ä»¬ä¸»è¦å…³å¿ƒçš„ç‚¹æœ‰ä»¥ä¸‹ä¸‰ç‚¹ï¼š 1ã€è‡ªåŠ¨é‡Šæ”¾æ± ä»€ä¹ˆæ—¶å€™åˆ›å»ºï¼Ÿ 2ã€å¯¹è±¡æ˜¯å¦‚ä½•åŠ å…¥è‡ªåŠ¨é‡Šæ”¾æ± çš„ï¼Ÿ 3ã€å“ªäº›å¯¹è±¡æ‰ä¼šåŠ å…¥è‡ªåŠ¨é‡Šæ”¾æ± ï¼Ÿ ä¸‹é¢å¸¦ç€è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬æ¥ä¸€æ­¥æ­¥æ¢ç´¢è‡ªåŠ¨é‡Šæ”¾æ± çš„åº•å±‚åŸç† 1.1.1 AutoreleasePoolPageä»æœ€åˆçš„clangæˆ–è€…æ±‡ç¼–åˆ†ææˆ‘ä»¬äº†è§£äº†è‡ªåŠ¨é‡Šæ”¾æ± å…¶åº•å±‚æ˜¯è°ƒç”¨çš„objc_autoreleasePoolPushå’Œobjc_autoreleasePoolPopä¸¤ä¸ªæ–¹æ³•ï¼Œå…¶æºç å®ç°å¦‚ä¸‹ 12345678910111213//***********pushæ–¹æ³•***********void *objc_autoreleasePoolPush(void){ return AutoreleasePoolPage::push();}//***********popæ–¹æ³•***********voidobjc_autoreleasePoolPop(void *ctxt){ AutoreleasePoolPage::pop(ctxt);} ä»æºç ä¸­æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œéƒ½æ˜¯è°ƒç”¨çš„AutoreleasePoolPageçš„pushå’Œpopå®ç°ï¼Œä»¥ä¸‹æ˜¯å…¶å®šä¹‰ï¼Œä»å®šä¹‰ä¸­å¯ä»¥çœ‹å‡ºï¼Œè‡ªåŠ¨é‡Šæ”¾æ± æ˜¯ä¸€ä¸ªé¡µï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªé¡µçš„å¤§å°æ˜¯4096å­—èŠ‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137//************å®å®šä¹‰************#define PAGE_MIN_SIZE PAGE_SIZE#define PAGE_SIZE I386_PGBYTES#define I386_PGBYTES 4096 /* bytes per 80386 page *///************ç±»å®šä¹‰************class AutoreleasePoolPage : private AutoreleasePoolPageData{ friend struct thread_data_t;public: //é¡µçš„å¤§å° static size_t const SIZE =#if PROTECT_AUTORELEASEPOOL PAGE_MAX_SIZE; // must be multiple of vm page size#else PAGE_MIN_SIZE; // size and alignment, power of 2#endifprivate: ... //æ„é€ å‡½æ•° AutoreleasePoolPage(AutoreleasePoolPage *newParent) : AutoreleasePoolPageData(begin(),//å¼€å§‹å­˜å‚¨çš„ä½ç½® objc_thread_self(),//ä¼ çš„æ˜¯å½“å‰çº¿ç¨‹ï¼Œå½“å‰çº¿ç¨‹æ—¶é€šè¿‡tlsè·å–çš„ newParent, newParent ? 1+newParent-&gt;depth : 0,//å¦‚æœæ˜¯ç¬¬ä¸€é¡µæ·±åº¦ä¸º0ï¼Œå¾€åæ˜¯å‰ä¸€ä¸ªçš„æ·±åº¦+1 newParent ? newParent-&gt;hiwat : 0) {...} //ææ„å‡½æ•° ~AutoreleasePoolPage() {...} ... //é¡µçš„å¼€å§‹ä½ç½® id * begin() {...} //é¡µçš„ç»“æŸä½ç½® id * end() {...} //é¡µæ˜¯å¦ä¸ºç©º bool empty() {...} //é¡µæ˜¯å¦æ»¡äº† bool full() {...} //é¡µçš„å­˜å‚¨æ˜¯å¦å°‘äºä¸€åŠ bool lessThanHalfFull() {...} //æ·»åŠ é‡Šæ”¾å¯¹è±¡ id *add(id obj){...} //é‡Šæ”¾æ‰€æœ‰å¯¹è±¡ void releaseAll() {...} //é‡Šæ”¾åˆ°stopä½ç½®ä¹‹å‰çš„æ‰€æœ‰å¯¹è±¡ void releaseUntil(id *stop) {...} //æ€æ‰ void kill() {...} //é‡Šæ”¾æœ¬åœ°çº¿ç¨‹å­˜å‚¨ç©ºé—´ static void tls_dealloc(void *p) {...} //è·å–AutoreleasePoolPage static AutoreleasePoolPage *pageForPointer(const void *p) {...} static AutoreleasePoolPage *pageForPointer(uintptr_t p) {...} //æ˜¯å¦æœ‰ç©ºæ± å ä½ç¬¦ static inline bool haveEmptyPoolPlaceholder() {...} //è®¾ç½®ç©ºæ± å ä½ç¬¦ static inline id* setEmptyPoolPlaceholder(){...} //è·å–å½“å‰æ“ä½œé¡µ static inline AutoreleasePoolPage *hotPage(){...} //è®¾ç½®å½“å‰æ“ä½œé¡µ static inline void setHotPage(AutoreleasePoolPage *page) {...} //è·å–coldPage static inline AutoreleasePoolPage *coldPage() {...} static inline id *autoreleaseFast(id obj){...} //æ·»åŠ è‡ªåŠ¨é‡Šæ”¾å¯¹è±¡ï¼Œå½“é¡µæ»¡çš„æ—¶å€™è°ƒç”¨è¿™ä¸ªæ–¹æ³• static __attribute__((noinline)) id *autoreleaseFullPage(id obj, AutoreleasePoolPage *page) {...} //æ·»åŠ è‡ªåŠ¨é‡Šæ”¾å¯¹è±¡ï¼Œå½“æ²¡é¡µçš„æ—¶å€™ä½¿ç”¨è¿™ä¸ªæ–¹æ³• static __attribute__((noinline)) id *autoreleaseNoPage(id obj){...} //åˆ›å»ºæ–°é¡µ static __attribute__((noinline)) id *autoreleaseNewPage(id obj) {...} public: //è‡ªåŠ¨é‡Šæ”¾ static inline id autorelease(id obj){...} //å…¥æ ˆ static inline void *push() {...} //å…¼å®¹è€çš„ SDK å‡ºæ ˆæ–¹æ³• __attribute__((noinline, cold)) static void badPop(void *token){...} //å‡ºæ ˆé¡µé¢ template&lt;bool allowDebug&gt; static void popPage(void *token, AutoreleasePoolPage *page, id *stop){...} __attribute__((noinline, cold)) static void popPageDebug(void *token, AutoreleasePoolPage *page, id *stop){...} //å‡ºæ ˆ static inline void pop(void *token){...} static void init(){...} //æ‰“å° __attribute__((noinline, cold)) void print(){...} //æ‰“å°æ‰€æœ‰ __attribute__((noinline, cold)) static void printAll(){...} //æ‰“å°Hiwat __attribute__((noinline, cold)) static void printHiwat(){...} ä»å…¶å®šä¹‰ä¸­å‘ç°ï¼ŒAutoreleasePoolPageæ˜¯ç»§æ‰¿è‡ªAutoreleasePoolPageData,ä¸”è¯¥ç±»çš„å±æ€§ä¹Ÿæ˜¯æ¥è‡ªçˆ¶ç±»ï¼Œä»¥ä¸‹æ˜¯AutoreleasePoolPageDataçš„å®šä¹‰ï¼Œ 1234567891011121314151617181920212223242526class AutoreleasePoolPage;struct AutoreleasePoolPageData{ //ç”¨æ¥æ ¡éªŒAutoreleasePoolPageçš„ç»“æ„æ˜¯å¦å®Œæ•´ magic_t const magic;//16ä¸ªå­—èŠ‚ //æŒ‡å‘æœ€æ–°æ·»åŠ çš„autoreleasedå¯¹è±¡çš„ä¸‹ä¸€ä¸ªä½ç½®ï¼Œåˆå§‹åŒ–æ—¶æŒ‡å‘begin() __unsafe_unretained id *next;//8å­—èŠ‚ //æŒ‡å‘å½“å‰çº¿ç¨‹ pthread_t const thread;//8å­—èŠ‚ //æŒ‡å‘çˆ¶èŠ‚ç‚¹ï¼Œç¬¬ä¸€ä¸ªç»“ç‚¹çš„parentå€¼ä¸ºnil AutoreleasePoolPage * const parent;//8å­—èŠ‚ //æŒ‡å‘å­èŠ‚ç‚¹ï¼Œæœ€åä¸€ä¸ªç»“ç‚¹çš„childå€¼ä¸ºnil AutoreleasePoolPage *child;//8å­—èŠ‚ //è¡¨ç¤ºæ·±åº¦ï¼Œä»0å¼€å§‹ï¼Œå¾€åé€’å¢1 uint32_t const depth;//4å­—èŠ‚ //è¡¨ç¤ºhigh water mark æœ€å¤§å…¥æ ˆæ•°é‡æ ‡è®° uint32_t hiwat;//4å­—èŠ‚ //åˆå§‹åŒ– AutoreleasePoolPageData(__unsafe_unretained id* _next, pthread_t _thread, AutoreleasePoolPage* _parent, uint32_t _depth, uint32_t _hiwat) : magic(), next(_next), thread(_thread), parent(_parent), child(nil), depth(_depth), hiwat(_hiwat) { }}; å‘ç°å…¶ä¸­æœ‰parentå’Œchildï¼Œè¯´æ˜è‡ªåŠ¨é‡Šæ”¾æ± é™¤äº†æ˜¯ä¸€ä¸ªé¡µï¼Œè¿˜æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ç»“æ„ å…¶ä¸­AutoreleasePoolPageDataç»“æ„ä½“çš„å†…å­˜å¤§å°ä¸º56å­—èŠ‚ï¼š å±æ€§magic çš„ç±»å‹æ˜¯magic_tç»“æ„ä½“ï¼Œæ‰€å å†…å­˜å¤§å°ä¸ºm[4];æ‰€å å†…å­˜ï¼ˆå³4*4=16å­—èŠ‚ï¼‰ å±æ€§nextï¼ˆæŒ‡é’ˆï¼‰ã€threadï¼ˆå¯¹è±¡ï¼‰ã€parentï¼ˆå¯¹è±¡ï¼‰ã€childï¼ˆå¯¹è±¡ï¼‰å‡å 8å­—èŠ‚ï¼ˆå³4*8=32å­—èŠ‚ï¼‰ å±æ€§depthã€hiwatç±»å‹ä¸ºuint32_tï¼Œå®é™…ç±»å‹æ˜¯unsigned intç±»å‹ï¼Œå‡å 4å­—èŠ‚ï¼ˆå³2*4=8å­—èŠ‚ï¼‰ 1.1.2 objc_autoreleasePoolPushè¿›å…¥pushæºç å®ç°ï¼Œæœ‰ä»¥ä¸‹é€»è¾‘ åˆ¤æ–­æ˜¯å¦ä¸ºæœ‰ pool å¦‚æœæ²¡æœ‰ï¼Œåˆ™é€šè¿‡autoreleaseNewPageæ–¹æ³•åˆ›å»º å¦‚æœæœ‰ï¼Œåˆ™é€šè¿‡autoreleaseFastå‹æ ˆå“¨å…µå¯¹è±¡ 12345678910111213141516//å…¥æ ˆstatic inline void *push() { id *dest; //åˆ¤æ–­æ˜¯å¦æœ‰pool if (slowpath(DebugPoolAllocation)) { // Each autorelease pool starts on a new pool page.è‡ªåŠ¨é‡Šæ”¾æ± ä»æ–°æ± é¡µé¢å¼€å§‹ //å¦‚æœæ²¡æœ‰ï¼Œåˆ™åˆ›å»º dest = autoreleaseNewPage(POOL_BOUNDARY); } else { //å‹æ ˆä¸€ä¸ªPOOL_BOUNDARYï¼Œå³å‹æ ˆå“¨å…µ dest = autoreleaseFast(POOL_BOUNDARY); } ASSERT(dest == EMPTY_POOL_PLACEHOLDER || *dest == POOL_BOUNDARY); return dest;} autoreleaseNewPageè¿›å…¥objc_autoreleasePoolPush -&gt; push -&gt; autoreleaseNewPageæºç å®ç°ï¼Œä¸»è¦æ˜¯é€šè¿‡hotPageè·å–å½“å‰é¡µï¼Œåˆ¤æ–­å½“å‰é¡µæ˜¯å¦å­˜åœ¨ å¦‚æœå­˜åœ¨ï¼Œåˆ™é€šè¿‡autoreleaseFullPageæ–¹æ³•å‹æ ˆå¯¹è±¡ å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™é€šè¿‡autoreleaseNoPageæ–¹æ³•åˆ›å»ºé¡µ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182//åˆ›å»ºæ–°é¡µstatic __attribute__((noinline))id *autoreleaseNewPage(id obj){ //è·å–å½“å‰æ“ä½œé¡µ AutoreleasePoolPage *page = hotPage(); //å¦‚æœå­˜åœ¨ï¼Œåˆ™å‹æ ˆå¯¹è±¡ if (page) return autoreleaseFullPage(obj, page); //å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºé¡µ else return autoreleaseNoPage(obj);}//******** hotPageæ–¹æ³• ********//è·å–å½“å‰æ“ä½œé¡µstatic inline AutoreleasePoolPage *hotPage() { //è·å–å½“å‰é¡µ AutoreleasePoolPage *result = (AutoreleasePoolPage *) tls_get_direct(key); //å¦‚æœæ˜¯ä¸€ä¸ªç©ºæ± ï¼Œåˆ™è¿”å›nilï¼Œå¦åˆ™ï¼Œè¿”å›å½“å‰çº¿ç¨‹çš„è‡ªåŠ¨é‡Šæ”¾æ±  if ((id *)result == EMPTY_POOL_PLACEHOLDER) return nil; if (result) result-&gt;fastcheck(); return result;}//******** autoreleaseNoPageæ–¹æ³• ********static __attribute__((noinline))id *autoreleaseNoPage(id obj){ // &quot;No page&quot; could mean no pool has been pushed // or an empty placeholder pool has been pushed and has no contents yet ASSERT(!hotPage()); bool pushExtraBoundary = false; //åˆ¤æ–­æ˜¯å¦æ˜¯ç©ºå ä½ç¬¦ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å‹æ ˆå“¨å…µæ ‡è¯†ç¬¦ç½®ä¸ºYES if (haveEmptyPoolPlaceholder()) { // We are pushing a second pool over the empty placeholder pool // or pushing the first object into the empty placeholder pool. // Before doing that, push a pool boundary on behalf of the pool // that is currently represented by the empty placeholder. pushExtraBoundary = true; } //å¦‚æœå¯¹è±¡ä¸æ˜¯å“¨å…µå¯¹è±¡ï¼Œä¸”æ²¡æœ‰Poolï¼Œåˆ™æŠ¥é”™ else if (obj != POOL_BOUNDARY &amp;&amp; DebugMissingPools) { // We are pushing an object with no pool in place, // and no-pool debugging was requested by environment. _objc_inform(&quot;MISSING POOLS: (%p) Object %p of class %s &quot; &quot;autoreleased with no pool in place - &quot; &quot;just leaking - break on &quot; &quot;objc_autoreleaseNoPool() to debug&quot;, objc_thread_self(), (void*)obj, object_getClassName(obj)); objc_autoreleaseNoPool(obj); return nil; } //å¦‚æœå¯¹è±¡æ˜¯å“¨å…µå¯¹è±¡ï¼Œä¸”æ²¡æœ‰ç”³è¯·è‡ªåŠ¨é‡Šæ”¾æ± å†…å­˜ï¼Œåˆ™è®¾ç½®ä¸€ä¸ªç©ºå ä½ç¬¦å­˜å‚¨åœ¨tlsä¸­ï¼Œå…¶ç›®çš„æ˜¯ä¸ºäº†èŠ‚çœå†…å­˜ else if (obj == POOL_BOUNDARY &amp;&amp; !DebugPoolAllocation) {//å¦‚æœä¼ å…¥å‚æ•°ä¸ºå“¨å…µ // We are pushing a pool with no pool in place, // and alloc-per-pool debugging was not requested. // Install and return the empty pool placeholder. return setEmptyPoolPlaceholder();//è®¾ç½®ç©ºçš„å ä½ç¬¦ } // We are pushing an object or a non-placeholder'd pool. // Install the first page. //åˆå§‹åŒ–ç¬¬ä¸€é¡µ AutoreleasePoolPage *page = new AutoreleasePoolPage(nil); //è®¾ç½®pageä¸ºå½“å‰èšç„¦é¡µ setHotPage(page); // Push a boundary on behalf of the previously-placeholder'd pool. //å‹æ ˆå“¨å…µçš„æ ‡è¯†ç¬¦ä¸ºYESï¼Œåˆ™å‹æ ˆå“¨å…µå¯¹è±¡ if (pushExtraBoundary) { //å‹æ ˆå“¨å…µ page-&gt;add(POOL_BOUNDARY); } // Push the requested object or pool. //å‹æ ˆå¯¹è±¡ return page-&gt;add(obj);} å…¶ä¸­autoreleaseNoPageæ–¹æ³•ä¸­å‘ç°å½“å‰çº¿ç¨‹çš„è‡ªåŠ¨é‡Šæ”¾æ± æ˜¯é€šè¿‡AutoreleasePoolPageåˆ›å»ºçš„ï¼Œå…¶å®šä¹‰ä¸­æœ‰æ„é€ æ–¹æ³•ï¼Œè€Œæ„é€ æ–¹æ³•çš„å®ç°æ˜¯é€šè¿‡çˆ¶ç±»AutoreleasePoolPageDataçš„åˆå§‹åŒ–æ–¹æ³•ï¼ˆä»ä¸Šé¢çš„å®šä¹‰ä¸­å¯ä»¥å¾—çŸ¥ï¼‰ 1234567891011121314151617181920212223242526//**********AutoreleasePoolPageæ„é€ æ–¹æ³•********** AutoreleasePoolPage(AutoreleasePoolPage *newParent) : AutoreleasePoolPageData(begin(),//å¼€å§‹å­˜å‚¨çš„ä½ç½® objc_thread_self(),//ä¼ çš„æ˜¯å½“å‰çº¿ç¨‹ï¼Œå½“å‰çº¿ç¨‹æ—¶é€šè¿‡tlsè·å–çš„ newParent, newParent ? 1+newParent-&gt;depth : 0,//å¦‚æœæ˜¯ç¬¬ä¸€é¡µæ·±åº¦ä¸º0ï¼Œå¾€åæ˜¯å‰ä¸€ä¸ªçš„æ·±åº¦+1 newParent ? newParent-&gt;hiwat : 0){ if (parent) { parent-&gt;check(); ASSERT(!parent-&gt;child); parent-&gt;unprotect(); //this è¡¨ç¤º æ–°å»ºé¡µé¢ï¼Œå°†å½“å‰é¡µé¢çš„å­èŠ‚ç‚¹ èµ‹å€¼ä¸ºæ–°å»ºé¡µé¢ parent-&gt;child = this; parent-&gt;protect(); } protect();}//**********AutoreleasePoolPageDataåˆå§‹åŒ–æ–¹æ³•**********AutoreleasePoolPageData(__unsafe_unretained id* _next, pthread_t _thread, AutoreleasePoolPage* _parent, uint32_t _depth, uint32_t _hiwat) : magic(), next(_next), thread(_thread), parent(_parent), child(nil), depth(_depth), hiwat(_hiwat) { } å…¶ä¸­AutoreleasePoolPageDataæ–¹æ³•ä¼ å…¥çš„å‚æ•°å«ä¹‰ä¸ºï¼š begin()è¡¨ç¤ºå‹æ ˆçš„ä½ç½®ï¼ˆå³ä¸‹ä¸€ä¸ªè¦é‡Šæ”¾å¯¹è±¡çš„å‹æ ˆåœ°å€ï¼‰ã€‚å¯ä»¥é€šè¿‡æºç è°ƒè¯•beginï¼Œå‘ç°å…¶å…·ä½“å®ç°ç­‰äºé¡µé¦–åœ°å€+56ï¼Œå…¶ä¸­çš„56å°±æ˜¯ç»“æ„ä½“AutoreleasePoolPageDataçš„å†…å­˜å¤§å° 123456//********begin()********//é¡µçš„å¼€å§‹ä½ç½®id * begin() { //ç­‰äº é¦–åœ°å€+56ï¼ˆAutoreleasePoolPageç±»æ‰€å å†…å­˜å¤§å°ï¼‰ return (id *) ((uint8_t *)this+sizeof(*this));} objc_thread_self() è¡¨ç¤ºçš„æ˜¯å½“å‰çº¿ç¨‹ï¼Œè€Œå½“å‰çº¿ç¨‹æ—¶é€šè¿‡tlsè·å–çš„ 123456__attribute__((const))static inline pthread_t objc_thread_self(){ //é€šè¿‡tlsè·å–å½“å‰çº¿ç¨‹ return (pthread_t)tls_get_direct(_PTHREAD_TSD_SLOT_PTHREAD_SELF);} newParentè¡¨ç¤ºçˆ¶èŠ‚ç‚¹ åç»­ä¸¤ä¸ªå‚æ•°æ˜¯é€šè¿‡çˆ¶èŠ‚ç‚¹çš„æ·±åº¦ã€æœ€å¤§å…¥æ ˆä¸ªæ•°è®¡ç®—depthä»¥åŠhiwat æŸ¥çœ‹è‡ªåŠ¨é‡Šæ”¾æ± å†…å­˜ç»“æ„ ç”±äºåœ¨ARCæ¨¡å¼ä¸‹ï¼Œæ˜¯æ— æ³•æ‰‹åŠ¨è°ƒç”¨autoreleaseï¼Œæ‰€ä»¥å°†Demoåˆ‡æ¢è‡³MRCæ¨¡å¼ï¼ˆBuild Settings -&gt; Objectice-C Automatic Reference Countingè®¾ç½®ä¸ºNOï¼‰ å®šä¹‰å¦‚ä¸‹ä»£ç  1234567891011121314//************æ‰“å°è‡ªåŠ¨é‡Šæ”¾æ± ç»“æ„************extern void _objc_autoreleasePoolPrint(void);//************è¿è¡Œä»£ç ************int main(int argc, const char * argv[]) { @autoreleasepool { //å¾ªç¯åˆ›å»ºå¯¹è±¡ï¼Œå¹¶åŠ å…¥è‡ªåŠ¨é‡Šæ”¾æ±  for (int i = 0; i &lt; 5; i++) { NSObject *objc = [[NSObject alloc] sutorelease]; } //è°ƒç”¨ _objc_autoreleasePoolPrint(); }} è¿è¡Œç»“æœå¦‚ä¸‹ï¼Œå‘ç°æ˜¯6ä¸ªï¼Œä½†æ˜¯æˆ‘ä»¬å‹æ ˆçš„å¯¹è±¡å…¶å®åªæœ‰5ä¸ªï¼Œå…¶ä¸­çš„POOLè¡¨ç¤ºå“¨å…µï¼Œå³è¾¹ç•Œï¼Œå…¶ç›®çš„æ˜¯ä¸ºäº†é˜²æ­¢è¶Šç•Œ æŸ¥çœ‹è‡ªåŠ¨é‡Šæ”¾æ± çš„å†…å­˜ç»“æ„ï¼Œå‘ç°ï¼Œé¡µçš„é¦–åœ°å€ä¸å“¨å…µå¯¹è±¡ç›¸å·®0x38ï¼Œè½¬æ¢æˆåè¿›åˆ¶åˆšå¥½æ˜¯56ï¼Œä¹Ÿå°±æ˜¯ AutoreleasePoolPageè‡ªå·±æœ¬èº«çš„å†…å­˜å¤§å° å°†ä¸Šè¿°çš„æµ‹è¯•ä»£ç çš„æ•°æ®æ”¹ä¸º505ï¼Œå…¶å†…å­˜ç»“æ„å¦‚ä¸‹ï¼Œå‘ç°ç¬¬ä¸€é¡µæ»¡äº†ï¼Œå­˜å‚¨äº†504ä¸ªè¦é‡Šæ”¾çš„å¯¹è±¡ï¼Œç¬¬äºŒé¡µåªå­˜å‚¨äº†ä¸€ä¸ª å†å°†æ•°æ®æ”¹ä¸º505+506ï¼Œæ¥éªŒè¯ç¬¬äºŒé¡µæ˜¯å¦ä¹Ÿæ˜¯å­˜å‚¨504ä¸ªå¯¹è±¡ é€šè¿‡è¿è¡Œå‘ç°ï¼Œç¬¬ä¸€é¡µå­˜å‚¨504ï¼Œç¬¬äºŒé¡µå­˜å‚¨505ï¼Œç¬¬ä¸‰é¡µå­˜å‚¨2ä¸ª ç»“è®º æ‰€ä»¥é€šè¿‡ä¸Šè¿°æµ‹è¯•ï¼Œå¯ä»¥å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š ç¬¬ä¸€é¡µå¯ä»¥å­˜æ”¾504ä¸ªå¯¹è±¡ï¼Œä¸”åªæœ‰ç¬¬ä¸€é¡µæœ‰å“¨å…µï¼Œå½“ä¸€é¡µå‹æ ˆæ»¡äº†ï¼Œå°±ä¼šå¼€è¾Ÿæ–°çš„ä¸€é¡µ ç¬¬äºŒé¡µå¼€å§‹ï¼Œæœ€å¤šå¯ä»¥å­˜æ”¾505ä¸ªå¯¹è±¡ ä¸€é¡µçš„å¤§å°ç­‰äº 505 * 8 = 4040 è¿™ä¸ªç»“è®ºåŒæ ·å¯ä»¥é€šè¿‡AutoreleasePoolPageä¸­çš„SIZEæ¥å¾—åˆ°å°è¯ï¼Œä»å…¶å®šä¹‰ä¸­æˆ‘ä»¬å¯ä»¥å¾—å‡ºï¼Œä¸€é¡µçš„å¤§å°æ˜¯4096å­—èŠ‚ï¼Œè€Œåœ¨å…¶æ„é€ å‡½æ•°ä¸­å¯¹è±¡çš„å‹æ ˆä½ç½®ï¼Œæ˜¯ä»é¦–åœ°å€+56å¼€å§‹çš„ï¼Œæ‰€ä»¥å¯ä»¥ä¸€é¡µä¸­å®é™…å¯ä»¥å­˜å‚¨ 4096-56 = 4040å­—èŠ‚ï¼Œè½¬æ¢æˆå¯¹è±¡æ˜¯ 4040 / 8 = 505ä¸ª,å³ä¸€é¡µæœ€å¤šå¯ä»¥å­˜å‚¨505ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­ç¬¬ä¸€é¡µæœ‰å“¨å…µå¯¹è±¡åªèƒ½å­˜å‚¨504ä¸ªã€‚ autoreleaseFastè¿›å…¥autoreleaseFastæºç ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ æ­¥ï¼š è·å–å½“å‰æ“ä½œé¡µï¼Œå¹¶åˆ¤æ–­é¡µæ˜¯å¦å­˜åœ¨ä»¥åŠæ˜¯å¦æ»¡äº† å¦‚æœé¡µå­˜åœ¨ï¼Œä¸”æœªæ»¡ï¼Œåˆ™é€šè¿‡addæ–¹æ³•å‹æ ˆå¯¹è±¡ å¦‚æœé¡µå­˜åœ¨ï¼Œä¸”æ»¡äº†ï¼Œåˆ™é€šè¿‡autoreleaseFullPageæ–¹æ³•å®‰æ’æ–°çš„é¡µé¢ å¦‚æœé¡µä¸å­˜åœ¨ï¼Œåˆ™é€šè¿‡autoreleaseNoPageæ–¹æ³•åˆ›å»ºæ–°é¡µ 12345678910111213141516static inline id *autoreleaseFast(id obj){ //è·å–å½“å‰æ“ä½œé¡µ AutoreleasePoolPage *page = hotPage(); //åˆ¤æ–­é¡µæ˜¯å¦æ»¡äº† if (page &amp;&amp; !page-&gt;full()) { //å¦‚æœæœªæ»¡ï¼Œåˆ™å‹æ ˆ return page-&gt;add(obj); } else if (page) { //å¦‚æœæ»¡äº†ï¼Œåˆ™å®‰æ’æ–°çš„é¡µé¢ return autoreleaseFullPage(obj, page); } else { //é¡µä¸å­˜åœ¨ï¼Œåˆ™æ–°å»ºé¡µ return autoreleaseNoPage(obj); }} autoreleaseFullPage è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯ç”¨äºåˆ¤æ–­å½“å‰é¡µæ˜¯å¦å·²ç»å­˜å‚¨æ»¡äº†ï¼Œå¦‚æœå½“å‰é¡µå·²ç»æ»¡äº†ï¼Œé€šè¿‡do-whileå¾ªç¯æŸ¥æ‰¾å­èŠ‚ç‚¹å¯¹åº”çš„é¡µï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ–°å»ºé¡µï¼Œå¹¶å‹æ ˆå¯¹è±¡ 1234567891011121314151617181920212223//æ·»åŠ è‡ªåŠ¨é‡Šæ”¾å¯¹è±¡ï¼Œå½“é¡µæ»¡çš„æ—¶å€™è°ƒç”¨è¿™ä¸ªæ–¹æ³•static __attribute__((noinline))id *autoreleaseFullPage(id obj, AutoreleasePoolPage *page){ // The hot page is full. // Step to the next non-full page, adding a new page if necessary. // Then add the object to that page. ASSERT(page == hotPage()); ASSERT(page-&gt;full() || DebugPoolAllocation); //do-whileéå†å¾ªç¯æŸ¥æ‰¾ç•Œé¢æ˜¯å¦æ»¡äº† do { //å¦‚æœå­é¡µé¢å­˜åœ¨ï¼Œåˆ™å°†é¡µé¢æ›¿æ¢ä¸ºå­é¡µé¢ if (page-&gt;child) page = page-&gt;child; //å¦‚æœå­é¡µé¢ä¸å­˜åœ¨ï¼Œåˆ™æ–°å»ºé¡µé¢ else page = new AutoreleasePoolPage(page); } while (page-&gt;full()); //è®¾ç½®ä¸ºå½“å‰æ“ä½œé¡µé¢ setHotPage(page); //å¯¹è±¡å‹æ ˆ return page-&gt;add(obj);} ä»AutoreleasePoolPageåˆå§‹åŒ–æ–¹æ³•ä¸­å¯ä»¥çœ‹å‡ºï¼Œä¸»è¦æ˜¯é€šè¿‡æ“ä½œchildå¯¹è±¡ï¼Œå°†å½“å‰é¡µçš„childæŒ‡å‘æ–°å»ºé¡µé¢ï¼Œç”±æ­¤å¯ä»¥å¾—å‡ºé¡µæ˜¯é€šè¿‡åŒå‘é“¾è¡¨è¿æ¥ add æ–¹æ³• è¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯æ·»åŠ é‡Šæ”¾å¯¹è±¡ï¼Œå…¶åº•å±‚æ˜¯å®ç°æ˜¯é€šè¿‡nextæŒ‡é’ˆå­˜å‚¨é‡Šæ”¾å¯¹è±¡ï¼Œå¹¶å°†nextæŒ‡é’ˆé€’å¢ï¼Œè¡¨ç¤ºä¸‹ä¸€ä¸ªé‡Šæ”¾å¯¹è±¡å­˜å‚¨çš„ä½ç½®ã€‚ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºé¡µæ˜¯é€šè¿‡æ ˆç»“æ„å­˜å‚¨ 123456789101112//æ·»åŠ é‡Šæ”¾å¯¹è±¡id *add(id obj){ ASSERT(!full()); unprotect(); //ä¼ å…¥å¯¹è±¡å­˜å‚¨çš„ä½ç½® id *ret = next; // faster than `return next-1` because of aliasing //å°†objå‹æ ˆåˆ°nextæŒ‡é’ˆä½ç½®ï¼Œç„¶ånextè¿›è¡Œ++ï¼Œå³ä¸‹ä¸€ä¸ªå¯¹è±¡å­˜å‚¨çš„ä½ç½® *next++ = obj; protect(); return ret;} autoreleaseåœ¨demoä¸­ï¼Œæˆ‘ä»¬é€šè¿‡autoreleaseæ–¹æ³•ï¼Œåœ¨MRCæ¨¡å¼ä¸‹ï¼Œå°†å¯¹è±¡å‹æ ˆåˆ°è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œä¸‹é¢æ¥åˆ†æå…¶åº•å±‚å®ç° æŸ¥çœ‹autoreleaseæ–¹æ³•æºç  å¦‚æœä¸æ˜¯å¯¹è±¡ æˆ–è€… æ˜¯å°å¯¹è±¡ï¼Œåˆ™ç›´æ¥è¿”å› å¦‚æœæ˜¯å¯¹è±¡ï¼Œåˆ™è°ƒç”¨å¯¹è±¡çš„autoreleaseè¿›è¡Œé‡Šæ”¾ 12345678910__attribute__((aligned(16), flatten, noinline))idobjc_autorelease(id obj){ //å¦‚æœä¸æ˜¯å¯¹è±¡ï¼Œåˆ™ç›´æ¥è¿”å› if (!obj) return obj; //å¦‚æœæ˜¯å°å¯¹è±¡ï¼Œä¹Ÿç›´æ¥è¿”å› if (obj-&gt;isTaggedPointer()) return obj; return obj-&gt;autorelease();} è¿›å…¥å¯¹è±¡çš„autoreleaseå®ç° 1234567891011121314151617181920212223242526272829303132333435363738394041ğŸ‘‡inline id objc_object::autorelease(){ ASSERT(!isTaggedPointer()); //åˆ¤æ–­æ˜¯å¦æ˜¯è‡ªå®šä¹‰ç±» if (fastpath(!ISA()-&gt;hasCustomRR())) { return rootAutorelease(); } return ((id(*)(objc_object *, SEL))objc_msgSend)(this, @selector(autorelease));}ğŸ‘‡inline id objc_object::rootAutorelease(){ //å¦‚æœæ˜¯å°å¯¹è±¡ï¼Œç›´æ¥è¿”å› if (isTaggedPointer()) return (id)this; if (prepareOptimizedReturn(ReturnAtPlus1)) return (id)this; return rootAutorelease2();}ğŸ‘‡__attribute__((noinline,used))id objc_object::rootAutorelease2(){ ASSERT(!isTaggedPointer()); return AutoreleasePoolPage::autorelease((id)this);}ğŸ‘‡static inline id autorelease(id obj){ ASSERT(obj); ASSERT(!obj-&gt;isTaggedPointer()); //autoreleaseFast å‹æ ˆæ“ä½œ id *dest __unused = autoreleaseFast(obj); ASSERT(!dest || dest == EMPTY_POOL_PLACEHOLDER || *dest == obj); return obj;} ä»è¿™é‡Œçœ‹å‡ºï¼Œæ— è®ºæ˜¯å‹æ ˆå“¨å…µå¯¹è±¡ï¼Œè¿˜æ˜¯æ™®é€šå¯¹è±¡ï¼Œéƒ½ä¼šæ¥åˆ°autoreleaseFastæ–¹æ³•ï¼Œåªæ˜¯åŒºåˆ«æ ‡è¯†ä¸åŒè€Œä»¥ 1.1.3 objc_autoreleasePoolPopåœ¨objc_autoreleasePoolPopæ–¹æ³•ä¸­æœ‰ä¸ªå‚æ•°ï¼Œåœ¨clangåˆ†ææ—¶ï¼Œå‘ç°ä¼ å…¥çš„å‚æ•°æ˜¯pushå‹æ ˆåè¿”å›çš„å“¨å…µå¯¹è±¡ï¼Œå³ctxtï¼Œå…¶ç›®çš„æ˜¯é¿å…å‡ºæ ˆæ··ä¹±ï¼Œé˜²æ­¢å°†åˆ«çš„å¯¹è±¡å‡ºæ ˆ è¿›å…¥popæºç å®ç°ï¼Œä¸»è¦ç”±ä»¥ä¸‹å‡ æ­¥ ç©ºé¡µé¢çš„å¤„ç†ï¼Œå¹¶æ ¹æ®tokenè·å–page å®¹é”™å¤„ç† é€šè¿‡popPageå‡ºæ ˆé¡µ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950//å‡ºæ ˆstatic inline voidpop(void *token){ AutoreleasePoolPage *page; id *stop; //åˆ¤æ–­å¯¹è±¡æ˜¯å¦æ˜¯ç©ºå ä½ç¬¦ if (token == (void*)EMPTY_POOL_PLACEHOLDER) { //å¦‚æœå½“æ˜¯ç©ºå ä½ç¬¦ // Popping the top-level placeholder pool. //è·å–å½“å‰é¡µ page = hotPage(); if (!page) { // Pool was never used. Clear the placeholder. //å¦‚æœå½“å‰é¡µä¸å­˜åœ¨ï¼Œåˆ™æ¸…é™¤ç©ºå ä½ç¬¦ return setHotPage(nil); } // Pool was used. Pop its contents normally. // Pool pages remain allocated for re-use as usual. //å¦‚æœå½“å‰é¡µå­˜åœ¨ï¼Œåˆ™å°†å½“å‰é¡µè®¾ç½®ä¸ºcoldPage,tokenè®¾ç½®ä¸ºcoldPageçš„å¼€å§‹ä½ç½® page = coldPage(); token = page-&gt;begin(); } else { //è·å–tokenæ‰€åœ¨çš„é¡µ page = pageForPointer(token); } stop = (id *)token; //åˆ¤æ–­æœ€åä¸€ä¸ªä½ç½®ï¼Œæ˜¯å¦æ˜¯å“¨å…µ if (*stop != POOL_BOUNDARY) { //æœ€åä¸€ä¸ªä½ç½®ä¸æ˜¯å“¨å…µï¼Œå³æœ€åä¸€ä¸ªä½ç½®æ˜¯ä¸€ä¸ªå¯¹è±¡ if (stop == page-&gt;begin() &amp;&amp; !page-&gt;parent) { //å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªä½ç½®ï¼Œä¸”æ²¡æœ‰çˆ¶èŠ‚ç‚¹ï¼Œä»€ä¹ˆä¹Ÿä¸åš // Start of coldest page may correctly not be POOL_BOUNDARY: // 1. top-level pool is popped, leaving the cold page in place // 2. an object is autoreleased with no pool } else { //å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªä½ç½®ï¼Œä¸”æœ‰çˆ¶èŠ‚ç‚¹ï¼Œåˆ™å‡ºç°äº†æ··ä¹± // Error. For bincompat purposes this is not // fatal in executables built with old SDKs. return badPop(token); } } if (slowpath(PrintPoolHiwat || DebugPoolAllocation || DebugMissingPools)) { return popPageDebug(token, page, stop); } //å‡ºæ ˆé¡µ return popPage&lt;false&gt;(token, page, stop);} è¿›å…¥popPageæºç ï¼Œå…¶ä¸­ä¼ å…¥çš„allowDebugä¸ºfalseï¼Œåˆ™é€šè¿‡releaseUntilå‡ºæ ˆå½“å‰é¡µstopä½ç½®ä¹‹å‰çš„æ‰€æœ‰å¯¹è±¡ï¼Œå³å‘æ ˆä¸­çš„å¯¹è±¡å‘é€releaseæ¶ˆæ¯ï¼Œç›´åˆ°é‡åˆ°ä¼ å…¥çš„å“¨å…µå¯¹è±¡ 12345678910111213141516171819202122232425262728293031323334353637//å‡ºæ ˆé¡µé¢template&lt;bool allowDebug&gt; static void popPage(void *token, AutoreleasePoolPage *page, id *stop){ if (allowDebug &amp;&amp; PrintPoolHiwat) printHiwat(); //å‡ºæ ˆå½“å‰æ“ä½œé¡µé¢å¯¹è±¡ page-&gt;releaseUntil(stop); // memory: delete empty children åˆ é™¤ç©ºå­é¡¹ if (allowDebug &amp;&amp; DebugPoolAllocation &amp;&amp; page-&gt;empty()) { // special case: delete everything during page-per-pool debugging //è°ƒè¯•æœŸé—´åˆ é™¤æ¯ä¸ªç‰¹æ®Šæƒ…å†µä¸‹çš„æ‰€æœ‰æ±  //è·å–å½“å‰é¡µé¢çš„çˆ¶èŠ‚ç‚¹ AutoreleasePoolPage *parent = page-&gt;parent; //å°†å½“å‰é¡µé¢æ€æ‰ page-&gt;kill(); //è®¾ç½®æ“ä½œé¡µé¢ä¸ºçˆ¶èŠ‚ç‚¹é¡µé¢ setHotPage(parent); } else if (allowDebug &amp;&amp; DebugMissingPools &amp;&amp; page-&gt;empty() &amp;&amp; !page-&gt;parent) { // special case: delete everything for pop(top) // when debugging missing autorelease pools //ç‰¹æ®Šæƒ…å†µï¼šè°ƒè¯•ä¸¢å¤±çš„è‡ªåŠ¨é‡Šæ”¾æ± æ—¶åˆ é™¤popï¼ˆtopï¼‰çš„æ‰€æœ‰å†…å®¹ page-&gt;kill(); setHotPage(nil); } else if (page-&gt;child) { // hysteresis: keep one empty child if page is more than half full å¦‚æœé¡µé¢å·²æ»¡ä¸€åŠä»¥ä¸Šï¼Œåˆ™ä¿ç•™ä¸€ä¸ªç©ºå­çº§ if (page-&gt;lessThanHalfFull()) { page-&gt;child-&gt;kill(); } else if (page-&gt;child-&gt;child) { page-&gt;child-&gt;child-&gt;kill(); } }} è¿›å…¥releaseUntilå®ç°ï¼Œä¸»è¦æ˜¯é€šè¿‡å¾ªç¯éå†ï¼Œåˆ¤æ–­å¯¹è±¡æ˜¯å¦ç­‰äºstopï¼Œå…¶çš„æ˜¯é‡Šæ”¾stopä¹‹å‰çš„æ‰€æœ‰çš„å¯¹è±¡ï¼Œ é¦–å…ˆé€šè¿‡è·å–pageçš„nexté‡Šæ”¾å¯¹è±¡ï¼ˆå³pageçš„æœ€åä¸€ä¸ªå¯¹è±¡ï¼‰ï¼Œå¹¶å¯¹nextè¿›è¡Œé€’å‡ï¼Œè·å–ä¸Šä¸€ä¸ªå¯¹è±¡ åˆ¤æ–­æ˜¯å¦æ˜¯å“¨å…µå¯¹è±¡ï¼Œå¦‚æœä¸æ˜¯åˆ™è‡ªåŠ¨è°ƒç”¨objc_releaseé‡Šæ”¾ 12345678910111213141516171819202122232425262728293031323334353637383940414243//é‡Šæ”¾åˆ°stopä½ç½®ä¹‹å‰çš„æ‰€æœ‰å¯¹è±¡void releaseUntil(id *stop) { // Not recursive: we don't want to blow out the stack ä¸æ˜¯é€’å½’çš„ï¼šæˆ‘ä»¬ä¸æƒ³ç ´åå †æ ˆ // if a thread accumulates a stupendous amount of garbage //åˆ¤æ–­ä¸‹ä¸€ä¸ªå¯¹è±¡æ˜¯å¦ç­‰äºstopï¼Œå¦‚æœä¸ç­‰äºï¼Œåˆ™è¿›å…¥whileå¾ªç¯ while (this-&gt;next != stop) { // Restart from hotPage() every time, in case -release // autoreleased more objects æ¯æ¬¡ä»hotPageï¼ˆï¼‰é‡æ–°å¯åŠ¨ï¼Œä»¥é˜²-releaseè‡ªåŠ¨é‡Šæ”¾æ›´å¤šå¯¹è±¡ //è·å–å½“å‰æ“ä½œé¡µé¢ï¼Œå³hoté¡µé¢ AutoreleasePoolPage *page = hotPage(); // fixme I think this `while` can be `if`, but I can't prove it //å¦‚æœå½“å‰é¡µæ˜¯ç©ºçš„ while (page-&gt;empty()) { //å°†pageèµ‹å€¼ä¸ºçˆ¶èŠ‚ç‚¹é¡µ page = page-&gt;parent; //å¹¶è®¾ç½®å½“å‰é¡µä¸ºçˆ¶èŠ‚ç‚¹é¡µ setHotPage(page); } page-&gt;unprotect(); //nextè¿›è¡Œ--æ“ä½œï¼Œå³å‡ºæ ˆ id obj = *--page-&gt;next; //å°†é¡µç´¢å¼•ä½ç½®ç½®ä¸ºSCRIBBLEï¼Œè¡¨ç¤ºå·²ç»è¢«é‡Šæ”¾ memset((void*)page-&gt;next, SCRIBBLE, sizeof(*page-&gt;next)); page-&gt;protect(); if (obj != POOL_BOUNDARY) { //é‡Šæ”¾ objc_release(obj); } } //è®¾ç½®å½“å‰é¡µ setHotPage(this);#if DEBUG // we expect any children to be completely empty for (AutoreleasePoolPage *page = child; page; page = page-&gt;child) { ASSERT(page-&gt;empty()); }#endif} è¿›å…¥killå®ç°ï¼Œä¸»è¦æ˜¯é”€æ¯å½“å‰é¡µï¼Œå°†å½“å‰é¡µèµ‹å€¼ä¸ºçˆ¶èŠ‚ç‚¹é¡µï¼Œå¹¶å°†çˆ¶èŠ‚ç‚¹é¡µçš„childå¯¹è±¡æŒ‡é’ˆç½®ä¸ºnil 1234567891011121314151617181920212223//é”€æ¯void kill() { // Not recursive: we don't want to blow out the stack // if a thread accumulates a stupendous amount of garbage AutoreleasePoolPage *page = this; //è·å–æœ€åä¸€ä¸ªé¡µ while (page-&gt;child) page = page-&gt;child; AutoreleasePoolPage *deathptr; do { deathptr = page; //å­èŠ‚ç‚¹ å˜æˆ çˆ¶èŠ‚ç‚¹ page = page-&gt;parent; if (page) { page-&gt;unprotect(); //å­èŠ‚ç‚¹ä¸ºnil page-&gt;child = nil; page-&gt;protect(); } delete deathptr; } while (deathptr != this);} 1.2 autoreleasepoolç»“æ„å›¾ 1.3 æ€»ç»“ autoreleasepoolå…¶æœ¬è´¨æ˜¯ä¸€ä¸ªç»“æ„ä½“å¯¹è±¡ï¼Œä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± å¯¹è±¡å°±æ˜¯é¡µï¼Œæ˜¯æ˜¯æ ˆç»“æ„å­˜å‚¨ï¼Œç¬¦åˆå…ˆè¿›åå‡ºçš„åŸåˆ™ é¡µçš„æ ˆåº•æ˜¯ä¸€ä¸ª56å­—èŠ‚å¤§å°çš„ç©ºå ä½ç¬¦ï¼Œä¸€é¡µæ€»å¤§å°ä¸º4096å­—èŠ‚ åªæœ‰ç¬¬ä¸€é¡µæœ‰å“¨å…µå¯¹è±¡ï¼Œç¬¬ä¸€é¡µæœ€å¤šå­˜å‚¨504ä¸ªå¯¹è±¡ï¼Œä»ç¬¬äºŒé¡µå¼€å§‹æœ€å¤šå­˜å‚¨505ä¸ªå¯¹è±¡ åœ¨è‡ªåŠ¨é‡Šæ”¾æ± çš„å‹æ ˆï¼ˆå³pushï¼‰æ“ä½œä¸­ å½“æ²¡æœ‰poolï¼Œå³åªæœ‰ç©ºå ä½ç¬¦ï¼ˆå­˜å‚¨åœ¨tlsä¸­ï¼‰æ—¶ï¼Œåˆ™åˆ›å»ºé¡µï¼Œå‹æ ˆå“¨å…µå¯¹è±¡ åœ¨é¡µä¸­å‹æ ˆæ™®é€šå¯¹è±¡ä¸»è¦æ˜¯é€šè¿‡nextæŒ‡é’ˆé€’å¢è¿›è¡Œçš„ï¼Œ å½“é¡µæ»¡äº†æ—¶ï¼Œéœ€è¦è®¾ç½®é¡µçš„childå¯¹è±¡ä¸ºæ–°å»ºé¡µ åœ¨è‡ªåŠ¨é‡Šæ”¾æ± çš„å‡ºæ ˆï¼ˆå³popï¼‰æ“ä½œä¸­ åœ¨é¡µä¸­å‡ºæ ˆæ™®é€šå¯¹è±¡ä¸»è¦æ˜¯é€šè¿‡nextæŒ‡é’ˆé€’å‡è¿›è¡Œçš„ï¼Œ å½“é¡µç©ºäº†æ—¶ï¼Œéœ€è¦èµ‹å€¼é¡µçš„parentå¯¹è±¡ä¸ºå½“å‰é¡µ äºŒã€RunLoopå¯¹äºRunLoopï¼Œä¸»è¦å…³å¿ƒçš„ç‚¹æœ‰ä»¥ä¸‹å‡ ä¸ª 1ã€runloopæ˜¯ä»€ä¹ˆï¼Ÿ 2ã€runloopå’Œçº¿ç¨‹çš„å…³ç³»ï¼Ÿ 3ã€runloopæ˜¯ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„ï¼Ÿ 2.1 ä»‹ç»RunLoopæ˜¯äº‹ä»¶æ¥æ”¶å’Œåˆ†å‘æœºåˆ¶çš„ä¸€ä¸ªå®ç°ï¼Œæ˜¯çº¿ç¨‹ç›¸å…³çš„åŸºç¡€æ¡†æ¶çš„ä¸€éƒ¨åˆ†ï¼Œä¸€ä¸ªRunLoopå°±æ˜¯ä¸€ä¸ªäº‹ä»¶å¤„ç†çš„å¾ªç¯ï¼Œç”¨æ¥ä¸åœçš„è°ƒåº¦å·¥ä½œä»¥åŠå¤„ç†è¾“å…¥äº‹ä»¶ã€‚ RunLoopæœ¬è´¨æ˜¯ä¸€ä¸ª do-whileå¾ªç¯ï¼Œæ²¡äº‹åšå°±ä¼‘æ¯ï¼Œæ¥æ´»äº†å°±å¹²æ´»ã€‚ä¸æ™®é€šçš„whileå¾ªç¯æ˜¯æœ‰åŒºåˆ«çš„ï¼Œæ™®é€šçš„whileå¾ªç¯ä¼šå¯¼è‡´CPUè¿›å…¥å¿™ç­‰å¾…çŠ¶æ€ï¼Œå³ä¸€ç›´æ¶ˆè€—cpuï¼Œè€ŒRunLoopåˆ™ä¸ä¼šï¼ŒRunLoopæ˜¯ä¸€ç§é—²ç­‰å¾…ï¼Œå³RunLoopå…·å¤‡ä¼‘çœ åŠŸèƒ½ã€‚ RunLoopçš„ä½œç”¨ ä¿æŒç¨‹åºçš„æŒç»­è¿è¡Œ å¤„ç†Appä¸­çš„å„ç§äº‹ä»¶ï¼ˆè§¦æ‘¸ã€å®šæ—¶å™¨ã€performSelectorï¼‰ èŠ‚çœcpuèµ„æºï¼Œæä¾›ç¨‹åºçš„æ€§èƒ½ï¼Œè¯¥åšäº‹å°±åšäº‹ï¼Œè¯¥ä¼‘æ¯å°±ä¼‘æ¯ 2.2 æºç åˆ†æä½¿ç”¨æˆ‘çš„runloopæºç åˆ†æ 2.2.1 RunLoopå’Œçº¿ç¨‹çš„å…³ç³»ä¸€èˆ¬åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œå¯¹äºRunLoopçš„è·å–ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼ 1234// ä¸»è¿è¡Œå¾ªç¯ CFRunLoopRef mainRunloop = CFRunLoopGetMain(); // å½“å‰è¿è¡Œå¾ªç¯ CFRunLoopRef currentRunloop = CFRunLoopGetCurrent(); è¿›å…¥CFRunLoopGetMainæºç  1234567CFRunLoopRef CFRunLoopGetMain(void) { CHECK_FOR_FORK(); static CFRunLoopRef __main = NULL; // no retain needed //pthread_main_thread_np ä¸»çº¿ç¨‹ if (!__main) __main = _CFRunLoopGet0(pthread_main_thread_np()); // no CAS needed return __main;} è¿›å…¥_CFRunLoopGet0 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051// should only be called by Foundation// t==0 is a synonym for &quot;main thread&quot; that always worksCF_EXPORT CFRunLoopRef _CFRunLoopGet0(pthread_t t) { //å¦‚æœtä¸å­˜åœ¨ï¼Œåˆ™æ ‡è®°ä¸ºä¸»çº¿ç¨‹ï¼ˆå³é»˜è®¤æƒ…å†µï¼Œé»˜è®¤æ˜¯ä¸»çº¿ç¨‹ï¼‰ if (pthread_equal(t, kNilPthreadT)) { t = pthread_main_thread_np(); } __CFSpinLock(&amp;loopsLock); if (!__CFRunLoops) { __CFSpinUnlock(&amp;loopsLock); //åˆ›å»ºå…¨å±€å­—å…¸ï¼Œæ ‡è®°ä¸ºkCFAllocatorSystemDefault CFMutableDictionaryRef dict = CFDictionaryCreateMutable(kCFAllocatorSystemDefault, 0, NULL, &amp;kCFTypeDictionaryValueCallBacks); //é€šè¿‡ä¸»çº¿ç¨‹ åˆ›å»ºä¸»è¿è¡Œå¾ªç¯ CFRunLoopRef mainLoop = __CFRunLoopCreate(pthread_main_thread_np()); //åˆ©ç”¨dictï¼Œè¿›è¡Œkey-valueç»‘å®šæ“ä½œï¼Œå³å¯ä»¥è¯´æ˜ï¼Œçº¿ç¨‹å’Œrunloopæ˜¯ä¸€ä¸€å¯¹åº”çš„ // dict : key value CFDictionarySetValue(dict, pthreadPointer(pthread_main_thread_np()), mainLoop); if (!OSAtomicCompareAndSwapPtrBarrier(NULL, dict, (void * volatile *)&amp;__CFRunLoops)) { CFRelease(dict); } CFRelease(mainLoop); __CFSpinLock(&amp;loopsLock); } //é€šè¿‡å…¶ä»–çº¿ç¨‹è·å–runloop CFRunLoopRef loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t)); __CFSpinUnlock(&amp;loopsLock); if (!loop) { //å¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œåˆ™æ–°å»ºä¸€ä¸ªè¿è¡Œå¾ªç¯ CFRunLoopRef newLoop = __CFRunLoopCreate(t); __CFSpinLock(&amp;loopsLock); loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t)); if (!loop) { //å°†æ–°å»ºçš„runloop ä¸ çº¿ç¨‹è¿›è¡Œkey-valueç»‘å®š CFDictionarySetValue(__CFRunLoops, pthreadPointer(t), newLoop); loop = newLoop; } // don't release run loops inside the loopsLock, because CFRunLoopDeallocate may end up taking it __CFSpinUnlock(&amp;loopsLock); CFRelease(newLoop); } if (pthread_equal(t, pthread_self())) { _CFSetTSD(__CFTSDKeyRunLoop, (void *)loop, NULL); if (0 == _CFGetTSD(__CFTSDKeyRunLoopCntr)) { _CFSetTSD(__CFTSDKeyRunLoopCntr, (void *)(PTHREAD_DESTRUCTOR_ITERATIONS-1), (void (*)(void *))__CFFinalizeRunLoop); } } return loop;} ä»è¿™é‡Œå¯ä»¥è¯´æ˜ï¼ŒRunloopåªæœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯ä¸»çº¿ç¨‹çš„ï¼Œ ä¸€ä¸ªæ˜¯å…¶ä»–çº¿ç¨‹çš„ã€‚å³runloopå’Œçº¿ç¨‹æ˜¯ä¸€ä¸€å¯¹åº”çš„ 2.2.2 RunLoopçš„åˆ›å»ºè¿›å…¥__CFRunLoopCreateæºç ï¼Œå…¶ä¸­ä¸»è¦æ˜¯å¯¹runloopå±æ€§çš„èµ‹å€¼æ“ä½œ 12345678910111213141516171819202122232425262728293031323334static CFRunLoopRef __CFRunLoopCreate(pthread_t t) { CFRunLoopRef loop = NULL; CFRunLoopModeRef rlm; uint32_t size = sizeof(struct __CFRunLoop) - sizeof(CFRuntimeBase); loop = (CFRunLoopRef)_CFRuntimeCreateInstance(kCFAllocatorSystemDefault, __kCFRunLoopTypeID, size, NULL); //å¦‚æœloopä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å›NULL if (NULL == loop) { return NULL; } //runloopå±æ€§é…ç½® (void)__CFRunLoopPushPerRunData(loop); __CFRunLoopLockInit(&amp;loop-&gt;_lock); loop-&gt;_wakeUpPort = __CFPortAllocate(); if (CFPORT_NULL == loop-&gt;_wakeUpPort) HALT; __CFRunLoopSetIgnoreWakeUps(loop); loop-&gt;_commonModes = CFSetCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeSetCallBacks); CFSetAddValue(loop-&gt;_commonModes, kCFRunLoopDefaultMode); loop-&gt;_commonModeItems = NULL; loop-&gt;_currentMode = NULL; loop-&gt;_modes = CFSetCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeSetCallBacks); loop-&gt;_blocks_head = NULL; loop-&gt;_blocks_tail = NULL; loop-&gt;_counterpart = NULL; loop-&gt;_pthread = t;#if DEPLOYMENT_TARGET_WINDOWS loop-&gt;_winthread = GetCurrentThreadId();#else loop-&gt;_winthread = 0;#endif rlm = __CFRunLoopFindMode(loop, kCFRunLoopDefaultMode, true); if (NULL != rlm) __CFRunLoopModeUnlock(rlm); return loop;} è¿›å…¥CFRunLoopRefçš„å®šä¹‰,æ ¹æ®å®šä¹‰å¾—çŸ¥ï¼Œå…¶å®RunLoopä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚æ˜¯__CFRunLoopç»“æ„ä½“çš„æŒ‡é’ˆç±»å‹ 123456789101112131415161718typedef struct __CFRunLoop * CFRunLoopRef;ğŸ‘‡struct __CFRunLoop { CFRuntimeBase _base; pthread_mutex_t _lock; /* locked for accessing mode list */ __CFPort _wakeUpPort; // used for CFRunLoopWakeUp Boolean _unused; volatile _per_run_data *_perRunData; // reset for runs of the run loop pthread_t _pthread; uint32_t _winthread; CFMutableSetRef _commonModes; CFMutableSetRef _commonModeItems; CFRunLoopModeRef _currentMode; CFMutableSetRef _modes; struct _block_item *_blocks_head; struct _block_item *_blocks_tail; CFTypeRef _counterpart;}; ä»å®šä¹‰ä¸­å¯ä»¥å¾—å‡ºï¼Œä¸€ä¸ªRunLoopä¾èµ–äºå¤šä¸ªModeï¼Œæ„å‘³ç€ä¸€ä¸ªRunLoopéœ€è¦å¤„ç†å¤šä¸ªäº‹åŠ¡ï¼Œå³ä¸€ä¸ªModeå¯¹åº”å¤šä¸ªItemï¼Œè€Œä¸€ä¸ªitemä¸­ï¼ŒåŒ…å«äº†timerã€sourceã€observerï¼Œå¦‚ä¸‹æ‰€ç¤º Modeç±»å‹ å…¶ä¸­modeåœ¨è‹¹æœæ–‡æ¡£ä¸­æåŠçš„æœ‰äº”ä¸ªï¼Œè€Œåœ¨iOSä¸­å…¬å¼€æš´éœ²å‡ºæ¥çš„åªæœ‰ NSDefaultRunLoopMode å’Œ NSRunLoopCommonModesã€‚ NSRunLoopCommonModes å®é™…ä¸Šæ˜¯ä¸€ä¸ª Mode çš„é›†åˆï¼Œé»˜è®¤åŒ…æ‹¬ NSDefaultRunLoopMode å’Œ NSEventTrackingRunLoopModeã€‚ NSDefaultRunLoopModeï¼šé»˜è®¤çš„modeï¼Œæ­£å¸¸æƒ…å†µä¸‹éƒ½æ˜¯åœ¨è¿™ä¸ªmode NSConnectionReplyMode NSModalPanelRunLoopMode NSEventTrackingRunLoopModeï¼šä½¿ç”¨è¿™ä¸ªModeå»è·Ÿè¸ªæ¥è‡ªç”¨æˆ·äº¤äº’çš„äº‹ä»¶ï¼ˆæ¯”å¦‚UITableViewä¸Šä¸‹æ»‘åŠ¨ï¼‰ NSRunLoopCommonModesï¼šä¼ªæ¨¡å¼ï¼Œçµæ´»æ€§æ›´å¥½ Source &amp; Timer &amp; Observer Sourceè¡¨ç¤ºå¯ä»¥å”¤é†’RunLoopçš„ä¸€äº›äº‹ä»¶ï¼Œä¾‹å¦‚ç”¨æˆ·ç‚¹å‡»äº†å±å¹•ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªRunLoopï¼Œä¸»è¦åˆ†ä¸ºSource0å’ŒSource1 Source0 è¡¨ç¤º éç³»ç»Ÿäº‹ä»¶ï¼Œå³ç”¨æˆ·è‡ªå®šä¹‰çš„äº‹ä»¶ Source1 è¡¨ç¤ºç³»ç»Ÿäº‹ä»¶ï¼Œä¸»è¦è´Ÿè´£åº•å±‚çš„é€šè®¯ï¼Œå…·å¤‡å”¤é†’èƒ½åŠ› Timer å°±æ˜¯å¸¸ç”¨NSTimerå®šæ—¶å™¨è¿™ä¸€ç±» Observer ä¸»è¦ç”¨äºç›‘å¬RunLoopçš„çŠ¶æ€å˜åŒ–ï¼Œå¹¶ä½œå‡ºä¸€å®šå“åº”ï¼Œä¸»è¦æœ‰ä»¥ä¸‹ä¸€äº›çŠ¶æ€ 123456789101112131415typedef CF_OPTIONS(CFOptionFlags, CFRunLoopActivity) { //è¿›å…¥RunLoop kCFRunLoopEntry = (1UL &lt;&lt; 0), //å³å°†å¤„ç†Timers kCFRunLoopBeforeTimers = (1UL &lt;&lt; 1), //å³å°†å¤„ç†Source kCFRunLoopBeforeSources = (1UL &lt;&lt; 2), //å³å°†è¿›å…¥ä¼‘çœ  kCFRunLoopBeforeWaiting = (1UL &lt;&lt; 5), //è¢«å”¤é†’ kCFRunLoopAfterWaiting = (1UL &lt;&lt; 6), //é€€å‡ºRunLoop kCFRunLoopExit = (1UL &lt;&lt; 7), kCFRunLoopAllActivities = 0x0FFFFFFFU}; éªŒè¯ï¼šRunLoopå’Œmodeæ˜¯ä¸€å¯¹å¤š ä¸‹é¢ï¼Œé€šè¿‡ä¸Šé¢çš„ä»£ç è°ƒè¯•æ¥éªŒè¯æˆ‘ä»¬ä¸Šé¢æåŠçš„å…³ç³» é€šè¿‡lldbå‘½ä»¤è·å–mainRunloopã€currentRunloopçš„currentMode po CFRunLoopCopyCurrentMode(mainRunloop) po CFRunLoopCopyCurrentMode(currentRunloop) ä»è¿™é‡Œï¼Œå¯ä»¥è¯´æ˜ï¼Œrunloopåœ¨è¿è¡Œæ—¶çš„modeåªæœ‰ä¸€ä¸ª è·å–mainRunloopçš„æ‰€æœ‰æ¨¡å‹ï¼Œå³po CFRunLoopCopyAllModes(mainRunloop) ä»ç»“æœå¯ä»¥éªŒè¯runloop å’Œ CFRunloopMode å…·æœ‰ ä¸€å¯¹å¤šçš„å…³ç³» éªŒè¯ï¼šmodeå’ŒItemä¹Ÿæ˜¯ä¸€å¯¹å¤š åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼ŒåŠ æ–­ç‚¹ï¼Œé€šè¿‡btæŸ¥çœ‹å †æ ˆä¿¡æ¯ï¼Œä»è¿™é‡Œçœ‹å‡ºtimerçš„itemç±»å‹å¦‚ä¸‹æ‰€ç¤º åœ¨RunLoopæºç ä¸­æŸ¥çœ‹Itemç±»å‹ï¼Œæœ‰ä»¥ä¸‹å‡ ç§ blockåº”ç”¨:__CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__ è°ƒç”¨timer:__CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__ å“åº”source0: __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__ å“åº”source1: __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION__ GCDä¸»é˜Ÿåˆ—:__CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__ observeræº: __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__ åœ¨è¿™é‡Œä»¥Timerä¸ºä¾‹ï¼Œä¸€èˆ¬åˆå§‹åŒ–timeræ—¶ï¼Œéƒ½ä¼šå°†timeré€šaddTimer:forMode:æ–¹æ³•æ·»åŠ åˆ°Runloopä¸­ï¼Œäºæ˜¯åœ¨æºç ä¸­æŸ¥æ‰¾addTimerçš„ç›¸å…³æ–¹æ³•ï¼Œå³CFRunLoopAddTimeræ–¹æ³•ï¼Œå…¶æºç å®ç°å¦‚ä¸‹ï¼Œå…¶å®ç°ä¸»è¦åˆ¤æ–­æ˜¯å¦æ˜¯kCFRunLoopCommonModesï¼Œç„¶åæŸ¥æ‰¾runloopçš„modeè¿›è¡ŒåŒ¹é…å¤„ç† å…¶ä¸­kCFRunLoopCommonModes ä¸æ˜¯ä¸€ç§æ¨¡å¼ï¼Œæ˜¯ä¸€ç§æŠ½è±¡çš„ä¼ªæ¨¡å¼ï¼Œæ¯”defaultModeæ›´åŠ çµæ´» é€šè¿‡CFSetAddValue(rl-&gt;_commonModeItems, rlt);å¯ä»¥å¾—çŸ¥ï¼Œrunloopä¸mode æ˜¯ä¸€å¯¹å¤šçš„ï¼ŒåŒæ—¶å¯ä»¥å¾—å‡ºmode ä¸ item ä¹Ÿæ˜¯ä¸€å¯¹å¤šçš„ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465void CFRunLoopAddTimer(CFRunLoopRef rl, CFRunLoopTimerRef rlt, CFStringRef modeName) { CHECK_FOR_FORK(); if (__CFRunLoopIsDeallocating(rl)) return; if (!__CFIsValid(rlt) || (NULL != rlt-&gt;_runLoop &amp;&amp; rlt-&gt;_runLoop != rl)) return; __CFRunLoopLock(rl); // é‡ç‚¹ : kCFRunLoopCommonModes if (modeName == kCFRunLoopCommonModes) { //å¦‚æœæ˜¯kCFRunLoopCommonModes ç±»å‹ CFSetRef set = rl-&gt;_commonModes ? CFSetCreateCopy(kCFAllocatorSystemDefault, rl-&gt;_commonModes) : NULL; if (NULL == rl-&gt;_commonModeItems) { rl-&gt;_commonModeItems = CFSetCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeSetCallBacks); } //runloopä¸mode æ˜¯ä¸€å¯¹å¤šçš„ï¼Œ modeä¸itemä¹Ÿæ˜¯ä¸€å¯¹å¤šçš„ CFSetAddValue(rl-&gt;_commonModeItems, rlt); if (NULL != set) { CFTypeRef context[2] = {rl, rlt}; /* add new item to all common-modes */ //æ‰§è¡Œ CFSetApplyFunction(set, (__CFRunLoopAddItemToCommonModes), (void *)context); CFRelease(set); } } else { //å¦‚æœæ˜¯écommonModeç±»å‹ //æŸ¥æ‰¾runloopçš„æ¨¡å‹ CFRunLoopModeRef rlm = __CFRunLoopFindMode(rl, modeName, true); if (NULL != rlm) { if (NULL == rlm-&gt;_timers) { CFArrayCallBacks cb = kCFTypeArrayCallBacks; cb.equal = NULL; rlm-&gt;_timers = CFArrayCreateMutable(kCFAllocatorSystemDefault, 0, &amp;cb); } } //åˆ¤æ–­modeæ˜¯å¦åŒ¹é… if (NULL != rlm &amp;&amp; !CFSetContainsValue(rlt-&gt;_rlModes, rlm-&gt;_name)) { __CFRunLoopTimerLock(rlt); if (NULL == rlt-&gt;_runLoop) { rlt-&gt;_runLoop = rl; } else if (rl != rlt-&gt;_runLoop) { __CFRunLoopTimerUnlock(rlt); __CFRunLoopModeUnlock(rlm); __CFRunLoopUnlock(rl); return; } // å¦‚æœåŒ¹é…ï¼Œåˆ™å°†runloopåŠ è¿›å»ï¼Œè€Œrunloopçš„æ‰§è¡Œä¾èµ–äº [runloop run] CFSetAddValue(rlt-&gt;_rlModes, rlm-&gt;_name); __CFRunLoopTimerUnlock(rlt); __CFRunLoopTimerFireTSRLock(); __CFRepositionTimerInMode(rlm, rlt, false); __CFRunLoopTimerFireTSRUnlock(); if (!_CFExecutableLinkedOnOrAfter(CFSystemVersionLion)) { // Normally we don't do this on behalf of clients, but for // backwards compatibility due to the change in timer handling... if (rl != CFRunLoopGetCurrent()) CFRunLoopWakeUp(rl); } } if (NULL != rlm) { __CFRunLoopModeUnlock(rlm); } } __CFRunLoopUnlock(rl);} 2.2.3 RunLoopæ‰§è¡Œä¼—æ‰€å‘¨çŸ¥ï¼ŒRunLoopçš„æ‰§è¡Œä¾èµ–äºrunæ–¹æ³•ï¼Œä»ä¸‹é¢çš„å †æ ˆä¿¡æ¯ä¸­å¯ä»¥çœ‹å‡ºï¼Œå…¶åº•å±‚æ‰§è¡Œçš„æ˜¯__CFRunLoopRunæ–¹æ³• è¿›å…¥__CFRunLoopRunæºç ï¼Œé’ˆå¯¹ä¸åŒçš„å¯¹è±¡ï¼Œæœ‰ä¸åŒçš„å¤„ç† å¦‚æœæœ‰observerï¼Œåˆ™è°ƒç”¨ __CFRunLoopDoObservers å¦‚æœæœ‰blockï¼Œåˆ™è°ƒç”¨__CFRunLoopDoBlocks å¦‚æœæœ‰timerï¼Œåˆ™è°ƒç”¨ __CFRunLoopDoTimers å¦‚æœæ˜¯source0ï¼Œåˆ™è°ƒç”¨__CFRunLoopDoSources0 å¦‚æœæ˜¯source1ï¼Œåˆ™è°ƒç”¨__CFRunLoopDoSource1 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253/* rl, rlm are locked on entrance and exit */static int32_t __CFRunLoopRun(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFTimeInterval seconds, Boolean stopAfterHandle, CFRunLoopModeRef previousMode) { ... do{ ... //é€šçŸ¥ Observers: å³å°†å¤„ç†timeräº‹ä»¶ if (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeTimers) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeTimers); //é€šçŸ¥ Observers: å³å°†å¤„ç†Sourceäº‹ä»¶ if (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeSources) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeSources); //å¤„ç†Blocks __CFRunLoopDoBlocks(rl, rlm); //å¤„ç†sources0 Boolean sourceHandledThisLoop = __CFRunLoopDoSources0(rl, rlm, stopAfterHandle); //å¤„ç†sources0è¿”å›ä¸ºYES if (sourceHandledThisLoop) { // å¤„ç†Blocks __CFRunLoopDoBlocks(rl, rlm); } ... //å¦‚æœæ˜¯timer else if (modeQueuePort != MACH_PORT_NULL &amp;&amp; livePort == modeQueuePort) { CFRUNLOOP_WAKEUP_FOR_TIMER(); if (!__CFRunLoopDoTimers(rl, rlm, mach_absolute_time())) { // Re-arm the next timer, because we apparently fired early __CFArmNextTimerInMode(rlm, rl); } } ... //å¦‚æœæ˜¯source1 CFRunLoopSourceRef rls = __CFRunLoopModeFindSourceForMachPort(rl, rlm, livePort); if (rls) {#if DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI mach_msg_header_t *reply = NULL; sourceHandledThisLoop = __CFRunLoopDoSource1(rl, rlm, rls, msg, msg-&gt;msgh_size, &amp;reply) || sourceHandledThisLoop; if (NULL != reply) { (void)mach_msg(reply, MACH_SEND_MSG, reply-&gt;msgh_size, 0, MACH_PORT_NULL, 0, MACH_PORT_NULL); CFAllocatorDeallocate(kCFAllocatorSystemDefault, reply); }#elif DEPLOYMENT_TARGET_WINDOWS sourceHandledThisLoop = __CFRunLoopDoSource1(rl, rlm, rls) || sourceHandledThisLoop;#endif } ... }while (0 == retVal); ...} è¿›å…¥__CFRunLoopDoTimersæºç ï¼Œä¸»è¦æ˜¯é€šè¿‡forå¾ªç¯ï¼Œå¯¹å•ä¸ªtimerè¿›è¡Œå¤„ç† 12345678910static Boolean __CFRunLoopDoTimers(CFRunLoopRef rl, CFRunLoopModeRef rlm, uint64_t limitTSR) { /* DOES CALLOUT */ ... //å¾ªç¯éå†ï¼Œåšä¸‹å±‚å•ä¸ªtimerçš„æ‰§è¡Œ for (CFIndex idx = 0, cnt = timers ? CFArrayGetCount(timers) : 0; idx &lt; cnt; idx++) { CFRunLoopTimerRef rlt = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(timers, idx); Boolean did = __CFRunLoopDoTimer(rl, rlm, rlt); timerHandled = timerHandled || did; } ...} è¿›å…¥__CFRunLoopDoTimeræºç ï¼Œä¸»è¦é€»è¾‘æ˜¯timeræ‰§è¡Œå®Œæ¯•åï¼Œä¼šä¸»åŠ¨è°ƒç”¨__CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__å‡½æ•°ï¼Œæ­£å¥½ä¸timerå †æ ˆè°ƒç”¨ä¸­çš„ä¸€è‡´ 123456// mode and rl are locked on entry and exitstatic Boolean __CFRunLoopDoTimer(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFRunLoopTimerRef rlt) { ... __CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__(rlt-&gt;_callout, rlt, context_info); ...} timeræ‰§è¡Œæ€»ç»“ ä¸ºè‡ªå®šä¹‰çš„timerï¼Œè®¾ç½®Modeï¼Œå¹¶å°†å…¶åŠ å…¥RunLoopä¸­ åœ¨RunLoopçš„runæ–¹æ³•æ‰§è¡Œæ—¶ï¼Œä¼šè°ƒç”¨__CFRunLoopDoTimersæ‰§è¡Œæ‰€æœ‰timer åœ¨__CFRunLoopDoTimersæ–¹æ³•ä¸­ï¼Œä¼šé€šè¿‡forå¾ªç¯æ‰§è¡Œå•ä¸ªtimerçš„æ“ä½œ åœ¨__CFRunLoopDoTimeræ–¹æ³•ä¸­ï¼Œtimeræ‰§è¡Œå®Œæ¯•åï¼Œä¼šæ‰§è¡Œå¯¹åº”çš„timerå›è°ƒå‡½æ•° ä»¥ä¸Šï¼Œæ˜¯é’ˆå¯¹timerçš„æ‰§è¡Œåˆ†æï¼Œå¯¹äºobserverã€blockã€source0ã€source1ï¼Œå…¶æ‰§è¡ŒåŸç†ä¸timeræ˜¯ç±»ä¼¼çš„ï¼Œè¿™é‡Œå°±ä¸å†é‡å¤è¯´æ˜ä»¥ä¸‹æ˜¯è‹¹æœå®˜æ–¹æ–‡æ¡£é’ˆå¯¹RunLoopå¤„ç†ä¸åŒæºçš„å›¾ç¤º 2.2.4 RunLoop åº•å±‚åŸç†ä»ä¸Šè¿°çš„å †æ ˆä¿¡æ¯ä¸­å¯ä»¥çœ‹å‡ºï¼Œrunåœ¨åº•å±‚çš„å®ç°è·¯å¾„ä¸ºCFRunLoopRun -&gt; CFRunLoopRun -&gt; __CFRunLoopRun è¿›å…¥CFRunLoopRunæºç ï¼Œå…¶ä¸­ä¼ å…¥çš„å‚æ•°1.0e10ï¼ˆç§‘å­¦è®¡æ•°ï¼‰ ç­‰äº 1* e^10ï¼Œç”¨äºè¡¨ç¤ºè¶…æ—¶æ—¶é—´ 12345678void CFRunLoopRun(void) { /* DOES CALLOUT */ int32_t result; do { // 1.0e10 : ç§‘å­¦æŠ€æœ¯ 1*10^10 result = CFRunLoopRunSpecific(CFRunLoopGetCurrent(), kCFRunLoopDefaultMode, 1.0e10, false); CHECK_FOR_FORK(); } while (kCFRunLoopRunStopped != result &amp;&amp; kCFRunLoopRunFinished != result);} è¿›å…¥CFRunLoopRunSpecificæºç ï¼Œé¦–å…ˆæ ¹æ®modeNameæ‰¾åˆ°å¯¹åº”çš„modeï¼Œç„¶åä¸»è¦åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š å¦‚æœæ˜¯entryï¼Œåˆ™é€šçŸ¥observerï¼Œå³å°†è¿›å…¥runloop å¦‚æœæ˜¯exitï¼Œåˆ™é€šè¿‡observerï¼Œå³å°†é€€å‡ºrunloop å¦‚æœæ˜¯å…¶ä»–ä¸­é—´çŠ¶æ€ï¼Œä¸»è¦æ˜¯é€šè¿‡runloopå¤„ç†å„ç§æº å…¶ä¼ªä»£ç è¡¨ç¤ºå¦‚ä¸‹ 1234567891011121314151617181920SInt32 CFRunLoopRunSpecific(CFRunLoopRef rl, CFStringRef modeName, CFTimeInterval seconds, Boolean returnAfterSourceHandled) { /* DOES CALLOUT */ CHECK_FOR_FORK(); if (__CFRunLoopIsDeallocating(rl)) return kCFRunLoopRunFinished; __CFRunLoopLock(rl); //é¦–å…ˆæ ¹æ®modeNameæ‰¾åˆ°å¯¹åº”mode CFRunLoopModeRef currentMode = __CFRunLoopFindMode(rl, modeName, false); // é€šçŸ¥ Observers: RunLoop å³å°†è¿›å…¥ loopã€‚ __CFRunLoopDoObservers(rl, currentMode, kCFRunLoopEntry); // å†…éƒ¨å‡½æ•°ï¼Œè¿›å…¥loop result = __CFRunLoopRun(rl, currentMode, seconds, returnAfterSourceHandled, previousMode); // é€šçŸ¥ Observers: RunLoop å³å°†é€€å‡ºã€‚ __CFRunLoopDoObservers(rl, currentMode, kCFRunLoopExit); return result; } è¿›å…¥__CFRunLoopRunæºç ï¼Œç”±äºè¿™éƒ¨åˆ†ä»£ç è¾ƒå¤šï¼Œäºæ˜¯è¿™é‡Œç”¨ä¼ªä»£ç ä»£æ›¿ã€‚å…¶ä¸»è¦é€»è¾‘æ˜¯æ ¹æ®ä¸åŒçš„äº‹ä»¶æºè¿›è¡Œä¸åŒçš„å¤„ç†ï¼Œå½“RunLoopä¼‘çœ æ—¶ï¼Œå¯ä»¥é€šè¿‡ç›¸åº”çš„äº‹ä»¶å”¤é†’RunLoop 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788//æ ¸å¿ƒå‡½æ•°/* rl, rlm are locked on entrance and exit */static int32_t __CFRunLoopRun(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFTimeInterval seconds, Boolean stopAfterHandle, CFRunLoopModeRef previousMode){ //é€šè¿‡GCDå¼€å¯ä¸€ä¸ªå®šæ—¶å™¨ï¼Œç„¶åå¼€å§‹è·‘åœˆ dispatch_source_t timeout_timer = NULL; ... dispatch_resume(timeout_timer); int32_t retVal = 0; //å¤„ç†äº‹åŠ¡,å³å¤„ç†items do { // é€šçŸ¥ Observers: å³å°†å¤„ç†timeräº‹ä»¶ __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeTimers); // é€šçŸ¥ Observers: å³å°†å¤„ç†Sourceäº‹ä»¶ __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeSources) // å¤„ç†Blocks __CFRunLoopDoBlocks(rl, rlm); // å¤„ç†sources0 Boolean sourceHandledThisLoop = __CFRunLoopDoSources0(rl, rlm, stopAfterHandle); // å¤„ç†sources0è¿”å›ä¸ºYES if (sourceHandledThisLoop) { // å¤„ç†Blocks __CFRunLoopDoBlocks(rl, rlm); } // åˆ¤æ–­æœ‰æ— ç«¯å£æ¶ˆæ¯(Source1) if (__CFRunLoopWaitForMultipleObjects(NULL, &amp;dispatchPort, 0, 0, &amp;livePort, NULL)) { // å¤„ç†æ¶ˆæ¯ goto handle_msg; } // é€šçŸ¥ Observers: å³å°†è¿›å…¥ä¼‘çœ  __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeWaiting); __CFRunLoopSetSleeping(rl); // ç­‰å¾…è¢«å”¤é†’ __CFRunLoopServiceMachPort(waitSet, &amp;msg, sizeof(msg_buffer), &amp;livePort, poll ? 0 : TIMEOUT_INFINITY); // user callouts now OK again __CFRunLoopUnsetSleeping(rl); // é€šçŸ¥ Observers: è¢«å”¤é†’ï¼Œç»“æŸä¼‘çœ  __CFRunLoopDoObservers(rl, rlm, kCFRunLoopAfterWaiting); handle_msg: if (è¢«timerå”¤é†’) { // å¤„ç†Timers __CFRunLoopDoTimers(rl, rlm, mach_absolute_time())ï¼› }else if (è¢«GCDå”¤é†’){ // å¤„ç†gcd __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__(msg); }else if (è¢«source1å”¤é†’){ // è¢«Source1å”¤é†’ï¼Œå¤„ç†Source1 __CFRunLoopDoSource1(rl, rlm, rls, msg, msg-&gt;msgh_size, &amp;reply) } // å¤„ç†block __CFRunLoopDoBlocks(rl, rlm); if (sourceHandledThisLoop &amp;&amp; stopAfterHandle) { retVal = kCFRunLoopRunHandledSource;//å¤„ç†æº } else if (timeout_context-&gt;termTSR &lt; mach_absolute_time()) { retVal = kCFRunLoopRunTimedOut;//è¶…æ—¶ } else if (__CFRunLoopIsStopped(rl)) { __CFRunLoopUnsetStopped(rl); retVal = kCFRunLoopRunStopped;//åœæ­¢ } else if (rlm-&gt;_stopped) { rlm-&gt;_stopped = false; retVal = kCFRunLoopRunStopped;//åœæ­¢ } else if (__CFRunLoopModeIsEmpty(rl, rlm, previousMode)) { retVal = kCFRunLoopRunFinished;//ç»“æŸ } }while (0 == retVal); return retVal;} æ‰€ä»¥ï¼Œç»¼ä¸Šæ‰€è¿°ï¼ŒRunLoopçš„æ‰§è¡Œæµç¨‹ï¼Œå¦‚ä¸‹æ‰€ç¤º ä¸‰ã€é—®é¢˜3.1 AutoreleasePool ç›¸å…³é¢˜1ï¼šä¸´æ—¶å˜é‡ä»€ä¹ˆæ—¶å€™é‡Šæ”¾ï¼Ÿ å¦‚æœåœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸€èˆ¬æ˜¯è¶…å‡ºå…¶ä½œç”¨åŸŸå°±ä¼šç«‹å³é‡Šæ”¾ å¦‚æœå°†ä¸´æ—¶å˜é‡åŠ å…¥äº†è‡ªåŠ¨é‡Šæ”¾æ± ï¼Œä¼šå»¶è¿Ÿé‡Šæ”¾ï¼Œå³åœ¨runloopä¼‘çœ æˆ–è€…autoreleasepoolä½œç”¨åŸŸä¹‹åé‡Šæ”¾ é¢˜2ï¼šAutoreleasePoolåŸç† è‡ªåŠ¨é‡Šæ”¾æ± çš„æœ¬è´¨æ˜¯ä¸€ä¸ªAutoreleasePoolPageç»“æ„ä½“å¯¹è±¡ï¼Œæ˜¯ä¸€ä¸ªæ ˆç»“æ„å­˜å‚¨çš„é¡µï¼Œæ¯ä¸€ä¸ªAutoreleasePoolPageéƒ½æ˜¯ä»¥åŒå‘é“¾è¡¨çš„å½¢å¼è¿æ¥ è‡ªåŠ¨é‡Šæ”¾æ± çš„å‹æ ˆå’Œå‡ºæ ˆä¸»è¦æ˜¯é€šè¿‡ç»“æ„ä½“çš„æ„é€ å‡½æ•°å’Œææ„å‡½æ•°è°ƒç”¨åº•å±‚çš„objc_autoreleasePoolPushå’Œobjc_autoreleasePoolPopï¼Œå®é™…ä¸Šæ˜¯è°ƒç”¨AutoreleasePoolPageçš„pushå’Œpopä¸¤ä¸ªæ–¹æ³• æ¯æ¬¡è°ƒç”¨pushæ“ä½œå…¶å®å°±æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„AutoreleasePoolPageï¼Œè€ŒAutoreleasePoolPageçš„å…·ä½“æ“ä½œå°±æ˜¯æ’å…¥ä¸€ä¸ªPOOL_BOUNDARYï¼Œå¹¶è¿”å›æ’å…¥POOL_BOUNDARYçš„å†…å­˜åœ°å€ã€‚è€Œpushå†…éƒ¨è°ƒç”¨autoreleaseFastæ–¹æ³•å¤„ç†ï¼Œä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç§æƒ…å†µ å½“pageå­˜åœ¨ï¼Œä¸”ä¸æ»¡æ—¶ï¼Œè°ƒç”¨addæ–¹æ³•å°†å¯¹è±¡æ·»åŠ è‡³pageçš„nextæŒ‡é’ˆå¤„ï¼Œå¹¶nexté€’å¢ å½“pageå­˜åœ¨ï¼Œä¸”å·²æ»¡æ—¶ï¼Œè°ƒç”¨autoreleaseFullPageåˆå§‹åŒ–ä¸€ä¸ªæ–°çš„pageï¼Œç„¶åè°ƒç”¨addæ–¹æ³•å°†å¯¹è±¡æ·»åŠ è‡³pageæ ˆä¸­ å½“pageä¸å­˜åœ¨æ—¶ï¼Œè°ƒç”¨autoreleaseNoPageåˆ›å»ºä¸€ä¸ªhotPageï¼Œç„¶åè°ƒç”¨addæ–¹æ³•å°†å¯¹è±¡æ·»åŠ è‡³pageæ ˆä¸­ å½“æ‰§è¡Œpopæ“ä½œæ—¶ï¼Œä¼šä¼ å…¥ä¸€ä¸ªå€¼ï¼Œè¿™ä¸ªå€¼å°±æ˜¯pushæ“ä½œçš„è¿”å›å€¼ï¼Œå³POOL_BOUNDARYçš„å†…å­˜åœ°å€tokenã€‚æ‰€ä»¥popå†…éƒ¨çš„å®ç°å°±æ˜¯æ ¹æ®tokenæ‰¾åˆ°å“¨å…µå¯¹è±¡æ‰€å¤„çš„pageä¸­ï¼Œç„¶åä½¿ç”¨ objc_release é‡Šæ”¾ tokenä¹‹å‰çš„å¯¹è±¡ï¼Œå¹¶æŠŠnext æŒ‡é’ˆåˆ°æ­£ç¡®ä½ç½® é¢˜3ï¼šAutoreleasePoolèƒ½å¦åµŒå¥—ä½¿ç”¨ï¼Ÿ å¯ä»¥åµŒå¥—ä½¿ç”¨ï¼Œå…¶ç›®çš„æ˜¯å¯ä»¥æ§åˆ¶åº”ç”¨ç¨‹åºçš„å†…å­˜å³°å€¼ï¼Œä½¿å…¶ä¸è¦å¤ªé«˜ å¯ä»¥åµŒå¥—çš„åŸå› æ˜¯å› ä¸ºè‡ªåŠ¨é‡Šæ”¾æ± æ˜¯ä»¥æ ˆä¸ºèŠ‚ç‚¹ï¼Œé€šè¿‡åŒå‘é“¾è¡¨çš„å½¢å¼è¿æ¥çš„ï¼Œä¸”æ˜¯å’Œçº¿ç¨‹ä¸€ä¸€å¯¹åº”çš„ è‡ªåŠ¨é‡Šæ”¾æ± çš„å¤šå±‚åµŒå¥—å…¶å®å°±æ˜¯ä¸åœçš„pushså“¨å…µå¯¹è±¡ï¼Œåœ¨popæ—¶ï¼Œä¼šå…ˆé‡Šæ”¾é‡Œé¢çš„ï¼Œåœ¨é‡Šæ”¾å¤–é¢çš„ é¢˜4ï¼šå“ªäº›å¯¹è±¡å¯ä»¥åŠ å…¥AutoreleasePoolï¼Ÿallocåˆ›å»ºå¯ä»¥å—ï¼Ÿ ä½¿ç”¨newã€allocã€copyå…³é”®å­—ç”Ÿæˆçš„å¯¹è±¡å’Œretainäº†çš„å¯¹è±¡éœ€è¦æ‰‹åŠ¨é‡Šæ”¾ï¼Œä¸ä¼šè¢«æ·»åŠ åˆ°è‡ªåŠ¨é‡Šæ”¾æ± ä¸­ è®¾ç½®ä¸ºautoreleaseçš„å¯¹è±¡ä¸éœ€è¦æ‰‹åŠ¨é‡Šæ”¾ï¼Œä¼šç›´æ¥è¿›å…¥è‡ªåŠ¨é‡Šæ”¾æ±  æ‰€æœ‰ autorelease çš„å¯¹è±¡ï¼Œåœ¨å‡ºäº†ä½œç”¨åŸŸä¹‹åï¼Œä¼šè¢«è‡ªåŠ¨æ·»åŠ åˆ°æœ€è¿‘åˆ›å»ºçš„è‡ªåŠ¨é‡Šæ”¾æ± ä¸­ é¢˜5ï¼šAutoreleasePoolçš„é‡Šæ”¾æ—¶æœºæ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿ App å¯åŠ¨åï¼Œè‹¹æœåœ¨ä¸»çº¿ç¨‹ RunLoop é‡Œæ³¨å†Œäº†ä¸¤ä¸ª Observerï¼Œå…¶å›è°ƒéƒ½æ˜¯_wrapRunLoopWithAutoreleasePoolHandler()ã€‚ ç¬¬ä¸€ä¸ª Observer ç›‘è§†çš„äº‹ä»¶æ˜¯ Entry(å³å°†è¿›å…¥ Loop)ï¼Œå…¶å›è°ƒå†…ä¼šè°ƒç”¨ _objc_autoreleasePoolPush() åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± ã€‚å…¶ order æ˜¯ -2147483647ï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼Œä¿è¯åˆ› å»ºé‡Šæ”¾æ± å‘ç”Ÿåœ¨å…¶ä»–æ‰€æœ‰å›è°ƒä¹‹å‰ã€‚ ç¬¬äºŒä¸ª Observer ç›‘è§†äº†ä¸¤ä¸ªäº‹ä»¶: BeforeWaiting(å‡†å¤‡è¿›å…¥ä¼‘çœ ) æ—¶è°ƒç”¨ _objc_autoreleasePoolPop() å’Œ _objc_autoreleasePoolPush() é‡Šæ”¾æ—§çš„æ± å¹¶åˆ›å»ºæ–°æ± ;Exit(å³ å°†é€€å‡º Loop) æ—¶è°ƒç”¨ _objc_autoreleasePoolPop() æ¥é‡Šæ”¾è‡ªåŠ¨é‡Šæ”¾æ± ã€‚è¿™ä¸ª Observer çš„ order æ˜¯ 2147483647ï¼Œä¼˜å…ˆçº§æœ€ä½ï¼Œä¿è¯å…¶é‡Šæ”¾æ± å­å‘ç”Ÿåœ¨å…¶ä»–æ‰€æœ‰å›è°ƒä¹‹åã€‚ é¢˜6ï¼šthread å’Œ AutoreleasePoolçš„å…³ç³» åœ¨å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œæ‰¾åˆ°å¦‚ä¸‹è¯´æ˜ 1Each thread (including the main thread) maintains its own stack of NSAutoreleasePool objects (see Threads). As new pools are created, they get added to the top of the stack. When pools are deallocated, they are removed from the stack. Autoreleased objects are placed into the top autorelease pool for the current thread. When a thread terminates, it automatically drains all of the autorelease pools associated with itself. å¤§è‡´æ„æ€å¦‚ä¸‹ï¼š æ¯ä¸ªçº¿ç¨‹ï¼ŒåŒ…æ‹¬ä¸»çº¿ç¨‹åœ¨å†…éƒ½ç»´æŠ¤äº†è‡ªå·±çš„è‡ªåŠ¨é‡Šæ”¾æ± å †æ ˆç»“æ„ æ–°çš„è‡ªåŠ¨é‡Šæ”¾æ± åœ¨è¢«åˆ›å»ºæ—¶ï¼Œä¼šè¢«æ·»åŠ åˆ°æ ˆé¡¶ï¼›å½“è‡ªåŠ¨é‡Šæ”¾æ± é”€æ¯æ—¶ï¼Œä¼šä»æ ˆä¸­ç§»é™¤ å¯¹äºå½“å‰çº¿ç¨‹æ¥è¯´ï¼Œä¼šå°†è‡ªåŠ¨é‡Šæ”¾çš„å¯¹è±¡æ”¾å…¥è‡ªåŠ¨é‡Šæ”¾æ± çš„æ ˆé¡¶ï¼›åœ¨çº¿ç¨‹åœæ­¢æ—¶ï¼Œä¼šè‡ªåŠ¨é‡Šæ”¾æ‰ä¸è¯¥çº¿ç¨‹å…³è”çš„æ‰€æœ‰è‡ªåŠ¨é‡Šæ”¾æ±  æ€»ç»“ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸ä¹‹å…³è”çš„è‡ªåŠ¨é‡Šæ”¾æ± å †æ ˆç»“æ„ï¼Œæ–°çš„poolåœ¨åˆ›å»ºæ—¶ä¼šè¢«å‹æ ˆåˆ°æ ˆé¡¶ï¼Œpoolé”€æ¯æ—¶ï¼Œä¼šè¢«å‡ºæ ˆï¼Œå¯¹äºå½“å‰çº¿ç¨‹æ¥è¯´ï¼Œé‡Šæ”¾å¯¹è±¡ä¼šè¢«å‹æ ˆåˆ°æ ˆé¡¶ï¼Œçº¿ç¨‹åœæ­¢æ—¶ï¼Œä¼šè‡ªåŠ¨é‡Šæ”¾ä¸ä¹‹å…³è”çš„è‡ªåŠ¨é‡Šæ”¾æ±  é¢˜7ï¼šRunLoop å’Œ AutoreleasePoolçš„å…³ç³» åœ¨å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œæ‰¾åˆ°å¦‚ä¸‹è¯´æ˜ 1The Application Kit creates an autorelease pool on the main thread at the beginning of every cycle of the event loop, and drains it at the end, thereby releasing any autoreleased objects generated while processing an event. å¤§è‡´æ„æ€å¦‚ä¸‹ï¼š ä¸»ç¨‹åºçš„RunLoopåœ¨æ¯æ¬¡äº‹ä»¶å¾ªç¯ä¹‹å‰ä¹‹å‰ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª autoreleasePool å¹¶ä¸”ä¼šåœ¨äº‹ä»¶å¾ªç¯ç»“æŸæ—¶ï¼Œæ‰§è¡Œdrainæ“ä½œï¼Œé‡Šæ”¾å…¶ä¸­çš„å¯¹è±¡ 3.2 RunLoopç›¸å…³é¢˜1ï¼šå½“å‰æœ‰ä¸ªå­çº¿ç¨‹ï¼Œå­çº¿ç¨‹ä¸­æœ‰ä¸ªtimerã€‚timeræ˜¯å¦èƒ½å¤Ÿæ‰§è¡Œ å¹¶è¿›è¡ŒæŒç»­çš„æ‰“å°ï¼Ÿ 12345678910111213141516CJLThread *thread = [[CJLThread alloc] initWithBlock:^{ // thread.name = nil å› ä¸ºè¿™ä¸ªå˜é‡åªæ˜¯æ•æ‰ // CJLThread *thread = nil // thread = åˆå§‹åŒ– æ•æ‰ä¸€ä¸ªnilè¿›æ¥ NSLog(@&quot;%@---%@&quot;,[NSThread currentThread],[[NSThread currentThread] name]); [NSTimer scheduledTimerWithTimeInterval:1 repeats:YES block:^(NSTimer * _Nonnull timer) { NSLog(@&quot;hello word&quot;); // é€€å‡ºçº¿ç¨‹--ç»“æœrunloopä¹Ÿåœæ­¢äº† if (self.isStopping) { [NSThread exit]; } }]; }]; thread.name = @&quot;lgcode.com&quot;; [thread start]; ä¸å¯ä»¥ï¼Œå› ä¸ºå­çº¿ç¨‹çš„runloopé»˜è®¤ä¸å¯åŠ¨ï¼Œ éœ€è¦runloop runå¯åŠ¨ï¼Œéœ€è¦å°†ä¸Šè¿°ä»£ç æ”¹æˆä¸‹é¢è¿™æ ·ï¼š 123456789101112131415161718//æ”¹æˆ CJLThread *thread = [[CJLThread alloc] initWithBlock:^{ // thread.name = nil å› ä¸ºè¿™ä¸ªå˜é‡åªæ˜¯æ•æ‰ // CJLThread *thread = nil // thread = åˆå§‹åŒ– æ•æ‰ä¸€ä¸ªnilè¿›æ¥ NSLog(@&quot;%@---%@&quot;,[NSThread currentThread],[[NSThread currentThread] name]); [NSTimer scheduledTimerWithTimeInterval:1 repeats:YES block:^(NSTimer * _Nonnull timer) { NSLog(@&quot;hello word&quot;); // é€€å‡ºçº¿ç¨‹--ç»“æœrunloopä¹Ÿåœæ­¢äº† if (self.isStopping) { [NSThread exit]; } }]; [[NSRunLoop currentRunLoop] run];}];thread.name = @&quot;lgcode.com&quot;;[thread start]; é¢˜2ï¼šRunLoopå’Œçº¿ç¨‹çš„å…³ç³» æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªä¸ä¹‹å¯¹åº”çš„RunLoopï¼Œæ‰€ä»¥RunLoopä¸çº¿ç¨‹æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå…¶ç»‘å®šå…³ç³»é€šè¿‡ä¸€ä¸ªå…¨å±€çš„DIctionaryå­˜å‚¨ï¼Œçº¿ç¨‹ä¸ºkeyï¼Œrunloopä¸ºvalueã€‚ çº¿ç¨‹ä¸­çš„RunLoopä¸»è¦æ˜¯ç”¨æ¥ç®¡ç†çº¿ç¨‹çš„ï¼Œå½“çº¿ç¨‹çš„RunLoopå¼€å¯åï¼Œä¼šåœ¨æ‰§è¡Œå®Œä»»åŠ¡åè¿›è¡Œä¼‘çœ çŠ¶æ€ï¼Œå½“æœ‰äº‹ä»¶è§¦å‘å”¤é†’æ—¶ï¼Œåˆå¼€å§‹å·¥ä½œï¼Œå³æœ‰æ´»æ—¶å¹²æ´»ï¼Œæ²¡æ´»å°±ä¼‘æ¯ ä¸»çº¿ç¨‹çš„RunLoopæ˜¯é»˜è®¤å¼€å¯çš„ï¼Œåœ¨ç¨‹åºå¯åŠ¨ä¹‹åï¼Œä¼šä¸€ç›´è¿è¡Œï¼Œä¸ä¼šé€€å‡º å…¶ä»–çº¿ç¨‹çš„RunLoopé»˜è®¤æ˜¯ä¸å¼€å¯çš„ï¼Œå¦‚æœéœ€è¦ï¼Œåˆ™æ‰‹åŠ¨å¼€å¯ é¢˜3ï¼šNSRunLoop å’Œ CFRunLoopRef åŒºåˆ« NSRunLoopæ˜¯åŸºäºCFRunLoopRefé¢å‘å¯¹è±¡çš„APIï¼Œæ˜¯ä¸å®‰å…¨çš„ CFRunLoopRefæ˜¯åŸºäºCè¯­è¨€ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„ é¢˜4ï¼šRunloopçš„modeä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ modeä¸»è¦æ˜¯ç”¨äºæŒ‡å®šRunLoopä¸­äº‹ä»¶ä¼˜å…ˆçº§çš„ é¢˜5ï¼šä»¥+scheduledTimerWithTimeInterval:çš„æ–¹å¼è§¦å‘çš„timerï¼Œåœ¨æ»‘åŠ¨é¡µé¢ä¸Šçš„åˆ—è¡¨æ—¶ï¼Œtimerä¼šæš‚åœå›è°ƒï¼Œ ä¸ºä»€ä¹ˆï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ timeråœæ­¢çš„åŸå› æ˜¯å› ä¸ºæ»‘åŠ¨scrollViewæ—¶ï¼Œä¸»çº¿ç¨‹çš„RunLoopä¼šä»NSDefaultRunLoopModeåˆ‡æ¢åˆ°UITrackingRunLoopModeï¼Œè€Œtimeræ˜¯æ·»åŠ åœ¨NSDefaultRunLoopModeã€‚æ‰€ä»¥timerä¸ä¼šæ‰§è¡Œ å°†timeræ”¾å…¥NSRunLoopCommonModesä¸­æ‰§è¡Œ PSæˆ‘çš„autoreleaseæºç  æˆ‘çš„runloopæºç  å‚è€ƒiOS-åº•å±‚åŸç† 33ï¼šå†…å­˜ç®¡ç†ï¼ˆä¸‰ï¼‰","link":"/2021/07/19/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/24-AutoReleasePool%20&%20NSRunLoop/"},{"title":"ã€Šå¤§å‚ç›´ç¾ã€‹è§‚åæ„Ÿ","text":"è®¤çœŸçœ‹å®Œä¸‰é›†ä¹‹åï¼Œæœ‰å¾ˆå¤šæƒ³è¯´çš„ã€‚ é¦–å…ˆæ˜¯å¯¹äºç½‘é£æ‹æ‘„çš„è¿™éƒ¨çºªå½•ç‰‡çš„åæ§½ï¼Œä¸ªäººæ„Ÿè§‰è´¨é‡ä¸€èˆ¬ï¼Œä¸€ä¸ªæ˜æ˜¾çš„æ§½ç‚¹å°±æ˜¯æœ‰äº›åœºæ™¯ä¸‹å‡»çƒçš„é…éŸ³å¤ªå‡äº†ï¼Œè¿˜æœ‰è¿™ä¸ªæ»¤é•œä¹Ÿä¸æ˜¯å¾ˆå–œæ¬¢ï¼Œåƒè’™äº†ä¸€å±‚çº±æˆ–è€…æ¶‚äº†ä¸€å±‚ç²‰ã€‚ åæ§½å½’åæ§½ï¼Œçœ‹çºªå½•ç‰‡è¿½æ±‚çš„æ˜¯çœŸå®ä»¥åŠçœ‹åè‡ªå·±çš„æ„Ÿæ‚Ÿã€‚ ä¹‹å‰å¯¹äºå¤§å‚ç›´ç¾äº†è§£ä¸å¤šï¼Œä»…çœ‹è¿‡å¥¹å’Œå°å¨2018ç¾ç½‘å•æ‰“å†³èµ›çš„ HLï¼Œå½“æ—¶å¥¹ç»™æˆ‘çš„æ„Ÿè§‰å°±æ˜¯å†·é™å’Œæ¸©æŸ”ï¼Œçƒæ¥ä¸åˆ°ï¼ŒOKæˆ‘æ ¹æœ¬ä¸è´¹é‚£ä¸ªåŠ›æ°”å»è¿½ï¼Œè¯¥ä¸¢çš„åˆ†å°±ä¸¢å§ã€‚è™½ç„¶å¥¹ä¹Ÿä¼šæœ‰éå¸¸æ¿€åŠ¨çš„æ—¶å€™ï¼Œä½†æ˜¯ç›¸æ¯”èµ·å…¶ä»–é€‰æ‰‹æ¥è¯´å†…æ•›å¾ˆå¤šï¼Œä¹Ÿæ˜¯å› æ­¤è®°ä½äº†å¥¹ã€‚ çœ‹å®Œè¿™éƒ¨çºªå½•ç‰‡ä¹‹åæ˜ç™½äº†åŸæ¥å¤§å‚ç›´ç¾ä¸€ç›´éƒ½æ˜¯è¿™æ ·æ²‰é»˜ã€å®‰é™ã€‚4å²å¼€å§‹æ‰“ç½‘çƒï¼Œå¥¹è¯´å¥¹çˆ¶äº²ä¸å–œæ¬¢ä¸å…¶ä»–å®¶é•¿é—²è°ˆï¼Œç”±æ­¤å¯ä»¥çœ‹å‡ºå¥¹çš„æ€§æ ¼ä¸€æ–¹é¢ä¹Ÿæ˜¯å—åˆ°äº†å®¶åº­çš„å½±å“ã€‚ç½‘çƒæ˜¯ä¸€ä¸ªäººçš„æˆ˜æ–—ï¼Œæœ‰æ—¶å€™å¾ˆå­¤ç‹¬ï¼Œä½†æ˜¯ä½ èƒ½åšçš„ä¹Ÿåªæœ‰å­¤ç‹¬çš„ä¸“æ³¨ã€‚ åœ¨å¤§å‚ç›´ç¾å­¤ç‹¬ã€æ²‰é»˜ã€ä¸å—å…³æ³¨çš„æ—¶å€™ï¼Œå¥¹çš„ç½‘çƒæŠ€æœ¯æ—¥è¶‹å®Œç¾ï¼Œè¿™ä¹Ÿä½¿å¾—å¥¹èƒ½å¤Ÿæˆ˜èƒœå¦‚æ—¥ä¸­å¤©çš„å°å¨ï¼Œéœæ—¶ä¸€åˆ‡éƒ½ä¸å†å®‰é™äº†ã€‚æœ‰å¤ªå¤šæ–°é²œç¯å¢ƒå’Œå£°éŸ³åœ¨åˆºæ¿€è¿™ä½æ–°æ™‹ç¾ç½‘å† å†›ï¼Œä½œä¸ºä¸€ä¸ªä¸æ€ä¹ˆçˆ±è¡¨è¾¾ï¼Œåªæ˜¯å®‰é™æ‰“çƒçš„å°å¥³ç”Ÿè€Œè¨€ï¼Œå¾ˆéš¾å¹³è¡¡å¥½å¤–ç•Œç»™å¥¹çš„å‹åŠ›å’Œè‡ªå·±çš„æ—¥å¸¸è®­ç»ƒã€‚å¥¹ä¸çŸ¥é“è¿™ä¸ªæ—¶å€™è‡ªå·±è¯¥åšä»€ä¹ˆäº†ï¼Œæ˜¯å»å°è¯•ä»æ¥æ²¡ä½“ä¼šè¿‡çš„å…‰é²œç”Ÿæ´»è¿˜æ˜¯åšäººä»¬æœŸæœ›å¥¹åšçš„é‚£æ ·ï¼Œç»§ç»­åšä¸€ä¸ªâ€œæœ¬åˆ†â€çš„èŒä¸šé€‰æ‰‹å‘¢ï¼Ÿæ²¡æœ‰äººä¼šä¸ºè¿™ä¸€åˆ‡åšå¥½å‡†å¤‡ï¼Œå°¤å…¶æ˜¯é¢å¯¹è¿™æ ·åºå¤§åˆææ€–çš„æ— çŸ¥ç¾¤ä¼—ã€‚ ä»æˆ‘ç°åœ¨çš„è§’åº¦æ¥çœ‹ï¼Œè¿™ç§æ—¶å€™æœ€ä¸åº”è¯¥å…³æ³¨çš„å°±æ˜¯ç¾¤ä¼—ï¼Œç¾¤ä¼—æ˜¯æ— çŸ¥ã€ä½æ™ºå•†çš„ï¼Œä»–ä»¬åŒ–èº«å¼ºå¤§çš„é»‘è‰²é£æš´è£¹æŒŸç€ä½ ï¼Œæ­¤æ—¶æ­¤åˆ»åº”è¯¥æ‰¾å¥½è‡ªå·±çš„é¿é£æ¸¯ï¼Œå…å—è¿«å®³ã€‚ åœ¨å…¬å¸ƒã€Šå¤§å‚ç›´ç¾ã€‹è¿™éƒ¨çºªå½•ç‰‡ä¸Šæ˜ çš„ä¸€ç¯‡å¾®åšä¸‹é¢ï¼Œæˆ‘çŸåˆ°äº†ä¸¤çœ¼å‡¶æ‰‹ä»¬çš„â€œå‡¶å™¨â€ï¼Œæ— éæ˜¯è´¨ç–‘ä¸ä¼šè¯´æ—¥è¯­çš„ç¾ç±é»‘äººæ€ä¹ˆèƒ½ä»£è¡¨æ—¥æœ¬ã€ä¸æ¥å—é‡‡è®¿æœ‰ä»€ä¹ˆèµ„æ ¼æ‰“çƒï¼Œé€€èµ›å§ä¹‹ç±»çš„ã€‚æ²¡é”™ï¼Œæ— è®ºè¿‡äº†å¤šä¹…ï¼Œä¹Œåˆä¹‹ä¼—ä¸€ç›´éƒ½åœ¨ï¼Œæ‰€ä»¥æˆ‘é©¬ä¸Šæ»‘åŠ¨è¿”å›ï¼Œè¿”è¿˜è¿™æˆ¾æ°”å……æ–¥çš„æˆ˜åœºç»™ä»–ä»¬ã€‚é¢å¯¹è¿™ç§ï¼Œè¦ä¹ˆæŠŠä»–ä»¬å½“åšè¼èšä¸åˆ†æ•£ä¸€ç‚¹ç²¾åŠ›åœ¨ä»–ä»¬èº«ä¸Šï¼Œè¦ä¹ˆæŠŠä»–ä»¬ä¸ºå·±æ‰€ç”¨ã€‚ æ¬£æ…°çš„æ˜¯ï¼Œç»å†äº†è¿™äº›çš„å¤§å‚ç›´ç¾æˆé•¿äº†ï¼Œå¥¹èµ°å‘å† å†›çš„æ­¥ä¼æ²¡æœ‰åœé¡¿ï¼Œæ¸©æŸ”æ²‰é™çš„å¤–è¡¨ä¸‹å·²ç„¶å¸¦æœ‰å±‚å±‚å å çš„æŠ¤ç”²ã€‚","link":"/2021/07/19/%E8%A7%82%E5%BD%B1%E7%AC%94%E8%AE%B0/%E3%80%8A%E5%A4%A7%E5%9D%82%E7%9B%B4%E7%BE%8E%E3%80%8B%E8%A7%82%E5%90%8E%E6%84%9F/"},{"title":"Hexo é…ç½®","text":"ä¸€ã€å‡çº§ä¸»é¢˜1.ä½¿ç”¨ 1sudo npm install -g npm-upgrade å’Œ 123ncu -u // è‡ªåŠ¨æ›´æ–°æ‰€æœ‰æ’ä»¶æˆ–è€… npm-upgrade // æ‰‹åŠ¨é€‰æ‹©æ’ä»¶æ›´æ–° æ¥å‡çº§Hexoä¸­çš„æ’ä»¶ 2.ä¿å­˜ 1npm update -g 1npm update --save 3.å®‰è£…é…ç½®ä¸»é¢˜ 1npm install hexo-theme-icarus 1hexo config theme icarus 4.æ ¹æ®æç¤ºå®‰è£…ç¼ºå°‘æˆ–è€…éœ€è¦æ›´æ–°çš„ä¸œè¥¿ 5.å†æ¬¡é…ç½®ä¸»é¢˜ 1hexo config theme icarus è¿™ä¸ªæ—¶å€™åº”è¯¥æç¤ºé…ç½®æˆåŠŸäº† 6.æœ¬åœ°å¯åŠ¨çœ‹çœ‹ 1hexo s äºŒã€Icarus é…ç½®2.1 åŸºç¡€é…ç½®ä¿®æ”¹é€šè¿‡ä¿®æ”¹ä¸»é¢˜çš„å…¨å±€é…ç½®æ–‡ä»¶_config.icarus.yml 2.2 ä¿®æ”¹åšå®¢ä¸ºï¼šä¸»é¡µä¸‰æ ï¼Œæ–‡ç« é¡µä¸¤æ æ‰¾åˆ°hexo-theme-icarusæ–‡ä»¶å¤¹ï¼Œåœ¨æ­¤ç›®å½•ä¸‹æ·»åŠ _config.post.ymlæ–‡ä»¶å¹¶é…ç½®ï¼š 123456789101112widgets: - # Where should the widget be placed, left sidebar or right sidebar position: left type: toc # Whether to show the index of each heading index: false # Whether to collapse sub-headings when they are out-of-view collapsed: true # Maximum level of headings to show (1-6) depth: 6 2.3 ä¸»é¢˜è¿›è¡Œ cdn åŠ é€Ÿæœç´¢å¹¶æ‰¾åˆ°cdn.jsæ–‡ä»¶ï¼Œå¹¶ä¿®æ”¹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839/** * @private */// åŸæ¥çš„// const PROVIDERS = {// LIBRARY: {// cdnjs: '[cdnjs]https://cdnjs.cloudflare.com/ajax/libs/${ package }/${ version }/${ filename }',// loli: '[cdnjs]https://cdnjs.loli.net/ajax/libs/${ package }/${ version }/${ filename }',// jsdelivr: 'https://cdn.jsdelivr.net/npm/${ package }@${ version }/${ filename }',// unpkg: 'https://unpkg.com/${ package }@${ version }/${ filename }'// },// FONT: {// google: 'https://fonts.googleapis.com/${ type }?family=${ fontname }',// loli: 'https://fonts.loli.net/${ type }?family=${ fontname }'// },// ICON: {// loli: 'https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css',// fontawesome: 'https://use.fontawesome.com/releases/v5.12.0/css/all.css'// }// };// æ”¹ä¸ºï¼šconst PROVIDERS = { LIBRARY: { // cdnjs: '[cdnjs]https://cdnjs.cloudflare.com/ajax/libs/${ package }/${ version }/${ filename }', cdnjs: 'https://cdnjs.loli.net/ajax/libs/${ package }/${ version }/${ filename }', loli: '[cdnjs]https://cdnjs.loli.net/ajax/libs/${ package }/${ version }/${ filename }', jsdelivr: 'https://cdn.jsdelivr.net/npm/${ package }@${ version }/${ filename }', unpkg: 'https://unpkg.com/${ package }@${ version }/${ filename }' }, FONT: { google: 'https://fonts.loli.net/${ type }?family=${ fontname }', loli: 'https://fonts.loli.net/${ type }?family=${ fontname }' }, ICON: { loli: 'https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css', fontawesome: 'https://cdnjs.loli.net/ajax/libs/font-awesome/5.4.1/css/all.min.css' }}; 2.4 ä¿®æ”¹æ–‡ç« é¡µçš„å®½åº¦æ‰¾åˆ°layout.jsxæ–‡ä»¶ is-9-widescreen ä¸­çš„ 9 å°±æ˜¯å®½åº¦æ¯”ä¾‹ï¼Œé»˜è®¤ä¸º 8 12'is-8-tablet is-8-desktop is-9-widescreen': columnCount === 2, 'is-8-tablet is-8-desktop is-6-widescreen': columnCount === 3","link":"/2020/12/16/%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE/Hexo%20%E9%85%8D%E7%BD%AE/"},{"title":"JsDelivrå›¾åºŠè¾¾åˆ°50MBä¸Šé™çš„è§£å†³åŠæ³•","text":"ä¸€ã€ç»§ç»­ä½¿ç”¨ CDN åŠ é€Ÿåœ¨å›¾åºŠæ˜¯ GitHub + PicGo + JsDelivr çš„å›¾åºŠç¯å¢ƒä¸‹ï¼Œå¦‚æœå›¾ç‰‡åˆ°è¾¾50MB åï¼Œå°±æ— æ³•é åŸæ¥çš„åœ°å€è®¿é—®äº†ã€‚ è§£å†³æ–¹æ³•æ˜¯åœ¨ GitHub éšä¾¿å‘å¸ƒä¸€ä¸ª Releaseï¼Œç„¶åæŠŠ 1234567/ ä»“åº“å@åˆ†ä¹‹å /æ”¹ä¸º/ ä»“åº“å@Tagå / å³å¯ç»§ç»­ä½¿ç”¨ ä¾‹å¦‚ï¼š 1234ä¸èƒ½ä½¿ç”¨çš„ï¼šhttps://cdn.jsdelivr.net/gh/speam/blogImgs@master/v2-3c7b92a4b87ff685dbc95291decbc9c1_1440w.jpgæ”¹ä¸ºï¼šhttps://cdn.jsdelivr.net/gh/speam/blogImgs@1.0/v2-3c7b92a4b87ff685dbc95291decbc9c1_1440w.jpg äºŒã€æ”¾å¼ƒ CDN åŠ é€Ÿï¼Œç›´æ¥å…¨å­˜åˆ° GitHub ä¸Šã€é‡‡ç”¨ã€‘ä¸å¯èƒ½æ¯æ¬¡è¶…è¿‡50 MB é™åˆ¶çš„æ—¶å€™éƒ½æŒ‰ç…§ä¸Šé¢çš„æ“ä½œä¸€éï¼Œå¤ªéº»çƒ¦äº†ï¼Œæ‰€ä»¥æŠŠå›¾ç›´æ¥æ”¾åœ¨ GitHub ä¸Šã€‚ ä½†æ˜¯è¿™æ ·æœ‰ä¸ªç¼ºç‚¹å°±æ˜¯ä¸å¼€å…¨å±€ä»£ç†çš„æƒ…å†µä¸‹ï¼Œå›¾ç‰‡ä¸‹è½½éå¸¸æ…¢æˆ–è€…ç›´æ¥æ˜¾ç¤ºä¸å‡ºæ¥ï¼Œä½†ä¸ºäº†ä¿è¯å›¾ç‰‡é•¿æœŸæœ‰æ•ˆï¼Œåªèƒ½å¼€å…¨å±€ä»£ç†äº†ã€‚","link":"/2021/03/18/%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE/JsDelivr%E5%9B%BE%E5%BA%8A%E8%BE%BE%E5%88%B050MB%E4%B8%8A%E9%99%90%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/"},{"title":"25-ç•Œé¢ä¼˜åŒ–","text":"ä¸€ã€CPU å’Œ GPUCPU è´Ÿè´£ï¼š å¯¹è±¡çš„åˆ›å»ºå’Œé”€æ¯ã€å¯¹è±¡å±æ€§çš„è°ƒæ•´ã€å¸ƒå±€è®¡ç®—ã€æ–‡æœ¬çš„è®¡ç®—å’Œæ’ç‰ˆã€å›¾ç‰‡çš„æ ¼å¼è½¬æ¢å’Œè§£ç ã€å›¾åƒçš„ç»˜åˆ¶ GPU è´Ÿè´£ï¼š çº¹ç†çš„æ¸²æŸ“ GPU æ¸²æŸ“æµç¨‹ï¼š äºŒã€å¦‚ä½•å‡å°‘å¡é¡¿å¸ƒå±€ç›¸å…³ï¼š å°½é‡ç”¨è½»é‡çº§çš„å¯¹è±¡ï¼Œæ¯”å¦‚ç”¨ä¸åˆ°äº‹ä»¶å¤„ç†çš„åœ°æ–¹ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨CALayerå–ä»£UIView ä¸è¦é¢‘ç¹åœ°ä¿®æ”¹UIViewçš„ç›¸å…³å±æ€§ï¼Œæ¯”å¦‚frameã€boundsã€transformç­‰å±æ€§ å°½é‡æå‰è®¡ç®—å¥½å¸ƒå±€ï¼Œåœ¨æœ‰éœ€è¦æ—¶ä¸€æ¬¡æ€§è°ƒæ•´å¯¹åº”çš„å±æ€§ï¼Œä¸è¦å¤šæ¬¡ä¿®æ”¹å±æ€§ Autolayoutä¼šæ¯”ç›´æ¥è®¾ç½®frameæ¶ˆè€—æ›´å¤šçš„CPUèµ„æº å›¾ç‰‡çš„sizeæœ€å¥½åˆšå¥½è·ŸUIImageViewçš„sizeä¿æŒä¸€è‡´ å°½é‡é¿å…çŸ­æ—¶é—´å†…å¤§é‡å›¾ç‰‡çš„æ˜¾ç¤ºï¼Œå°½å¯èƒ½å°†å¤šå¼ å›¾ç‰‡åˆæˆä¸€å¼ è¿›è¡Œæ˜¾ç¤º GPUèƒ½å¤„ç†çš„æœ€å¤§çº¹ç†å°ºå¯¸æ˜¯4096x4096ï¼Œä¸€æ—¦è¶…è¿‡è¿™ä¸ªå°ºå¯¸ï¼Œå°±ä¼šå ç”¨CPUèµ„æºè¿›è¡Œå¤„ç†ï¼Œæ‰€ä»¥çº¹ç†å°½é‡ä¸è¦è¶…è¿‡è¿™ä¸ªå°ºå¯¸ å°½é‡å‡å°‘è§†å›¾æ•°é‡å’Œå±‚æ¬¡ å‡å°‘é€æ˜çš„è§†å›¾ï¼ˆalpha&lt;1ï¼‰ï¼Œä¸é€æ˜çš„å°±è®¾ç½®opaqueä¸ºYES å°½é‡é¿å…å‡ºç°ç¦»å±æ¸²æŸ“ çº¿ç¨‹ç›¸å…³ï¼š æ§åˆ¶ä¸€ä¸‹çº¿ç¨‹çš„æœ€å¤§å¹¶å‘æ•°é‡ å°½é‡æŠŠè€—æ—¶çš„æ“ä½œæ”¾åˆ°å­çº¿ç¨‹ æ–‡æœ¬å¤„ç†ï¼ˆå°ºå¯¸è®¡ç®—ã€ç»˜åˆ¶ï¼‰ å›¾ç‰‡å¤„ç†ï¼ˆè§£ç ã€ç»˜åˆ¶ï¼‰ã€‚å›¾ç‰‡å¯ä»¥ä½¿ç”¨å­çº¿ç¨‹é¢„è§£ç ï¼Œä¸»çº¿ç¨‹æ¸²æŸ“ ä¸‰ã€ç¦»å±æ¸²æŸ“3.1 ç¦»å±æ¸²æŸ“æ¶ˆè€—æ€§èƒ½çš„åŸå›  éœ€è¦åˆ›å»ºæ–°çš„ç¼“å†²åŒº ç¦»å±æ¸²æŸ“çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œéœ€è¦å¤šæ¬¡åˆ‡æ¢ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œå…ˆæ˜¯ä»å½“å‰å±å¹•ï¼ˆOn-Screenï¼‰åˆ‡æ¢åˆ°ç¦»å±ï¼ˆOff-Screenï¼‰ï¼›ç­‰åˆ°ç¦»å±æ¸²æŸ“ç»“æŸä»¥åï¼Œå°†ç¦»å±ç¼“å†²åŒºçš„æ¸²æŸ“ç»“æœæ˜¾ç¤ºåˆ°å±å¹•ä¸Šï¼Œåˆéœ€è¦å°†ä¸Šä¸‹æ–‡ç¯å¢ƒä»ç¦»å±åˆ‡æ¢åˆ°å½“å‰å±å¹• 3.2 å“ªäº›æ“ä½œä¼šè§¦å‘ç¦»å±æ¸²æŸ“ï¼Ÿ å…‰æ …åŒ–ï¼Œlayer.shouldRasterize = YES é®ç½©ï¼Œlayer.mask åœ†è§’ï¼ŒåŒæ—¶è®¾ç½®layer.masksToBounds = YESã€layer.cornerRadiuså¤§äº0 è§£å†³ï¼šé€šè¿‡CoreGraphicsç»˜åˆ¶è£å‰ªåœ†è§’ï¼Œæˆ–è€…å«ç¾å·¥æä¾›åœ†è§’å›¾ç‰‡ é˜´å½±ï¼Œlayer.shadowXXX å¦‚æœè®¾ç½®äº†layer.shadowPathå°±ä¸ä¼šäº§ç”Ÿç¦»å±æ¸²æŸ“ å››ã€è€—ç”µä¼˜åŒ–4.1 è€—ç”µçš„æ¥æºcpu å¤„ç†ã€ç½‘ç»œã€å®šä½ã€å›¾åƒ 4.2 ä¼˜åŒ–æ–¹æ¡ˆ å°‘ç”¨å®šæ—¶å™¨ ä¼˜åŒ–I/Oæ“ä½œï¼š å°½é‡ä¸è¦é¢‘ç¹å†™å…¥å°æ•°æ®ï¼Œæœ€å¥½æ‰¹é‡ä¸€æ¬¡æ€§å†™å…¥ è¯»å†™å¤§é‡é‡è¦æ•°æ®æ—¶ï¼Œè€ƒè™‘ç”¨dispatch_ioï¼Œå…¶æä¾›äº†åŸºäºGCDçš„å¼‚æ­¥æ“ä½œæ–‡ä»¶I/Oçš„APIã€‚ç”¨dispatch_ioç³»ç»Ÿä¼šä¼˜åŒ–ç£ç›˜è®¿é—® æ•°æ®é‡æ¯”è¾ƒå¤§çš„ï¼Œå»ºè®®ä½¿ç”¨æ•°æ®åº“ï¼ˆæ¯”å¦‚SQLiteã€CoreDataï¼‰ ç½‘ç»œä¼˜åŒ–ï¼š å‡å°‘ã€å‹ç¼©ç½‘ç»œæ•°æ® å¦‚æœå¤šæ¬¡è¯·æ±‚çš„ç»“æœæ˜¯ç›¸åŒçš„ï¼Œå°½é‡ä½¿ç”¨ç¼“å­˜ ä½¿ç”¨æ–­ç‚¹ç»­ä¼ ï¼Œå¦åˆ™ç½‘ç»œä¸ç¨³å®šæ—¶å¯èƒ½å¤šæ¬¡ä¼ è¾“ç›¸åŒçš„å†…å®¹ ç½‘ç»œä¸å¯ç”¨æ—¶ï¼Œä¸è¦å°è¯•æ‰§è¡Œç½‘ç»œè¯·æ±‚ è®©ç”¨æˆ·å¯ä»¥å–æ¶ˆé•¿æ—¶é—´è¿è¡Œæˆ–è€…é€Ÿåº¦å¾ˆæ…¢çš„ç½‘ç»œæ“ä½œï¼Œè®¾ç½®åˆé€‚çš„è¶…æ—¶æ—¶é—´ æ‰¹é‡ä¼ è¾“ï¼Œæ¯”å¦‚ï¼Œä¸‹è½½è§†é¢‘æµæ—¶ï¼Œä¸è¦ä¼ è¾“å¾ˆå°çš„æ•°æ®åŒ…ï¼Œç›´æ¥ä¸‹è½½æ•´ä¸ªæ–‡ä»¶æˆ–è€…ä¸€å¤§å—ä¸€å¤§å—åœ°ä¸‹è½½ã€‚å¦‚æœä¸‹è½½å¹¿å‘Šï¼Œä¸€æ¬¡æ€§å¤šä¸‹è½½ä¸€äº›ï¼Œç„¶åå†æ…¢æ…¢å±•ç¤ºã€‚å¦‚æœä¸‹è½½ç”µå­é‚®ä»¶ï¼Œä¸€æ¬¡ä¸‹è½½å¤šå°ï¼Œä¸è¦ä¸€å°ä¸€å°åœ°ä¸‹è½½ å®šä½ä¼˜åŒ–ï¼š å¦‚æœåªæ˜¯éœ€è¦å¿«é€Ÿç¡®å®šç”¨æˆ·ä½ç½®ï¼Œæœ€å¥½ç”¨CLLocationManagerçš„requestLocationæ–¹æ³•ã€‚å®šä½å®Œæˆåï¼Œä¼šè‡ªåŠ¨è®©å®šä½ç¡¬ä»¶æ–­ç”µ å¦‚æœä¸æ˜¯å¯¼èˆªåº”ç”¨ï¼Œå°½é‡ä¸è¦å®æ—¶æ›´æ–°ä½ç½®ï¼Œå®šä½å®Œæ¯•å°±å…³æ‰å®šä½æœåŠ¡ å°½é‡é™ä½å®šä½ç²¾åº¦ï¼Œæ¯”å¦‚å°½é‡ä¸è¦ä½¿ç”¨ç²¾åº¦æœ€é«˜çš„kCLLocationAccuracyBest éœ€è¦åå°å®šä½æ—¶ï¼Œå°½é‡è®¾ç½®pausesLocationUpdatesAutomaticallyä¸ºYESï¼Œå¦‚æœç”¨æˆ·ä¸å¤ªå¯èƒ½ç§»åŠ¨çš„æ—¶å€™ç³»ç»Ÿä¼šè‡ªåŠ¨æš‚åœä½ç½®æ›´æ–° å°½é‡ä¸è¦ä½¿ç”¨startMonitoringSignificantLocationChangesï¼Œä¼˜å…ˆè€ƒè™‘startMonitoringForRegion: ç¡¬ä»¶æ£€æµ‹ä¼˜åŒ–ï¼š ç”¨æˆ·ç§»åŠ¨ã€æ‘‡æ™ƒã€å€¾æ–œè®¾å¤‡æ—¶ï¼Œä¼šäº§ç”ŸåŠ¨ä½œ(motion)äº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶ç”±åŠ é€Ÿåº¦è®¡ã€é™€èºä»ªã€ç£åŠ›è®¡ç­‰ç¡¬ä»¶æ£€æµ‹ã€‚åœ¨ä¸éœ€è¦æ£€æµ‹çš„åœºåˆï¼Œåº”è¯¥åŠæ—¶å…³é—­è¿™äº›ç¡¬ä»¶ äº”ã€App çš„å¯åŠ¨APPçš„å†·å¯åŠ¨å¯ä»¥æ¦‚æ‹¬ä¸º3å¤§é˜¶æ®µ dyld runtime main 5.1 dylddyldï¼ˆdynamic link editorï¼‰ï¼ŒåŠ¨æ€é“¾æ¥å™¨ï¼Œå¯ä»¥ç”¨æ¥è£…è½½Mach-Oæ–‡ä»¶ï¼ˆå¯æ‰§è¡Œæ–‡ä»¶ã€åŠ¨æ€åº“ç­‰ï¼‰ å¯åŠ¨APPæ—¶ï¼Œdyldæ‰€åšçš„äº‹æƒ…ï¼š è£…è½½APPçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ŒåŒæ—¶ä¼šé€’å½’åŠ è½½æ‰€æœ‰ä¾èµ–çš„åŠ¨æ€åº“ 5.2 runtimeå¯åŠ¨APPæ—¶ï¼Œruntimeæ‰€åšçš„äº‹æƒ…æœ‰ï¼š è°ƒç”¨map_imagesè¿›è¡Œå¯æ‰§è¡Œæ–‡ä»¶å†…å®¹çš„è§£æå’Œå¤„ç† åœ¨load_imagesä¸­è°ƒç”¨call_load_methodsï¼Œè°ƒç”¨æ‰€æœ‰Classå’ŒCategoryçš„+loadæ–¹æ³• è¿›è¡Œå„ç§objcç»“æ„çš„åˆå§‹åŒ–ï¼ˆæ³¨å†ŒObjcç±» ã€åˆå§‹åŒ–ç±»å¯¹è±¡ç­‰ç­‰ï¼‰ è°ƒç”¨C++é™æ€åˆå§‹åŒ–å™¨å’Œattribute((constructor))ä¿®é¥°çš„å‡½æ•° åˆ°æ­¤ä¸ºæ­¢ï¼Œå¯æ‰§è¡Œæ–‡ä»¶å’ŒåŠ¨æ€åº“ä¸­æ‰€æœ‰çš„ç¬¦å·(Classï¼ŒProtocolï¼ŒSelectorï¼ŒIMPï¼Œâ€¦)éƒ½å·²ç»æŒ‰æ ¼å¼æˆåŠŸåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œè¢« runtime æ‰€ç®¡ç† 5.3 å¯åŠ¨æ€»ç»“ APPçš„å¯åŠ¨ç”±dyldä¸»å¯¼ï¼Œå°†å¯æ‰§è¡Œæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ï¼Œé¡ºä¾¿åŠ è½½æ‰€æœ‰ä¾èµ–çš„åŠ¨æ€åº“ å¹¶ç”±runtimeè´Ÿè´£è§£æå¤„ç†æˆobjcå®šä¹‰çš„ç»“æ„ æ‰€æœ‰åˆå§‹åŒ–å·¥ä½œç»“æŸåï¼Œdyldå°±ä¼šè°ƒç”¨mainå‡½æ•° æ¥ä¸‹æ¥å°±æ˜¯UIApplicationMainå‡½æ•°ï¼ŒAppDelegateçš„application:didFinishLaunchingWithOptions:æ–¹æ³• 5.4 å¯åŠ¨ä¼˜åŒ–dyld å‡å°‘ã€åˆå¹¶åŠ¨æ€åº“ å‡å°‘Objcç±»ã€åˆ†ç±»çš„æ•°é‡ã€å‡å°‘Selectoræ•°é‡ å‡å°‘C++è™šå‡½æ•°æ•°é‡ Swiftå°½é‡ä½¿ç”¨struct runtime ç”¨+initializeæ–¹æ³•å’Œdispatch_onceå–ä»£æ‰€æœ‰çš„attribute((constructor))ã€C++é™æ€æ„é€ å™¨ã€ObjCçš„+load main åœ¨ä¸å½±å“ç”¨æˆ·ä½“éªŒçš„å‰æä¸‹ï¼Œå°½å¯èƒ½å°†ä¸€äº›æ“ä½œå»¶è¿Ÿï¼Œä¸è¦å…¨éƒ¨éƒ½æ”¾åœ¨didfinishLaunchingæ–¹æ³•ä¸­ æŒ‰éœ€åŠ è½½ å…­ã€å®‰è£…åŒ…ç˜¦èº«å®‰è£…åŒ…ï¼ˆIPAï¼‰ä¸»è¦ç”±å¯æ‰§è¡Œæ–‡ä»¶ã€èµ„æºç»„æˆ 6.1 å¯æ‰§è¡Œæ–‡ä»¶ç˜¦èº« Strip Linked Productã€Make Strings Read-Onlyã€Symbols Hidden by Defaultè®¾ç½®ä¸ºYES å»æ‰å¼‚å¸¸æ”¯æŒï¼ŒEnable C++ Exceptionsã€Enable Objective-C Exceptionsè®¾ç½®ä¸ºNOï¼Œ Other C Flagsæ·»åŠ -fno-exceptions æ£€æµ‹æœªä½¿ç”¨ä»£ç ï¼š AppCodeæ£€æµ‹ï¼šèœå•æ  -&gt; Code -&gt; Inspect Code SelectorsUnrefsæ£€æµ‹ï¼šã€Š22-iOS Appå¯åŠ¨ä¼˜åŒ–ã€‹ä¸­æåˆ°è¿‡ ç¼–å†™LLVMæ’ä»¶æ£€æµ‹å‡ºé‡å¤ä»£ç ã€æœªè¢«è°ƒç”¨çš„ä»£ç  6.2 èµ„æºç˜¦èº«èµ„æºï¼ˆå›¾ç‰‡ã€éŸ³é¢‘ã€è§†é¢‘ç­‰ï¼‰ é‡‡å–æ— æŸå‹ç¼© å»é™¤æ²¡æœ‰ç”¨åˆ°çš„èµ„æºï¼š https://github.com/tinymind/LSUnusedResources","link":"/2021/07/20/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/25-%E7%95%8C%E9%9D%A2%E4%BC%98%E5%8C%96/"},{"title":"ã€Šæ‰‹æŠŠæ‰‹æ•™ä½ ä¹°åŸºé‡‘ã€‹è¯»ä¹¦ç¬”è®°","text":"","link":"/2021/08/11/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E3%80%8A%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%B9%B0%E5%9F%BA%E9%87%91%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"},{"title":"ã€Šå†°ä¸ç«ä¹‹æ­Œã€‹è¯»ä¹¦ç¬”è®°","text":"ç®€è¿°ï¼šä¸€éƒ¨å…·ä¸­ä¸–çºªé­”å¹»å°è¯´ï¼Œè®²è¿°äº†æ¶ç©ºä¸–ç•Œä¸­å„è·¯äººç‰©æŒ£æ‰æ±‚ç”Ÿå’Œä¸ºäº‰æƒå¤ºåˆ©è€Œè¿›è¡Œæˆ˜æ–—çš„æ•…äº‹ã€‚ è¿™éƒ¨ä¹¦çš„ä¼˜ç‚¹ï¼š 1.æ²¡æœ‰ç»å¯¹çš„å•ä¸€è‹±é›„è®ºï¼Œä¸åƒã€Šé¾™æ—ã€‹æˆ–è€…ã€Šå“ˆåˆ©æ³¢ç‰¹ã€‹ä¸­æœ‰ä¸€ä¸ªè¡€ç»Ÿæ— æ•Œï¼Œä¸ªäººå…‰ç¯è¶…å¼ºçš„â€œè¶…äººâ€ä½œä¸ºæ³•åˆ™ä¸»å¯¼æ•´ä¸ªä¸–ç•Œçš„è¿è¡Œï¼›è¿™éƒ¨ä¹¦ä¸­çš„æ¯ä¸ªäººéƒ½æ˜¯æœ‰è¡€æœ‰è‚‰çš„ä¸ªä½“ï¼Œæ¯ä¸ªéƒ½æœ‰å…¶ä¼˜ç‚¹å’Œç¼ºç‚¹ï¼Œæ²¡æœ‰ä¸€æ‰‹é®å¤©çš„èƒ½åŠ›ï¼Œå³ä¾¿æ˜¯æœ‰å¼ºå¤§é­”åŠ›çš„çº¢è¢å¥³å·«ï¼Œå¥¹çš„å åœä¹Ÿæ—¶å¸¸ä¼šå‡ºé”™ï¼Œèƒ½å¤Ÿæ„Ÿè§‰åˆ°ä»–ä»¬ä¹Ÿåªæ˜¯èŠ¸èŠ¸ä¼—ç”Ÿï¼Œè·Ÿæˆ‘ä»¬å¹¶æ²¡æœ‰ä»€ä¹ˆä¸åŒï¼Œåªä¸è¿‡å¹´ä»£ä¸åŒï¼Œä¸–ç•Œä¸åŒï¼Œé€ å°±äº†ä¸åŒçš„äººæ ¼ã€‚è¿™æ ·èƒ½å¤Ÿè·Ÿç€äººç‰©ä¸€èµ·æˆé•¿ï¼Œå¯ä»¥æ˜ç™½ä»–å½“æ—¶ä¸ºä»€ä¹ˆä¼šåšå‡ºé‚£æ ·çš„æŠ‰æ‹©ã€‚ 2.æœ‰æ¸…æ™°çš„å†å²è„‰ç»œå’Œå®¶æ—å…³ç³»ï¼Œç»‡æˆä¸€å¼ ä¸¥å¯†çš„ä¸­ä¸–çºªç½‘ç»œï¼Œæ•…äº‹æºå¤´æœ‰è¿¹å¯å¾ªï¼Œè¿™ä¹Ÿæ˜¯èƒ½æ‹æˆç”µè§†å‰§çš„åŸå› ä¹‹ä¸€å§ã€‚ 3.ä¸­ä¸–çºªçš„è´¨æ„Ÿå……è¶³ï¼Œä½œè€…æœ‰éå¸¸æ·±åšçš„çŸ¥è¯†ç§¯ç´¯ï¼Œåœ¨è¯»çš„è¿‡ç¨‹ä¸­è¿˜èƒ½é¡ºä¾¿äº†è§£å…³äºé¥®é£Ÿã€æœé¥°ã€æ­¦å™¨ã€æˆ˜äº‰ã€åœ°ç†ã€è‡ªç„¶ç¯å¢ƒç­‰çç¢çš„çŸ¥è¯†ã€‚ 4.è™½ç„¶èå…¥äº†ä¸€äº›ç„å¹»ã€é­”æ³•ç­‰å…ƒç´ ï¼Œä½†å¹¶æ²¡æœ‰è§‰å¾—ç‰¹åˆ«å¤¸å¼ ï¼Œä¾ç„¶æ˜¯ä»¥ç»å¯¹çš„ç¡¬å®åŠ›ä¸ºä¸»å¯¼ã€‚ æ„Ÿå—ï¼š è¿™éƒ¨å·¨è‘—ç”±äºè¿‡äºåºå¤§ï¼Œé‡Œé¢æœ‰èŒ«èŒ«å¤šçš„äººåã€åœ°åï¼Œå¾ˆéš¾å…¨éƒ½è®°ä½ï¼Œæ‰€ä»¥åˆšå¼€å§‹å°±æ‰¾äº†æ—è°±å’Œåœ°å›¾å‚è€ƒç€çœ‹ï¼Œä¸­é—´è¿˜ä¹°äº†å®˜æ–¹çš„åœ°å›¾é›†ï¼Œè¯»åˆ°åé¢æ›´æ˜¯æ‰¾äº†ä¸€ä¸ªå†°ä¸ç«ä¹‹æ­Œç™¾ç§‘ç½‘ç«™å»æ£€ç´¢ä¸€äº›ä¸œè¥¿ï¼Œçœ‹å®Œè¿™éƒ¨ä¹¦çš„æ—¶é—´è·¨åº¦è¾¾åˆ°äº†ä¸€å¹´ä¹‹ä¹…ï¼Œä¸»è¦æ˜¯çœ‹å¾—æ…¢ï¼Œå¹³å‡æ¯å¤©éƒ½çœ‹ä¸åˆ°ä¸€ç‚¹ç‚¹ã€‚æ€»ä¹‹ï¼Œä½œè€…å†™çš„æ—¶å€™èŠ±è´¹äº†å¤§é‡å¿ƒè¡€ï¼Œæˆ‘çœ‹çš„ä¹Ÿæ˜¯ã€‚ä¸è¿‡è¿˜æ˜¯éå¸¸å€¼å¾—è¯»çš„ï¼Œåœ¨æˆ‘è¯»è¿‡çš„å°è¯´ä¸­ï¼Œè¿™éƒ¨æ˜¯æœ€å¥½çš„ã€‚ ä¸ªäººæœ€å–œæ¬¢çš„è§’è‰²æ˜¯æåˆ©æ˜‚Â·å…°å°¼æ–¯ç‰¹ï¼Œè™½ç„¶æ˜¯ä¸ªä¾å„’ï¼Œä½†èº«ä½“çš„æ®‹ç–¾å¹¶ä¸èƒ½æ©ç›–å…¶å¿ƒæ™ºçš„èªæ˜ï¼Œå¹¶ä¸”ä»–æ—¢æœ‰ä¼¶ä¿çš„å£é½¿åˆçƒ­è¡·è¯»ä¹¦æ±²å–çŸ¥è¯†ï¼Œåœ¨è¿™æ ·çš„æˆ˜ä¹±å¹´ä»£åªè¦èƒ½ä¸çŠ¯å¤§é”™ï¼Œè¿æ°”ä¸å¤ªå·®ä¾¿èƒ½å¦‚é±¼å¾—æ°´ã€‚è¿™ä¹Ÿæ˜¯ä¸»è¦è§’è‰²ä¸­æœ€å¹½é»˜çš„ä¸€ä½äº†ï¼Œå¯ä»¥è¯´æœ‰å‹‡æœ‰è°‹ï¼Œå¦‚æœé…ä¸Šä¸€å‰¯å¼ºå¥çš„èº«ä½“ï¼Œé‚£åº”è¯¥æ˜¯å°è¯´ä¸­æœ€å¼ºå¤§çš„å­˜åœ¨äº†ã€‚ è¯´åˆ°å¼ºå¤§ï¼Œé¾™ä¹‹æ¯ä¸¹å¦®è‰ä¸æ˜¯æœ‰ä¸»è§’å…‰ç¯åŠ æŒçš„ä¸€ä½ï¼Œèƒ½å¤Ÿé©¯æœä¸‰æ¡é¾™ï¼Œè¿˜ä¸æ€•çƒˆç«ï¼Œæ˜¯æœ€æœ‰å¯èƒ½èµ¢å¾—æœ€åæˆ˜äº‰çš„äººã€‚å¯ä¸¹å¦®è‰ä¸ä¹Ÿæ˜¯å¥³äººï¼Œä¹Ÿæœ‰å¥³äººæŸ”æƒ…ã€æƒ³è¦è¢«ä¿æŠ¤çš„ä¸€é¢ï¼Œè™½ç„¶å¾ˆå°‘è¡¨éœ²ï¼Œä½†ä¹¦ä¸­å¥¹æ— æ—¶ä¸åˆ»ä¸åœ¨è¿›è¡Œè¿™ç§å†…åœ¨æƒ³è¦å®‰å®ä½†å¤–åœ¨æ‰‹è¿«äºå½¢åŠ¿ä¸å¾—ä¸åšå¼ºèµ·æ¥çš„å†…å¿ƒæ–—äº‰ã€‚ è®¨åŒçš„æœ‰å¾ˆå¤šï¼Œå…¶ä¸­åŸ¹æå°”Â·è´é‡Œå¸­ã€è±èÂ·è‰¾æ—ã€ä¹”æ‹‰Â·è«å°”è’™ä¸‰ä½å±ä¹‹æœ€ã€‚ åªå¯æƒœè¿™éƒ¨ä¹¦æˆªæ­¢2021å¹´8æœˆåªå‡ºç‰ˆäº†5å·ï¼Œæœ€åå¹¶æ²¡æœ‰å®Œç»“ï¼Œä¹Ÿæ²¡æœ‰æœ€ç»ˆæˆ˜çš„è‹—å¤´ï¼Œæ•…äº‹åˆ°ä¸¹å¦®è‰ä¸ç‹¬è‡ªåœ¨å¤šæ–¯æ‹‰å…‹æµ·è¢«èƒŒå›è¿‡å¥¹çš„è¡€ç›Ÿå«å‘ç°åå°±æˆªæ­¢äº†ï¼Œè¿™éƒ¨å°è¯´å‰æœŸçš„é…é…¿å®åœ¨å¤ªå……è¶³äº†ï¼Œæ‰€ä»¥æˆ‘ä¸€ç›´éƒ½åœ¨ç­‰å¾…æ‰€è°“çš„â€œå¤œç‹â€éœ‡æ’¼ç™»åœºæ¥ä¸€åœºæ—·ä¸–ä¹‹æˆ˜ã€‚ä¸è¿‡é‰´äºåŸè‘—æ”¹ç¼–çš„ç”µè§†å‰§çƒ‚å°¾äº†ï¼Œæ‰€ä»¥è¿˜æ˜¯å¸Œæœ›ä½œè€…èƒ½å¤Ÿç»™å°è¯´æ¥ä¸€ä¸ªå®Œç¾çš„ç»“å±€ã€‚","link":"/2021/08/26/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E3%80%8A%E5%86%B0%E4%B8%8E%E7%81%AB%E4%B9%8B%E6%AD%8C%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"},{"title":"ã€Šæ€ªèƒã€‹è§‚åæ„Ÿ","text":"è¯´èµ·è¿™éƒ¨ç”µå½±ï¼Œä¸ä¹‹ç»“ç¼˜çš„æ•…äº‹ä¹Ÿå¾ˆæœ‰æ„æ€ã€‚ åˆšå¼€å§‹æ˜¯è¢«ç”µå½±å°é¢å¸å¼•ï¼Œé¢œè‰²äº®ä¸½åˆæ¸…çˆ½ï¼Œç¬¦åˆæˆ‘çš„å®¡ç¾ï¼Œé‚è´­å…¥ï¼Œä½†æ˜¯åˆšå¼€å§‹çœ‹çš„æ—¶å€™å‘ç°ç”µå½±ç”»é¢çš„æ¯”ä¾‹å±…ç„¶æ˜¯4:3çš„ï¼Œè€Œä¸”ç”»é¢å™ªç‚¹éå¸¸å¤šï¼Œçœ‹èµ·æ¥è¿™ç”µå½±åˆè€åˆæ²¡ç»è´¹çš„æ ·å­ï¼Œä»¥ä¸ºè‡ªå·±è¢«å‘äº†ï¼Œç„¶åç”Ÿæ°”å…³æ‰äº†ã€‚åæ¥æƒ³äº†æƒ³å†ç»™ä»–ä¸€æ¬¡æœºä¼šï¼Œç‚¹å¼€ï¼Œæ»šåŠ¨æ¡æ‹–åˆ°1/3å¤„ï¼Œçœ‹åˆ°äº†å¥³ä¸»å’Œç”·ä¸»åœ¨åœ°é“ä¸Šæš§æ˜§çš„ä¸€å¹•ï¼Œå‘ç°å¥³ä¸»æŒºæ¼‚äº®ï¼Œå‰§æƒ…ä¹Ÿè¿˜è¡Œï¼Œå°±å†æ¬¡ä»å¤´å¼€å§‹çœ‹ã€‚ è¿›åº¦è¿‡åŠä¹‹åï¼Œçªç„¶å‘ç°ç”»é¢å˜å®½æˆ16:9çš„äº†ï¼Œæœ‰ç‚¹éœ‡æƒŠï¼Œæ‹–ç€è¿›åº¦æ¡æ‰¾æœ€å¼€å§‹å˜å®½çš„é‚£ä¸€å¹•ï¼Œå‘ç°æ˜¯ç”·ä¸»ä¸»åŠ¨æ¨å¼€é—¨èµ°åˆ°å¤–é¢æ—¶ï¼Œæ•´ä¸ªç”µå½±çš„ç”»é¢éšç€é—¨çš„æ¨å¼€é€æ¸å¼€é˜”ï¼Œè¿™æ‰æ˜ç™½å¼€å§‹ç”»é¢è¾ƒçª„æ˜¯å› ä¸ºå¼ºè¿«ç—‡ç¦é”¢äº†ä¸¤äººï¼Œéšç€å¼ºè¿«ç—‡çš„æ¶ˆå¤±ï¼Œç¦é”¢ä¹Ÿæ¶ˆå¤±äº†ï¼Œæ‰€ä»¥ç”»é¢æ‰å˜æˆäº†å®½æ¯”ä¾‹çš„16:9ã€‚ç¬¬ä¸€æ¬¡è§åˆ°è¿™ç§é€šè¿‡ç”»é¢æ¯”ä¾‹æ¥è¡¨ç°æ€æƒ³çš„å·§å¦™æ„æ€ï¼ŒæƒŠå–œäº†ä¸€é˜µå­ã€‚ ç”µå½±çš„å¤§æ¦‚å†…å®¹æ˜¯ï¼Œä¸¤ä¸ªåŒæ ·æ‚£æœ‰ä¸¥é‡ OCDï¼ˆå¼ºè¿«ç—‡ï¼‰çš„ç”·å¥³æ„å¤–ç»“ç¼˜å¹¶æ‹çˆ±ï¼Œç”Ÿæ´»åœ¨ä¸€èµ·ä¹‹åçªç„¶æœ‰ä¸€å¤©ç”·ç”Ÿçš„å¼ºè¿«ç—‡æ¶ˆå¤±äº†ï¼Œç„¶åæ˜¯ç¿»å¤©è¦†åœ°çš„ç”Ÿæ´»ä¸Šçš„å‰§å˜ï¼Œç”·ç”Ÿäº‹ä¸šå‘å±•ã€å‡ºè½¨ï¼Œæœ€ç»ˆå¯¼è‡´ä¸¤äººæƒ…æ„Ÿç ´è£‚ï¼Œå¥³ç”Ÿè‡ªæ€ï¼›åæ¥å¥³ç”ŸæƒŠé†’ï¼Œå‘ç°ç”·ä¸»ç—…å¥½çš„çŠ¶å†µéƒ½æ˜¯è‡ªå·±çš„ä¸€åœºæ¢¦ï¼Œå…¶å®è‡ªå·±æ‰æ˜¯ç—…å¥½çš„äººï¼Œäºæ˜¯ä¹‹å‰å‘ç”Ÿåœ¨ç”·ç”Ÿèº«ä¸Šçš„å‰§å˜åŒæ ·å³å°†å‘ç”Ÿåœ¨å¥³ç”Ÿèº«ä¸Šã€‚ç”µå½±åˆ°è¿™é‡Œå°±ç»“å°¾äº†ï¼Œåœç•™åœ¨å¥³ç”Ÿå¯¹å³å°†å‘ç”Ÿçš„äº‹æƒ…çš„å¹»æƒ³ï¼Œå¹¶æ²¡æœ‰å‘ŠçŸ¥æœ€åçš„ç»“å±€ã€‚ ä¹‹å‰ä¸€ç›´æ¯”è¾ƒè®¨åŒè¿™ç§å¼€æ”¾å¼çš„ç»“å±€ï¼Œçœ‹ç”µå½±å›¾çš„å°±æ˜¯ä¸ªç®€å•ç²—æš´ï¼Œè¿™éƒ¨ç”µå½±ä¹Ÿä¸ä¾‹å¤–ã€‚æˆ‘å¸Œæœ›è¿™éƒ¨ç”µå½±æœ‰ä¸ªå®Œç¾çš„ç»“å°¾ï¼Œåƒã€Šå¤æ´›ç‰¹çƒ¦æ¼ã€‹ä¸€æ ·ï¼Œå¤æ´›æ¢¦åˆ°è¿‡æ‚²å‰§ï¼Œé‚£ä¹ˆç°å®ä¸­çš„è‡ªå·±å°±ä¼šæåŠ›é¿å…æ‚²å‰§ï¼Œå½“ç„¶ã€Šå¤æ´›ã€‹è¿™ç§æ˜¯å®Œå®Œå…¨å…¨çœŸç›¸å¤§ç™½çš„åˆå®¶æ¬¢ä¹çš„ç»“å±€ï¼Œåœ¨è¿™é‡Œå¹¶ä¸é€‚ç”¨ï¼Œæˆ‘å»ºè®®ã€Šæ€ªèƒã€‹è¿™éƒ¨ç”µå½±æœ€åæ˜¯ä¸€ç§å«è“„å®Œæ»¡çš„ç»“å±€ï¼Œæ¯”å¦‚ä»å¥³ç”Ÿéå¸¸ç»†å¾®çš„åŠ¨ä½œä¸­ä½“ç°å‡ºå¥¹æœ€åä¹Ÿåœ¨é¿å…æ‚²å‰§å‘ç”Ÿï¼Œè€Œä¸æ˜¯ä¸ä½œä¸ºï¼Œä»è€Œåæ˜ å‡ºå¥³ç”Ÿå¯¹å®Œæ»¡çˆ±æƒ…çš„å‘å¾€ï¼Œæˆ‘è§‰å¾—è¿™æ‰æ˜¯æˆ‘æ»¡æ„çš„ç»“å±€ã€‚å½“ç„¶ï¼Œæˆ‘æœ‰æ—¶å€™ä¹Ÿä¼šæƒ³ï¼Œå¦‚æœè¿™ç§æœªåœå…ˆçŸ¥çš„èƒ½åŠ›äº§ç”Ÿåœ¨æˆ‘èº«ä¸Šï¼Œé‚£ä¹ˆç°åœ¨çš„æˆ‘åº”è¯¥æ˜¯å®Œå…¨ä¸åŒçš„å…‰æ™¯äº†å§ã€‚ä¸è¿‡è™½ç„¶ç”µå½±æ²¡æœ‰ç»™å‡ºç»“å±€ï¼Œä½†æ˜¯æˆ‘æ„¿æ„ç›¸ä¿¡è¿™ä¸ªå¥³ç”Ÿèƒ½é¿å…æ¢¦ä¸­åœºæ™¯çš„å†æ¬¡å‘ç”Ÿï¼Œå› ä¸ºæ¢¦ä¸­ä½“ä¼šè¿‡è¿™ç§ç—›è‹¦ï¼Œå°±ä¸ä¼šå†å»å°è¯•äº†å§ã€‚ è¿™éƒ¨ç”µå½±çš„éƒ¨åˆ†æƒ…èŠ‚æ¯”è¾ƒè€å¥—ï¼Œæ¯”å¦‚ç”·ç”Ÿç—…å¥½åçš„ä¸€äº›äº‹ä¸šå‘å±•å’Œæƒ…æ„Ÿç”Ÿæ´»ï¼Œä½†å…¶å®å¯åˆ›æ–°ç‚¹ä¸æ˜¯ç‰¹åˆ«å¤šï¼Œæœ‰äº›äººç”Ÿä¸å°±æ˜¯åœ¨é‡å¤åˆ«äººçš„äººç”Ÿå—ï¼Œè¿™ä¹ˆæ‹ä¹Ÿæ²¡ä»€ä¹ˆã€‚ æœ€ç›´è§‚çš„æ„Ÿå—åº”è¯¥å°±æ˜¯æ•´éƒ¨ç”µå½±é²œè‰³çš„é…è‰²äº†ï¼Œä»äººç‰©çš„æœè£…åˆ°å®¤å†…è£…ä¿®ï¼Œä½†æ˜¯ç”»é¢æ•´ç†äº®åº¦åˆä¸æ˜¯å¾ˆé«˜ï¼Œæ‰€ä»¥æ„Ÿè§‰æœ‰äº›è·³è·ƒåˆæœ‰äº›å‹æŠ‘ï¼Œæˆ–è®¸åœ¨æš—ç¤ºæ•´éƒ¨ç”µå½±æ‚²å‰§çš„æ”¶å°¾ï¼Ÿå¸Œæœ›ä¸æ˜¯ã€‚ è¿™éƒ¨ç”µå½±è¿˜æœ‰ä¸€ä¸ªä¸å¾—ä¸è¯´çš„åœ°æ–¹ï¼Œè¿™æ˜¯äºšæ´²é¦–éƒ¨ä»å¤´åˆ°å°¾éƒ½ä½¿ç”¨ iPhone æ‹æ‘„çš„ç”µå½±ï¼Œä»ç”»é¢çš„å™ªç‚¹å°±å¯ä»¥æ˜æ˜¾çœ‹å¾—å‡ºæ¥æ˜¯è‹¹æœé£ã€‚è™½è¯´å¯èƒ½æ˜¯ä¸€ç§å®£ä¼ å½¢å¼ï¼Œä½†æˆ‘ä¾ç„¶æ„Ÿè§‰åˆ°ï¼Œé‡è¦çš„æ°¸è¿œéƒ½ä¸æ˜¯å·¥å…·ï¼Œå·¥å…·æ°¸è¿œæ˜¯ä¸ºäº†å†…å®¹æœåŠ¡çš„ï¼Œé‡è¦çš„æ˜¯å†…å®¹ã€‚Jobs ç»™äº†æˆ‘æœ€å¼ºå¤§çš„å·¥å…·ï¼Œé‚£ä¹ˆæˆ‘åº”è¯¥åˆ›é€ äº›ä»€ä¹ˆå‘¢ï¼Ÿ","link":"/2021/09/01/%E8%A7%82%E5%BD%B1%E7%AC%94%E8%AE%B0/%E3%80%8A%E6%80%AA%E8%83%8E%E3%80%8B%E8%A7%82%E5%90%8E%E6%84%9F/"},{"title":"ã€Šé£å¤©çº¢çŒªä¾ ã€‹è§‚åæ„Ÿ","text":"è®²è¿°ä¸€ä½æœ‰éª¨æ°”çš„é£è¡Œå‘˜å› ä¸çŸ¥åçš„åŸå› å˜æˆä¸€åªçŒªï¼Œé€šè¿‡åœ¨æµ·ä¸Šè¿½æ•é£è¡Œæµ·ç›—èµšå–èµé‡‘çš„æ•…äº‹ã€‚ å°è±¡æ¯”è¾ƒæ·±åˆ»çš„æœ‰ä¸¤ç‚¹ï¼Œä¸€æ˜¯çº¢çŒªä¾ æœ‰ä¸€ä¸ªåœ¨å°å²›ä¸Šçš„ç§˜å¯†åŸºåœ°ï¼Œæœ‰ä¸€ä¸ªå¯ä»¥è®©é£æœºé€šè¿‡çš„å…¥å£ï¼Œè¿›å»ä¹‹åæ˜¯ä¸€å°ç‰‡æ²™æ»©ï¼Œæ•´ä¸ªåŸºåœ°è¢«å±±ä½“ç¯ç»•ï¼Œåƒæ˜¯å‡¹é™·çš„ç«å±±å£ï¼Œä»–å°±åœ¨è¿™ä¼‘æ†©ï¼Œä¸€äººä¸€æ¤…ï¼Œæ™´ç©ºæ²™æ»©ï¼Œæ— äººæ‰“æ‰°ï¼ŒçœŸæ˜¯ä»¤äººç¥å¾€ã€‚ å¦ä¸€ç‚¹å°±æ˜¯ï¼Œé€šè¿‡çœ‹å®«å´éªçš„æ‰€æœ‰ç”µå½±ï¼Œå‘ç°ä»–å¸¸æŠŠå¿ƒçµç¾å¥½çš„å¥³ç”Ÿåˆ»ç”»æˆå¤©ç„¶å»é›•é¥°çš„æ¨¡æ ·ï¼Œæœ‰ç‚¹å¯çˆ±æœ‰æœ‰ç‚¹é«˜å†·ï¼Œä½†æ€§æ ¼å´æ˜¯ç‹¬ç«‹ã€å‹‡æ•¢ã€å¼ºç¡¬ã€ç‡çœŸï¼Œè¿™åº”è¯¥å°±æ˜¯ä»–å¿ƒç›®ä¸­æœ€ç†æƒ³åŒ–çš„å¥³æ€§äº†å§ï¼Œå¥½åƒä¹Ÿæ˜¯æˆ‘çš„ã€‚ å®«å´éªçš„è®¿è°ˆä¸­ä»–è¯´ï¼Œâ€œæˆ‘å–œæ¬¢çš„ç”µå½±ä»æ¥éƒ½ä¸æ˜¯å› ä¸ºå®ƒçš„æ•…äº‹æƒ…ç»“ï¼Œè€Œæ˜¯æŸä¸€ä¸ªé•œå¤´è®©æˆ‘è§‰å¾—å¤ªæ£’äº†ï¼Œæˆ‘è®¤ä¸ºè¿™æ‰æ˜¯ç”µå½±ã€‚â€åœ¨è¿™éƒ¨ç”µå½±ä¸­ä¹Ÿå¯ä»¥å°è¯è¿™å¥è¯ï¼Œæœ‰æµ·ä¸Šåœºæ™¯çš„é•œå¤´ï¼Œæˆ‘ä»¿ä½›èƒ½é—»åˆ°æµ·ç›çš„å‘³é“ï¼Œèº«ä¸Šå¥½åƒå¹è¿‡åŒæ ·çš„é£ï¼Œé£˜é€¸ï¼Œè‡ªç”±ã€‚ æœç‹ä¸Šçš„ä¸€ä½ä½œè€…å¦‚æ­¤è¯„ä»·å®«å´éªï¼šâ€œä¼Ÿå¤§çš„ä½œå“ï¼Œéœ€è¦å¤©æ‰é€†é£è€Œè¡Œï¼Œä¸å±ˆæœã€ä¸å¦¥åã€‚â€æ¯«æ— ç–‘é—®ï¼Œå®«å´éªåˆ›ä½œäº†å¤ªå¤šä¼Ÿå¤§çš„ä½œå“ã€‚æˆ‘æœ‰æ—¶å€™å°±åœ¨æƒ³ï¼Œä¸ºä»€ä¹ˆä»–è¿™ä¹ˆæ‰§ç€ã€è®¤çœŸï¼Ÿä»–æ˜¯çœŸçš„å–œæ¬¢ç”»ç”»å—ï¼Œè¿˜æ˜¯çœŸçš„æ²¡ä»€ä¹ˆå…¶ä»–çˆ±å¥½æ‰€ä»¥æ­»ç£•åˆ°åº•ï¼Ÿæˆ‘ç›®å‰å€¾å‘äºè®¤ä¸ºä»–æ˜¯ä¹ æƒ¯è®¤çœŸçš„è¿™ç§çŠ¶æ€äº†ï¼Œæ²¡åŠæ³•åœä¸‹æ¥ï¼Œè¿™ä¸€æ–¹é¢æ˜¯å¥½äº‹ï¼Œå¸Œæœ›æˆ‘ä¹Ÿèƒ½åœ¨è‡ªå·±çš„å·¥ä½œä¸­åšåˆ°å¦‚æ­¤è®¤çœŸï¼Œæ¯•ç«Ÿè¿™æ˜¯å‡­å€Ÿè‡ªå·±æ»¡è…”çƒ­æƒ…èµ°å‡ºæ¥çš„è·¯å­ï¼Œè€Œä¸”æˆ‘ç¦»å®«çš„è®¤çœŸè¿˜å·®çš„å¾ˆè¿œï¼Œä½†ä¸€æ–¹é¢ä¹Ÿè¦æ—¶åˆ»æ³¨æ„ï¼Œä¸è¦åªåŸ‹å¤´åŠªåŠ›ï¼Œä¸–ç•Œä¸Šæœ‰çš„æ˜¯æ¯”æˆ‘åŠªåŠ›çš„äººï¼Œæ‰€ä»¥æˆ‘è¦ä¿æŒè‡ªå·±çš„ç›´è§‰å’Œæƒ³æ³•ï¼Œä¸è¦åªç¡¬ç¢°ç¡¬ã€‚","link":"/2021/09/03/%E8%A7%82%E5%BD%B1%E7%AC%94%E8%AE%B0/%E3%80%8A%E9%A3%9E%E5%A4%A9%E7%BA%A2%E7%8C%AA%E4%BE%A0%E3%80%8B%E8%A7%82%E5%90%8E%E6%84%9F/"},{"title":"ã€Šç›¸çº¦æ˜ŸæœŸäºŒã€‹è¯»ä¹¦ç¬”è®°","text":"Iriså­¦å§æ¨èï¼šâ€œå¦‚æœä½ è¿æ­»äº¡éƒ½ä¸æ€•ï¼Œé‚£è¿˜æœ‰ä»€ä¹ˆèƒ½éš¾å¾—å€’ä½ å‘¢ï¼Ÿâ€ è®²è¿°äº†ä¸€ä½å“ˆä½›å¤§å­¦ç¤¾ä¼šå­¦æ•™æˆè«é‡Œåœ¨æ™šå¹´å¾—äº†ä¸éœé‡‘ç›¸åŒçš„ALS(æ¸å†»ç—‡)ï¼Œä»–çš„ä¸€ä½å­¦ç”Ÿåœ¨ç”µè§†èŠ‚ç›®ä¸­å¾—çŸ¥æ¶ˆæ¯åæ¯å‘¨äºŒä¾¿æ¥æ¢è®¿ä»–çš„è¿™ä½è€å¸ˆå¹¶ä¸Šä¸€å ‚æœ€åçš„ã€å…³äºäººç”Ÿçš„è¯¾ã€‚ ä½™ç§‹é›¨ä½œåºï¼Œåºä¸­ä»–ç‹ åŠ²çš„å¤¸äº†è€äººä¸€ç•ªï¼Œæœ€åä¸€æ®µä»–æ˜¯è¿™ä¹ˆå†™çš„ï¼šâ€œæ­£è¦æç¬”ï¼Œè„‘æµ·ä¸­æ€ä¹ˆä¹ŸæŒ¥ä¸å»è¿œæ–¹è€äººçš„èº«å½±ã€‚ä»–åœ¨è°ƒçš®çš„çœ¨çœ¼ï¼Œè¯´â€˜æˆ‘æ—©å°±çŸ¥é“ä½ æƒ³æ‰“æˆ‘â€™ï¼Œè¯´â€™åƒä¸‡åˆ«æŠŠæˆ‘çƒ§è¿‡äº†å¤´â€™â€¦â€¦é‚£ä¹ˆï¼Œæˆ‘ä»¬çœŸçš„ä¸è¦åœ¨å¦ä¸€ä¸ªæ„ä¹‰ä¸ŠæŠŠä»–â€™çƒ§è¿‡äº†å¤´â€™ï¼Œå³ä¾¿å¤§å®¶éƒ½æ¥å—äº†ä»–çš„è¯¾ç¨‹ã€‚æ˜¯çš„ï¼Œä»–åªæ˜¯ä¸€ä½æ™®é€šçš„æ•™å¸ˆï¼Œè®²äº†ä¸€è¾ˆå­è¯¾ï¼Œæœ€åä¸€è¯¾æœ‰å…³äººç”Ÿã€‚â€ ä»–æåˆ°ä¸è¦åœ¨æŸç§æ„ä¹‰ä¸Šâ€œæŠŠä»–çƒ§è¿‡äº†å¤´â€ï¼Œæ„æ€åº”è¯¥æ˜¯ä¸è¦æŠŠä»–çš„è¿™äº›å…³äºäººç”Ÿçš„ç†å¿µå½“æˆè‡³ç†åè¨€ç›´è‡³æˆä¸ºè‡ªå·±çš„äººç”Ÿä¿¡æ¡ï¼Œä¸å»è´¨ç–‘æˆ–è€…æ€è€ƒå°±å…¨ç›˜æ¥å—ã€‚ç¡®å®æ˜¯è¿™æ ·ï¼Œè€å¸ˆçœŸæ­£çš„ä½œç”¨åªæ˜¯å¸¦é¢†ä½ å»æ€è€ƒï¼Œè€Œä¸æ˜¯å‘Šè¯‰ä½ å®Œå…¨æ­£ç¡®çš„é“ç†ï¼Œäººçš„ä¸€ç”Ÿä¸­æœ€é‡è¦çš„å°±æ˜¯ä¿æŒè‡ªå·±çš„æ€è€ƒã€‚å½“ç„¶ï¼Œè¿™å ‚å…³äºäººç”Ÿçš„è¯¾è¿˜æ˜¯éå¸¸æ·±åˆ»çš„ã€‚ â€œè«é‡Œï¼Œå°±åƒä»–è¯´çš„é‚£æ ·ï¼Œå»ºç«‹äº†ä»–è‡ªå·±çš„æ–‡åŒ–â€”â€”æ—©åœ¨ä»–æ‚£ç—…ä¹‹å‰å°±è¿™ä¹ˆåšäº†ã€‚å°ç»„è®¨è®ºï¼Œå’Œæœ‹å‹æ•£æ­¥ï¼Œå»åç››é¡¿å¹¿åœºçš„æ•™å ‚è·³èˆè‡ªå¨±ã€‚ä»–è¿˜åˆ¶å®šäº†ä¸€ä¸ªåå«ç»¿å±‹çš„è®¡åˆ’ï¼Œä¸ºè´«å›°çš„äººæä¾›å¿ƒç†æ²»ç–—ã€‚ä»–åšè§ˆç¾¤ä¹¦ä¸ºä»–çš„è¯¾å¯»æ‰¾æ–°çš„æ€æƒ³å†…å®¹ï¼Œä»–èµ°è®¿åŒäº‹ä»¬ï¼Œä¸æ¯•ä¸šçš„å­¦ç”Ÿä¿æŒè”ç³»ï¼Œç»™è¿œæ–¹çš„æœ‹å‹å†™ä¿¡ã€‚ä»–æƒ…æ„¿èŠ±æ—¶é—´å»äº«äº«å£ç¦å’Œèµç©è‡ªç„¶ï¼Œè€Œä»ä¸æµªè´¹åœ¨ç”µè§†å–œå‰§æˆ–å‘¨æœ«ç”µå½±ä¸Šã€‚ä»–å»ºç«‹äº†ä¸€ç§äººç±»æ´»åŠ¨çš„æ¨¡å¼â€”â€”ç›¸äº’äº¤æµï¼Œç›¸äº’å½±å“ï¼Œç›¸äº’çˆ±æŠ¤â€”â€”è¿™ä¸€æ¨¡å¼å……å®ç€ä»–çš„ç”Ÿæ´»ã€‚â€ â€”â€”ã€Šç‚¹åã€‹ ç¡®å®ï¼Œäººæœ‰æ—¶çœŸçš„ä¼šæ²‰æµ¸åœ¨è‡ªå·±çš„ä¸–ç•Œä¸­ï¼Œæ²‰æµ¸åœ¨ç”µè§†ç”µå½±çš„å¹»å¢ƒä¸­ï¼Œè€Œå¿˜è®°äº†ä¸äººäº¤æµçš„é‡è¦æ€§ï¼Œä¸äººäº¤æµå¯ä»¥è®©å¤§è„‘å……åˆ†æ´»è·ƒï¼Œè€Œçœ‹å½±ç‰‡çš„å¤§éƒ¨åˆ†æ—¶é—´é‡Œï¼Œæ€ç»´éƒ½æ˜¯ä¸åŠ¨çš„ã€‚ä½†ä¹Ÿä¸èƒ½è¯´æ‰€æœ‰çš„ç”µè§†å–œå‰§æˆ–è€…ç”µå½±éƒ½æ˜¯â€œæµªè´¹æ—¶é—´â€ï¼Œè™½ç„¶å¤§éƒ¨åˆ†æ˜¯è¿™æ ·ï¼Œä½†æœ‰äº›è¿˜æ˜¯èƒ½ç»™äººå¸¦æ¥å•çº¯çš„å¿«ä¹æˆ–è€…å¯ç¤ºçš„ã€‚æˆ‘åœ¨æƒ³ï¼Œç”µå½±ç”µè§†å‰§ã€æ¸¸æˆï¼Œèƒ½å¦æœ‰ä¸€å¤©å’Œä¹¦ç±å¹³èµ·å¹³åï¼Œå˜æˆäººç±»çš„ç²¾ç¥ç‘°å®ï¼Œæˆ–è€…è¯´â€œäººç±»è¿›æ­¥çš„é˜¶æ¢¯â€ï¼Œå› ä¸ºæœ‰è¶Šæ¥è¶Šå¤šä¼˜ç§€çš„ä½œå“ï¼Œæœ‰è¶Šæ¥è¶Šå¤šçš„äººä¸ºä¹‹ä»˜å‡ºå¤§é‡çš„å¿ƒè¡€ï¼Œç”µå½±ç”µè§†å‰§ã€æ¸¸æˆï¼Œåœ¨æœªæ¥ï¼Œæ˜¯å¦å¯ä»¥ç§°å¾—ä¸Šæ˜¯ä¹¦ç±çš„å¦ä¸€ç§å½¢å¼ï¼Ÿå¤§æ¦‚éœ€è¦æ—¶é—´çš„æ£€éªŒå§ï¼Œbç«™ä¸Šæœ€ä¼˜ç§€çš„è§†é¢‘ä½œå“ï¼Œå†è¿‡åå¹´ã€äºŒåå¹´ã€ä¸‰åå¹´ä¹‹åè¿˜èƒ½ç•™å­˜å—ï¼Œä»¥ä¸€ç§ç²¾ç¥ç‘°å®çš„å½¢å¼ï¼Ÿ â€œäººç”Ÿæœ€é‡è¦çš„æ˜¯å­¦ä¼šå¦‚ä½•æ–½çˆ±äºäººï¼Œå¹¶å»æ¥å—çˆ±ã€‚çˆ±æ˜¯å”¯ä¸€çš„ç†æ€§è¡Œä¸ºâ€œ â€”â€”ã€Šç¬¬ä¸€ä¸ªæ˜ŸæœŸäºŒâ€”â€”è°ˆè®ºä¸–ç•Œã€‹ æœ‰ç‚¹çœ‹ä¸å¤ªæ‡‚ï¼Œåº”è¯¥è¯´éå¸¸ä¸æ‡‚ã€‚ â€œç±³å¥‡ï¼Œæˆ‘ä¸è®©è‡ªå·±æœ‰æ›´å¤šçš„è‡ªå“€è‡ªæ€œã€‚æ¯å¤©æ—©ä¸Šå°±ä¸€å°ä¼šå„¿ï¼Œæ‰å‡ æ»´çœ¼æ³ªï¼Œå°±å®Œäº†ã€‚â€ â€”â€”ã€Šç¬¬äºŒä¸ªæ˜ŸæœŸäºŒâ€”â€”è°ˆè®ºè‡ªæ€œã€‹ ç¨»ç››å’Œå¤«ä¹Ÿè¯´è¿‡ç±»ä¼¼çš„è¯ï¼Œä¸è¦è‡ªæˆ‘æ¶ˆæ²‰ï¼Œå¯¹è‡ªå·±æ²¡æœ‰å¥½å¤„ã€‚é‚£ä¹ˆå³ä¾¿è¦æ¶ˆæ²‰ï¼Œå°±ä¸€å°ä¼šå°±å¥½äº†ï¼Œä¸è¦å¤ªå¤šï¼Œç„¶åæ¥ç€ç”Ÿæ´»ã€‚ â€œæˆ‘ä»¬çš„æ–‡åŒ–ä¸é¼“åŠ±ä½ å»æ€è€ƒè¿™ç±»å›é¢˜,æ‰€ä»¥ä½ åªæœ‰åœ¨ä¸´æ­»å‰æ‰ä¼šå»æƒ³å®ƒã€‚æˆ‘ä»¬æ‰€å…³æ³¨çš„æ˜¯ä¸€äº›å¾ˆè‡ªç§çš„äº‹æƒ…ï¼šäº‹ä¸šï¼Œå®¶åº­ï¼Œèµšé’±ï¼Œå¿è¿˜æŠµæŠ¼è´§æ¬¾ï¼Œä¹°æ–°è½¦ï¼Œä¿®å–æš–å™¨â€”â€”é™·åœ¨æ°¸æ— æ­¢å¢ƒçš„çäº‹é‡Œï¼Œå°±ä¸ºäº†æ´»ä¸‹å»ã€‚å› æ­¤,æˆ‘ä»¬ä¸ä¹ æƒ¯é€€åä¸€æ­¥ï¼Œå®¡è§†ä¸€ä¸‹è‡ªå·±çš„ç”Ÿæ´»é—®ï¼Œå°±è¿™äº›ï¼Ÿè¿™å°±æ˜¯æˆ‘éœ€è¦çš„ä¸€åˆ‡ï¼Ÿæ˜¯ä¸æ˜¯è¿˜ç¼ºç‚¹ä»€ä¹ˆï¼Ÿâ€ ä»–åœé¡¿äº†ä¸€ä¸‹ã€‚ â€œä½ éœ€è¦æœ‰äººä¸ºä½ æŒ‡ç‚¹ä¸€ä¸‹ã€‚ç”Ÿæ´»ä¸ä¼šä¸€è¹´è€Œå°±çš„ã€‚â€ æˆ‘çŸ¥é“ä»–åœ¨è¯´ä»€ä¹ˆã€‚æˆ‘ä»¬åœ¨ç”Ÿæ´»ä¸­éƒ½éœ€è¦æœ‰å¯¼å¸ˆçš„æŒ‡å¼•ã€‚ è€Œæˆ‘çš„å¯¼å¸ˆå°±ååœ¨æˆ‘çš„å¯¹é¢ã€‚ â€”â€”ã€Šç¬¬ä¸‰ä¸ªæ˜ŸæœŸäºŒâ€”â€”è°ˆè®ºé—æ†¾ã€‹ æˆ‘æƒ³äº†ä¸€ä¼šï¼Œç¼ºå°‘çš„æ˜¯çˆ±å’Œè¢«çˆ±ï¼Œåœ¨ç”Ÿæ´»çš„è½¦è½®ä¸åœæ»šåŠ¨çš„æ—¶å€™ï¼Œå¯èƒ½æˆ‘å¿½ç•¥äº†å¾ˆå¤šçˆ±ã€‚ æ¯ä¸ªäººéƒ½åº”è¯¥æœ‰ä¸€ä½äººç”Ÿçš„å¯¼å¸ˆï¼Œä½œè€…æ‰¾åˆ°äº†ï¼Œæˆ‘è¿˜æ²¡æ‰¾åˆ°ã€‚ä¸è¿‡ä½œè€…æ„è¯†åˆ°è¿™ç‚¹çš„æ—¶å€™å¤§æ¦‚æ˜¯37å²ï¼Œæˆ‘è¿˜å¯ä»¥ç»§ç»­å¯»æ‰¾ã€‚ â€œä¸€æ—¦ä½ å­¦ä¼šäº†æ€æ ·å»æ­»ï¼Œä½ ä¹Ÿå°±å­¦ä¼šäº†æ€æ ·å»ç”Ÿæ´»ã€‚â€ â€œå¦‚æœä½ èƒ½æ¥å—éšæ—¶éƒ½ä¼šæ­»å»çš„äº‹å®â€”â€”ä½ å°±ä¸ä¼šåƒç°åœ¨è¿™æ ·è€½äºæŠ±è´Ÿäº†ã€‚ä½ ä¸ºæ­¤è€Œä»˜å‡ºçš„æ—¶é—´å’Œç²¾åŠ›çš„äº‹â€”â€”ä½ æ‰€åšçš„å·¥ä½œâ€”â€”ä¹Ÿè®¸å°±ä¸å†æ˜¾å¾—é‚£ä¹ˆé‡è¦äº†ã€‚ä½ ä¹Ÿè®¸ä¼šè®©å‡ºç©ºé—´æ¥æ»¡è¶³ç²¾ç¥ä¸Šçš„éœ€æ±‚ã€‚â€ â€œå°½ç®¡æˆ‘è¯´ä¸ä¸Šæ¥â€˜ç²¾ç¥äº§ç‰©â€™åˆ°åº•ä¸ºä½•ç‰©ï¼Œä½†æˆ‘çŸ¥é“æˆ‘ä»¬åœ¨æœ‰äº›æ–¹é¢ç¡®å®æ˜¯æœ‰ç¼ºé™·çš„ã€‚æˆ‘ä»¬è¿‡å¤šçš„è¿½æ±‚ç‰©è´¨éœ€è¦ï¼Œå¯ä»–ä»¬å¹¶ä¸èƒ½ä½¿æˆ‘ä»¬æ»¡è¶³ã€‚æˆ‘ä»¬å¿½è§†äº†äººä¸äººä¹‹é—´ç›¸äº’çˆ±æŠ¤çš„å…³ç³»ï¼Œæˆ‘ä»¬å¿½è§†äº†å‘¨å›´çš„ä¸–ç•Œã€‚â€ â€”â€”ã€Šç¬¬å››ä¸ªæ˜ŸæœŸäºŒâ€”â€”è°ˆè®ºæ­»äº¡ã€‹ åœ¨ä¸€ä¸ªå°†æ­»ä¹‹äººå£ä¸­è¯´å‡ºç”Ÿæ´»çš„çœŸå®å¥¥ä¹‰æ˜¯æä¸ºä»¤äººæ·±çœçš„ï¼ŒåŒæ ·çš„è¯ä¹”å¸ƒæ–¯åœ¨ç”Ÿç—…åä¹Ÿè¯´è¿‡ï¼Œä»–è¯´è¦æŠŠæ¯å¤©å½“æˆç”Ÿå‘½ä¸­çš„æœ€åä¸€å¤©å»è¿‡ï¼Œç„¶ååå¤é—®è‡ªå·±æ˜¯å¦è¿˜ä¼šåƒä¹‹å‰æ‰“ç®—çš„é‚£æ ·å»åšã€‚æŠŠæ¯å¤©å½“æˆè‡ªå·±ç”Ÿå‘½çš„æœ€åä¸€å¤©æ„å‘³ç€åªåšè‡ªå·±è®¤ä¸ºæœ€æœ‰ä»·å€¼çš„äº‹æƒ…ï¼Œåªåšè®©è‡ªå·±ä¸ä¼šåæ‚”çš„å†³å®šï¼Œæ„å‘³ç€æˆ‘ä»¬è¦å¯¹çˆ±çš„äººã€çˆ±æˆ‘ä»¬çš„äººè¡¨è¾¾å‡ºè‡ªå·±æœ€çœŸå®çš„æƒ…æ„Ÿï¼Œè¿˜æ„å‘³ç€å¦‚æœæ¯å¤©éƒ½èƒ½è¿™ä¹ˆåšåˆ°ï¼Œé‚£ä¹ˆä¸€ä¸ªäººçš„äººç”Ÿå°†ä¼šæ˜¯å®Œå…¨å……å®æ»¡è¶³ä¸åæ‚”çš„å®Œæ»¡äººç”Ÿï¼Œæˆ‘åº”è¯¥å¤šå¤šæé†’è‡ªå·±çš„ã€‚ â€œå¦‚æœæ²¡æœ‰å®¶åº­ï¼Œäººä»¬ä¾¿å¤±å»äº†å¯ä»¥æ”¯æ’‘çš„æ ¹åŸºã€‚æˆ‘çš„ç—…åå¯¹è¿™ä¸€ç‚¹æ›´æœ‰ä½“ä¼šã€‚å¦‚æœä½ å¾—ä¸åˆ°æ¥è‡ªå®¶åº­çš„æ”¯æŒã€çˆ±æŠšã€ç…§é¡¾å’Œå…³ç³»ï¼Œä½ æ‹¥æœ‰çš„ä¸œè¥¿ä¾¿å°‘çš„å¯æ€œã€‚çˆ±æ˜¯è‡³é«˜æ— ä¸Šçš„ã€‚â€ â€œå¦‚æœä½ æƒ³ä½“éªŒæ€æ ·å¯¹å¦ä¸€ä¸ªäººæ‰¿æ‹…è´£ä»»ï¼Œæƒ³å­¦ä¼šå¦‚ä½•å…¨èº«å¿ƒçš„å»çˆ±çš„è¯ï¼Œé‚£ä¹ˆä½ å°±åº”è¯¥æœ‰å­©å­ã€‚â€ â€”â€”ã€Šç¬¬äº”ä¸ªæ˜ŸæœŸäºŒâ€”â€”è°ˆè®ºå®¶åº­ã€‹ é‚£ä¹ˆæˆ‘ä¹Ÿåº”è¯¥æœ‰å­©å­ï¼Œè™½ç„¶æˆ‘ä¹‹å‰ä¹Ÿä¸€ç›´è®¤ä¸ºå­©å­æ˜¯äº‹ä¸šè·¯ä¸Šçš„ç»Šè„šçŸ³ã€‚å¯æ˜¯æˆ‘ç¡®å®ä¸æ€ä¹ˆä¼šå…¨èº«å¿ƒçš„çˆ±ï¼Œåšä¸åˆ°è¿™ç‚¹ï¼Œä¸èƒ½ç®—å¾—ä¸Šæ˜¯ä¸€ä¸ªå®Œæ»¡çš„äººã€‚ â€œæ˜¯çš„ï¼Œè¶…è„±è‡ªæˆ‘ã€‚è¿™éå¸¸é‡è¦â€”â€”ä¸ä»…å¯¹æˆ‘è¿™ä¸ªå¿«è¦æ­»çš„äººæ˜¯è¿™æ ·ï¼Œå¯¹åƒä½ è¿™æ ·å®Œå…¨å¥åº·çš„äººä¹Ÿå¦‚æ­¤ã€‚è¦å­¦ä¼šè¶…è„±ã€‚è¶…è„±å¹¶ä¸æ˜¯è¯´ä¸æŠ•å…¥åˆ°ç”Ÿæ´»ä¸­å»ã€‚ç›¸åï¼Œä½ åº”è¯¥å®Œå®Œå…¨å…¨çš„æŠ•å…¥è¿›å»ã€‚ç„¶åä½ æ‰èµ°å¾—å‡ºæ¥ã€‚â€ â€œæ¥å—æ‰€æœ‰çš„æ„Ÿæƒ…â€”â€”å¯¹å¥³äººçš„çˆ±æ‹ï¼Œå¯¹äº²äººçš„æ‚²ä¼¤ï¼Œæˆ–åƒæˆ‘æ‰€ç»å†çš„ï¼šç”±è‡´å‘½çš„ç–¾ç—…è€Œå¼•èµ·çš„ææƒ§å’Œç—›è‹¦ã€‚å¦‚æœä½ é€ƒé¿è¿™äº›æ„Ÿæƒ…â€”â€”ä¸è®©è‡ªå·±å»æ„Ÿå—ã€ç»å†â€”â€”ä½ å°±æ°¸è¿œè¶…è„±ä¸äº†ï¼Œå› ä¸ºä½ å§‹ç»ˆå¿ƒå­˜ææƒ§ã€‚ä½ å®³æ€•ç—›è‹¦ï¼Œå®³æ€•æ‚²ä¼¤ï¼Œå®³æ€•çˆ±å¿…é¡»æ‰¿å—æ„Ÿæƒ…ä¼¤å®³ã€‚ å¯ä½ ä¸€æ—¦æŠ•å…¥è¿›å»ï¼Œæ²‰æµ¸åœ¨æ„Ÿæƒ…çš„æ±ªæ´‹é‡Œï¼Œä½ å°±èƒ½å……åˆ†çš„ä½“éªŒå®ƒï¼ŒçŸ¥é“ä»€ä¹ˆæ˜¯ç—›è‹¦ï¼Œä»€ä¹ˆæ˜¯æ‚²ä¼¤ã€‚åªæœ‰åˆ°é‚£æ—¶ä½ æ‰èƒ½è¯´ï¼Œâ€˜å¥½å§ï¼Œæˆ‘å·²ç»ç»å†äº†è¿™ä»½æ„Ÿæƒ…ï¼Œæˆ‘å·²ç»è®¤è¯†äº†è¿™ä»½æ„Ÿæƒ…ï¼Œç°åœ¨æˆ‘éœ€è¦è¶…è„±ä»–â€™â€ â€”â€”ã€Šç¬¬å…­ä¸ªæ˜ŸæœŸäºŒâ€”â€”è°ˆè®ºæ„Ÿæƒ…ã€‹ â€œä½ åº”è¯¥å‘ç°ä½ ç°åœ¨ç”Ÿæ´»ä¸­çš„ä¸€åˆ‡ç¾å¥½ã€çœŸå®çš„ä¸œè¥¿ã€‚å›é¦–è¿‡å»ä¼šä½¿ä½ äº§ç”Ÿç«äº‰çš„æ„è¯†ï¼Œè€Œå¹´é¾„æ˜¯æ— æ³•ç«äº‰çš„ã€‚â€ â€œè¿™äº›å¹´é¾„é˜¶æ®µæˆ‘éƒ½ç»å†è¿‡ï¼Œæˆ‘çŸ¥é“ä»–ä»¬æ˜¯ä»€ä¹ˆæ ·çš„ã€‚å½“æˆ‘åº”è¯¥æ˜¯ä¸ªå­©å­æ—¶ï¼Œæˆ‘ä¹äºåšä¸ªå­©å­ï¼›å½“æˆ‘åº”è¯¥æ˜¯ä¸ªèªæ˜çš„è€å¤´æ—¶ï¼Œæˆ‘ä¹Ÿä¹äºåšä¸ªèªæ˜çš„è€å¤´ã€‚æˆ‘ä¹äºæ¥å—è‡ªç„¶èµ‹äºˆæˆ‘çš„ä¸€åˆ‡æƒåŠ›ã€‚æˆ‘å±äºä»»ä½•ä¸€ä¸ªå¹´é¾„ï¼Œç›´åˆ°ç°åœ¨çš„æˆ‘ã€‚æˆ‘ä¸ä¼šç¾¡æ…•ä½ çš„äººç”Ÿé˜¶æ®µâ€”â€”å› ä¸ºæˆ‘ä¹Ÿæœ‰è¿‡è¿™ä¸ªäººç”Ÿé˜¶æ®µã€‚â€ â€”â€”ã€Šç¬¬ä¸ƒä¸ªæ˜ŸæœŸäºŒâ€”â€”è°ˆè®ºå¯¹è¡°è€çš„ææƒ§ã€‹ å½“æˆ‘åº”è¯¥æ˜¯ä¸ªå¹´è½»äººçš„æ—¶å€™ï¼Œå°±åº”è¯¥æœ‰å¹´è½»äººçš„å‹‡æ°”ï¼›â€œå½“æˆ‘åº”è¯¥æ˜¯ä¸ªèªæ˜çš„è€å¤´æ—¶ï¼Œæˆ‘ä¹Ÿä¹äºåšä¸ªèªæ˜çš„è€å¤´â€ã€‚ â€œæˆ‘ä»¬å›½å®¶æå€¡çŒè¾“çš„æ•™è‚²å½¢å¼ï¼Œä»–ä»¬å¯¹ä½ ä¸€éåˆä¸€éåœ°é‡å¤ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬å›½å®¶çš„åšæ³•ã€‚æ‹¥æœ‰å¾—è¶Šå¤šè¶Šå¥½ã€‚é’±è¶Šå¤šè¶Šå¥½ã€‚è´¢å¯Œè¶Šå¤šè¶Šå¥½ã€‚å•†ä¸šè¡Œä¸ºä¹Ÿæ˜¯è¶Šå¤šè¶Šå¥½ã€‚è¶Šå¤šè¶Šå¥½ã€‚è¶Šå¤šè¶Šå¥½ã€‚æˆ‘ä»¬åå¤åœ°å¯¹åˆ«äººè¿™ä¹ˆè¯´â€”â€”åˆ«äººåˆåå¤åœ°å¯¹æˆ‘ä»¬è¿™ä¹ˆè¯´â€”â€”ä¸€éåˆä¸€é€šï¼Œç›´åˆ°äººäººéƒ½è®¤ä¸ºè¿™æ˜¯çœŸç†ã€‚å¤§å¤šæ•°äººä¼šå—åˆ°è¿·æƒ‘è€Œå¤±å»è‡ªå·±çš„åˆ¤æ–­èƒ½åŠ›ã€‚â€ â€œå®é™…ä¸Š,å®ƒä»¬ä¸èƒ½ä½¿ä½ æ„Ÿåˆ°æ»¡è¶³ã€‚ä½ çŸ¥ä¸çŸ¥é“çœŸæ­£ä½¿ä½ æ„Ÿåˆ°æ»¡è¶³çš„æ˜¯ä»€ä¹ˆå—ï¼Ÿâ€”â€”ç»™äºˆä»–äººä½ åº”è¯¥ç»™äºˆçš„ä¸œè¥¿ï¼Œä½ çš„æ—¶é—´ï¼Œä½ çš„å…³å¿ƒï¼Œä½ çš„é—²è°ˆã€‚â€œ â€œæŠŠè‡ªå·²æœ¬å¥‰çŒ®ç»™çˆ±ï¼ŒæŠŠè‡ªå·±å¥‰çŒ®ç»™ç¤¾åŒºï¼ŒæŠŠè‡ªå·±å¥‰çŒ®ç»™èƒ½ç»™äºˆä½ ç›®æ ‡å’Œæ„ä¹‰çš„åˆ›é€ ã€‚â€ â€œç±³å¥‡ï¼Œå¦‚æœä½ æƒ³å¯¹ç¤¾ä¼šçš„ä¸Šå±‚ç‚«è€€è‡ªå·±ï¼Œé‚£å°±æ‰“æ¶ˆè¿™ä¸ªå¿µå¤´ï¼Œä»–ä»¬ç…§æ ·çœ‹ä¸èµ·ä½ ã€‚å¦‚æœä½ æƒ³å¯¹ç¤¾ä¼šçš„åº•å±‚ç‚«è€€è‡ªå·±ï¼Œä¹Ÿè¯·æ‰“æ¶ˆè¿™ä¸ªå¿µå¤´ï¼Œä»–ä»¬åªä¼šå¿Œå¦’ä½ ã€‚èº«ä»½å’Œåœ°ä½å¾€å¾€ä½¿ä½ æ„Ÿåˆ°æ— æ‰€é€‚ä»ã€‚å”¯æœ‰ä¸€é¢—å¦è¯šçš„å¿ƒæ–¹èƒ½ä½¿ä½ æ‚ ç„¶åœ°é¢å¯¹æ•´ä¸ªç¤¾ä¼šã€‚â€ â€œæˆ‘å½“ç„¶åœ¨å—ç½ªã€‚ä½†ç»™äºˆä»–äººèƒ½ä½¿æˆ‘æ„Ÿåˆ°è‡ªå·±è¿˜æ´»ç€ã€‚æ±½è½¦å’Œæˆ¿å­ä¸èƒ½ç»™ä½ è¿™ç§æ„Ÿè§‰ï¼Œé•œå­é‡Œç…§å‡ºçš„æ¨¡æ ·ä¹Ÿä¸èƒ½ç»™ä½ è¿™ç§æ„Ÿè§‰ã€‚åªæœ‰å½“æˆ‘å¥‰çŒ®å‡ºäº†æ—¶é—´ï¼Œå½“æˆ‘ä½¿é‚£æ­¤æ‚²ä¼¤çš„äººé‡åˆéœ²å‡ºç¬‘é¢œï¼Œæˆ‘æ‰æ„Ÿåˆ°æˆ‘ä»åƒä»¥å‰ä¸€æ ·çš„å¥åº·ï¼Œåªè¦ä½ åšçš„æ˜¯å‘è‡ªå†…å¿ƒçš„ï¼Œä½ è¿‡åå°±ä¸ä¼šæ„Ÿåˆ°å¤±æœ›ï¼Œä¸ä¼šæ„Ÿåˆ°å¦’å¿Œï¼Œä¹Ÿä¸ä¼šè®¡è¾ƒåˆ«äººçš„å›æŠ¥ã€‚å¦åˆ™ï¼Œä½ å°±è¦æ‚£å¾—æ‚£å¤±ã€‚â€œ â€”â€”ã€Šç¬¬å…«ä¸ªæ˜ŸæœŸäºŒâ€”â€”è°ˆè®ºé‡‘é’±ã€‹ é‡‘é’±ä¸æ˜¯å—åˆ°è¿·æƒ‘è€Œè§‰å¾—è¶Šå¤šè¶Šå¥½ï¼Œä½†æ˜¯ä¹Ÿè¦æœ‰å……è¶³çš„ä¿éšœï¼Œåƒå¾·å›½çš„åšå¤šÂ·èˆè´¹å°”è¯´çš„é‚£æ ·é‡‘é’±èƒ½å¤Ÿä¿éšœä½ å»çœ‹ç¾ä¸½çš„é£æ™¯ã€é‡è§æœ‰è¶£çš„äººã€åšæœ‰æ„æ€çš„å·¥ä½œã€‚æœ€æœ€é‡è¦çš„æ˜¯ä¸è¦åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­è¿·å¤±è‡ªæˆ‘ï¼Œè¿™ç‚¹éœ€è¦æ—¶å¸¸æé†’ï¼Œå› ä¸ºæˆ‘èº«è¾¹å°±æœ‰è¿™æ ·çš„ä¾‹å­ã€‚ æˆ‘è®¤åŒè€äººçš„è§‚ç‚¹ï¼šâ€œç»™äºˆä»–äººä½ åº”è¯¥ç»™äºˆçš„ä¸œè¥¿ï¼Œä½ çš„æ—¶é—´ï¼Œä½ çš„å…³å¿ƒï¼Œä½ çš„é—²è°ˆâ€ï¼Œè¿™æ ·æ‰èƒ½å¾—åˆ°ç²¾ç¥çš„æ»¡è¶³ï¼ŒåŒæ ·ä¹Ÿèƒ½å¸¦ç»™åˆ«äººä»¥æ”¶è·ï¼Œæ˜¯ä¸€é¡¹äº’åˆ©çš„ä¸¾æªã€‚ä¸è¦åå•¬è‡ªå·±çš„é—²è°ˆã€‚ å°‘ä¸€äº›ç‚«è€€ï¼Œå¤šä¸€äº›çœŸè¯šã€‚â€œä¸€ç­‰äººæ‰æ·±æ²‰åšé‡ï¼›äºŒç­‰äººæ‰ç£Šè½è±ªé›„ï¼›ä¸‰ç­‰äººæ‰èªæ˜æ‰è¾©â€ã€‚ â€œæˆ‘å–œæ¬¢å…¨èº«å¿ƒåœ°æŠ•å…¥ï¼Œå½“æˆ‘ç°åœ¨åŒä½ äº¤è°ˆæ—¶ï¼Œç±³å¥‡ï¼Œæˆ‘å°±å°½åŠ›æŠŠæ³¨æ„åŠ›é›†ä¸­åœ¨æˆ‘ä»¬çš„è°ˆè¯ä¸Šã€‚æˆ‘ä¸å»æƒ³ä¸Šä¸ªæ˜ŸæœŸæˆ‘ä»¬çš„ä¼šé¢ï¼Œæˆ‘ä¸å»æƒ³æ˜ŸæœŸäº”è¦å‘ç”Ÿçš„äº‹ï¼Œæˆ‘ä¹Ÿä¸å»æƒ³ç§‘ä½©å°”è¦åˆ¶ä½œçš„å¦ä¸€æ¡£èŠ‚ç›®æˆ–æˆ‘æ­£åœ¨æ¥å—çš„è¯ç‰©æ²»ç–—ã€‚æˆ‘åœ¨å’Œä½ è¯´è¯ã€‚æˆ‘æƒ³çš„åªæœ‰ä½ ã€‚â€œ ä»–åœ¨è¿™æ–¹é¢æ˜¯åšå¾—æå…¶å‡ºè‰²çš„ã€‚ä½ å’Œä»–è°ˆè®ºä¸å¹¸çš„äº‹æƒ…æ—¶,ä»–çš„çœ¼ç›ä¼šå˜å¾—æ¹¿æ¶¦;ä½ å’Œä»–å¼€ä¸€ä¸ªå“ªæ€•æ˜¯è¹©è„šçš„ç©ç¬‘æ—¶ï¼Œä»–çš„çœ¼ç›ä¼šç¬‘æˆä¸€æ¡ç¼ã€‚ä»–éšæ—¶å‘ä½ ç¥–éœ²ä»–çš„æ„Ÿæƒ…ï¼Œè€Œè¿™æ­£æ˜¯æˆ‘ä»¬è¿™ä¸€ä»£äººæ‰€ç¼ºå°‘çš„å“è´¨ã€‚æˆ‘ä»¬å¾ˆä¼šæ•·è¡ï¼šâ€œä½ æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿâ€â€œä½ ä½åœ¨å“ªå„¿ï¼Ÿâ€å¯çœŸæ­£åœ°å»å€¾å¬â€”â€”ä¸å¸¦ä»»ä½•å…œå”®ã€åˆ©ç”¨æˆ–æƒ³å¾—åˆ°å›æŠ¥çš„åŠ¨æœºå’Œå¿ƒç†â€”â€”æˆ‘ä»¬èƒ½åšåˆ°å—ï¼Ÿæˆ‘ç›¸ä¿¡åœ¨è«é‡Œçš„æœ€åå‡ ä¸ªæœˆé‡Œæ¥çœ‹æœ›ä»–çš„äººï¼Œæœ‰è®¸å¤šæ˜¯ä¸ºäº†ä»è«é‡Œé‚£å¾—åˆ°ä»–ä»¬éœ€è¦çš„å…³æ³¨ï¼Œè€Œä¸æ˜¯æŠŠä»–ä»¬çš„å…³æ³¨ç»™äºˆè«é‡Œã€‚è€Œè¿™ä½ç¾¸å¼±çš„è€äººæ€»æ˜¯ä¸é¡¾ä¸ªäººçš„ç—…ç—›å’Œè¡°é€€åœ¨æ»¡è¶³ç€ä»–ä»¬ã€‚ ä½†çˆ¶èœçš„æ­»å´ä½¿è«é‡ŒçŸ¥é“äº†è¯¥å¦‚ä½•å»å‡†å¤‡äººç”Ÿçš„æœ€åä¸€æ®µæ—…ç¨‹ã€‚ä»–è‡³å°‘æ‡‚å¾—äº†ï¼šç”Ÿæ´»ä¸­åº”è¯¥æœ‰è®¸å¤šçš„æ‹¥æŠ±ã€äº²å»ã€äº¤è°ˆ,æ¬¢ç¬‘å’Œé“åˆ«,è€Œè¿™ä¸€åˆ‡ä»–éƒ½æ²¡æ¥å¾—åŠä»çˆ¶äº²å’Œæ¯äº²é‚£é‡Œå¾—åˆ°ã€‚ â€”â€”ã€Šç¬¬ä¹ä¸ªæ˜ŸæœŸäºŒâ€”â€”è°ˆè®ºçˆ±çš„æ°¸æ’ã€‹ æˆ‘å¸Œæœ›æˆ‘å¯ä»¥æ…¢æ…¢åšåˆ°ã€‚ å‰æ®µæ—¶é—´åœ¨æ²¹ç®¡ä¸Šçœ‹åˆ°ä¸€ä½åšä¸»è®²è¿°è‡ªå·±ä¸åˆ«äººçš„cafe talkï¼Œå¥¹è¯´è‡ªå·±å¼€å§‹éƒ½æ˜¯ä¼šèŠä¸€äº›ä¸ç”Ÿæ´»ç›¸å…³çš„ï¼Œæ¯”è¾ƒéšæ„ï¼Œè´´è¿‘å¯¹è¯è€…æƒ…æ„Ÿçš„è¯é¢˜ï¼Œæœ€åæ‰ä¼šèŠåˆ°å•†ä¸šè¯é¢˜ï¼Œä¸€è¾¹çœŸè¯šä¸€è¾¹åˆæœ‰ç›®çš„æ€§ï¼Œè¿˜æŒºçŸ›ç›¾çš„ï¼Œå¯èƒ½åšå¤šäº†ï¼Œè§å¤šäº†å°±ä¹ ä»¥ä¸ºå¸¸äº†ï¼Œä¹Ÿæ­£å¦‚å¥¹åšçš„é‚£æ ·ã€‚ â€œåœ¨è¿™ä¸ªç¤¾ä¼š,äººä¸äººä¹‹é—´äº§ç”Ÿä¸€ç§çˆ±çš„å…³ç³»æ˜¯ååˆ†é‡è¦çš„ï¼Œå› ä¸ºæˆ‘ä»¬æ–‡åŒ–ä¸­çš„å¾ˆå¤§ä¸€éƒ¨åˆ†å¹¶æ²¡æœ‰ç»™äºˆä½ è¿™ç§ä¸œè¥¿ã€‚å¯æ˜¯ç°åœ¨è¿™äº›å¯æ€œçš„å¹´è½»äººï¼Œè¦ä¹ˆè¿‡äºè‡ªç§è€Œæ— æ³•å’Œåˆ«äººå»ºç«‹çœŸè¯šçš„æ‹çˆ±å…³ç³»,è¦ä¹ˆè½»ç‡åœ°èµ°è¿›å©šå§»æ®¿å ‚,ç„¶åå…­ä¸ªæœˆååˆåŒ†åŒ†åœ°é€ƒäº†å‡ºæ¥ã€‚ä»–ä»¬å¹¶ä¸æ¸…æ¥šè¦ä»ä¼´ä¾£é‚£å„¿å¾—åˆ°ä»€ä¹ˆã€‚ä»–ä»¬è¿è‡ªå·±ä¹Ÿæ— æ³•è®¤æ¸…â€”â€”åˆå¦‚ä½•å»è®¤è¯†ä»–ä»¬è¦å«å¨¶çš„äººå‘¢ï¼Ÿâ€œ â€œä¸è¿‡ï¼Œçˆ±æƒ…å’Œå©šå§»è¿˜æ˜¯æœ‰ç« å¯å¾ªçš„ï¼šå¦‚æœä½ ä¸å°Šé‡å¯¹æ–¹ï¼Œä½ ä»¬çš„å…³ç³»å°±ä¼šæœ‰éº»çƒ¦;å¦‚æœä½ ä¸æ‡‚æ€æ ·å¦¥åï¼Œä½ ä»¬çš„å…³ç³»å°±ä¼šæœ‰éº»çƒ¦;å¦‚æœä½ ä»¬å½¼æ­¤ä¸èƒ½å¼€è¯šå¸ƒå…¬åœ°äº¤æµ,ä½ ä»¬çš„å…³ç³»å°±ä¼šæœ‰éº»çƒ¦;å¦‚æœä½ ä»¬æ²¡æœ‰å…±åŒçš„ä»·å€¼è§‚ï¼Œä½ ä»¬åŒæ ·ä¼šæœ‰éº»çƒ¦ã€‚ä½ ä»¬å¿…é¡»æœ‰ç›¸åŒçš„ä»·å€¼è§‚ã€‚è€Œè¿™ä¸€ä»·å€¼è§‚é‡Œæœ€é‡è¦çš„ï¼Œæ˜¯ä½ ä»¬å¯¹å©šå§»çš„é‡è¦æ€§çš„ä¿¡å¿µã€‚â€ â€”â€”ã€Šç¬¬åä¸ªæ˜ŸæœŸäºŒâ€”â€”è°ˆè®ºå©šå§»ã€‹ ç°åœ¨æ€»ç»“çš„è¯ï¼Œé¦–å…ˆæ˜¯è¦è®¤æ¸…è‡ªå·±ï¼ŒåŠæ—¶çš„åæ€ï¼Œç„¶åå†è®¤è¯†å¯¹æ–¹ã€‚ â€œè¿™å°±æ˜¯æˆ‘è¯´çš„ä½ åº”è¯¥å»ºç«‹ä¸€ä¸ªè‡ªå·±çš„å°æ–‡åŒ–ï¼Œæˆ‘å¹¶ä¸æ˜¯è®©ä½ å»å¿½è§†è¿™ä¸ªç¤¾ä¼šçš„æ¯ä¸€æ¡è°åˆ™ã€‚æ¯”æ–¹è¯´ï¼Œæˆ‘ä¸ä¼šå…‰ç€èº«äºå»å¤–é¢è½¬æ‚ ;æˆ‘ä¹Ÿä¸ä¼šå»é—¯çº¢ç¯ã€‚åœ¨è¿™ç±»å°äº‹æƒ…ä¸Šæˆ‘èƒ½éµçºªå®ˆæ³•ã€‚ä½†åœ¨å¤§é—®é¢˜ä¸Š å¦‚ä½•æ€æƒ³ï¼Œå¦‚ä½•è¯„åˆ¤ï¼Œä½ å¿…é¡»è‡ªå·±é€‰æ‹©ã€‚ä½ ä¸èƒ½è®©ä»»ä½•ä¸€ä¸ªäººâ€”â€”æˆ–ä»»ä½•ä¸€ä¸ªç¤¾ä¼šâ€”â€”æ¥æ›¿ä½ ä½œå‡ºå†³å®šã€‚â€œ â€”â€”ã€Šç¬¬åä¸€ä¸ªæ˜ŸæœŸäºŒâ€”â€”è°ˆè®ºæˆ‘ä»¬çš„æ–‡åŒ–ã€‹ æœ‰å¾ˆå¤šäº‹æƒ…å‰äººå·²ç»æ€»ç»“å¥½äº†ï¼Œå¸®ä½ åšå‡ºäº†å†³å®šï¼Œå¾ˆå¤šäººæœ‰æ—¶å€™åªæ˜¯ç›²ç›®çš„è·Ÿä»ï¼Œäººçš„ä¸€ç”Ÿè¦ç”±è‡ªå·±æ¥å†³å®šï¼Œæ‰€ä»¥åšå‡ºçš„å†³å®šè¦ç¬¦åˆè‡ªå·±çš„å†…å¿ƒã€‚Iriså­¦å§ä¹Ÿæåˆ°è¿‡ï¼šâ€œä¸èŒç›²ç›®å¬ä»å‰äººçš„è§è§£ï¼Œè™½ç„¶æˆ‘ä¹Ÿå±äºå‰äººâ€ã€‚ â€œä¸´æ­»å‰å…ˆåŸè°…è‡ªå·±ï¼Œç„¶ååŸè°…åˆ«äººã€‚åŸè°…è‡ªå·±åº”è¯¥åšè€Œæ²¡æœ‰åšçš„äº‹ã€‚ä½ ä¸åº”è¯¥é™·åœ¨é—æ†¾çš„æƒ…ç»ªä¸­æ— æ³•è‡ªæ‹”ï¼Œè¿™å¯¹ä½ æ˜¯æ²¡æœ‰ç›Šå¤„çš„ï¼Œå°¤å…¶æ˜¯å¤„åœ¨æˆ‘è¿™ä¸ªé˜¶æ®µã€‚â€ â€œæˆ‘ä¸€ç›´å¸Œæœ›è‡ªå·±å·¥ä½œå¾—æ›´å‡ºè‰²äº›ï¼Œå¸Œæœ›èƒ½å¤šå†™å‡ æœ¬ä¹¦ã€‚æˆ‘å¸¸å¸¸ä¸ºæ­¤è€Œè‡ªè´£ã€‚ç°åœ¨æˆ‘å‘ç°è¿™æ¯«æ— å¸®åŠ©ã€‚è·Ÿå®ƒå’Œè§£ã€‚è·Ÿè‡ªå·±å’Œè§£ã€‚è·Ÿä½ å‘¨å›´çš„äººå’Œè§£ã€‚â€ â€”â€”ã€Šç¬¬åäºŒä¸ªæ˜ŸæœŸäºŒâ€”â€”è°ˆè®ºåŸè°…ã€‹ å¯¹å•Šï¼Œå…ˆåŸè°…è‡ªå·±ï¼Œè®©è‡ªå·±ä¸å¤„åœ¨é—æ†¾çš„æƒ…ç»ªä¸­ï¼Œæ‘†è„±å‡ºæ¥ï¼Œæ‰èƒ½æ›´å¥½çš„ç†è§£åˆ«äººã€‚ä¸è¦æœ‰æ— æ³•é‡Šæ€€çš„æ¶ˆæ²‰æƒ…ç»ªã€‚ â€œå¦‚æœæˆ‘ä»¬çŸ¥é“æˆ‘ä»¬å¯ä»¥è¿™æ ·å»é¢å¯¹æ­»äº¡çš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½åº”ä»˜æœ€å›°éš¾çš„äº‹æƒ…äº†â€”â€”ä¸ç”Ÿæ´»è®²å’Œã€‚â€ â€œæ­»æ˜¯å¾ˆè‡ªç„¶çš„ï¼Œæˆ‘ä»¬ä¹‹æ‰€ä»¥å¯¹æ­»äº¡å¤§æƒŠå°æ€ªï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬æ²¡æœ‰æŠŠè‡ªå·±è§†ä½œè‡ªç„¶çš„ä¸€éƒ¨åˆ†ã€‚æˆ‘ä»¬è§‰å¾—æ—¢ç„¶æ˜¯äººå°±å¾—é«˜äºè‡ªç„¶ã€‚â€ â€”â€”ã€Šç¬¬åä¸‰ä¸ªæ˜ŸæœŸäºŒâ€”â€”è°ˆè®ºå®Œç¾çš„ä¸€å¤©ã€‹ æˆ‘ä»æ¥éƒ½è§‰å¾—æ­»äº¡æ˜¯ä¸€ç§å¾ˆæ­£å¸¸ä¸è¿‡çš„äº‹æƒ…ï¼Œå”¯ä¸€å®³æ€•çš„å¯èƒ½å°±æ˜¯å¦‚æœè‡ªå·±å¾—äº†ä»€ä¹ˆé‡ç—…ï¼Œè¦èŠ±è´¹å®¶é‡Œå¤ªå¤šé’±äº†å§ã€‚å¦‚æœæ¯•ç”Ÿè¿˜æœ‰æœªå®Œæˆçš„å¿ƒæ„¿ï¼Œé‚£ä¹ˆå°±å°½å¯èƒ½çš„åœ¨ä¸´ç»ˆå‰å®Œæˆï¼Œå¦‚æœæ­»äº¡å®åœ¨è¦èµ°åœ¨å¿ƒæ„¿çš„å‰é¢ï¼Œé‚£ä¹Ÿæ— èƒ½ä¸ºåŠ›äº†ï¼Œå¸¦ç€é—æ†¾ç»ˆäº†ä¹Ÿä¸æ˜¯ä»€ä¹ˆç¾æ„§çš„äº‹æƒ…ã€‚ â€œè¡Œäº†ï¼Œâ€œä»–ä½å£°è¯´ã€‚ â€”â€”ã€Šç¬¬åå››ä¸ªæ˜ŸæœŸäºŒâ€”â€”é“åˆ«ã€‹","link":"/2021/09/23/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E3%80%8A%E7%9B%B8%E7%BA%A6%E6%98%9F%E6%9C%9F%E4%BA%8C%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"}],"tags":[],"categories":[{"name":"Mac","slug":"Mac","link":"/categories/Mac/"},{"name":"iOSÂ·åº•å±‚åŸç†","slug":"iOSÂ·åº•å±‚åŸç†","link":"/categories/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/"},{"name":"iOSÂ·è´¨é‡&amp;æ•ˆç‡","slug":"iOSÂ·è´¨é‡-æ•ˆç‡","link":"/categories/iOS%C2%B7%E8%B4%A8%E9%87%8F-%E6%95%88%E7%8E%87/"},{"name":"è¯»ä¹¦ç¬”è®°","slug":"è¯»ä¹¦ç¬”è®°","link":"/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"},{"name":"iOSÂ·é—®é¢˜è®°å½•","slug":"iOSÂ·é—®é¢˜è®°å½•","link":"/categories/iOS%C2%B7%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/"},{"name":"iOSÂ·æ•°æ®å­˜å‚¨","slug":"iOSÂ·æ•°æ®å­˜å‚¨","link":"/categories/iOS%C2%B7%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/"},{"name":"è§‚å½±ç¬”è®°","slug":"è§‚å½±ç¬”è®°","link":"/categories/%E8%A7%82%E5%BD%B1%E7%AC%94%E8%AE%B0/"},{"name":"åšå®¢é…ç½®","slug":"åšå®¢é…ç½®","link":"/categories/%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE/"}]}