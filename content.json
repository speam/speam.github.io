{"pages":[{"title":"å…³äºæœ¬ç«™","text":"è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚","link":"/about/index.html"}],"posts":[{"title":"M1èŠ¯ç‰‡Macå®‰è£…ä»»æ„iOS Appçš„æ–¹å¼","text":"1.å®‰è£… Apple Configurator2 2.è¿æ¥ iPhoneï¼Œç‚¹å‡»æ·»åŠ  appï¼Œæ‰¾åˆ°å¯¹åº”çš„ App åå°±ä¼šè‡ªåŠ¨å¼€å§‹ä¸‹è½½ 3.ä¸‹è½½å®Œæˆåä¼šæç¤ºè®¾å¤‡ä¸Šå­˜åœ¨è¿™ä¸ªåº”ç”¨ï¼Œè¿™ä¸ªæ—¶å€™ä¸è¦ç‚¹ä»»ä½•æŒ‰é’® 4.æ‰“å¼€ï¼š 1~/Library/Group Containers/K36BKF7T3D.group.com.apple.configurator/Library/Caches/Assets/TemporaryItems/MobileApps/ å¯ä»¥çœ‹åˆ°å·²ç»ä¸‹è½½å¥½çš„ ipa å®‰è£…åŒ…ï¼ŒæŠŠå®ƒæ‹·è´å‡ºæ¥ï¼Œä¸ç„¶ä¼šè¢«è‡ªåŠ¨åˆ é™¤ï¼ˆæˆ–è€…ç›´æ¥åŒå‡»å®‰è£…ï¼‰ 5.åŒå‡» ipa å®‰è£…ï¼Œæ‰“å¼€æ—¶ä¼šæç¤ºæ²¡æœ‰æƒé™ 6.æ‰“å¼€ç»ˆç«¯ï¼Œè¾“å…¥ 1sudo xattr -r -d com.apple.quarantine Appè·¯å¾„ (ä¾‹å¦‚ sudo xattr -r -d com.apple.quarantine /Applications/WeChat.app ) ç„¶åå°±å¯ä»¥æ­£å¸¸æ‰“å¼€ Appï¼Œæ„‰å¿«çš„ç©è€äº†ã€‚","link":"/2020/11/28/Mac/M1%E8%8A%AF%E7%89%87Mac%E5%AE%89%E8%A3%85%E4%BB%BB%E6%84%8FiOS%20App%E7%9A%84%E6%96%B9%E5%BC%8F/"},{"title":"Macåº”ç”¨ç¨‹åºæ— æ³•æ‰“å¼€æˆ–æ–‡ä»¶æŸåçš„è§£å†³åŠæ³•","text":"ä¸€ã€é‡åˆ°æç¤º â€œXXX.app å·²æŸåï¼Œæ‰“ä¸å¼€ã€‚æ‚¨åº”è¯¥å°†å®ƒç§»åˆ°åºŸçº¸ç¯“ â€ æˆ– â€œ æ‰“ä¸å¼€ XXX.appï¼Œå› ä¸ºå®ƒæ¥è‡ªèº«ä»½ä¸æ˜çš„å¼€å‘è€…â€œ è§£å†³åŠæ³•ï¼š æ‰“å¼€ç³»ç»Ÿåå¥½è®¾ç½®ç•Œé¢ï¼Œè¿›å…¥å®‰å…¨æ€§ä¸éšç§ ç‚¹æŒ‰å·¦ä¸‹è§’çš„é”å›¾æ ‡ï¼Œè§£é”æ›´æ”¹æƒé™ å°†å…è®¸ä»ä»¥ä¸‹ä½ç½®ä¸‹è½½çš„åº”ç”¨ï¼Œæ›´æ”¹ä¸º â€œä»»ä½•æ¥æºâ€ ï¼Œç„¶åå†æ‰“å¼€åº”ç”¨å³å¯ äºŒã€æç¤ºå·²æŸåæ— æ³•æ‰“å¼€ æ‰“å¼€ç»ˆç«¯ï¼› è¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼Œå›è½¦ï¼›sudo xattr -d com.apple.quarantine /Applications/xxxx.appæ³¨æ„ï¼š/Applications/xxxx.app æ¢æˆä½ çš„Appè·¯å¾„ é‡å¯Appå³å¯ã€‚","link":"/2021/05/08/Mac/Mac%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E6%97%A0%E6%B3%95%E6%89%93%E5%BC%80%E6%88%96%E6%96%87%E4%BB%B6%E6%8D%9F%E5%9D%8F%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/"},{"title":"01-å¯¹è±¡çš„åˆ›å»º","text":"ä¸€ã€å‰è¨€çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š æ€è€ƒallocå’Œinitåº•å±‚åˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿå¸¦ç€è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬ä»æºç çš„è§’åº¦æ¢ç´¢ã€‚ äºŒã€åˆ†æ alloc æºç 1.0 å‡†å¤‡å·¥ä½œ1.ä» è‹¹æœå®˜æ–¹å¼€æºä»£ç åˆ—è¡¨ æ‰¾åˆ° objc4æºç ã€‚ è‹¹æœäº 2006 å¹´å‘å¸ƒ Objective-C 2.0 ï¼Œé‡å†™äº† Objective-C 1.0 ä¸­ç±»ä¸å¯¹è±¡çš„å®šä¹‰ï¼Œå‘½åä¸º objc4 2.ä¸‹è½½åˆ°æœ¬åœ°åï¼Œéœ€è¦å¯¹å·¥ç¨‹è¿›è¡Œä¸€ç•ªç¼–è¯‘è°ƒè¯•ï¼Œå…·ä½“æ­¥éª¤å¯å‚è€ƒ Cooci çš„åšå®¢ iOS_objc4-756.2 æœ€æ–°æºç ç¼–è¯‘è°ƒè¯•ã€‚ 3.ç¼–è¯‘é€šè¿‡åï¼Œå°±å¯ä»¥æ–°å»ºä¸ª target è°ƒè¯•äº† æˆ‘ Github ä¸Šçš„æºç ï¼šhttps://github.com/speam/OjbcSuorce.git 4.å¸¸ç”¨çš„ä»£ç è·Ÿè¸ªæ–¹å¼ï¼š Xcode èœå•æ ä¾æ¬¡ç‚¹å‡»Debug-&gt;Debug Workflow-&gt;Always show Disassembly control + step into ä¸‹ç¬¦å·æ–­ç‚¹ï¼Œå¦‚alloc 1.1 objc_allocâ€”allocçš„çœŸæ­£å…¥å£ç»™[Person alloc]åŠ æ–­ç‚¹ æ­¤æ—¶ï¼Œåœ¨Xcodeçš„èœå•æ ä¾æ¬¡ç‚¹å‡»Debug-&gt;Debug Workflow-&gt;Always show Disassemblyï¼Œå¾—åˆ°æ±‡ç¼–ä»£ç ï¼Œå‘ç°è°ƒç”¨äº†objc_alloc: å®šä½åˆ°objc_alloc()ï¼Œå‘ç°å†…éƒ¨è°ƒç”¨callAlloc() 1.2 callAllocåˆ†æobjc_alloc()å†…éƒ¨è°ƒç”¨callAlloc()ï¼Œå…¶æºç ä¸ºï¼š 123456789101112131415161718192021222324252627282930313233// Call [cls alloc] or [cls allocWithZone:nil], with appropriate // shortcutting optimizations.static ALWAYS_INLINE idcallAlloc(Class cls, bool checkNil, bool allocWithZone=false){ if (slowpath(checkNil &amp;&amp; !cls)) return nil;#if __OBJC2__ if (fastpath(!cls-&gt;ISA()-&gt;hasCustomAWZ())) { // No alloc/allocWithZone implementation. Go straight to the allocator. // fixme store hasCustomAWZ in the non-meta class and // add it to canAllocFast's summary if (fastpath(cls-&gt;canAllocFast())) { // æ°¸è¿œä¸èµ°è¿™é‡Œ // No ctors, raw isa, etc. Go straight to the metal. bool dtor = cls-&gt;hasCxxDtor(); id obj = (id)calloc(1, cls-&gt;bits.fastInstanceSize()); if (slowpath(!obj)) return callBadAllocHandler(cls); obj-&gt;initInstanceIsa(cls, dtor); return obj; } else { // æ°¸è¿œèµ°è¿™é‡Œ // Has ctor or raw isa or something. Use the slower path. id obj = class_createInstance(cls, 0); if (slowpath(!obj)) return callBadAllocHandler(cls); return obj; } }#endif // No shortcuts available. if (allocWithZone) return [cls allocWithZone:nil]; return [cls alloc];} å¯¹callAlloc()çš„åˆ†æå¦‚ä¸‹ï¼š â‘ __OBJC2__åœ¨ OC2.0 ä»¥åä¸º1ï¼Œæºç ï¼š 12345678// Define __OBJC2__ for the benefit of our asm files.#ifndef __OBJC2__# if TARGET_OS_OSX &amp;&amp; !TARGET_OS_IOSMAC &amp;&amp; __i386__ // old ABI# else# define __OBJC2__ 1 // æ€»ä¹‹éƒ½æ˜¯1# endif#endif â‘¡slowpath(bool)ä¸fastpath(bool)ï¼šå¸¸ç”¨äºif-elseï¼Œå¯ä»¥ä¼˜åŒ–åˆ¤æ–­çš„é€Ÿåº¦ã€‚ 12345// fastpath(x)ï¼šè¡¨ç¤ºè¿”å›å€¼ä¸ºxï¼Œä¸”xå¾ˆæœ‰å¯èƒ½ä¸º1#define fastpath(x) (__builtin_expect(bool(x), 1))// slowpath(x)ï¼šè¡¨ç¤ºè¿”å›å€¼ä¸ºxï¼Œä¸”xå¾ˆæœ‰å¯èƒ½ä¸º0#define slowpath(x) (__builtin_expect(bool(x), 0)) â‘¢hasCustomAWZ()ï¼šæ„æ€æ˜¯hasCustomAllocWithZoneï¼Œå³æ˜¯å¦æœ‰é‡å†™ç±»çš„+allocWithZone:æ–¹æ³•ï¼Œä½†æ˜¯å®ƒçš„å€¼å¹¶ä¸èƒ½ç®€å•åœ°è¿™ä¹ˆåˆ¤æ–­ï¼å…ˆçœ‹æºç  123bool hasCustomAWZ() { return ! bits.hasDefaultAWZ();} æ³¨æ„ï¼šhasCustomAWZ()çš„å€¼é—®é¢˜ã€éå¸¸é‡è¦ï¼Œè®¾ç½®åˆå§‹åŒ–é¡ºåºï¼Œå¾ˆå¤šåšå®¢ä¸­æ ¹æœ¬æ²¡æœ‰æåˆ°ï¼ã€‘ ç±»çš„+initializeæ–¹æ³•ä¸»è¦ç”¨äºåˆå§‹åŒ–é™æ€å˜é‡ã€‚åœ¨å…¶æ‰§è¡Œä¹‹å‰ï¼ŒhasDefaultAWZ()å€¼ä¸ºfalseï¼Œå³hasCustomAWZ()ä¸ºtrueï¼›å…¶æ‰§è¡Œä¹‹åï¼Œå¦‚æœå½“å‰ç±»é‡å†™äº†+allocWithZone:æ–¹æ³•ï¼ŒhasCustomAWZ()ä¸ºtrueï¼Œå¦åˆ™ä¸ºfalseï¼ˆä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šé‡å†™ï¼Œå³hasCustomAWZä¸ºfalseï¼‰ã€‚ ç±»çš„+initializeæ–¹æ³•ä¼šåœ¨ç¬¬ä¸€æ¬¡åˆå§‹åŒ–è¯¥ç±»ä¹‹å‰è°ƒç”¨ã€‚å½“è°ƒç”¨[cls alloc]æ—¶ï¼Œä¼šè§¦å‘objc_msgSendï¼Œç„¶åä¼šæ‰§è¡Œ+initialize:ã€‚ï¼ˆæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥åˆ†åˆ«æ‰“å°+allocå’Œ+initialize:æ–¹æ³•åŠ ä»¥éªŒè¯ï¼‰ å› æ­¤ï¼Œå½“ç±»ç¬¬ä¸€æ¬¡æ¥åˆ°callAlloc()æ—¶ï¼Œæœ€ç»ˆä¼šæ‰§è¡Œ[cls alloc]ã€‚ â‘£canAllocFast()æºç å¦‚ä¸‹ï¼š 1234bool canAllocFast() { assert(!isFuture()); return bits.canAllocFast();} å†å¾€åº•å±‚æ‰¾bits.canAllocFast()ï¼Œå‘ç°å…³é”®å®FAST_ALLOC 1234567891011#if FAST_ALLOC ... bool canAllocFast() { return bits &amp; FAST_ALLOC; }#else ... bool canAllocFast() { return false; }#endif ç»§ç»­æ·±å…¥ï¼Œæ¥åˆ°äº†FAST_ALLOCå®å®šä¹‰ä¹‹å¤„ 123456789#if !__LP64__ // å½“å‰æ“ä½œç³»ç»Ÿä¸æ˜¯64ä½...#elif 1 // å½“å‰æ“ä½œç³»ç»Ÿæ˜¯64ä½...#else ...#define FAST_ALLOC (1UL&lt;&lt;2) // æ‰¾åˆ°äº†...#endif ä»ä¸Šé¢å®ä»£ç å¯ä»¥å¾—å‡ºè¿™æ ·çš„ç»“è®ºï¼Œå³æ— è®ºå½“å‰æ“ä½œç³»ç»Ÿæ˜¯ä¸æ˜¯64ä½ï¼Œéƒ½æ²¡æœ‰å®šä¹‰FAST_ALLOCï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒcanAllocFast()æ°¸è¿œæ˜¯false! å› æ­¤ï¼Œå¦‚æœhasCustomAWZ()ä¸ºfalseæ—¶ï¼Œä¼šç›´æ¥å»åˆ°class_createInstance()ã€‚ 1.3 alloc-&gt;_objc_rootAlloc-&gt;callAlloc-&gt;class_createInstanceé€šè¿‡å¯¹hasCustomAWZ()çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“ç±»çš„ç¬¬ä¸€æ¬¡åˆå§‹åŒ–æœ€ç»ˆæ˜¯èµ°åˆ°callAllocçš„æœ€åï¼Œå³return [cls alloc]; â‘ ç”±äºæ‰§è¡Œäº†[cls alloc]ï¼Œè¿™æ¬¡çœŸçš„æ¥åˆ°alloc()æ–¹æ³•äº† 123+ (id)alloc { return _objc_rootAlloc(self);} â‘¡æ¥ç€æ˜¯_objc_rootAlloc() 1234567// Base class implementation of +alloc. cls is not nil.// Calls [cls allocWithZone:nil].id_objc_rootAlloc(Class cls){ return callAlloc(cls, false/*checkNil*/, true/*allocWithZone*/); // æ³¨æ„è¿™é‡Œçš„ä¸‰ä¸ªå‚æ•°} â‘¢å†æ¬¡æ¥åˆ°callAllocï¼Œæ­¤æ—¶hasCustomAWZ()çš„å€¼å–å†³äºå½“å‰ç±»æ˜¯å¦é‡å†™äº†+allocWithZone:æ–¹æ³•ã€‚ ç”±äºPersonç±»æ²¡æœ‰é‡å†™ï¼Œfastpath(!cls-&gt;ISA()-&gt;hasCustomAWZ())ä¸ºtrueï¼Œè€ŒcanAllocFast()æ°¸è¿œä¸ºfalseã€‚ å› æ­¤ï¼Œæ¥ä¸‹æ¥ä¼šèµ°åˆ°class_createInstance()ï¼Œå…¶æºç å¦‚ä¸‹ï¼š 12345id class_createInstance(Class cls, size_t extraBytes){ return _class_createInstanceFromZone(cls, extraBytes, nil);} 1.4 _class_createInstanceFromZoneé¡¾åæ€ä¹‰ï¼Œè¿™æ˜¯è¦åˆ›å»ºå¯¹è±¡ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546static __attribute__((always_inline)) id_class_createInstanceFromZone(Class cls, size_t extraBytes, void *zone, bool cxxConstruct = true, size_t *outAllocatedSize = nil){ if (!cls) return nil; assert(cls-&gt;isRealized()); // ä¸€æ¬¡è¯»å–ç±»çš„ä¿¡æ¯ä½ä»¥æé«˜æ€§èƒ½ bool hasCxxCtor = cls-&gt;hasCxxCtor(); // æ˜¯å¦æœ‰æ„é€ å‡½æ•° bool hasCxxDtor = cls-&gt;hasCxxDtor(); // æ˜¯å¦æœ‰ææ„å‡½æ•° bool fast = cls-&gt;canAllocNonpointer(); // OC 2.0ä»¥ä¸ŠåŸºæœ¬ä¸Šè¿”å›çš„éƒ½æ˜¯true // è®¡ç®—å†…å­˜ size_t size = cls-&gt;instanceSize(extraBytes); if (outAllocatedSize) *outAllocatedSize = size; id obj; if (!zone &amp;&amp; fast) { // åˆ†é…1å—å¤§å°ä¸ºsizeçš„è¿ç»­å†…å­˜ obj = (id)calloc(1, size); if (!obj) return nil; // åˆå§‹åŒ–å¯¹è±¡çš„isa obj-&gt;initInstanceIsa(cls, hasCxxDtor); } else { if (zone) { obj = (id)malloc_zone_calloc ((malloc_zone_t *)zone, 1, size); } else { obj = (id)calloc(1, size); } if (!obj) return nil; // Use raw pointer isa on the assumption that they might be // doing something weird with the zone or RR. obj-&gt;initIsa(cls); } if (cxxConstruct &amp;&amp; hasCxxCtor) { obj = _objc_constructOrFree(obj, cls); } return obj;} å¯¹_class_createInstanceFromZone()çš„åˆ†æå¦‚ä¸‹ï¼š â‘ cls-&gt;instanceSize(extraBytes)è®¡ç®—å†…å­˜ï¼Œæ­¤æ—¶çš„extraBytesæ˜¯0ï¼Œå…¶æºç æ˜¯ 1234567891011121314151617181920212223242526272829303132// 1.size_t instanceSize(size_t extraBytes) { size_t size = alignedInstanceSize() + extraBytes; // CF requires all objects be at least 16 bytes. if (size &lt; 16) size = 16; return size;}// 2.uint32_t alignedInstanceSize() { return word_align(unalignedInstanceSize());}// 3. å­—èŠ‚å¯¹é½static inline uint32_t word_align(uint32_t x) { return (x + WORD_MASK) &amp; ~WORD_MASK;}static inline size_t word_align(size_t x) { return (x + WORD_MASK) &amp; ~WORD_MASK;}// 4.#ifdef __LP64__# define WORD_SHIFT 3UL# define WORD_MASK 7UL# define WORD_BITS 64#else# define WORD_SHIFT 2UL# define WORD_MASK 3UL# define WORD_BITS 32#endif å¯è§ï¼ŒWORD_MASKåœ¨64ä½ç³»ç»Ÿä¸‹æ˜¯7ï¼Œå¦åˆ™æ˜¯3ï¼Œword_align()æ–¹æ³•å°±æ˜¯è¿›è¡Œå­—èŠ‚å¯¹é½çš„ã€‚ å­—èŠ‚å¯¹é½ç®—æ³•ï¼š(x + WORD_MASK) &amp; ~WORD_MASK 12345678910111213141516å‡å¦‚ï¼š x = 9ï¼Œå·²çŸ¥ WORD_MASK = 7 x + WORD_MASK = 9 + 7 = 16 WORD_MASK äºŒè¿›åˆ¶ ï¼š0000 0111 = 7 ï¼ˆ4+2+1ï¼‰ ~WORD_MASK äºŒè¿›åˆ¶ : 1111 1000 16çš„äºŒè¿›åˆ¶ä¸º : 0001 0000 0001 0000 &amp; 1111 1000--------------- 0001 0000 = 16æ‰€ä»¥å­—èŠ‚å¯¹é½åè¿”å›16 ä¹Ÿå°±æ˜¯8çš„å€æ•°å¯¹é½ï¼Œå³8å­—èŠ‚å¯¹é½ å› æ­¤ï¼Œword_align()åœ¨64ä½ç³»ç»Ÿä¸‹æ˜¯8å­—èŠ‚å¯¹é½ï¼Œå¦åˆ™æ˜¯4å­—èŠ‚å¯¹é½ã€‚ åŒæ—¶ï¼ŒinstanceSize()å‡½æ•°åˆå¯¹å†…å­˜å¤§å°åˆè¿›è¡Œäº†æœ€å°16å­—èŠ‚çš„é™åˆ¶ã€‚ â‘¡canAllocNonpointer()æ˜¯å¯¹isaçš„ç±»å‹çš„åŒºåˆ†ï¼Œå¦‚æœä¸€ä¸ªç±»ä½¿ç”¨isa_tç±»å‹çš„isaçš„è¯å°±è¿”å›trueï¼Œæˆ‘ä»¬ä¸ç”¨å¤ªå…³å¿ƒï¼ŒOC 2.0ä»¥ä¸ŠåŸºæœ¬ä¸Šè¿”å›çš„éƒ½æ˜¯trueï¼Œæ‰€ä»¥fastå°±æ˜¯trueï¼›è€Œåœ¨__OBJC2__ä¸­ï¼Œzoneä¼šè¢«å¿½ç•¥ï¼Œæ‰€ä»¥!zoneä¹Ÿæ˜¯trueï¼› ç»¼ä¸Šï¼Œæ¥ç€å°±æ˜¯calloc()å’ŒinitInstanceIsa()ã€‚ â‘¢size_t size = cls-&gt;instanceSize(extraBytes);è¿™ä¸€æ­¥å¾—åˆ°äº†è®¡ç®—åçš„sizeï¼Œä¼ åˆ°calloc(1, size)ä¸­è¿›è¡Œåˆ†é…å†…å­˜ã€‚ â‘£calloc()çš„åº•å±‚æºç æ˜¯åœ¨è‹¹æœå¼€æºçš„libmallocæºç ä¸­(æˆ‘Githubä¸­ä¹Ÿå‡†å¤‡äº†)ï¼Œç»è¿‡æ–­ç‚¹è·Ÿè¸ª(ä¸­é—´è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œç•¥è¿‡å…ˆ)ï¼Œå‘ç°calloc()åˆ†é…çš„å†…å­˜å¤§å°å—segregated_size_to_fit()å½±å“ï¼Œçœ‹ä¸‹é¢æºç ï¼š 123456789101112131415161718192021static MALLOC_INLINE size_tsegregated_size_to_fit(nanozone_t *nanozone, size_t size, size_t *pKey) // è¿™é‡Œçš„sizeå°±æ˜¯calloc(1, size)ä¸­ä¼ è¿‡æ¥çš„{ size_t k, slot_bytes; if (0 == size) { // Historical behavior size = NANO_REGIME_QUANTA_SIZE; } // round up and shift for number of quanta k = (size + NANO_REGIME_QUANTA_SIZE - 1) &gt;&gt; SHIFT_NANO_QUANTUM; // multiply by power of two quanta size slot_bytes = k &lt;&lt; SHIFT_NANO_QUANTUM; // Zero-based! *pKey = k - 1; return slot_bytes;}#define SHIFT_NANO_QUANTUM 4#define NANO_REGIME_QUANTA_SIZE (1 &lt;&lt; SHIFT_NANO_QUANTUM) // 16 ä»ä»£ç å¯ä»¥çœ‹å‡ºï¼Œslot_bytesç­‰äº(size + 16-1) &gt;&gt; 4 &lt;&lt; 4ï¼Œæ˜¯16å­—èŠ‚å¯¹é½ï¼Œæ‰€ä»¥å°±æ˜¯å°†è®¡ç®—å¾—åˆ°çš„sizeè¿›è¡Œä¸€æ¬¡16å­—èŠ‚å¯¹é½ï¼Œå› æ­¤calloc()åˆ†é…çš„å†…å­˜å¤§å°å¿…ç„¶æ˜¯16å­—èŠ‚çš„æ•´æ•°å€ï¼Œå› æ­¤ä¸ºå¯¹è±¡åˆ†é…çš„å†…å­˜ç©ºé—´ä¸€å®šæ˜¯16å­—èŠ‚å¯¹é½çš„ã€‚ â‘¤initInstanceIsa()å°±æ˜¯åˆå§‹åŒ–isaï¼Œå¹¶ä¸”å…³è”clsã€‚ ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œ_class_createInstanceFromZone()åšäº†å¾ˆå¤šäº‹æƒ…ï¼Œå¹¶ä¸”æœ€ç»ˆç¡®å®åˆ›å»ºäº†å¯¹è±¡ï¼Œå‡ ä¹å¹²äº†æ‰€æœ‰äº‹æƒ…ï¼Œé‚£ä¹ˆï¼Œinitåˆåˆ°åº•åšäº†ä»€ä¹ˆå‘¢ï¼Ÿ ä¸‰ã€initå’Œnew1. init1234567891011- (id)init { return _objc_rootInit(self);}id_objc_rootInit(id obj){ // In practice, it will be hard to rely on this function. // Many classes do not properly chain -init calls. return obj;} éå¸¸ç®€å•ï¼Œinitä»…ä»…æ˜¯å°†allocåˆ›å»ºçš„å¯¹è±¡è¿”å›ã€‚æ˜¯ä¸€ç§å·¥å‚è®¾è®¡æ–¹æ¡ˆï¼Œæ–¹ä¾¿å­ç±»é‡å†™ã€‚ 2. newæˆ‘ä»¬å†çœ‹çœ‹new 123+ (id)new { return [callAlloc(self, false/*checkNil*/) init];} å¾ˆæ˜æ˜¾ï¼Œnewç›¸å½“äºalloc+initã€‚ å››ã€æ€»ç»“å…³äºallocã€initä»¥åŠnewçš„æºç åˆ†æå°±åˆ°è¿™äº†ã€‚åœ¨allocçš„è¿‡ç¨‹ä¸­ï¼ŒcallAllocå’Œ_class_createInstanceFromZoneè¿™ä¸¤ä¸ªå‡½æ•°æ˜¯é‡ç‚¹ã€‚ ä»¥ä¸Šæºç æµç¨‹åˆ†æï¼Œæ˜¯å»ºç«‹åœ¨objc4-756.2æºç çš„åŸºç¡€ä¸Šçš„ï¼Œ756.2æ˜¯ç›®å‰æœ€æ–°çš„ç‰ˆæœ¬ã€‚ ä¸‹é¢ç”¨æµç¨‹å›¾æ€»ç»“ä¸€ä¸‹allocåˆ›å»ºå¯¹è±¡çš„è¿‡ç¨‹ï¼šï¼ˆè¿™æ˜¯æˆ‘çœ‹è¿‡çš„åšå®¢ä¸­ï¼Œæœ€å‡†ç¡®çš„å›¾ï¼‰ äº”ã€æºç æˆ‘çš„ malloc æºç  æˆ‘çš„ libobjc æºç  è‹¹æœå®˜æ–¹ objc4 æºç  å‚è€ƒçº¢é…’ç‰›æ’ https://juejin.im/post/6844904038467633160#heading-15","link":"/2020/10/29/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/01-%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%88%9B%E5%BB%BA/"},{"title":"07ä¸Š-é€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶å’ŒMach-Oæ–‡ä»¶","text":"å‰è¨€è¦ç ”ç©¶dyldçš„åŠ è½½æµç¨‹ï¼Œé¦–å…ˆè¦äº†è§£é€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶å’ŒMach-Oæ–‡ä»¶ã€‚ ä¸€ã€é€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶1.1 ç®€ä»‹Universal Binaryå°†å¤šç§æ¶æ„çš„ Mach-O æ–‡ä»¶åˆå¹¶è€Œæˆã€‚å®ƒé€šè¿‡ header æ¥è®°å½•ä¸åŒæ¶æ„åœ¨æ–‡ä»¶ä¸­çš„åç§»é‡ã€‚ç³»ç»Ÿåœ¨åŠ è½½è¿è¡Œè¯¥ç¨‹åºæ—¶ï¼Œä¼šæ ¹æ®Universal Binaryä¸­æä¾›çš„å¤šä¸ªæ¶æ„æ¥ä¸å½“å‰ç³»ç»Ÿå¹³å°åšåŒ¹é…ï¼Œè¿è¡Œé€‚åˆå½“å‰ç³»ç»Ÿçš„é‚£ä¸ªç‰ˆæœ¬ã€‚ 1.2 ç§ç±»é€šç”¨äºŒè¿›åˆ¶çš„â€é€šç”¨â€ä¸æ­¢é’ˆå¯¹å¯ä»¥ç›´æ¥è¿è¡Œçš„å¯æ‰§è¡Œç¨‹åºã€‚åŒ…å«ä»¥ä¸‹å‡ ç§ï¼š Mach-O Object ç›®æ ‡æ–‡ä»¶ .o Mach-O ececutableå¯æ‰§è¡Œæ–‡ä»¶ Mach-O dynamically åŠ¨æ€åº“æ–‡ä»¶ .a .dylib Framework Mach-O dynamic linker åŠ¨æ€é“¾æ¥å™¨æ–‡ä»¶ dyld Mach-O dSYM companion ç¬¦å·è¡¨æ–‡ä»¶.dsymï¼Œç­‰ æ’ä¸€å¥ï¼Œæœ‰åŠ¨æ€åº“å°±æœ‰é™æ€åº“ï¼Œé‚£ä¹ˆå®ƒä»¬çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿçœ‹å›¾ï¼š é™æ€åº“ï¼š åŠ¨æ€åº“ï¼š é€šè¿‡ä¸Šé¢ä¸¤å¹…å›¾æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼š é™æ€åº“è¡¨ç°ä¸ºï¼šåœ¨é“¾æ¥é˜¶æ®µä¼šå°†æ±‡ç¼–ç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶ä¸å¼•ç”¨çš„åº“ä¸€èµ·é“¾æ¥æ‰“åŒ…è¿›å¯æ‰§è¡Œæ–‡ä»¶ä¸­ã€‚ åŠ¨æ€åº“è¡¨ç°ä¸ºï¼šç¨‹åºç¼–è¯‘å¹¶ä¸ä¼šé“¾æ¥åˆ°ç›®æ ‡ä»£ç ä¸­ï¼Œåœ¨ç¨‹åºå¯æ‰§è¡Œæ–‡ä»¶é‡Œé¢ä¼šä¿ç•™å¯¹åŠ¨æ€åº“çš„å¼•ç”¨ã€‚å…¶ä¸­ï¼ŒåŠ¨æ€åº“åˆ†ä¸ºåŠ¨æ€é“¾æ¥åº“å’ŒåŠ¨æ€åŠ è½½åº“ã€‚ åŠ¨æ€é“¾æ¥åº“ï¼šåœ¨æ²¡æœ‰è¢«åŠ è½½åˆ°å†…å­˜çš„å‰æä¸‹ï¼Œå½“å¯æ‰§è¡Œæ–‡ä»¶è¢«åŠ è½½ï¼ŒåŠ¨æ€åº“ä¹Ÿéšç€è¢«åŠ è½½åˆ°å†…å­˜ä¸­ã€‚åœ¨ Linked Framework and Libraries è®¾ç½®çš„ä¸€äº› share librariesã€‚ã€éšç€ç¨‹åºå¯åŠ¨è€Œå¯åŠ¨ã€‘ åŠ¨æ€åŠ è½½åº“ï¼šå½“éœ€è¦çš„æ—¶å€™å†ä½¿ç”¨ dlopen ç­‰é€šè¿‡ä»£ç æˆ–è€…å‘½ä»¤çš„æ–¹å¼æ¥åŠ è½½ã€‚ã€åœ¨ç¨‹åºå¯åŠ¨ä¹‹åï¼Œç”¨åˆ°å†å»å¯åŠ¨ã€‘ 1.3 æ“ä½œé€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶1.3.1 æŸ¥çœ‹è‹¹æœè‡ªå®¶ç³»ç»Ÿä¸­å­˜åœ¨ç€å¾ˆå¤šé€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶ã€‚æ¯”å¦‚/usr/bin/pythonï¼Œåœ¨ç»ˆç«¯ä¸­æ‰§è¡Œfileå‘½ä»¤å¯ä»¥æŸ¥çœ‹å®ƒçš„ä¿¡æ¯ï¼š 1234$ file /usr/bin/python/usr/bin/python: Mach-O universal binary with 2 architectures/usr/bin/python (for architecture x86_64): Mach-O 64-bit executable x86_64/usr/bin/python (for architecture i386): Mach-O executable i386 1.3.2 æå–ç³»ç»Ÿæä¾›äº†ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·lipoæ¥æ“ä½œé€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶ã€‚å¯ä»¥æ·»åŠ ã€æå–ã€åˆ é™¤ä»¥åŠæ›¿æ¢é€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ç‰¹å®šæ¶æ„çš„äºŒè¿›åˆ¶ç‰ˆæœ¬ã€‚ ä¾‹å¦‚æå–pythonä¸­x86_64ç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶å¯ä»¥æ‰§è¡Œï¼š 1$ lipo /usr/bin/python -extract x86_64 -output ~/Desktop/python.x64 1.3.3 åˆ é™¤åˆ é™¤x86ç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶å¯ä»¥æ‰§è¡Œï¼š 1$ lipo /usr/bin/python -remove i386 -output ~/Desktop/python.x64 1.3.4 ç˜¦èº«æˆ–è€…ç›´æ¥ç˜¦èº«ä¸ºx86_64ç‰ˆæœ¬ï¼š 1$ lipo /usr/bin/python -thin x86_64 -output ~/Desktop/python.x64 1.4 æºç åˆ†æä¸‹è½½** MachOView**ï¼Œæœç´¢fat.hï¼ŒæŸ¥çœ‹æºç ï¼š 12345678910111213141516171819#include &lt;stdint.h&gt;#include &lt;mach/machine.h&gt;#include &lt;architecture/byte_order.h&gt;#define FAT_MAGIC 0xcafebabe#define FAT_CIGAM 0xbebafeca /* NXSwapLong(FAT_MAGIC) */struct fat_header { uint32_t magic; /* FAT_MAGIC */ uint32_t nfat_arch; /* number of structs that follow */};struct fat_arch { cpu_type_t cputype; /* cpu specifier (int) */ cpu_subtype_t cpusubtype; /* machine specifier (int) */ uint32_t offset; /* file offset to this object file */ uint32_t size; /* size of this object file */ uint32_t align; /* alignment as a power of 2 */}; fat_headerç»“æ„ä½“ä¸­ï¼š magicå­—æ®µå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„é­”æ•°ï¼ˆä¾‹å¦‚é€šå¸¸åˆ¤æ–­pngæ–‡ä»¶æ ¼å¼ï¼Œè¿˜æœ‰å¿«é€Ÿæ±‚å¹³æ–¹æ ¹çš„[0x5f3759dfï¼‰ï¼ŒåŠ è½½å™¨é€šè¿‡è¿™ä¸ªé­”æ•°å€¼æ¥åˆ¤æ–­è¿™æ˜¯ä»€ä¹ˆæ ·çš„æ–‡ä»¶ï¼Œèƒ–äºŒè¿›åˆ¶æ–‡ä»¶çš„é­”æ•°å€¼æ˜¯å®šå€¼0xcafebabe nfat_archå­—æ®µæ˜¯æŒ‡å½“å‰çš„èƒ–äºŒè¿›åˆ¶æ–‡ä»¶åŒ…å«äº†å¤šå°‘ä¸ªä¸åŒæ¶æ„çš„Mach-Oæ–‡ä»¶ã€‚fat_headeråä¼šè·Ÿç€ä¸€ä¸ªæˆ–å¤šä¸ªè¿ç»­çš„fat_archï¼Œæœ‰å¤šå°‘ä¸ªä¸åŒæ¶æ„çš„Mach-Oæ–‡ä»¶ï¼Œå°±æœ‰å¤šå°‘ä¸ªfat_archã€‚ fat_archç»“æ„ä½“ä¸­ï¼š cputypeæŒ‡å®šäº†å…·ä½“çš„cpuç±»å‹ï¼Œå®ƒçš„ç±»å‹æ˜¯cpu_type_tï¼Œå®šä¹‰ä½äºmach/machine.hä¸­ã€‚cpuçš„å¸¸ç”¨ç±»å‹ä¸»è¦æœ‰å¦‚ä¸‹å‡ ç§ï¼š 123456789101112#define CPU_TYPE_X86 ((cpu_type_t) 7)#define CPU_TYPE_I386 CPU_TYPE_X86 #define CPU_TYPE_X86_64 (CPU_TYPE_X86 | CPU_ARCH_ABI64)#define CPU_TYPE_MC98000 ((cpu_type_t) 10)#define CPU_TYPE_HPPA ((cpu_type_t) 11)#define CPU_TYPE_ARM ((cpu_type_t) 12)#define CPU_TYPE_ARM64 (CPU_TYPE_ARM | CPU_ARCH_ABI64)#define CPU_TYPE_MC88000 ((cpu_type_t) 13)#define CPU_TYPE_SPARC ((cpu_type_t) 14)#define CPU_TYPE_I860 ((cpu_type_t) 15)#define CPU_TYPE_POWERPC ((cpu_type_t) 18)#define CPU_TYPE_POWERPC64 (CPU_TYPE_POWERPC | CPU_ARCH_ABI64 macOSå¹³å°ä¸Šçš„CPUç±»å‹ä¸€èˆ¬ä¸ºCPU_TYPE_X86_64ã€‚ cpusubtypeæŒ‡å®šäº†cpuçš„å­ç±»å‹ã€‚å®ƒçš„ç±»å‹æ˜¯cpu_subtype_tã€‚cpuå­ç±»å‹ä¸»è¦æœ‰å¦‚ä¸‹å‡ ç§ï¼š 1234567#define CPU_SUBTYPE_MASK 0xff000000#define CPU_SUBTYPE_LIB64 0x80000000#define CPU_SUBTYPE_X86_ALL ((cpu_subtype_t)3)#define CPU_SUBTYPE_X86_64_ALL ((cpu_subtype_t)3)#define CPU_SUBTYPE_X86_ARCH1 ((cpu_subtype_t)4)#define CPU_SUBTYPE_X86_64_H ((cpu_subtype_t)8)...... cpuå­ç±»å‹ä¸€èˆ¬CPU_SUBTYPE_LIB64ä¸CPU_SUBTYPE_X86_64_ALLæ¯”è¾ƒå¸¸è§ã€‚ offsetå­—æ®µæŒ‡æ˜äº†å½“å‰cpuæ¶æ„æ•°æ®ç›¸å¯¹äºå½“å‰æ–‡ä»¶å¼€å¤´çš„åç§»å€¼ã€‚ sizeå­—æ®µæŒ‡æ˜äº†æ•°æ®çš„å¤§å°ã€‚ alignå­—æ®µæŒ‡æ˜äº†æ•°æ®çš„å†…å­˜å¯¹é½è¾¹ç•Œï¼Œå–å€¼å¿…é¡»æ˜¯2çš„æ¬¡æ–¹ï¼Œå®ƒç¡®ä¿äº†å½“å‰cpuæ¶æ„çš„ç›®æ ‡æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­æ—¶ï¼Œæ•°æ®æ˜¯ç»è¿‡å†…å­˜ä¼˜åŒ–å¯¹é½çš„ã€‚ å¯ä»¥ä½¿ç”¨otoolå·¥å…·æ‰“å°æœ¬æœºå®‰è£…çš„pythonç¨‹åºçš„fat_headerä¿¡æ¯ã€‚å¦‚ä¸‹ï¼š 123456789101112131415161718$ otool -f -V /usr/bin/pythonFat headersfat_magic FAT_MAGICnfat_arch 2architecture i386 cputype CPU_TYPE_I386 cpusubtype CPU_SUBTYPE_I386_ALL capabilities 0x0 offset 4096 size 29632 align 2^12 (4096)architecture x86_64 cputype CPU_TYPE_X86_64 cpusubtype CPU_SUBTYPE_X86_64_ALL capabilities CPU_SUBTYPE_LIB64 offset 36864 size 29872 align 2^12 (4096) åœ¨fat_archç»“æ„ä½“å¾€ä¸‹å°±æ˜¯å…·ä½“çš„Mach-Oæ–‡ä»¶æ ¼å¼äº†ã€‚ äºŒã€Mach-Oæ–‡ä»¶2.1 ç®€ä»‹Mach-Oæ˜¯Mach Objectæ–‡ä»¶æ ¼å¼çš„ç¼©å†™ï¼Œæ˜¯macä»¥åŠiOSä¸Šå¯æ‰§è¡Œæ–‡ä»¶çš„æ ¼å¼ã€‚ 2.2 åˆ†ç±»Mach-O æœ‰ä¸‰ç§æ–‡ä»¶ç±»å‹: Executableã€Dylibã€Bundleã€‚ Executable ç±»å‹ executable æ˜¯ app çš„äºŒè¿›åˆ¶ä¸»æ–‡ä»¶ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ app extension çš„äºŒè¿›åˆ¶ä¸»æ–‡ä»¶ æˆ‘ä»¬ä¸€èˆ¬å¯ä»¥åœ¨ Xcode é¡¹ç›®ä¸­çš„ Products æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°å®ƒï¼š Dylib ç±»å‹ dylib æ˜¯åŠ¨æ€åº“ï¼Œåœ¨å…¶ä»–å¹³å°ä¹Ÿå« DSO æˆ–è€… DLLã€‚ Bundle ç±»å‹ ç°é˜¶æ®µ Bundle æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„ dylibï¼Œä½ æ˜¯æ— æ³•å¯¹å…¶è¿›è¡Œé“¾æ¥çš„ã€‚ä½ æ‰€èƒ½åšçš„æ˜¯åœ¨ Runtime è¿è¡Œæ—¶å»é€šè¿‡ dlopen æ¥åŠ è½½å®ƒï¼Œå®ƒå¯ä»¥åœ¨ macOS ä¸Šç”¨äºæ’ä»¶ã€‚ Image å’Œ Framework é•œåƒæ–‡ä»¶åŒ…å«äº†ä¸Šè¿°çš„ä¸‰ç§æ–‡ä»¶ç±»å‹ã€‚æœ‰å¾ˆå¤šä¸œè¥¿éƒ½å«åš Frameworkï¼Œä½†åœ¨æœ¬æ–‡ä¸­ï¼ŒFramework æŒ‡çš„æ˜¯ä¸€ä¸ª dylibï¼Œå®ƒå‘¨å›´æœ‰ä¸€ä¸ªç‰¹æ®Šçš„ç›®å½•ç»“æ„æ¥ä¿å­˜è¯¥ dylib æ‰€éœ€çš„æ–‡ä»¶ã€‚ 2.3 ç»“æ„ é€šè¿‡ä¸Šå›¾ï¼Œå¯ä»¥çœ‹å‡ºMach-Oä¸»è¦ç”±ä»¥ä¸‹ä¸‰éƒ¨åˆ†ç»„æˆï¼š Header æè¿°äº†Mach-Oçš„cpuæ¶æ„ã€æ–‡ä»¶ç±»å‹ä»¥åŠåŠ è½½å‘½ä»¤ç­‰ä¿¡æ¯ Load commands åŒ…å«åŒºåŸŸä½ç½®ã€ç¬¦å·è¡¨ã€åŠ¨æ€ç¬¦å·è¡¨ï¼ŒåŠ è½½Mach-Oæ–‡ä»¶æ—¶ä½¿ç”¨è¿™é‡Œçš„æ•°æ®ç¡®å®šå†…å­˜åˆ†å¸ƒ Data æ•°æ®æ®µsegementï¼ŒåŒ…å«å…·ä½“ä»£ç ã€å¸¸é‡ã€ç±»ã€æ–¹æ³•ç­‰ï¼Œæœ‰å¤šä¸ªsegmentï¼Œæ¯ä¸ªsegmentæœ‰0åˆ°å¤šä¸ªsectionï¼Œæ¯ä¸ªæ®µæœ‰ä¸€ä¸ªè™šæ‹Ÿåœ°å€æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ 2.3.1 Header** MachOView**æºç ä¸­æœç´¢loader.hå¹¶æŸ¥çœ‹ï¼š 12345678910111213141516171819struct mach_header { uint32_t magic; /* mach magic number identifier */ cpu_type_t cputype; /* cpu specifier */ cpu_subtype_t cpusubtype; /* machine specifier */ uint32_t filetype; /* type of file */ uint32_t ncmds; /* number of load commands */ uint32_t sizeofcmds; /* the size of all the load commands */ uint32_t flags; /* flags */};struct mach_header_64 { uint32_t magic; /* mach magic number identifier */ cpu_type_t cputype; /* cpu specifier */ cpu_subtype_t cpusubtype; /* machine specifier */ uint32_t filetype; /* type of file */ uint32_t ncmds; /* number of load commands */ uint32_t sizeofcmds; /* the size of all the load commands */ uint32_t flags; /* flags */ uint32_t reserved; /* reserved */}; magicï¼šé­”æ•°ï¼Œç¡®å®šæ˜¯64ä½è¿˜æ˜¯32ä½ cputypeï¼šcpuç±»å‹ cpusubtypeï¼šcpuå­ç±»å‹ filetypeï¼šMach-Oæ”¯æŒå¤šç§æ–‡ä»¶ç±»å‹ï¼Œä½¿ç”¨filetypeæ¥æ ‡æ³¨å…·ä½“æ–‡ä»¶ç±»å‹ ncmdsï¼šåŠ è½½å‘½ä»¤çš„æ•°é‡ sizeofcmdsï¼šå‘½ä»¤åŒºåŸŸï¼ˆload commandsï¼‰æ€»çš„å­—èŠ‚å¤§å° flagsï¼šæ ‡è¯†äºŒè¿›åˆ¶æ–‡ä»¶æ‰€æ”¯æŒçš„åŠŸèƒ½ï¼Œä¸»è¦ä¸ç³»ç»Ÿçš„åŠ è½½ã€é“¾æ¥æœ‰å…³ 2.3.2 Load commandsHeaderä¹‹åæ˜¯load commandsåŠ è½½å‘½ä»¤æ®µï¼Œç”¨äºè§£æåŠ è½½å‘½ä»¤ã€‚ 1234struct load_command { uint32_t cmd; /* type of load command */ uint32_t cmdsize; /* total size of command in bytes */}; cmdï¼šå‘½ä»¤ç±»å‹ï¼Œé’ˆå¯¹ä¸åŒæ¶æ„æœ‰ä¸åŒçš„ç»“æ„ï¼ˆ32ä½ã€64ä½ï¼‰ cmdsizeï¼šå‘½ä»¤æ‰€å å­—èŠ‚å¤§å°ï¼ˆ32ä½sizeå¿…é¡»ä¸º4å­—èŠ‚çš„å€æ•°ï¼Œ64ä½sizeå¿…é¡»ä¸º8å­—èŠ‚çš„å€æ•°ï¼‰ã€‚ åœ¨æ–‡ä»¶ä¸­æœ‰ä¸¤ä¸ªç»“æ„ä½“segment_commandå’Œsegment_command_64é’ˆå¯¹ä¸åŒæ¶æ„çš„ç»“æ„ä½“ï¼Œå†…éƒ¨è®¾ç½®å­—æ®µç›¸åŒã€‚ä»¥segment_command_64ä¸ºä¾‹ï¼š 12345678910111213struct segment_command_64 { /* for 64-bit architectures */ uint32_t cmd; /* LC_SEGMENT_64 */ uint32_t cmdsize; /* includes sizeof section_64 structs */ char segname[16]; /* segment name */ uint64_t vmaddr; /* memory address of this segment */ uint64_t vmsize; /* memory size of this segment */ uint64_t fileoff; /* file offset of this segment */ uint64_t filesize; /* amount to map from the file */ vm_prot_t maxprot; /* maximum VM protection */ vm_prot_t initprot; /* initial VM protection */ uint32_t nsects; /* number of sections in segment */ uint32_t flags; /* flags */}; cmdï¼šåŠ è½½å‘½ä»¤ç±»å‹ LC_SEGMENTï¼šè¡¨ç¤ºè¿™å¥½ä¼¼ä¸€ä¸ªæ®µåŠ è½½å‘½ä»¤ï¼Œéœ€è¦å°†å®ƒåŠ è½½åˆ°å¯¹åº”çš„è¿›ç¨‹ç©ºé—´ä¸Š LC_LOAD_DYLIBï¼šè¿™æ˜¯ä¸€ä¸ªéœ€è¦åŠ¨æ€åŠ è½½çš„é“¾æ¥åº“ï¼Œå®ƒä½¿ç”¨dylib_commandç»“æ„ä½“è¡¨ç¤º LC_MAINï¼šè®°å½•äº†å¯æ‰§è¡Œæ–‡ä»¶çš„ä¸»å‡½æ•°main()çš„ä½ç½®ï¼Œå®ƒä½¿ç”¨entry_point_commandç»“æ„ä½“è¡¨ç¤º LC_CODE_SIGNATUREï¼šä»£ç ç­¾åçš„åŠ è½½å‘½ä»¤ï¼Œæè¿°äº†Mach-Oçš„ä»£ç ç­¾åä¿¡æ¯ï¼Œå®ƒå±äºé“¾æ¥ä¿¡æ¯ï¼Œä½¿ç”¨linkedit_data_commandç»“æ„ä½“è¡¨ç¤º cmdsizeï¼šåŠ è½½å‘½ä»¤æ‰€å å†…å­˜å¤§å° segnameï¼šå­˜æ”¾16å­—èŠ‚å¤§å°çš„æ®µåå­—ï¼Œå½“å‰æ˜¯__PAGEZEROã€‚ vmaddrï¼šæ®µçš„è™šæ‹Ÿå†…å­˜èµ·å§‹åœ°å€ vmsizeï¼šæ®µçš„è™šæ‹Ÿå†…å­˜å¤§å° fileoffï¼šæ®µåœ¨æ–‡ä»¶ä¸­åç§»é‡ filesizeï¼šæ®µåœ¨æ–‡ä»¶å¤§å° maxprotï¼šæ®µé¡µé¢æ‰€éœ€è¦çš„æœ€é«˜å†…å­˜ä¿æŠ¤ï¼ˆ4=r,2=w,1=xï¼‰ initprotï¼šæ®µé¡µé¢åˆå§‹çš„å†…å­˜ä¿æŠ¤ nsectsï¼šæ®µä¸­åŒ…å«sectionçš„æ•°é‡ flagsï¼šå…¶ä»–æ‚é¡¹æ ‡å¿—ä½ çœ‹MachOViewä¸­çš„loadcommandsï¼š ä»¥ä¸Šä¸ºæ˜¯åº”ç”¨ç¨‹åºæ‰€æœ‰åŠ è½½å‘½ä»¤ï¼Œé€šè¿‡ä¸Šé¢æµç¨‹èƒ½å¤Ÿçœ‹åˆ°å¯¹ç³»ç»Ÿåº“çš„åŠ è½½é¡ºåºã€‚å¯¹æ¯”é¡¹ç›®ä¸­å¼•å…¥çš„åº“æ–‡ä»¶ï¼Œé¡ºåºæ˜¯ä¸€è‡´çš„ï¼Œå¦‚ä¸‹å›¾ï¼š ä»¥ä¸ŠåŠ è½½å‘½ä»¤å«ä¹‰å¦‚ä¸‹ï¼š LC_SEGMENT_64ï¼šå°†æ–‡ä»¶ä¸­çš„æ®µæ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ä¸­ LC_DYLD_INFO_ONLYï¼šåŠ¨æ€é“¾æ¥ç›¸å…³ä¿¡æ¯ LC_SYMTABï¼šç¬¦å·è¡¨ä¿¡æ¯ï¼Œä½ç½®ã€åç§»ã€æ•°æ®ä¸ªæ•°ï¼Œä¾›dyldä½¿ç”¨ LC_DYSYMTABï¼šåŠ¨æ€ç¬¦å·è¡¨ä¿¡æ¯ï¼Œä¾›dyldä½¿ç”¨ LC_LOAD_DYLINKERï¼šé“¾æ¥å™¨ä¿¡æ¯ï¼Œè®°å½•ä½¿ç”¨é‚£äº›é“¾æ¥å™¨å®Œæˆå†…æ ¸ååºçš„åŠ è½½å·¥ä½œ LC_UUIDï¼šMach-Oæ–‡ä»¶çš„å”¯ä¸€æ ‡è¯† LC_VERSION_MIN_MACOSXï¼šæ”¯æŒæœ€ä½æ“ä½œç³»ç»Ÿç‰ˆæœ¬ LC_SOURCE_VERSIONï¼šæºä»£ç çš„ç‰ˆæœ¬å· LC_MAINï¼šè®¾ç½®ä¸»çº¿ç¨‹çš„å…¥å£å³æ ˆå¤§å° LC_LOAD_DYLIBï¼šä¾èµ–åº“ä¿¡æ¯ï¼Œdyldé€šè¿‡è¯¥å‘½ä»¤å»åŠ è½½ä¾èµ–åº“ LC_FUNCTION_STARTSï¼šå‡½æ•°çš„èµ·å§‹åœ°å€è¡¨ LC_CODE_SIGNATUREï¼šä»£ç ç­¾å 2.3.3 DataDataåŒºåŸŸç”±Segmentæ®µå’ŒSectionèŠ‚ç»„æˆï¼š segmentä¸»è¦æœ‰__TEXTå’Œ__DATAç»„æˆ __textï¼šæ˜¯ä¸»ç¨‹åºä»£ç  __stubsã€__stub_helperï¼šæ˜¯åŠ¨æ€é“¾æ¥çš„æ¡© __cstringï¼šç¨‹åºä¸­cè¯­è¨€å­—ç¬¦ä¸² __constï¼šå¸¸é‡ Sectionå«ä¹‰ï¼š Section64(__TEXT,__objc_methname)ï¼šOCç±»å Section64(__DATA,__objc_classlist)ï¼šOCç±»åˆ—è¡¨ Section64(__DATA,__objc_protollist)ï¼šOCåŸå‹åˆ—è¡¨ Section64(__DATA,__objc_imageinfo)ï¼šOCé•œåƒä¿¡æ¯ Section64(__DATA,__objc_selfrefs)ï¼šOCç±»è‡ªå¼•ç”¨ Section64(__DATA,__objc_superrefs)ï¼šOCç±»è¶…ç±»çš„å¼•ç”¨ Section64(__DATA,__ivar)ï¼šOCç±»æˆå‘˜å˜é‡ ç­‰ç­‰ï¼Œéƒ½æ˜¯é€šè¿‡sectionæ¥å¯¹OCä¸­çš„å…·ä½“ç±»åˆ«åšåŠ è½½çš„ã€‚ segmentæ®µåˆ†32ä½å’Œ64ä½ï¼Œå­—æ®µç›¸åŒï¼Œä»¥64ä¸ºä¾‹å¦‚ä¸‹ï¼š 1234567891011121314struct section_64 { /* for 64-bit architectures */ char sectname[16]; /* name of this section */ char segname[16]; /* segment this section goes in */ uint64_t addr; /* memory address of this section */ uint64_t size; /* size in bytes of this section */ uint32_t offset; /* file offset of this section */ uint32_t align; /* section alignment (power of 2) */ uint32_t reloff; /* file offset of relocation entries */ uint32_t nreloc; /* number of relocation entries */ uint32_t flags; /* flags (section type and attributes)*/ uint32_t reserved1; /* reserved (for offset or index) */ uint32_t reserved2; /* reserved (for count or sizeof) */ uint32_t reserved3; /* reserved */}; sectnameï¼šæ˜¯__text ,å°±æ˜¯ä¸»ç¨‹åºä»£ç  segnameï¼šè¯¥sectionæ‰€å±çš„segmentåï¼Œç¬¬ä¸€ä¸ªæ˜¯__TEXT addrï¼šå½“å‰sectionåœ¨å†…å­˜ä¸­çš„èµ·å§‹ä½ç½® sizeï¼šå½“å‰sectionæ‰€å å†…å­˜å¤§å° offsetï¼šå½“å‰sectionçš„æ–‡ä»¶åç§» alignï¼šå­—èŠ‚å¤§å°å¯¹é½ reloffï¼šé‡å®šä½å…¥å£çš„æ–‡ä»¶åç§»ï¼Œ0 nrelocï¼šéœ€è¦é‡å®šä½çš„å…¥å£æ•°é‡ï¼Œ0 flagsï¼šåŒ…å«sectionçš„typeå’Œattributes reserved1ã€reserved2é¢„ç•™å­—æ®µ å‚è€ƒMach-O Mach-Oå¯æ‰§è¡Œæ–‡ä»¶ iOS åº•å±‚æ¢ç´¢ - åº”ç”¨åŠ è½½","link":"/2021/01/15/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/07%E4%B8%8A-%E9%80%9A%E7%94%A8%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E5%92%8CMach-O%E6%96%87%E4%BB%B6/"},{"title":"10-åº•å±‚é¢è¯•ç­”ç–‘","text":"ä¸€ã€ä»€ä¹ˆæ˜¯ Runtimeç­”ï¼šç”¨ Cã€C++ã€æ±‡ç¼–å®ç°çš„ä¸€å¥— APIï¼Œä¸º OC è¯­è¨€åŠ å…¥äº†é¢å‘å¯¹è±¡å’Œè¿è¡Œæ—¶çš„åŠŸèƒ½ã€‚ åº”ç”¨ä¸¾ä¾‹ï¼š ç±»çš„ ro å’Œ rw å±æ€§ï¼Œro(read-only)åœ¨ç¼–è¯‘æœŸå°±ç¡®å®šå¥½äº†ï¼Œè€Œ rw(read-write)æ˜¯åœ¨è¿è¡Œæ—¶æ‰å®Œå…¨èµ‹å€¼ã€‚ äºŒã€æ–¹æ³•çš„æœ¬è´¨æ˜¯ä»€ä¹ˆç­”ï¼šæ–¹æ³•çš„æœ¬è´¨å°±æ˜¯æ¶ˆæ¯çš„å‘é€ï¼Œå°±æ˜¯åœ¨åº•å±‚è°ƒç”¨_objc_msgSenndæ–¹æ³•å¯»æ‰¾æ–¹æ³•IMPçš„è¿‡ç¨‹ï¼Œä¸»è¦ç»å†äº†ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š å¿«é€ŸæŸ¥æ‰¾æµç¨‹ï¼šé€šè¿‡æ±‡ç¼–ï¼ˆobjc_msgSendï¼‰æŸ¥æ‰¾cache_tä¸­ç¼“å­˜çš„æ¶ˆæ¯ï¼Œæ‰¾åˆ°å°±è¿”å›impï¼Œæ‰¾ä¸åˆ°å°±è¿›è¡Œæ…¢é€ŸæŸ¥æ‰¾ã€‚ æ…¢é€ŸæŸ¥æ‰¾æµç¨‹ï¼šé€šè¿‡å‡½æ•°lookUpImpOrForwardé€’å½’æŸ¥æ‰¾å½“å‰ç±»å’Œçˆ¶ç±»çš„ç¼“å­˜å’Œæ–¹æ³•åˆ—è¡¨ï¼Œå¦‚æœæ‰¾åˆ°äº†å°±ä¼šç¼“å­˜æ–¹æ³•æ–¹ä¾¿å¿«é€ŸæŸ¥æ‰¾ï¼Œæ‰¾ä¸åˆ°å°±ä¼šè¿›è¡ŒåŠ¨æ€æ–¹æ³•è§£æ åŠ¨æ€æ–¹æ³•è§£æï¼šæ­¤æ—¶OCä¼šç»™æˆ‘ä»¬ä¸€æ¬¡å¯¹selçš„å¤„ç†æœºä¼šï¼Œä½ å¯ä»¥åœ¨resolveInstanceMethod:ï¼ˆç±»æ–¹æ³•å¯¹åº”resolveClassMethod:ï¼‰ä¸­æ·»åŠ ä¸€ä¸ªIMP å¦‚æœä½ æ²¡æŠŠæ¡ä½è¿™æ¬¡æœºä¼šï¼Œä¹Ÿå°±æ˜¯è§£æå¤±è´¥æ—¶ï¼Œä¼šæ¥åˆ°æ¶ˆæ¯è½¬å‘é˜¶æ®µï¼Œè¿™ä¸ªé˜¶æ®µæœ‰ä¸¤ä¸ªæœºä¼šå»å¤„ç†selï¼Œåˆ†åˆ«æ˜¯å¿«é€Ÿè½¬å‘çš„forwardingTargetForSelector:ï¼Œä»¥åŠæ…¢é€Ÿè½¬å‘çš„methodSignatureForSelector:ã€‚ æ¶ˆæ¯å¿«é€Ÿè½¬å‘ï¼šforwardingTargedForSelectorï¼Œå¦‚æœæœ‰å¤„ç†ï¼Œå°±äº¤ç»™å¤„ç†çš„å¯¹è±¡æ¥å®ç°ï¼Œæ²¡æœ‰å°±äº¤ç»™å…¶ä»–å¯¹è±¡å¤„ç†ï¼Œè¿›å…¥æ…¢é€Ÿè½¬å‘é˜¶æ®µã€‚ æ¶ˆæ¯æ…¢é€Ÿè½¬å‘ï¼šmethodSignatureForSelectorï¼Œè¿›è¡Œæ–¹æ³•ç­¾åï¼ŒæŠŠæ–¹æ³•ä¸¢å‡ºå»ï¼ŒforwardInvocationæ¥å¯¹æ¶ˆæ¯å¤„ç†ã€‚ æœªæ‰¾åˆ°æ¶ˆæ¯ï¼šæ— æ³•æ‰¾åˆ°IMPï¼Œå°±è¿›å…¥åˆ°äº†doesNotRecognizeSelectoræŠ¥é”™ï¼Œæ‰“å°log ä¸‰ã€sel æ˜¯ä»€ä¹ˆï¼ŸIMP æ˜¯ä»€ä¹ˆï¼Ÿä¸¤è€…ä¹‹é—´çš„å…³ç³»ï¼Ÿç­”ï¼š SELæ˜¯æ–¹æ³•ç¼–å·ï¼Œä¹Ÿæ˜¯æ–¹æ³•åï¼Œåœ¨dyldåŠ è½½é•œåƒå¸¦å†…å­˜æ—¶ï¼Œé€šè¿‡_read_imageæ–¹æ³•åŠ è½½åˆ°å†…å­˜çš„è¡¨ä¸­äº† IMP å°±æ˜¯æˆ‘ä»¬å‡½æ•°å®ç°æŒ‡é’ˆ ï¼Œæ‰¾IMPå°±æ˜¯æ‰¾å‡½æ•°çš„è¿‡ç¨‹ å‡½æ•°å°±æ˜¯å¯¹åº”çš„å®ç°å†…å®¹ å››ã€èƒ½å¦å‘è¿â¾æ—¶åˆ›å»ºçš„ç±»ä¸­æ·»åŠ æˆå‘˜å˜é‡ï¼Ÿç­”ï¼šä¸èƒ½ã€‚ åŸå› ï¼š 1234567891011121314151617181920struct class_ro_t { uint32_t flags; uint32_t instanceStart; uint32_t instanceSize;#ifdef __LP64__ uint32_t reserved;#endif const uint8_t * ivarLayout; const char * name; method_list_t * baseMethodList; // æ–¹æ³•åˆ—è¡¨ protocol_list_t * baseProtocols; // åè®®åˆ—è¡¨ const ivar_list_t * ivars; // æˆå‘˜å˜é‡åˆ—è¡¨ const uint8_t * weakIvarLayout; property_list_t *baseProperties; // å±æ€§åˆ—è¡¨ ...} 12345678910111213struct class_rw_t { // Be warned that Symbolication knows the layout of this structure. uint32_t flags; uint32_t version; const class_ro_t *ro; method_array_t methods; // æ–¹æ³•åˆ—è¡¨ property_array_t properties; // å±æ€§åˆ—è¡¨ protocol_array_t protocols; // åè®®åˆ—è¡¨ ...} å› ä¸ºæˆ‘ä»¬ç¼–è¯‘å¥½çš„æˆå‘˜å˜é‡å­˜å‚¨çš„ä½ç½®åœ¨ç±»çš„roä¸­ï¼Œâ¼€æ—¦ç¼–è¯‘å®Œæˆï¼Œå†…å­˜ç»“æ„å°±å®Œå…¨ç¡®å®šâ½†æ³•ä¿®æ”¹ï¼Œåªèƒ½ä¿®æ”¹ç±»çš„rwä¸­çš„æ–¹æ³•æˆ–è€…å¯ä»¥é€šè¿‡å…³è”å¯¹è±¡çš„æ–¹å¼æ¥æ·»åŠ å±æ€§ã€‚ å…³è”å¯¹è±¡æ·»åŠ çš„ä¸»è¦æ­¥éª¤å¦‚ä¸‹ï¼š objc_setAssociatedObjectè®¾ç½®setæ–¹æ³•ï¼šæ‰¾åˆ°å…³è”å¯¹è±¡çš„æ€»å“ˆå¸Œè¡¨ï¼Œç„¶åé€šè¿‡æŒ‡é’ˆåœ°å€æ‰¾åˆ°è¯¥ç±»çš„å“ˆå¸Œè¡¨ï¼Œç„¶åé€šè¿‡keyå€¼è¿›è¡Œå­˜å‚¨ objc_getAssociatedObjectè®¾ç½®getæ–¹æ³•ï¼šå’Œsetæ–¹æ³•ä¸€æ ·æŸ¥è¯¢è¡¨ï¼Œæ‰¾åˆ°å€¼ åœ¨ç±»çš„deallocä¼šæ¸…é™¤å…³è”å¯¹è±¡çš„å“ˆå¸Œè¡¨ äº”ã€isKindOfClass å’Œ isMemberOfClassçš„åŒºåˆ«ç­”ï¼šå½“è°ƒç”¨è€…å¯¹è±¡æ˜¯å®ä¾‹å¯¹è±¡æ—¶ï¼šã€å¸¸ç”¨ã€‘ -isKindOfClassï¼šåˆ¤æ–­è°ƒç”¨è€…å¯¹è±¡æ˜¯å¦æ˜¯xxç±»ä»¥åŠä»–çš„å­ç±»çš„å®ä¾‹-isMemberOfClassï¼šåˆ¤æ–­è°ƒç”¨è€…å¯¹è±¡æ˜¯å¦æ˜¯xxç±»çš„å®ä¾‹ å½“è°ƒç”¨è€…å¯¹è±¡æ˜¯ç±»å¯¹è±¡æ—¶ï¼šã€å¯å¿½ç•¥ã€‘ +isKindOfClassï¼šåˆ¤æ–­å½“å‰ç±»å¯¹è±¡çš„å…ƒç±»å¯¹è±¡åŠå…¶çˆ¶ç±»çš„å…ƒç±»å¯¹è±¡æ˜¯å¦ç­‰äºä¼ å…¥çš„å¯¹è±¡ +isMemberOfClassï¼šåˆ¤æ–­å½“å‰ç±»å¯¹è±¡çš„å…ƒç±»å¯¹è±¡æ˜¯å¦ç­‰äºä¼ å…¥çš„è¿™ä¸ªå¯¹è±¡ åŸç†æ¢ç©¶ï¼šä¸¾ä¾‹ï¼š 1.æ¶ˆæ¯æ¥æ”¶è€…æ˜¯å®åŠ›å¯¹è±¡-&gt;è°ƒç”¨å¯¹è±¡æ–¹æ³• 12345BOOL re5 = [(id)[NSObject alloc] isKindOfClass:[NSObject class]]; // 1BOOL re6 = [(id)[NSObject alloc] isMemberOfClass:[NSObject class]]; // 1BOOL re7 = [(id)[LGPerson alloc] isKindOfClass:[LGPerson class]]; // 1BOOL re8 = [(id)[LGPerson alloc] isMemberOfClass:[LGPerson class]]; // 1NSLog(@&quot; re5 :%hhd\\n re6 :%hhd\\n re7 :%hhd\\n re8 :%hhd\\n&quot;,re5,re6,re7,re8); ä¸Šè¿°Logçš„æ‰“å°ç»“æœä¸º1ï¼Œ0ï¼Œ0ï¼Œ0 2.æ¶ˆæ¯æ¥æ”¶è€…æ˜¯ç±»å¯¹è±¡-&gt;è°ƒç”¨ç±»æ–¹æ³• 12345BOOL re1 = [(id)[NSObject class] isKindOfClass:[NSObject class]]; // 1BOOL re2 = [(id)[NSObject class] isMemberOfClass:[NSObject class]]; // 0BOOL re3 = [(id)[LGPerson class] isKindOfClass:[LGPerson class]]; // 0BOOL re4 = [(id)[LGPerson class] isMemberOfClass:[LGPerson class]]; // 0NSLog(@&quot; re1 :%hhd\\n re2 :%hhd\\n re3 :%hhd\\n re4 :%hhd\\n&quot;,re1,re2,re3,re4); ä¸Šè¿°Logçš„æ‰“å°ç»“æœä¸º1ï¼Œ1ï¼Œ1ï¼Œ1 å¯¹äºç¬¬1ä¸ªä¾‹å­ï¼Œå¤§å®¶éƒ½ä½¿ç”¨çš„éå¸¸ç†Ÿç»ƒï¼Œä½†æ˜¯å¯¹äºç¬¬2ä¸ªä¾‹å­çš„æ‰“å°ç»“æœå°±æœ‰äº›çº³é—·äº†ã€‚æˆ‘ä»¬å‘ç°ä¸¤ä¸ªä¾‹å­çš„ä¸»è¦åŒºåˆ«åœ¨äºæ¶ˆæ¯æ¥å—è€…æ˜¯å®ä¾‹å¯¹è±¡è¿˜æ˜¯ç±»å¯¹è±¡ã€‚ å…¶å®è¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯æœ‰å¯¹åº”çš„ç±»æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•çš„ï¼Œåªä¸è¿‡æˆ‘ä»¬å¹³æ—¶ä¸ä½¿ç”¨ç±»æ–¹æ³•è€Œå·²ï¼ŒæŸ¥çœ‹æºç ï¼š 123456789101112/************************************************************************ object_getClass.* Locking: None. If you add locking, tell gdb (rdar://7516456).**********************************************************************/// object_getClass()æ–¹æ³•å–å¾—çš„æ˜¯å¯¹è±¡çš„isaæŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡// å¯¹äºå¯¹è±¡æ¥è¯´å°±æ˜¯è·å–åˆ°ä»–çš„ç±»// å¯¹äºç±»å¯¹è±¡æ¥è¯´å°±æ˜¯è·å–åˆ°ä»–çš„å…ƒç±»Class object_getClass(id obj){ if (obj) return obj-&gt;getIsa(); else return Nil;} 12345678910111213141516171819202122232425// åˆ¤æ–­å½“å‰ç±»å¯¹è±¡çš„å…ƒç±»å¯¹è±¡æ˜¯å¦ä¸ä¼ å…¥çš„è¿™ä¸ªå¯¹è±¡ç›¸ç­‰ï¼Œæ‰€ä»¥è¿™ä¸ªclsåº”è¯¥æ˜¯å…ƒç±»å¯¹è±¡æ‰æœ‰å¯èƒ½ä¸º true+ (BOOL)isMemberOfClass:(Class)cls {return object_getClass((id)self) == cls;}// åˆ¤æ–­å½“å‰å®ä¾‹å¯¹è±¡çš„ç±»å¯¹è±¡æ˜¯å¦ä¸ä¼ å…¥çš„å¯¹è±¡ç›¸ç­‰ï¼Œæ‰€ä»¥clsåªæœ‰å¯èƒ½æ˜¯ç±»å¯¹è±¡æ‰æœ‰å¯èƒ½ç›¸ç­‰- (BOOL)isMemberOfClass:(Class)cls {return [self class] == cls;}// å¾ªç¯åˆ¤æ–­å½“å‰ç±»å¯¹è±¡çš„å…ƒç±»å¯¹è±¡åŠå…¶çˆ¶ç±»çš„å…ƒç±»å¯¹è±¡æ˜¯å¦ç­‰äºä¼ å…¥çš„cls+ (BOOL)isKindOfClass:(Class)cls { for (Class tcls = object_getClass((id)self); tcls; tcls = tcls-&gt;superclass) { if (tcls == cls) return YES; } return NO;}// å¾ªç¯åˆ¤æ–­å½“å‰å®ä¾‹å¯¹è±¡çš„çˆ¶ç±»çš„ç±»å¯¹è±¡æ˜¯å¦ç­‰äºä¼ å…¥çš„å¯¹è±¡clsï¼Œä¹Ÿå°±æ˜¯åˆ¤æ–­å®ä¾‹å¯¹è±¡æ˜¯å¦æ˜¯clsåŠå…¶å­ç±»çš„ä¸€ç§- (BOOL)isKindOfClass:(Class)cls { for (Class tcls = [self class]; tcls; tcls = tcls-&gt;superclass) { if (tcls == cls) return YES; } return NO;} æ‰€ä»¥ï¼Œå¦‚æœæ–¹æ³•è°ƒç”¨è€…æ˜¯å®ä¾‹å¯¹è±¡ï¼Œé‚£ä¹ˆä¼ å…¥çš„å°±åº”è¯¥æ˜¯ç±»å¯¹è±¡ï¼›å¦‚æœæ–¹æ³•è°ƒç”¨è€…æ˜¯ç±»å¯¹è±¡ï¼Œé‚£ä¹ˆä¼ å…¥çš„å°±åº”è¯¥æ˜¯å…ƒç±»å¯¹è±¡ã€‚ å…­ã€[self class]ã€[super class]ã€[self superclass]çš„åŒºåˆ«ä»¥åŠåŸç†åˆ†æç»“è®º class:è·å–å½“å‰æ–¹æ³•è°ƒç”¨è€…çš„ç±» superclass:è·å–å½“å‰æ–¹æ³•è°ƒç”¨è€…çš„çˆ¶ç±» super:æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œç»“æ„ä½“ä¸­æ¶ˆæ¯æ¥æ”¶è€…è¿˜æ˜¯å½“å‰å¯¹è±¡ï¼Œæ‰€ä»¥å°±ä¼šè®©å½“å‰å¯¹è±¡å»è°ƒç”¨çˆ¶ç±»æ–¹æ³•ï¼Œæœ¬è´¨è¿˜æ˜¯å½“å‰å¯¹è±¡åœ¨è°ƒç”¨ ä¾‹åˆ›å»ºä¸€ä¸ªStudentç±»ç»§æ‰¿å­Personç±»ï¼ŒæŸ¥çœ‹æ‰“å°ï¼š 1234NSLog(@&quot;[self class] = %@&quot;, [self class]); // [self class] = StudentNSLog(@&quot;[super class] = %@&quot;, [super class]); // [super class] = StudentNSLog(@&quot;[self superclass] = %@&quot;, [self superclass]); // [self superclass] = PersonNSLog(@&quot;[super superclass] = %@&quot;, [super superclass]);// [super superclass] = Person åŸç†å…ˆä¸Šæºç çœ‹ä¸€ä¸‹ç¬¬ä¸€ä¸ªå’Œç¬¬ä¸‰ä¸ªçš„ç†è§£ 1234567891011121314151617181920212223242526272829303132 // object_getClass()æ–¹æ³•å–å¾—çš„æ˜¯å¯¹è±¡çš„isaæŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡ // å¯¹äºå¯¹è±¡æ¥è¯´å°±æ˜¯è·å–åˆ°ä»–çš„ç±» // å¯¹äºç±»å¯¹è±¡æ¥è¯´å°±æ˜¯è·å–åˆ°ä»–çš„å…ƒç±» Class object_getClass(id obj) { if (obj) return obj-&gt;getIsa(); else return Nil; } + (Class)class { return self; } - (Class)class { return object_getClass(self); } + (Class)superclass { return self-&gt;superclass; } - (Class)superclass { return [self class]-&gt;superclass; }Class class_getSuperclass(Class cls){ if (!cls) return nil; return cls-&gt;superclass;} æˆ‘ä»¬çŸ¥é“ï¼Œè¿™é‡Œæ–¹æ³•ä¸­çš„selféƒ½æ˜¯æŒ‡æ¶ˆæ¯çš„æ¥å—è€…ï¼Œåœ¨è¿™é‡Œå°±è¡¨ç¤ºStudentç±»ï¼Œæ ¹æ®ä»¥ä¸Šæºç ï¼Œç¬¬ä¸€ä¸ªå’Œç¬¬ä¸‰ä¸ªæ²¡å•¥ç–‘é—®ï¼Œéƒ½æ˜¯å¯»æ‰¾Studentçš„isaå’Œçˆ¶ç±»ã€‚ é‚£ä¹ˆsuperè°ƒç”¨æ—¶ï¼Œæœ‰å•¥ä¸åŒï¼Œæˆ‘ä»¬éœ€è¦å…ˆçŸ¥é“superçš„æœ¬è´¨ é€šè¿‡clangç¼–è¯‘ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåº•å±‚è°ƒç”¨æ—¶superè°ƒç”¨çš„æ–¹æ³•ä¸æ˜¯msgSend,è€Œæ˜¯objc_msgSendSuper(object ,superclass, @selector(class))ï¼Œä¼ å…¥äº†ä¸€ä¸ªsuperçš„ç»“æ„ä½“å’Œæ–¹æ³•ã€‚ æˆ‘ä»¬çŸ¥é“æ¶ˆæ¯å‘é€çš„æ—¶å€™ï¼Œæ…¢é€ŸæŸ¥æ‰¾æµç¨‹æ˜¯éœ€è¦ä»è‡ªèº«é€’å½’æŸ¥æ‰¾åˆ°NSObjectçš„ï¼Œè€Œobjc_msgSendSuperå°±è¡¨ç¤ºç›´æ¥ä»æ¶ˆæ¯æ¥å—è€…çš„çˆ¶ç±»å¼€å§‹é€’å½’æŸ¥æ‰¾ï¼Œè·³è¿‡äº†æœ¬èº«çš„æ–¹æ³•åˆ—è¡¨ï¼Œè¿™æ ·æŸ¥æ‰¾çš„é€Ÿåº¦å¯ä»¥æ›´å¿«ã€‚ superçš„ç»“æ„ä½“å¦‚ä¸‹ 1234struct objc_super { __unsafe_unretained _Nonnull id receiver; __unsafe_unretained _Nonnull Class super_class;}; ä¸¤ä¸ªå‚æ•°åˆ†åˆ«ä¸ºæ¶ˆæ¯çš„æ¥å—è€…å’Œçˆ¶ç±»ï¼Œåœ¨è¿™é‡ŒStudentå³ä¸ºæ¶ˆæ¯æ¥å—è€…,Personä¸ºçˆ¶ç±». æ‰€ä»¥è°ƒç”¨[super class]å’Œ[super superclass]æœ¬è´¨ä¸Šæ¶ˆæ¯çš„æ¥å—è€…è¿˜æ˜¯selfï¼Œå³Studentç±»ã€‚æ‰€ä»¥å°±è·Ÿç¬¬ä¸€ä¸ªå’Œç¬¬ä¸‰ä¸ªç»“æœæ²¡æœ‰åŒºåˆ«ã€‚ å°ç»“[self class] å°±æ˜¯å‘é€æ¶ˆæ¯objc_msgSendï¼Œæ¶ˆæ¯æ¥å—è€…æ˜¯ self,â½…æ³•ç¼–å·ï¼šclass [super class] æœ¬è´¨å°±æ˜¯objc_msgSendSuper, æ¶ˆæ¯çš„æ¥å—è€…è¿˜æ˜¯ self â½…æ³•ç¼–å·ï¼šclass(çˆ¶ç±»çš„) åªæ˜¯objc_msgSendSuper ä¼šæ›´å¿« ç›´æ¥è·³è¿‡ self çš„æŸ¥æ‰¾,ä½†æ˜¯éƒ½ä¼šèµ°åˆ°NSObjectåŸºç±»çš„å®ç°æ–¹æ³•ä¸­ï¼Œä½†æ˜¯éƒ½æ˜¯ä»¥selfä¸ºæ¥å—è€… ä¸ƒã€Runtime æ˜¯å¦‚ä½•å®ç° weak çš„ï¼Œä¸ºä»€ä¹ˆå¯ä»¥â¾ƒåŠ¨ç½® nilï¼Ÿä¸»è¦æ€»ç»“å¦‚ä¸‹ï¼š é€šè¿‡SideTableæ‰¾åˆ°æˆ‘ä»¬çš„weak_table weak_table æ ¹æ®referent æ‰¾åˆ°æˆ–è€…åˆ›å»º weak_entry_t ç„¶åappend_referrer(entry, referrer)å°†æ–°å¼±å¼•â½¤çš„å¯¹è±¡åŠ è¿›å»entry æœ€åweak_entry_insert æŠŠentryåŠ â¼Šåˆ°æˆ‘ä»¬çš„weak_table åœ¨ç±»deallocæ—¶ï¼Œä¼šæ ¹æ®æ’å…¥çš„æ­¥éª¤æ‰¾åˆ°å¯¹åº”çš„å¼±å¼•ç”¨ï¼Œå¹¶ç½®ä¸ºnil å…³äºweakçš„ç›¸å…³çŸ¥è¯†åšäº†å•ç‹¬çš„æ€»ç»“ï¼Œè¯¦æƒ…å¯ä»¥çœ‹ä¸‹æ–¹æ–‡ç« ğŸ‘‡ 11-weakåŸç†æ¢ç©¶ å…«ã€Method Swizzling çš„å‘ä¸åº”â½¤è¯¦æƒ…å¯ä»¥çœ‹ä¸‹é¢çš„æ–‡ç« ï¼š 12-Method Swizzlingçš„å‘ä¸åº”ç”¨ å‚è€ƒiOSåº•å±‚å­¦ä¹  - Runtimeä¹‹ç –å‚é¢è¯•ç­”ç–‘","link":"/2021/02/16/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/10-%E5%BA%95%E5%B1%82%E9%9D%A2%E8%AF%95%E7%AD%94%E7%96%91/"},{"title":"ç™¾åº¦ç§»åŠ¨ç»Ÿè®¡é”™è¯¯æŠ¥å‘Šçš„ä½¿ç”¨","text":"linkï¼š https://mtj.baidu.com/web/dashboard ç»ˆç«¯å‘½ä»¤ï¼š 1xcrun atos --arch arm64 -o +åŒ…è·¯å¾„ -l åŸºåœ°å€+å›è½¦+åç§»åœ°å€+å›è½¦ åŒ…è·¯å¾„ åŸºåœ°å€ &amp; åç§»åœ°å€","link":"/2020/10/19/iOS%C2%B7%E8%B4%A8%E9%87%8F&%E6%95%88%E7%8E%87/%E7%99%BE%E5%BA%A6%E7%A7%BB%E5%8A%A8%E7%BB%9F%E8%AE%A1%E9%94%99%E8%AF%AF%E6%8A%A5%E5%91%8A%E7%9A%84%E4%BD%BF%E7%94%A8/"},{"title":"Hexo é…ç½®","text":"ä¸€ã€å‡çº§ä¸»é¢˜1.ä½¿ç”¨ 1sudo npm install -g npm-upgrade å’Œ 123ncu -u // è‡ªåŠ¨æ›´æ–°æ‰€æœ‰æ’ä»¶æˆ–è€… npm-upgrade // æ‰‹åŠ¨é€‰æ‹©æ’ä»¶æ›´æ–° æ¥å‡çº§Hexoä¸­çš„æ’ä»¶ 2.ä¿å­˜ 1npm update -g 1npm update --save 3.å®‰è£…é…ç½®ä¸»é¢˜ 1npm install hexo-theme-icarus 1hexo config theme icarus 4.æ ¹æ®æç¤ºå®‰è£…ç¼ºå°‘æˆ–è€…éœ€è¦æ›´æ–°çš„ä¸œè¥¿ 5.å†æ¬¡é…ç½®ä¸»é¢˜ 1hexo config theme icarus è¿™ä¸ªæ—¶å€™åº”è¯¥æç¤ºé…ç½®æˆåŠŸäº† 6.æœ¬åœ°å¯åŠ¨çœ‹çœ‹ 1hexo s äºŒã€Icarus é…ç½®2.1 åŸºç¡€é…ç½®ä¿®æ”¹é€šè¿‡ä¿®æ”¹ä¸»é¢˜çš„å…¨å±€é…ç½®æ–‡ä»¶_config.icarus.yml 2.2 ä¿®æ”¹åšå®¢ä¸ºï¼šä¸»é¡µä¸‰æ ï¼Œæ–‡ç« é¡µä¸¤æ æ‰¾åˆ°hexo-theme-icarusæ–‡ä»¶å¤¹ï¼Œåœ¨æ­¤ç›®å½•ä¸‹æ·»åŠ _config.post.ymlæ–‡ä»¶å¹¶é…ç½®ï¼š 123456789101112widgets: - # Where should the widget be placed, left sidebar or right sidebar position: left type: toc # Whether to show the index of each heading index: false # Whether to collapse sub-headings when they are out-of-view collapsed: true # Maximum level of headings to show (1-6) depth: 6 2.3 ä¸»é¢˜è¿›è¡Œ cdn åŠ é€Ÿæœç´¢å¹¶æ‰¾åˆ°cdn.jsæ–‡ä»¶ï¼Œå¹¶ä¿®æ”¹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839/** * @private */// åŸæ¥çš„// const PROVIDERS = {// LIBRARY: {// cdnjs: '[cdnjs]https://cdnjs.cloudflare.com/ajax/libs/${ package }/${ version }/${ filename }',// loli: '[cdnjs]https://cdnjs.loli.net/ajax/libs/${ package }/${ version }/${ filename }',// jsdelivr: 'https://cdn.jsdelivr.net/npm/${ package }@${ version }/${ filename }',// unpkg: 'https://unpkg.com/${ package }@${ version }/${ filename }'// },// FONT: {// google: 'https://fonts.googleapis.com/${ type }?family=${ fontname }',// loli: 'https://fonts.loli.net/${ type }?family=${ fontname }'// },// ICON: {// loli: 'https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css',// fontawesome: 'https://use.fontawesome.com/releases/v5.12.0/css/all.css'// }// };// æ”¹ä¸ºï¼šconst PROVIDERS = { LIBRARY: { // cdnjs: '[cdnjs]https://cdnjs.cloudflare.com/ajax/libs/${ package }/${ version }/${ filename }', cdnjs: 'https://cdnjs.loli.net/ajax/libs/${ package }/${ version }/${ filename }', loli: '[cdnjs]https://cdnjs.loli.net/ajax/libs/${ package }/${ version }/${ filename }', jsdelivr: 'https://cdn.jsdelivr.net/npm/${ package }@${ version }/${ filename }', unpkg: 'https://unpkg.com/${ package }@${ version }/${ filename }' }, FONT: { google: 'https://fonts.loli.net/${ type }?family=${ fontname }', loli: 'https://fonts.loli.net/${ type }?family=${ fontname }' }, ICON: { loli: 'https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css', fontawesome: 'https://cdnjs.loli.net/ajax/libs/font-awesome/5.4.1/css/all.min.css' }}; 2.4 ä¿®æ”¹æ–‡ç« é¡µçš„å®½åº¦æ‰¾åˆ°layout.jsxæ–‡ä»¶ is-9-widescreen ä¸­çš„ 9 å°±æ˜¯å®½åº¦æ¯”ä¾‹ï¼Œé»˜è®¤ä¸º 8 12'is-8-tablet is-8-desktop is-9-widescreen': columnCount === 2, 'is-8-tablet is-8-desktop is-6-widescreen': columnCount === 3","link":"/2020/12/16/%E5%8D%9A%E5%AE%A2/Hexo%20%E9%85%8D%E7%BD%AE/"},{"title":"è§£æ ips æ–‡ä»¶","text":"ä¸€ã€å‰è¨€å¦‚æœ iOS è®¾å¤‡ä¸Šçš„æŸæ¬¾ APP å‘ç”Ÿ crashï¼Œé‚£ä¹ˆæ˜¯èƒ½å¤Ÿåœ¨æ‰‹æœºå†…æŸ¥æ‰¾åˆ° crash ä¿¡æ¯çš„ã€‚ æ–¹æ³•å°±æ˜¯è®¾ç½®-&gt;éšç§-&gt;åˆ†æ-&gt;åˆ†ææ•°æ®ï¼›æ–‡ä»¶åæ ¼å¼å°±æ˜¯ APP åŒ…å+æ—¶é—´çš„ ips æ–‡ä»¶ï¼Œä¸€çœ¼å°±èƒ½å®šä½å‡ºå“ªä¸€ä¸ªAPPä»€ä¹ˆæ—¶é—´å‘ç”Ÿçš„ crashï¼Œæ¥ä¸‹æ¥å¯¼å‡ºä½ å…³æ³¨çš„ ips æ–‡ä»¶ã€‚ å› ä¸ºè§£æå‰çš„ ips æ–‡ä»¶æ˜¯åå…­è¿›åˆ¶çš„å †æ ˆä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹è¿™äº›æ•°æ®è¿›è¡Œç¬¦å·åŒ–è½¬æ¢ï¼Œå°†å †æ ˆåœ°å€è½¬åŒ–ä¸ºæˆ‘ä»¬å¯è¯†åˆ«çš„ä¸€äº›ç±»åã€æ–¹æ³•åç­‰ç¬¦å·ä¿¡æ¯ã€‚ äºŒã€è§£æåœ¨æ¡Œé¢æ–°å»ºåä¸º crash çš„æ–‡ä»¶å¤¹ï¼Œè¯¥æ–‡ä»¶å¤¹éœ€è¦å¯¼å…¥å››æ ·ä¸œè¥¿ï¼› ç¬¬ä¸€ä¸ªï¼šä»è®¾å¤‡å¯¼å‡ºçš„ ips æ–‡ä»¶ï¼Œéœ€è¦æ”¹åç¼€åä¸º crash ç¬¬äºŒä¸ªï¼šæ‰¾åˆ° /Applications/Xcode.app/Contents/SharedFrameworks/DVTFoundation.framework/Versions/A/Resources/symbolicatecrash è·¯å¾„ï¼ŒæŠŠ symbolicatecrash æ‹·è´åˆ° crash æ–‡ä»¶å¤¹ä¸­ ç¬¬ä¸‰ä¸ªï¼šæ‰“å¼€ Xcode-&gt;window-&gt;Organizerï¼Œæ‰¾åˆ°å¯¹åº”ç‰ˆæœ¬çš„ archivesï¼Œå³é”® Show in Finderï¼Œé€‰ä¸­xcarchive æ–‡ä»¶å³é”®æ˜¾ç¤ºåŒ…å†…å®¹ï¼Œæ‹·è´å‡º dSYMs æ–‡ä»¶å¤¹ä¸‹çš„ dSYM æ–‡ä»¶ ç¬¬å››ä¸ªï¼šæ‰“å¼€ Xcode-&gt;window-&gt;Organizerï¼Œæ‰¾åˆ°å¯¹åº”ç‰ˆæœ¬çš„ archivesï¼Œå³é”®Show in Finderï¼Œé€‰ä¸­xcarchive æ–‡ä»¶å³é”®æ˜¾ç¤ºåŒ…å†…å®¹ï¼Œæ‹·è´å‡º Products-&gt;Applications æ–‡ä»¶å¤¹ä¸‹çš„APPæ–‡ä»¶ æ­¤æ—¶crashæ–‡ä»¶å¤¹ä¸‹æ–‡ä»¶ï¼š ç„¶åæ‰“å¼€ç»ˆç«¯ï¼Œcd åˆ° crash æ–‡ä»¶å¤¹ä¸‹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š ./symbolicatecrash xxx.carsh xxx.dSYM &gt; log.carsh æ‰§è¡Œä¹‹åï¼Œç»ˆç«¯å¯èƒ½æŠ¥é”™ Error: â€œDEVELOPER_DIRâ€ is not defined at ./symbolicatecrash line 69. ç»§ç»­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š export DEVELOPER_DIR=â€/Applications/Xcode.app/Contents/Developerâ€ ç„¶åï¼Œå†ç»§ç»­æ‰§è¡Œç¬¬ä¸€æ¡ç”Ÿæˆ log çš„å‘½ä»¤ï¼Œæ­¤æ—¶ crash æ–‡ä»¶å¤¹å†…åº”è¯¥å°±èƒ½çœ‹åˆ°ä¸€ä¸ª log.crash æ–‡ä»¶ï¼Œæ‰“å¼€æ­¤æ–‡ä»¶ï¼Œå°±èƒ½æ›´å¥½çš„å®šä½é—®é¢˜æ‰€åœ¨äº†ã€‚","link":"/2021/03/11/iOS%C2%B7%E8%B4%A8%E9%87%8F&%E6%95%88%E7%8E%87/%E8%A7%A3%E6%9E%90%20ips%E6%96%87%E4%BB%B6/"},{"title":"12-Method Swizzlingçš„å‘ä¸åº”ç”¨","text":"ä¸€ã€æ–¹æ³•çš„æœ¬è´¨Objective-Cä¸­ï¼Œæ–¹æ³•æ˜¯ç”±SELå’ŒIMPç»„æˆçš„ï¼Œå‰è€…å«åšæ–¹æ³•ç¼–å·ï¼Œåè€…å«æ–¹æ³•å®ç°ã€‚OCä¸­è°ƒç”¨æ–¹æ³•å«åšå‘é€æ¶ˆæ¯ï¼Œå‘é€æ¶ˆæ¯å‰ä¼šå…ˆæŸ¥æ‰¾æ¶ˆæ¯ï¼ŒæŸ¥æ‰¾è¿‡ç¨‹å°±æ˜¯é€šè¿‡SELæŸ¥æ‰¾IMPçš„è¿‡ç¨‹ï¼Œå¦å¤–ï¼Œæˆ‘ä»¬ç»å¸¸åœ¨ä»£ç ä¸­ä½¿ç”¨@selector(someMethod)è¿™æ ·çš„è¯­æ³•ï¼Œ@selector()å«åšæ–¹æ³•é€‰æ‹©å™¨ï¼Œå…¶è¿”å›çš„å°±æ˜¯SELï¼ŒçœŸæ­£æ‰§è¡Œæ—¶ä¼šæ ¹æ®è¿™ä¸ªSELæŸ¥æ‰¾å¯¹åº”çš„IMPã€‚ äºŒã€MethodSwizzling åŸç†æ¯”å¦‚æœ‰æ–¹æ³•sel1å¯¹åº”imp1ï¼Œsel2å¯¹åº”imp2ï¼Œç»è¿‡æ–¹æ³•äº¤æ¢ï¼Œä½¿å¾—runtimeåœ¨æ–¹æ³•æŸ¥æ‰¾æ—¶å°†sel1çš„æŸ¥æ‰¾ç»“æœå˜ä¸ºimp2ï¼š ï¿¼ ä¸‰ã€Method Swizzling ç›¸å…³å‡½æ•° API1234567891011121314151617// é€šè¿‡SELè·å–ä¸€ä¸ªæ–¹æ³•class_getInstanceMethod// è·å–ä¸€ä¸ªæ–¹æ³•çš„å®ç°method_getImplementation// è·å–ä¸€ä¸ªOCå®ç°çš„ç¼–ç ç±»å‹method_getTypeEncoding// ç»™æ–¹æ³•æ·»åŠ å®ç°class_addMethod// ç”¨ä¸€ä¸ªæ–¹æ³•çš„å®ç°æ›¿æ¢å¦ä¸€ä¸ªæ–¹æ³•çš„å®ç°class_replaceMethod// äº¤æ¢ä¸¤ä¸ªæ–¹æ³•çš„å®ç°method_exchangeImplementations å››ã€ç®€å•ç¤ºä¾‹æ–°å»ºä¸€ä¸ªiOSå·¥ç¨‹ï¼Œæ–°å»ºä¸€ä¸ªPersonç±»ï¼Œå¹¶ä¸ºPersonæ·»åŠ ä¸¤ä¸ªæ–¹æ³•-walkå’Œ-runï¼š 123456789101112131415161718192021// Person.h@interface Person : NSObject- (void)walk;- (void)run;@end// Person.m@implementation Person- (void)walk { NSLog(@&quot;walk&quot;);}- (void)run { NSLog(@&quot;run&quot;);}@end æ–°å»ºä¸€ä¸ªNSObjectçš„åˆ†ç±»MethodSwizzlingå¦‚ä¸‹ï¼š 12345678910111213141516171819// NSObject+MethodSwizzling.h@interface NSObject (MethodSwizzling)+ (void)methodswizzlingWithClass:(Class)cls orgSEL:(SEL)orgSEL targetSEL:(SEL)targetSEL;@end// NSObject+MethodSwizzling.m#import &lt;objc/runtime.h&gt;@implementation NSObject (MethodSwizzling)+ (void)methodswizzlingWithClass:(Class)cls orgSEL:(SEL)orgSEL targetSEL:(SEL)targetSEL { Method orgMethod = class_getInstanceMethod(cls, orgSEL); Method tgtMethod = class_getInstanceMethod(cls, targetSEL); method_exchangeImplementations(orgMethod, tgtMethod);}@end åœ¨Person.mä¸­é‡å†™+loadæ–¹æ³•ï¼š 12345678+ (void)load { static dispatch_once_t onceToken; dispatch_once(&amp;onceToken, ^{ [self methodswizzlingWithClass:self orgSEL:@selector(walk) targetSEL:@selector(run)]; });} åœ¨ViewControllerçš„-viewDidLoadä¸­è°ƒç”¨-walkï¼š 12345- (void)viewDidLoad { [super viewDidLoad]; Person *person = [[Person alloc] init]; [person walk];} è¿è¡Œç¨‹åºï¼Œæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š 12020-02-09 21:26:07.613230+0800 TestObjC[1716:74628] run è°ƒç”¨çš„æ˜¯-walkï¼Œå®é™…æ‰§è¡Œçš„æ˜¯-runï¼Œå®Œæˆäº†æ–¹æ³•äº¤æ¢ã€‚ äº”ã€å‘ç‚¹5.1 äº¤æ¢æ–¹æ³•åå†è°ƒç”¨ load æ–¹æ³•ç¬¬ä¸€ä¸ªå‘ç‚¹æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯æˆ‘ä»¬åœ¨loadä¸­äº¤æ¢å®Œæ–¹æ³•åï¼Œä¸åšå¤„ç†çš„è¯ï¼Œå¦‚æœå†å»è°ƒç”¨loadï¼Œæ–¹æ³•IMPä¼šåˆè¢«äº¤æ¢å›æ¥ï¼Œå¯¼è‡´äº¤æ¢ä¸æˆåŠŸã€‚ è§£å†³çš„æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼šä½¿ç”¨å•ä¾‹æ¨¡å¼æ¥äº¤æ¢æ–¹æ³•ï¼Œä¿è¯æ–¹æ³•çš„äº¤æ¢åªæ‰§è¡Œä¸€æ¬¡ 5.2 åœ¨ç»§æ‰¿çš„ç±»ä¸­è¿›è¡Œæ–¹æ³•äº¤æ¢å¯¼è‡´äº¤æ¢çš„ç»“æœå’Œé¢„æœŸä¸ä¸€è‡´å…·ä½“æè¿°æ˜¯ï¼šåœ¨å­ç±»ä¸­äº¤æ¢å®ƒç‹¬æœ‰çš„æ–¹æ³•å’Œç»§æ‰¿è‡ªçˆ¶ç±»çš„æ–¹æ³•ï¼Œå­ç±»äº¤æ¢æ˜¯æˆåŠŸäº†ï¼Œä½†æ˜¯çˆ¶ç±»ä¸­çš„æ–¹æ³•ä¹Ÿè¢«äº¤æ¢äº†ã€‚ ä½¿ç”¨çš„æ—¶å€™å¤šæ³¨æ„ä¸€ä¸‹ã€‚ ä¾‹ï¼š 123456789101112131415161718Person.h @interface Person : NSObject- (void)walk;@end Person.m@implementation Person- (void)walk { NSLog(@&quot;walk&quot;);}@end 123456789101112131415161718192021222324252627282930313233Student.h@interface Student : Person- (void)study;@end Student.m@implementation Student- (void)study { NSLog(@&quot;study&quot;);}+ (void)load { static dispatch_once_t onceToken; dispatch_once(&amp;onceToken, ^{ [self methodSwizzlingWithClass:self orgSEL:@selector(walk) targetSEL:@selector(study)]; });}+ (void)methodSwizzlingWithClass:(Class)cls orgSEL:(SEL)orgSEL targetSEL:(SEL)targetSEL { Method orgMethod = class_getInstanceMethod(cls, orgSEL); Method tgtMethod = class_getInstanceMethod(cls, targetSEL); method_exchangeImplementations(orgMethod, tgtMethod);}@end 123456789// Student ç±»ä¸­æ–¹æ³•äº¤æ¢æˆåŠŸäº†Student *s = [Student new];[s walk]; // study[s study]; // walk// ä½†æ˜¯é¡ºä¾¿ä¹ŸæŠŠçˆ¶ç±»ç»™äº¤æ¢äº†ï¼ˆè¿™æ˜¯æˆ‘ä»¬ä¸éœ€è¦çš„ï¼Œå¤šæ³¨æ„ï¼‰Person *p = [Person new];[p walk]; // study 5.3 è¦äº¤æ¢çš„æ–¹æ³•æœªå®ç°æ—¶ä¼šäº¤æ¢å¤±è´¥è¿˜æ˜¯ä¸Šé¢çš„ä¾‹å­ï¼Œå¦‚æœ Student ç±»ä¸­ï¼Œåªå£°æ˜äº† -study æ–¹æ³•ï¼Œä½†æ˜¯æœªå®ç°ï¼Œå†äº¤æ¢ -walk æ–¹æ³•å’Œ -study æ–¹æ³•å°±ä¼šäº¤æ¢å¤±è´¥ï¼Œè¿˜æ˜¯ä¹‹å‰çš„è€æ ·å­ï¼Œè¿™ç‚¹ä¹Ÿè¦æ³¨æ„ï¼ˆä¸è¿‡æ­£å¸¸äººå†™ä¸å‡ºè¿™ç§ä»£ç ï¼‰ å…­ã€å¸¸è§åº”ç”¨6.1 åŸ‹ç‚¹ç»Ÿè®¡6.1.1 é¡µé¢æµè§ˆäº‹ä»¶åœ¨ iOS å¼€å‘ä¸­æœ€å¸¸è§çš„ä¸‰ç§åŸ‹ç‚¹ï¼Œå°±æ˜¯å¯¹é¡µé¢è¿›å…¥æ¬¡æ•°ã€é¡µé¢åœç•™æ—¶é—´ã€ç‚¹å‡»äº‹ä»¶çš„åŸ‹ç‚¹ã€‚è¿™äº›éƒ½å¯ä»¥é€šè¿‡Method Swizzlingæ¥å®ç°ã€‚ é€šè¿‡äº¤æ¢UIViewControllerä¸­viewWillAppearå’ŒviewWillDisappearçš„æ–¹æ³•ï¼Œæ¥å®ç°äº†è¿›å…¥ç•Œé¢å’Œé€€å‡ºç•Œé¢çš„ç»Ÿè®¡ï¼Œå¹¶è®°å½•äº†ç›¸å…³çš„ç±»åï¼Œé€šè¿‡æ˜ å°„çš„å…³ç³»ï¼Œå°±å¯ä»¥æ¸…æ¥šçš„çŸ¥é“ç”¨æˆ·çš„è¡Œä¸ºäº†ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243@implementation UIViewController (logger)+ (void)load { static dispatch_once_t onceToken; dispatch_once(&amp;onceToken, ^{ // é€šè¿‡ @selector è·å¾—è¢«æ›¿æ¢å’Œæ›¿æ¢æ–¹æ³•çš„ SELï¼Œä½œä¸º SMHook:hookClass:fromeSelector:toSelector çš„å‚æ•°ä¼ å…¥ SEL fromSelectorAppear = @selector(viewWillAppear:); SEL toSelectorAppear = @selector(hook_viewWillAppear:); [SMHook hookClass:self fromSelector:fromSelectorAppear toSelector:toSelectorAppear]; SEL fromSelectorDisappear = @selector(viewWillDisappear:); SEL toSelectorDisappear = @selector(hook_viewWillDisappear:); [SMHook hookClass:self fromSelector:fromSelectorDisappear toSelector:toSelectorDisappear]; });}- (void)hook_viewWillAppear:(BOOL)animated { // å…ˆæ‰§è¡Œæ’å…¥ä»£ç ï¼Œå†æ‰§è¡ŒåŸ viewWillAppear æ–¹æ³• [self insertToViewWillAppear]; [self hook_viewWillAppear:animated];}- (void)hook_viewWillDisappear:(BOOL)animated { // æ‰§è¡Œæ’å…¥ä»£ç ï¼Œå†æ‰§è¡ŒåŸ viewWillDisappear æ–¹æ³• [self insertToViewWillDisappear]; [self hook_viewWillDisappear:animated];}- (void)insertToViewWillAppear { // åœ¨ ViewWillAppear æ—¶è¿›è¡Œæ—¥å¿—çš„åŸ‹ç‚¹ [[[[SMLogger create] message:[NSString stringWithFormat:@&quot;%@ Appear&quot;,NSStringFromClass([self class])]] classify:ProjectClassifyOperation] save];}- (void)insertToViewWillDisappear { âœ…/ åœ¨ ViewWillDisappear æ—¶è¿›è¡Œæ—¥å¿—çš„åŸ‹ç‚¹ [[[[SMLogger create] message:[NSString stringWithFormat:@&quot;%@ Disappear&quot;,NSStringFromClass([self class])]] classify:ProjectClassifyOperation] save];}@end 6.1.2 æ§ä»¶ç‚¹å‡»äº‹ä»¶é‚£ä¹ˆç‚¹å‡»æ–¹æ³•ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡è¿è¡Œæ—¶è¿›è¡Œæ–¹æ³•æ›¿æ¢å®ç°æ— ä¾µå…¥åŸ‹ç‚¹ã€‚ åŸç†ï¼š å½“æˆ‘ä»¬ä¸ºä¸€ä¸ªæ§ä»¶æ·»åŠ  Target-Action åï¼Œç”¨æˆ·æ“ä½œæ§ä»¶ï¼ˆæ¯”å¦‚ç‚¹å‡»ï¼‰æ—¶ï¼Œé¦–å…ˆä¼šè°ƒç”¨-sendAction:to:forEvent:æ–¹æ³•ï¼Œå¹¶å°†äº‹ä»¶è½¬å‘ç»™åº”ç”¨ç¨‹åºçš„ UIApplication å¯¹è±¡ã€‚ï¼ˆUIApplication ç±»ä¸­å¯¹åº”çš„æ˜¯-sendAction:from:forEvent:æ–¹æ³•ï¼‰ å¦‚æœ Target ä¸ä¸ºç©ºï¼Œåº”ç”¨ç¨‹åºä¼šè®©è¯¥å¯¹è±¡è°ƒç”¨å¯¹åº”çš„æ–¹æ³•å“åº”äº‹ä»¶ï¼›å¦‚æœ Target ä¸ºç©ºï¼Œåº”ç”¨ç¨‹åºä¼šåœ¨å“åº”é“¾ä¸­æœç´¢å®šä¹‰äº†è¯¥æ–¹æ³•çš„å¯¹è±¡ï¼Œç„¶åæ‰§è¡Œè¯¥æ–¹æ³•ã€‚ å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ Method Swizzling äº¤æ¢ UIApplication ç±»ä¸­çš„-sendAction:from:forEvent:æ–¹æ³•ï¼Œç„¶ååœ¨äº¤æ¢åçš„æ–¹æ³•ä¸­è§¦å‘é‡‡é›†äº‹ä»¶ã€‚ å®Œæ•´ä»£ç ï¼š 123456789101112131415161718192021222324#import &quot;UIApplication+XWTracking.h&quot;#import &quot;XWTrackingAnalysisSDK.h&quot;#import &quot;NSObject+XWSwizzler.h&quot;#import &quot;UIView+XWTracking.h&quot;@implementation UIApplication (XWTracking)+ (void)load { [UIApplication xwtracking_swizzleMethod:@selector(sendAction:to:from:forEvent:) withMethod:@selector(xwtracking_sendAction:to:from:forEvent:)];}- (BOOL)xwtracking_sendAction:(SEL)action to:(nullable id)target from:(nullable id)sender forEvent:(nullable UIEvent *)event { // UITabBarItemç»§æ‰¿è‡ªNSObjectï¼Œä¸è¿‡æ»¤ä¼šå´©æºƒ BOOL condition = ((event.allTouches.anyObject.phase == UITouchPhaseEnded) || [sender isKindOfClass:UISwitch.class] || [sender isKindOfClass:UISegmentedControl.class] || [sender isKindOfClass:UIStepper.class]) &amp;&amp; !([sender isKindOfClass:UITabBarItem.class] || [sender isKindOfClass:UIBarButtonItem.class]); if (condition) { // è§¦å‘$AppClickäº‹ä»¶ [XWTrackingAnalysisSDK.shareInstance trackAppClickWithView:sender properties:nil]; } // è°ƒç”¨åŸæœ‰å®ç° return [self xwtracking_sendAction:action to:target from:sender forEvent:event];}@end å’Œ UIViewControllerç”Ÿå‘½å‘¨æœŸåŸ‹ç‚¹ä¸åŒçš„æ˜¯ï¼ŒUIButtonåœ¨ä¸€ä¸ªè§†å›¾ç±»ä¸­å¯èƒ½æœ‰å¤šä¸ªä¸åŒçš„ç»§æ‰¿ç±»ï¼Œç›¸åŒ UIButtonçš„å­ç±»åœ¨ä¸åŒè§†å›¾ç±»çš„åŸ‹ç‚¹ä¹Ÿè¦åŒºåˆ«å¼€ï¼š 123456789101112131415- (void)trackAppClickWithView:(UIView *)view properties:(NSDictionary&lt;NSString *,id&gt; *)properties { NSMutableDictionary *eventProperties = [NSMutableDictionary dictionary]; // è·å–æ§ä»¶ç±»å‹ eventProperties[@&quot;$element_type&quot;] = view.xwtracking_elementType; // è·å–æ§ä»¶æ˜¾ç¤ºæ–‡æœ¬ eventProperties[@&quot;$element_content&quot;] = view.xwtracking_elementContent; // è·å–æ§ä»¶æ‰€åœ¨çš„ UIViewController UIViewController *vc = view.xwtracking_viewController; // è®¾ç½®é¡µé¢ç›¸å…³å±æ€§ eventProperties[@&quot;$screen_name&quot;] = NSStringFromClass(vc.class); // æ·»åŠ è‡ªå®šä¹‰å±æ€§ [eventProperties addEntriesFromDictionary:properties]; // è§¦å‘$AppClickäº‹ä»¶ [XWTrackingAnalysisSDK.shareInstance track:@&quot;$AppClick&quot; properties:eventProperties];} é™¤äº† UIViewControllerã€UIButton æ§ä»¶ä»¥å¤–ï¼ŒCocoa æ¡†æ¶çš„å…¶ä»–æ§ä»¶éƒ½å¯ä»¥ä½¿ç”¨è¿™ç§æ–¹æ³•æ¥è¿›è¡Œæ— ä¾µå…¥åŸ‹ç‚¹ã€‚ä»¥ Cocoa æ¡†æ¶ä¸­æœ€å¤æ‚çš„ UITableView æ§ä»¶ä¸ºä¾‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ hook setDelegate æ–¹æ³•æ¥å®ç°æ— ä¾µå…¥åŸ‹ç‚¹ã€‚å¦å¤–ï¼Œå¯¹äº Cocoa æ¡†æ¶ä¸­çš„æ‰‹åŠ¿äº‹ä»¶ï¼ˆGesture Eventï¼‰ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ hook initWithTarget:action:æ–¹æ³•æ¥å®ç°æ— ä¾µå…¥åŸ‹ç‚¹ã€‚ 6.2 é˜²æ­¢æ•°ç»„ï¼Œå­—å…¸ç­‰è¶Šç•Œå´©æºƒæ•°ç»„è¶Šç•Œç­‰æ˜¯æœ€å®¹æ˜“é€ æˆcrashçš„ä¸€ç§æ–¹å¼ï¼Œè€Œä¸”ä¸€èˆ¬å´©æºƒèµ·æ¥æ¯”è¾ƒä¸¥é‡ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å°½é‡é¿å…ã€‚ åœ¨iOSä¸­NSNumberã€NSArrayã€NSDictionaryç­‰è¿™äº›ç±»éƒ½æ˜¯ç±»ç°‡(Class Clusters)ï¼Œä¸€ä¸ªNSArrayçš„å®ç°å¯èƒ½ç”±å¤šä¸ªç±»ç»„æˆã€‚æ‰€ä»¥å¦‚æœæƒ³å¯¹NSArrayè¿›è¡ŒSwizzlingï¼Œå¿…é¡»è·å–åˆ°å…¶çœŸèº«è¿›è¡ŒSwizzlingï¼Œç›´æ¥å¯¹NSArrayè¿›è¡Œæ“ä½œæ˜¯æ— æ•ˆçš„ã€‚è¿™æ˜¯å› ä¸ºMethod Swizzlingå¯¹NSArrayè¿™äº›çš„ç±»ç°‡æ˜¯ä¸èµ·ä½œç”¨çš„ã€‚ å› ä¸ºè¿™äº›ç±»ç°‡ç±»ï¼Œå…¶å®æ˜¯ä¸€ç§æŠ½è±¡å·¥å‚çš„è®¾è®¡æ¨¡å¼ã€‚æŠ½è±¡å·¥å‚å†…éƒ¨æœ‰å¾ˆå¤šå…¶å®ƒç»§æ‰¿è‡ªå½“å‰ç±»çš„å­ç±»ï¼ŒæŠ½è±¡å·¥å‚ç±»ä¼šæ ¹æ®ä¸åŒæƒ…å†µï¼Œåˆ›å»ºä¸åŒçš„æŠ½è±¡å¯¹è±¡æ¥è¿›è¡Œä½¿ç”¨ã€‚ä¾‹å¦‚æˆ‘ä»¬è°ƒç”¨NSArrayçš„objectAtIndex:æ–¹æ³•ï¼Œè¿™ä¸ªç±»ä¼šåœ¨æ–¹æ³•å†…éƒ¨åˆ¤æ–­ï¼Œå†…éƒ¨åˆ›å»ºä¸åŒæŠ½è±¡ç±»è¿›è¡Œæ“ä½œã€‚ æ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯¹NSArrayç±»è¿›è¡ŒSwizzlingæ“ä½œå…¶å®åªæ˜¯å¯¹çˆ¶ç±»è¿›è¡Œäº†æ“ä½œï¼Œåœ¨NSArrayå†…éƒ¨ä¼šåˆ›å»ºå…¶ä»–å­ç±»æ¥æ‰§è¡Œæ“ä½œï¼ŒçœŸæ­£æ‰§è¡ŒSwizzlingæ“ä½œçš„å¹¶ä¸æ˜¯NSArrayè‡ªèº«ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥å¯¹å…¶â€œçœŸèº«â€è¿›è¡Œæ“ä½œã€‚ ä¸‹é¢åˆ—ä¸¾äº†NSArrayå’ŒNSDictionaryæœ¬ç±»çš„ç±»åï¼Œå¯ä»¥é€šè¿‡Runtimeå‡½æ•°å–å‡ºæœ¬ç±»ï¼š ç±»å çœŸèº« NSArray __NSArrayI NSMutableArray __NSArrayM NSDictionary __NSDictionaryI NSMutableDictionary __NSDictionaryM 6.2.1 å¤„ç† NSArrayNSArray+CrashHandle.h 1234567891011121314151617//// NSArray+CrashHandle.h// Test14//// Created by IMO on 2020/10/10.// Copyright Â© 2020 IMO. All rights reserved.//#import &lt;Foundation/Foundation.h&gt;NS_ASSUME_NONNULL_BEGIN@interface NSArray (CrashHandle)@endNS_ASSUME_NONNULL_END NSArray+CrashHandle.m 123456789101112131415161718192021222324252627282930313233343536//// NSArray+CrashHandle.m// Test14//// Created by IMO on 2020/10/10.// Copyright Â© 2020 IMO. All rights reserved.//#import &quot;NSArray+CrashHandle.h&quot;#import &lt;objc/runtime.h&gt;@implementation NSArray (CrashHandle)// å¦‚æœä¸‹é¢ä»£ç ä¸èµ·ä½œç”¨ï¼Œé€ æˆè¿™ä¸ªé—®é¢˜çš„åŸå› å¤§å¤šéƒ½æ˜¯å…¶è°ƒç”¨äº†super loadæ–¹æ³•ã€‚åœ¨ä¸‹é¢çš„loadæ–¹æ³•ä¸­ï¼Œä¸åº”è¯¥è°ƒç”¨çˆ¶ç±»çš„loadæ–¹æ³•ã€‚è¿™æ ·ä¼šå¯¼è‡´æ–¹æ³•äº¤æ¢æ— æ•ˆ+ (void)load { Method fromMethod = class_getInstanceMethod(objc_getClass(&quot;__NSArrayI&quot;), @selector(objectAtIndex:)); Method toMethod = class_getInstanceMethod(objc_getClass(&quot;__NSArrayI&quot;), @selector(xw_objectAtIndex:)); method_exchangeImplementations(fromMethod, toMethod);}- (id)xw_objectAtIndex:(NSUInteger)index { if (index &gt; self.count - 1) { // æ•°ç»„è¶Šç•Œ @try { return [self xw_objectAtIndex:index]; } @catch (NSException *exception) { // åœ¨å´©æºƒåä¼šæ‰“å°å´©æºƒä¿¡æ¯ã€‚å¦‚æœæ˜¯çº¿ä¸Šï¼Œå¯ä»¥åœ¨è¿™é‡Œå°†å´©æºƒä¿¡æ¯å‘é€åˆ°æœåŠ¡å™¨ NSLog(@&quot;---------- %s Crash Because Method %s ----------\\n&quot;, class_getName(self.class), __func__); NSLog(@&quot;%@&quot;, [exception callStackSymbols]); return nil; } @finally {} } else { // å¦‚æœæ²¡æœ‰é—®é¢˜ï¼Œåˆ™æ­£å¸¸è¿›è¡Œæ–¹æ³•è°ƒç”¨ return [self xw_objectAtIndex:index]; }}@end 12345678910**************************è°ƒç”¨******************************- (void)viewDidLoad { [super viewDidLoad]; // æµ‹è¯•ä»£ç  NSArray *array = @[@0, @1, @2, @3]; [array objectAtIndex:3]; //æœ¬æ¥è¦å¥”æºƒçš„ï¼Œä½†æ˜¯æ²¡æœ‰ï¼Œæ‰“å°å‡ºäº†ä¿¡æ¯ [array objectAtIndex:4];} 6.2.2 å¤„ç† NSMutableArrayNSMutableArray+CrashHandle.h 1234567891011121314151617//// NSMutableArray+CrashHandle.h// Test14//// Created by IMO on 2020/10/10.// Copyright Â© 2020 IMO. All rights reserved.//#import &lt;Foundation/Foundation.h&gt;NS_ASSUME_NONNULL_BEGIN@interface NSMutableArray (CrashHandle)@endNS_ASSUME_NONNULL_END NSMutableArray+CrashHandle.m 12345678910111213141516171819202122232425262728293031323334//// NSMutableArray+CrashHandle.m// Test14//// Created by IMO on 2020/10/10.// Copyright Â© 2020 IMO. All rights reserved.//#import &quot;NSMutableArray+CrashHandle.h&quot;#import &lt;objc/runtime.h&gt;@implementation NSMutableArray (CrashHandle)+ (void)load { Method fromMethod = class_getInstanceMethod(objc_getClass(&quot;__NSArrayM&quot;), @selector(objectAtIndex:)); Method toMethod = class_getInstanceMethod(objc_getClass(&quot;__NSArrayM&quot;), @selector(xw_objectAtIndex:)); method_exchangeImplementations(fromMethod, toMethod);}- (id)xw_objectAtIndex:(NSUInteger)index { if (index &gt; self.count - 1) { // æ•°ç»„è¶Šç•Œ @try { return [self xw_objectAtIndex:index]; } @catch (NSException *exception) { NSLog(@&quot;---------- %s Crash Because Method %s ----------\\n&quot;, class_getName(self.class), __func__); NSLog(@&quot;%@&quot;, [exception callStackSymbols]); return nil; } @finally {} } else { return [self xw_objectAtIndex:index]; }}@end ä»¥ä¸Šçš„ä¸¤ä¸ªä¾‹å­ï¼Œåªæ˜¯å¼€å‘ä¸­å¸¸ç”¨çš„ï¼Œè¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„åº”ç”¨ï¼Œå°±éœ€è¦æ ¹æ®éœ€æ±‚æ¥ä¸æ–­è°ƒæ•´äº†ã€‚è¿™äº›éƒ½å±äº AOP é¢å‘åˆ‡é¢ç¼–ç¨‹çš„ä¸€ä¸ªå®é™…åº”ç”¨ï¼ŒMethod Swizzling ä¹Ÿæ˜¯å…¶åœ¨ iOS å¼€å‘ä¸­åº”ç”¨çš„æœ€å¸¸ç”¨çš„ä¸€ç§ AOP æ€æƒ³ å‚è€ƒiOSåº•å±‚å­¦ä¹  - Runtimeä¹‹Method Swizzlingé»‘é­”æ³• Objective-C çš„ MethodSwizzling","link":"/2021/02/18/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/12-Method%20Swizzling%E7%9A%84%E5%9D%91%E4%B8%8E%E5%BA%94%E7%94%A8/"},{"title":"JsDelivrå›¾åºŠè¾¾åˆ°50MBä¸Šé™çš„è§£å†³åŠæ³•","text":"ä¸€ã€ç»§ç»­ä½¿ç”¨ CDN åŠ é€Ÿåœ¨å›¾åºŠæ˜¯ GitHub + PicGo + JsDelivr çš„å›¾åºŠç¯å¢ƒä¸‹ï¼Œå¦‚æœå›¾ç‰‡åˆ°è¾¾50MB åï¼Œå°±æ— æ³•é åŸæ¥çš„åœ°å€è®¿é—®äº†ã€‚ è§£å†³æ–¹æ³•æ˜¯åœ¨ GitHub éšä¾¿å‘å¸ƒä¸€ä¸ª Releaseï¼Œç„¶åæŠŠ 1234567/ ä»“åº“å@åˆ†ä¹‹å /æ”¹ä¸º/ ä»“åº“å@Tagå / å³å¯ç»§ç»­ä½¿ç”¨ ä¾‹å¦‚ï¼š 1234ä¸èƒ½ä½¿ç”¨çš„ï¼šhttps://cdn.jsdelivr.net/gh/speam/blogImgs@master/v2-3c7b92a4b87ff685dbc95291decbc9c1_1440w.jpgæ”¹ä¸ºï¼šhttps://cdn.jsdelivr.net/gh/speam/blogImgs@1.0/v2-3c7b92a4b87ff685dbc95291decbc9c1_1440w.jpg äºŒã€æ”¾å¼ƒ CDN åŠ é€Ÿï¼Œç›´æ¥å…¨å­˜åˆ° GitHub ä¸Šã€é‡‡ç”¨ã€‘ä¸å¯èƒ½æ¯æ¬¡è¶…è¿‡50 MB é™åˆ¶çš„æ—¶å€™éƒ½æŒ‰ç…§ä¸Šé¢çš„æ“ä½œä¸€éï¼Œå¤ªéº»çƒ¦äº†ï¼Œæ‰€ä»¥æŠŠå›¾ç›´æ¥æ”¾åœ¨ GitHub ä¸Šã€‚ ä½†æ˜¯è¿™æ ·æœ‰ä¸ªç¼ºç‚¹å°±æ˜¯ä¸å¼€å…¨å±€ä»£ç†çš„æƒ…å†µä¸‹ï¼Œå›¾ç‰‡ä¸‹è½½éå¸¸æ…¢æˆ–è€…ç›´æ¥æ˜¾ç¤ºä¸å‡ºæ¥ï¼Œä½†ä¸ºäº†ä¿è¯å›¾ç‰‡é•¿æœŸæœ‰æ•ˆï¼Œåªèƒ½å¼€å…¨å±€ä»£ç†äº†ã€‚","link":"/2021/03/18/%E5%8D%9A%E5%AE%A2/JsDelivr%E5%9B%BE%E5%BA%8A%E8%BE%BE%E5%88%B050MB%E4%B8%8A%E9%99%90%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/"},{"title":"ã€ŠæŒ‡æ•°åŸºé‡‘æŠ•èµ„æŒ‡å—ã€‹è¯»ä¹¦ç¬”è®°","text":"ä¸€ã€ä¹¦ç±ä¿¡æ¯ä¹¦åï¼šæŒ‡æ•°åŸºé‡‘æŠ•èµ„æŒ‡å— ä½œè€…ï¼šé“¶è¡Œèºä¸é’‰ åˆ†ç±»ï¼šæŠ•èµ„ç†è´¢å·¥å…·ä¹¦ è¯»å®Œæ—¶é—´ï¼š2021.3 äºŒã€å‰è¨€ä½œè€…åœ¨å…¶å‰è¨€ä¸­æåˆ°çš„è‡ªå·±â€œå°†ä¼šé‡‡å–â€çš„ç»„åˆï¼š50%æ²ªæ·±300æŒ‡æ•°åŸºé‡‘ï¼Œ15%ä¸Šè¯çº¢åˆ©åŸºé‡‘ï¼Œ30%æ ‡æ™®500æŒ‡æ•°åŸºé‡‘ï¼Œ5%çº³æ–¯è¾¾å…‹ç»¼åˆåŸºé‡‘ã€‚ ä¸‰ã€ç†è§£3.1 æŒ‡æ•°åŸºé‡‘çš„åˆ†ç±»å®½åŸºæŒ‡æ•°åŸºé‡‘ è¡Œä¸šæŒ‡æ•°åŸºé‡‘ 3.2 å¦‚ä½•é€‰æŒ‡æ•°åŸºé‡‘ï¼Ÿ3.2.1 åŸºæœ¬ç†å¿µä½ä¼°å€¼ä»·å€¼æŠ•èµ„ã€‚å·´è²ç‰¹çš„è€å¸ˆæ ¼é›·å„å§†åŸºäºä»·å€¼æŠ•èµ„æ€»ç»“äº†ä¸‰ä¸ªç†è®ºï¼šä»·æ ¼ä¸ä»·å€¼çš„å…³ç³»ã€èƒ½åŠ›åœˆã€å®‰å…¨è¾¹é™…ã€‚ ä»·æ ¼ä¸ä»·å€¼çš„å…³ç³»ï¼š ä»·æ ¼å›´ç»•ä»·å€¼ä¸Šä¸‹æ³¢åŠ¨ èƒ½åŠ›åœˆï¼š äº†è§£è‡ªå·±çš„æŠ•èµ„å“ç§ï¼Œåˆ¤æ–­å…¶å¤§è‡´ä»·å€¼ï¼Œå¾ˆé‡è¦ å®‰å…¨è¾¹é™…ï¼š ä»·æ ¼ä½äºä»·å€¼çš„æ—¶å€™æ‰å¯ä»¥æŠ•èµ„ 3.2.2 ä¼°å€¼æŒ‡æ ‡å¸‚ç›ˆç‡$$å¸‚ç›ˆç‡ = \\frac{å¸‚å€¼}{ç›ˆåˆ©}$$ å¸‚å€¼ä¼šæ³¢åŠ¨ï¼Œä½ä»£è¡¨ä½ä¼°ï¼Œè¶Šä½è¶Šå¥½ ç›ˆåˆ©æ”¶ç›Šç‡$$ç›ˆåˆ©æ”¶ç›Šç‡=\\frac{ç›ˆåˆ©}{å¸‚å€¼}$$ è¶Šé«˜ä»£è¡¨ä¼°å€¼è¶Šä½ï¼Œè¶Šé«˜è¶Šå¥½ å¸‚å‡€ç‡$$å¸‚å‡€ç‡=\\frac{å¸‚å€¼}{å‡€èµ„äº§}$$ è¶Šä½è¶Šå¥½ è‚¡æ¯ç‡$$è‚¡æ¯ç‡=\\frac{åˆ†çº¢}{å¸‚å€¼}$$ è¶Šé«˜è¶Šå¥½ åˆ†çº¢ç‡$$åˆ†çº¢ç‡=\\frac{åˆ†çº¢}{å‡€åˆ©æ¶¦}$$ ä¸€èˆ¬ä¸å˜ ROE(å‡€èµ„äº§æ”¶ç›Šç‡)$$ROE=\\frac{å‡€åˆ©æ¶¦}{å‡€èµ„äº§}$$ 3.2.3 ä¼°å€¼æŸ¥è¯¢æ–¹å¼å…¬ä¼—å·ï¼šå®šæŠ•åå¹´èµšåå€ 3.2.4 ä¸¤ç§æ–¹å¼æŒ‘é€‰ç›ˆåˆ©æ”¶ç›Šç‡æ³•å½“ç›ˆåˆ©æ”¶ç›Šç‡å¤§äº10%æ—¶ï¼Œå¼€å§‹å®šæŠ• å½“ç›ˆåˆ©æ”¶ç›Šç‡åœ¨6.4%ï½10%æ—¶ï¼ŒåšæŒæŒæœ‰ å½“ç›ˆåˆ©æ”¶ç›Šç‡å°äº6.4%æ—¶ï¼Œåˆ†æ‰¹å–å‡º åšæ ¼å…¬å¼æ³•æŒ‡æ•°åŸºé‡‘æœªæ¥çš„å¹´å¤åˆæ”¶ç›Šç‡ = æŒ‡æ•°åŸºé‡‘çš„æŠ•èµ„åˆæœŸè‚¡æ¯ç‡ + æŒ‡æ•°åŸºé‡‘æ¯å¹´çš„å¸‚ç›ˆç‡å˜åŒ–ç‡ + æŒ‡æ•°åŸºé‡‘æ¯å¹´çš„ç›ˆåˆ©å˜åŒ–ç‡ 3.3 å¦‚ä½•ä¹°å–3.3.1 å®šæŠ•è§„åˆ™ç›ˆåˆ©æ”¶ç›Šç‡æ³• + å®šæŠ• åšæ ¼å…¬å¼æ³• + å®šæŠ• 3.3.2 è®¡ç®—å¹´å¤åˆæ”¶ç›Šç‡IRR å…¬å¼ 3.3.3 æé«˜æ”¶ç›Šç‡çš„å°æŠ€å·§å®šæœŸä¸å®šé¢ + ç›ˆåˆ©æ”¶ç›Šç‡æ³•$$æ¯ä¸ªæœˆçš„å®šæŠ•é‡‘é¢=é¦–æ¬¡ä½ä¼°æ—¶çš„å®šæŠ•èµ„é‡‘*\\frac{å½“æœˆçš„ç›ˆåˆ©æ”¶ç›Šç‡}{é¦–æ¬¡çš„ç›ˆåˆ©æ”¶ç›Šç‡}$$ 3.4 æ„å»ºè‡ªå·±çš„å®šæŠ•è®¡åˆ’ 3.5 å®¶åº­èµ„äº§é…ç½®çŸ­æœŸèµ„é‡‘ç®¡ç†â€”è´§å¸åŸºé‡‘ï¼ˆä½™é¢å®ï¼‰ ä¸­æœŸèµ„é‡‘ç®¡ç†â€”å€ºåˆ¸ å››ã€ç»“å°¾å¼•ç”¨ä½œè€…å–œæ¬¢çš„ä¸€å¥è¯ï¼šâ€œæˆ‘ç›¸ä¿¡ï¼Œæˆ‘ç»ˆå°†å¯Œæœ‰ï¼â€","link":"/2021/03/28/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E3%80%8A%E6%8C%87%E6%95%B0%E5%9F%BA%E9%87%91%E6%8A%95%E8%B5%84%E6%8C%87%E5%8D%97%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"},{"title":"WKWebview ç™½å±é—®é¢˜å¤„ç†","text":"ä¸€ã€é—®é¢˜æè¿°WKWebview è½½å…¥è¿‡ç¨‹ä¸­æœ‰æ¦‚ç‡ä¼šå‡ºç°æ•´ä¸ª webview ç©ºç™½çš„æƒ…å†µï¼Œæˆ‘ä»¬åˆ†æè®¤ä¸ºè¿™å±äº iOS ç³»ç»Ÿçš„ bugï¼ŒçŒœæµ‹å¤§æ¦‚æˆ–è®¸æœ‰å¯èƒ½maybeå‡ºç°çš„åŸå› æ˜¯ç½‘é¡µé‡å®šå‘è¿‡å¤šæˆ–è€…å…¶ä»–å„ç§åŸå› ã€‚ è™½ç„¶æ˜¯ç³»ç»Ÿ bugï¼Œä½†è¿˜æ˜¯è¦æˆ‘ä»¬è‡ªå·±å»è§£å†³ã€‚ äºŒã€å°è¯•è§£å†³å®éªŒä¸€ï¼šåœ¨ webViewWebContentProcessDidTerminate å›è°ƒå‡½æ•°ä¸­å¤„ç†å®éªŒè¿‡ç¨‹ï¼š åšå®¢æ‘˜å½•ï¼š 1å½“ WKWebView æ€»ä½“å†…å­˜å ç”¨è¿‡å¤§ï¼Œé¡µé¢å³å°†ç™½å±çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šè°ƒç”¨`-webViewWebContentProcessDidTerminate:`å›è°ƒå‡½æ•°ï¼Œç„¶ååœ¨è¯¥å‡½æ•°é‡Œæ‰§è¡Œ`[webView reload]`å»è§£å†³ç™½å±é—®é¢˜ã€‚ å®éªŒç»“æœï¼š é¡µé¢å³å°†ç™½å±çš„æ—¶å€™å¹¶ä¸èµ°ä¸Šé¢çš„ä»£ç†æ–¹æ³•ã€‚è€Œä¸”è·Ÿ WKWebView å†…å­˜å ç”¨æ²¡ä»»ä½•å…³ç³»ï¼Œå› ä¸ºæˆ‘ç›´æ¥åœ¨ MacBook Pro with M1 chip ä¸Šè·‘çœŸæœºä¹Ÿä¼šå‡ºç°ç™½å±é—®é¢˜ï¼Œä½¿ç”¨ç”µè„‘16 GBå†…å­˜ï¼Œè¶³å¤Ÿå¤§äº†ã€‚ å®éªŒäºŒï¼šåœ¨ webViewWebContentProcessDidTerminate å›è°ƒå‡½æ•°ä¸­å¤„ç†å®éªŒè¿‡ç¨‹ï¼š åšå®¢æ‘˜å½•ï¼š 1å½“h5é¡µé¢å³å°†ç™½å±æ—¶ï¼Œä¼šè°ƒç”¨`-(void)webViewWebContentProcessDidTerminate:`æ–¹æ³•ï¼Œæˆ‘ä»¬åªéœ€åœ¨è¿™ä¸ªæ–¹æ³•ä¸­é‡æ–°åŠ è½½webviewå³å¯ å®éªŒç»“æœï¼š é¡µé¢å³å°†ç™½å±çš„æ—¶å€™å¹¶ä¸èµ°ä¸Šé¢çš„ä»£ç†æ–¹æ³•ã€‚å®éªŒè¿‡ç¨‹ä¸­å‘ç°å‡ºç°ç™½å±é—®é¢˜æ—¶æœ‰æ—¶å€™ä¼šè°ƒç”¨ï¼šdidFailNavigation:æ–¹æ³•ï¼Œå¹¶ä¸”å½“æ—¶çš„æŠ¥é”™æ˜¯é‡å®šå‘è¿‡å¤šã€‚ä½†æ˜¯æœ‰æ—¶å€™åˆä¸èµ°didFailNavigationè¿™ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥ä¹Ÿä¸èƒ½åœ¨è¿™é‡Œå»å¤„ç†ã€‚ å®éªŒä¸‰ï¼šæ£€æµ‹ webView.title æ˜¯å¦ä¸ºç©ºå®éªŒè¿‡ç¨‹ï¼š åœ¨-viewWillAppearçš„æ—¶å€™æ£€æµ‹webView.titleï¼Œå¦‚æœä¸ºç©ºåˆ™reloadé¡µé¢ã€‚ å®éªŒç»“æœï¼š æ‰€æœ‰é¡µé¢åœ¨-viewWillAppearçš„æ—¶å€™webView.titleéƒ½ä¸ºç©ºï¼Œå› ä¸ºé¡µé¢éƒ½æ²¡åŠ è½½å®Œï¼Œæ–¹æ¡ˆå°±æœ‰é—®é¢˜ï¼Œæ‰€ä»¥ passã€‚ å®éªŒå››ï¼šjs æ³¨å…¥èµ„æºåŠ è½½é”™è¯¯æ£€æµ‹ä»£ç å®éªŒè¿‡ç¨‹ï¼š æ³¨å…¥ä¸‹é¢çš„ js ä»£ç ï¼Œç›‘æµ‹åˆ°å‡ºé”™å°±é‡æ–°åŠ è½½ç½‘é¡µ 123456789101112// ç›‘æ§èµ„æºåŠ è½½é”™è¯¯(img,script,css,ä»¥åŠjsonp)ï¼Œå‡ºé”™å°±é‡æ–°åŠ è½½window.addEventListener('error', function (e) { console.log(&quot;===&quot; + e.message + &quot;===&quot;); location.reload();}, true);window.onerror = function (errorMessage, scriptURI, lineNumber, columnNumber, errorObj) { console.log(&quot;é”™è¯¯ä¿¡æ¯ï¼š&quot;, errorMessage); console.log(&quot;å‡ºé”™æ–‡ä»¶ï¼š&quot;, scriptURI); console.log(&quot;å‡ºé”™è¡Œå·ï¼š&quot;, lineNumber); console.log(&quot;å‡ºé”™åˆ—å·ï¼š&quot;, columnNumber); console.log(&quot;é”™è¯¯è¯¦æƒ…ï¼š&quot;, errorObj);} å®éªŒç»“æœï¼š æ³¨å…¥ js ä»£ç åä¼šå‡ºç°é¡µé¢æ— é™é‡è½½é—®é¢˜ï¼Œè€Œä¸”åç»­æˆ‘ä»¬åˆ†æé¡µé¢ç™½å±æ˜¯ iOS ç³»ç»Ÿé—®é¢˜ï¼Œé‚£ä¹ˆæŠŠé—®é¢˜çš„æ£€æµ‹äº¤ç»™ H5 å»åšæ˜¾ç„¶æ˜¯ä¸åˆç†ä¹Ÿä¸å¯¹çš„ã€‚ ä¸‰ã€æœ€ç»ˆæ–¹æ¡ˆï¼šåƒç´ éå†ï¼Œçº¯ç™½åƒç´ è¶…è¿‡é˜ˆå€¼å°±é‡æ–°è½½å…¥å‚è€ƒå­—èŠ‚è·³åŠ¨å›¢é˜Ÿçš„è§£å†³æ–¹æ¡ˆï¼Œé‡‡ç”¨åœ¨ç½‘é¡µåŠ è½½å®Œæ¯•åå¯¹å½“å‰ webview çš„å¯è§†åŒºåŸŸæˆªå›¾ï¼Œå¹¶å¯¹æ­¤å¿«ç…§è¿›è¡Œåƒç´ ç‚¹éå†ï¼Œå¦‚æœçº¯ç™½è‰²åƒç´ æ‰€å ç™¾åˆ†æ¯”è¶…è¿‡é˜ˆå€¼ï¼Œåˆ™è®¤ä¸ºå‡ºç°ç™½å±ï¼Œç„¶åè®©å½“å‰é¡µé¢é‡æ–°åŠ è½½çš„æ–¹å¼å»å¤„ç†ã€‚ 3.1 è·å–å¿«ç…§ioså®˜æ–¹æä¾›äº†ç®€æ˜“çš„è·å–webviewå¿«ç…§æ¥å£ï¼Œé€šè¿‡å¼‚æ­¥å›è°ƒæ‹¿åˆ°å½“å‰å¯è§†åŒºåŸŸçš„å±å¹•æˆªå›¾ã€‚ 1- (void)takeSnapshotWithConfiguration:(nullable WKSnapshotConfiguration *)snapshotConfiguration completionHandler:(void (^)(UIImage * _Nullable snapshotImage, NSError * _Nullable error))completionHandler API_AVAILABLE(ios(11.0)); å…¶ä¸­snapshotConfigurationå‚æ•°å¯ç”¨äºé…ç½®å¿«ç…§å¤§å°èŒƒå›´ï¼Œé»˜è®¤æˆªå–å½“å‰å®¢æˆ·ç«¯æ•´ä¸ªå±å¹•åŒºåŸŸã€‚å½“ç„¶è¦å‰”é™¤å¯¼èˆªæ ï¼Œå› ä¸ºä¸€èˆ¬å¯¼èˆªæ çš„é¢œè‰²éƒ½æ˜¯è‡ªå®šä¹‰çš„é¢œè‰²ï¼Œéçº¯ç™½ï¼Œä¼šå¹²æ‰°æ£€æµ‹ç»“æœã€‚ 12345678910111213141516- (void)judgeLoadingStatus:(WKWebView *)webview { if (@available(iOS 11.0, *)) { if (webView &amp;&amp; [webView isKindOfClass:[WKWebView class]]) { // çŠ¶æ€æ é«˜åº¦ CGFloat statusBarHeight = [[UIApplication sharedApplication] statusBarFrame].size.height; // å¯¼èˆªæ é«˜åº¦ CGFloat navigationHeight = webView.viewController.navigationController.navigationBar.frame.size.height; // âœ…ä»…æˆªå›¾æ£€æµ‹å¯¼èˆªæ ä»¥ä¸‹éƒ¨åˆ†å†…å®¹ WKSnapshotConfiguration *shotConfiguration = [[WKSnapshotConfiguration alloc] init]; shotConfiguration.rect = CGRectMake(0, statusBarHeight + navigationHeight, _webView.bounds.size.width, (_webView.bounds.size.height - navigationHeight - statusBarHeight)); [_webView takeSnapshotWithConfiguration:shotConfiguration completionHandler:^(UIImage * _Nullable snapshotImage, NSError * _Nullable error) { //todo }]; } }} 3.2 ç¼©æ”¾å¿«ç…§ ä¸ºäº†æå‡æ£€æµ‹æ€§èƒ½ï¼Œè€ƒè™‘å°†å¿«ç…§ç¼©æ”¾è‡³1/5ï¼Œå‡å°‘åƒç´ ç‚¹æ€»æ•°ï¼Œä»è€ŒåŠ å¿«éå†é€Ÿåº¦ã€‚ 1234567891011121314- (UIImage *)scaleImage:(UIImage *)image { CGFloat scale = 0.2; CGSize newsize; newsize.width = floor(image.size.width * scale); newsize.height = floor(image.size.height * scale); if (@available(iOS 10.0, *)) { UIGraphicsImageRenderer *renderer = [[UIGraphicsImageRenderer alloc] initWithSize:newsize]; return [renderer imageWithActions:^(UIGraphicsImageRendererContext * _Nonnull rendererContext) { [image drawInRect:CGRectMake(0, 0, newsize.width, newsize.height)]; }]; } else { return image; }} ç»æµ‹è¯•ç¼©æ”¾åéå†è¿‡ç¨‹å¤§æ¦‚åœ¨20msä»¥å†…ã€‚ æ³¨æ„è¿™é‡Œæœ‰ä¸ªå‘ï¼šç”±äºç¼©æ”¾åçš„å›¾çš„å°ºå¯¸åœ¨ åŸå›¾å®½é«˜*ç¼©æ”¾ç³»æ•°åå¯èƒ½ä¸æ˜¯æ•´æ•°ï¼Œåœ¨å¸ƒç½®ç”»å¸ƒé‡ç»˜æ—¶é»˜è®¤å‘ä¸Šå–æ•´ï¼Œè¿™å°±é€ æˆé‡ç»˜çš„ç”»å¸ƒæ¯”ç†è®ºä¸Šç¼©æ”¾åçš„å›¾å¤§ã€‚åœ¨éå†ç¼©æ”¾åå›¾ç‰‡çš„åƒç´ æ—¶ï¼Œä¼šå°†å›¾å¤–ç”»å¸ƒä¸Šçš„åƒç´ çº³å…¥è€ƒè™‘èŒƒå›´ï¼Œå¯¼è‡´å®é™…ç™½å±é¡µåƒç´ å æ¯”å¹¶é100%ã€‚å› æ­¤ä½¿ç”¨floorå°†å…¶å°ºå¯¸å¤§å°å‘ä¸‹å–æ•´ï¼ˆä½¿ç”¨ floor å‡½æ•°ï¼‰ã€‚ 3.3 éå†å¿«ç…§éå†å¿«ç…§ç¼©æ”¾åå›¾ç‰‡çš„åƒç´ ç‚¹ï¼Œå¯¹çº¯ç™½åƒç´ å æ¯”å¤§äº99%çš„é¡µé¢ï¼Œè®¤å®šå…¶ä¸ºç™½å±é—®é¢˜é¡µã€‚ 12345678910111213141516171819202122232425262728293031323334353637// éå†åƒç´ ç‚¹ ç™½è‰²åƒç´ å æ¯”å¤§äº99%è®¤å®šä¸ºç™½å±- (BOOL)searchEveryPixel:(UIImage *)image { CGImageRef cgImage = [image CGImage]; size_t width = CGImageGetWidth(cgImage); size_t height = CGImageGetHeight(cgImage); // æ¯ä¸ªåƒç´ ç‚¹åŒ…å«r g b a å››ä¸ªå­—èŠ‚ size_t bytesPerRow = CGImageGetBytesPerRow(cgImage); size_t bitsPerPixel = CGImageGetBitsPerPixel(cgImage); CGDataProviderRef dataProvider = CGImageGetDataProvider(cgImage); CFDataRef data = CGDataProviderCopyData(dataProvider); UInt8 *buffer = (UInt8 *)CFDataGetBytePtr(data); int whiteCount = 0; int totalCount = 0; for (int j = 0; j &lt; height; j ++ ) { for (int i = 0; i &lt; width; i ++) { UInt8 *pt = buffer + j * bytesPerRow + i * (bitsPerPixel / 8); UInt8 red = * pt; UInt8 green = *(pt + 1); UInt8 blue = *(pt + 2); totalCount ++; if (red &gt;= 254 &amp;&amp; green &gt;= 254 &amp;&amp; blue &gt;= 254) { whiteCount ++; } } } float proportion = (float)whiteCount / totalCount ; NSLog(@&quot;å½“å‰åƒç´ ç‚¹æ•°ï¼š%d,ç™½è‰²åƒç´ ç‚¹æ•°:%d , å æ¯”: %f&quot;,totalCount , whiteCount , proportion ); if (proportion &gt; 0.99) { return YES; } else { return NO; }} æ³¨æ„è¿™é‡Œæœ‰ä¸ªå‘ï¼šæœ‰æ—¶å€™å‡ºç°ç™½å±äº†ï¼Œä½†æ˜¯æ£€æµ‹å‡ºæ¥çš„ RGB å€¼æœ‰äº›ä¸º254ï¼Œæœ‰äº›ä¸º255ï¼Œæ‰€ä»¥éœ€è¦if (red &gt;= 254 &amp;&amp; green &gt;= 254 &amp;&amp; blue &gt;= 254)è¿™æ ·å¤„ç†ã€‚ 3.4 ä½¿ç”¨åœ¨é¡µé¢åŠ è½½å®Œæˆåè°ƒç”¨-judgeLoadingStatus:æ–¹æ³•åˆ¤æ–­æ˜¯å¦å‡ºç°ç™½å±ï¼Œå‡ºç°äº†å°±é‡æ–°åˆ·æ–°é¡µé¢ï¼Œç»æµ‹è¯•å¯ä»¥å®Œç¾è§£å†³ç™½å±é—®é¢˜ã€‚ 12345678910111213141516171819- (void)webView:(WKWebView *)webView didFinishNavigation:(null_unspecified WKNavigation *)navigation { @weakify(self); [self judgeLoadingStatus:webView withBlock:^(webviewLoadingStatus status) { @strongify(self); switch (status) { case WebViewErrorStatus: self.reloadTime += 1; if (self.reloadTime &gt; 2) { return; } [webView reload]; NSLog(@&quot;é‡åˆ°ç™½å±ï¼Œé‡æ–°åŠ è½½ğŸ†˜&quot;); break; default: break; } }];} 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687#pragma mark - å¤„ç†ç™½å±é—®é¢˜// åˆ¤æ–­æ˜¯å¦ç™½å±- (void)judgeLoadingStatus:(WKWebView *)webview withBlock:(void (^)(webviewLoadingStatus status))completionBlock { webviewLoadingStatus __block status = WebViewPendStatus; if (@available(iOS 11.0, *)) { if (webview) { // çŠ¶æ€æ é«˜åº¦ CGFloat statusBarHeight = [[UIApplication sharedApplication] statusBarFrame].size.height; // å¯¼èˆªæ é«˜åº¦ CGFloat navigationHeight = webview.viewController.navigationController.navigationBar.frame.size.height; WKSnapshotConfiguration *shotConfiguration = [[WKSnapshotConfiguration alloc] init]; // ä»…æˆªå›¾æ£€æµ‹å¯¼èˆªæ ä»¥ä¸‹éƒ¨åˆ†å†…å®¹(åº•éƒ¨å®‰å…¨åŒºåŸŸä¸å½±å“) shotConfiguration.rect = CGRectMake(0, statusBarHeight + navigationHeight, webview.bounds.size.width, (webview.bounds.size.height - navigationHeight - statusBarHeight)); @weakify(self); [webview takeSnapshotWithConfiguration:shotConfiguration completionHandler:^(UIImage * _Nullable snapshotImage, NSError * _Nullable error) { @strongify(self); if (snapshotImage) { UIImage *scaleImage = [self scaleImage:snapshotImage]; BOOL isWhiteScreen = [self searchEveryPixel:scaleImage]; if (isWhiteScreen) { status = WebViewErrorStatus; } else { status = WebViewNormalStatus; } } if (completionBlock) { completionBlock(status); } }]; } }}// éå†åƒç´ ç‚¹ ç™½è‰²åƒç´ å æ¯”å¤§äº99%è®¤å®šä¸ºç™½å±- (BOOL)searchEveryPixel:(UIImage *)image { CGImageRef cgImage = [image CGImage]; size_t width = CGImageGetWidth(cgImage); size_t height = CGImageGetHeight(cgImage); // æ¯ä¸ªåƒç´ ç‚¹åŒ…å«r g b a å››ä¸ªå­—èŠ‚ size_t bytesPerRow = CGImageGetBytesPerRow(cgImage); size_t bitsPerPixel = CGImageGetBitsPerPixel(cgImage); CGDataProviderRef dataProvider = CGImageGetDataProvider(cgImage); CFDataRef data = CGDataProviderCopyData(dataProvider); UInt8 *buffer = (UInt8 *)CFDataGetBytePtr(data); int whiteCount = 0; int totalCount = 0; for (int j = 0; j &lt; height; j ++ ) { for (int i = 0; i &lt; width; i ++) { UInt8 *pt = buffer + j * bytesPerRow + i * (bitsPerPixel / 8); UInt8 red = * pt; UInt8 green = *(pt + 1); UInt8 blue = *(pt + 2); totalCount ++; if (red &gt;= 254 &amp;&amp; green &gt;= 254 &amp;&amp; blue &gt;= 254) { whiteCount ++; } } } float proportion = (float)whiteCount / totalCount ; NSLog(@&quot;å½“å‰åƒç´ ç‚¹æ•°ï¼š%d,ç™½è‰²åƒç´ ç‚¹æ•°:%d , å æ¯”: %f&quot;,totalCount , whiteCount , proportion ); if (proportion &gt; 0.99) { return YES; } else { return NO; }}// ä¸ºäº†æå‡æ£€æµ‹æ€§èƒ½ï¼Œè€ƒè™‘å°†å¿«ç…§ç¼©æ”¾è‡³1/5ï¼Œå‡å°‘åƒç´ ç‚¹æ€»æ•°ï¼Œä»è€ŒåŠ å¿«éå†é€Ÿåº¦- (UIImage *)scaleImage:(UIImage *)image { CGFloat scale = 0.2; CGSize newsize; newsize.width = floor(image.size.width * scale); newsize.height = floor(image.size.height * scale); if (@available(iOS 10.0, *)) { UIGraphicsImageRenderer *renderer = [[UIGraphicsImageRenderer alloc] initWithSize:newsize]; return [renderer imageWithActions:^(UIGraphicsImageRendererContext * _Nonnull rendererContext) { [image drawInRect:CGRectMake(0, 0, newsize.width, newsize.height)]; }]; } else { return image; }} åè®°ä¿æŒæ€€ç–‘ç²¾ç¥ã€‚","link":"/2021/02/22/iOS%C2%B7%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/WKWebview-%E7%99%BD%E5%B1%8F%E9%97%AE%E9%A2%98%E5%A4%84%E7%90%86/"},{"title":"iOS+SQLite","text":"ä¸€ã€SQLite31.1 åŸºæœ¬æ“ä½œæ•°æ®åº“æ“ä½œæœ€åŸºæœ¬çš„æ— éå°±æ˜¯==å¢ï¼Œåˆ ï¼Œæ”¹ï¼ŒæŸ¥==å››ä¸ªåŠŸèƒ½ã€‚å¢åˆ æ”¹å¯ä»¥ç»Ÿä¸€å½’ä¸ºä¿®æ”¹æ•°æ®ï¼š åœ¨ SQLite ä¸­ï¼Œä¿®æ”¹æ•°æ®çš„åŸºæœ¬æµç¨‹ä¸ºï¼š ç¬¬ä¸€æ­¥ sqlite3_open_v2 æ‰“å¼€æ•°æ®åº“ç¬¬äºŒæ­¥ sqlite3_prepare_v2 é¢„å¤„ç† SQL è¯­å¥æ“ä½œç¬¬ä¸‰æ­¥ sqlite3_bind_xxx ç»‘å®šå‚æ•°ç¬¬å››æ­¥ sqlite3_step / sqlite3_exec æ‰§è¡Œ SQL è¯­å¥ç¬¬äº”æ­¥ sqlite3_finalize å’Œ sqlite3_close é‡Šæ”¾èµ„æº 1.2 APIsqlite3_open_v2æ‰“å¼€æ•°æ®åº“ å‚æ•°1:æ•°æ®åº“æ–‡ä»¶è·¯å¾„ å‚æ•°2:æ•°æ®åº“å¥æŸ„ / æ•°æ®åº“å®ä¾‹ å‚æ•°3:æ ‡è®° æœ‰ä»¥ä¸‹å‡ ç§ï¼š SQLITE_OPEN_NOMUTEX: è®¾ç½®æ•°æ®åº“è¿æ¥è¿è¡Œåœ¨å¤šçº¿ç¨‹æ¨¡å¼(æ²¡æœ‰æŒ‡å®šå•çº¿ç¨‹æ¨¡å¼çš„æƒ…å†µä¸‹)SQLITE_OPEN_FULLMUTEXï¼šè®¾ç½®æ•°æ®åº“è¿æ¥è¿è¡Œåœ¨ä¸²è¡Œæ¨¡å¼ã€‚SQLITE_OPEN_SHAREDCACHEï¼šè®¾ç½®è¿è¡Œåœ¨å…±äº«ç¼“å­˜æ¨¡å¼ã€‚SQLITE_OPEN_PRIVATECACHEï¼šè®¾ç½®è¿è¡Œåœ¨éå…±äº«ç¼“å­˜æ¨¡å¼ã€‚SQLITE_OPEN_READWRITEï¼šæŒ‡å®šæ•°æ®åº“è¿æ¥å¯ä»¥è¯»å†™ã€‚SQLITE_OPEN_CREATEï¼šå¦‚æœæ•°æ®åº“ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºã€‚ å‚æ•°4:ä½¿ç”¨è¯¥æ•°æ®åº“çš„è™šæ‹Ÿæœºçš„åå­—ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸éœ€è¦ç”¨ï¼Œç›´æ¥ä¼  NULL sqlite3_prepare_v2æ£€æŸ¥SQLè¯­å¥çš„åˆæ³•æ€§ï¼ˆæŸ¥è¯¢å‰çš„å‡†å¤‡ï¼‰ è‹¥è¯­å¥åˆæ³•å³ç¼–è¯‘é€šè¿‡ï¼Œåˆ™å°†è¯­å¥äº§ç”Ÿçš„æŒ‡ä»¤å¡è¿› stmt å¥æŸ„ï¼ˆæ­¤æ—¶å¹¶æœªæ‰§è¡ŒæŒ‡ä»¤ï¼‰ å‚æ•°1:æ•°æ®åº“å®ä¾‹ å‚æ•°2:éœ€è¦æ£€æŸ¥çš„ SQL è¯­å¥ å‚æ•°3:SQL è¯­å¥çš„æœ€å¤§å­—èŠ‚é•¿åº¦ï¼Œ-1ä»£è¡¨æ€»é•¿åº¦ å‚æ•°4:stmt å¥æŸ„ï¼Œç”¨æ¥å­˜å‚¨ SQL stmt æŒ‡ä»¤ å‚æ•°5:æŒ‡å‘ zSql æœªä½¿ç”¨éƒ¨åˆ†çš„æŒ‡é’ˆï¼Œä¼  null sqlite3_bindé€šè¿‡ prepare æ¥å£å¯ä»¥æ”¯æŒå‚æ•°åŒ–çš„ SQL è¯­å¥ï¼Œå³å¸¦é—®å·çš„SQLè¯­å¥ã€‚æ¯”å¦‚æŸ¥è¯¢è¯­å¥select * from t where id=?ï¼Œæˆ–è€…æ’å…¥è¯­å¥insert into t(a,b,c) values(?,?,?)ã€‚ç”±äºé—®å·æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œå› æ­¤éœ€è¦è°ƒç”¨sqlite3_bind_xxxæ¥å£æ¥ç»‘å®šå…·ä½“çš„å‚æ•°ã€‚ ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç±»ï¼šsqlite3_bind_intsqlite3_bind_int64sqlite3_bind_doublesqlite3_bind_textsqlite3_bind_blobsqlite3_bind_null å‚æ•°1:è¯­å¥å¯¹è±¡ å‚æ•°2:å‚æ•°å¼€å§‹æ‰§è¡Œçš„åºå· å‚æ•°3:æˆ‘ä»¬è¦ç»‘å®šçš„å€¼ å‚æ•°4:ç»‘å®šçš„å­—ç¬¦ä¸²çš„é•¿åº¦ å‚æ•°5:æŒ‡é’ˆï¼Œä¼  NULL sqlite3_stepæ‰§è¡Œstmtå¥æŸ„ï¼ˆæ‰§è¡Œå­˜å‚¨åœ¨ stmt å¥æŸ„çš„æŒ‡ä»¤ï¼‰ å¦‚æœæŒ‡ä»¤èƒ½æŸ¥è¯¢åˆ°ä¸‹ä¸€è¡Œæ•°æ®ï¼Œå°±ä¼šè¿”å›SQLITE_ROW å¦‚æœæŒ‡ä»¤ï¼ˆä¾‹å¦‚å†™å…¥æ•°æ®ï¼‰ä¸éœ€è¦è¿”è¿˜æ•°æ®ï¼Œå°±ä¼šè¿”è¿˜SQLITE_DONE å‚æ•°ï¼šstmt å¥æŸ„ sqlite3_execç›´æ¥ç¼–è¯‘å¹¶æ‰§è¡Œ SQL è¯­å¥ ç‰¹ç‚¹ï¼š1ã€æ²¡æœ‰SQLè¯­æ³•æ£€æŸ¥ 2ã€æ¯ä¸€å¥SQLè¯­å¥å³ä½¿å®Œå…¨ä¸€æ ·ï¼Œä¹Ÿä¼šé‡æ–°ç¼–è¯‘æ‰§è¡Œï¼Œå¯¹æ‰¹é‡æŒ‡ä»¤æ¥è¯´æ•ˆç‡ä¸é«˜ã€‚ å‚æ•°1:ä¸€ä¸ªæ‰“å¼€çš„æ•°æ®åº“å®ä¾‹ å‚æ•°2:éœ€è¦æ‰§è¡Œçš„SQLè¯­å¥ å‚æ•°3:SQLè¯­å¥æ‰§è¡Œå®Œæ¯•åçš„å›è°ƒ å‚æ•°4:å›è°ƒå‡½æ•°çš„ç¬¬1ä¸ªå‚æ•° å‚æ•°5:é”™è¯¯ä¿¡æ¯ sqlite3_finalizeæ¸…ç†è¯­å¥å¥æŸ„(ä»¥ä¾¿é‡å¤ä½¿ç”¨åŒä¸€ä¸ª stmt å¥æŸ„) å‚æ•°ï¼šstmt å¥æŸ„ sqlite3_closeå…³é—­æ•°æ®åº“è¿æ¥ å‚æ•°ï¼šæ•°æ®åº“å®ä¾‹ sqlite3_resetå°†å·²ç¼–è¯‘çš„SQLè¯­å¥æ¢å¤åˆ°åˆå§‹çŠ¶æ€ï¼Œä¿ç•™è¯­å¥ç›¸å…³çš„èµ„æºï¼Œé‡ç½®åå¯é‡æ–°ç»‘å®šæ•°æ® å‚æ•°ï¼šstmt å¥æŸ„ 1.3 SQLite å¤šçº¿ç¨‹SQLite å¤šçº¿ç¨‹æ“ä½œçš„ç‰¹ç‚¹ä¸ºä¿è¯çº¿ç¨‹å®‰å…¨ï¼ŒSQLite æ•°æ®åº“åªèƒ½å¹¶å‘è¯»ï¼Œä¸èƒ½å¹¶å‘å†™ã€‚ SQLite å¤šçº¿ç¨‹æ“ä½œçš„æ­£ç¡®æ–¹å¼ å¤šçº¿ç¨‹è¯»å†™ï¼Œä½¿ç”¨åŒä¸€ä¸ªæ•°æ®åº“ã€‚ã€é‡‡ç”¨ã€‘ è¿™ç§æƒ…å†µä¸‹ç”±äºä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªæ•°æ®åº“è¿æ¥ï¼ŒSQLite å†…éƒ¨æœ‰é”æœºåˆ¶ï¼Œä¸ä¼šå‡ºç°å¼‚å¸¸ã€‚è¿™ç§å¤šçº¿ç¨‹æ“ä½œå¹¶ä¸æ˜¯çœŸæ­£çš„å¹¶å‘æ“ä½œï¼Œç”±äºé”æœºåˆ¶çš„å­˜åœ¨æ‰€ä»¥ä»ç„¶æ˜¯é˜»å¡çš„ã€‚ å¤šçº¿ç¨‹è¯»ï¼Œå•çº¿ç¨‹å†™ï¼Œæ¯ä¸ªçº¿ç¨‹ä½¿ç”¨å„è‡ªç‹¬ç«‹çš„æ•°æ®åº“è¿æ¥ï¼ˆä½†æ˜¯éœ€è¦å¼€å¯walæ¨¡å¼ï¼Œä»¥å¼€å¯æ•°æ®åº“è¿æ¥æ± ï¼‰ã€‚ è¿™ç§æƒ…å†µä¸‹æ˜¯çœŸçš„å®ç°äº†å¤šçº¿ç¨‹å¹¶å‘è¯»æ“ä½œï¼Œä½†æ˜¯å†™æ“ä½œä»èƒ½åªå¯ä»¥å•çº¿ç¨‹ï¼Œå¦‚æœå¤šçº¿ç¨‹å†™(æ¯ä¸ªçº¿ç¨‹ä½¿ç”¨å„è‡ªçš„æ•°æ®åº“è¿æ¥)å°±ä¼šå‡ºç°é—®é¢˜ã€‚ ä¸¤ç§æ–¹æ¡ˆå¯¹æ¯”ï¼š ç†è®ºä¸Šå¹¶å‘æ“ä½œè¶Šå¤šï¼Œæ–¹æ¡ˆ2æ•ˆç‡è¶Šé«˜ã€‚å®é™…æµ‹è¯•ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ äºŒã€iOS ä¸­çš„ä½¿ç”¨æ–¹å¼å¯¹äºæ–¹æ¡ˆä¸€ï¼Œé‡‡ç”¨å¼‚æ­¥å‡½æ•°+ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—å»æ“ä½œåŒä¸€ä¸ªæ•°æ®åº“(å¼€å¯æ•°æ®åº“åä¸å…³é—­)ã€‚ è¿™ç§æƒ…å†µä¸‹å°±ä¼šå¼€è¾Ÿä¸€ä¸ªå­çº¿ç¨‹ï¼ŒåŒæ—¶ä¸²è¡Œçš„æ“ä½œåŒä¸€ä¸ªæ•°æ®åº“ï¼Œæ‰€ä»¥æ—¢èƒ½å¤Ÿä¸é˜»å¡ UIï¼Œåˆèƒ½å¤Ÿä¿è¯çº¿ç¨‹å®‰å…¨ã€‚ ä»£ç å°è£…ï¼š XWTrackingAnalyticsDatabase.h 123456789101112131415161718192021222324252627282930313233343536373839404142434445//// XWTrackingAnalyticsDatabase.h// XWTrackingSDK//// Created by IMO on 2021/2/20.//// å‘½ä»¤è¡ŒéªŒè¯ï¼š// 1. è¿›å…¥æ•°æ®åº“ç¼“å­˜çš„ Caches è·¯å¾„// 2. æ‰§è¡Œ sqlite3 XWTrackingAnalyticsDatabase.sqlite// 3. sqlite&gt; .tables// 4. sqlite&gt; select * from events#import &lt;Foundation/Foundation.h&gt;#import &lt;sqlite3.h&gt;NS_ASSUME_NONNULL_BEGIN@interface XWTrackingAnalyticsDatabase : NSObject@property (nonatomic, copy, readonly) NSString *filePath;@property (nonatomic) sqlite3 *database;/// æœ¬åœ°äº‹ä»¶å­˜å‚¨æ€»é‡@property (nonatomic) NSUInteger eventCount;/// åˆå§‹åŒ–æ–¹æ³•/// @param filePath æ•°æ®åº“è·¯å¾„ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™ä½¿ç”¨é»˜è®¤è·¯å¾„- (instancetype)initWithFilePath:(nullable NSString *)filePath NS_DESIGNATED_INITIALIZER;/// å‘æ•°æ®åº“ä¸­æ’å…¥äº‹ä»¶æ•°æ®/// @param event äº‹ä»¶- (void)insertEvent:(NSDictionary *)event;/// ä»æ•°æ®åº“ä¸­è·å–äº‹ä»¶æ•°æ®/// @param count è·å–äº‹ä»¶æ•°æ®çš„æ¡æ•°- (NSArray&lt;NSString *&gt; *)selectEventsForCount:(NSUInteger)count;/// ä»æ•°æ®åº“ä¸­åˆ é™¤ä¸€å®šæ•°é‡çš„äº‹ä»¶æ•°æ®ï¼Œè¿”å›æ˜¯å¦åˆ é™¤æˆåŠŸ/// @param count åˆ é™¤äº‹ä»¶æ•°æ®çš„æ¡æ•°- (BOOL)deleteEventsForCount:(NSUInteger)count;@endNS_ASSUME_NONNULL_END XWTrackingAnalyticsDatabase.m 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164#import &quot;XWTrackingAnalyticsDatabase.h&quot;static NSString * const XWTrackingAnalyticsDatabaseName = @&quot;XWTrackingAnalyticsDatabase.sqlite&quot;;@interface XWTrackingAnalyticsDatabase ()@property (nonatomic, strong) dispatch_queue_t queue;@end@implementation XWTrackingAnalyticsDatabase- (instancetype)init { return [self initWithFilePath:nil];}- (instancetype)initWithFilePath:(NSString *)filePath { self = [super init]; if (self) { _filePath = filePath ? : [NSSearchPathForDirectoriesInDomains(NSCachesDirectory, NSUserDomainMask, YES).lastObject stringByAppendingPathComponent:XWTrackingAnalyticsDatabaseName]; NSLog(@&quot;æ•°æ®åº“è·¯å¾„æ˜¯ï¼š%@&quot;, _filePath); // åˆå§‹åŒ–é˜Ÿåˆ—çš„å”¯ä¸€æ ‡è¯† NSString *label = [NSString stringWithFormat:@&quot;cn.imo.serialQueue.%p&quot;, self]; // åˆ›å»ºä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ— _queue = dispatch_queue_create(label.UTF8String, DISPATCH_QUEUE_SERIAL); [self open]; [self queryLocalDatabaseEventCount]; } return self;}- (void)open { dispatch_async(self.queue, ^{ // åˆå§‹åŒ– SQLite åº“ if (sqlite3_open_v2(self.filePath.UTF8String, &amp;(self-&gt;_database), SQLITE_OPEN_READWRITE | SQLITE_OPEN_CREATE, NULL) != SQLITE_OK) { return NSLog(@&quot;SQLite stmt prepare error:%s&quot;, sqlite3_errmsg(self.database)); } char *error; // åˆ›å»ºæ•°æ®åº“è¡¨çš„ SQL è¯­å¥ NSString *sql = @&quot;CREATE TABLE IF NOT EXISTS events (id INTEGER PRIMARY KEY AUTOINCREMENT, event BLOB);&quot;; // è¿è¡Œåˆ›å»ºè¡¨æ ¼çš„ SQL è¯­å¥ if (sqlite3_exec(self.database, sql.UTF8String, NULL, NULL, &amp;error) != SQLITE_OK) { return NSLog(@&quot;Create events Failure %s&quot;, error); } });}static sqlite3_stmt *insertStmt = NULL;- (void)insertEvent:(NSDictionary *)event { dispatch_async(self.queue, ^{ if (insertStmt) { // é‡ç½®æ’å…¥è¯­å¥ï¼Œé‡ç½®åå¯é‡æ–°ç»‘å®šæ•°æ® sqlite3_reset(insertStmt); } else { // æ’å…¥è¯­å¥ NSString *sql = @&quot;INSERT INTO events (event) values(?)&quot;; // å‡†å¤‡æ‰§è¡Œ SQL è¯­å¥ï¼Œè·å– sqlite3_stmt if (sqlite3_prepare_v2(self.database, sql.UTF8String, -1, &amp;insertStmt, NULL) != SQLITE_OK) { // å‡†å¤‡æ‰§è¡Œ SQL è¯­å¥å¤±è´¥ï¼Œæ‰“å° log è¿”å›å¤±è´¥ (NO) return NSLog(@&quot;SQlite stmt prepare error:%s&quot;, sqlite3_errmsg(self.database)); } } NSError *error = nil; // å°† event è½¬æ¢æˆ JSON æ•°æ® NSData *data = [NSJSONSerialization dataWithJSONObject:event options:NSJSONWritingPrettyPrinted error:&amp;error]; if (error) { // event è½¬æ¢å¤±è´¥ return NSLog(@&quot;JSON Serialization error:%@&quot;, error); } // å°† JSON æ•°æ®ä¸ stmt ç»‘å®š sqlite3_bind_blob(insertStmt, 1, data.bytes, (int)data.length, SQLITE_TRANSIENT); // æ‰§è¡Œ stmt if (sqlite3_step(insertStmt) != SQLITE_DONE) { // æ‰§è¡Œå¤±è´¥ return NSLog(@&quot;Insert event into events error&quot;); } // æ•°æ®æ’å…¥æˆåŠŸï¼Œäº‹ä»¶æ•°é‡åŠ ä¸€ self.eventCount++; });}// æœ€åä¸€æ¬¡æŸ¥è¯¢çš„äº‹ä»¶æ•°é‡static NSUInteger lastSelectEventCount = 50;static sqlite3_stmt *selectStmt = NULL;- (NSArray&lt;NSString *&gt; *)selectEventsForCount:(NSUInteger)count { NSMutableArray&lt;NSString *&gt; *events = [NSMutableArray arrayWithCapacity:count]; // è¿™é‡Œéœ€è¦ä½¿ç”¨åŒæ­¥å‡½æ•°ï¼Œå¦åˆ™ä¼šå¯¼è‡´è¿”å›çš„äº‹ä»¶ä¸å®Œæ•´ dispatch_sync(self.queue, ^{ if (self.eventCount == 0) { return; } if (count != lastSelectEventCount) { lastSelectEventCount = count; selectStmt = NULL; } if (selectStmt) { // é‡ç½®æŸ¥è¯¢è¯­å¥ï¼Œé‡ç½®ä¹‹åå¯ä»¥é‡æ–°æŸ¥è¯¢æ•°æ® sqlite3_reset(selectStmt); } else { // æŸ¥è¯¢è¯­å¥ï¼ˆæŒ‰ id å‡åºæ’ï¼‰ NSString *sql = [NSString stringWithFormat:@&quot;SELECT id, event FROM events ORDER BY id ASC LIMIT %lu&quot;, (unsigned long)count]; // å‡†å¤‡æ‰§è¡Œ SQL è¯­å¥ï¼Œè·å– sqlite3_stmt if (sqlite3_prepare_v2(self.database, sql.UTF8String, -1, &amp;selectStmt, NULL) != SQLITE_OK) { return NSLog(@&quot;SQLite stmt prepare error:%s&quot;, sqlite3_errmsg(self.database)); } } // æ‰§è¡Œ SQL è¯­å¥ while (sqlite3_step(selectStmt) == SQLITE_ROW) { // å°†æŸ¥è¯¢åˆ°çš„è¿™æ¡æ•°æ®è½¬æ¢æˆ NSData å¯¹è±¡ NSData *data = [[NSData alloc] initWithBytes:sqlite3_column_blob(selectStmt, 1) length:sqlite3_column_bytes(selectStmt, 1)]; // å°†æŸ¥è¯¢åˆ°çš„äº‹ä»¶æ•°æ®è½¬æ¢æˆ JSON å­—ç¬¦ä¸² NSString *jsonString = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];#if DEBUG NSLog(@&quot;%@&quot;, jsonString);#endif // å°† JSON å­—ç¬¦ä¸²æ·»åŠ åˆ°æ•°ç»„ä¸­ [events addObject:jsonString]; } }); return events;}- (BOOL)deleteEventsForCount:(NSUInteger)count { __block BOOL success = YES; dispatch_sync(self.queue, ^{ if (self.eventCount == 0) { return; } // åˆ é™¤è¯­å¥ NSString *sql = [NSString stringWithFormat:@&quot;DELETE FROM events WHERE id IN (SELECT id FROM events ORDER BY id ASC LIMIT %lu);&quot;, (unsigned long)count]; char *errmsg; // æ‰§è¡Œåˆ é™¤è¯­å¥ if (sqlite3_exec(self.database, sql.UTF8String, NULL, NULL, &amp;errmsg) != SQLITE_OK) { success = NO; return NSLog(@&quot;Failed to delete record msg=%s&quot;, errmsg); } self.eventCount = self.eventCount &lt; count ? 0 : self.eventCount - count; }); return success;}// æŸ¥è¯¢æ•°æ®åº“ä¸­å·²ç¼“å­˜çš„äº‹ä»¶æ¡æ•°- (void)queryLocalDatabaseEventCount { dispatch_async(self.queue, ^{ // æŸ¥è¯¢è¯­å¥ NSString *sql = @&quot;SELECT count(*) FROM events;&quot;; sqlite3_stmt *stmt = NULL; // å‡†å¤‡æ‰§è¡Œ SQL è¯­å¥ï¼Œè·å– sqlite3_stmt if (sqlite3_prepare_v2(self.database, sql.UTF8String, -1, &amp;stmt, NULL) != SQLITE_OK) { return NSLog(@&quot;SQLite stmt prepare error:%s&quot;, sqlite3_errmsg(self.database)); } while (sqlite3_step(stmt) == SQLITE_ROW) { self.eventCount = sqlite3_column_int(stmt, 0); } });}@end å‚è€ƒSQLiteå¤šçº¿ç¨‹å¹¶å‘æ“ä½œ SQLiteä½¿ç”¨(ä¸‰)&amp;&amp;æ ¸å¿ƒAPIä½¿ç”¨","link":"/2021/02/25/iOS%C2%B7%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/iOS+SQLite/"},{"title":"02-isaåŸç†","text":"ä¸€ã€ å‰è¨€ åœ¨arm64æ¶æ„ä¹‹å‰ï¼Œisaä»…ä»…æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œä¿å­˜ç€ç±»å¯¹è±¡æˆ–å…ƒç±»å¯¹è±¡çš„å†…å­˜åœ°å€ åœ¨arm64æ¶æ„ä¹‹å,è‹¹æœå¯¹isaè¿›è¡Œäº†ä¼˜åŒ–,å˜æˆäº†ä¸€ä¸ªisa_tç±»å‹çš„è”åˆä½“ç»“æ„,åŒæ—¶ä½¿ç”¨ä½åŸŸæ¥å­˜å‚¨æ›´å¤šçš„ä¿¡æ¯: å¯¹è±¡çš„isaæŒ‡é’ˆå¹¶ä¸æ˜¯ç›´æ¥æŒ‡å‘ç±»å¯¹è±¡æˆ–è€…å…ƒç±»å¯¹è±¡çš„å†…å­˜åœ°å€ï¼Œè€Œæ˜¯éœ€è¦&amp; ISA_MASKæ‰èƒ½è·å–ç±»å¯¹è±¡æˆ–è€…å…ƒç±»å¯¹è±¡çš„åœ°å€ã€‚ äºŒã€ å†…å®¹è¡¥å……2.1 ä½è¿ç®—ç¬¦ ä½è¿ç®—ç¬¦ç”¨æ¥å¯¹äºŒè¿›åˆ¶ä½è¿›è¡Œæ“ä½œ æ“ä½œæ•°åªèƒ½ä¸ºæ•´å‹å’Œå­—ç¬¦å‹æ•°æ®ã€‚ Cè¯­è¨€ä¸­å…­ç§ä½è¿ç®—ç¬¦ï¼š&amp;æŒ‰ä½ä¸ã€|æŒ‰ä½æˆ–ã€^æŒ‰ä½å¼‚æˆ–ã€~éã€&lt;&lt;å·¦ç§»å’Œ&gt;&gt;å³ç§»ã€‚ 1)æŒ‰ä½ä¸&amp; æœ‰0å‡º0,å…¨1å‡º1. A B &amp; 0 0 0 1 0 0 0 1 0 1 1 1 2)æŒ‰ä½æˆ– | æœ‰1å‡º1,å…¨0å‡º0. A B I 0 0 0 1 0 1 0 1 1 1 1 1 3)æŒ‰ä½å¼‚æˆ–^ ç›¸åŒä¸º0,ä¸åŒä¸º1. A B ^ 0 0 0 1 0 1 0 1 1 1 1 0 4)é ~ éè¿ç®—å³å–åè¿ç®—ï¼Œåœ¨äºŒè¿›åˆ¶ä¸­ 1 å˜ 0 ï¼Œ0 å˜ 1ã€‚ä¾‹å¦‚110101è¿›è¡Œéè¿ç®—åä¸º001010ï¼Œå³1010. 5)å·¦ç§» &lt;&lt; å·¦ç§»è¿ç®—å°±æ˜¯æŠŠ&lt;&lt;å·¦è¾¹çš„è¿ç®—æ•°çš„å„äºŒè¿›ä½å…¨éƒ¨å·¦ç§»è‹¥å¹²ä½ï¼Œç§»åŠ¨çš„ä½æ•°å³&lt;&lt;å³è¾¹çš„æ•°çš„æ•°å€¼ã€‚ é«˜ä½ä¸¢å¼ƒï¼Œä½ä½è¡¥0ã€‚ å·¦ç§»nä½å°±æ˜¯ä¹˜ä»¥2çš„næ¬¡æ–¹ã€‚ä¾‹å¦‚ï¼ša&lt;&lt;4æ˜¯æŒ‡æŠŠaçš„å„äºŒè¿›ä½å‘å·¦ç§»åŠ¨4ä½ã€‚å¦‚åŸæ¥a=00000011(åè¿›åˆ¶3)ï¼Œå·¦ç§»4ä½åä¸º00110000(åè¿›åˆ¶48)ã€‚ 6)å³ç§» &gt;&gt; å³ç§»è¿ç®—å°±æ˜¯æŠŠ&gt;&gt;å·¦è¾¹çš„è¿ç®—æ•°çš„å„äºŒè¿›ä½å…¨éƒ¨å³ç§»è‹¥å¹²ä½ï¼Œ&gt;&gt;å³è¾¹çš„æ•°æŒ‡å®šç§»åŠ¨çš„ä½æ•°ã€‚ä¾‹å¦‚ï¼šè®¾ a=15ï¼Œa&gt;&gt;2 è¡¨ç¤ºæŠŠ00001111å³ç§»ä¸º00000011(åè¿›åˆ¶3) 2.2 ä½è¿ç®—ç¬¦çš„è¿ç”¨1)å–å€¼ å¯ä»¥åˆ©ç”¨æŒ‰ä½ä¸ &amp;è¿ç®—å–å‡ºæŒ‡å®šä½çš„å€¼ å…·ä½“æ“ä½œæ˜¯æƒ³å–å‡ºå“ªä¸€ä½çš„å€¼å°±å°†é‚£ä¸€ä½ç½®ä¸º1,å…¶å®ƒä½éƒ½ä¸º0,ç„¶ååŒåŸæ•°æ®è¿›è¡ŒæŒ‰ä½ä¸è®¡ç®—,å³å¯å–å‡ºç‰¹å®šçš„ä½. ä¾‹: 0000 0011å–å‡ºå€’æ•°ç¬¬ä¸‰ä½çš„å€¼ 123456// æƒ³å–å‡ºå€’æ•°ç¬¬ä¸‰ä½çš„å€¼ï¼Œå°±å°†å€’æ•°ç¬¬ä¸‰ä½çš„å€¼ç½®ä¸º1ï¼Œå…¶å®ƒä½ä¸º0ï¼Œè·ŸåŸæ•°æ®æŒ‰ä½ä¸è¿ç®— 0000 0011 (æºç )&amp; 0000 0100 ï¼ˆæ©ç ï¼‰------------ 0000 0000 // å¾—å‡ºæŒ‰ä½ä¸è¿ç®—åçš„ç»“æœï¼Œå³å¯æ‹¿åˆ°åŸæ•°æ®ä¸­å€’æ•°ç¬¬ä¸‰ä½çš„å€¼ä¸º0 ä¸Šé¢çš„ä¾‹å­ä¸­,æˆ‘ä»¬ä»0000 0011ä¸­å–å€¼,åˆ™æœ‰0000 0011è¢«ç§°ä¹‹ä¸ºæºç .è¿›è¡ŒæŒ‰ä½ä¸æ“ä½œè®¾å®šçš„0000 0100ç§°ä¹‹ä¸ºæ©ç . ä¾‹: 0000 0011å–å‡ºåä¸‰ä½çš„å€¼ 123456// æƒ³å–å‡ºåä¸‰ä½çš„å€¼ï¼Œå°±å°†æ©ç åä¸‰ä½ç½®ä¸º1ï¼Œå…¶å®ƒä½ä¸º0ï¼Œè·ŸåŸæ•°æ®æŒ‰ä½ä¸è¿ç®— 0000 0011 (æºç )&amp; 0000 0111 ï¼ˆæ©ç ï¼‰------------ 0000 0011 // å¾—å‡ºæŒ‰ä½ä¸è¿ç®—åçš„ç»“æœï¼Œå³å¯æ‹¿åˆ°åŸæ•°æ®ä¸­åä¸‰ä½çš„å€¼ä¸º011 2)è®¾å€¼ å¯ä»¥é€šè¿‡æŒ‰ä½æˆ– |æˆ–è€…æŒ‰ä½ä¸ &amp;è¿ç®—ç¬¦å°†æŸä¸€ä½çš„å€¼è®¾ä¸º1æˆ–0. è¦å°†æŸä¸€ä½çš„å€¼ç½®ä¸º1çš„è¯ï¼Œé‚£ä¹ˆå°±å°†æ©ç ä¸­å¯¹åº”ä½çš„å€¼è®¾ä¸º1ï¼Œæ©ç å…¶å®ƒä½ä¸º0ï¼Œå°†æºç ä¸æ©ç è¿›è¡ŒæŒ‰ä½æˆ–|æ“ä½œå³å¯. ä¾‹: å°†0000 0011å€’æ•°ç¬¬ä¸‰ä½çš„å€¼æ”¹ä¸º1 12345// æ”¹å˜å€’æ•°ç¬¬ä¸‰ä½çš„å€¼ï¼Œå°±å°†æ©ç å€’æ•°ç¬¬ä¸‰ä½çš„å€¼ç½®ä¸º1ï¼Œå…¶å®ƒä½ä¸º0ï¼Œè·Ÿæºç æŒ‰ä½æˆ–è¿ç®— 0000 0011| 0000 0100------------ 0000 0111 // å³å¯å°†æºç ä¸­å€’æ•°ç¬¬ä¸‰ä½çš„å€¼æ”¹ä¸º1 è¦å°†æŸä¸€ä½çš„å€¼ç½®ä¸º0çš„è¯ï¼Œé‚£ä¹ˆå°±å°†æ©ç ä¸­å¯¹åº”ä½çš„å€¼è®¾ä¸º0ï¼Œæ©ç å…¶å®ƒä½ä¸º1ï¼Œå°†æºç ä¸æ©ç è¿›è¡ŒæŒ‰ä½ä¸&amp;æ“ä½œå³å¯. ä¾‹: å°†0000 0011å€’æ•°ç¬¬äºŒä½çš„å€¼æ”¹ä¸º0 12345// æ”¹å˜å€’æ•°ç¬¬äºŒä½çš„å€¼ï¼Œå°±å°†æ©ç å€’æ•°ç¬¬äºŒä½çš„å€¼ç½®ä¸º0ï¼Œå…¶å®ƒä½ä¸º1ï¼Œè·Ÿæºç `æŒ‰ä½ä¸&amp;`è¿ç®— 0000 0011| 1111 1101------------ 0000 0001 // å³å¯å°†æºç ä¸­å€’æ•°ç¬¬äºŒä½çš„å€¼æ”¹ä¸º0 3)å®é™…åº”ç”¨ å£°æ˜ä¸€ä¸ªTCJCarç±»ï¼Œç±»ä¸­æœ‰å››ä¸ªBOOLç±»å‹çš„å±æ€§,åˆ†åˆ«ä¸ºfrontã€backã€leftã€right,é€šè¿‡è¿™å››ä¸ªå±æ€§æ¥åˆ¤æ–­è¿™è¾†å°è½¦çš„è¡Œé©¶æ–¹å‘. ç„¶åæˆ‘ä»¬æ¥æŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ªTCJCarç±»å¯¹è±¡æ‰€å æ®çš„å†…å­˜å¤§å°: æˆ‘ä»¬çœ‹åˆ°,ä¸€ä¸ªTCJCarç±»çš„å¯¹è±¡å æ®16ä¸ªå­—èŠ‚.å…¶ä¸­åŒ…æ‹¬ä¸€ä¸ªisaæŒ‡é’ˆå’Œå››ä¸ªBOOLç±»å‹çš„å±æ€§,8+1+1+1+1=12,æ ¹æ®å†…å­˜å¯¹é½åŸåˆ™,æ‰€ä»¥ä¸€ä¸ªTCJCarç±»çš„å¯¹è±¡å 16ä¸ªå­—èŠ‚. æˆ‘ä»¬çŸ¥é“,BOOLå€¼åªæœ‰ä¸¤ç§æƒ…å†µ:0æˆ–1ï¼Œå æ®ä¸€ä¸ªå­—èŠ‚çš„å†…å­˜ç©ºé—´.è€Œä¸€ä¸ªå­—èŠ‚çš„å†…å­˜ç©ºé—´ä¸­åˆæœ‰8ä¸ªäºŒè¿›åˆ¶ä½ï¼Œå¹¶ä¸”äºŒè¿›åˆ¶åŒæ ·åªæœ‰0æˆ–1ï¼Œé‚£ä¹ˆæˆ‘ä»¬å®Œå…¨å¯ä»¥ä½¿ç”¨1ä¸ªäºŒè¿›åˆ¶ä½æ¥è¡¨ç¤ºä¸€ä¸ªBOOLå€¼ã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¸Šé¢å£°æ˜çš„å››ä¸ªBOOLå€¼æœ€ç»ˆåªä½¿ç”¨4ä¸ªäºŒè¿›åˆ¶ä½å°±å¯ä»¥ä»£æ›¿ï¼Œè¿™æ ·å°±èŠ‚çœäº†å†…å­˜ç©ºé—´ã€‚é‚£æˆ‘ä»¬å¦‚ä½•å®ç°å‘¢ï¼Ÿ æƒ³è¦å®ç°å››ä¸ªBOOLå€¼å­˜æ”¾åœ¨ä¸€ä¸ªå­—èŠ‚ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡charç±»å‹çš„æˆå‘˜å˜é‡æ¥å®ç°ã€‚ charç±»å‹å ä¸€ä¸ªå­—èŠ‚å†…å­˜ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯8ä¸ªäºŒè¿›åˆ¶ä½.å¯ä»¥ä½¿ç”¨å…¶ä¸­æœ€åå››ä¸ªäºŒè¿›åˆ¶ä½æ¥å­˜å‚¨4ä¸ªBOOLå€¼ã€‚ (å½“ç„¶ä¸èƒ½æŠŠcharç±»å‹å†™æˆå±æ€§,å› ä¸ºä¸€æ—¦å†™æˆå±æ€§,ç³»ç»Ÿä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬æ·»åŠ æˆå‘˜å˜é‡,è‡ªåŠ¨å®ç°setå’Œgetæ–¹æ³•) 123@interface TCJCar(){ char _frontBackLeftRight;} å¦‚æœæˆ‘ä»¬èµ‹å€¼_frontBackLeftRightä¸º1,å³0b 0000 0001,åªä½¿ç”¨8ä¸ªäºŒè¿›åˆ¶ä½ä¸­çš„æœ€å4ä¸ªåˆ†åˆ«ç”¨0æˆ–è€…1æ¥ä»£è¡¨frontã€backã€leftã€rightçš„å€¼.é‚£ä¹ˆæ­¤æ—¶frontã€backã€leftã€rightçš„çŠ¶æ€ä¸º: ç»“åˆæˆ‘ä»¬ä¸Šæ–‡è®²çš„6ç§ä½è¿ç®—ç¬¦ä»¥åŠä½¿ç”¨åœºæ™¯,æˆ‘ä»¬å¯ä»¥åˆ†åˆ«å£°æ˜frontã€backã€leftã€rightçš„æ©ç ,æ¥æ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œä¸‹ä¸€æ­¥çš„ä½è¿ç®—å–å€¼å’Œèµ‹å€¼: 1234#define TCJDirectionFrontMask 0b00001000 //æ­¤äºŒè¿›åˆ¶æ•°å¯¹åº”åè¿›åˆ¶æ•°ä¸º 8#define TCJDirectionBackMask 0b00000100 //æ­¤äºŒè¿›åˆ¶æ•°å¯¹åº”åè¿›åˆ¶æ•°ä¸º 4#define TCJDirectionLeftMask 0b00000010 //æ­¤äºŒè¿›åˆ¶æ•°å¯¹åº”åè¿›åˆ¶æ•°ä¸º 2#define TCJDirectionRightMask 0b00000001 //æ­¤äºŒè¿›åˆ¶æ•°å¯¹åº”åè¿›åˆ¶æ•°ä¸º 1 é€šè¿‡å¯¹ä½è¿ç®—ç¬¦çš„å·¦ç§»&lt;&lt;å’Œå³ç§»&gt;&gt;çš„äº†è§£ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸Šé¢çš„ä»£ç ä¼˜åŒ–æˆï¼š 1234#define TCJDirectionFrontMask (1 &lt;&lt; 3)#define TCJDirectionBackMask (1 &lt;&lt; 2)#define TCJDirectionLeftMask (1 &lt;&lt; 1)#define TCJDirectionRightMask (1 &lt;&lt; 0) è‡ªå®šä¹‰çš„setæ–¹æ³•å¦‚ä¸‹: 1234567891011121314151617181920212223242526272829303132- (void)setFront:(BOOL)front{ if (front) {// å¦‚æœéœ€è¦å°†å€¼ç½®ä¸º1ï¼Œå°†æºç å’Œæ©ç è¿›è¡ŒæŒ‰ä½æˆ–è¿ç®— _frontBackLeftRight |= TCJDirectionFrontMask; } else {// å¦‚æœéœ€è¦å°†å€¼ç½®ä¸º0 // å°†æºç å’ŒæŒ‰ä½å–ååçš„æ©ç è¿›è¡ŒæŒ‰ä½ä¸è¿ç®— _frontBackLeftRight &amp;= ~TCJDirectionFrontMask; }}- (void)setBack:(BOOL)back{ if (back) { _frontBackLeftRight |= TCJDirectionBackMask; } else { _frontBackLeftRight &amp;= ~TCJDirectionBackMask; }}- (void)setLeft:(BOOL)left{ if (left) { _frontBackLeftRight |= TCJDirectionLeftMask; } else { _frontBackLeftRight &amp;= ~TCJDirectionLeftMask; }}- (void)setRight:(BOOL)right{ if (right) { _frontBackLeftRight |= TCJDirectionRightMask; } else { _frontBackLeftRight &amp;= ~TCJDirectionRightMask; }} è‡ªå®šä¹‰çš„getæ–¹æ³•å¦‚ä¸‹: 12345678910111213141516- (BOOL)isFront{ return !!(_frontBackLeftRight &amp; TCJDirectionFrontMask);}- (BOOL)isBack{ return !!(_frontBackLeftRight &amp; TCJDirectionBackMask);}- (BOOL)isLeft{ return !!(_frontBackLeftRight &amp; TCJDirectionLeftMask);}- (BOOL)isRight{ return !!(_frontBackLeftRight &amp; TCJDirectionRightMask);} æ­¤å¤„éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä»£ç ä¸­!ä¸ºé€»è¾‘è¿ç®—ç¬¦éï¼Œå› ä¸º_frontBackLeftRight &amp; TCJDirectionFrontMaskä»£ç æ‰§è¡Œåï¼Œè¿”å›çš„è‚¯å®šæ˜¯ä¸€ä¸ªæ•´å‹æ•°ï¼Œå¦‚å½“frontä¸ºYESæ—¶ï¼Œè¯´æ˜äºŒè¿›åˆ¶æ•°ä¸º0b 0000 1000ï¼Œå¯¹åº”çš„åè¿›åˆ¶æ•°ä¸º8ï¼Œé‚£ä¹ˆè¿›è¡Œä¸€æ¬¡é€»è¾‘éè¿ç®—åï¼Œ!(8)çš„å€¼ä¸º0ï¼Œå¯¹0å†è¿›è¡Œä¸€æ¬¡é€»è¾‘éè¿ç®—!(0)ï¼Œç»“æœå°±æˆäº†1ï¼Œé‚£ä¹ˆæ­£å¥½è·Ÿfrontä¸ºYESå¯¹åº”.æ‰€ä»¥æ­¤å¤„è¿›è¡Œä¸¤æ¬¡é€»è¾‘éè¿ç®—ï¼Œ!!. å½“ç„¶,è¿˜è¦å®ç°åˆå§‹åŒ–æ–¹æ³•: 12345678- (instancetype)init{ self = [super init]; if (self) { _frontBackLeftRight = 0b00001000; } return self;} é€šè¿‡æµ‹è¯•éªŒè¯,æˆ‘ä»¬å®Œæˆäº†å–å€¼å’Œèµ‹å€¼: 2.3 ä½åŸŸæœ‰äº›ä¿¡æ¯åœ¨å­˜å‚¨æ—¶ï¼Œå¹¶ä¸éœ€è¦å ç”¨ä¸€ä¸ªå®Œæ•´çš„å­—èŠ‚(8ä¸ªäºŒè¿›åˆ¶ä½)ï¼Œ è€Œåªéœ€å å‡ ä¸ªæˆ–ä¸€ä¸ªäºŒè¿›åˆ¶ä½ã€‚â€œä½åŸŸâ€æ˜¯æŠŠä¸€ä¸ªå­—èŠ‚ä¸­çš„äºŒè¿›ä½åˆ’åˆ†ä¸ºå‡ ä¸ªä¸åŒçš„åŒºåŸŸï¼Œ å¹¶è¯´æ˜æ¯ä¸ªåŒºåŸŸçš„ä½æ•°ã€‚æ¯ä¸ªåŒºåŸŸå°±å¯ä»¥å­˜å‚¨ä¸€æ®µä¿¡æ¯ï¼Œè¿™æ ·å°±å¯ä»¥æŠŠä¿¡æ¯ç”¨ä¸€ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºã€‚ 2.4 è”åˆä½“è¿™é‡Œé€šè¿‡ä¸structçš„å¯¹æ¯”æ¥ç†è§£union: â‘ ä¸¤è€…éƒ½å¯ä»¥åŒ…å«å¤šä¸ªä¸åŒç±»å‹çš„æ•°æ®ï¼Œå¦‚intã€doubleã€Classç­‰ã€‚ â‘¡åœ¨structä¸­å„æˆå‘˜æœ‰å„è‡ªçš„å†…å­˜ç©ºé—´ï¼Œä¸€ä¸ªstructå˜é‡çš„å†…å­˜æ€»é•¿åº¦å¤§äºç­‰äºå„æˆå‘˜å†…å­˜é•¿åº¦ä¹‹å’Œï¼›è€Œåœ¨unionä¸­ï¼Œå„æˆå‘˜å…±äº«ä¸€æ®µå†…å­˜ç©ºé—´ï¼Œä¸€ä¸ªunionçš„å†…å­˜æ€»é•¿åº¦ç­‰äºå„æˆå‘˜ä¸­å†…å­˜æœ€é•¿çš„é‚£ä¸ªæˆå‘˜çš„å†…å­˜é•¿åº¦ã€‚ â‘¢å¯¹structä¸­çš„æˆå‘˜è¿›è¡Œèµ‹å€¼ï¼Œä¸ä¼šå½±å“å…¶ä»–æˆå‘˜çš„å€¼ï¼›å¯¹unionä¸­çš„æˆå‘˜èµ‹å€¼æ—¶ï¼Œæ¯æ¬¡åªèƒ½ç»™ä¸€ä¸ªæˆå‘˜èµ‹å€¼ï¼ŒåŒæ—¶å…¶å®ƒæˆå‘˜çš„å€¼ä¹Ÿå°±ä¸å­˜åœ¨äº†ã€‚ å†™æ³•ï¼š 123union è”åˆä½“å{ æˆå‘˜åˆ—è¡¨} 2.5 oc ä¸­çš„ GDB è°ƒè¯•2.5.1 ç®€ä»‹GDBï¼ˆGNU Debuggerï¼‰æ˜¯UNIXåŠUNIX-likeä¸‹çš„å¼ºå¤§è°ƒè¯•å·¥å…·ï¼Œå¯ä»¥è°ƒè¯•ada, c, c++, asm, minimal, d, fortran, Objective-c, go, java,pascalç­‰è¯­è¨€ã€‚ 2.5.2 åœ¨ iOS å¼€å‘ä¸­çš„ä½œç”¨â‘  æ™®é€šå˜é‡æŸ¥çœ‹ ä½¿ç”¨ p å˜é‡åå³å¯ï¼š 12(gdb) p a$1 = 10 â‘¡ æ‰“å°æŒ‡é’ˆæŒ‡å‘å†…å®¹ å¦‚æœè¿˜æ˜¯ä½¿ç”¨ä¸Šé¢çš„æ–¹å¼æ‰“å°æŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ï¼Œé‚£ä¹ˆæ‰“å°å‡ºæ¥çš„åªæ˜¯æŒ‡é’ˆåœ°å€è€Œå·²ï¼Œä¾‹å¦‚ï¼š 12(gdb) p d$1 = (int *) 0x602010 è€Œå¦‚æœæƒ³è¦æ‰“å°æŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ï¼Œéœ€è¦è§£å¼•ç”¨ï¼š 12(gdb) p *d$2 = 0 â‘¢ æŒ‰ç…§ç‰¹å®šæ ¼å¼æ‰“å°å˜é‡ å¯¹äºç®€å•çš„æ•°æ®ï¼Œpé»˜è®¤çš„æ‰“å°æ–¹å¼å·²ç»è¶³å¤Ÿäº†ï¼Œå®ƒä¼šæ ¹æ®å˜é‡ç±»å‹çš„æ ¼å¼æ‰“å°å‡ºæ¥ï¼Œä½†æ˜¯æœ‰æ—¶å€™è¿™è¿˜ä¸å¤Ÿï¼Œæˆ‘ä»¬éœ€è¦æ›´å¤šçš„æ ¼å¼æ§åˆ¶ã€‚ä½¿ç”¨æ ¼å¼æ§åˆ¶å­—ç¬¦æ¥æ§åˆ¶ æ­£å¸¸æ–¹å¼æ‰“å°å­—ç¬¦æ•°ç»„cï¼š 12(gdb) p c$18 = &quot;hello world&quot; æŸ¥çœ‹å®ƒçš„åå…­è¿›åˆ¶æ ¼å¼æ‰“å°: 123(gdb) p/x c$19 = {0x68, 0x65, 0x6c, 0x6c, 0x6f, 0x2c, 0x73, 0x68, 0x6f, 0x75, 0x77, 0x61, 0x6e, 0x67, 0x0} ä½†æ˜¯å¦‚æœæˆ‘ä»¬æƒ³ç”¨è¿™ç§æ–¹å¼æŸ¥çœ‹æµ®ç‚¹æ•°çš„äºŒè¿›åˆ¶æ ¼å¼æ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºç›´æ¥æ‰“å°å®ƒé¦–å…ˆä¼šè¢«è½¬æ¢æˆæ•´å‹ï¼Œå› æ­¤æœ€ç»ˆä¼šå¾—åˆ°8ï¼š 12345(gdb) p e$1 = 8.5(gdb) p/t e$2 = 1000 â‘£ æŸ¥çœ‹å†…å­˜å†…å®¹ examine(ç®€å†™ä¸ºx)å¯ä»¥ç”¨æ¥æŸ¥çœ‹å†…å­˜åœ°å€ä¸­çš„å€¼ã€‚è¯­æ³•å¦‚ä¸‹ï¼š 1x/[n][f][u] addr å…¶ä¸­ï¼š n è¡¨ç¤ºè¦æ˜¾ç¤ºçš„å†…å­˜å•å…ƒæ•°ï¼Œé»˜è®¤å€¼ä¸º1(æƒ³æ‰“å¤šå°‘æ®µå°±å†™å‡ ) f è¡¨ç¤ºè¦æ‰“å°çš„æ ¼å¼ï¼Œé€šè¿‡æ ¼å¼æ§åˆ¶å­—ç¬¦æ§åˆ¶ u è¦æ‰“å°çš„å•å…ƒé•¿åº¦ addr å†…å­˜åœ°å€ æ ¼å¼æ§åˆ¶å­—ç¬¦ï¼š x æŒ‰åå…­è¿›åˆ¶æ ¼å¼æ˜¾ç¤ºå˜é‡ã€å¸¸ç”¨ã€‘ d æŒ‰åè¿›åˆ¶æ ¼å¼æ˜¾ç¤ºå˜é‡ u æŒ‰åå…­è¿›åˆ¶æ ¼å¼æ˜¾ç¤ºæ— ç¬¦å·æ•´å‹ o æŒ‰å…«è¿›åˆ¶æ ¼å¼æ˜¾ç¤ºå˜é‡ t æŒ‰äºŒè¿›åˆ¶æ ¼å¼æ˜¾ç¤ºå˜é‡ a æŒ‰åå…­è¿›åˆ¶æ ¼å¼æ˜¾ç¤ºå˜é‡ c æŒ‰å­—ç¬¦æ ¼å¼æ˜¾ç¤ºå˜é‡ f æŒ‰æµ®ç‚¹æ•°æ ¼å¼æ˜¾ç¤ºå˜é‡ å•å…ƒé•¿åº¦ï¼š g å…«å­—èŠ‚ã€å¸¸ç”¨ã€‘ b å­—èŠ‚ h åŠå­—ï¼Œå³åŒå­—èŠ‚ w å­—ï¼Œå³å››å­—èŠ‚ ä¸¾ä¾‹ï¼š 1234x/4xg p // æ‰“å° p çš„å†…å­˜å†…å®¹ // æ‰“4æ®µå†…å­˜å†…å®¹ // 16è¿›åˆ¶æ‰“å° // æ¯æ®µå†…å­˜å†…å®¹æ‰“å°8å­—èŠ‚ ä¸‰ã€ isa ä»‹ç»3.1 å‰è¨€å›é¡¾ä¸Šç¯‡æ–‡ç« ä¸­çš„ä»£ç : 12345678910111213141516171819202122232425262728293031323334353637383940414243444546static __attribute__((always_inline)) id_class_createInstanceFromZone(Class cls, size_t extraBytes, void *zone, bool cxxConstruct = true, size_t *outAllocatedSize = nil){ if (!cls) return nil; assert(cls-&gt;isRealized()); // ä¸€æ¬¡è¯»å–ç±»çš„ä¿¡æ¯ä½ä»¥æé«˜æ€§èƒ½ bool hasCxxCtor = cls-&gt;hasCxxCtor(); // æ˜¯å¦æœ‰æ„é€ å‡½æ•° bool hasCxxDtor = cls-&gt;hasCxxDtor(); // æ˜¯å¦æœ‰ææ„å‡½æ•° bool fast = cls-&gt;canAllocNonpointer(); // OC 2.0ä»¥ä¸ŠåŸºæœ¬ä¸Šè¿”å›çš„éƒ½æ˜¯true // è®¡ç®—å†…å­˜ size_t size = cls-&gt;instanceSize(extraBytes); if (outAllocatedSize) *outAllocatedSize = size; id obj; if (!zone &amp;&amp; fast) { // åˆ†é…1å—å¤§å°ä¸ºsizeçš„è¿ç»­å†…å­˜ obj = (id)calloc(1, size); if (!obj) return nil; // åˆå§‹åŒ–å¯¹è±¡çš„isa obj-&gt;initInstanceIsa(cls, hasCxxDtor); } else { if (zone) { obj = (id)malloc_zone_calloc ((malloc_zone_t *)zone, 1, size); } else { obj = (id)calloc(1, size); } if (!obj) return nil; // Use raw pointer isa on the assumption that they might be // doing something weird with the zone or RR. obj-&gt;initIsa(cls); } if (cxxConstruct &amp;&amp; hasCxxCtor) { obj = _objc_constructOrFree(obj, cls); } return obj;} åœ¨ä¸Šæ–‡ä¸­æˆ‘ä»¬çŸ¥é“allocåº•å±‚ä¼šè°ƒç”¨callocåˆ†é…å†…å­˜ï¼Œæ¥ç€å°±æ˜¯initInstanceIsa(cls, hasCxxDtor)ï¼Œé¡¾åæ€ä¹‰æ˜¯åˆå§‹åŒ–å¯¹è±¡çš„isaï¼Œå…¶å…³é”®ä»£ç å¦‚ä¸‹ 1234567891011121314151617181920212223242526272829303132333435363738394041inline void objc_object::initInstanceIsa(Class cls, bool hasCxxDtor){ assert(!cls-&gt;instancesRequireRawIsa()); assert(hasCxxDtor == cls-&gt;hasCxxDtor()); // ç•™æ„è¿™é‡Œçš„true initIsa(cls, true, hasCxxDtor);}inline void objc_object::initIsa(Class cls, bool nonpointer, bool hasCxxDtor) { assert(!isTaggedPointer()); if (!nonpointer) { isa.cls = cls; } else { assert(!DisableNonpointerIsa); assert(!cls-&gt;instancesRequireRawIsa()); isa_t newisa(0);#if SUPPORT_INDEXED_ISA assert(cls-&gt;classArrayIndex() &gt; 0); newisa.bits = ISA_INDEX_MAGIC_VALUE; // isa.magic is part of ISA_MAGIC_VALUE // isa.nonpointer is part of ISA_MAGIC_VALUE newisa.has_cxx_dtor = hasCxxDtor; newisa.indexcls = (uintptr_t)cls-&gt;classArrayIndex();#else newisa.bits = ISA_MAGIC_VALUE; // isa.magic is part of ISA_MAGIC_VALUE // isa.nonpointer is part of ISA_MAGIC_VALUE newisa.has_cxx_dtor = hasCxxDtor; newisa.shiftcls = (uintptr_t)cls &gt;&gt; 3;#endif isa = newisa; }} Tagged Pointer: æ®è¯´ï¼Œä¸ºäº†èŠ‚çœå†…å­˜å’Œæé«˜æ‰§è¡Œæ•ˆç‡ï¼Œè‹¹æœæå‡ºäº†Tagged Pointerçš„æ¦‚å¿µã€‚å¯¹äº 64 ä½ç¨‹åºï¼Œå¼•å…¥Tagged Pointeråï¼Œç›¸å…³é€»è¾‘èƒ½å‡å°‘ä¸€åŠçš„å†…å­˜å ç”¨ï¼Œä»¥åŠ 3å€ çš„è®¿é—®é€Ÿåº¦æå‡ï¼Œ100å€ çš„åˆ›å»ºã€é”€æ¯é€Ÿåº¦æå‡ã€‚ Tagged Pointeré¦–æ¬¡åº”ç”¨äºiPhone 5sè®¾å¤‡ä¸Šï¼Œç°åœ¨å‡ ä¹éƒ½åº”ç”¨Tagged Pointeräº†ã€‚æƒ³äº†è§£æ›´å¤šå…³äºTagged Pointerçš„å†…å®¹å¯å‚è€ƒï¼š æ·±å…¥ç†è§£ Tagged Pointerã€‚ 3.2 isa çš„ç»“æ„ç‚¹å‡»objc_object::initIsa()ä¸­çš„isaï¼Œå‘ç°isaæ˜¯isa_tç±»å‹ 123456789101112union isa_t { isa_t() { } isa_t(uintptr_t value) : bits(value) { } Class cls; uintptr_t bits;#if defined(ISA_BITFIELD) struct { ISA_BITFIELD; // ä½åŸŸ };#endif}; è€Œisa_tå®é™…ä¸Šæ˜¯ä¸€ä¸ªunionï¼Œå³è”åˆä½“ï¼Œå 8ä¸ªå­—èŠ‚ï¼Œå®ƒçš„ç‰¹æ€§å°±æ˜¯å…±ç”¨å†…å­˜ï¼Œæˆ–è€…è¯´æ˜¯äº’æ–¥ï¼Œæ¯”å¦‚è¯´å¦‚æœclsèµ‹å€¼äº†å°±ä¸åœ¨å¯¹bitsè¿›è¡Œèµ‹å€¼ã€‚ 3.2.1 isa çš„ bits æˆå‘˜å˜é‡3.2.2 isaçš„ cls æˆå‘˜å˜é‡å®ƒæ˜¯Classç±»å‹ï¼Œæºç ï¼š 12345678910111213141516171819202122typedef struct objc_class *Class;// é¡ºä¾¿äº†è§£ä¸€ä¸‹idçš„ç±»å‹ï¼Œæ˜¾ç„¶idæ˜¯ä¸ªæŒ‡é’ˆå˜é‡ï¼Œå®ƒçš„å€¼åªæœ‰ä¸€ä¸ªisaå˜é‡typedef struct objc_object *id;struct objc_class : objc_object { // Class ISA; Class superclass; cache_t cache; class_data_bits_t bits; class_rw_t *data() { return bits.data(); } ... // ä¸€äº›æ–¹æ³•};struct objc_object {private: isa_t isa; ... // ä¸€äº›å…¬æœ‰ã€ç§æœ‰æ–¹æ³•}; ä»æºç å¾—çŸ¥ï¼ŒClasså®é™…ä¸Šæ˜¯objc_classç»“æ„ä½“çš„æŒ‡é’ˆå˜é‡ï¼Œè€Œobjc_classåˆç»§æ‰¿è‡ªobjc_objectï¼ˆè¯´æ˜ç±»æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼‰ï¼Œå› æ­¤Classè¿™ä¸ªç»“æ„ä½“æŒ‡é’ˆå˜é‡çš„å€¼å†…éƒ¨æœ‰ä¸€ä¸ªisaæˆå‘˜å˜é‡ï¼ˆç±»å‹ä¸ºisa_tï¼‰ï¼Œè¿™ä¸ªisaæˆå‘˜å˜é‡åœ¨64ä½CPUæ¶æ„ä¸‹æ˜¯8å­—èŠ‚ï¼Œä¸”æ’åœ¨objc_classç»“æ„ä½“çš„å‰8å­—èŠ‚ã€‚ 3.2.3 isa çš„ä½åŸŸæŸ¥çœ‹ISA_BITFIELDï¼š æ¨¡æ‹Ÿå™¨ï¼š 12345678910111213141516# elif __x86_64__# define ISA_MASK 0x00007ffffffffff8ULL# define ISA_MAGIC_MASK 0x001f800000000001ULL# define ISA_MAGIC_VALUE 0x001d800000000001ULL# define ISA_BITFIELD \\ uintptr_t nonpointer : 1; \\ uintptr_t has_assoc : 1; \\ uintptr_t has_cxx_dtor : 1; \\ uintptr_t shiftcls : 44; /*MACH_VM_MAX_ADDRESS 0x7fffffe00000*/ \\ uintptr_t magic : 6; \\ uintptr_t weakly_referenced : 1; \\ uintptr_t deallocating : 1; \\ uintptr_t has_sidetable_rc : 1; \\ uintptr_t extra_rc : 8# define RC_ONE (1ULL&lt;&lt;56)# define RC_HALF (1ULL&lt;&lt;7) çœŸæœºï¼š 12345678910111213141516# if __arm64__# define ISA_MASK 0x0000000ffffffff8ULL# define ISA_MAGIC_MASK 0x000003f000000001ULL# define ISA_MAGIC_VALUE 0x000001a000000001ULL# define ISA_BITFIELD \\ uintptr_t nonpointer : 1; \\ uintptr_t has_assoc : 1; \\ uintptr_t has_cxx_dtor : 1; \\ uintptr_t shiftcls : 33; /*MACH_VM_MAX_ADDRESS 0x1000000000*/ \\ uintptr_t magic : 6; \\ uintptr_t weakly_referenced : 1; \\ uintptr_t deallocating : 1; \\ uintptr_t has_sidetable_rc : 1; \\ uintptr_t extra_rc : 19# define RC_ONE (1ULL&lt;&lt;45)# define RC_HALF (1ULL&lt;&lt;18) é¦–å…ˆæ˜ç¡®ä¸€ç‚¹ï¼Œåœ¨64ä½CPUæ¶æ„ä¸‹isaæŒ‡é’ˆçš„é•¿åº¦ä¹Ÿæ˜¯8å­—èŠ‚ï¼Œå®ƒå¯ä»¥å­˜å‚¨è¶³å¤Ÿå¤šçš„å†…å®¹ï¼Œè‹¹æœä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼Œå­˜å‚¨ç±»åœ°å€åªç”¨äº†ä¸€éƒ¨åˆ†ä½ï¼ˆx86_64ä¸‹æ˜¯44ä½ï¼Œarm64ä¸‹æ˜¯33ä½ï¼‰ï¼Œå‰©ä¸‹çš„ä½ç”¨æ¥å­˜å‚¨ä¸€äº›å…¶å®ƒä¿¡æ¯ã€‚ å…·ä½“åˆ†æä¸€ä¸‹ISA_BITFIELDä½åŸŸå„æˆå‘˜çš„è¡¨ç¤ºæ„ä¹‰ï¼š nonpointerï¼šè¡¨ç¤ºæ˜¯å¦å¯¹isaæŒ‡é’ˆå¼€å¯æŒ‡é’ˆä¼˜åŒ–ã€‚ 0ï¼šä¸ä¼˜åŒ–ï¼Œæ˜¯çº¯isaæŒ‡é’ˆï¼Œå½“è®¿é—®isaæŒ‡é’ˆæ—¶ï¼Œç›´æ¥è¿”å›å…¶æˆå‘˜å˜é‡cls 1ï¼šä¼˜åŒ–ï¼Œå³isa æŒ‡é’ˆå†…å®¹ä¸æ­¢æ˜¯ç±»åœ°å€ï¼Œè¿˜åŒ…å«äº†ç±»çš„ä¸€äº›ä¿¡æ¯ã€å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ç­‰ã€‚ has_assocï¼šæ˜¯å¦æœ‰å…³è”å¯¹è±¡ã€‚ has_cxx_dtorï¼šè¯¥å¯¹è±¡æ˜¯å¦æœ‰C++æˆ–Objcçš„ææ„å™¨ã€‚ å¦‚æœæœ‰ææ„å‡½æ•°ï¼Œåˆ™éœ€è¦åšä¸€äº›ææ„çš„é€»è¾‘å¤„ç†ï¼› å¦‚æœæ²¡æœ‰ï¼Œåˆ™å¯ä»¥æ›´å¿«çš„é‡Šæ”¾å¯¹è±¡ã€‚ shiftclsï¼šå­˜å‚¨ç±»åœ°å€ã€‚å¼€å¯æŒ‡é’ˆä¼˜åŒ–çš„æƒ…å†µä¸‹ï¼Œåœ¨ x86_64 æ¶æ„æœ‰ 44ä½ ç”¨æ¥å­˜å‚¨ç±»åœ°å€ï¼Œarm64 æ¶æ„ä¸­å  33ä½ ã€‚ magicï¼šç”¨äºè°ƒè¯•å™¨åˆ¤æ–­å½“å‰å¯¹è±¡æ˜¯çœŸçš„å¯¹è±¡ï¼Œè¿˜æ˜¯ä¸€æ®µæ²¡æœ‰åˆå§‹åŒ–çš„ç©ºé—´ã€‚ weakly_referencedï¼šç”¨äºæ ‡è¯†å¯¹è±¡æ˜¯å¦è¢«æŒ‡å‘æˆ–è€…æ›¾ç»è¢«æŒ‡å‘ä¸€ä¸ªARCçš„å¼±å˜é‡ï¼Œæ²¡æœ‰å¼±å¼•ç”¨çš„å¯¹è±¡é‡Šæ”¾çš„æ›´å¿«ã€‚ deallocatingï¼šæ ‡è¯†å¯¹è±¡æ˜¯å¦æ­£åœ¨é‡Šæ”¾å†…å­˜ã€‚ has_sidetable_rcï¼šå¯¹è±¡çš„å¼•ç”¨è®¡æ•°å€¼æ˜¯å¦æœ‰è¿›ä½ã€‚ extra_rcï¼šè¡¨ç¤ºè¯¥å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å€¼ã€‚ extra_rcåªæ˜¯å­˜å‚¨äº†é¢å¤–çš„å¼•ç”¨è®¡æ•°ï¼Œå®é™…çš„å¼•ç”¨è®¡æ•°å…¬å¼ï¼šå®é™…å¼•ç”¨è®¡æ•° = extra_rc + 1ã€‚è¿™é‡Œå äº†8ä½ï¼Œæ‰€ä»¥ç†è®ºä¸Šå¯ä»¥å­˜å‚¨çš„æœ€å¤§å¼•ç”¨è®¡æ•°æ˜¯ï¼š2^8 - 1 + 1 = 256ï¼ˆarm64CPUæ¶æ„ä¸‹çš„extra_rcå 19ä½ï¼Œå¯å­˜å‚¨çš„æœ€å¤§å¼•ç”¨è®¡æ•°ä¸º2^19 - 1 + 1 = 524288ï¼‰ã€‚ ä¸has_sidetable_rcçš„å…³è”ï¼šå½“å¯¹è±¡çš„æœ€å¤§å¼•ç”¨è®¡æ•°è¶…è¿‡ç•Œé™åï¼Œhas_sidetable_rcçš„å€¼ä¸º1ï¼Œå¦åˆ™ä¸º0 3.5 isaçš„ä½œç”¨ä»objc_objectçš„ç»“æ„å¯ä»¥è¯´æ˜ï¼Œå½“ç³»ç»Ÿä¸ºä¸€ä¸ªå¯¹è±¡åˆ†é…å¥½å†…å­˜ï¼Œå¹¶åˆå§‹åŒ–å®ä¾‹å˜é‡åï¼Œåœ¨è¿™äº›å¯¹è±¡çš„å®ä¾‹å˜é‡çš„ç»“æ„ä½“ä¸­çš„ç¬¬ä¸€ä¸ªå°±æ˜¯isaã€‚ åŒæ—¶ï¼Œé€šè¿‡å¯¹isaçš„ä½åŸŸè¯´æ˜ï¼Œæˆ‘ä»¬çŸ¥é“shiftclså­˜å‚¨çš„æ˜¯ç±»åœ°å€ã€‚åœ¨arm64 æ¶æ„ä¸­å  33ä½ã€‚ æˆ‘ä»¬å°†ISA_MASKçš„å€¼0x0000000ffffffff8ULLè½¬åŒ–ä¸ºäºŒè¿›åˆ¶æ•°åˆ†æä¸€ä¸‹: ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ISA_MASKçš„å€¼è½¬åŒ–ä¸ºäºŒè¿›åˆ¶åä¸­é—´æœ‰33ä½éƒ½ä¸º1ï¼Œé‚£ä¹ˆisaæŒ‡é’ˆåŒISA_MASKè¿›è¡ŒæŒ‰ä½ä¸è¿ç®—å°±å¯ä»¥å–å‡ºä¸­é—´33ä½çš„å€¼ï¼Œè¿™æ­£æ˜¯ä¸­é—´å 33ä½çš„shiftclsï¼Œæ‰€ä»¥å°±å–å‡ºäº†ç±»å¯¹è±¡å’Œå…ƒç±»å¯¹è±¡çš„å†…å­˜åœ°å€ä¿¡æ¯ã€‚ ä¾‹ï¼š æ­¤æ—¶é€šè¿‡lldbå‘½ä»¤è°ƒè¯• è¯´æ˜ï¼š 0x001d800100001129æ˜¯å¯¹è±¡pçš„isaå€¼ï¼Œé€šè¿‡isa &amp; ISA_MASKè¿ç®—å¾—åˆ°çš„0x0000000100001128å°±æ˜¯Personç±»çš„åœ°å€ è¯æ˜ã€1ã€‘ï¼šé€šè¿‡p/x Person.classç›´æ¥æ‰“å°Personç±»åœ°å€ï¼Œæ˜¾ç„¶å¾—åˆ°çš„æ˜¯0x0000000100001128ï¼Œå¦‚æ­¤ã€1ã€‘è¯æ˜æˆç«‹ï¼ ç»“è®ºï¼šisaå°†å¯¹è±¡å’Œç±»å…³è”èµ·æ¥ï¼Œèµ·åˆ°äº†ä¸­é—´æ¡¥æ¢çš„ä½œç”¨ã€‚ 3.6 isaçš„åˆå§‹åŒ–è¡¥å……æœ€åè¡¥å……ä¸€ä¸‹isaçš„åˆå§‹åŒ–ã€‚è¿˜è®°å¾—åˆå§‹åŒ–isaçš„å…¥å£å—ï¼Ÿæ˜¯initIsa(cls, true, hasCxxDtor);ï¼Œæ­¤æ—¶nonpointerçš„å€¼æ˜¯trueï¼Œå†çœ‹SUPPORT_INDEXED_ISAçš„å®šä¹‰ 12345#if __ARM_ARCH_7K__ &gt;= 2 || (__arm64__ &amp;&amp; !__LP64__)# define SUPPORT_INDEXED_ISA 1#else# define SUPPORT_INDEXED_ISA 0#endif åœ¨x86_64ä¸‹ï¼ŒSUPPORT_INDEXED_ISAæ˜¯0ï¼Œæ‰€ä»¥isaçš„åˆå§‹åŒ–æœ€ç»ˆä¼šæ¥åˆ° 1234567891011isa_t newisa(0);// ä½¿ç”¨ISA_MAGIC_VALUE(0x001d800000000001ULL)èµ‹å€¼ç»™bits// nonpointerä¸º1ï¼Œmagicä¸º1dï¼Œå…¶ä»–å˜é‡ä¸ºé›¶newisa.bits = ISA_MAGIC_VALUE;// hasCxxDtoræ˜¯ä»ç±»çš„isaä¸­å–å‡ºçš„newisa.has_cxx_dtor = hasCxxDtor;// å°†clså³ç§»3ä½åèµ‹å€¼ç»™shiftclsnewisa.shiftcls = (uintptr_t)cls &gt;&gt; 3;isa = newisa; ç¢äºç¯‡å¹…ï¼Œè¿™é‡Œä¸ç»§ç»­æ·±å…¥hasCxxDtorã€‚ å››ã€isa æŒ‡å‘å›¾åœ¨OCä¸­ï¼Œå¯¹è±¡çš„æ–¹æ³•å¹¶æ²¡æœ‰å­˜å‚¨äºå¯¹è±¡çš„ç»“æ„ä½“ä¸­ï¼ˆå¦‚æœæ¯ä¸€ä¸ªå¯¹è±¡éƒ½ä¿å­˜äº†è‡ªå·±èƒ½æ‰§è¡Œçš„æ–¹æ³•ï¼Œé‚£ä¹ˆå¯¹å†…å­˜çš„å ç”¨æœ‰æå¤§çš„å½±å“ï¼‰ã€‚ å½“å¯¹è±¡çš„å®ä¾‹æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå®ƒé€šè¿‡è‡ªå·±çš„isaæ¥æŸ¥æ‰¾å¯¹åº”çš„ç±»ï¼Œç„¶ååœ¨æ‰€å±ç±»çš„ class_data_bits_tç»“æ„ä½“ä¸­æŸ¥æ‰¾å¯¹åº”æ–¹æ³•çš„å®ç°ã€‚åŒæ—¶ï¼Œæ¯ä¸€ä¸ªobjc_class ä¹Ÿæœ‰ä¸€ä¸ªæŒ‡å‘è‡ªå·±çš„çˆ¶ç±»çš„æŒ‡é’ˆsuperclassç”¨æ¥æŸ¥æ‰¾ç»§æ‰¿çš„æ–¹æ³•ã€‚ è€Œå½“è°ƒç”¨ ç±»æ–¹æ³• æ—¶ï¼Œå®ƒçš„æŸ¥æ‰¾æµç¨‹æ˜¯æ€æ ·çš„å‘¢ï¼Ÿå¯¹æ­¤OCçš„è§£å†³æ–¹æ¡ˆå°±æ˜¯å¼•å…¥å…ƒç±»ï¼Œæ¥ä¿è¯ç±»æ–¹æ³•ä¹Ÿèƒ½é€šè¿‡ç›¸åŒçš„æœºåˆ¶æŸ¥æ‰¾åˆ°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç±»çš„isaæŒ‡å‘çš„æ˜¯å…ƒç±»ã€‚ è‹¹æœå®˜æ–¹isaæŒ‡å‘å›¾ï¼š æ¥ä¸‹æ¥æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹å§ã€‚ 4.1 å‡†å¤‡å·¥ä½œåˆ›å»ºTeacherç±»ã€Personç±»ï¼Œå…¶ä¸­Personç±»ç»§æ‰¿äºNSObjectï¼ŒTeacherç±»ç»§æ‰¿äºPersonç±»ã€‚ 4.2 éªŒè¯è¿‡ç¨‹1.è·å–teacherå¯¹è±¡çš„ç±»ï¼ˆç»“æœæ˜¯Teacherç±»ï¼Œåœ°å€ä¸º0x0000000100001230ï¼‰ 123456789(lldb) x/4gx teacher0x100f59400: 0x001d800100001231 0x00000000000000000x100f59410: 0x636f72504b575b2d 0x70756f7247737365 (lldb) p/x 0x001d800100001231 &amp; 0x00007ffffffffff8 // isa &amp; ISA_MASK(long) $3 = 0x0000000100001230 // å¯¹è±¡teacherçš„ç±»åœ°å€ (lldb) po $3Teacher // å¯¹è±¡teacherçš„ç±» 2.è·å–Teacherç±»çš„å…ƒç±»ï¼ˆç»“æœæ˜¯Teacherå…ƒç±»ï¼Œåœ°å€ä¸º0x0000000100001208ï¼‰ 123456789(lldb) x/4gx Teacher.class0x100001230: 0x001d800100001209 0x00000001000011e00x100001240: 0x0000000100f61150 0x0000000100000003(lldb) p/x 0x001d800100001209 &amp; 0x00007ffffffffff8 // isa &amp; ISA_MASK(long) $5 = 0x0000000100001208 // Teacherç±»çš„å…ƒç±»åœ°å€ (lldb) po $5Teacher // Teacherç±»çš„å…ƒç±» Teacherç±» å’Œ Teacherå…ƒç±» åœ°å€ä¸ä¸€æ · 3.è·å–personå¯¹è±¡çš„ç±»ï¼ˆç»“æœæ˜¯Personç±»ï¼Œåœ°å€ä¸º0x00000001000011e0ï¼‰ï¼Œä»¥åŠç±»çš„å…ƒç±»ï¼ˆç»“æœæ˜¯Personå…ƒç±»ï¼Œåœ°å€ä¸º0x00000001000011b8ï¼‰ 12345678910111213141516171819(lldb) x/4gx person0x100f60a30: 0x001d8001000011e1 0x00000000000000000x100f60a40: 0x0000000000000002 0x00007fff9b855588 (lldb) p/x 0x001d8001000011e1 &amp; 0x00007ffffffffff8 // isa &amp; ISA_MASK(long) $8 = 0x00000001000011e0 // å¯¹è±¡personçš„ç±»åœ°å€ (lldb) po $8Person // å¯¹è±¡personçš„ç±»(lldb) x/4gx Person.class0x1000011e0: 0x001d8001000011b9 0x0000000100b381400x1000011f0: 0x0000000100f61030 0x0000000100000003 (lldb) p/x 0x001d8001000011b9 &amp; 0x00007ffffffffff8 // isa &amp; ISA_MASK(long) $10 = 0x00000001000011b8 // Personç±»çš„å…ƒç±»åœ°å€ (lldb) po $10Person // Personç±»çš„å…ƒç±» 4.è·å–objectå¯¹è±¡çš„ç±»ï¼ˆç»“æœæ˜¯NSObjectç±»ï¼Œåœ°å€ä¸º0x0000000100b38140ï¼‰ï¼Œä»¥åŠç±»çš„å…ƒç±»ï¼ˆç»“æœæ˜¯NSObjectå…ƒç±»ï¼Œåœ°å€ä¸º0x0000000100b380f0ï¼‰ 123456789101112131415161718192021(lldb) x/4gx object0x100f5cc50: 0x001d800100b38141 0x00000000000000000x100f5cc60: 0x70736e494b575b2d 0x574b57726f746365 (lldb) p/x 0x001d800100b38141 &amp; 0x00007ffffffffff8 // isa &amp; ISA_MASK(long) $12 = 0x0000000100b38140 // å¯¹è±¡objectçš„ç±»åœ°å€ (lldb) po $12 NSObject // å¯¹è±¡objectçš„ç±» (lldb) x/4gx NSObject.class0x100b38140: 0x001d800100b380f1 0x00000000000000000x100b38150: 0x0000000101913060 0x0000000200000003 (lldb) p/x 0x001d800100b380f1 &amp; 0x00007ffffffffff8 // isa &amp; ISA_MASK(long) $14 = 0x0000000100b380f0 // NSObjectç±»çš„å…ƒç±»åœ°å€ (lldb) po $14NSObject // NSObjectç±»çš„å…ƒç±» 5.è·å–Teacherå…ƒç±»çš„å…ƒç±»ï¼ŒPersonå…ƒç±»çš„å…ƒç±»ï¼Œä»¥åŠNSObjectå…ƒç±»çš„å…ƒç±» 123456789101112131415161718192021222324252627282930313233(lldb) x/4gx 0x0000000100001208 // Teacherå…ƒç±»0x100001208: 0x001d800100b380f1 0x00000001000011b80x100001218: 0x000000010186f950 0x0000000400000007 (lldb) p/x 0x001d800100b380f1 &amp; 0x00007ffffffffff8 // isa &amp; ISA_MASK(long) $16 = 0x0000000100b380f0 // NSObjectå…ƒç±» (lldb) po $16NSObject // NSObjectå…ƒç±» (lldb) x/4gx 0x00000001000011b8 // Personå…ƒç±»0x1000011b8: 0x001d800100b380f1 0x0000000100b380f00x1000011c8: 0x0000000101905a50 0x0000000300000007 (lldb) p/x 0x001d800100b380f1 &amp; 0x00007ffffffffff8 // isa &amp; ISA_MASK(long) $17 = 0x0000000100b380f0 // NSObjectå…ƒç±» (lldb) po $17NSObject // NSObjectå…ƒç±» (lldb) x/4gx 0x0000000100b380f0 // NSObjectå…ƒç±»0x100b380f0: 0x001d800100b380f1 0x0000000100b381400x100b38100: 0x0000000101903820 0x0000000500000007 (lldb) p/x 0x001d800100b380f1 &amp; 0x00007ffffffffff8 // isa &amp; ISA_MASK(long) $18 = 0x0000000100b380f0 // NSObjectå…ƒç±» (lldb) po $18NSObject // NSObjectå…ƒç±» 4.3 isaæŒ‡å‘ç»“è®º åŸºäºã€4.2ã€‘çš„éªŒè¯è¿‡ç¨‹ï¼Œå¯ä»¥å¾—å‡ºç»“è®ºï¼š å¯¹è±¡çš„isaæŒ‡é’ˆæŒ‡å‘å¯¹è±¡çš„æ‰€å±ç±» ç±»çš„isaæŒ‡é’ˆæŒ‡å‘ç±»çš„å…ƒç±» å…ƒç±»çš„isaæŒ‡é’ˆæŒ‡å‘æ ¹å…ƒç±» æ ¹å…ƒç±»çš„isaæŒ‡é’ˆæŒ‡å‘ä»–è‡ªå·±(å½¢æˆé—­ç¯) 4.4 ç»§æ‰¿å…³ç³»çš„è¯æ˜ç±»çš„ç»§æ‰¿å…³ç³»è¯æ˜è¿‡ç¨‹ï¼šï¼ˆä»¥ -&gt; è¡¨ç¤º ç»§æ‰¿è‡ªï¼‰ 12345678(lldb) p class_getSuperclass(Teacher.class)(Class) $19 = Person // Teacherç±» -&gt; Personç±»(lldb) p class_getSuperclass(Person.class)(Class) $20 = NSObject // Personç±» -&gt; NSObjectç±»(lldb) p class_getSuperclass(NSObject.class)(Class) $21 = nil // NSObjectç±» -&gt; nil å…ƒç±»çš„ç»§æ‰¿å…³ç³»è¯æ˜è¿‡ç¨‹ï¼šï¼ˆä»¥ -&gt; è¡¨ç¤º ç»§æ‰¿è‡ªï¼‰ 1234567891011121314151617// 0x0000000100001208 æ˜¯ Teacherå…ƒç±»(lldb) p/x class_getSuperclass((Class)0x0000000100001208)(Class) $17 = 0x00000001000011b8 // Personå…ƒç±»(lldb) po $17Person // Teacherå…ƒç±» -&gt; Personå…ƒç±»// 0x00000001000011b8 æ˜¯ Personå…ƒç±»(lldb) p/x class_getSuperclass((Class)0x00000001000011b8)(Class) $22 = 0x0000000100b380f0 // NSObjectå…ƒç±»ï¼ˆæ ¹å…ƒç±»ï¼‰(lldb) po $22NSObject // Personå…ƒç±» -&gt; æ ¹å…ƒç±»// 0x0000000100b380f0 æ˜¯ æ ¹å…ƒç±»(lldb) p/x class_getSuperclass((Class)0x0000000100b380f0)(Class) $23 = 0x0000000100b38140 NSObject // NSObjectç±»ï¼ˆæ ¹ç±»ï¼‰(lldb) po $23NSObject // æ ¹å…ƒç±» -&gt; æ ¹ç±» æ ¹å…ƒç±»ç»§æ‰¿è‡ªæ ¹ç±»ï¼ˆNSObjectå…ƒç±» -&gt; NSObjectç±»ï¼‰ï¼Œæ ¹ç±»ç»§æ‰¿è‡ªnilï¼ˆNSObjectç±» -&gt; nilï¼‰ äº”ã€æ€»ç»“1.isaæ˜¯isa_tç»“æ„ï¼Œé‡‡ç”¨ è”åˆä½“+ä½åŸŸ çš„æ­é…æ¥è®¾è®¡ï¼šåœ¨ä¸åŒçš„ä½ä¸Šæ˜¾ç¤ºä¸åŒçš„å†…å®¹ï¼Œä»¥æ­¤æ¥èŠ‚çœå‚¨å­˜ç©ºé—´ï¼Œè¿›è€Œä¼˜åŒ–å†…å­˜ã€‚ 2.isaåŒ…å«äº†clså’Œbitsä¸¤ä¸ªæˆå‘˜å˜é‡ï¼Œè¿™ä¸¤ä¸ªæˆå‘˜å˜é‡åœ¨64ä½CPUæ¶æ„ä¸‹çš„é•¿åº¦éƒ½æ˜¯8å­—èŠ‚ï¼Œæ‰€ä»¥isaåœ¨64ä½CPUæ¶æ„ä¸‹çš„é•¿åº¦ä¹Ÿæ˜¯8å­—èŠ‚ã€‚ 3.isaçš„ä½åŸŸä¸Šå­˜å‚¨äº†ä¸€äº›å¯¹è±¡ä¸ç±»çš„ä¿¡æ¯ï¼Œå¹¶å°†å¯¹è±¡ä¸ç±»å…³è”èµ·æ¥ï¼Œèµ·åˆ°ä¸­é—´æ¡¥æ¢çš„ä½œç”¨ã€‚ 4.æŒ‡å‘å›¾ç›¸å…³ç»“è®ºï¼š ç»§æ‰¿ å­ç±» -&gt; çˆ¶ç±» -&gt; æ ¹ç±»(NSObject) å­å…ƒç±» -&gt; çˆ¶å…ƒç±» -&gt; æ ¹å…ƒç±» !!! æ ¹å…ƒç±» -&gt; æ ¹ç±» (NSObject) å½¢æˆé—­ç¯ isa æŒ‡å‘ å®ä¾‹å¯¹è±¡ isa -&gt; ç±»å¯¹è±¡ ç±»å¯¹è±¡ isa -&gt; å…ƒç±»å¯¹è±¡ å…ƒç±»å¯¹è±¡ isa -&gt; æ ¹å…ƒç±»å¯¹è±¡ æ ¹å…ƒç±»å¯¹è±¡ isa -&gt; ä»–è‡ªå·±(å½¢æˆé—­ç¯) å…­ã€æºç æˆ‘çš„ malloc æºç  æˆ‘çš„ libobjc æºç  å‚è€ƒèµ„æ–™OCæºç åˆ†æä¹‹isa GDBè°ƒè¯•æŒ‡å—","link":"/2020/11/16/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/02-isa%E5%8E%9F%E7%90%86/"},{"title":"04-æ–¹æ³•çš„ç¼“å­˜åŸç†","text":"å‰è¨€ä¸€ã€ cache_tæºç åˆ†æå½“OCé¡¹ç›®ç¼–è¯‘å®Œæˆåï¼Œç±»çš„å®ä¾‹æ–¹æ³•ï¼ˆæ–¹æ³•ç¼–å·SEL å’Œ å‡½æ•°åœ°å€IMPï¼‰å°±ä¿å­˜åœ¨ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­ã€‚æˆ‘ä»¬çŸ¥é“ OC ä¸ºäº†å®ç°å…¶åŠ¨æ€æ€§ï¼Œå°† æ–¹æ³•çš„è°ƒç”¨åŒ…è£…æˆäº† SEL å¯»æ‰¾ IMP çš„è¿‡ç¨‹ã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæ¯æ¬¡è°ƒç”¨æ–¹æ³•ï¼Œéƒ½è¦å»ç±»çš„æ–¹æ³•åˆ—è¡¨ï¼ˆç”šè‡³çˆ¶ç±»ã€æ ¹ç±»çš„æ–¹æ³•åˆ—è¡¨ï¼‰ä¸­æŸ¥è¯¢å…¶å‡½æ•°åœ°å€ï¼ŒåŠ¿å¿…ä¼šå¯¹æ€§èƒ½é€ æˆæå¤§çš„æŸè€—ã€‚ ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼ŒOC é‡‡ç”¨äº†æ–¹æ³•ç¼“å­˜çš„æœºåˆ¶æ¥æé«˜è°ƒç”¨æ•ˆç‡ï¼Œä¹Ÿå°±æ˜¯cache_tï¼Œå…¶ä½œç”¨å°±æ˜¯ç¼“å­˜å·²è°ƒç”¨çš„æ–¹æ³•ã€‚å½“è°ƒç”¨æ–¹æ³•æ—¶ï¼Œobjc_msgSendä¼šå…ˆå»ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°å°±æ‰§è¡Œè¯¥æ–¹æ³•ï¼›å¦‚æœä¸åœ¨ç¼“å­˜ä¸­ï¼Œåˆ™å»ç±»çš„æ–¹æ³•åˆ—è¡¨ï¼ˆåŒ…æ‹¬çˆ¶ç±»ã€æ ¹ç±»çš„æ–¹æ³•åˆ—è¡¨ï¼‰æŸ¥æ‰¾ï¼Œæ‰¾åˆ°åä¼šå°†æ–¹æ³•çš„SELå’ŒIMPç¼“å­˜åˆ°cache_tä¸­ï¼Œä»¥ä¾¿ä¸‹æ¬¡è°ƒç”¨æ—¶èƒ½å¤Ÿå¿«é€Ÿæ‰§è¡Œã€‚ 1.1 cache_tç»“æ„æºç ï¼š 12345678910111213141516171819202122232425struct cache_t { struct bucket_t *_buckets; // ç¼“å­˜æ•°ç»„ï¼Œå³å“ˆå¸Œæ¡¶ mask_t _mask; // ç¼“å­˜æ•°ç»„çš„å®¹é‡ä¸´ç•Œå€¼ mask_t _occupied; // ç¼“å­˜æ•°ç»„ä¸­å·²ç¼“å­˜æ–¹æ³•æ•°é‡ ... // ä¸€äº›å‡½æ•°};#if __LP64__typedef uint32_t mask_t;#elsetypedef uint16_t mask_t;#endifstruct bucket_t {private:#if __arm64__ uintptr_t _imp; SEL _sel;#else SEL _sel; uintptr_t _imp;#endif ... // ä¸€äº›æ–¹æ³•}; ä»ä¸Šé¢æºç ä¸éš¾çœ‹å‡ºï¼Œåœ¨64ä½CPUæ¶æ„ä¸‹ï¼Œcache_té•¿åº¦æ˜¯16å­—èŠ‚ã€‚å•ä»ç»“æ„æ¥çœ‹ï¼Œæ–¹æ³•æ˜¯ç¼“å­˜åœ¨bucket_tï¼ˆåˆç§°å“ˆå¸Œæ¡¶ï¼‰ä¸­ï¼Œæ¥ä¸‹æ¥ç”¨ä¸ªä¾‹å­éªŒè¯ä¸€ä¸‹cache_tæ˜¯å¦ç¼“å­˜äº†å·²è°ƒç”¨çš„æ–¹æ³•ã€‚ 1.2 æ–¹æ³•ç¼“å­˜çš„éªŒè¯1.åˆ›å»ºä¸€ä¸ªç®€å•çš„Personç±»ï¼Œä»£ç å¦‚ä¸‹ 1234567891011121314151617181920212223@interface Person : NSObject- (void)methodFirst;- (void)methodSecond;- (void)methodThird;@end@implementation Person- (void)methodFirst { NSLog(@&quot;%s&quot;, __FUNCTION__);}- (void)methodSecond { NSLog(@&quot;%s&quot;, __FUNCTION__);}- (void)methodThird { NSLog(@&quot;%s&quot;, __FUNCTION__);}@end 2.æ–¹æ³•è°ƒç”¨å‰çš„cache_t åœ¨æ–¹æ³•è°ƒç”¨å‰æ‰“ä¸ªæ–­ç‚¹ï¼Œçœ‹çœ‹cache_tçš„ç¼“å­˜æƒ…å†µ è¯´æ˜ï¼š objc_classç»“æ„ä¸­ISAå 8å­—èŠ‚ï¼ŒsuperClasså 8å­—èŠ‚ï¼Œç”±äºæˆ‘ä»¬æ˜¯æŒ‰ç…§8å­—èŠ‚ä¸ºä¸€æ®µæ‰“å°çš„ï¼Œæ‰€ä»¥åˆšå¥½0x1000011d8å°±æ˜¯cache_té¦–åœ°å€ã€‚ ç”±äºè¿˜æ²¡æœ‰ä»»ä½•æ–¹æ³•è°ƒç”¨ï¼Œæ‰€ä»¥_maskå’Œ_occupiedéƒ½æ˜¯0ï¼Œå³è¿˜æ²¡æœ‰æ–¹æ³•ç¼“å­˜ã€‚ ä¸ºä»€ä¹ˆè°ƒç”¨äº†allocå’Œclassï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªæ–¹æ³•æ€ä¹ˆæ²¡æœ‰ç¼“å­˜ï¼Œè¿™é‡Œè¦æåˆ°æˆ‘ä»¬ä¹‹å‰æ¢ç´¢ç±»çš„æ–¹æ³•å­˜å‚¨ä¸­è¯´åˆ°çš„ï¼Œå¯¹è±¡çš„æ–¹æ³•å­˜åœ¨ç±»ä¸­ï¼Œç±»çš„ç±»æ–¹æ³•ä»¥å®ä¾‹æ–¹æ³•çš„å½¢å¼å­˜åœ¨å…ƒç±»ä¸­ï¼Œæˆ‘ä»¬è¿™é‡Œæ¢ç´¢çš„æ˜¯ç±»çš„cacheç¼“å­˜ï¼Œæ‰€ä»¥åªèƒ½æ‰¾åˆ°å®ä¾‹æ–¹æ³•ã€‚ä¸‹é¢ç›´æ¥ç»™å¤§å®¶çœ‹ä¸€ä¸‹å…ƒç±»é‡Œçš„cacheä»¥åŠbucketï¼Œä¹Ÿæ‰¾åˆ°äº†allocæ–¹æ³•çš„ç¼“å­˜ï¼Œè¿™ä¹Ÿè¯´æ˜ï¼Œæˆ‘ä»¬çš„æ€è·¯æ˜¯æ­£ç¡®çš„ï¼š 123456789101112131415161718192021(lldb) p/x 0x001d8001000012b9 &amp; 0x00007ffffffffff8ULL(unsigned long long) $5 = 0x00000001000012b8// 0x00000001000012b8è¿™ä¸ªç©æ„å°±æ˜¯å…ƒç±»çš„åœ°å€äº†ã€‚ä¹‹å‰çš„isaåŸç†ï¼Œé‡Œé¢ä»‹ç»åˆ°äº†å¦‚ä½•ä»ç±»æŸ¥æ‰¾åˆ°å…ƒç±»(lldb) x/4gx 0x00000001000012b80x1000012b8: 0x001d800100b360f1 0x0000000100b360f00x1000012c8: 0x0000000101e236c0 0x0000000200000003(lldb) p (cache_t *)0x1000012c8(cache_t *) $6 = 0x00000001000012c8(lldb) p *$6(cache_t) $7 = { _buckets = 0x0000000101e236c0 _mask = 3 _occupied = 2}(lldb) p $7._buckets(bucket_t *) $8 = 0x0000000101e236c0(lldb) p *$8(bucket_t) $9 = { _key = 4298994200 _imp = 0x00000001003cc3b0 (libobjc.A.dylib`::+[NSObject alloc]() at NSObject.mm:2294)} 3.æ–¹æ³•è°ƒç”¨åçš„cache_t æ‰§è¡Œallocå’Œinitè¿™ä¸¤ä¸ªæ–¹æ³•åï¼Œcache_tå˜åŒ–å¦‚ä¸‹ ä»ä¸Šå›¾å¯çŸ¥ï¼Œè°ƒç”¨initåï¼Œ_maskçš„å€¼æ˜¯3ï¼Œ_occupiedåˆ™æ˜¯1ã€‚_bucketsæŒ‡é’ˆçš„å€¼ï¼ˆæ•°ç»„é¦–åœ°å€ï¼‰å‘ç”Ÿäº†å˜åŒ–ï¼ˆä»0x1003db250å˜æˆ0x101700090ï¼‰ï¼ŒåŒæ—¶ç¼“å­˜äº†initæ–¹æ³•çš„SELå’ŒIMPã€‚ æ€è€ƒï¼š 1. alloc æ–¹æ³•è°ƒç”¨åï¼Œç¼“å­˜åœ¨å“ªé‡Œï¼Ÿ 2. ä¸ºä»€ä¹ˆ init æ–¹æ³•ä¸åœ¨ _buckets ç¬¬ä¸€ä¸ªä½ç½®ï¼Ÿ ç»§ç»­æ‰§è¡ŒmethodFirstï¼Œå†çœ‹cache_t æ­¤æ—¶ï¼Œ_maskçš„å€¼æ˜¯3ï¼ˆæ²¡å‘ç”Ÿå˜åŒ–ï¼‰ï¼Œ_occupiedåˆ™å˜æˆäº†2ï¼Œ_bucketsæŒ‡é’ˆåœ°å€æ²¡å˜ï¼Œå¢åŠ ç¼“å­˜äº†methodFirstæ–¹æ³•çš„SELå’ŒIMPã€‚ æ¥ç€æ˜¯æ‰§è¡ŒmethodSecondï¼Œä¸”çœ‹ æ˜¾ç„¶ï¼Œ_occupiedå˜æˆäº†3ï¼Œè€Œ_bucketsæŒ‡é’ˆåœ°å€ä¸æ”¹å˜ï¼ŒåŒæ—¶æ–°å¢methodSecondçš„æ–¹æ³•ç¼“å­˜ã€‚ æœ€åæ‰§è¡ŒmethodThirdåï¼Œå†çœ‹cache_tå˜åŒ– è¿™æ¬¡çš„ç»“æœå°±å®Œå…¨ä¸åŒäº†ã€‚_maskçš„å€¼å˜æˆ7ï¼Œ_occupiedåˆ™é‡æ–°å˜æˆäº†1ï¼Œè€Œ_bucketsä¸ä»…é¦–åœ°å€å˜äº†ï¼Œä¹‹å‰ç¼“å­˜çš„initã€methodFirstå’ŒmethodSecondæ–¹æ³•ä¹Ÿæ²¡äº†ï¼Œä»…å­˜åœ¨çš„åªæœ‰æ–°å¢çš„methodThirdæ–¹æ³•ã€‚çœ‹æ¥ï¼Œcache_tå¹¶éæ˜¯å¦‚æˆ‘ä»¬æ‰€æ„¿çš„é‚£æ ·â€”â€”è°ƒç”¨ä¸€ä¸ªæ–¹æ³•å°±ç¼“å­˜ä¸€ä¸ªæ–¹æ³•ã€‚ æ€è€ƒï¼šä¹‹å‰ç¼“å­˜çš„æ–¹æ³•ï¼ˆinitã€methodFirst å’Œ methodSecondï¼‰å“ªå»äº†ï¼Ÿ 1.3 cache_tå°ç»“è®©æˆ‘ä»¬æ¢³ç†ä¸€ä¸‹ä¸Šé¢çš„ä¾‹å­ã€‚åœ¨ä¾æ¬¡æ‰§è¡ŒPersonçš„å®ä¾‹æ–¹æ³•initã€methodFirstã€methodSecondã€methodThirdåï¼Œcache_tå˜åŒ–å¦‚ä¸‹ è°ƒç”¨çš„æ–¹æ³• _buckets _mask _occupied æœªè°ƒç”¨æ–¹æ³• ç©º 0 0 init init 3 1 initã€methodFirst initã€methodFirst 3 2 initã€methodFirstã€methodSecond initã€methodFirstã€methodSecond 3 3 initã€methodFirstã€methodSecondã€methodThird methodThird 7 1 å¯è§ï¼Œ**cache_tçš„ç¡®èƒ½å®æ—¶ç¼“å­˜å·²è°ƒç”¨çš„æ–¹æ³•**ã€‚ ä¸Šé¢çš„éªŒè¯è¿‡ç¨‹ä¹Ÿå¯ä»¥å¸®åŠ©æˆ‘ä»¬ç†è§£cache_tä¸‰ä¸ªæˆå‘˜å˜é‡çš„æ„ä¹‰ã€‚ bucketå¯è¯‘ä¸ºæ¡¶ï¼ˆå³å“ˆå¸Œæ¡¶ï¼‰ï¼Œç”¨äºè£…æ–¹æ³•ï¼› occupiedå¯è¯‘ä¸ºå·²å æœ‰ï¼Œè¡¨ç¤ºå·²ç¼“å­˜çš„æ–¹æ³•æ•°é‡ï¼› maskå¯è¯‘ä¸ºé¢å…·ã€æ©é¥°ç‰©ï¼Œä¹çœ‹æ— å¤´ç»ªï¼Œä½†æ˜¯æ³¨æ„åˆ°cache_tä¸­æœ‰è·å–å®¹é‡çš„å‡½æ•°ï¼ˆcapacityï¼‰ï¼Œå…¶æºç å¦‚ä¸‹ 12345678910111213141516struct cache_t { ... mask_t mask(); mask_t capacity(); ...}mask_t cache_t::mask() { return _mask; }mask_t cache_t::capacity() { return mask() ? mask()+1 : 0; } ä»capacityæ–¹æ³•çœ‹å‡ºï¼šå½“_maskä¸ç­‰äº0çš„æ—¶å€™ï¼Œæ„å‘³ç€å·²ç»è°ƒç”¨è¿‡å®ä¾‹æ–¹æ³•ï¼Œæ­¤æ—¶æ¡¶çš„å®¹é‡ä¸º_mask + 1ï¼Œå¦‚æœ_maskæ˜¯0ï¼Œè¯´æ˜æœªè°ƒç”¨å®ä¾‹æ–¹æ³•ï¼Œå³æ¡¶çš„å®¹é‡ä¸º0ã€‚æ•…ï¼Œ_maskä»ä¾§é¢åæ˜ äº†æ¡¶çš„å®¹é‡ã€‚ äºŒã€cache_tçš„æ–¹æ³•ç¼“å­˜åŸç†æ¥ä¸‹æ¥ï¼Œä»æ–¹æ³•çš„è°ƒç”¨è¿‡ç¨‹å¼€å§‹åˆ†æcache_tçš„æ–¹æ³•ç¼“å­˜åŸç†ã€‚ 2.1 cache_fillOCæ–¹æ³•çš„æœ¬è´¨æ˜¯ **æ¶ˆæ¯å‘é€ï¼ˆå³objc_msgSendï¼‰ï¼Œåº•å±‚æ˜¯é€šè¿‡æ–¹æ³•çš„ SEL æŸ¥æ‰¾ IMP**ã€‚ ç®€è¦æµç¨‹ï¼š 1.è°ƒç”¨æ–¹æ³•æ—¶ï¼Œobjc_msgSendä¼šå»cache_tå³ç¼“å­˜ä¸­æŸ¥è¯¢æ–¹æ³•çš„å‡½æ•°å®ç°ï¼ˆè¿™éƒ¨åˆ†æ˜¯ç”±æ±‡ç¼–ä»£ç å®ç°çš„ï¼Œéå¸¸é«˜æ•ˆï¼‰ï¼Œåœ¨ç¼“å­˜ä¸­æ‰¾çš„è¿‡ç¨‹æš‚ä¸”ä¸è¡¨ 2.å½“ç¼“å­˜ä¸­æ²¡æœ‰çš„æ—¶å€™ï¼Œåˆ™å»ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾ï¼Œç›´è‡³æ‰¾åˆ°åï¼Œå†è°ƒç”¨cache_fillï¼Œç›®çš„æ˜¯ä¸ºäº†å°†æ–¹æ³•ç¼“å­˜åˆ°cache_tä¸­ï¼Œå…¶æºç å¦‚ä¸‹ 12345678910void cache_fill(Class cls, SEL sel, IMP imp, id receiver){#if !DEBUG_TASK_THREADS mutex_locker_t lock(cacheUpdateLock); cache_fill_nolock(cls, sel, imp, receiver);#else _collecting_in_critical(); return;#endif} objc_msgSendçš„å…·ä½“æµç¨‹å°†å¦èµ·ä¸€æ–‡åˆ†æï¼Œè¿™é‡Œä¸ä½œèµ˜è¿°ã€‚ 2.2 cache_fill_nolockcache_fillåˆä¼šæ¥åˆ°cache_fill_nolockï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯å°†æ–¹æ³•çš„SELå’ŒIMPå†™å…¥_bucketsï¼ŒåŒæ—¶æ›´æ–°_maskå’Œ_occupiedã€‚ å…¶æºç ä»¥åŠè¯¦ç»†åˆ†æå¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243static void cache_fill_nolock(Class cls, SEL sel, IMP imp, id receiver){ cacheUpdateLock.assertLocked(); // å¦‚æœç±»æœªåˆå§‹åŒ– if (!cls-&gt;isInitialized()) return; // åœ¨è·å–cacheUpdateLockä¹‹å‰ï¼Œç¡®ä¿å…¶ä»–çº¿ç¨‹æ²¡æœ‰å°†è¯¥æ–¹æ³•å†™å…¥ç¼“å­˜ if (cache_getImp(cls, sel)) return; // è·å– cls çš„ cache_tæŒ‡é’ˆ cache_t *cache = getCache(cls); // newOccupiedä¸ºæ–°çš„æ–¹æ³•ç¼“å­˜æ•°ï¼Œç­‰äº å½“å‰æ–¹æ³•ç¼“å­˜æ•°+1 mask_t newOccupied = cache-&gt;occupied() + 1; // è·å–å½“å‰cache_tçš„æ€»å®¹é‡ï¼Œå³ mask+1 mask_t capacity = cache-&gt;capacity(); if (cache-&gt;isConstantEmptyCache()) { // å½“ç¬¬ä¸€æ¬¡è°ƒç”¨ç±»çš„å®ä¾‹æ–¹æ³•æ—¶ï¼ˆå¦‚æœ¬æ–‡çš„ã€1.2ã€‘ä¾‹ä¸­çš„`init`ï¼‰ cache-&gt;reallocate(capacity, capacity ?: INIT_CACHE_SIZE); } else if (newOccupied &lt;= capacity / 4 * 3) { // æ–°çš„æ–¹æ³•ç¼“å­˜æ•° ä¸å¤§äº æ€»å®¹é‡çš„3/4ï¼ŒæŒ‰åŸæ ·ä½¿ç”¨ï¼Œæ— éœ€æ‰©å®¹ } else { // æ–°çš„æ–¹æ³•ç¼“å­˜æ•° å¤§äº æ€»å®¹é‡çš„3/4ï¼Œéœ€è¦æ‰©å®¹ cache-&gt;expand(); } // æ ¹æ®selè·å–bucketï¼Œæ­¤bucketçš„selä¸€èˆ¬ä¸º0ï¼ˆè¯´æ˜è¿™ä¸ªä½ç½®è¿˜æ²¡ç¼“å­˜æ–¹æ³•ï¼‰ï¼Œ // ä¹Ÿå¯èƒ½ä¸å®å‚selç›¸ç­‰ï¼ˆhashå†²çªï¼Œå¯èƒ½æ€§å¾ˆä½ï¼‰ bucket_t *bucket = cache-&gt;find(sel, receiver); // å½“ä¸”ä»…å½“bucketçš„selä¸º0æ—¶ï¼Œæ‰§è¡Œ_occupied++ if (bucket-&gt;sel() == 0) cache-&gt;incrementOccupied(); // æ›´æ–°bucketçš„selå’Œimp bucket-&gt;set&lt;Atomic&gt;(sel, imp);}// INIT_CACHE_SIZE å³ä¸º4enum { INIT_CACHE_SIZE_LOG2 = 2, INIT_CACHE_SIZE = (1 &lt;&lt; INIT_CACHE_SIZE_LOG2)}; ä»ä¸Šé¢çš„æºç ä¸éš¾çœ‹å‡ºï¼Œcache_fill_nolockä¸»è¦æ˜¯cache_tç¼“å­˜æ–¹æ³•çš„è°ƒåº¦ä¸­å¿ƒï¼Œåœ¨è¿™é‡Œä¼šï¼š 1.å†³å®šæ‰§è¡Œ_bucketsçš„å“ªä¸€ç§ç¼“å­˜ç­–ç•¥ï¼ˆåˆå§‹åŒ–åç¼“å­˜ã€ç›´æ¥ç¼“å­˜ã€æ‰©å®¹åç¼“å­˜ï¼Œä¸‰è€…å–ä¸€ï¼‰ï¼› 2.ç„¶åé€šè¿‡æ–¹æ³•çš„selæ‰¾åˆ°ä¸€ä¸ªbucketï¼Œå¹¶æ›´æ–°è¿™ä¸ªbucketçš„selå’Œimpã€‚ï¼ˆå¦‚æœè¿™ä¸ªbucketçš„selä¸º0ï¼Œè¯´æ˜æ˜¯ä¸ªç©ºæ¡¶ï¼Œæ­£å¥½å¯ä»¥ç¼“å­˜æ–¹æ³•ï¼Œäºæ˜¯æ‰§è¡Œ_occupied++ï¼‰ã€‚ æ€è€ƒï¼šä¸ºä»€ä¹ˆæ‰©å®¹ä¸´ç•Œç‚¹æ˜¯ 3/4ï¼Ÿ 2.3 reallocateåœ¨ä¸‹é¢è¿™ä¸¤ç§æƒ…å†µä¸‹ä¼šæ‰§è¡Œreallocateï¼š ä¸€æ˜¯ç¬¬ä¸€æ¬¡åˆå§‹åŒ–_bucketsçš„æ—¶å€™ å¦ä¸€ç§åˆ™æ˜¯_bucketsæ‰©å®¹çš„æ—¶å€™ æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹reallocateåšäº†å“ªäº›äº‹æƒ… 1234567891011121314151617181920212223242526void cache_t::reallocate(mask_t oldCapacity, mask_t newCapacity){ // å½“ä¸”ä»…å½“`_buckets`ä¸­æœ‰ç¼“å­˜æ–¹æ³•æ—¶ï¼ŒfeeOldä¸ºtrue bool freeOld = canBeFreed(); // è·å–å½“å‰bucketsæŒ‡é’ˆï¼Œå³_buckets bucket_t *oldBuckets = buckets(); // å¼€è¾Ÿæ–°çš„bucketsæŒ‡é’ˆ bucket_t *newBuckets = allocateBuckets(newCapacity); // Cache's old contents are not propagated. // This is thought to save cache memory at the cost of extra cache fills. // fixme re-measure this assert(newCapacity &gt; 0); assert((uintptr_t)(mask_t)(newCapacity-1) == newCapacity-1); // å°†æ–°bucketsã€æ–°maskï¼ˆnewCapacity-1ï¼‰åˆ†åˆ«èµ‹å€¼è·Ÿå½“å‰çš„ _buckets å’Œ _mask setBucketsAndMask(newBuckets, newCapacity - 1); if (freeOld) { // é‡Šæ”¾æ—§çš„bucketså†…å­˜ç©ºé—´ cache_collect_free(oldBuckets, oldCapacity); cache_collect(false); }} reallocateå®Œç¾è§£é‡Šäº†åœ¨ä¾‹ã€1.2ã€‘ä¸­çš„å‡ ä¸ªæƒ…å†µï¼š initæ‰§è¡Œå®Œåï¼Œ_bucketsæŒ‡é’ˆåœ°å€å˜äº†ï¼Œ_maskå˜æˆäº†3ï¼› methodThirdæ‰§è¡Œå®Œåï¼Œ_bucketsä¸ä»…æŒ‡é’ˆåœ°å€å˜äº†ï¼ŒåŒæ—¶ä¹‹å‰ç¼“å­˜çš„initã€methodFirstå’ŒmethodSecondæ–¹æ³•ä¹Ÿéƒ½ä¸åœ¨äº† æ³¨æ„ï¼Œ_occupiedçš„å˜åŒ–æ˜¯åœ¨å›åˆ°cache_fill_nolockåå‘ç”Ÿçš„ã€‚ æ€è€ƒï¼šæ‰©å®¹åï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥æŠŠä¹‹å‰ç¼“å­˜çš„æ–¹æ³•åŠ å…¥æ–°çš„bucketsä¸­ï¼Ÿ 2.4 expandä»cache_fill_nolockæºç æ¥çœ‹ï¼Œå½“æ–°çš„æ–¹æ³•ç¼“å­˜æ•°ï¼ˆ_occupied+1ï¼‰å¤§äºæ€»å®¹é‡ï¼ˆ_mask+1ï¼‰æ—¶ï¼Œä¼šå¯¹_bucketsè¿›è¡Œæ‰©å®¹ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œexpandå‡½æ•°ï¼Œå…¶æºç å¦‚ä¸‹ 1234567891011121314151617void cache_t::expand(){ cacheUpdateLock.assertLocked(); // è·å–å½“å‰æ€»å®¹é‡ï¼Œå³_mask+1 uint32_t oldCapacity = capacity(); // æ–°çš„å®¹é‡ = æ—§å®¹é‡ * 2 uint32_t newCapacity = oldCapacity ? oldCapacity*2 : INIT_CACHE_SIZE; if ((uint32_t)(mask_t)newCapacity != newCapacity) { // mask overflow - can't grow further // fixme this wastes one bit of mask newCapacity = oldCapacity; } reallocate(oldCapacity, newCapacity);} è¿™ä¸ªå‡½æ•°éå¸¸ç®€å•ï¼Œä»…ä»…æ˜¯è®¡ç®—å¥½æ–°çš„å®¹é‡åï¼Œå°±å»è°ƒç”¨reallocateå‡½æ•°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼š åœ¨ä¸è¶…è¿‡uint32_tå¤§å°ï¼ˆ4å­—èŠ‚ï¼‰æ—¶ï¼Œæ¯æ¬¡æ‰©å®¹ä¸ºåŸæ¥çš„2å€ å¦‚æœè¶…è¿‡äº†uint32_tï¼Œåˆ™é‡æ–°ç”³è¯·è·ŸåŸæ¥ä¸€æ ·å¤§å°çš„buckets 2.5 findåœ¨æ‰§è¡Œå®Œç›¸åº”çš„bucketsç­–ç•¥åï¼Œæ¥ä¸‹æ¥å°±éœ€è¦æ‰¾åˆ°åˆé€‚çš„ä½ç½®ï¼ˆbucketï¼‰ï¼Œä»¥å­˜å‚¨ æ–¹æ³•çš„SELå’ŒIMPã€‚findå…·ä½“åšçš„äº‹æƒ…å°±æ˜¯æ ¹æ®æ–¹æ³•çš„SELï¼Œè¿”å›ä¸€ä¸ªç¬¦åˆè¦æ±‚çš„bucketï¼ŒåŒæ ·ä¸Šæºç  123456789101112131415161718192021222324252627282930313233343536373839404142434445464748bucket_t * cache_t::find(SEL s, id receiver){ assert(s != 0); // è·å–å½“å‰bucketsï¼Œå³_buckets bucket_t *b = buckets(); // è·å–å½“å‰maskï¼Œå³_mask mask_t m = mask(); // ç”± sel &amp; mask å¾—å‡ºèµ·å§‹ç´¢å¼•å€¼ mask_t begin = cache_hash(s, m); mask_t i = begin; do { // selä¸º0ï¼šè¯´æ˜ i è¿™ä¸ªä½ç½®å°šæœªç¼“å­˜æ–¹æ³•ï¼› // selç­‰äºsï¼šå‘½ä¸­ç¼“å­˜ï¼Œè¯´æ˜ i è¿™ä¸ªä½ç½®å·²ç¼“å­˜æ–¹æ³•ï¼Œå¯èƒ½æ˜¯hashå†²çª if (b[i].sel() == 0 || b[i].sel() == s) { return &amp;b[i]; } } while ((i = cache_next(i, m)) != begin); // hack // æ‰¾ä¸åˆ°å¤šä½™çš„å“ˆå¸Œæ¡¶ï¼ˆå‡ºé”™çš„å¤„ç†ï¼Œæ‰“å°é—®é¢˜ï¼‰ã€‚ä¸€èˆ¬ä¸ä¼šèµ°åˆ°è¿™é‡Œï¼ Class cls = (Class)((uintptr_t)this - offsetof(objc_class, cache)); cache_t::bad_cache(receiver, (SEL)s, cls);}static inline mask_t cache_hash(SEL sel, mask_t mask) { return (mask_t)(uintptr_t)sel &amp; mask;}#if __arm__ || __x86_64__ || __i386__// objc_msgSend has few registers available.// Cache scan increments and wraps at special end-marking bucket.#define CACHE_END_MARKER 1static inline mask_t cache_next(mask_t i, mask_t mask) { return (i+1) &amp; mask;}#elif __arm64__// objc_msgSend has lots of registers available.// Cache scan decrements. No end marker needed.#define CACHE_END_MARKER 0static inline mask_t cache_next(mask_t i, mask_t mask) { return i ? i-1 : mask;}#else#error unknown architecture#endif ä»æºç å¯ä»¥å‘ç°ï¼Œfindæ‰¾bucketçš„æ–¹å¼ç”¨åˆ°äº†hashçš„æ€æƒ³ï¼šä»¥_bucketsä½œä¸ºå“ˆå¸Œæ¡¶ï¼Œä»¥cache_hashä½œä¸ºå“ˆå¸Œå‡½æ•°ï¼Œè¿›è¡Œå“ˆå¸Œè¿ç®—åå¾—å‡ºç´¢å¼•å€¼indexï¼ˆæœ¬è´¨æ˜¯xx &amp; maskï¼Œæ‰€ä»¥indexæœ€å¤§å€¼å°±æ˜¯_maskçš„å€¼ï¼‰ã€‚ ç”±äºç´¢å¼•å€¼æ˜¯é€šè¿‡å“ˆå¸Œè¿ç®—å¾—å‡ºçš„ï¼Œå…¶ç»“æœè‡ªç„¶æ˜¯æ— åºçš„ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¸Šä¾‹ä¸­initæ–¹æ³•ä¸åœ¨_bucketsç¬¬ä¸€ä¸ªä½ç½®çš„åŸå› ã€‚ ä¸‰ã€å¤šçº¿ç¨‹å¯¹æ–¹æ³•ç¼“å­˜çš„å½±å“æ—¢ç„¶å“ˆå¸Œæ¡¶çš„æ•°é‡æ˜¯åœ¨è¿è¡Œæ—¶åŠ¨æ€å¢åŠ çš„ï¼Œé‚£ä¹ˆåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è°ƒç”¨æ–¹æ³•æ—¶ï¼Œå¯¹æ–¹æ³•çš„ç¼“å­˜æœ‰æ²¡æœ‰ä»€ä¹ˆå½±å“å‘¢ï¼Ÿçœ‹ä¸‹é¢çš„åˆ†æã€‚ 3.1 å¤šçº¿ç¨‹åŒæ—¶è¯»å–ç¼“å­˜åœ¨æ•´ä¸ªobjc_msgSendå‡½æ•°ä¸­ï¼Œä¸ºäº†è¾¾åˆ°æœ€ä½³çš„æ€§èƒ½ï¼Œå¯¹æ–¹æ³•ç¼“å­˜çš„è¯»å–æ“ä½œæ˜¯æ²¡æœ‰æ·»åŠ ä»»ä½•é”çš„ã€‚è€Œå¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨å·²ç¼“å­˜çš„æ–¹æ³•ï¼Œå¹¶ä¸ä¼šå¼•å‘_bucketså’Œ_maskçš„å˜åŒ–ï¼Œå› æ­¤å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–æ–¹æ³•ç¼“å­˜çš„æ“ä½œæ˜¯ä¸ä¼šæœ‰å®‰å…¨éšæ‚£çš„ã€‚ 3.2 å¤šçº¿ç¨‹åŒæ—¶å†™ç¼“å­˜ä»å†™ç¼“å­˜çš„cache_fill_nolockæ–¹æ³•ä¸­æˆ‘ä»¬çŸ¥é“åœ¨æ¡¶æ•°é‡æ‰©å®¹å’Œå†™æ¡¶æ•°æ®ä¹‹å‰ï¼Œç³»ç»Ÿä½¿ç”¨äº†ä¸€ä¸ªå…¨å±€çš„äº’æ–¥é”ï¼ˆcacheUpdateLock.assertLocked()ï¼‰æ¥ä¿è¯å†™å…¥çš„åŒæ­¥å¤„ç†ï¼Œå¹¶ä¸”åœ¨é”ä½çš„èŒƒå›´å†…éƒ¨è¿˜åšäº†ä¸€æ¬¡æŸ¥ç¼“å­˜çš„æ“ä½œï¼ˆif (cache_getImp(cls, sel)) return;ï¼‰ï¼Œè¿™æ ·å°± ä¿è¯äº†å“ªæ€•å¤šä¸ªçº¿ç¨‹åŒæ—¶å†™åŒä¸€ä¸ªæ–¹æ³•çš„ç¼“å­˜ä¹Ÿåªä¼šäº§ç”Ÿå†™ä¸€æ¬¡çš„æ•ˆæœï¼Œå³å¤šçº¿ç¨‹åŒæ—¶å†™ç¼“å­˜çš„æ“ä½œä¹Ÿä¸ä¼šæœ‰å®‰å…¨éšæ‚£ã€‚ 3.3 å¤šçº¿ç¨‹åŒæ—¶è¯»å†™ç¼“å­˜è¿™ä¸ªæƒ…å†µå°±æ¯”è¾ƒå¤æ‚äº†ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹objc_msgSendè¯»ç¼“å­˜çš„ä»£ç ï¼ˆä»¥ arm64æ¶æ„æ±‡ç¼– ä¸ºä¾‹ï¼‰ 12345678910111213141516171819202122232425262728293031323334353637383940.macro CacheLookup // x1 = SEL, x16 = isa ldp x10, x11, [x16, #CACHE] // x10 = buckets, x11 = occupied|mask and w12, w1, w11 // x12 = _cmd &amp; mask add x12, x10, x12, LSL #4 // x12 = buckets + ((_cmd &amp; mask)&lt;&lt;4) ldp x9, x17, [x12] // {x9, x17} = *bucket1: cmp x9, x1 // if (bucket-&gt;sel != _cmd) b.ne 2f // scan more CacheHit $0 // call or return imp 2: // not hit: x12 = not-hit bucket CheckMiss $0 // miss if bucket-&gt;sel == 0 cmp x12, x10 // wrap if bucket == buckets b.eq 3f ldp x9, x17, [x12, #-16]! // {x9, x17} = *--bucket b 1b // loop3: // wrap: x12 = first bucket, w11 = mask add x12, x12, w11, UXTW #4 // x12 = buckets+(mask&lt;&lt;4) // Clone scanning loop to miss instead of hang when cache is corrupt. // The slow path may detect any corruption and halt later. ldp x9, x17, [x12] // {x9, x17} = *bucket1: cmp x9, x1 // if (bucket-&gt;sel != _cmd) b.ne 2f // scan more CacheHit $0 // call or return imp 2: // not hit: x12 = not-hit bucket CheckMiss $0 // miss if bucket-&gt;sel == 0 cmp x12, x10 // wrap if bucket == buckets b.eq 3f ldp x9, x17, [x12, #-16]! // {x9, x17} = *--bucket b 1b // loop3: // double wrap JumpMiss $0 .endmacro å…¶ä¸­ï¼ŒldpæŒ‡ä»¤çš„ä½œç”¨æ˜¯å°†æ•°æ®ä»å†…å­˜è¯»å–å‡ºæ¥å­˜åˆ°å¯„å­˜å™¨ï¼Œç¬¬ä¸€ä¸ªldpä»£ç ä¼š æŠŠcache_tä¸­çš„_buckets å’Œ _occupied | _maskæ•´ä¸ªç»“æ„ä½“æˆå‘˜åˆ†åˆ«è¯»å–åˆ°x10å’Œx11ä¸¤ä¸ªå¯„å­˜å™¨ä¸­ï¼Œå¹¶ä¸”CacheLookupçš„åç»­ä»£ç æ²¡æœ‰å†æ¬¡è¯»å–cache_tçš„æˆå‘˜æ•°æ®ï¼Œè€Œæ˜¯ä¸€ç›´ä½¿ç”¨x10å’Œx11ä¸­çš„å€¼è¿›è¡Œå“ˆå¸ŒæŸ¥æ‰¾ã€‚ç”±äºCPUèƒ½ä¿è¯å•æ¡æŒ‡ä»¤æ‰§è¡Œçš„åŸå­æ€§ï¼Œæ‰€ä»¥ åªè¦ä¿è¯ldp x10, x11, [x16, #CACHE]è¿™æ®µä»£ç è¯»å–åˆ°çš„_bucketsä¸_maskæ˜¯äº’ç›¸åŒ¹é…çš„ï¼ˆå³è¦ä¹ˆåŒæ—¶æ˜¯æ‰©å®¹å‰çš„æ•°æ®ï¼Œè¦ä¹ˆåŒæ—¶æ˜¯æ‰©å®¹åçš„æ•°æ®ï¼‰ï¼Œé‚£ä¹ˆå¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å†™æ–¹æ³•ç¼“å­˜ä¹Ÿæ˜¯æ²¡æœ‰å®‰å…¨éšæ‚£çš„ã€‚ 3.3.1 ç¼–è¯‘å†…å­˜å±éšœè¿™é‡Œæœ‰ä¸ªç–‘é—®ï¼Œå³ç³»ç»Ÿæ˜¯å¦‚ä½•ç¡®ä¿_bucketsä¸_maskçš„è¿™ç§ä¸€è‡´æ€§çš„å‘¢ï¼Ÿè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªå˜é‡çš„å†™å…¥æºç  1234567891011121314151617181920void cache_t::setBucketsAndMask(struct bucket_t *newBuckets, mask_t newMask){ // objc_msgSend uses mask and buckets with no locks. // It is safe for objc_msgSend to see new buckets but old mask. // (It will get a cache miss but not overrun the buckets' bounds). // It is unsafe for objc_msgSend to see old buckets and new mask. // Therefore we write new buckets, wait a lot, then write new mask. // objc_msgSend reads mask first, then buckets. // ensure other threads see buckets contents before buckets pointer mega_barrier(); _buckets = newBuckets; // ensure other threads see new buckets before new mask mega_barrier(); _mask = newMask; _occupied = 0;} è¿™æ®µC++ä»£ç å…ˆä¿®æ”¹_bucketsï¼Œç„¶åå†æ›´æ–°_maskçš„å€¼ï¼Œä¸ºäº†ç¡®ä¿è¿™ä¸ªé¡ºåºä¸è¢«ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œè¿™é‡Œä½¿ç”¨äº†mega_baerrier()æ¥å®ç° ç¼–è¯‘å†…å­˜å±éšœï¼ˆCompiler Memory Barrierï¼‰ã€‚ å¦‚æœä¸è®¾ç½® ç¼–è¯‘å†…å­˜å±éšœ çš„è¯ï¼Œç¼–è¯‘å™¨æœ‰å¯èƒ½ä¼šä¼˜åŒ–ä»£ç å…ˆèµ‹å€¼_maskï¼Œç„¶åæ‰æ˜¯èµ‹å€¼_bucketsï¼Œä¸¤è€…çš„èµ‹å€¼ä¹‹é—´ï¼Œå¦‚æœå¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œldp x10, x11, [x16, #0x10]æŒ‡ä»¤ï¼Œå¾—åˆ°çš„å°±æ˜¯æ—§_bucketså’Œæ–°_maskï¼Œè¿›è€Œå‡ºç°å†…å­˜æ•°ç»„è¶Šç•Œå¼•å‘ç¨‹åºå´©æºƒã€‚ è€ŒåŠ å…¥äº†ç¼–è¯‘å†…å­˜å±éšœåï¼Œå°±ç®—å¾—åˆ°çš„æ˜¯æ–°_bucketså’Œæ—§_maskï¼Œä¹Ÿä¸ä¼šå¯¼è‡´ç¨‹åºå´©æºƒã€‚ ç¼–è¯‘å†…å­˜å±éšœä»…ä»…æ˜¯ç¡®ä¿_bucketsçš„èµ‹å€¼ä¼šä¼˜å…ˆäº_maskçš„èµ‹å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä»»ä½•åœºæ™¯ä¸‹å½“æŒ‡ä»¤ldp x10, x11, [x16, #CACHE]æ‰§è¡Œåï¼Œå¾—åˆ°çš„_bucketsæ•°ç»„çš„é•¿åº¦ä¸€å®šæ˜¯å¤§äºæˆ–ç­‰äº_mask+1çš„ï¼Œå¦‚æ­¤å°±ä¿è¯äº†ä¸ä¼šå‡ºç°å†…å­˜æ•°ç»„è¶Šç•Œå¯¼è‡´çš„ç¨‹åºå´©æºƒã€‚å¯è§ï¼Œå€ŸåŠ©ç¼–è¯‘å†…å­˜å±éšœçš„æŠ€å·§åœ¨ä¸€å®šçš„ç¨‹åº¦ä¸Šå¯ä»¥å®ç°æ— é”è¯»å†™æŠ€æœ¯ã€‚ å¯¹å†…å­˜å±éšœæ„Ÿå…´è¶£çš„åŒå­¦å¯æˆ³ ç†è§£ Memory barrierï¼ˆå†…å­˜å±éšœï¼‰ 3.3.2 å†…å­˜åƒåœ¾å›æ”¶æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨å¤šçº¿ç¨‹è¯»å†™æ–¹æ³•ç¼“å­˜æ—¶ï¼Œå†™çº¿ç¨‹å¯èƒ½ä¼šæ‰©å®¹_bucketsï¼ˆå¼€è¾Ÿæ–°çš„_bucketså†…å­˜ï¼ŒåŒæ—¶é”€æ¯æ—§çš„_bucketsï¼‰ï¼Œæ­¤æ—¶ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹è¯»å–åˆ°çš„_bucketsæ˜¯æ—§çš„å†…å­˜ï¼Œå°±æœ‰å¯èƒ½ä¼šå‘ç”Ÿè¯»å†…å­˜å¼‚å¸¸è€Œç³»ç»Ÿå´©æºƒã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒOCä½¿ç”¨äº†ä¸¤ä¸ªå…¨å±€æ•°ç»„objc_entryPointsã€objc_exitPointsï¼Œåˆ†åˆ«ä¿å­˜æ‰€æœ‰ä¼šè®¿é—®åˆ°cacheçš„å‡½æ•°çš„èµ·å§‹åœ°å€ã€ç»“æŸåœ°å€ 12extern &quot;C&quot; uintptr_t objc_entryPoints[];extern &quot;C&quot; uintptr_t objc_exitPoints[]; ä¸‹é¢åˆ—å‡ºè¿™äº›å‡½æ•°ï¼ˆåŒæ ·ä»¥ arm64æ¶æ„æ±‡ç¼– ä¸ºä¾‹ï¼‰ 12345678910111213141516171819.private_extern _objc_entryPoints_objc_entryPoints: .quad _cache_getImp .quad _objc_msgSend .quad _objc_msgSendSuper .quad _objc_msgSendSuper2 .quad _objc_msgLookup .quad _objc_msgLookupSuper2 .quad 0.private_extern _objc_exitPoints_objc_exitPoints: .quad LExit_cache_getImp .quad LExit_objc_msgSend .quad LExit_objc_msgSendSuper .quad LExit_objc_msgSendSuper2 .quad LExit_objc_msgLookup .quad LExit_objc_msgLookupSuper2 .quad 0 å½“çº¿ç¨‹æ‰©å®¹å“ˆå¸Œæ¡¶æ—¶ï¼Œä¼šå…ˆæŠŠæ—§çš„æ¡¶å†…å­˜ä¿å­˜åœ¨ä¸€ä¸ªå…¨å±€çš„åƒåœ¾å›æ”¶æ•°ç»„å˜é‡garbage_refsä¸­ï¼Œç„¶åå†éå†å½“å‰è¿›ç¨‹ï¼ˆåœ¨iOSä¸­ï¼Œä¸€ä¸ªè¿›ç¨‹å°±æ˜¯ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼‰ä¸­çš„æ‰€æœ‰çº¿ç¨‹ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œobjc_entryPointsåˆ—è¡¨ä¸­çš„å‡½æ•°ï¼ˆåŸç†æ˜¯PCå¯„å­˜å™¨ä¸­çš„å€¼æ˜¯å¦åœ¨objc_entryPointså’Œobjc_exitPointsè¿™ä¸ªèŒƒå›´å†…ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¯´æ˜æ²¡æœ‰ä»»ä½•çº¿ç¨‹è®¿é—®cacheï¼Œå¯ä»¥æ”¾å¿ƒåœ°å¯¹garbage_refsä¸­çš„æ‰€æœ‰å¾…é”€æ¯çš„å“ˆå¸Œæ¡¶å†…å­˜å—æ‰§è¡ŒçœŸæ­£çš„é”€æ¯æ“ä½œï¼›å¦‚æœæœ‰åˆ™è¯´æ˜æœ‰çº¿ç¨‹è®¿é—®cacheï¼Œè¿™æ¬¡å°±ä¸åšå¤„ç†ï¼Œä¸‹æ¬¡å†æ£€æŸ¥å¹¶åœ¨é€‚å½“çš„æ—¶å€™è¿›è¡Œé”€æ¯ã€‚ ä»¥ä¸Šï¼Œ**OC 2.0çš„runtimeå·§å¦™çš„åˆ©ç”¨äº†ldpæ±‡ç¼–æŒ‡ä»¤ã€ç¼–è¯‘å†…å­˜å±éšœæŠ€æœ¯ã€å†…å­˜åƒåœ¾å›æ”¶æŠ€æœ¯ç­‰å¤šç§æ‰‹æ®µæ¥è§£å†³å¤šçº¿ç¨‹è¯»å†™çš„æ— é”å¤„ç†æ–¹æ¡ˆï¼Œæ—¢ä¿è¯äº†å®‰å…¨ï¼Œåˆæå‡äº†ç³»ç»Ÿçš„æ€§èƒ½ã€‚** æ·±å…¥è§£æ„objc_msgSendå‡½æ•°çš„å®ç° è¿™ç¯‡åšæ–‡ä¼šå¸®åŠ©ä½ è¿›ä¸€æ­¥äº†è§£Runtimeçš„å®ç°ï¼Œå°¤å…¶åœ¨å¤šçº¿ç¨‹è¯»å†™æ–¹æ³•ç¼“å­˜æ–¹é¢ å››ã€é—®é¢˜è®¨è®ºæ¥åˆ°è¿™é‡Œï¼Œç›¸ä¿¡å¤§å®¶å¯¹cache_tç¼“å­˜æ–¹æ³•çš„åŸç†å·²ç»æœ‰äº†ä¸€å®šçš„ç†è§£ã€‚ç°åœ¨è¯·çœ‹ä¸‹é¢çš„å‡ ä¸ªé—®é¢˜ï¼š 4.1 ç±»æ–¹æ³•çš„ç¼“å­˜ä½ç½®Qï¼šPersonç±»è°ƒç”¨allocæ–¹æ³•åï¼Œç¼“å­˜åœ¨å“ªé‡Œï¼Ÿ Aï¼šç¼“å­˜åœ¨ Personå…ƒç±» çš„ cache_t ä¸­ã€‚è¯æ˜å¦‚ä¸‹å›¾ 4.2 _maskçš„ä½œç”¨Qï¼šè¯·è¯´æ˜cache_tä¸­_maskçš„ä½œç”¨ Aï¼š_maskä»ä¾§é¢åæ˜ äº†cache_tä¸­å“ˆå¸Œæ¡¶çš„æ•°é‡ï¼ˆå“ˆå¸Œæ¡¶çš„æ•°é‡ = _mask + 1ï¼‰ï¼Œä¿è¯äº†æŸ¥æ‰¾å“ˆå¸Œæ¡¶æ—¶ä¸ä¼šå‡ºç°è¶Šç•Œçš„æƒ…å†µã€‚ é¢˜è§£ï¼šä»ä¸Šé¢çš„æºç åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“cache_tåœ¨ä»»ä½•ä¸€æ¬¡ç¼“å­˜æ–¹æ³•çš„æ—¶å€™ï¼Œå“ˆå¸Œæ¡¶çš„æ•°é‡ä¸€å®šæ˜¯ &gt;=4ä¸”èƒ½è¢« 4æ•´é™¤çš„ï¼Œ_maskåˆ™ç­‰äºå“ˆå¸Œæ¡¶çš„æ•°é‡-1ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç¼“å­˜æ–¹æ³•çš„æ—¶å€™ï¼Œ_maskçš„äºŒè¿›åˆ¶ä½ä¸Šå…¨éƒ½æ˜¯1ã€‚å½“å¾ªç¯æŸ¥è¯¢å“ˆå¸Œæ¡¶çš„æ—¶å€™ï¼Œç´¢å¼•å€¼æ˜¯ç”±xx &amp; _maskè¿ç®—å¾—å‡ºçš„ï¼Œå› æ­¤ç´¢å¼•å€¼æ˜¯å°äºå“ˆå¸Œæ¡¶çš„æ•°é‡çš„ï¼ˆindex &lt;= _maskï¼Œæ•…index &lt; capacityï¼‰ï¼Œä¹Ÿå°±ä¸ä¼šå‡ºç°è¶Šç•Œçš„æƒ…å†µã€‚ 4.3 å…³äºæ‰©å®¹ä¸´ç•Œç‚¹3/4çš„è®¨è®ºQï¼šä¸ºä»€ä¹ˆæ‰©å®¹ä¸´ç•Œç‚¹æ˜¯3/4ï¼Ÿ Aï¼šä¸€èˆ¬è®¾å®šä¸´ç•Œç‚¹å°±ä¸å¾—ä¸æƒè¡¡ ç©ºé—´åˆ©ç”¨ç‡ å’Œ æ—¶é—´åˆ©ç”¨ç‡ ã€‚åœ¨ 3/4 è¿™ä¸ªä¸´ç•Œç‚¹çš„æ—¶å€™ï¼Œç©ºé—´åˆ©ç”¨ç‡æ¯”è¾ƒé«˜ï¼ŒåŒæ—¶åˆé¿å…äº†ç›¸å½“å¤šçš„å“ˆå¸Œå†²çªï¼Œæ—¶é—´åˆ©ç”¨ç‡ä¹Ÿæ¯”è¾ƒé«˜ã€‚ é¢˜è§£ï¼šæ‰©å®¹ä¸´ç•Œç‚¹ç›´æ¥å½±å“å¾ªç¯æŸ¥æ‰¾å“ˆå¸Œæ¡¶çš„æ•ˆç‡ã€‚è®¾æƒ³ä¸¤ä¸ªæç«¯æƒ…å†µï¼š å½“ä¸´ç•Œç‚¹æ˜¯1çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å…¨éƒ¨çš„å“ˆå¸Œæ¡¶éƒ½ç¼“å­˜æœ‰æ–¹æ³•æ—¶ï¼Œæ‰ä¼šæ‰©å®¹ã€‚è¿™è™½ç„¶è®©å¼€è¾Ÿå‡ºæ¥çš„å†…å­˜ç©ºé—´çš„åˆ©ç”¨ç‡è¾¾åˆ°100%ï¼Œä½†æ˜¯ä¼šé€ æˆå¤§é‡çš„å“ˆå¸Œå†²çªï¼ŒåŠ å‰§äº†æŸ¥æ‰¾ç´¢å¼•çš„æ—¶é—´æˆæœ¬ï¼Œå¯¼è‡´æ—¶é—´åˆ©ç”¨ç‡ä½ä¸‹ï¼Œè¿™ä¸é«˜é€Ÿç¼“å­˜çš„ç›®çš„ç›¸æ‚–ï¼› å½“ä¸´ç•Œç‚¹æ˜¯0.5çš„æ—¶å€™ï¼Œæ„å‘³ç€å“ˆå¸Œæ¡¶çš„å ç”¨é‡è¾¾åˆ°æ€»æ•°ä¸€åŠçš„æ—¶å€™ï¼Œå°±ä¼šæ‰©å®¹ã€‚è¿™è™½ç„¶æå¤§é¿å…äº†å“ˆå¸Œå†²çªï¼Œæ—¶é—´åˆ©ç”¨ç‡éå¸¸é«˜ï¼Œå´æµªè´¹äº†ä¸€åŠçš„ç©ºé—´ï¼Œä½¿å¾—ç©ºé—´åˆ©ç”¨ç‡ä½ä¸‹ã€‚è¿™ç§ä»¥ç©ºé—´æ¢å–æ—¶é—´çš„åšæ³•åŒæ ·ä¸å¯å–ï¼› ä¸¤ç›¸æƒè¡¡ä¸‹ï¼Œå½“æ‰©å®¹ä¸´ç•Œç‚¹æ˜¯3/4çš„æ—¶å€™ï¼Œç©ºé—´åˆ©ç”¨ç‡ å’Œ æ—¶é—´åˆ©ç”¨ç‡ éƒ½ç›¸å¯¹æ¯”è¾ƒé«˜ã€‚ 4.4 ç¼“å­˜å¾ªç¯æŸ¥æ‰¾çš„æ­»å¾ªç¯æƒ…å†µQï¼šç¼“å­˜å¾ªç¯æŸ¥æ‰¾å“ˆå¸Œæ¡¶æ˜¯å¦ä¼šå‡ºç°æ­»å¾ªç¯çš„æƒ…å†µï¼Ÿ Aï¼šä¸ä¼šå‡ºç°ã€‚ é¢˜è§£ï¼šå½“å“ˆå¸Œæ¡¶çš„åˆ©ç”¨ç‡è¾¾åˆ°3/4çš„æ—¶å€™ï¼Œä¸‹æ¬¡ç¼“å­˜çš„æ—¶å€™å°±ä¼šè¿›è¡Œæ‰©å®¹ï¼Œå³ç©ºæ¡¶çš„æ•°é‡æœ€å°‘ä¹Ÿä¼šæœ‰æ€»æ•°çš„1/4ï¼Œå› æ­¤å¾ªç¯æŸ¥è¯¢ç´¢å¼•çš„æ—¶å€™ï¼Œä¸€å®šä¼šå‡ºç°å‘½ä¸­ç¼“å­˜æˆ–è€…ç©ºæ¡¶çš„æƒ…å†µï¼Œä»è€Œç»“æŸå¾ªç¯ã€‚ äº”ã€æ€»ç»“é€šè¿‡ä»¥ä¸Šä¾‹å­çš„éªŒè¯ã€æºç çš„åˆ†æä»¥åŠé—®é¢˜çš„è®¨è®ºï¼Œç°åœ¨æ€»ç»“ä¸€ä¸‹cache_tçš„å‡ ä¸ªç»“è®ºï¼š 1.cache_tèƒ½ç¼“å­˜è°ƒç”¨è¿‡çš„æ–¹æ³•ã€‚ 2.cache_tçš„ä¸‰ä¸ªæˆå‘˜å˜é‡ä¸­ï¼Œ _bucketsçš„ç±»å‹æ˜¯struct bucket_t *ï¼Œä¹Ÿå°±æ˜¯æŒ‡é’ˆæ•°ç»„ï¼Œå®ƒè¡¨ç¤ºä¸€ç³»åˆ—çš„å“ˆå¸Œæ¡¶ï¼ˆå·²è°ƒç”¨çš„æ–¹æ³•çš„SELå’ŒIMPå°±ç¼“å­˜åœ¨å“ˆå¸Œæ¡¶ä¸­ï¼‰ï¼Œä¸€ä¸ªæ¡¶å¯ä»¥ç¼“å­˜ä¸€ä¸ªæ–¹æ³•ã€‚ _maskçš„ç±»å‹æ˜¯mask_tï¼ˆmask_tåœ¨64ä½æ¶æ„ä¸‹å°±æ˜¯uint32_tï¼Œé•¿åº¦ä¸º4ä¸ªå­—èŠ‚ï¼‰ï¼Œå®ƒçš„å€¼ç­‰äºå“ˆå¸Œæ¡¶çš„æ€»æ•°-1ï¼ˆcapacity - 1ï¼‰ï¼Œä¾§é¢åæ˜ äº†å“ˆå¸Œæ¡¶çš„æ€»æ•°ã€‚ _occupiedçš„ç±»å‹ä¹Ÿæ˜¯mask_tï¼Œå®ƒä»£è¡¨çš„æ˜¯å½“å‰_bucketså·²ç¼“å­˜çš„æ–¹æ³•æ•°ã€‚ 3.å½“ç¼“å­˜çš„æ–¹æ³•æ•°åˆ°è¾¾ä¸´ç•Œç‚¹ï¼ˆæ¡¶æ€»æ•°çš„3/4ï¼‰æ—¶ï¼Œä¸‹æ¬¡å†ç¼“å­˜æ–°çš„æ–¹æ³•æ—¶ï¼Œé¦–å…ˆä¼šä¸¢å¼ƒæ—§çš„æ¡¶ï¼ŒåŒæ—¶å¼€è¾Ÿæ–°çš„å†…å­˜ï¼Œä¹Ÿå°±æ˜¯æ‰©å®¹ï¼ˆæ‰©å®¹åéƒ½æ˜¯å…¨æ–°çš„æ¡¶ï¼Œä»¥åæ¯ä¸ªæ–¹æ³•éƒ½è¦é‡æ–°ç¼“å­˜çš„ï¼‰ï¼Œç„¶åå†æŠŠæ–°çš„æ–¹æ³•ç¼“å­˜ä¸‹æ¥ï¼Œæ­¤æ—¶_occupiedä¸º1ã€‚ 4.å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œå¯åˆ†ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š å¤šçº¿ç¨‹è¯»ç¼“å­˜ï¼šè¯»ç¼“å­˜ç”±æ±‡ç¼–å®ç°ï¼Œæ— é”ä¸”é«˜æ•ˆï¼Œç”±äºå¹¶æ²¡æœ‰æ”¹å˜_bucketså’Œ_maskï¼Œæ‰€ä»¥å¹¶æ— å®‰å…¨éšæ‚£ã€‚ å¤šçº¿ç¨‹å†™ç¼“å­˜ï¼šOCç”¨äº†ä¸ªå…¨å±€çš„äº’æ–¥é”ï¼ˆcacheUpdateLock.assertLocked()ï¼‰æ¥ä¿è¯ä¸ä¼šå‡ºç°å†™ä¸¤æ¬¡ç¼“å­˜çš„æƒ…å†µã€‚ å¤šçº¿ç¨‹è¯»å†™ç¼“å­˜ï¼šOCä½¿ç”¨äº†ldpæ±‡ç¼–æŒ‡ä»¤ã€ç¼–è¯‘å†…å­˜å±éšœæŠ€æœ¯ã€å†…å­˜åƒåœ¾å›æ”¶æŠ€æœ¯ç­‰å¤šç§æ‰‹æ®µæ¥è§£å†³å¤šçº¿ç¨‹è¯»å†™çš„æ— é”å¤„ç†æ–¹æ¡ˆï¼Œæ—¢ä¿è¯äº†å®‰å…¨ï¼Œåˆæå‡äº†ç³»ç»Ÿçš„æ€§èƒ½ã€‚ å‚è€ƒhttps://juejin.cn/post/6844904070596001806","link":"/2020/12/16/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/04-%E6%96%B9%E6%B3%95%E7%9A%84%E7%BC%93%E5%AD%98%E5%8E%9F%E7%90%86/"},{"title":"05-æ–¹æ³•çš„æœ¬è´¨å’Œæ¶ˆæ¯æŸ¥æ‰¾æµç¨‹","text":"å‰è¨€ åœ¨Objective-Cä¸­ï¼Œå½“ç¼–è¯‘å™¨é‡åˆ°ä¸€ä¸ªæ–¹æ³•è°ƒç”¨æ—¶ï¼Œå®ƒä¼šå°†æ–¹æ³•çš„è°ƒç”¨å˜æˆä»¥ä¸‹å‡½æ•°ä¸­çš„ä¸€ä¸ªï¼šobjc_msgSendã€objc_msgSend_stretã€objc_msgSendSuperå’Œobjc_msgSendSuper_stretã€‚ å‘é€ç»™å¯¹è±¡çš„çˆ¶ç±»çš„æ¶ˆæ¯ï¼ˆä½¿ç”¨superå…³é”®å­—æ—¶ï¼‰æ˜¯ä½¿ç”¨objc_msgSendSuperå‘é€çš„ï¼Œå…¶ä»–æ¶ˆæ¯æ˜¯ä½¿ç”¨objc_msgSendå‘é€çš„ã€‚å¦‚æœæ˜¯ä»¥æ•°æ®ç»“æ„ä½“ä½œä¸ºè¿”å›å€¼çš„æ–¹æ³•ï¼Œåˆ™æ˜¯ä½¿ç”¨objc_msgSendSuper_stretæˆ–objc_msgSend_stretå‘é€çš„ã€‚ ç„¶è€Œè¿™ä¸€åˆ‡ï¼Œéƒ½è¦ä»Runtimeå¼€å§‹è¯´èµ· ä¸€ã€Runtime1.1 ä»€ä¹ˆæ˜¯RuntimeRuntimeæ˜¯ä¸€å¥—APIï¼Œç”±cã€c++ã€æ±‡ç¼–ä¸€èµ·å†™æˆçš„ï¼Œä¸ºOCæä¾›äº†è¿è¡Œæ—¶çš„ç‰¹æ€§ è¿è¡Œæ—¶ï¼šä»£ç è·‘èµ·æ¥ï¼Œå°†å¯æ‰§è¡Œæ–‡ä»¶è£…è½½åˆ°å†…å­˜ ç¼–è¯‘æ—¶ï¼šæ­£åœ¨ç¼–è¯‘çš„æ—¶é—´â€”â€”ç¿»è¯‘æºä»£ç å°†é«˜çº§è¯­è¨€ï¼ˆOCã€Swiftï¼‰ç¿»è¯‘æˆæœºå™¨è¯­è¨€ï¼ˆæ±‡ç¼–ç­‰ï¼‰ï¼Œæœ€åå˜æˆäºŒè¿›åˆ¶ 1.2 Runtimeç‰ˆæœ¬Runtimeæœ‰ä¸¤ä¸ªç‰ˆæœ¬â€”â€”Legacyå’ŒModernï¼Œè‹¹æœå¼€å‘è€…æ–‡æ¡£éƒ½å†™å¾—æ¸…æ¸…æ¥šæ¥š æºç ä¸­-oldã€__OBJC__ä»£è¡¨Legacyç‰ˆæœ¬ -newã€__OBJC2__ä»£è¡¨Modernç‰ˆæœ¬ï¼Œä»¥æ­¤åšå…¼å®¹ 1.3 Runtimeçš„ä½œç”¨åŠè°ƒç”¨Runtimeåº•å±‚ç»è¿‡ç¼–è¯‘ä¼šæä¾›ä¸€å¥—APIå’Œä¾›FrameWorkã€Serviceä½¿ç”¨ 1.4 Runtime è°ƒç”¨æ–¹å¼ Runtime APIï¼Œå¦‚ sel_registerName() NSObject APIï¼Œå¦‚ isKindOf() OCä¸Šå±‚æ–¹å¼ï¼Œå¦‚ @selector() åŸæ¥å¹³å¸¸åœ¨ç”¨çš„è¿™ä¹ˆå¤šæ–¹æ³•éƒ½æ˜¯Runtimeå•Šï¼Œé‚£ä¹ˆæ–¹æ³•ç©¶ç«Ÿæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ äºŒã€æ–¹æ³•çš„æœ¬è´¨2.1 ç ”ç©¶æ–¹æ³•é€šè¿‡clangç¼–è¯‘æˆcppæ–‡ä»¶å¯ä»¥çœ‹åˆ°åº•å±‚ä»£ç ï¼Œå¾—åˆ°æ–¹æ³•çš„æœ¬è´¨ å…¼å®¹ç¼–è¯‘ï¼ˆä»£ç å°‘ï¼‰ï¼š 1clang -rewrite-objc main.m -o main.cpp å®Œæ•´ç¼–è¯‘ï¼ˆä¸æŠ¥é”™ï¼‰ï¼š 1xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc main.m -o main.cpp 2.2 ä»£ç è½¬æ¢12FXPerson *p = [FXPerson alloc];[p fly]; è½¬ä¸ºï¼š 12FXPerson *p = ((FXPerson *(*)(id, SEL))(void *)objc_msgSend)((id)objc_getClass(&quot;FXPerson&quot;), sel_registerName(&quot;alloc&quot;));((void (*)(id, SEL))(void *)objc_msgSend)((id)p, sel_registerName(&quot;fly&quot;)); ((FXPerson *(*)(id, SEL))(void *)æ˜¯ç±»å‹å¼ºè½¬ (id)objc_getClass(&quot;FXPerson&quot;)è·å–FXPersonç±»å¯¹è±¡ sel_registerName(&quot;alloc&quot;)ç­‰åŒäº@selector() é‚£ä¹ˆå¯ä»¥ç†è§£ä¸º((ç±»å‹å¼ºè½¬)objc_msgSend)(å¯¹è±¡, æ–¹æ³•è°ƒç”¨) å»é™¤å¼ºè½¬åå°±å®¹æ˜“åˆ†è¾¨å¤šäº† 12Person *person = objc_msgSend(objc_getClass(&quot;Person&quot;), sel_registerName(&quot;alloc&quot;));objc_msgSend(person, sel_registerName(&quot;personInstanceMethod1&quot;)); å‘ç°+allocå’ŒpersonInstanceMethod1è¿™ä¸¤ä¸ªæ–¹æ³•çš„è°ƒç”¨ï¼Œå®é™…ä¸Šå°±æ˜¯è°ƒç”¨objc_msgSendå‡½æ•°ã€‚ 2.3æ–¹æ³•çš„æœ¬è´¨å¯ä»¥åœ¨arm64.sæ–‡ä»¶ä¸­æ‰¾åˆ°objc_msgSendå‡½æ•°çš„è¯´æ˜ 1id objc_msgSend(id self, SEL _cmd, ...) å…¶ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°selfæ˜¯è°ƒç”¨è€…æœ¬èº«ï¼Œå®ƒä¹Ÿæ˜¯æ¥æ”¶è€…ï¼›ç¬¬äºŒä¸ªå‚æ•°_cmdæ˜¯æ–¹æ³•ç¼–å·ï¼›å‰©ä¸‹çš„å¯å˜å‚æ•°åˆ—è¡¨æ˜¯æ–¹æ³•è‡ªå·±çš„å‚æ•°ã€‚ ç®€å•è¯´æ˜ä¸€ä¸‹ï¼š idæŒ‡çš„æ˜¯OCå¯¹è±¡ï¼Œæ¯ä¸ªå¯¹è±¡åœ¨å†…å­˜çš„ç»“æ„éƒ½æ˜¯ä¸ç¡®å®šçš„ï¼Œä½†å…¶é¦–åœ°å€æŒ‡å‘çš„æ˜¯å¯¹è±¡çš„isaï¼Œé€šè¿‡isaï¼Œåœ¨è¿è¡Œæ—¶å°±èƒ½è·å–åˆ°objc_class objc_classè¡¨ç¤ºå¯¹è±¡çš„Classï¼Œå®ƒçš„ç»“æ„åœ¨ç¼–è¯‘åå°±ç¡®å®šäº† SELè¡¨ç¤ºé€‰æ‹©å™¨ï¼Œé€šå¸¸å¯ç†è§£ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ã€‚OCåœ¨è¿è¡Œæ—¶ç»´æŠ¤ç€ä¸€å¼ SELè¡¨ï¼Œå°†å­—ç¬¦ä¸²ç›¸åŒçš„æ–¹æ³•åæ˜ å°„åˆ°å”¯ä¸€ä¸€ä¸ªSELä¸Š ä»»æ„ç±»çš„ç›¸åŒæ–¹æ³•åæ˜ å°„çš„SELéƒ½ç›¸åŒï¼ˆå¯ä»¥æŠŠSELè¿‘ä¼¼åœ°ç­‰åŒäºæ–¹æ³•åï¼‰ å¯ä»¥é€šè¿‡sel_registerName(char *name)è¿™ä¸ªCå‡½æ•°å¾—åˆ°SELï¼ŒOCä¹Ÿæä¾›äº†ä¸€ä¸ªè¯­æ³•ç³–@selectorç”¨æ¥æ–¹ä¾¿çš„è°ƒç”¨è¯¥å‡½æ•° IMPæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆã€‚OCä¸­çš„æ–¹æ³•æœ€ç»ˆéƒ½ä¼šè½¬æ¢æˆçº¯Cçš„å‡½æ•°ï¼ŒIMPè¡¨ç¤ºçš„å°±æ˜¯è¿™äº›å‡½æ•°çš„åœ°å€ã€‚ å¦‚æœå¤–éƒ¨å®šä¹‰äº†Cå‡½æ•°å¹¶è°ƒç”¨å¦‚void fly() {}ï¼Œåœ¨clangç¼–è¯‘ä¹‹åè¿˜æ˜¯fly()è€Œä¸æ˜¯é€šè¿‡objc_msgSendå»è°ƒç”¨ã€‚å› ä¸ºå‘é€æ¶ˆæ¯å°±æ˜¯æ‰¾å‡½æ•°å®ç°çš„è¿‡ç¨‹ï¼Œè€ŒCå‡½æ•°å¯ä»¥é€šè¿‡å‡½æ•°åâ€”â€”æŒ‡é’ˆå°±å¯ä»¥æ‰¾åˆ° ä»ä¸Šé¢çš„ä¾‹å­å¯ä»¥å¾—å‡ºä¸€ä¸ªç»“è®ºï¼šæ–¹æ³•è°ƒç”¨çš„æœ¬è´¨æ˜¯é€šè¿‡objc_msgSendå‡½æ•°ï¼Œå‘è°ƒç”¨è€…å‘é€åä¸ºSELçš„æ¶ˆæ¯ï¼Œæ‰¾åˆ°å…·ä½“çš„å‡½æ•°åœ°å€IMPï¼Œè¿›è€Œæ‰§è¡Œè¯¥å‡½æ•°ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸‹é¢çš„ä¸¤æ®µä»£ç å®é™…ä¸Šæ•ˆæœæ˜¯ç›¸åŒçš„ è¦æƒ³ä½¿ç”¨ objc_msgSend å‡½æ•°ï¼Œéœ€è¦æ”¹ä¸€å¤„è®¾ç½®ã€‚å¦‚ä¸‹å›¾ï¼š 2.4å‘ä¸åŒå¯¹è±¡å‘é€æ¶ˆæ¯1234567891011121314151617#import &lt;Foundation/Foundation.h&gt;#import &lt;objc/message.h&gt;@interface FXFather: NSObject- (void)walk;+ (void)run;@end@implementation FXFather- (void)walk { NSLog(@&quot;%s&quot;,__func__); }+ (void)run { NSLog(@&quot;%s&quot;,__func__); }@end@interface FXSon: FXFather- (void)jump;+ (void)swim;@end å­ç±»FXSonæœ‰å®ä¾‹æ–¹æ³•jumpã€ç±»æ–¹æ³•swim çˆ¶ç±»FXFatheræœ‰å®ä¾‹æ–¹æ³•walkã€ç±»æ–¹æ³•run â‘ å‘é€å®ä¾‹æ–¹æ³• æ¶ˆæ¯æ¥æ”¶è€…â€”â€”å®ä¾‹å¯¹è±¡ 12FXSon *s = [FXSon new];objc_msgSend(s, sel_registerName(&quot;jump&quot;)); â‘¡å‘é€ç±»æ–¹æ³• æ¶ˆæ¯æ¥æ”¶è€…â€”â€”ç±»å¯¹è±¡ 1objc_msgSend(objc_getClass(&quot;FXSon&quot;), sel_registerName(&quot;swim&quot;)); â‘¢å‘çˆ¶ç±»å‘é€å®ä¾‹æ–¹æ³• objc_msgSendä¸èƒ½å‘çˆ¶ç±»å‘é€æ¶ˆæ¯ï¼Œéœ€è¦ä½¿ç”¨objc_msgSendSuperï¼Œå¹¶ç»™objc_superç»“æ„ä½“èµ‹å€¼ï¼ˆåœ¨objc2ä¸­åªéœ€è¦èµ‹å€¼receiverã€super_classï¼‰ 123456789101112131415/// Specifies the superclass of an instance. struct objc_super { /// Specifies an instance of a class. __unsafe_unretained _Nonnull id receiver; /// Specifies the particular superclass of the instance to message. #if !defined(__cplusplus) &amp;&amp; !__OBJC2__ /* For compatibility with old objc-runtime.h header */ __unsafe_unretained _Nonnull Class class;#else __unsafe_unretained _Nonnull Class super_class;#endif /* super_class is the first class to search */};#endif receiverâ€”â€”å®ä¾‹å¯¹è±¡ï¼›super_classâ€”â€”çˆ¶ç±»ç±»å¯¹è±¡ 1234struct objc_super superInstanceMethod;superInstanceMethod.receiver = s;superInstanceMethod.super_class = objc_getClass(&quot;FXFather&quot;);objc_msgSendSuper(&amp;superInstanceMethod, sel_registerName(&quot;walk&quot;)); â‘£å‘çˆ¶ç±»å‘é€ç±»æ–¹æ³• receiverâ€”â€”ç±»å¯¹è±¡ï¼›super_classâ€”â€”çˆ¶ç±»å…ƒç±»å¯¹è±¡ 1234struct objc_super superClassMethod;superClassMethod.receiver = [s class];superClassMethod.super_class = class_getSuperclass(object_getClass([s class]));objc_msgSendSuper(&amp;superClassMethod, sel_registerName(&quot;run&quot;)); ä¸‰ã€æ¶ˆæ¯æŸ¥æ‰¾æµç¨‹æ–¹æ³•çš„æŸ¥æ‰¾ï¼Œä¹Ÿå«æ¶ˆæ¯çš„æŸ¥æ‰¾ï¼Œå®ƒçš„å‡†å¤‡å·¥ä½œæ˜¯ä»objc_msgSendå¼€å§‹ï¼Œå‡†å¤‡å°±ç»ªåï¼Œæ‰ä¼šå±•å¼€æŸ¥æ‰¾ã€‚ 3.1å¼€å§‹æŸ¥æ‰¾æ‰“å¼€objcæºç ï¼Œç”±äºä¸»è¦ç ”ç©¶arm64ç»“æ„çš„æ±‡ç¼–å®ç°ï¼Œæ¥åˆ°objc-msg-arm64.sï¼š æ‰¾åˆ°objc_msgSendçš„æºç ï¼š 1id objc_msgSend(id self, SEL _cmd, ...); p0è¡¨ç¤º0å¯„å­˜å™¨çš„æŒ‡é’ˆï¼Œx0è¡¨ç¤ºå®ƒçš„å€¼ï¼Œw0è¡¨ç¤ºä½32ä½çš„å€¼ï¼ˆä¸ç”¨è¿‡å¤šåœ¨æ„ï¼‰ â‘ å¼€å§‹objc_msgSend â‘¡åˆ¤æ–­æ¶ˆæ¯æ¥æ”¶è€…æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºç›´æ¥è¿”å› â‘¢åˆ¤æ–­tagged_pointersï¼ˆä¹‹åä¼šè®²åˆ°ï¼‰ â‘£å–å¾—å¯¹è±¡ä¸­çš„isaå­˜ä¸€ä»½åˆ°p13ä¸­ï¼ˆå¯„å­˜å™¨æŒ‡ä»¤åœ¨é€†å‘ç¯‡ä¸­ä¼šè®²åˆ°ï¼‰ â‘¤æ ¹æ®isaè¿›è¡Œmaskåœ°å€åç§»å¾—åˆ°å¯¹åº”çš„ä¸Šçº§å¯¹è±¡ï¼ˆç±»ã€å…ƒç±»ï¼‰ æŸ¥çœ‹GetClassFromIsa_p16æºç ï¼š 1.macro GetClassFromIsa_p16 ä¸»è¦å°±æ˜¯è¿›è¡Œisa &amp; maskå¾—åˆ°classæ“ä½œ â‘¥å¼€å§‹åœ¨ç¼“å­˜ä¸­æŸ¥æ‰¾impâ€”â€”å¼€å¯å¿«é€Ÿæµç¨‹ 3.2å¿«é€Ÿæµç¨‹ä»CacheLookupå¼€å§‹å¿«é€ŸæŸ¥æ‰¾æµç¨‹ï¼ˆæ­¤æ—¶x0æ˜¯selï¼Œx16æ˜¯classï¼‰ï¼Œæ¨¡å¼æ˜¯NORMALã€‚ 1.macro CacheLookup â‘ #CACHEæ˜¯ä¸ªå®å®šä¹‰è¡¨ç¤º16ä¸ªå­—èŠ‚ï¼Œ[x16, #CACHE]è¡¨ç¤ºç±»å¯¹è±¡å†…å­˜åœ°å€åç§»16å­—èŠ‚å¾—åˆ°cacheã€‚ cacheä¸€åˆ†ä¸ºäºŒï¼š8å­—èŠ‚çš„bucketså­˜æ”¾åœ¨p10ï¼Œä¸¤ä¸ª4å­—èŠ‚çš„occupiedå’Œmaskå­˜æ”¾åœ¨p11 12#define CLASS __SIZEOF_POINTER__#define CACHE (2 * __SIZEOF_POINTER__) â‘¡x1æ˜¯selå³cmdï¼Œå–å‡ºp11ä¸­çš„ä½32ä½ï¼ˆw11ï¼‰ï¼šmaskï¼Œä¸¤è€…è¿›è¡Œä¸è¿ç®—å¾—åˆ°hashä¸‹æ ‡ å­˜æ”¾åœ¨x12 â‘¢p12å…ˆå·¦ç§»åŠ¨(1+PTRSHIFT)ï¼Œå†ä¸p10bucketsç›¸åŠ å¾—åˆ°æ–°çš„p12â€”â€”bucket â‘£æ‹¿å‡ºp12bucketåœ°å€æ‰€åœ¨çš„å€¼ï¼Œæ”¾åœ¨p17impå’Œp9selä¸­ï¼Œè¿™ç‚¹å¯ä»¥ä»bucket_tçš„ç»“æ„ä¸­çœ‹å‡ºï¼ˆselå¼ºè½¬æˆkeyï¼‰ç”¨bucketä¸­çš„selä¸x1cmdä½œå¯¹æ¯”ï¼Œå¦‚æœç›¸åŒåˆ™ç¼“å­˜å‘½ä¸­CacheHitå¾—åˆ°å…¶ä¸­çš„impï¼›å¦‚æœä¸ç­‰å°±è·³è½¬ 12345678910111213struct bucket_t {private: // IMP-first is better for arm64e ptrauth and no worse for arm64. // SEL-first is better for armv7* and i386 and x86_64.#if __arm64__ MethodCacheIMP _imp; cache_key_t _key;#else cache_key_t _key; MethodCacheIMP _imp;#endif ...} â‘¤å¦‚æœbucket-&gt;sel == 0åˆ™CheckMissï¼›æ¯”è¾ƒp12bucketå’Œp10bucketsï¼Œå¦‚æœä¸ç›¸ç­‰å°±å°†x12bucketçš„å€¼è¿›è¡Œè‡ªå‡æ“ä½œï¼ˆæŸ¥æ‰¾ä¸Šä¸€ä¸ªbucketï¼‰ï¼Œè·³è½¬å›â‘£é‡æ–°å¾ªç¯ï¼Œç›´åˆ°bucket == bucketséå†ç»“æŸè·³è½¬â‘¥ 123456789101112.macro CheckMiss // miss if bucket-&gt;sel == 0.if $0 == GETIMP cbz p9, LGetImpMiss.elseif $0 == NORMAL cbz p9, __objc_msgSend_uncached.elseif $0 == LOOKUP cbz p9, __objc_msgLookup_uncached.else.abort oops.endif.endmacro â‘¥å¹³ç§»å“ˆå¸Œä½¿å¾—p12 = first bucketï¼Œå†é‡å¤è¿›è¡Œä¸€ä¸‹ç±»ä¼¼â‘£â‘¤â‘¥çš„æ“ä½œï¼š é˜²æ­¢ä¸æ–­å¾ªç¯çš„è¿‡ç¨‹ä¸­å¤šçº¿ç¨‹å¹¶å‘çš„æ—¶å€™æ­£å¥½ç¼“å­˜æ›´æ–°äº†ã€‚ å¦‚æœbucket-&gt;sel == 0èµ°CheckMissï¼Œå¦‚æœbucket == bucketsèµ°JumpMissï¼Œæœ¬è´¨æ˜¯ä¸€æ ·çš„ 1234567891011.macro JumpMiss.if $0 == GETIMP b LGetImpMiss.elseif $0 == NORMAL b __objc_msgSend_uncached.elseif $0 == LOOKUP b __objc_msgLookup_uncached.else.abort oops.endif.endmacro å½“NORMALæ—¶ï¼ŒCheckMisså’ŒJumpMisséƒ½èµ°__objc_msgSend_uncached â‘¦__objc_msgSend_uncachedè°ƒç”¨MethodTableLookup â‘§ä¿å­˜å‚æ•°è°ƒç”¨c++æ–¹æ³•è¿›å…¥æ…¢é€Ÿæµç¨‹ 1.macro MethodTableLookup å¿«é€ŸæŸ¥æ‰¾çš„è¿‡ç¨‹ç®€è¦æ€»ç»“: å¿«é€ŸæŸ¥æ‰¾å®Œæ•´æµç¨‹å›¾ï¼š 3.3æ…¢é€ŸæŸ¥æ‰¾æ±‡ç¼–__class_lookupMethodAndLoadCache3ä¸c++ä¸­_class_lookupMethodAndLoadCache3ç›¸å¯¹åº” 12345IMP _class_lookupMethodAndLoadCache3(id obj, SEL sel, Class cls){ return lookUpImpOrForward(cls, sel, obj, YES/*initialize*/, NO/*cache*/, YES/*resolver*/);} 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128// initialize = YES , cache = NO , resolver = YESIMP lookUpImpOrForward(Class cls, SEL sel, id inst, bool initialize, bool cache, bool resolver){ IMP imp = nil; bool triedResolver = NO; runtimeLock.assertUnlocked(); // ç¼“å­˜æŸ¥æ‰¾ï¼Œcacheä¸ºNOç›´æ¥è·³è¿‡ if (cache) { imp = cache_getImp(cls, sel); if (imp) return imp; } // runtimeLock is held during isRealized and isInitialized checking // to prevent races against concurrent realization. // runtimeLock is held during method search to make // method-lookup + cache-fill atomic with respect to method addition. // Otherwise, a category could be added but ignored indefinitely because // the cache was re-filled with the old value after the cache flush on // behalf of the category. // lockæ˜¯ä¸ºäº†é˜²æ­¢å¤šçº¿ç¨‹æ“ä½œï¼› ç±»æ˜¯å¦è¢«ç¼–è¯‘ runtimeLock.lock(); checkIsKnownClass(cls); // ä¸ºæŸ¥æ‰¾æ–¹æ³•åšå‡†å¤‡æ¡ä»¶ï¼Œå¦‚æœç±»æ²¡æœ‰åˆå§‹åŒ–æ—¶ï¼Œåˆå§‹åŒ–ç±»å’Œçˆ¶ç±»ã€å…ƒç±»ç­‰ if (!cls-&gt;isRealized()) { realizeClass(cls); } if (initialize &amp;&amp; !cls-&gt;isInitialized()) { runtimeLock.unlock(); _class_initialize (_class_getNonMetaClass(cls, inst)); runtimeLock.lock(); // If sel == initialize, _class_initialize will send +initialize and // then the messenger will send +initialize again after this // procedure finishes. Of course, if this is not being called // from the messenger then it won't happen. 2778172 } retry: runtimeLock.assertLocked(); // Try this class's cache. // ä»ç¼“å­˜é‡Œé¢æŸ¥æ‰¾ä¸€éï¼Œè‹¥æœ‰ç›´æ¥goto done imp = cache_getImp(cls, sel); if (imp) goto done; // Try this class's method lists. // å½¢æˆå±€éƒ¨ä½œç”¨åŸŸï¼Œé¿å…å±€éƒ¨å˜é‡å‘½åé‡å¤ { // åœ¨ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾æ–¹æ³•ï¼Œè‹¥æœ‰ç›´æ¥cache_fill Method meth = getMethodNoSuper_nolock(cls, sel); if (meth) { log_and_fill_cache(cls, meth-&gt;imp, sel, inst, cls); imp = meth-&gt;imp; goto done; } } // Try superclass caches and method lists. { unsigned attempts = unreasonableClassCount(); // éå†çˆ¶ç±»è¿›è¡ŒæŸ¥æ‰¾ for (Class curClass = cls-&gt;superclass; curClass != nil; curClass = curClass-&gt;superclass) { // Halt if there is a cycle in the superclass chain. if (--attempts == 0) { _objc_fatal(&quot;Memory corruption in class list.&quot;); } // Superclass cache. // åœ¨çˆ¶ç±»ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œè‹¥æœ‰ç›´æ¥cache_fill imp = cache_getImp(curClass, sel); if (imp) { if (imp != (IMP)_objc_msgForward_impcache) { // Found the method in a superclass. Cache it in this class. log_and_fill_cache(cls, imp, sel, inst, curClass); goto done; } else { // Found a forward:: entry in a superclass. // Stop searching, but don't cache yet; call method // resolver for this class first. break; } } // Superclass method list. // åœ¨çˆ¶ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾æ–¹æ³•ï¼Œè‹¥æœ‰ç›´æ¥cache_fill Method meth = getMethodNoSuper_nolock(curClass, sel); if (meth) { log_and_fill_cache(cls, meth-&gt;imp, sel, inst, curClass); imp = meth-&gt;imp; goto done; } } } // No implementation found. Try method resolver once. // å¦‚æœæ–¹æ³•ä»ç„¶æ²¡æ‰¾åˆ°ï¼Œå°±å¼€å§‹åšåŠ¨æ€æ–¹æ³•è§£æ if (resolver &amp;&amp; !triedResolver) { runtimeLock.unlock(); _class_resolveMethod(cls, sel, inst); // âœ… runtimeLock.lock(); // Don't cache the result; we don't hold the lock so it may have // changed already. Re-do the search from scratch instead. triedResolver = YES; goto retry; } // No implementation found, and method resolver didn't help. // Use forwarding. // å¼€å§‹æ¶ˆæ¯è½¬å‘ imp = (IMP)_objc_msgForward_impcache; cache_fill(cls, sel, imp, inst); done: runtimeLock.unlock(); return imp;} æ…¢é€Ÿæµç¨‹ä¸»è¦åˆ†ä¸ºå‡ ä¸ªæ­¥éª¤ï¼š â‘ _class_lookupMethodAndLoadCache3è°ƒç”¨lookUpImpOrForwardï¼Œæ­¤æ—¶å‚æ•°initialize=YES cache=NO resolver=YES â‘¡runtimeLock.lock()ä¸ºäº†é˜²æ­¢å¤šçº¿ç¨‹æ“ä½œ â‘¢realizeClass(cls)ä¸ºæŸ¥æ‰¾æ–¹æ³•åšå‡†å¤‡æ¡ä»¶ï¼Œå¦‚æœç±»æ²¡æœ‰åˆå§‹åŒ–æ—¶ï¼Œåˆå§‹åŒ–ç±»å’Œçˆ¶ç±»ã€å…ƒç±»ç­‰ â‘£imp = cache_getImp(cls, sel)ä¸ºäº†å®¹é”™ä»ç¼“å­˜ä¸­å†æ‰¾ä¸€éï¼Œè‹¥æœ‰goto doneâ‘¨ â‘¤// Try this class's method listså±€éƒ¨ä½œç”¨åŸŸä¸­ï¼Œåœ¨ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾æ–¹æ³•ï¼Œè‹¥æœ‰ç›´æ¥log_and_fill_cacheå¹¶goto doneâ‘¨ â‘¥// Try superclass caches and method listså±€éƒ¨ä½œç”¨åŸŸä¸­ï¼Œéå†çˆ¶ç±»ï¼šå…ˆåœ¨çˆ¶ç±»ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œè‹¥æœ‰ç›´æ¥log_and_fill_cacheå¹¶goto doneï¼›æ²¡æœ‰å†å»çˆ¶ç±»çš„æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾æ–¹æ³•ï¼Œè‹¥æœ‰ç›´æ¥log_and_fill_cacheå¹¶goto doneâ‘¨ â‘¦å¦‚æœè¿˜æ²¡æ‰¾åˆ°å°±åŠ¨æ€æ–¹æ³•è§£æresolveMethodï¼Œæ ‡è®°ä¸ºtriedResolver = YESï¼ˆå·²è‡ªæˆ‘æ‹¯æ•‘è¿‡ï¼‰ã€‚åŠ¨æ€æ–¹æ³•è§£æç»“æŸåè·³è½¬æ…¢é€Ÿæµç¨‹â‘£ â‘§å¦‚æœåŠ¨æ€æ–¹æ³•è§£æå®Œæˆåå†æ‰¾ä¸€éä»ç„¶æ²¡æ‰¾åˆ°impï¼Œå°±æŠ›å‡ºé”™è¯¯_objc_msgForward_impcacheå¾—åˆ°impå¹¶cache_fill â‘¨doneï¼šå¤šçº¿ç¨‹è§£é”ï¼Œè¿”å›imp æ¥ä¸‹æ¥æ‹†è§£æ­¥éª¤è¿›è¡Œè¯´æ˜ï¼š cache_getImpè¿™ä¸ªæ–¹æ³•åç»­ä¼šè§£é‡Š getMethodNoSuper_nolockéå†è°ƒç”¨search_method_listæŸ¥æ‰¾æ–¹æ³•åˆ—è¡¨ 12345678910111213141516171819getMethodNoSuper_nolock(Class cls, SEL sel){ runtimeLock.assertLocked(); assert(cls-&gt;isRealized()); // fixme nil cls? // fixme nil sel? for (auto mlists = cls-&gt;data()-&gt;methods.beginLists(), end = cls-&gt;data()-&gt;methods.endLists(); mlists != end; ++mlists) { method_t *m = search_method_list(*mlists, sel); if (m) return m; } return nil;} search_method_liståˆ©ç”¨äºŒåˆ†æŸ¥æ‰¾å¯»æ‰¾æ–¹æ³• 1234567891011121314151617181920212223242526272829static method_t *search_method_list(const method_list_t *mlist, SEL sel){ int methodListIsFixedUp = mlist-&gt;isFixedUp(); int methodListHasExpectedSize = mlist-&gt;entsize() == sizeof(method_t); if (__builtin_expect(methodListIsFixedUp &amp;&amp; methodListHasExpectedSize, 1)) { // å¦‚æœæ–¹æ³•åˆ—è¡¨å·²ç»æ’åºå¥½äº†ï¼Œåˆ™é€šè¿‡äºŒåˆ†æŸ¥æ‰¾æ³•æŸ¥æ‰¾æ–¹æ³•ï¼Œä»¥èŠ‚çœæ—¶é—´ return findMethodInSortedMethodList(sel, mlist); } else { // Linear search of unsorted method list // å¦‚æœæ–¹æ³•åˆ—è¡¨æ²¡æœ‰æ’åºå¥½å°±éå†æŸ¥æ‰¾ for (auto&amp; meth : *mlist) { if (meth.name == sel) return &amp;meth; } }#if DEBUG // sanity-check negative results if (mlist-&gt;isFixedUp()) { for (auto&amp; meth : *mlist) { if (meth.name == sel) { _objc_fatal(&quot;linear search worked when binary search did not&quot;); } } }#endif return nil;} findMethodInSortedMethodListäºŒåˆ†æŸ¥æ‰¾ç®—æ³•çš„å…·ä½“å®ç°ï¼ˆäº†è§£å³å¯ï¼‰ 12345678910111213141516171819202122232425262728293031323334353637static method_t *findMethodInSortedMethodList(SEL key, const method_list_t *list){ assert(list); const method_t * const first = &amp;list-&gt;first; const method_t *base = first; const method_t *probe; uintptr_t keyValue = (uintptr_t)key; uint32_t count; // &gt;&gt;1 è¡¨ç¤ºå°†å˜é‡nçš„å„ä¸ªäºŒè¿›åˆ¶ä½é¡ºåºå³ç§»1ä½ï¼Œæœ€é«˜ä½è¡¥äºŒè¿›åˆ¶0 // count &gt;&gt;= 1 å¦‚æœcountä¸ºå¶æ•°åˆ™å€¼å˜ä¸º(count / 2)ï¼›å¦‚æœcountä¸ºå¥‡æ•°åˆ™å€¼å˜ä¸º(count-1) / 2 for (count = list-&gt;count; count != 0; count &gt;&gt;= 1) { probe = base + (count &gt;&gt; 1); // å–å‡ºä¸­é—´method_tçš„nameï¼Œä¹Ÿå°±æ˜¯SEL uintptr_t probeValue = (uintptr_t)probe-&gt;name; if (keyValue == probeValue) { // `probe` is a match. // Rewind looking for the *first* occurrence of this value. // This is required for correct category overrides. // ç»§ç»­å‘å‰äºŒåˆ†æŸ¥è¯¢ while (probe &gt; first &amp;&amp; keyValue == (uintptr_t)probe[-1].name) { probe--; } // å–å‡º probe return (method_t *)probe; } // å¦‚æœkeyValue &gt; probeValue åˆ™æŠ˜åŠå‘åæŸ¥è¯¢ if (keyValue &gt; probeValue) { base = probe + 1; count--; } } return nil;} log_and_fill_cache-&gt;cache_fill-&gt;cache_fill_nolockè¿›è¡Œç¼“å­˜ 12345678910111213log_and_fill_cache(Class cls, IMP imp, SEL sel, id receiver, Class implementer){#if SUPPORT_MESSAGE_LOGGING if (objcMsgLogEnabled) { bool cacheIt = logMessageSend(implementer-&gt;isMetaClass(), cls-&gt;nameForLogging(), implementer-&gt;nameForLogging(), sel); if (!cacheIt) return; }#endif cache_fill (cls, sel, imp, receiver);} resolveMethodåŠ¨æ€æ–¹æ³•è§£æâ€”â€”åœ¨æ‰¾ä¸åˆ°impæ—¶çš„è‡ªæˆ‘æ‹¯æ•‘æ“ä½œ ä¸»è¦é€»è¾‘æ˜¯æ˜¯objc_msgSendå‡½æ•°å‘é€SEL_resolveInstanceMethodæ¶ˆæ¯ï¼Œç³»ç»Ÿè°ƒç”¨resolveInstanceMethod å‘é€æ¶ˆæ¯åï¼Œç³»ç»Ÿä¼šå†æŸ¥æ‰¾ä¸€ä¸‹selæ–¹æ³• 123456789101112131415161718void _class_resolveMethod(Class cls, SEL sel, id inst){ if (! cls-&gt;isMetaClass()) { // try [cls resolveInstanceMethod:sel] _class_resolveInstanceMethod(cls, sel, inst); } else { // try [nonMetaClass resolveClassMethod:sel] // and [cls resolveInstanceMethod:sel] _class_resolveClassMethod(cls, sel, inst); if (!lookUpImpOrNil(cls, sel, inst, NO/*initialize*/, YES/*cache*/, NO/*resolver*/)) { _class_resolveInstanceMethod(cls, sel, inst); } }} _objc_msgForward_impcacheåœ¨æ±‡ç¼–ä¸­è°ƒç”¨äº†_objc_msgForwardï¼Œç„¶ååˆè¿›å…¥_objc_forward_handlerï¼Œå®ƒåœ¨c++è°ƒç”¨äº†objc_defaultForwardHandler 123456789void *_objc_forward_handler = (void*)objc_defaultForwardHandler;objc_defaultForwardHandler(id self, SEL sel){ _objc_fatal(&quot;%c[%s %s]: unrecognized selector sent to instance %p &quot; &quot;(no message forward handler is installed)&quot;, class_isMetaClass(object_getClass(self)) ? '+' : '-', object_getClassName(self), sel_getName(sel), self);} åŸæ¥unrecognized selector sent to instance xxxæ˜¯è¿™ä¹ˆæ¥çš„å•Šâ€¦ æ…¢é€ŸæŸ¥æ‰¾çš„è¿‡ç¨‹ç®€è¦æ€»ç»“: æ…¢é€ŸæŸ¥æ‰¾å®Œæ•´æµç¨‹å›¾ï¼š å››ã€æ€»ç»“æ¥åˆ°è¿™é‡Œï¼Œå·²ç»æŠŠæ¶ˆæ¯çš„æŸ¥æ‰¾ä»‹ç»å®Œæ¯•ï¼Œæ˜¯æ—¶å€™æ€»ç»“ä¸€ä¸‹äº†ã€‚ 4.1æ–¹æ³•è°ƒç”¨çš„æœ¬è´¨ æ–¹æ³•çš„è°ƒç”¨ä¼šè¢«ç¼–è¯‘å™¨ç¿»è¯‘æˆobjc_msgSendã€objc_msgSendSuperã€objc_msgSend_stretå’Œobjc_msgSendSuper_stretè¿™å››ä¸ªå‡½æ•°ä¹‹ä¸€ï¼Œè¿™å››ä¸ªå‡½æ•°éƒ½æ˜¯ç”±æ±‡ç¼–ä»£ç å®ç°çš„ã€‚ å¦‚æœæ˜¯ä»¥æ•°æ®ç»“æ„ä½“ä½œä¸ºè¿”å›å€¼çš„æ–¹æ³•ï¼Œæœ€ç»ˆä¼šè½¬æ¢æˆç›¸åº”çš„objc_msgSend_stretæˆ–objc_msgSendSuper_stretå‡½æ•° ä½¿ç”¨superå…³é”®å­—è°ƒç”¨æ–¹æ³•æ—¶ï¼Œæ˜¯ä½¿ç”¨objc_msgSendSuperå‘é€çš„ å…¶ä»–çš„æ–¹æ³•è°ƒç”¨æ˜¯ä½¿ç”¨objc_msgSendå‡½æ•°å‘é€æ¶ˆæ¯çš„ã€‚ æ–¹æ³•çš„è°ƒç”¨æ˜¯é€šè¿‡objc_msgSendï¼ˆæˆ–objc_msgSendSuperï¼Œæˆ–objc_msgSend_stretï¼Œæˆ–objc_msgSendSuper_stretï¼‰å‡½æ•°ï¼Œå‘è°ƒç”¨è€…å‘é€åä¸ºSELçš„æ¶ˆæ¯ï¼Œæ‰¾åˆ°å…·ä½“çš„å‡½æ•°åœ°å€IMPï¼Œè¿›è€Œæ‰§è¡Œè¯¥å‡½æ•°ã€‚ 4.2æ–¹æ³•çš„æŸ¥æ‰¾æ–¹æ³•çš„æŸ¥æ‰¾æµç¨‹å¦‚ä¸‹ï¼š 1.ä»objc_msgSendæºç å¼€å§‹ï¼Œä¼šå…ˆå» ç±»ï¼ˆå®ä¾‹æ–¹æ³•ï¼‰/å…ƒç±»ï¼ˆç±»æ–¹æ³•ï¼‰ çš„ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°IMPåˆ™è¿”å›å¹¶è°ƒç”¨ï¼Œå¦åˆ™ä¼šå» ç±»/å…ƒç±» çš„æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾ 2.â€œæ­¥éª¤1â€ä¸­çš„â€œç¼“å­˜+æ–¹æ³•åˆ—è¡¨â€çš„æŸ¥æ‰¾æ–¹æ¡ˆï¼Œä¼šéå†ç±»çš„ç»§æ‰¿ä½“ç³»ï¼ˆç±»ã€ç±»çš„çˆ¶ç±»ã€â€¦ã€æ ¹ç±»ï¼‰ï¼Œåˆ†åˆ«è¿›è¡ŒæŸ¥æ‰¾ï¼Œç›´è‡³æ‰¾åˆ°IMPä¸ºæ­¢ã€‚ å¦‚æœåœ¨å½“å‰ç±»çš„ç¼“å­˜ä¸­æ²¡æ‰¾åˆ°ï¼Œä½†æ˜¯åœ¨å…¶æ–¹æ³•åˆ—è¡¨ï¼ˆæˆ–å…¶â€œçˆ¶ç±»â€¦æ ¹ç±»â€çš„ç¼“å­˜æˆ–æ–¹æ³•åˆ—è¡¨ï¼‰ä¸­æ‰¾åˆ°äº†IMPï¼Œéœ€è¦è¿›è¡Œä¸€æ¬¡æ˜¯å¦æ˜¯æ¶ˆæ¯è½¬å‘çš„åˆ¤æ–­ï¼Œå¦‚æœä¸æ˜¯æ¶ˆæ¯è½¬å‘ï¼Œé‚£ä¹ˆå°±å¯¹å½“å‰ç±»çš„ç¼“å­˜è¿›è¡Œå¡«å……æ“ä½œï¼Œæ–¹ä¾¿ä¸‹æ¬¡è°ƒç”¨æ—¶çš„æŸ¥æ‰¾ï¼›å¦‚æœæ˜¯æ¶ˆæ¯è½¬å‘ï¼Œåˆ™ä¸ä¼šç¼“å­˜åˆ°å½“å‰ç±»ä¸­ 3.å¦‚æœéå†ç»“æŸåä¾ç„¶æœªæ‰¾åˆ°IMPï¼Œåˆ™ä¼šå¯åŠ¨æ¶ˆæ¯çš„è§£ææˆ–è½¬å‘ã€‚ äº”ã€é—®é¢˜è®¨è®º5.1objc_msgSendä¸ºä»€ä¹ˆè¦ç”¨æ±‡ç¼–ç¼–å†™ï¼ŸAï¼šåŸå› å¤§è‡´æœ‰ä»¥ä¸‹å‡ ç‚¹ Cè¯­è¨€æ˜¯é™æ€è¯­è¨€ï¼Œæ— æ³•å®ç°å‚æ•°ä¸ªæ•°ã€ç±»å‹æœªçŸ¥çš„æƒ…å†µä¸‹è·³è½¬åˆ°å¦ä¸€ä¸ªä»»æ„çš„å‡½æ•°å®ç°çš„åŠŸèƒ½ï¼›è€Œæ±‡ç¼–çš„å¯„å­˜å™¨å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ æ±‡ç¼–æ‰§è¡Œæ•ˆç‡æ¯”Cè¯­è¨€çš„é«˜ ä½¿ç”¨æ±‡ç¼–å¯ä»¥æœ‰æ•ˆé˜²æ­¢ç³»ç»Ÿå‡½æ•°è¢«hookï¼Œå› æ­¤æ›´ä¸ºå®‰å…¨ã€‚ 5.2ä¸ºä»€ä¹ˆç´¢å¼•å€¼è¦å·¦ç§»1 + PTRSHIFTä½ï¼ŸAï¼šåœ¨objc4-756.2æºç ä¸­æ‰¾åˆ°ç­”æ¡ˆï¼Œä½†æ˜¯åœ¨objc4-779.1æºç ç‰ˆæœ¬çš„cache_tç»“æ„ä¸­ï¼Œå­˜åœ¨å…³äºè¿™ä¸ªé—®é¢˜çš„è§£é‡Šã€‚å…¶éƒ¨åˆ†æºç å¦‚ä¸‹ï¼š 12345678910111213// How much the mask is shifted by.static constexpr uintptr_t maskShift = 48; // Additional bits after the mask which must be zero. msgSend// takes advantage of these additional bits to construct the value// `mask &lt;&lt; 4` from `_maskAndBuckets` in a single instruction.static constexpr uintptr_t maskZeroBits = 4; // The largest mask value we can store.static constexpr uintptr_t maxMask = ((uintptr_t)1 &lt;&lt; (64 - maskShift)) - 1; // The mask applied to `_maskAndBuckets` to retrieve the buckets pointer.static constexpr uintptr_t bucketsMask = ((uintptr_t)1 &lt;&lt; (maskShift - maskZeroBits)) - 1; æ€»çš„æ¥è¯´ï¼Œåœ¨64ä½ä¸­ï¼Œmaskçš„åç§»å€¼ä¸º48ï¼Œä¹Ÿå°±æ˜¯æœ€é«˜çš„16ä½å­˜å‚¨maskï¼›æ¥ç€çš„44ä½æ˜¯bucketsæŒ‡é’ˆåœ°å€ï¼Œæœ€ä½çš„4ä½æ˜¯é™„åŠ ä½ï¼Œå³ bucketsçš„æœ‰æ•ˆæŒ‡é’ˆåœ°å€ä»…ä»…æ˜¯64ä½ä¸­çš„[4, 47]ä½ã€‚åœ¨CacheLookupæºç ä¸­ï¼Œç”±_cmd &amp; maskå“ˆå¸Œè¿ç®—å¯ä»¥å¾—åˆ°ç´¢å¼•å€¼ï¼ˆç´¢å¼•å€¼ &lt; ((1 &lt;&lt; 16) - 1)ï¼‰ï¼Œå¦‚æœæƒ³å¾—åˆ°è¿™ä¸ªä½ç½®çš„bucketï¼Œå…¶ç´¢å¼•å€¼å¿…é¡»å·¦ç§»4ä½åï¼Œæ‰èƒ½ä¸bucketsæŒ‡é’ˆåœ°å€ç›¸åŠ å¾—åˆ°æ­£ç¡®çš„bucketåœ°å€ã€‚ å‚è€ƒ Objective-C ä¸­çš„æ¶ˆæ¯ä¸æ¶ˆæ¯è½¬å‘ Objective-Cåº•å±‚æ±‡æ€» https://juejin.cn/post/6844904118973104135#heading-0 OCæºç åˆ†æä¹‹æ–¹æ³•çš„æŸ¥æ‰¾åŸç† æ¶ˆæ¯æŸ¥æ‰¾æµç¨‹ iOSæ¢ç´¢ æ–¹æ³•çš„æœ¬è´¨å’Œæ¶ˆæ¯æŸ¥æ‰¾æµç¨‹","link":"/2020/12/29/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/05-%20%E6%96%B9%E6%B3%95%E7%9A%84%E6%9C%AC%E8%B4%A8%E5%92%8C%E6%B6%88%E6%81%AF%E6%9F%A5%E6%89%BE%E6%B5%81%E7%A8%8B/"},{"title":"03-å¯¹è±¡&amp;ç±»çš„ç»“æ„","text":"ä¸€ã€å¯¹è±¡&amp;ç±»çš„ç»“æ„1.1 è§£è¯»ç±»çš„æœ¬è´¨ä»NSObjectç±»çš„å®šä¹‰å¼€å§‹ 123456789OBJC_AVAILABLE(10.0, 2.0, 9.0, 1.0, 2.0)OBJC_ROOT_CLASSOBJC_EXPORT@interface NSObject &lt;NSObject&gt; {#pragma clang diagnostic push#pragma clang diagnostic ignored &quot;-Wobjc-interface-ivars&quot; Class isa OBJC_ISA_AVAILABILITY;#pragma clang diagnostic pop} æ³¨æ„ï¼šNSObjectæœ‰ä¸ªClassç±»å‹çš„isaæˆå‘˜å˜é‡ æ¥ä¸‹æ¥ç”¨Clangç¼–è¯‘main.mï¼Œè¾“å‡º.cppæ–‡ä»¶ï¼Œçœ‹ä¸€ä¸‹NSObjectç±»çš„åº•å±‚å®šä¹‰ 1clang -x objective-c -rewrite-objc -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk main.m æ‰“å¼€main.cppæ–‡ä»¶ï¼Œæ‰¾åˆ°äº†NSObject 123456789#ifndef _REWRITER_typedef_NSObject#define _REWRITER_typedef_NSObjecttypedef struct objc_object NSObject;typedef struct {} _objc_exc_NSObject;#endifstruct NSObject_IMPL { Class isa;}; å‘ç°NSObjectç±»æœ¬è´¨ä¸Šæ˜¯objc_objectç»“æ„ä½“ï¼ŒåŒæ—¶æœ‰å®šä¹‰ä¸€ä¸ªNSObject_IMPLç»“æ„ä½“ï¼ˆIMPLæ˜¯implementationçš„ç¼©å†™ï¼‰ï¼Œé‡Œé¢æœ‰NSObjectç±»çš„isaæˆå‘˜å˜é‡ã€‚ ç°åœ¨æŠŠæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„Personç±»ç”¨clangç¼–è¯‘æˆc++çœ‹ä¸€ä¸‹ã€‚æˆ‘ä»¬å®šä¹‰çš„Personç±»ï¼š(æœ‰ä¸ªageå±æ€§å’Œrunæ–¹æ³•) 123456789101112131415@interface Person : NSObject@property (nonatomic) NSInteger age;- (void)run;@end@implementation Person- (void)run { NSLog(@&quot;I am running.&quot;);}@end ç¼–è¯‘æˆc++åï¼š 123456789101112131415161718#ifndef _REWRITER_typedef_Person#define _REWRITER_typedef_Persontypedef struct objc_object Person;typedef struct {} _objc_exc_Person;#endifextern &quot;C&quot; unsigned long OBJC_IVAR_$_Person$_age;struct Person_IMPL { struct NSObject_IMPL NSObject_IVARS; NSInteger _age;};static void _I_Person_run(Person * self, SEL _cmd) { NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_mc_9fhhprrj4k92vxzqm3g127z40000gn_T_main_09fc70_mi_0);}static NSInteger _I_Person_age(Person * self, SEL _cmd) { return (*(NSInteger *)((char *)self + OBJC_IVAR_$_Person$_age)); }static void _I_Person_setAge_(Person * self, SEL _cmd, NSInteger age) { (*(NSInteger *)((char *)self + OBJC_IVAR_$_Person$_age)) = age; } å¯è§ï¼ŒPersonç±»æœ¬è´¨åŒæ ·æ˜¯objc_objectç»“æ„ä½“ç±»å‹ï¼ŒPerson_IMPLç»“æ„ä½“å†…éƒ¨å¤šäº†ä¸ªstruct NSObject_IMPLç±»å‹çš„NSObject_IVARSæˆå‘˜å˜é‡â€”â€”å³ç»§æ‰¿è‡ªNSObjectçš„ç±»ï¼Œéƒ½æœ‰ä¸ªClassç±»å‹çš„isaæˆå‘˜å˜é‡ã€‚ 1.2 objc_objectç»“æ„æºç ï¼š 12345678910111213141516171819202122struct objc_object {private: isa_t isa; public: ... // ä¸€äº›å‡½æ•°};union isa_t { isa_t() { } isa_t(uintptr_t value) : bits(value) { } Class cls; uintptr_t bits;#if defined(ISA_BITFIELD) struct { ISA_BITFIELD; // defined in isa.h };#endif}; å…³äºisa_tçš„åˆ†æè§ä¸Šç¯‡æ–‡ç«  objc_objectç»“æ„ä½“å†…éƒ¨çš„æ–¹æ³•æœ‰äº”åä¸ªå·¦å³ï¼Œå¤§è‡´å¯åˆ†ä¸ºä»¥ä¸‹å‡ ç±» ä¸€äº›å…³äºisaçš„å‡½æ•°ï¼Œå¦‚initIsa()ã€getIsa()ã€changeIsa()ç­‰ ä¸€äº›å¼±å¼•ç”¨çš„å‡½æ•°ï¼Œå¦‚isWeaklyReferenced()ã€setWeaklyReferenced_nolock()ç­‰ ä¸€äº›å†…å­˜ç®¡ç†å‡½æ•°ï¼Œå¦‚retain()ã€release()ã€autorelease()ç­‰ ä¸¤ä¸ªå…³è”å¯¹è±¡å‡½æ•°ï¼Œåˆ†åˆ«æ˜¯hasAssociatedObjects()å’ŒsetHasAssociatedObjects 1.3 objc_classç»“æ„åŒæ ·å…ˆä¸Šæºç  1234567891011121314typedef struct objc_class *Class;typedef struct objc_object *id;struct objc_class : objc_object { // Class ISA; Class superclass; cache_t cache; // formerly cache pointer and vtable class_data_bits_t bits; // class_rw_t * plus custom rr/alloc flags class_rw_t *data() { return bits.data(); } ... // ä¸€äº›å‡½æ•°}; ä»æºç å¯ä»¥çœ‹å‡ºï¼ŒClassæ˜¯objc_classç»“æ„ä½“ç±»å‹çš„æŒ‡é’ˆå˜é‡ï¼Œç»§æ‰¿è‡ªobjc_objectç»“æ„ä½“ã€‚Classæœ‰4ä¸ªæˆå‘˜å˜é‡ï¼Œä¸”å®ƒä»¬åœ¨å†…å­˜å­˜å‚¨ä¸Šæ˜¯æœ‰åºçš„ï¼Œä¾æ¬¡åˆ†åˆ«æ˜¯ï¼š 1.isaï¼šç±»å‹æ˜¯isa_tï¼Œ64ä½ä¸‹é•¿åº¦ä¸º8å­—èŠ‚ï¼Œä¸Šç¯‡å·²åšè¿‡åˆ†æï¼Œè¿™é‡Œç•¥è¿‡ 2.superclassï¼šç±»å‹æ˜¯Classï¼Œè¡¨ç¤ºç»§æ‰¿å…³ç³»ï¼ŒæŒ‡å‘å½“å‰ç±»çš„çˆ¶ç±»ï¼ŒåŒæ ·8å­—èŠ‚ 3.cacheï¼šç±»å‹æ˜¯cache_tï¼Œè¡¨ç¤ºç¼“å­˜ï¼Œç”¨äºç¼“å­˜å·²è°ƒç”¨çš„æ–¹æ³•ï¼ŒåŠ é€Ÿæ–¹æ³•çš„è°ƒç”¨ã€‚å…¶å…·ä½“ç»“æ„å¦‚ä¸‹: 12345678910111213141516struct cache_t { struct bucket_t *_buckets; // 64ä½ä¸‹æ˜¯8å­—èŠ‚ mask_t _mask; // 64ä½ä¸‹æ˜¯4å­—èŠ‚ mask_t _occupied; // 64ä½ä¸‹æ˜¯4å­—èŠ‚public: ... // ä¸€äº›å‡½æ•°};#if __LP64__typedef uint32_t mask_t; // uint32_t 4å­—èŠ‚ // x86_64 &amp; arm64 asm are less efficient with 16-bits#elsetypedef uint16_t mask_t; // uint16_t 2å­—èŠ‚#endiftypedef unsigned int uint32_t; å¯è§ï¼Œcacheè¿™ä¸ªæˆå‘˜å˜é‡é•¿åº¦æ˜¯16å­—èŠ‚ã€‚ cacheæ¯”è¾ƒé‡è¦ï¼Œå…³äºå®ƒçš„åˆ†æå¯æˆ³ OCæºç åˆ†æä¹‹æ–¹æ³•çš„ç¼“å­˜åŸç†ã€‚ 4.bitsï¼šç±»å‹æ˜¯class_data_bits_tï¼Œç”¨äºå­˜å‚¨ç±»çš„æ•°æ®ï¼ˆç±»çš„æ–¹æ³•ã€å±æ€§ã€éµå¾ªçš„åè®®ç­‰ä¿¡æ¯ï¼‰ï¼Œå…¶ç»“æ„å¦‚ä¸‹ 12345678struct class_data_bits_t { // Values are the FAST_ flags above. uintptr_t bits; // unsigned longprivate: ... // ä¸€äº›å‡½æ•°}; å…¶é•¿åº¦ä¹Ÿæ˜¯8å­—èŠ‚ã€‚æ ¹æ®bitsæˆå‘˜å˜é‡åœ¨objc_objectç»“æ„ä½“ä¸­æ³¨é‡Šçš„æè¿°ï¼Œå®ƒå®è´¨ä¸Šæ˜¯class_rw_t *åŠ ä¸Šè‡ªå®šä¹‰rr/allocæ ‡å¿—ï¼Œæœ€é‡è¦çš„æ˜¯class_rw_tã€‚ æ¥ä¸‹æ¥å°†é‡ç‚¹ä»‹ç»å®ƒã€‚ äºŒã€class_rw_t &amp; class_ro_tåˆ†æ rwæ˜¯readwriteçš„æ„æ€ï¼Œè€Œroåˆ™æ˜¯readonlyã€‚ OCç±»ä¸­çš„å±æ€§ã€æ–¹æ³•è¿˜æœ‰éµå¾ªçš„åè®®ç­‰ä¿¡æ¯éƒ½ä¿å­˜åœ¨class_rw_tä¸­ï¼Œé¦–å…ˆçœ‹çœ‹class_rw_tçš„ç»“æ„ï¼š 12345678910111213141516171819202122232425262728struct class_rw_t { uint32_t flags; uint32_t version; const class_ro_t *ro; method_array_t methods; // æ–¹æ³•åˆ—è¡¨ property_array_t properties; // å±æ€§åˆ—è¡¨ protocol_array_t protocols; // åè®®åˆ—è¡¨ Class firstSubclass; Class nextSiblingClass; char *demangledName;#if SUPPORT_INDEXED_ISA uint32_t index;#endif ...// ä¸€äº›å‡½æ•°};#if __ARM_ARCH_7K__ &gt;= 2 || (__arm64__ &amp;&amp; !__LP64__)# define SUPPORT_INDEXED_ISA 1 // armv7k or arm64_32#else# define SUPPORT_INDEXED_ISA 0#endif å‘ç°class_rw_tä¸­è¿˜æœ‰ä¸€ä¸ªè¢«constä¿®é¥°çš„æŒ‡é’ˆå˜é‡ roï¼Œæ˜¯class_ro_tç»“æ„ä½“æŒ‡é’ˆï¼Œå…¶ä¸­å­˜å‚¨äº†å½“å‰ç±»åœ¨ç¼–è¯‘æœŸç¡®å®šçš„æ–¹æ³•ã€æˆå‘˜å˜é‡ã€å±æ€§ä»¥åŠéµå¾ªçš„åè®®ç­‰ä¿¡æ¯ã€‚ 1234567891011121314151617181920212223struct class_ro_t { uint32_t flags; uint32_t instanceStart; uint32_t instanceSize;#ifdef __LP64__ uint32_t reserved;#endif const uint8_t * ivarLayout; const char * name; method_list_t * baseMethodList; // æ–¹æ³•åˆ—è¡¨ protocol_list_t * baseProtocols; // åè®®åˆ—è¡¨ const ivar_list_t * ivars; // æˆå‘˜å˜é‡åˆ—è¡¨ const uint8_t * weakIvarLayout; property_list_t *baseProperties; // å±æ€§åˆ—è¡¨ // This field exists only when RO_HAS_SWIFT_INITIALIZER is set. _objc_swiftMetadataInitializer __ptrauth_objc_method_list_imp _swiftMetadataInitializer_NEVER_USE[0]; ... // ä¸€äº›å‡½æ•°}; 2.1 è·å–class_rw_tè¦æƒ³è·å–class_rw_tæŒ‡é’ˆåœ°å€ï¼Œéœ€è¦çŸ¥é“objc_classçš„bitsæŒ‡é’ˆåœ°å€ï¼Œé€šè¿‡å¯¹objc_classçš„ç»“æ„åˆ†æå¾—çŸ¥ï¼ŒbitsæŒ‡é’ˆåœ°å€æ˜¯objc_classé¦–åœ°å€åç§»32ä¸ªå­—èŠ‚ï¼ˆisa + superclass + cache = 8+8+16=32å­—èŠ‚ï¼‰ ä¹Ÿå¯ä»¥ä»æºç å¾—çŸ¥å¦‚ä½•æ‹¿åˆ°class_rw_tæŒ‡é’ˆ 12345678910111213// objc_classç»“æ„ä½“ä¸­class_rw_t *data() { return bits.data(); // bitsæ˜¯class_data_bits_tç±»å‹}// class_data_bits_tç»“æ„ä½“ä¸­...class_rw_t* data() { return (class_rw_t *)(bits &amp; FAST_DATA_MASK);}// 64ä½ä¸‹#define FAST_DATA_MASK 0x00007ffffffffff8UL åœ¨64ä½ä¸‹ï¼Œclass_rw_tæŒ‡é’ˆåœ°å€æ˜¯åœ¨[3, 46]æ•°æ®æ®µï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥ç”¨bits &amp; FAST_DATA_MASKè®¡ç®—å‡ºclass_rw_tæŒ‡é’ˆåœ°å€ã€‚ æ¥ç€é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥éªŒè¯class_rw_tå’Œclass_ro_tæ˜¯å¦å­˜å‚¨äº†ç±»çš„ä¿¡æ¯ 2.2 å‡†å¤‡å·¥ä½œç»™Personç±»æ·»åŠ å±æ€§ã€æ–¹æ³•å’Œåè®®ï¼Œä»£ç å¦‚ä¸‹ 123456789101112131415161718192021222324252627282930313233@protocol PersonProtocol &lt;NSObject&gt;- (void)walk;@end@interface Person : NSObject &lt;PersonProtocol&gt; { NSInteger _gender;}@property (nonatomic) NSString *name;@property (nonatomic) NSInteger age;+ (void)printMyClassName;- (void)run;@end@implementation Person+ (void)printMyClassName { NSLog(@&quot;my class name is Person&quot;);}- (void)run { NSLog(@&quot;I am running.&quot;);}- (void)walk { NSLog(@&quot;I am walking.&quot;);}@end ç„¶åæ‰“ä¸Šæ–­ç‚¹ å¥½äº†ï¼Œå‡†å¤‡å·¥ä½œå®Œæˆï¼Œä¸‹é¢å¼€å§‹éªŒè¯ 2.3 class_rw_téªŒè¯è¿‡ç¨‹1.æ‰“å°Personç±» 1234(lldb) x/5gx pcls0x100002820: 0x001d8001000027f9 0x0000000100b391400x100002830: 0x00000001003dc250 0x00000000000000000x100002840: 0x0000000102237404 è¯´æ˜ï¼š Personç±»é¦–åœ°å€æ˜¯0x100002820ï¼Œå› æ­¤ï¼Œ0x100002840æ˜¯å…¶bitsåœ°å€ï¼ˆ32å­—èŠ‚å°±æ˜¯0x20ï¼Œ0x100002840 = 0x100002820 + 0x20ï¼‰ï¼Œbitså†…å®¹æ˜¯0x0000000102237404 0x001d8001000027f9æ˜¯Personç±»çš„isaåœ°å€ï¼ŒæŒ‡å‘Personå…ƒç±» 0x0000000100b39140æ˜¯Personç±»çš„superclassåœ°å€ï¼Œä¹Ÿå°±æ˜¯NSObjectç±»é¦–åœ°å€ 0x00000001003dc250 0x0000000000000000åˆ™æ˜¯Personç±»çš„cacheæ®µ 2.æ‰“å°class_rw_t 12345678910111213141516171819202122232425262728293031323334353637// bits &amp; FAST_DATA_MASK(lldb) p (class_rw_t *)(0x0000000102237404 &amp; 0x00007ffffffffff8)(class_rw_t *) $1 = 0x0000000102237400(lldb) p *$1(class_rw_t) $2 = { flags = 2148139008 version = 0 ro = 0x0000000100002788 methods = { list_array_tt&lt;method_t, method_list_t&gt; = { = { list = 0x0000000100002608 arrayAndFlag = 4294977032 } } } properties = { list_array_tt&lt;property_t, property_list_t&gt; = { = { list = 0x0000000100002720 arrayAndFlag = 4294977312 } } } protocols = { list_array_tt&lt;unsigned long, protocol_list_t&gt; = { = { list = 0x00000001000025a8 arrayAndFlag = 4294976936 } } } firstSubclass = nil nextSiblingClass = NSUUID demangledName = 0x0000000000000000} è¿™é‡Œè¯·å¤§å®¶ç•™æ„ä¸€ä¸‹class_rw_tçš„å‡ ä¸ªå…³é”®æˆå‘˜å˜é‡ï¼š roåœ°å€æ˜¯0x0000000100002788 methodsçš„liståœ°å€æ˜¯0x0000000100002608 propertiesçš„liståœ°å€æ˜¯0x0000000100002720 protocolsçš„liståœ°å€æ˜¯0x0000000100002608 3.éªŒè¯methods ç›®å‰æ¥çœ‹ï¼ŒPersonç±»è‡³å°‘æœ‰6ä¸ªå®ä¾‹æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯runã€walkä»¥åŠnameå’Œageçš„getterã€setterï¼Œè¿˜æœ‰1ä¸ªç±»æ–¹æ³•ï¼Œå³printMyClassNameï¼Œæ€»è®¡7ä¸ªæ–¹æ³•ã€‚ 123456789101112131415(lldb) p (method_list_t *)0x0000000100002608 // rwçš„methodsçš„liståœ°å€(method_list_t *) $7 = 0x0000000100002608(lldb) p *$7(method_list_t) $8 = { entsize_list_tt&lt;method_t, method_list_t, 3&gt; = { entsizeAndFlags = 26 count = 7 first = { name = &quot;walk&quot; types = 0x0000000100001e96 &quot;v16@0:8&quot; imp = 0x0000000100001530 (CCTest`-[Person walk] at main.m:45) } }} æ­£å¥½æ˜¯7ä¸ªæ–¹æ³•ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹éƒ½æ˜¯å“ªäº›ï¼ˆç”±äºmethod_list_tç»§æ‰¿è‡ªentsize_list_ttï¼Œå¯ä»¥é€šè¿‡entsize_list_ttçš„get()å‡½æ•°ä¸€ä¸€æ‰“å°ï¼‰ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748(lldb) p $8.get(0)(method_t) $9 = { name = &quot;walk&quot; types = 0x0000000100001e96 &quot;v16@0:8&quot; imp = 0x0000000100001530 (CCTest`-[Person walk] at main.m:45)}(lldb) p $8.get(1)(method_t) $10 = { name = &quot;.cxx_destruct&quot; types = 0x0000000100001e96 &quot;v16@0:8&quot; imp = 0x0000000100001600 (CCTest`-[Person .cxx_destruct] at main.m:35)}(lldb) p $8.get(2)(method_t) $11 = { name = &quot;name&quot; types = 0x0000000100001eb1 &quot;@16@0:8&quot; imp = 0x0000000100001560 (CCTest`-[Person name] at main.m:27)}(lldb) p $8.get(3)(method_t) $12 = { name = &quot;setName:&quot; types = 0x0000000100001f4b &quot;v24@0:8@16&quot; imp = 0x0000000100001580 (CCTest`-[Person setName:] at main.m:27)}(lldb) p $8.get(4)(method_t) $13 = { name = &quot;age&quot; types = 0x0000000100001f56 &quot;q16@0:8&quot; imp = 0x00000001000015c0 (CCTest`-[Person age] at main.m:28)}(lldb) p $8.get(5)(method_t) $14 = { name = &quot;run&quot; types = 0x0000000100001e96 &quot;v16@0:8&quot; imp = 0x0000000100001500 (CCTest`-[Person run] at main.m:41)}(lldb) p $8.get(6)(method_t) $15 = { name = &quot;setAge:&quot; types = 0x0000000100001f5e &quot;v24@0:8q16&quot; imp = 0x00000001000015e0 (CCTest`-[Person setAge:] at main.m:28)} æ˜¾ç„¶ï¼Œclass_rw_tçš„methodsç¡®å®åŒ…å«äº†Personç±»çš„å…¨éƒ¨å®ä¾‹æ–¹æ³•ï¼Œåªæ˜¯å¤šäº†ä¸ª.cxx_destructæ–¹æ³•ã€‚.cxx_destructæ–¹æ³•åŸæœ¬æ˜¯ä¸ºäº†C++å¯¹è±¡ææ„çš„ï¼ŒARCå€Ÿç”¨äº†è¿™ä¸ªæ–¹æ³•æ’å…¥ä»£ç å®ç°äº†è‡ªåŠ¨å†…å­˜é‡Šæ”¾çš„å·¥ä½œï¼Œå…³äºå…¶åŸç†è¿™é‡Œç•¥è¿‡ä¸æã€‚ æ€è€ƒï¼šç±»æ–¹æ³•printMyClassNameå“ªé‡Œå»äº†ï¼Ÿ 4.éªŒè¯properties åŒç†ï¼ŒPersonç±»è‡³å°‘æœ‰nameå’Œageè¿™ä¸¤ä¸ªå±æ€§ï¼Œä¸”çœ‹ 1234567891011121314151617181920212223242526272829(lldb) p (property_list_t *)0x0000000100002720 // rwçš„propertiesçš„liståœ°å€(property_list_t *) $18 = 0x0000000100002720(lldb) p *$18(property_list_t) $19 = { entsize_list_tt&lt;property_t, property_list_t, 0&gt; = { entsizeAndFlags = 16 count = 6 first = (name = &quot;name&quot;, attributes = &quot;T@\\&quot;NSString\\&quot;,&amp;,N,V_name&quot;) }}(lldb) p $19.get(0)(property_t) $20 = (name = &quot;name&quot;, attributes = &quot;T@\\&quot;NSString\\&quot;,&amp;,N,V_name&quot;) (lldb) p $19.get(1)(property_t) $21 = (name = &quot;age&quot;, attributes = &quot;Tq,N,V_age&quot;) (lldb) p $19.get(2)(property_t) $22 = (name = &quot;hash&quot;, attributes = &quot;TQ,R&quot;) (lldb) p $19.get(3)(property_t) $23 = (name = &quot;superclass&quot;, attributes = &quot;T#,R&quot;) (lldb) p $19.get(4)(property_t) $24 = (name = &quot;description&quot;, attributes = &quot;T@\\&quot;NSString\\&quot;,R,C&quot;) (lldb) p $19.get(5)(property_t) $25 = (name = &quot;debugDescription&quot;, attributes = &quot;T@\\&quot;NSString\\&quot;,R,C&quot;) æ˜¾ç„¶nameå’Œageå­˜å‚¨åœ¨propertiesä¸­ã€‚ å¤šä½™çš„å±æ€§ä¹Ÿä¸ä½œèµ˜è¿°ã€‚ 5.éªŒè¯protocols åœ¨éªŒè¯ä¹‹å‰ï¼Œå…ˆåˆ†æä¸€ä¸‹protocol_list_tï¼Œè¿™ä¸ªç»“æ„ä½“å¹¶ä¸æ˜¯ç»§æ‰¿è‡ªentsize_list_ttçš„ï¼Œå…¶ç»“æ„å¦‚ä¸‹ 1234567struct protocol_list_t { // count is 64-bit by accident. uintptr_t count; protocol_ref_t list[0]; // variable-size ... // ä¸€äº›å‡½æ•°} æ³¨æ„åˆ°variable-sizeè¿™ä¸ªæ³¨é‡Šéƒ¨åˆ†ï¼ˆå¯å˜å¤§å°ï¼‰ï¼Œä»¿ä½›çœ‹åˆ°äº†å¸Œæœ› 123456789101112131415161718192021typedef uintptr_t protocol_ref_t; // protocol_t *, but unremappedstruct protocol_t : objc_object { const char *mangledName; struct protocol_list_t *protocols; method_list_t *instanceMethods; method_list_t *classMethods; method_list_t *optionalInstanceMethods; method_list_t *optionalClassMethods; property_list_t *instanceProperties; uint32_t size; // sizeof(protocol_t) uint32_t flags; // Fields below this point are not always present on disk. const char **_extendedMethodTypes; const char *_demangledName; property_list_t *_classProperties; const char *demangledName(); ... // ä¸€äº›å‡½æ•°}; protocol_ref_tè™½ç„¶æœªæ˜ å°„æˆprotocol_t *ï¼Œä¸è¿‡åº”è¯¥å¯ä»¥è€ƒè™‘ä¸€ä¸‹å¼ºè½¬ï¼Œå®éªŒä¸€ä¸‹å§ï¼ˆè¿™æ¬¡æ˜¯æ‰¾åˆ°PersonProtocolåè®®ï¼‰ 1234567891011121314151617181920212223242526272829303132333435363738394041(lldb) p (protocol_list_t *)0x00000001000025a8 // rwçš„protocolsçš„liståœ°å€(protocol_list_t *) $26 = 0x00000001000025a8 (lldb) p *$26(protocol_list_t) $27 = (count = 1, list = protocol_ref_t [] @ 0x00007fb5decb30f8)(lldb) p (protocol_t *)$26-&gt;list[0](protocol_t *) $32 = 0x00000001000028a8 (lldb) p *$32(protocol_t) $33 = { objc_object = { isa = { cls = Protocol bits = 4306735304 = { nonpointer = 0 has_assoc = 0 has_cxx_dtor = 0 shiftcls = 538341913 magic = 0 weakly_referenced = 0 deallocating = 0 has_sidetable_rc = 0 extra_rc = 0 } } } mangledName = 0x0000000100001d16 &quot;PersonProtocol&quot; // å‡ºç°äº†ï¼ï¼ï¼ protocols = 0x0000000100002568 instanceMethods = 0x0000000100002580 classMethods = 0x0000000000000000 optionalInstanceMethods = 0x0000000000000000 optionalClassMethods = 0x0000000000000000 instanceProperties = 0x0000000000000000 size = 96 flags = 0 _extendedMethodTypes = 0x00000001000025a0 _demangledName = 0x0000000000000000 _classProperties = 0x0000000000000000} åŠŸå¤«ä¸è´Ÿæœ‰å¿ƒäººï¼Œæœ€ç»ˆéªŒè¯äº†class_rw_tçš„protocolsä¸­å«æœ‰Personç±»æ‰€éµå¾ªçš„PersonProtocolåè®®ã€‚ åˆ°äº†è¿™é‡Œï¼Œ**class_rw_tç¡®å®å­˜å‚¨äº†ç±»çš„å®ä¾‹æ–¹æ³•ã€å±æ€§å’Œéµå¾ªçš„åè®®äº†ã€‚** 2.4 class_ro_téªŒè¯è¿‡ç¨‹ç°åœ¨å°±å‰©ä¸‹roäº† 1.æ‰“å°class_ro_t 123456789101112131415161718(lldb) p $1-&gt;ro(const class_ro_t *) $38 = 0x0000000100002788 (lldb) p *$38(const class_ro_t) $39 = { flags = 388 instanceStart = 8 instanceSize = 32 reserved = 0 ivarLayout = 0x0000000100001d2e &quot;\\x11&quot; name = 0x0000000100001d0f &quot;Person&quot; baseMethodList = 0x0000000100002608 baseProtocols = 0x00000001000025a8 ivars = 0x00000001000026b8 weakIvarLayout = 0x0000000000000000 baseProperties = 0x0000000100002720 _swiftMetadataInitializer_NEVER_USE = {}} æœ‰æ²¡æœ‰å‘ç°ä»€ä¹ˆï¼**class_ro_tçš„æ–¹æ³•ã€å±æ€§å’Œåè®®çš„åœ°å€éƒ½ä¸class_rw_tçš„ä¸€è‡´ï¼Œæ—¢ç„¶æŒ‡å‘çš„æ˜¯åŒä¸€å—å†…å­˜ç©ºé—´ï¼Œæ˜¾ç„¶class_ro_tä¹Ÿå­˜å‚¨äº†Personç±»çš„å®ä¾‹æ–¹æ³•ã€å±æ€§å’Œåè®®**ã€‚ ä¸class_rw_tä¸åŒçš„æ˜¯ï¼Œclass_ro_tå¤šäº†ä¸€ä¸ªivarsåˆ—è¡¨ï¼Œé‡Œé¢å­˜æ”¾çš„åº”è¯¥æ˜¯Personç±»çš„æˆå‘˜å˜é‡ã€‚ 2.éªŒè¯ivars Personç±»çš„æˆå‘˜å˜é‡æœ‰ï¼š_genderã€_nameå’Œ_age æ‰€å¹¸ivar_list_tæ˜¯ç»§æ‰¿è‡ªentsize_list_ttçš„ï¼Œget()å‡½æ•°åˆå¯ä»¥ç”¨äº†ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940(lldb) p $39.ivars(const ivar_list_t *const) $40 = 0x00000001000026b8(lldb) p *$40(const ivar_list_t) $41 = { entsize_list_tt&lt;ivar_t, ivar_list_t, 0&gt; = { entsizeAndFlags = 32 count = 3 first = { offset = 0x00000001000027e0 name = 0x0000000100001e83 &quot;_gender&quot; type = 0x0000000100001f69 &quot;q&quot; alignment_raw = 3 size = 8 } }}(lldb) p $41.get(0)(ivar_t) $42 = { offset = 0x00000001000027e0 name = 0x0000000100001e83 &quot;_gender&quot; type = 0x0000000100001f69 &quot;q&quot; alignment_raw = 3 size = 8}(lldb) p $41.get(1)(ivar_t) $43 = { offset = 0x00000001000027e8 name = 0x0000000100001e8b &quot;_name&quot; type = 0x0000000100001f6b &quot;@\\&quot;NSString\\&quot;&quot; alignment_raw = 3 size = 8}(lldb) p $41.get(2)(ivar_t) $44 = { offset = 0x00000001000027f0 name = 0x0000000100001e91 &quot;_age&quot; type = 0x0000000100001f69 &quot;q&quot; alignment_raw = 3 size = 8} å®Œå…¨ç¬¦åˆé¢„æœŸï¼Œclass_ro_tç¡®å®å­˜å‚¨äº†Personç±»çš„æˆå‘˜å˜é‡ã€‚ 2.5 rwå’Œroçš„è”ç³»ä¸ºä»€ä¹ˆclass_rw_tã€class_ro_tçš„æ–¹æ³•ã€å±æ€§å’Œåè®®çš„åœ°å€ä¸€è‡´ï¼Ÿ åœ¨class_data_bits_tç»“æ„ä½“ä¸­çš„safe_ro()å‡½æ•°ä¸­å‘ç°äº†ç«¯å€ª 12345678910const class_ro_t *safe_ro() { class_rw_t *maybe_rw = data(); if (maybe_rw-&gt;flags &amp; RW_REALIZED) { // maybe_rw is rw return maybe_rw-&gt;ro; } else { // maybe_rw is actually ro return (class_ro_t *)maybe_rw; }} å¯è§ï¼Œrwä¸ä¸€å®šæ˜¯rwï¼Œä¹Ÿå¯èƒ½æ˜¯roã€‚å®é™…ä¸Šï¼Œåœ¨ç¼–è¯‘æœŸé—´ï¼Œç±»çš„class_data_bits_t *bitsæŒ‡é’ˆæŒ‡å‘çš„æ˜¯class_ro_t *ï¼Œç„¶ååœ¨OCè¿è¡Œæ—¶è°ƒç”¨äº†realizeClassWithoutSwift()ï¼ˆè‹¹æœå¼€æºçš„objc4-756.2æºç æ˜¯realizeClassWithoutSwift()ï¼Œåœ¨æ­¤ä¹‹å‰çš„ç‰ˆæœ¬æ˜¯realizeClass()æ–¹æ³•ï¼‰ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦åšçš„å°±æ˜¯åˆ©ç”¨ç¼–è¯‘æœŸç¡®å®šçš„roæ¥åˆå§‹åŒ–rwï¼š 12345678910111213141516171819ro = (const class_ro_t *)cls-&gt;data();if (ro-&gt;flags &amp; RO_FUTURE) { // This was a future class. rw data is already allocated. rw = cls-&gt;data(); ro = cls-&gt;data()-&gt;ro; cls-&gt;changeInfo(RW_REALIZED|RW_REALIZING, RW_FUTURE);} else { // ä¸€èˆ¬èµ°è¿™é‡Œ // Normal class. Allocate writeable class data. rw = (class_rw_t *)calloc(sizeof(class_rw_t), 1); // ç»™rwç”³è¯·å†…å­˜ rw-&gt;ro = ro; // è®¾ç½®rwçš„ro rw-&gt;flags = RW_REALIZED|RW_REALIZING; // è®¾ç½®flags cls-&gt;setData(rw); // ç»™clsè®¾ç½®æ­£ç¡®çš„rw}... // åˆå§‹åŒ– rw çš„å…¶ä»–å­—æ®µï¼Œæ›´æ–°superclassã€meta class// Attach categoriesmethodizeClass(cls); åœ¨ä»£ç çš„æœ€åï¼Œè¿˜è°ƒç”¨äº†methodizeClass()ï¼Œå…¶æºç å¦‚ä¸‹ 1234567891011121314151617181920212223242526272829303132333435363738static void methodizeClass(Class cls){ runtimeLock.assertLocked(); bool isMeta = cls-&gt;isMetaClass(); auto rw = cls-&gt;data(); auto ro = rw-&gt;ro; ... // æ‰“å°ä¿¡æ¯ // Install methods and properties that the class implements itself. method_list_t *list = ro-&gt;baseMethods(); if (list) { prepareMethodLists(cls, &amp;list, 1, YES, isBundleClass(cls)); rw-&gt;methods.attachLists(&amp;list, 1); } property_list_t *proplist = ro-&gt;baseProperties; if (proplist) { rw-&gt;properties.attachLists(&amp;proplist, 1); } protocol_list_t *protolist = ro-&gt;baseProtocols; if (protolist) { rw-&gt;protocols.attachLists(&amp;protolist, 1); } if (cls-&gt;isRootMetaclass()) { addMethod(cls, SEL_initialize, (IMP)&amp;objc_noop_imp, &quot;&quot;, NO); } category_list *cats = unattachedCategoriesForClass(cls, true /*realizing*/); attachCategories(cls, cats, false /*don't flush caches*/); ... // æ‰“å°ä¿¡æ¯ if (cats) free(cats); ... // æ‰“å°ä¿¡æ¯} åœ¨è¿™ä¸ªæ–¹æ³•é‡Œï¼Œå°†ç±»è‡ªå·±å®ç°çš„æ–¹æ³•ï¼ˆåŒ…æ‹¬åˆ†ç±»ï¼‰ã€å±æ€§å’Œéµå¾ªçš„åè®®åŠ è½½åˆ° methodsã€properties å’Œ protocols åˆ—è¡¨ä¸­ã€‚ è¿™å°±å®Œç¾è§£é‡Šäº†ä¸ºä»€ä¹ˆè¿è¡Œæ—¶rwå’Œroçš„æ–¹æ³•ã€å±æ€§å’Œåè®®ç›¸åŒã€‚ 2.6 rwå’Œroåœ¨è¿è¡Œæ—¶çš„ä¸åŒä¹‹å¤„ç›®å‰ä¸ºæ­¢çš„éªŒè¯éƒ½æ˜¯åŸºäºPersonç±»çš„ç°æœ‰ç»“æ„ï¼Œä¹Ÿå°±æ˜¯åœ¨ç¼–è¯‘æœŸå°±ç¡®å®šçš„ï¼Œçªå‡ºä¸äº†class_rw_tå’Œclass_ro_tçš„å·®å¼‚æ€§ã€‚æ¥ä¸‹æ¥ä¼šç”¨runtimeçš„apiåœ¨è¿è¡Œæ—¶ä¸ºPersonåŠ¨æ€æ·»åŠ ä¸€ä¸ªfly()æ–¹æ³•ï¼Œå†æ¥ä¸€è¯•ã€‚ 1.æ·»åŠ æ–¹æ³• å…·ä½“ä»£ç å¦‚ä¸‹ï¼š 12345void fly(id obj, SEL sel) { NSLog(@&quot;I am flying&quot;);}class_addMethod([Person class], NSSelectorFromString(@&quot;fly&quot;), (IMP)fly, &quot;v@:&quot;); å†åŠ ä¸€ä¸ªæ‰“å°æ–¹æ³•ï¼Œç”¨äºæ‰“å°ç±»çš„methods 123456789101112void printMethods(Class cls) { if (cls == nil) { return ; } CCNSLog(@&quot;------------ print %@ methods ------------&quot;, NSStringFromClass(cls)); uint32_t count; Method *methods = class_copyMethodList(cls, &amp;count); for (uint32_t i = 0; i &lt; count; i++) { Method method = methods[i]; CCNSLog(@&quot;åå­—ï¼š%@ -- ç±»å‹ï¼š%s&quot;, NSStringFromSelector(method_getName(method)), method_getTypeEncoding(method)); }} è¿è¡Œä¸€ä¸‹çœ‹æ•ˆæœï¼Œå‘ç°æ·»åŠ æˆåŠŸï¼Œå¦‚å›¾ 2.éªŒè¯è¿‡ç¨‹ å…ˆæ‰“å°class_rw_tï¼Œå³ è¿˜æœ‰class_ro_t å¯¹æ¯”åå‘ç°ï¼Œä¸¤è€…çš„å±æ€§ã€åè®®æŒ‡é’ˆåœ°å€æœªå‘ç”Ÿå˜åŒ–ï¼Œä½†æ˜¯æ–¹æ³•çš„æŒ‡é’ˆåœ°å€ä¸ä¸€æ ·äº†ã€‚ ç”±äºclass_rw_tæ˜¯è¿è¡Œæ—¶æ‰åˆå§‹åŒ–çš„ï¼Œè€Œclass_ro_tåœ¨ç¼–è¯‘æœŸé—´å°±ç¡®å®šäº†ï¼Œå› æ­¤å¯ä»¥çŒœæµ‹æ–°å¢çš„flyæ–¹æ³•å­˜å‚¨åœ¨class_rw_tçš„methodsæŒ‡é’ˆä¸Šï¼Œclass_ro_tçš„baseMethodListæŒ‡é’ˆä»ç¼–è¯‘æœŸä¹‹åå°±æœªå‘ç”Ÿæ”¹å˜ã€‚ ä¸‹é¢ç»§ç»­éªŒè¯ï¼Œé¦–å…ˆçœ‹class_ro_tçš„æ–¹æ³•åˆ—è¡¨ OKï¼Œç¼–è¯‘æœŸå°±ç¡®å®šçš„æ–¹æ³•éƒ½åœ¨ï¼Œå¹¶ä¸”æ²¡æœ‰flyæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´class_ro_tçš„æ–¹æ³•åˆ—è¡¨åœ¨è¿è¡Œæ—¶åŸºæœ¬æ²¡å˜ã€‚ class_ro_tçš„å±æ€§åˆ—è¡¨ã€æˆå‘˜å˜é‡åˆ—è¡¨ã€åè®®åœ¨è¿è¡Œæ—¶éƒ½æ²¡æœ‰å‘ç”Ÿæ”¹å˜ã€‚æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±å°è¯•éªŒè¯ä¸€ä¸‹ã€‚ æ¥ç€çœ‹class_rw_tçš„æ–¹æ³•åˆ—è¡¨ class_rw_tçš„methodsé‡Œé¢æ•°æ®å±…ç„¶éƒ½æ²¡æœ‰äº†ï¼Ÿ æ²¡åŠæ³•ï¼Œè¿™é‡Œæš‚æ—¶ç•™ä¸ªå‘å§ï¼Œæš‚æ—¶ä¸çŸ¥é“åŸå› ã€‚ ä¸‰ã€æ€»ç»“3.1 ç±»çš„ç»“æ„æ€»ç»“å…³äºç±»çš„ç»“æ„ï¼Œæˆ‘ä»¬äº†è§£åˆ°ï¼š ç±»æœ¬è´¨ä¸Šæ˜¯objc_objectç»“æ„ä½“ï¼Œä¹Ÿå°±æ˜¯ç±»ä¹Ÿæ˜¯å¯¹è±¡ï¼Œå³ä¸‡ç‰©æ˜¯å¯¹è±¡ã€‚ ç±»éƒ½åŒ…å«ä¸€ä¸ªClassç±»å‹çš„æˆå‘˜å˜é‡isa Classæ˜¯objc_classç»“æ„ä½“ç±»å‹çš„æŒ‡é’ˆå˜é‡ï¼Œå†…éƒ¨æœ‰4ä¸ªæˆå‘˜å˜é‡ï¼Œå³ isaï¼šç±»å‹æ˜¯isa_t superclassï¼šç±»å‹æ˜¯Classï¼Œè¡¨ç¤ºç»§æ‰¿å…³ç³»ï¼ŒæŒ‡å‘ç±»çš„çˆ¶ç±» cacheï¼šç±»å‹æ˜¯cache_tï¼Œè¡¨ç¤ºç¼“å­˜ï¼Œç”¨äºç¼“å­˜æŒ‡é’ˆå’Œ vtableï¼ŒåŠ é€Ÿæ–¹æ³•çš„è°ƒç”¨ bitsï¼šç±»å‹æ˜¯class_data_bits_tï¼Œç”¨äºå­˜å‚¨ç±»çš„æ•°æ®ï¼ˆç±»çš„æ–¹æ³•ã€å±æ€§ã€éµå¾ªçš„åè®®ç­‰ä¿¡æ¯ï¼‰ï¼Œå…¶é•¿åº¦åœ¨64ä½CPUä¸‹ä¸º8å­—èŠ‚ï¼Œæ˜¯ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘class_rw_t * 3.2 class_rw_tå’Œclass_ro_tæ€»ç»“ class_ro_tå­˜å‚¨äº†ç±»åœ¨ç¼–è¯‘æœŸç¡®å®šçš„æ–¹æ³•ï¼ˆåŒ…æ‹¬å…¶åˆ†ç±»çš„ï¼‰ã€æˆå‘˜å˜é‡ã€å±æ€§ä»¥åŠéµå¾ªçš„åè®®ç­‰ä¿¡æ¯ï¼Œåœ¨è¿è¡Œæ—¶ä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚ç¼–è¯‘æœŸï¼Œç±»çš„bitsæŒ‡é’ˆæŒ‡å‘çš„æ˜¯class_ro_tæŒ‡é’ˆï¼ˆå³æ­¤æ—¶class_rw_t å®é™…ä¸Šæ˜¯class_ro_t ï¼‰ã€‚ å®ä¾‹æ–¹æ³•å­˜å‚¨åœ¨ç±»ä¸­ ç±»æ–¹æ³•å­˜å‚¨åœ¨å…ƒç±»ä¸­ åœ¨realizeClassWithoutSwift()æ‰§è¡Œä¹‹åï¼Œclass_rw_tæ‰ä¼šè¢«åˆå§‹åŒ–ï¼ŒåŒæ—¶å­˜å‚¨ç±»çš„æ–¹æ³•ã€å±æ€§ä»¥åŠéµå¾ªçš„åè®®ï¼Œå®é™…ä¸Šï¼Œclass_rw_tå’Œclass_ro_tä¸¤è€…çš„æ–¹æ³•åˆ—è¡¨ï¼ˆæˆ–å±æ€§åˆ—è¡¨ã€åè®®åˆ—è¡¨ï¼‰çš„æŒ‡é’ˆæ˜¯ç›¸åŒçš„ã€‚ è¿è¡Œæ—¶å‘ç±»åŠ¨æ€æ·»åŠ å±æ€§ã€æ–¹æ³•æ—¶ï¼Œä¼šä¿®æ”¹class_rw_tçš„å±æ€§åˆ—è¡¨ã€æ–¹æ³•åˆ—è¡¨æŒ‡é’ˆï¼Œä½†class_ro_tå¯¹åº”çš„å±æ€§åˆ—è¡¨ã€æ–¹æ³•åˆ—è¡¨ä¸ä¼šå˜ã€‚ ä¸€ä¸ªå¾…è§£å†³çš„å‘ï¼šé€šè¿‡è¿è¡Œæ—¶æ·»åŠ æ–¹æ³•ï¼ˆæˆ–å±æ€§ã€åè®®ï¼‰æ”¹å˜äº† class_rw_t å¯¹åº”çš„æ–¹æ³•åˆ—è¡¨ï¼ˆæˆ–å±æ€§åˆ—è¡¨ã€åè®®åˆ—è¡¨ï¼‰çš„æŒ‡é’ˆåï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆå±…ç„¶åœ¨ class_rw_t çš„æ–¹æ³•åˆ—è¡¨ï¼ˆæˆ–å±æ€§åˆ—è¡¨ã€åè®®åˆ—è¡¨ï¼‰ä¸Šæ‰¾ä¸åˆ°æ–°å¢çš„æ–¹æ³•ï¼ˆæˆ–å±æ€§ã€åè®®ï¼‰äº†ã€‚ 3.3 ç±»æ–¹æ³•çš„å­˜å‚¨ä½ç½®ï¼ˆPersonç±»çš„ç±»æ–¹æ³•printMyClassName()ï¼‰ 12345678910111213141516171819202122232425262728293031323334353637383940414243// 1. è·å– Personå…ƒç±»(lldb) x/4gx pcls0x100002820: 0x001d8001000027f9 0x0000000100b391400x100002830: 0x00000001003dc250 0x0000000000000000(lldb) p/x 0x001d8001000027f9 &amp; 0x00007ffffffffff8(long) $50 = 0x00000001000027f8(lldb) po 0x00000001000027f8Person // Personå…ƒç±»// 2. è·å– Personå…ƒç±» çš„ bits(lldb) x/5gx 0x00000001000027f80x1000027f8: 0x001d800100b390f1 0x0000000100b390f00x100002808: 0x0000000102237440 0x00000001000000030x100002818: 0x00000001022373a0 // Personå…ƒç±» çš„ bits// 3. è·å– Personå…ƒç±» çš„ class_rw_t(lldb) p (class_rw_t *)(0x00000001022373a0 &amp; 0x00007ffffffffff8)(class_rw_t *) $52 = 0x00000001022373a0// 4. éªŒè¯ Personå…ƒç±» çš„ methods(lldb) p $52-&gt;methods(method_array_t) $55 = { list_array_tt&lt;method_t, method_list_t&gt; = { = { list = 0x0000000100002270 arrayAndFlag = 4294976112 } }}(lldb) p (method_list_t *)0x0000000100002270(method_list_t *) $56 = 0x0000000100002270(lldb) p *$56(method_list_t) $57 = { entsize_list_tt&lt;method_t, method_list_t, 3&gt; = { entsizeAndFlags = 26 count = 1 first = { name = &quot;printMyClassName&quot; // æˆåŠŸæ‰¾åˆ° Personç±»çš„ç±»æ–¹æ³• types = 0x0000000100001e96 &quot;v16@0:8&quot; imp = 0x00000001000014d0 (CCTest`+[Person printMyClassName] at main.m:37) } }} ç»“è®ºï¼šç±»æ–¹æ³• å­˜å‚¨ åœ¨ç±»çš„å…ƒç±»ä¸Šï¼Œä¸”ä½äºå…ƒç±»çš„class_ro_tçš„baseMethodListæŒ‡é’ˆä¸Šï¼ˆæˆ–åœ¨class_rw_tçš„methodsæŒ‡é’ˆä¸Šï¼‰","link":"/2020/11/18/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/03-%E5%AF%B9%E8%B1%A1&%E7%B1%BB%E7%9A%84%E7%BB%93%E6%9E%84/"},{"title":"08-ç±»çš„åŠ è½½è¿‡ç¨‹","text":"å‰è¨€ï¼šdyldåŠ è½½æµç¨‹ï¼ˆç²¾ç®€ï¼‰ç”±äºdyldæµç¨‹åŠ è½½æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„è¿‡ç¨‹ï¼Œè¿™é‡Œæˆ‘ä»¬åªåšç®€å•çš„åˆ†æã€‚ ä¸‹é¢æ˜¯mainå‡½æ•°ä¹‹å‰è°ƒç”¨å †æ ˆçš„ä¿¡æ¯ï¼š é€šè¿‡ä¸Šé¢çš„å †æ ˆä¿¡æ¯æˆ‘ä»¬å¯ä»¥ç®€å•åˆ†æå‡ºæ¥ä¸€ä¸ªæµç¨‹ _dyld_startå‡½æ•°ï¼Œæ˜¯æ•´ä¸ªåŠ è½½çš„å…¥å£ã€‚ ç»è¿‡dyldbooststrap::start-&gt;dyld::start-&gt;ImageLoad::-&gt;ImageLoadMackO::è¿™äº›æµç¨‹æŠŠMachOé‡Œé¢çš„ä¿¡æ¯è¯»å–åˆ°ã€‚ libSystem_initializerï¼Œåˆå§‹åŒ–ç³»ç»Ÿåº“ã€‚ libdispatch_initï¼Œåˆå§‹åŒ–libdispatchåº“ã€‚ _os_object_init-&gt;::_objc_initï¼Œåˆå§‹åŒ–objcåº“ã€‚ dyldä¸»è¦çš„æ­¥éª¤éƒ½åœ¨è¯»å–MachOæ®µé‡Œé¢çš„æ•°æ® æ¥ä¸‹æ¥ä½¿ç”¨objc4-756.2æºç è¿›è¡Œåˆ†æ ä¸€ã€_objc_initæµç¨‹123456789101112131415void _objc_init(void){ static bool initialized = false; if (initialized) return; initialized = true; // fixme defer initialization until an objc-using image is found? environ_init(); tls_init(); static_init(); lock_init(); exception_init(); _dyld_objc_notify_register(&amp;map_images, load_images, unmap_image);} 1.1 environ_init å‡½æ•°åˆå§‹åŒ–ç¯å¢ƒå˜é‡ã€‚è¿™é‡Œæˆ‘ä»¬çš„é‡ç‚¹ä¸æ˜¯çœ‹æºç ï¼Œä¸»è¦çœ‹ä¸‹é¢ï¼š æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ç»ˆç«¯è¿›è¡Œï¼šexport OBJC_HELP=1ç„¶åï¼š lsï¼ŒæŸ¥çœ‹ç›¸å…³çš„ç¯å¢ƒå˜é‡ï¼Œç•™æ„ä¸‹é¢ä¸¤ä¸ªå˜é‡ï¼š â€¦çœç•¥ä¸­é—´çš„éƒ¨åˆ†â€¦ æˆ‘ä»¬å¯ä»¥åœ¨Xcodeä¸­è°ƒæ•´è¿™ä¸¤ä¸ªç¯å¢ƒå˜é‡ç©ä¸€ä¸‹ï¼š 1.1.1 ä¿®æ”¹ç¯å¢ƒå˜é‡OBJC_PRINT_LOAD_METHODä¸ºYESå ä¿®æ”¹è¯¥ç¯å¢ƒå˜é‡ä¹‹åè§‚å¯Ÿæ§åˆ¶å°æ‰“å°è¾“å‡ºçš„ç»“æœ ç³»ç»Ÿçš„loadæ–¹æ³•ä¼šå…¨éƒ¨æ‰“å°å‡ºæ¥ã€‚ è‡ªå·±å®šä¹‰çš„loadæ–¹æ³•ä¹Ÿä¼šæ‰“å°å‡ºæ¥ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä»è¿™é‡Œå…¥æ‰‹ï¼Œåœ¨åšå¯åŠ¨ä¼˜åŒ–çš„æ—¶å€™å¯ä»¥å¿«é€Ÿå®šä½è°ƒæ•´è¿™äº›loadæ–¹æ³•ã€‚ 1.1.2 ä¿®æ”¹OBJC_PRINT_NONPOINTER_ISAä¸ºYESå ä¿®æ”¹è¯¥ç¯å¢ƒå˜é‡ä¹‹åè§‚å¯Ÿæ§åˆ¶å°æ‰“å°è¾“å‡ºçš„ç»“æœ ä¼˜åŒ–è¿‡çš„isaæŒ‡é’ˆåˆ™éœ€è¦&amp;ä¸ŠISA_MASKæ‰èƒ½çš„åˆ°ç±»çš„å†…å­˜åœ°å€ã€‚ å…³é—­nonpointerä¹‹åï¼ŒisaæŒ‡é’ˆå°±ä¸åšå†…å­˜ä¼˜åŒ–äº†ï¼Œæ‰€ä»¥ç±»çš„å†…å­˜åœ°å€å’Œisaçš„å†…å­˜åœ°å€å°±ç›¸åŒäº†ã€‚ è¿™é‡Œä¹ŸéªŒè¯äº†02-isaåŸç†ä¸­isaçš„åˆå§‹åŒ–çš„æ—¶å€™ï¼Œç›´æ¥å°†ç±»èµ‹å€¼isaçš„clsæˆå‘˜ã€‚ 1.2 tls_init å‡½æ•°tls_init()æ–¹æ³•æ˜¯å…³äºçº¿ç¨‹keyçš„ç»‘å®š 123456789void tls_init(void){#if SUPPORT_DIRECT_THREAD_KEYS _objc_pthread_key = TLS_DIRECT_KEY; pthread_key_init_np(TLS_DIRECT_KEY, &amp;_objc_pthread_destroyspecific);#else _objc_pthread_key = tls_create(&amp;_objc_pthread_destroyspecific);#endif} 1.3 static_init å‡½æ•°static_init()æ–¹æ³•æ³¨é‡Šä¸­æåˆ°ï¼šè¯¥æ–¹æ³•ä¼šè¿è¡ŒC++é™æ€æ„é€ å‡½æ•°ï¼ˆåªä¼šè¿è¡Œç³»ç»Ÿçº§åˆ«çš„æ„é€ å‡½æ•°ï¼‰ï¼Œåœ¨dyldè°ƒç”¨é™æ€æ„é€ å‡½æ•°ä¹‹å‰libcä¼šè°ƒç”¨_objc_initï¼Œæ‰€ä»¥å¿…é¡»è‡ªå·±å»å®ç° 1234567891011121314/************************************************************************ static_init* Run C++ static constructor functions.* libc calls _objc_init() before dyld would call our static constructors, * so we have to do it ourselves.**********************************************************************/static void static_init(){ size_t count; auto inits = getLibobjcInitializers(&amp;_mh_dylib_header, &amp;count); for (size_t i = 0; i &lt; count; i++) { inits[i](); }} 1.4 lock_init å‡½æ•°lock_init()æ–¹æ³•æ˜¯ä¸ªç©ºå‡½æ•°ï¼ŒOCçš„é”æœºåˆ¶å®Œå…¨é‡‡ç”¨Cã€C++é‚£ä¸€å¥— 123void lock_init(void){} 1.5 exception_init å‡½æ•°exception_init()åˆå§‹åŒ–libobjcçš„å¼‚å¸¸å¤„ç†ç³»ç»Ÿï¼Œæ³¨å†Œå¼‚å¸¸å¤„ç†çš„å›è°ƒï¼Œä»è€Œç›‘æ§å¼‚å¸¸çš„å¤„ç† 1234void exception_init(void){ old_terminate = std::set_terminate(&amp;_objc_terminate);} è°ƒç”¨åªå£°æ˜ä¸å®ç°ä¸ä½œä»»ä½•å¤„ç†çš„æ–¹æ³•ï¼Œå°±ä¼šæŠ¥é”™ï¼Œæ¥åˆ°_objc_terminate 1.6 _dyld_objc_notify_register å‡½æ•° é€šè¿‡ä¸‰ä¸ªå‡½æ•°æŒ‡é’ˆç›´æ¥å‘èµ·å›è°ƒã€‚è¿™é‡Œåˆ†æ_dyld_objc_notify_mappedè¿™ä¸ªå‡½æ•°ï¼Œåœ¨dyldé‡Œé¢é€šè¿‡æ³¨å†Œå‡½æ•°çš„å†…å­˜åœ°å€ï¼Œç„¶åé€šè¿‡å‡½æ•°æŒ‡é’ˆåˆå›è°ƒåˆ°äº†map_imagesè¿™ä¸ªå‡½æ•°ã€‚ è®°å½•ä¿å­˜æ³¨å†Œå‡½æ•°çš„å†…å­˜åœ°å€ã€‚ é€šè¿‡å‡½æ•°æŒ‡é’ˆçš„å½¢å¼å›è°ƒè¿™ä¸ªå‡½æ•°å³map_images,ä¸‹é¢è¿›å…¥åˆ°map_imagesåˆ†æã€‚ äºŒã€map_images å‡½æ•°å½“é•œåƒåŠ è½½åˆ°å†…å­˜æ—¶ä¼šè§¦å‘map_image 1234567891011121314/************************************************************************ map_images* Process the given images which are being mapped in by dyld.* Calls ABI-agnostic code after taking ABI-specific locks.** Locking: write-locks runtimeLock**********************************************************************/voidmap_images(unsigned count, const char * const paths[], const struct mach_header * const mhdrs[]){ mutex_locker_t lock(runtimeLock); return map_images_nolock(count, paths, mhdrs);} map_images_nolockå‡½æ•°ï¼š map_imageè°ƒç”¨map_images_nolockï¼Œç”±äºä»£ç æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬å»æ‰ä¸€äº›æ— å…³ç´§è¦çš„ä»£ç ï¼Œæ¯”å¦‚æ‰“å°æ—¥å¿—ä¿¡æ¯ã€ä»£ç çš„æ³¨é‡Šã€iOSç³»ç»Ÿç”¨åˆ°çš„ï¼Œç²¾ç®€ä¹‹åå¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465void map_images_nolock(unsigned mhCount, const char * const mhPaths[], const struct mach_header * const mhdrs[]){ static bool firstTime = YES; header_info *hList[mhCount]; uint32_t hCount; size_t selrefCount = 0; if (firstTime) { preopt_init(); } // Find all images with Objective-C metadata. hCount = 0; // Count classes. Size various table based on the total. int totalClasses = 0; int unoptimizedTotalClasses = 0; { uint32_t i = mhCount; while (i--) { const headerType *mhdr = (const headerType *)mhdrs[i]; auto hi = addHeader(mhdr, mhPaths[i], totalClasses, unoptimizedTotalClasses); if (!hi) { // no objc data in this entry continue; } if (mhdr-&gt;filetype == MH_EXECUTE) { // Size some data structures based on main executable is size#if __OBJC2__ size_t count; _getObjc2SelectorRefs(hi, &amp;count); selrefCount += count; _getObjc2MessageRefs(hi, &amp;count); selrefCount += count;#else _getObjcSelectorRefs(hi, &amp;selrefCount);#endif } hList[hCount++] = hi; } } // Perform one-time runtime initialization that must be deferred until // the executable itself is found. This needs to be done before // further initialization. // (The executable may not be present in this infoList if the // executable does not contain Objective-C code but Objective-C // is dynamically loaded later. if (firstTime) { sel_init(selrefCount); arr_init(); } if (hCount &gt; 0) { _read_images(hList, hCount, totalClasses, unoptimizedTotalClasses); } firstTime = NO;} ç°åœ¨å¼€å§‹åˆ†æç²¾ç®€ä¹‹åçš„ä»£ç  firstTimeä¸€ä¸ªç”¨staticä¿®é¥°çš„å±€éƒ¨æˆå‘˜å˜é‡ï¼Œè®°å½•ç¬¬ä¸€æ¬¡éœ€è¦åšçš„äº‹ã€‚ _getObjc2SelectorRefså‡½æ•°ï¼Œä»mach_oè¯»å–__objc_selrefsæ®µçš„ä¿¡æ¯ã€‚ _getObjc2MessageRefså‡½æ•°ï¼Œä»mach_oè¯»å–__objc_msgrefsæ®µçš„ä¿¡æ¯ã€‚ ç¬¬ä¸€æ¬¡éœ€è¦æ‰§è¡Œçš„å‡½æ•°preopt_init()ã€sel_init()ã€arr_init()ã€‚ _read_images()å‡½æ•°ï¼Œè¯»å–é•œåƒæ–‡ä»¶ã€‚ 2.1 preopt_init()æ³¨é‡Šæè¿°è¿™é‡Œä¼šå»¶è¿Ÿåˆå§‹åŒ–ï¼Œä¸»è¦æ˜¯å…±äº«ç¼“å­˜æœ‰äº†ä¹‹åçš„å¤„ç†ã€‚ 2.2 sel_init() å»æ‰å…¶ä»–ä¿¡æ¯ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ˜¯æ³¨å†Œäº†ä¸€äº›ç³»ç»Ÿæä¾›çš„APIã€‚ 2.3 arr_init() è¿™ä¸€å—ä¹Ÿæ˜¯æ¯”è¾ƒé‡è¦çš„ä¿¡æ¯ï¼Œè®©æˆ‘ä»¬çŸ¥é“äº†AutorereleasePoolPageå’ŒSideTableçš„åˆå§‹åŒ–åœ¨è¿™é‡Œæ˜¯æœ‰æ‰§è¡Œçš„ã€‚ 2.4 _read_images()å‰é¢çš„ä¸‰ä¸ªå‡½æ•°ä¸æ˜¯æˆ‘ä»¬ç›®å‰æ¢ç´¢çš„é‡ç‚¹ï¼Œåªæ˜¯ç®€å•çš„åˆ†æäº†ä¸€ä¸‹ã€‚ä¸‹é¢æˆ‘ä»¬å¼€å§‹æ·±å…¥_read_images()ï¼Œè¯·çœ‹æ¥ä¸‹æ¥çš„ç±»åŠ è½½éƒ¨åˆ†ã€‚ ä¸‰ã€ç±»åŠ è½½å…¥å£ï¼š_read_images() å‡½æ•°è¯»å–é•œåƒæ–‡ä»¶ã€‚ç”±äºè¿™ä¸ªå‡½æ•°çš„ä»£ç æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬æŠŠå…¶ä¸­çš„ä»£ç å…ˆç”¨ä¼ªä»£ç çš„ä¿¡æ¯å±•ç¤ºå‡ºæ¥ï¼Œç„¶åå†æ¥è®²è§£æ¯ä¸€æ­¥ã€‚ 1234567891011121314151617181920212223242526272829303132333435void _read_images(header_info **hList, uint32_t hCount, int totalClasses, int unoptimizedTotalClasses){ 1. å®šä¹‰å±€éƒ¨å˜é‡ï¼Œå¤„ç†ç¬¬ä¸€æ¬¡è¦åšçš„äº‹æƒ…ã€‚ if (!doneOnce){ ... } 2. ç±»çš„é‡æ˜ å°„ for (EACH_HEADER) { ... } 3. ä¿®å¤é‡æ˜ å°„ if (!noClassesRemapped()) { ... } 4. æ·»åŠ SELåˆ°namedSelectorsè¡¨ { ... } 5. ä¿®å¤æ—§çš„å‡½æ•°æŒ‡é’ˆè°ƒç”¨é—ç•™ for (EACH_HEADER) { ... } 6. æ·»åŠ Protocolåˆ°åè®®è¡¨ for (EACH_HEADER) { ... } 7. ä¿®å¤åè®®åˆ—è¡¨å¼•ç”¨ for (EACH_HEADER) { ... } 8. å®ç°éæ‡’åŠ è½½çš„ç±» for (EACH_HEADER) { ... } 9. Realize newly-resolved future classes if (resolvedFutureClasses) { ... } 10. å‘ç°å’Œå¤„ç†æ‰€æœ‰Category for (EACH_HEADER) { ... } 11. +load handled by prepare_load_methods() if (DebugNonFragileIvars) { ... }} é‡è¦çš„æœ‰ç¬¬1æ­¥ã€ç¬¬2æ­¥ã€ç¬¬11æ­¥ã€‚ 3.1 ç¬¬ä¸€æ¬¡è¦åšçš„äº‹æƒ… - doneOnceã€é‡è¦ã€‘å»æ‰æ‰“å°éƒ¨åˆ†çš„ä»£ç ã€ä¸iOSæ“ä½œç³»ç»Ÿä¸ç›¸å¹²çš„ä»£ç ã€‚ 123456789101112131415161718192021222324252627282930313233343536if (!doneOnce) { doneOnce = YES;#if SUPPORT_NONPOINTER_ISA# if SUPPORT_INDEXED_ISA# endif# if TARGET_OS_OSX# endif#endif if (DisableTaggedPointers) { disableTaggedPointers(); } initializeTaggedPointerObfuscator(); if (PrintConnecting) { _objc_inform(&quot;CLASS: found %d classes during launch&quot;, totalClasses); } // namedClasses // Preoptimized classes do not go in this table. // 4/3 is NXMapTable is load factor int namedClassesSize = (isPreoptimized() ? unoptimizedTotalClasses : totalClasses) * 4 / 3; gdb_objc_realized_classes = NXCreateMapTable(NXStrValueMapPrototype, namedClassesSize); allocatedClasses = NXCreateHashTable(NXPtrPrototype, 0, nil); ts.log(&quot;IMAGE TIMES: first time tasks&quot;); } disableTaggedPointers()å‡½æ•°ï¼Œæ¡ä»¶å…è®¸çš„æ—¶å€™ï¼Œç¦ç”¨taggedPointersã€‚ initializeTaggedPointerObfuscatorå‡½æ•°ï¼Œåˆå§‹åŒ–taggedPointerã€‚ gdb_objc_realized_classesé€šè¿‡NXæŠ€æœ¯åˆ›å»ºçš„mapTableï¼Œè¿™å¼ è¡¨é‡Œé¢åŒ…å«çš„æ‰€æœ‰ç±»çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºæ€»è¡¨ã€‚ allocatedClassesé€šè¿‡NXæŠ€æœ¯åˆ›å»ºçš„HashTableï¼Œè¿™å¼ è¡¨åªåŒ…å«å·²ç»å¼€è¾Ÿçš„ç±»çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºå·²å¼€è¾Ÿç±»çš„è¡¨ã€‚ 3.2 å¯¹æ‰€æœ‰ç±»åšé‡æ˜ å°„ã€é‡è¦ã€‘ä»åˆ—è¡¨ä¸­å–å‡ºæ‰€æœ‰ç±»ï¼Œéå†è¿›è¡Œå¤„ç† 123456789101112131415161718192021222324252627282930313233for (EACH_HEADER) { // ä»ç¼–è¯‘åçš„ç±»åˆ—è¡¨ä¸­å–å‡ºæ‰€æœ‰ç±»ï¼Œè·å–åˆ°çš„æ˜¯ä¸€ä¸ªclassref_tç±»å‹çš„æŒ‡é’ˆ classref_t *classlist = _getObjc2ClassList(hi, &amp;count); if (! mustReadClasses(hi)) { // Image is sufficiently optimized that we need not call readClass() continue; } bool headerIsBundle = hi-&gt;isBundle(); bool headerIsPreoptimized = hi-&gt;isPreoptimized(); for (i = 0; i &lt; count; i++) { // æ•°ç»„ä¸­ä¼šå–å‡ºOS_dispatch_queue_concurrentã€OS_xpc_objectã€NSRunloopç­‰ç³»ç»Ÿç±»ï¼Œä¾‹å¦‚CFã€Fundationã€libdispatchä¸­çš„ç±»ã€‚ä»¥åŠè‡ªå·±åˆ›å»ºçš„ç±» Class cls = (Class)classlist[i]; // é€šè¿‡readClasså‡½æ•°è·å–å¤„ç†åçš„æ–°ç±»ï¼Œ Class newCls = readClass(cls, headerIsBundle, headerIsPreoptimized); // åˆå§‹åŒ–æ‰€æœ‰æ‡’åŠ è½½çš„ç±»éœ€è¦çš„å†…å­˜ç©ºé—´ - ç°åœ¨æ•°æ®æ²¡æœ‰åŠ è½½åˆ°çš„ - è¿ç±»éƒ½æ²¡æœ‰åˆå§‹åŒ–çš„ if (newCls != cls &amp;&amp; newCls) { // Class was moved but not deleted. Currently this occurs // only when the new class resolved a future class. // Non-lazily realize the class below. // å°†æ‡’åŠ è½½çš„ç±»æ·»åŠ åˆ°æ•°ç»„ä¸­ resolvedFutureClasses = (Class *) realloc(resolvedFutureClasses, (resolvedFutureClassCount+1) * sizeof(Class)); resolvedFutureClasses[resolvedFutureClassCount++] = newCls; } }} readClassæ–¹æ³•ä¼šè¿”å›Classï¼Œè·Ÿè¿›å»çœ‹çœ‹å…·ä½“å®ç° å½“å‰ç±»çš„çˆ¶ç±»ä¸­è‹¥æœ‰ä¸¢å¤±çš„weak-linkedç±»ï¼Œåˆ™è¿”å›nil æ­£å¸¸æƒ…å†µä¸‹ä¸ä¼šèµ°è¿›popFutureNamedClassåˆ¤æ–­ï¼Œè¿™æ˜¯ä¸“é—¨é’ˆå¯¹æœªæ¥çš„å¾…å¤„ç†çš„ç±»çš„ç‰¹æ®Šæ“ä½œï¼Œå› æ­¤ä¹Ÿä¸ä¼šå¯¹roã€rwè¿›è¡Œæ“ä½œï¼ˆå¯æ‰“æ–­ç‚¹è°ƒè¯•ï¼Œåˆ›å»ºç±»å’Œç³»ç»Ÿç±»éƒ½ä¸ä¼šè¿›å…¥ï¼‰ åœ¨è°ƒç”¨addNamedClassï¼ŒaddClassTableEntryæ–¹æ³•åè¿”å›cls å°†å½“å‰ç±»æ·»åŠ åˆ°å·²åˆ›å»ºå¥½çš„gdb_objc_realized_classeså“ˆå¸Œè¡¨ï¼ˆæ€»è¡¨ï¼‰ 12345678910111213141516171819static void addNamedClass(Class cls, const char *name, Class replacing = nil){ runtimeLock.assertLocked(); Class old; if ((old = getClassExceptSomeSwift(name)) &amp;&amp; old != replacing) { inform_duplicate(name, old, cls); // getMaybeUnrealizedNonMetaClass uses name lookups. // Classes not found by name lookup must be in the // secondary meta-&gt;nonmeta table. addNonMetaClass(cls); } else { NXMapInsert(gdb_objc_realized_classes, name, cls); } assert(!(cls-&gt;data()-&gt;flags &amp; RO_META)); // wrong: constructed classes are already realized when they get here // assert(!cls-&gt;isRealized());} å½“å‰ç±»å·²ç»åˆå§‹åŒ–ï¼Œæ‰€ä»¥è¦æ·»åŠ åˆ°allocatedClasseså“ˆå¸Œè¡¨(å·²å¼€è¾Ÿç±»çš„è¡¨) 123456789101112static void addClassTableEntry(Class cls, bool addMeta = true) { runtimeLock.assertLocked(); // This class is allowed to be a known class via the shared cache or via // data segments, but it is not allowed to be in the dynamic table already. assert(!NXHashMember(allocatedClasses, cls)); if (!isKnownClass(cls)) NXHashInsert(allocatedClasses, cls); if (addMeta) addClassTableEntry(cls-&gt;ISA(), false);} 3.3 ä¿®å¤é‡æ˜ å°„å°†æœªæ˜ å°„Classå’ŒSuper Classé‡æ˜ å°„ï¼Œè°ƒç”¨_getObjc2ClassRefsè·å–ç±»çš„å¼•ç”¨ï¼Œè°ƒç”¨_getObjc2SuperRefsè·å–çˆ¶ç±»çš„å¼•ç”¨ï¼Œé€šè¿‡remapClassRefè¿›è¡Œé‡æ˜ å°„ 123456789101112131415// å°†æœªæ˜ å°„Classå’ŒSuper Classé‡æ˜ å°„ï¼Œè¢«remapçš„ç±»éƒ½æ˜¯éæ‡’åŠ è½½çš„ç±»if (!noClassesRemapped()) { for (EACH_HEADER) { // é‡æ˜ å°„Classï¼Œæ³¨æ„æ˜¯ä»_getObjc2ClassRefså‡½æ•°ä¸­å–å‡ºç±»çš„å¼•ç”¨ Class *classrefs = _getObjc2ClassRefs(hi, &amp;count); for (i = 0; i &lt; count; i++) { remapClassRef(&amp;classrefs[i]); } // fixme why doesn't test future1 catch the absence of this? classrefs = _getObjc2SuperRefs(hi, &amp;count); for (i = 0; i &lt; count; i++) { remapClassRef(&amp;classrefs[i]); } }} 3.4 æ·»åŠ SELåˆ°namedSelectorsè¡¨é€šè¿‡_getObjc2SelectorRefsæ‹¿åˆ°MachOä¸­çš„é™æ€æ®µ__objc_selrefsï¼Œéå†åˆ—è¡¨è°ƒç”¨sel_registerNameNoLockå°†SELæ·»åŠ åˆ°namedSelectorså“ˆå¸Œè¡¨ 123456789101112131415161718// å°†æ‰€æœ‰SELéƒ½æ³¨å†Œåˆ°å“ˆå¸Œè¡¨ä¸­ï¼Œæ˜¯å¦å¤–ä¸€å¼ å“ˆå¸Œè¡¨// Fix up @selector referencesstatic size_t UnfixedSelectors;{ mutex_locker_t lock(selLock); for (EACH_HEADER) { if (hi-&gt;isPreoptimized()) continue; bool isBundle = hi-&gt;isBundle(); SEL *sels = _getObjc2SelectorRefs(hi, &amp;count); UnfixedSelectors += count; for (i = 0; i &lt; count; i++) { const char *name = sel_cname(sels[i]); // æ³¨å†ŒSELçš„æ“ä½œ sels[i] = sel_registerNameNoLock(name, isBundle); } }} 3.5 ä¿®å¤æ—§çš„å‡½æ•°æŒ‡é’ˆè°ƒç”¨é—ç•™é€šè¿‡_getObjc2MessageRefsè·å–åˆ°é™æ€æ®µ__objc_selrefsï¼ŒfixupMessageReféå†å°†å‡½æ•°æŒ‡é’ˆè¿›è¡Œæ³¨å†Œï¼Œå¹¶fixä¸ºæ–°çš„å‡½æ•°æŒ‡é’ˆ 123456789101112131415// Fix up old objc_msgSend_fixup call sites// ä¿®å¤æ—§çš„å‡½æ•°æŒ‡é’ˆè°ƒç”¨é—ç•™for (EACH_HEADER) { message_ref_t *refs = _getObjc2MessageRefs(hi, &amp;count); if (count == 0) continue; if (PrintVtables) { _objc_inform(&quot;VTABLES: repairing %zu unsupported vtable dispatch &quot; &quot;call sites in %s&quot;, count, hi-&gt;fname()); } for (i = 0; i &lt; count; i++) { // å†…éƒ¨å°†å¸¸ç”¨çš„allocã€objc_msgSendç­‰å‡½æ•°æŒ‡é’ˆè¿›è¡Œæ³¨å†Œï¼Œå¹¶fixä¸ºæ–°çš„å‡½æ•°æŒ‡é’ˆ fixupMessageRef(refs+i); }} 3.6 å°†æ‰€æœ‰Protocoléƒ½æ·»åŠ åˆ°protocol_mapè¡¨ä¸­è°ƒç”¨_getObjc2ProtocolListè·å–åˆ°__objc_protoliståè®®åˆ—è¡¨ï¼ŒreadProtocoléå†æ·»åŠ Protocolåˆ°protocol_mapå“ˆå¸Œè¡¨ 12345678910111213141516171819// Discover protocols. Fix up protocol refs.// éå†æ‰€æœ‰åè®®åˆ—è¡¨ï¼Œå¹¶ä¸”å°†åè®®åˆ—è¡¨åŠ è½½åˆ°Protocolçš„å“ˆå¸Œè¡¨ä¸­for (EACH_HEADER) { extern objc_class OBJC_CLASS_$_Protocol; // cls = Protocolç±»ï¼Œæ‰€æœ‰åè®®å’Œå¯¹è±¡çš„ç»“æ„ä½“éƒ½ç±»ä¼¼ï¼Œisaéƒ½å¯¹åº”Protocolç±» Class cls = (Class)&amp;OBJC_CLASS_$_Protocol; assert(cls); // è·å–protocolå“ˆå¸Œè¡¨ NXMapTable *protocol_map = protocols(); bool isPreoptimized = hi-&gt;isPreoptimized(); bool isBundle = hi-&gt;isBundle(); // ä»ç¼–è¯‘å™¨ä¸­è¯»å–å¹¶åˆå§‹åŒ–Protocol protocol_t **protolist = _getObjc2ProtocolList(hi, &amp;count); for (i = 0; i &lt; count; i++) { readProtocol(protolist[i], cls, protocol_map, isPreoptimized, isBundle); }} 3.7 å¯¹æ‰€æœ‰Protocolåšé‡æ˜ å°„é€šè¿‡_getObjc2ProtocolRefsè·å–åˆ°__objc_protorefsï¼ˆä¸__objc_protolistä¸æ˜¯åŒä¸€ä¸ªä¸œè¥¿ï¼‰éå†remapProtocolRefä¿®å¤åè®®ï¼ŒremapProtocolRefæ¯”è¾ƒå½“å‰åè®®å’Œåè®®åˆ—è¡¨ä¸­åŒä¸€å†…å­˜åœ°å€çš„åè®®æ˜¯å¦ç›¸åŒï¼Œå¦‚æœä¸åŒåˆ™æ›¿æ¢ 1234567891011// Fix up @protocol references// Preoptimized images may have the right // answer already but we don't know for sure.// ä¿®å¤åè®®åˆ—è¡¨å¼•ç”¨ï¼Œä¼˜åŒ–åçš„imageså¯èƒ½æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯å¹¶ä¸ç¡®å®šfor (EACH_HEADER) { // éœ€è¦æ³¨æ„åˆ°æ˜¯ï¼Œä¸‹é¢çš„å‡½æ•°æ˜¯_getObjc2ProtocolRefsï¼Œå’Œä¸Šé¢çš„_getObjc2ProtocolListä¸ä¸€æ · protocol_t **protolist = _getObjc2ProtocolRefs(hi, &amp;count); for (i = 0; i &lt; count; i++) { remapProtocolRef(&amp;protolist[i]); }} 3.8 åˆå§‹åŒ–æ‰€æœ‰éæ‡’åŠ è½½çš„ç±»ï¼Œè¿›è¡Œrwã€roç­‰æ“ä½œã€é‡è¦ã€‘è‹¹æœå®˜æ–¹å¯¹äºéæ‡’åŠ è½½ç±»çš„å®šä¹‰æ˜¯ï¼šå®ç°äº†+loadæ–¹æ³•çš„ç±»æ˜¯éæ‡’åŠ è½½ç±»ï¼Œå¦åˆ™å°±æ˜¯æ‡’åŠ è½½ç±» ä¸‹é¢æ˜¯éæ‡’åŠ è½½ç±»çš„åŠ è½½æµç¨‹: _getObjc2NonlazyClassListè·å–åˆ°__objc_nlclslistï¼Œå–å‡ºéæ‡’åŠ è½½ç±» addClassTableEntryå†åŠ è½½ä¸€éâ€”â€”å¦‚æœå·²æ·»åŠ å°±ä¸ä¼šæ·»åŠ è¿›å»ï¼Œç¡®ä¿æ•´ä¸ªç»“æ„éƒ½è¢«æ·»åŠ  realizeClassWithoutSwiftæ˜¯æ¥ä¸‹æ¥è¦å…³æ³¨çš„åœ°æ–¹ 123456789101112131415161718192021222324252627282930313233343536373839404142// Realize non-lazy classes (for +load methods and static instances)// å®ç°éæ‡’åŠ è½½çš„ç±»ï¼Œå¯¹äºloadæ–¹æ³•å’Œé™æ€å®ä¾‹å˜é‡for (EACH_HEADER) { classref_t *classlist = _getObjc2NonlazyClassList(hi, &amp;count); for (i = 0; i &lt; count; i++) { Class cls = remapClass(classlist[i]); // printf(&quot;non-lazy Class:%s\\n&quot;,cls-&gt;mangledName()); if (!cls) continue; // hack for class __ARCLite__, which didn't get this above#if TARGET_OS_SIMULATOR if (cls-&gt;cache._buckets == (void*)&amp;_objc_empty_cache &amp;&amp; (cls-&gt;cache._mask || cls-&gt;cache._occupied)) { cls-&gt;cache._mask = 0; cls-&gt;cache._occupied = 0; } if (cls-&gt;ISA()-&gt;cache._buckets == (void*)&amp;_objc_empty_cache &amp;&amp; (cls-&gt;ISA()-&gt;cache._mask || cls-&gt;ISA()-&gt;cache._occupied)) { cls-&gt;ISA()-&gt;cache._mask = 0; cls-&gt;ISA()-&gt;cache._occupied = 0; }#endif addClassTableEntry(cls); if (cls-&gt;isSwiftStable()) { if (cls-&gt;swiftMetadataInitializer()) { _objc_fatal(&quot;Swift class %s with a metadata initializer &quot; &quot;is not allowed to be non-lazy&quot;, cls-&gt;nameForLogging()); } // fixme also disallow relocatable classes // We can't disallow all Swift classes because of // classes like Swift.__EmptyArrayStorage } // å®ç°æ‰€æœ‰éæ‡’åŠ è½½çš„ç±»(å®ä¾‹åŒ–ç±»å¯¹è±¡çš„ä¸€äº›ä¿¡æ¯ï¼Œä¾‹å¦‚rw) realizeClassWithoutSwift(cls); }} realizeClassWithoutSwiftåˆ†æï¼š â‘ rwåˆå§‹åŒ–å¹¶å°†roæ‹·è´ä¸€ä»½åˆ°rwä¸­çš„ro rwè¡¨ç¤ºreadWriteï¼Œç”±äºåŠ¨æ€æ€§ï¼Œå¯èƒ½ä¼šå¾€ç±»ä¸­æ·»åŠ å±æ€§ã€æ–¹æ³•ã€æ·»åŠ åè®® roè¡¨ç¤ºreadOnlyï¼Œåœ¨ç¼–è¯‘æ—¶å·²ç»ç¡®å®šäº†å†…å­˜ 12345678910111213ro = (const class_ro_t *)cls-&gt;data();if (ro-&gt;flags &amp; RO_FUTURE) { // This was a future class. rw data is already allocated. rw = cls-&gt;data(); ro = cls-&gt;data()-&gt;ro; cls-&gt;changeInfo(RW_REALIZED|RW_REALIZING, RW_FUTURE);} else { // Normal class. Allocate writeable class data. rw = (class_rw_t *)calloc(sizeof(class_rw_t), 1); rw-&gt;ro = ro; rw-&gt;flags = RW_REALIZED|RW_REALIZING; cls-&gt;setData(rw);} â‘¡é€’å½’è°ƒç”¨realizeClassWithoutSwiftå®Œå–„ç»§æ‰¿é“¾å¹¶å¤„ç†å½“å‰ç±»çš„çˆ¶ç±»ã€å…ƒç±»ï¼›å¦‚æœæœ‰çˆ¶ç±»ï¼Œå°±é€šè¿‡addSubclassæŠŠå½“å‰ç±»æ”¾åˆ°çˆ¶ç±»çš„å­ç±»åˆ—è¡¨ä¸­å» 123456789101112131415if (!cls) return nil;...supercls = realizeClassWithoutSwift(remapClass(cls-&gt;superclass));metacls = realizeClassWithoutSwift(remapClass(cls-&gt;ISA()));...// Update superclass and metaclass in case of remappingcls-&gt;superclass = supercls;cls-&gt;initClassIsa(metacls);...// Connect this class to its superclass's subclass listsif (supercls) { addSubclass(supercls, cls);} else { addRootClass(cls);} supercls = realizeClassWithoutSwift(remapClass(cls-&gt;superclass));é€’å½’çˆ¶ç±»çš„ä¿¡æ¯åˆå§‹åŒ–ï¼Œå‡ºå£æ˜¯çˆ¶ç±»ä¸ºnilã€‚ metacls = realizeClassWithoutSwift(remapClass(cls-&gt;ISA()));é€’å½’å…ƒç±»çš„ä¿¡æ¯åˆå§‹åŒ–ï¼Œå‡ºå£æ˜¯å…ƒç±»çš„å…ƒç±»ä¸ºè‡ªå·±ã€‚ if (supercls) {addSubclass(supercls, cls);} else { addRootClass(cls);}ï¼Œå¤„ç†class_data_bits_tæˆå‘˜åŒå‘ç»‘å®šçˆ¶ç±»ï¼Œå­ç±»ã€‚ â‘¢remapClassä¸­å¯¹ç±»åœ¨è¡¨ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¦‚æœè¡¨ä¸­å·²æœ‰è¯¥ç±»ï¼Œåˆ™è¿”å›ä¸€ä¸ªç©ºå€¼ï¼›å¦‚æœæ²¡æœ‰åˆ™è¿”å›å½“å‰ç±»ï¼Œè¿™æ ·ä¿è¯äº†ç±»åªåŠ è½½ä¸€æ¬¡å¹¶ç»“æŸé€’å½’ 123456789101112131415static Class remapClass(Class cls){ runtimeLock.assertLocked(); Class c2; if (!cls) return nil; NXMapTable *map = remappedClasses(NO); if (!map || NXMapMember(map, cls, (void**)&amp;c2) == NX_MAPNOTAKEY) { return cls; } else { return c2; }} â‘£æœ€åè°ƒç”¨äº†methodizeClass 123// Attach categoriesmethodizeClass(cls);return cls; â‘¤åœ¨methodizeClassä¸­ï¼Œä»roä¸­è¯»å–æ–¹æ³•åˆ—è¡¨ï¼ˆåŒ…æ‹¬åˆ†ç±»ä¸­çš„æ–¹æ³•ï¼‰ã€å±æ€§åˆ—è¡¨ã€åè®®åˆ—è¡¨å†™åˆ°rwä¸­ï¼ŒåŒæ—¶ä¹Ÿä¼šåŠ è½½åˆ†ç±»çš„ä¿¡æ¯åˆ°ç±»é‡Œé¢ã€‚ 1234567891011121314151617181920212223242526272829...// Install methods and properties that the class implements itself.method_list_t *list = ro-&gt;baseMethods();if (list) { prepareMethodLists(cls, &amp;list, 1, YES, isBundleClass(cls)); rw-&gt;methods.attachLists(&amp;list, 1);}property_list_t *proplist = ro-&gt;baseProperties;if (proplist) { rw-&gt;properties.attachLists(&amp;proplist, 1);}protocol_list_t *protolist = ro-&gt;baseProtocols;if (protolist) { rw-&gt;protocols.attachLists(&amp;protolist, 1);}// Root classes get bonus method implementations if they don't have // them already. These apply before category replacements.if (cls-&gt;isRootMetaclass()) { // root metaclass addMethod(cls, SEL_initialize, (IMP)&amp;objc_noop_imp, &quot;&quot;, NO);}// Attach categories.category_list *cats = unattachedCategoriesForClass(cls, true /*realizing*/);attachCategories(cls, cats, false /*don't flush caches*/);... ä¸ºä»€ä¹ˆè¦åŒºåˆ†roå’Œrwï¼Ÿ roçš„ç‰¹æ€§å°±æ˜¯åœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šäº†ã€‚æˆ‘ä»¬ä¸å¸Œæœ›è¿™äº›åŸå§‹æ•°æ®è¢«æ±¡æŸ“ï¼Œæ‰€ä»¥æŠŠè¿™äº›æ•°æ®å­˜åˆ°roä¸­ rwçš„ç‰¹æ€§æ˜¯å¯å˜çš„ã€‚å› ä¸ºruntimeçš„å­˜åœ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šåŠ¨æ€çš„æ·»åŠ å±æ€§ã€æ–¹æ³•ã€åè®®ç­‰ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠè¿™äº›æ•°æ®å­˜åˆ°å¯æ›´æ”¹çš„rwå½“ä¸­ å‰é¢å·²ç»æåˆ°äº†å®ç°+loadæ–¹æ³•çš„ç±»å°±æ˜¯éæ‡’åŠ è½½ç±»ï¼Œé‚£ä¹ˆæ²¡æœ‰å®ç°çš„ç±»å°±æ˜¯æ‡’åŠ è½½ç±»ã€‚ æ‰“å°éæ‡’åŠ è½½ç±»ï¼š å¯ä»¥é€šè¿‡printf(&quot;non-lazy Class:%s\\n&quot;,cls-&gt;mangledName())å»æ‰“å°è·å–åˆ°æ‰€æœ‰éæ‡’åŠ è½½ç±»ã€åªæœ‰å®ç°äº†+loadçš„ç±»æ‰ä¼šèµ°åˆ°è¿™é‡Œç„¶åè¢«æ‰“å°ï¼ˆFXPersonå†…éƒ¨å®ç°äº†+loadï¼Œå…¶ä»–éƒ½æ˜¯ç³»ç»Ÿå†…ç½®çš„ç±»ï¼‰ã€‘ é‚£ä¹ˆæ‡’åŠ è½½ç±»æ˜¯ä½•æ—¶åŠ åˆ°å†…å­˜ä¸­çš„å‘¢ï¼Ÿéœ€è¦çœ‹ä¸‹æ–‡åˆ†æã€‚ 3.9 å¤„ç†æ‰€æœ‰çš„åˆ†ç±»ï¼ŒåŒ…æ‹¬Classå’ŒMetal Classå°†åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­å…·ä½“ä»‹ç» 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748// Discover categories.// å‘ç°å’Œå¤„ç†æ‰€æœ‰Categoryfor (EACH_HEADER) { // å¤–éƒ¨å¾ªç¯éå†æ‰¾åˆ°å½“å‰ç±»ï¼ŒæŸ¥æ‰¾ç±»å¯¹åº”çš„Categoryæ•°ç»„ category_t **catlist = _getObjc2CategoryList(hi, &amp;count); bool hasClassProperties = hi-&gt;info()-&gt;hasCategoryClassProperties(); for (i = 0; i &lt; count; i++) { // å†…éƒ¨å¾ªç¯éå†å½“å‰ç±»çš„æ‰€æœ‰Category category_t *cat = catlist[i]; Class cls = remapClass(cat-&gt;cls); // é¦–å…ˆï¼Œé€šè¿‡å…¶æ‰€å±çš„ç±»æ³¨å†ŒCategoryã€‚å¦‚æœè¿™ä¸ªç±»å·²ç»è¢«å®ç°ï¼Œåˆ™é‡æ–°æ„é€ ç±»çš„æ–¹æ³•åˆ—è¡¨ã€‚ bool classExists = NO; if (cat-&gt;instanceMethods || cat-&gt;protocols || cat-&gt;instanceProperties) { // å°†Categoryæ·»åŠ åˆ°å¯¹åº”Classçš„valueä¸­ï¼Œvalueæ˜¯Classå¯¹åº”çš„æ‰€æœ‰categoryæ•°ç»„ addUnattachedCategoryForClass(cat, cls, hi); // å°†Categoryçš„methodã€protocolã€propertyæ·»åŠ åˆ°Class if (cls-&gt;isRealized()) { remethodizeClass(cls); classExists = YES; } if (PrintConnecting) { _objc_inform(&quot;CLASS: found category -%s(%s) %s&quot;, cls-&gt;nameForLogging(), cat-&gt;name, classExists ? &quot;on existing class&quot; : &quot;&quot;); } } // è¿™å—å’Œä¸Šé¢é€»è¾‘ä¸€æ ·ï¼ŒåŒºåˆ«åœ¨äºè¿™å—æ˜¯å¯¹Meta Classåšæ“ä½œï¼Œè€Œä¸Šé¢åˆ™æ˜¯å¯¹Classåšæ“ä½œ // æ ¹æ®ä¸‹é¢çš„é€»è¾‘ï¼Œä»ä»£ç çš„è§’åº¦æ¥è¯´ï¼Œæ˜¯å¯ä»¥å¯¹åŸç±»æ·»åŠ Categoryçš„ if (cat-&gt;classMethods || cat-&gt;protocols || (hasClassProperties &amp;&amp; cat-&gt;_classProperties)) { addUnattachedCategoryForClass(cat, cls-&gt;ISA(), hi); if (cls-&gt;ISA()-&gt;isRealized()) { remethodizeClass(cls-&gt;ISA()); } if (PrintConnecting) { _objc_inform(&quot;CLASS: found category +%s(%s)&quot;, cls-&gt;nameForLogging(), cat-&gt;name); } } }} 3.10 åˆå§‹åŒ–æ‰€æœ‰æœªåˆå§‹åŒ–çš„ç±»ã€é‡è¦ã€‘å®ç°æ‰€æœ‰çš„ç±»ã€‚åŒ…æ‹¬Swiftå’ŒOCï¼ŒåŒæ—¶ä¼šåˆå§‹åŒ–å…¶ä»–objc_classç»“æ„ä½“ç›¸å…³çš„ä¿¡æ¯ 123456789static void realizeAllClasses(void){ runtimeLock.assertLocked(); header_info *hi; for (hi = FirstHeader; hi; hi = hi-&gt;getNext()) { realizeAllClassesInImage(hi); // may drop and re-acquire runtimeLock }} å¾ªç¯å¤„ç†header_infoï¼Œè°ƒç”¨realizedAllClassesInImage()ã€‚ 1234567891011121314151617181920static void realizeAllClassesInImage(header_info *hi){ runtimeLock.assertLocked(); size_t count, i; classref_t *classlist; if (hi-&gt;areAllClassesRealized()) return; classlist = _getObjc2ClassList(hi, &amp;count); for (i = 0; i &lt; count; i++) { Class cls = remapClass(classlist[i]); // é‡æ–°æ˜ å°„ç±» if (cls) { realizeClassMaybeSwiftAndLeaveLocked(cls, runtimeLock); } } hi-&gt;setAllClassesRealized(YES);} å¾ªç¯è°ƒç”¨realizeClassMaybeSwiftAndLeaveLockedå‡½æ•° 12345static ClassrealizeClassMaybeSwiftAndLeaveLocked(Class cls, mutex_t&amp; lock){ return realizeClassMaybeSwiftMaybeRelock(cls, lock, true);} realizeClassMaybeSwiftMaybeRelockå‡½æ•°çœŸæ­£è°ƒç”¨çš„æ€»å…¥å£ 123456789101112131415161718192021static ClassrealizeClassMaybeSwiftMaybeRelock(Class cls, mutex_t&amp; lock, bool leaveLocked){ lock.assertLocked(); if (!cls-&gt;isSwiftStable_ButAllowLegacyForNow()) { // Non-Swift class. Realize it now with the lock still held. // fixme wrong in the future for objc subclasses of swift classes realizeClassWithoutSwift(cls); // éswiftç±» if (!leaveLocked) lock.unlock(); } else { // Swift class. We need to drop locks and call the Swift // runtime to initialize it. lock.unlock(); cls = realizeSwiftClass(cls); // swiftç±» assert(cls-&gt;isRealized()); // callback must have provoked realization if (leaveLocked) lock.lock(); } return cls;} é€šè¿‡åˆ¤æ–­æ˜¯å¦Swift classæ¥åŒºåˆ†Swiftå’ŒOCç±»çš„å®ç°å…¥å£ã€‚ ç„¶årealizeClassWithoutSwiftåœ¨3.8ä¸­åˆ†æè¿‡ä¸€æ¬¡äº†ã€‚ PSobjc4-756.2æºç æœ¬æ–‡ä½¿ç”¨ï¼šobjc4-756.2æºç  è¿›è¡Œåˆ†æ å‚è€ƒiOS åº•å±‚æ¢ç´¢ç¯‡Â·Easting iOSæ¢ç´¢ ç±»çš„åŠ è½½è¿‡ç¨‹","link":"/2021/01/21/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/08-%E7%B1%BB%E7%9A%84%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B/"},{"title":"11-weakåŸç†æ¢ç©¶","text":"å†…å­˜ç®¡ç†åœ¨APPå¼€å‘è¿‡ç¨‹ä¸­å æ®ç€ä¸€ä¸ªå¾ˆé‡è¦çš„åœ°ä½ï¼Œåœ¨iOSä¸­ï¼Œç³»ç»Ÿä¸ºæˆ‘ä»¬æä¾›äº†ARCçš„å¼€å‘ç¯å¢ƒï¼Œå¸®åŠ©æˆ‘ä»¬åšäº†å¾ˆå¤šå†…å­˜ç®¡ç†çš„å†…å®¹ã€‚æœ¬ç« æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ï¼Œå¹³æ—¶å¼€å‘ä¸­ä½¿ç”¨æœ€å¤šçš„weakåœ¨åº•å±‚æ˜¯å¦‚ä½•è¿›è¡Œå®ç°çš„ ä¸€ã€__strongã€__weakã€__unsafe_unretainedçš„åŒºåˆ«æˆ‘ä»¬é€šè¿‡ä¾‹å­æ¥çœ‹ä¸€ä¸‹__strongã€__weakã€__unsafe_unretainedçš„åŒºåˆ«ã€‚ é¦–å…ˆæ˜¯çœ‹å¦‚ä¸‹ä¾‹å­ï¼Œå¯ä»¥çŸ¥é“åœ¨ä¸´æ—¶ä½œç”¨åŸŸç»“æŸä¹‹åï¼Œç”Ÿæˆçš„å¯¹è±¡å°±ä¼šè¿›è¡Œé”€æ¯ï¼Œæˆ‘ä»¬åœ¨ä½œç”¨åŸŸå¤–éƒ¨ç”¨ä¿®é¥°ç¬¦æ¥æŒæœ‰å¯¹è±¡ï¼Œå†æ¥çœ‹ä¸€ä¸‹å¯¹è±¡çš„é”€æ¯æƒ…å†µ 123456789101112NSLog(@&quot;ä¸´æ—¶ä½œç”¨åŸŸå¼€å§‹&quot;);{ LGPerson *person = [[LGPerson alloc] init]; NSLog(@&quot;personå¯¹è±¡ï¼š%@&quot;, person);}NSLog(@&quot;ä¸´æ—¶ä½œç”¨åŸŸç»“æŸ&quot;);***************************æ‰“å°ç»“æœ******************************2020-01-19 10:57:13.910542+0800 objc-debug[74175:19740208] ä¸´æ—¶ä½œç”¨åŸŸå¼€å§‹2020-01-19 10:57:13.911181+0800 objc-debug[74175:19740208] personå¯¹è±¡ï¼š&lt;LGPerson: 0x10221c900&gt;2020-01-19 10:57:13.911277+0800 objc-debug[74175:19740208] LGPerson -[LGPerson dealloc]2020-01-19 10:57:13.911367+0800 objc-debug[74175:19740208] ä¸´æ—¶ä½œç”¨åŸŸç»“æŸ __strongå…ˆæ¥çœ‹ä¸€ä¸‹ç”¨__strongä¿®é¥°çš„ç»“æœã€‚å¯ä»¥å‘ç°ä¿®é¥°çš„å¯¹è±¡åœ¨ä½œç”¨åŸŸç»“æŸä¹‹åå¹¶æ²¡æœ‰é”€æ¯ï¼Œè¯´æ˜è¯¥å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å¢åŠ äº† 123456789101112131415__strong LGPerson *strongPerson;NSLog(@&quot;ä¸´æ—¶ä½œç”¨åŸŸå¼€å§‹&quot;);{ LGPerson *person = [[LGPerson alloc] init]; NSLog(@&quot;personå¯¹è±¡ï¼š%@&quot;, person); strongPerson = person;}NSLog(@&quot;ä¸´æ—¶ä½œç”¨åŸŸç»“æŸ&quot;);NSLog(@&quot;strongPersonï¼š%@&quot;, strongPerson);***************************æ‰“å°ç»“æœ******************************2020-01-19 11:54:44.079292+0800 objc-debug[74452:19777011] ä¸´æ—¶ä½œç”¨åŸŸå¼€å§‹2020-01-19 11:54:44.080060+0800 objc-debug[74452:19777011] personå¯¹è±¡ï¼š&lt;LGPerson: 0x101945ae0&gt;2020-01-19 11:54:44.080172+0800 objc-debug[74452:19777011] ä¸´æ—¶ä½œç”¨åŸŸç»“æŸ2020-01-19 11:54:44.080292+0800 objc-debug[74452:19777011] strongPersonï¼š&lt;LGPerson: 0x101945ae0&gt; __weakå†æ¥çœ‹ä¸€ä¸‹__weakä¿®é¥°çš„ç»“æœã€‚é€šè¿‡ä¸‹é¢çš„è¿è¡Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œç”¨__weakä¿®é¥°åï¼Œå¹¶æ²¡æœ‰å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œå¹¶ä¸”ä½œç”¨åŸŸç»“æŸï¼Œå¯¹è±¡é‡Šæ”¾åï¼Œä¿®é¥°çš„å¯¹è±¡ä¸ºnilï¼Œæ²¡æœ‰é€ æˆé‡æŒ‡é’ˆçš„å´©æºƒï¼Œå¯ä»¥è¯´æ˜¯ä¸€ç§å®‰å…¨çš„æ–¹æ¡ˆ 12345678910111213141516__weak LGPerson *weakPerson;NSLog(@&quot;ä¸´æ—¶ä½œç”¨åŸŸå¼€å§‹&quot;);{ LGPerson *person = [[LGPerson alloc] init]; NSLog(@&quot;personå¯¹è±¡ï¼š%@&quot;, person); weakPerson = person;}NSLog(@&quot;ä¸´æ—¶ä½œç”¨åŸŸç»“æŸ&quot;);NSLog(@&quot;weakPersonï¼š%@&quot;, weakPerson);***************************æ‰“å°ç»“æœ******************************2020-01-19 11:58:08.842409+0800 objc-debug[74479:19780263] ä¸´æ—¶ä½œç”¨åŸŸå¼€å§‹2020-01-19 11:58:08.843151+0800 objc-debug[74479:19780263] personå¯¹è±¡ï¼š&lt;LGPerson: 0x101712030&gt;2020-01-19 11:58:08.843382+0800 objc-debug[74479:19780263] LGPerson -[LGPerson dealloc]2020-01-19 11:58:08.843572+0800 objc-debug[74479:19780263] ä¸´æ—¶ä½œç”¨åŸŸç»“æŸ2020-01-19 11:58:08.843762+0800 objc-debug[74479:19780263] weakPersonï¼š(null) __unsafe_unretainedæœ€åæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼Œå¹³æ—¶å¼€å‘ä½¿ç”¨è¾ƒå°‘çš„__unsafe_unretainedå’Œä¸Šé¢ä¸¤ä¸ªçš„åŒºåˆ«åœ¨å“ªã€‚æˆ‘ä»¬é€šè¿‡ç»“æœå¯ä»¥å‘ç°ï¼Œåœ¨ä½œç”¨åŸŸæ¶ˆå¤±ï¼Œå¯¹è±¡å°±è¿›è¡Œäº†é”€æ¯ï¼Œå¹¶ä¸”åœ¨å‡ºä½œç”¨åŸŸæ‰“å°ä¿®é¥°å¯¹è±¡æ—¶ï¼Œå‡ºç°äº†é‡æŒ‡é’ˆçš„å´©æºƒEXC_BAD_ACCESS æ‰€ä»¥è¿™æ ·å°±çœ‹å‡ºäº†__weakå’Œ__unsafe_unretainedçš„åŒºåˆ«å°±æ˜¯å‰è€…ä¼šåœ¨å¯¹è±¡è¢«é‡Šæ”¾çš„æ—¶å€™è‡ªåŠ¨ç½®ä¸ºnilï¼Œè€Œåè€…å´ä¸è¡Œã€‚ 123456789101112131415__unsafe_unretained LGPerson *unsafePerson;NSLog(@&quot;ä¸´æ—¶ä½œç”¨åŸŸå¼€å§‹&quot;);{ LGPerson *person = [[LGPerson alloc] init]; NSLog(@&quot;personå¯¹è±¡ï¼š%@&quot;, person); unsafePerson = person;}NSLog(@&quot;ä¸´æ—¶ä½œç”¨åŸŸç»“æŸ&quot;);NSLog(@&quot;unsafePersonï¼š%@&quot;, unsafePerson);***************************æ‰“å°ç»“æœ******************************2020-01-19 12:02:34.428120+0800 objc-debug[74513:19785153] ä¸´æ—¶ä½œç”¨åŸŸå¼€å§‹2020-01-19 12:02:34.428813+0800 objc-debug[74513:19785153] personå¯¹è±¡ï¼š&lt;LGPerson: 0x1019159f0&gt;2020-01-19 12:02:34.428901+0800 objc-debug[74513:19785153] LGPerson -[LGPerson dealloc]2020-01-19 12:02:34.429015+0800 objc-debug[74513:19785153] ä¸´æ—¶ä½œç”¨åŸŸç»“æŸ å°ç»“ __strongä¿®é¥°åï¼Œå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¼šå¢åŠ ï¼Œåœ¨ä½œç”¨åŸŸå¤–ä¸ä¼šé”€æ¯ __weakä¿®é¥°åï¼Œå¯¹è±¡å¼•ç”¨è®¡æ•°ä¸ä¼šå¢åŠ ï¼Œåœ¨ä½œç”¨åŸŸå¤–ä¼šè‡ªåŠ¨ç½®ä¸ºnil __unsafe_unretainedä¿®é¥°åï¼Œå¼•ç”¨è®¡æ•°ä¸ä¼šå¢åŠ ï¼Œåœ¨ä½œç”¨åŸŸå¤–ä¸ä¼šç½®ç©ºï¼Œä¼šé€ æˆé‡æŒ‡é’ˆå´©æºƒ é€šè¿‡ä¸Šé¢ä¾‹å­åŸºæœ¬äº†è§£äº†__weakçš„ä½œç”¨ï¼Œé‚£ä¹ˆ__weakæ˜¯å¦‚ä½•è¿›è¡Œåˆ›å»ºå’Œé”€æ¯çš„å‘¢ï¼Œä¸‹é¢é€šè¿‡æºç è¿›è¡Œæ·±åº¦æ¢ç´¢ äºŒã€weak ä»£ç å®šä½æ‰“æ–­ç‚¹æŸ¥çœ‹æ±‡ç¼– åœ¨æ±‡ç¼–ä¸­å‘ç°weakåº•å±‚è°ƒç”¨çš„æ˜¯objc_initWeak æˆ‘ä»¬ç»™objc_initWeakæ‰“ä¸Šç¬¦å·æ–­ç‚¹é‡æ–°è¿è¡Œï¼Œå‘ç°objc_initWeakå­˜åœ¨äºlibobjc.A.dylibçš„åŠ¨æ€åº“ä¸­ã€‚ ä¸‰ã€weak çš„ä¿å­˜é€»è¾‘é€šè¿‡ä¸Šé¢çš„åˆ†ææˆ‘ä»¬æŠŠ weak çš„åˆ›å»ºå®šä½åˆ°äº†objc_initWeakè¿™ä¸ªæ–¹æ³•ï¼Œä¸‹é¢å¼€å§‹è¿›è¡Œæºç åˆ†æ objc_initWeakå…¶ä¸­ä¸¤ä¸ªå‚æ•°locationå’ŒnewObjçš„å«ä¹‰å¦‚ä¸‹ locationï¼šè¡¨ç¤º__weak æŒ‡é’ˆçš„åœ°å€ã€‚ä¹‹æ‰€ä»¥è¦å­˜å‚¨æŒ‡é’ˆçš„åœ°å€ï¼Œæ˜¯å› ä¸ºæœ€åæˆ‘ä»¬è¦è®²__weakæŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ç½®ä¸ºnilï¼Œå¦‚æœä»…å­˜å‚¨æŒ‡é’ˆçš„è¯ï¼Œæ˜¯ä¸èƒ½å¤Ÿå®Œæˆè¿™ä¸ªåŠŸèƒ½çš„ã€‚ newObjï¼šæ‰€å¼•ç”¨çš„å¯¹è±¡ã€‚ 1234567891011idobjc_initWeak(id *location, id newObj){ if (!newObj) { *location = nil; return nil; } return storeWeak&lt;DontHaveOld, DoHaveNew, DoCrashIfDeallocating&gt; (location, (objc_object*)newObj);} storeWeakæŸ¥çœ‹storeWeakæºç ï¼Œæ ¹æ®æ³¨é‡Šï¼Œå¯ä»¥çŸ¥é“å¦‚ä¸‹å‡ ç‚¹ HaveOldï¼šweakæŒ‡é’ˆä¹‹å‰æ˜¯å¦å·²ç»æŒ‡å‘äº†ä¸€ä¸ªå¼±å¼•ç”¨ HaveNewï¼šweakæŒ‡é’ˆæ˜¯å¦éœ€è¦æŒ‡å‘ä¸€ä¸ªæ–°å¼•ç”¨ CrashIfDeallocatingï¼šå¦‚æœè¢«å¼±å¼•ç”¨çš„å¯¹è±¡æ­£åœ¨ææ„ï¼Œæ­¤æ—¶å†å¼±å¼•ç”¨è¯¥å¯¹è±¡ï¼Œæ˜¯å¦åº”è¯¥crashã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111// Update a weak variable.// If HaveOld is true, the variable has an existing value // that needs to be cleaned up. This value might be nil.// If HaveNew is true, there is a new value that needs to be // assigned into the variable. This value might be nil.// If CrashIfDeallocating is true, the process is halted if newObj is // deallocating or newObj's class does not support weak references. // If CrashIfDeallocating is false, nil is stored instead.enum CrashIfDeallocating { DontCrashIfDeallocating = false, DoCrashIfDeallocating = true};template &lt;HaveOld haveOld, HaveNew haveNew, CrashIfDeallocating crashIfDeallocating&gt;static id storeWeak(id *location, objc_object *newObj){ assert(haveOld || haveNew); if (!haveNew) assert(newObj == nil); Class previouslyInitializedClass = nil; id oldObj; SideTable *oldTable; SideTable *newTable; // Acquire locks for old and new values. // Order by lock address to prevent lock ordering problems. // Retry if the old value changes underneath us. retry: // âœ…å¦‚æœweakæŒ‡é’ˆä¹‹å‰å¼±å¼•ç”¨è¿‡ä¸€ä¸ªobjï¼Œåˆ™å°†è¿™ä¸ªobjæ‰€å¯¹åº”çš„SideTableå–å‡ºï¼Œèµ‹å€¼ç»™oldTable if (haveOld) { oldObj = *location; oldTable = &amp;SideTables()[oldObj]; } else { // æ²¡æœ‰å¼±å¼•ç”¨è¿‡ï¼Œåˆ™oldTable = nil oldTable = nil; } // âœ…å¦‚æœweakæŒ‡é’ˆè¦å¼±å¼•ç”¨ä¸€ä¸ªæ–°çš„objï¼Œåˆ™å°†è¯¥objå¯¹åº”çš„SideTableå–å‡ºï¼Œèµ‹å€¼ç»™newTable if (haveNew) { newTable = &amp;SideTables()[newObj]; } else { newTable = nil; } // âœ…åŠ é”æ“ä½œï¼Œé˜²æ­¢å¤šçº¿ç¨‹ä¸­ç«äº‰å†²çª SideTable::lockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable); // âœ…å¤šçº¿ç¨‹å®‰å…¨ï¼šlocation åº”è¯¥ä¸ oldObj ä¿æŒä¸€è‡´ï¼Œå¦‚æœä¸åŒï¼Œè¯´æ˜å½“å‰çš„ location å·²ç»å¤„ç†è¿‡ oldObj å¯æ˜¯åˆè¢«å…¶ä»–çº¿ç¨‹æ‰€ä¿®æ”¹ if (haveOld &amp;&amp; *location != oldObj) { SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable); goto retry; } // Prevent a deadlock between the weak reference machinery // and the +initialize machinery by ensuring that no // weakly-referenced object has an un-+initialized isa. if (haveNew &amp;&amp; newObj) { Class cls = newObj-&gt;getIsa(); // âœ…å¦‚æœclsè¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œå…ˆåˆå§‹åŒ–ï¼Œå†å°è¯•è®¾ç½®å¼±å¼•ç”¨ if (cls != previouslyInitializedClass &amp;&amp; !((objc_class *)cls)-&gt;isInitialized()) { SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable); class_initialize(cls, (id)newObj); // If this class is finished with +initialize then we're good. // If this class is still running +initialize on this thread // (i.e. +initialize called storeWeak on an instance of itself) // then we may proceed but it will appear initializing and // not yet initialized to the check above. // Instead set previouslyInitializedClass to recognize it on retry. // âœ…å®Œæˆåˆå§‹åŒ–åè¿›è¡Œæ ‡è®° previouslyInitializedClass = cls; // âœ…newObj åˆå§‹åŒ–åï¼Œé‡æ–°è·å–ä¸€énewObj goto retry; } } // Clean up old value, if any. // âœ… å¦‚æœweakæŒ‡é’ˆä¹‹å‰å¼±å¼•ç”¨è¿‡åˆ«çš„å¯¹è±¡oldObjï¼Œåˆ™è°ƒç”¨weak_unregister_no_lockï¼Œåœ¨oldObjçš„weak_entry_tä¸­ç§»é™¤è¯¥weakæŒ‡é’ˆåœ°å€ if (haveOld) { weak_unregister_no_lock(&amp;oldTable-&gt;weak_table, oldObj, location); } // Assign new value, if any. // âœ…å¦‚æœweakæŒ‡é’ˆéœ€è¦å¼±å¼•ç”¨æ–°çš„å¯¹è±¡newObj if (haveNew) { // âœ…è°ƒç”¨weak_register_no_lockæ–¹æ³•ï¼Œå°†weakæŒ‡é’ˆçš„åœ°å€è®°å½•åˆ°newObjå¯¹åº”çš„weak_entry_tä¸­ newObj = (objc_object *) weak_register_no_lock(&amp;newTable-&gt;weak_table, (id)newObj, location, crashIfDeallocating); // weak_register_no_lock returns nil if weak store should be rejected // Set is-weakly-referenced bit in refcount table. // âœ…æ›´æ–°newObjçš„isaæŒ‡é’ˆçš„weakly_referenced bitæ ‡å¿—ä½ if (newObj &amp;&amp; !newObj-&gt;isTaggedPointer()) { newObj-&gt;setWeaklyReferenced_nolock(); } // Do not set *location anywhere else. That would introduce a race. // âœ…*location èµ‹å€¼ï¼Œä¹Ÿå°±æ˜¯å°†weakæŒ‡é’ˆç›´æ¥æŒ‡å‘äº†newObjï¼Œè€Œä¸”æ²¡æœ‰å°†newObjçš„å¼•ç”¨è®¡æ•°+1 *location = (id)newObj; } else { // No new value. The storage is not changed. } SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable); return (id)newObj;} å› ä¸ºæˆ‘ä»¬è¿™é‡Œæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œæ‰€ä»¥æ˜¯ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯haveNewçš„æƒ…å†µï¼Œè·å–åˆ°çš„æ˜¯æ–°çš„æ•£åˆ—è¡¨SideTableï¼Œä¸»è¦æ‰§è¡Œäº†weak_register_no_lockæ–¹æ³•æ¥è¿›è¡Œæ’å…¥ã€‚ weak_register_no_lockæ¥ç€æˆ‘ä»¬æ¥åˆ†æweak_register_no_lockå‡½æ•°æ˜¯æ€ä¹ˆæ³¨å†Œå¼±å¼•ç”¨çš„ã€‚ æˆ‘ä»¬å‘ç°å‡½æ•°å†…éƒ¨ä¸»è¦è¿›è¡Œäº†isTaggedPointerå’Œdeallocatingçš„åˆ¤æ–­ç­‰å‰ç½®æ¡ä»¶ï¼Œè¿™äº›éƒ½æ˜¯ä¸èƒ½è¿›è¡Œå¼±å¼•ç”¨çš„æƒ…å†µã€‚ å¦‚æœå¯ä»¥è¢«å¼±å¼•ç”¨ï¼Œåˆ™å°†è¢«å¼±å¼•ç”¨å¯¹è±¡æ‰€åœ¨çš„weak_tableä¸­çš„weak_entry_tå“ˆå¸Œæ•°ç»„ä¸­å–å‡ºå¯¹åº”çš„weak_entry_tï¼Œå¦‚æœweak_entry_tä¸å­˜åœ¨ï¼Œåˆ™ä¼šæ–°å»ºä¸€ä¸ªã€‚ç„¶åå°†æŒ‡å‘è¢«å¼±å¼•ç”¨å¯¹è±¡åœ°å€çš„æŒ‡é’ˆreferreré€šè¿‡å‡½æ•°append_referreræ’å…¥åˆ°å¯¹åº”çš„weak_entry_tå¼•ç”¨æ•°ç»„ã€‚è‡³æ­¤å°±å®Œæˆäº†å¼±å¼•ç”¨ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768/** * Registers a new (object, weak pointer) pair. Creates a new weak * object entry if it does not exist. * * @param weak_table The global weak table. * @param referent The object pointed to by the weak reference. * @param referrer The weak pointer address. */id weak_register_no_lock(weak_table_t *weak_table, id referent_id, id *referrer_id, bool crashIfDeallocating){ // âœ…é¦–å…ˆè·å–éœ€è¦å¼±å¼•ç”¨å¯¹è±¡ objc_object *referent = (objc_object *)referent_id; objc_object **referrer = (objc_object **)referrer_id; // âœ…å¦‚æœè¢«å¼±å¼•ç”¨å¯¹è±¡referentä¸ºnil æˆ–è€…è¢«å¼±å¼•ç”¨å¯¹è±¡é‡‡ç”¨äº†TaggedPointerè®¡æ•°æ–¹å¼ï¼Œåˆ™ç›´æ¥è¿”å› if (!referent || referent-&gt;isTaggedPointer()) return referent_id; // ensure that the referenced object is viable // âœ…ç¡®ä¿è¢«å¼•ç”¨çš„å¯¹è±¡å¯ç”¨ï¼ˆæ²¡æœ‰åœ¨é”€æ¯ï¼ŒåŒæ—¶åº”è¯¥æ”¯æŒweakå¼±å¼•ç”¨ï¼‰ bool deallocating; if (!referent-&gt;ISA()-&gt;hasCustomRR()) { deallocating = referent-&gt;rootIsDeallocating(); } else { BOOL (*allowsWeakReference)(objc_object *, SEL) = (BOOL(*)(objc_object *, SEL)) object_getMethodImplementation((id)referent, SEL_allowsWeakReference); if ((IMP)allowsWeakReference == _objc_msgForward) { return nil; } deallocating = ! (*allowsWeakReference)(referent, SEL_allowsWeakReference); } // âœ…å¦‚æœæ˜¯æ­£åœ¨é”€æ¯çš„å¯¹è±¡ï¼Œé‚£ä¹ˆä¸èƒ½å¤Ÿè¢«å¼±å¼•ç”¨ if (deallocating) { if (crashIfDeallocating) { _objc_fatal(&quot;Cannot form weak reference to instance (%p) of &quot; &quot;class %s. It is possible that this object was &quot; &quot;over-released, or is in the process of deallocation.&quot;, (void*)referent, object_getClassName((id)referent)); } else { return nil; } } // now remember it and where it is being stored // âœ…åœ¨ weak_table ä¸­æ‰¾åˆ°è¢«å¼±å¼•ç”¨å¯¹è±¡ referent å¯¹åº”çš„ weak_entry,å¹¶å°† referrer åŠ å…¥åˆ° weak_entry ä¸­ weak_entry_t *entry; if ((entry = weak_entry_for_referent(weak_table, referent))) { // âœ…å¦‚æœèƒ½æ‰¾åˆ° weak_entry,åˆ™è®² referrer æ’å…¥åˆ° weak_entry ä¸­ append_referrer(entry, referrer); } else { // âœ…å¦‚æœæ‰¾ä¸åˆ° weak_entryï¼Œå°±æ–°å»ºä¸€ä¸ª weak_entry_t new_entry(referent, referrer); weak_grow_maybe(weak_table); weak_entry_insert(weak_table, &amp;new_entry); } // Do not set *referrer. objc_storeWeak() requires that the // value not change. return referent_id;} append_referrerè¿™ä¸€æ­¥ä¸»è¦æ˜¯æ‰¾åˆ°å¼±å¼•ç”¨å¯¹è±¡çš„å¯¹åº”çš„weak_entryå“ˆå¸Œæ•°ç»„ä¸­ï¼ŒåŸºæœ¬å°±æ˜¯ä¸ªéå†æ’å…¥çš„è¿‡ç¨‹ï¼ŒåŸç†æ¯”è¾ƒç®€å• 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152static void append_referrer(weak_entry_t *entry, objc_object **new_referrer){ // âœ…å¦‚æœweak_entry ä½¿ç”¨é™æ€æ•°ç»„ inline_referrers if (! entry-&gt;out_of_line()) { // Try to insert inline. // âœ…å°è¯•å°† referrer æ’å…¥æ•°ç»„ for (size_t i = 0; i &lt; WEAK_INLINE_COUNT; i++) { if (entry-&gt;inline_referrers[i] == nil) { entry-&gt;inline_referrers[i] = new_referrer; return; } } // Couldn't insert inline. Allocate out of line. // âœ…å¦‚æœinline_referrersçš„ä½ç½®å·²ç»å­˜æ»¡äº†ï¼Œåˆ™è¦è½¬å‹ä¸º referrersï¼ŒåŠ¨æ€æ•°ç»„ weak_referrer_t *new_referrers = (weak_referrer_t *) calloc(WEAK_INLINE_COUNT, sizeof(weak_referrer_t)); // This constructed table is invalid, but grow_refs_and_insert // will fix it and rehash it. for (size_t i = 0; i &lt; WEAK_INLINE_COUNT; i++) { new_referrers[i] = entry-&gt;inline_referrers[i]; } entry-&gt;referrers = new_referrers; entry-&gt;num_refs = WEAK_INLINE_COUNT; entry-&gt;out_of_line_ness = REFERRERS_OUT_OF_LINE; entry-&gt;mask = WEAK_INLINE_COUNT-1; entry-&gt;max_hash_displacement = 0; } assert(entry-&gt;out_of_line()); // âœ…å¦‚æœåŠ¨æ€æ•°ç»„ä¸­å…ƒç´ ä¸ªæ•°å¤§äºæˆ–ç­‰äºæ•°ç»„æ€»ç©ºé—´çš„3/4ï¼Œåˆ™æ‰©å±•æ•°ç»„ç©ºé—´ä¸ºå½“å‰é•¿åº¦çš„ä¸€å€ï¼Œç„¶åå°† referrer æ’å…¥æ•°ç»„ if (entry-&gt;num_refs &gt;= TABLE_SIZE(entry) * 3/4) { return grow_refs_and_insert(entry, new_referrer); } // âœ…å¦‚æœä¸éœ€è¦æ‰©å®¹ï¼Œç›´æ¥æ’å…¥åˆ°weak_entryä¸­ // âœ…&amp; (entry-&gt;mask) ä¿è¯ begin çš„ä½ç½®åªèƒ½å¤§äºæˆ–ç­‰äºæ•°ç»„çš„é•¿åº¦ size_t begin = w_hash_pointer(new_referrer) &amp; (entry-&gt;mask); size_t index = begin; size_t hash_displacement = 0; while (entry-&gt;referrers[index] != nil) { hash_displacement++; index = (index+1) &amp; entry-&gt;mask; if (index == begin) bad_weak_table(entry); } if (hash_displacement &gt; entry-&gt;max_hash_displacement) { entry-&gt;max_hash_displacement = hash_displacement; } weak_referrer_t &amp;ref = entry-&gt;referrers[index]; ref = new_referrer; entry-&gt;num_refs++;} weak_unregister_no_lockå¦‚æœweakæŒ‡é’ˆåœ¨æŒ‡å‘objä¹‹å‰ï¼Œå·²ç»å¼±å¼•ç”¨äº†å…¶ä»–çš„å¯¹è±¡ï¼Œåˆ™éœ€è¦å…ˆå°†weakæŒ‡é’ˆä»å…¶ä»–å¯¹è±¡çš„weak_entry_tçš„hashæ•°ç»„ä¸­ç§»é™¤ã€‚åœ¨storeWeakæ–¹æ³•ä¸­ä¼šè°ƒç”¨weak_unregister_no_lockå‡½æ•°æ¥åšç§»é™¤æ“ä½œã€‚ weak_unregister_no_lockå‡½æ•°é¦–å…ˆä¼šåœ¨weak_tableä¸­æ‰¾å‡ºä»¥å‰è¢«å¼±å¼•ç”¨çš„å¯¹è±¡referentå¯¹åº”çš„weak_entry_tï¼Œåœ¨weak_entry_tä¸­ç§»é™¤è¢«å¼±å¼•ç”¨çš„å¯¹è±¡referrerã€‚ç§»é™¤å…ƒç´ åï¼Œåˆ¤æ–­æ­¤æ—¶weak_entry_tä¸­æ˜¯å¦è¿˜æœ‰å…ƒç´ ã€‚å¦‚æœæ­¤æ—¶weak_entry_tå·²ç»æ²¡æœ‰å…ƒç´ äº†ï¼Œåˆ™éœ€è¦å°†weak_entry_tä»weak_tableä¸­ç§»é™¤ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940voidweak_unregister_no_lock(weak_table_t *weak_table, id referent_id, id *referrer_id){ // æ‹¿åˆ°ä»¥å‰å¼±å¼•ç”¨çš„å¯¹è±¡å’Œå¯¹è±¡çš„åœ°å€ objc_object *referent = (objc_object *)referent_id; objc_object **referrer = (objc_object **)referrer_id; weak_entry_t *entry; if (!referent) return; // æŸ¥æ‰¾åˆ°ä»¥å‰å¼±å¼•ç”¨çš„å¯¹è±¡ referent æ‰€å¯¹åº”çš„ weak_entry_t if ((entry = weak_entry_for_referent(weak_table, referent))) { // åœ¨ä»¥å‰å¼±å¼•ç”¨çš„å¯¹è±¡ referent æ‰€å¯¹åº”çš„ weak_entry_t çš„ hash æ•°ç»„ä¸­ï¼Œç§»é™¤å¼±å¼•ç”¨ referrer remove_referrer(entry, referrer); // ç§»é™¤å…ƒç´ ä¹‹åï¼Œ è¦æ£€æŸ¥ä¸€ä¸‹ weak_entry_t çš„ hash æ•°ç»„æ˜¯å¦å·²ç»ç©ºäº† bool empty = true; if (entry-&gt;out_of_line() &amp;&amp; entry-&gt;num_refs != 0) { empty = false; } else { for (size_t i = 0; i &lt; WEAK_INLINE_COUNT; i++) { if (entry-&gt;inline_referrers[i]) { empty = false; break; } } } // å¦‚æœ weak_entry_t çš„hashæ•°ç»„å·²ç»ç©ºäº†ï¼Œåˆ™éœ€è¦å°† weak_entry_t ä» weak_table ä¸­ç§»é™¤ if (empty) { weak_entry_remove(weak_table, entry); } } // Do not set *referrer = nil. objc_storeWeak() requires that the // value not change.} è‡³æ­¤ï¼Œä¸€ä¸ªå¯¹è±¡çš„å¼±å¼•ç”¨è¿‡ç¨‹å·²ç»ç»“æŸ å››ã€weak çš„é”€æ¯é€»è¾‘é€šè¿‡å¼€å¤´çš„ä¾‹å­ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå‡ºä½œç”¨åŸŸï¼Œå¯¹è±¡deallocåï¼Œä¼šè‡ªåŠ¨æŠŠå¼±å¼•ç”¨å¯¹è±¡ç½®ç©ºï¼Œé‚£ä¹ˆä»–æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•æŸ¥çœ‹ä¸‹ç±»çš„deallocçš„æºç ï¼š _objc_rootDealloc123456789101112131415161718192021222324252627282930313233343536373839- (void)dealloc { _objc_rootDealloc(self);}**********************************void _objc_rootDealloc(id obj){ assert(obj); obj-&gt;rootDealloc();}***********************************inline voidobjc_object::rootDealloc(){ // âœ…å¦‚æœæ˜¯Tagged Pointerï¼Œå°±ç›´æ¥è¿”å› if (isTaggedPointer()) return; // fixme necessary? /* âœ…å¦‚æœåŒæ—¶æ»¡è¶³ 1. æ˜¯ä¼˜åŒ–è¿‡çš„isaã€ 2. æ²¡æœ‰è¢«weakæŒ‡é’ˆå¼•ç”¨è¿‡ã€ 3. æ²¡æœ‰å…³è”å¯¹è±¡ã€ 4. æ²¡æœ‰C++ææ„å‡½æ•°ã€ 5. æ²¡æœ‰sideTableï¼Œ å°±å¯ä»¥ç›´æ¥é‡Šæ”¾å†…å­˜free() */ if (fastpath(isa.nonpointer &amp;&amp; !isa.weakly_referenced &amp;&amp; !isa.has_assoc &amp;&amp; !isa.has_cxx_dtor &amp;&amp; !isa.has_sidetable_rc)) { assert(!sidetable_present()); free(this); } else { //å¦åˆ™çš„è¯å°±éœ€è¦é€šè¿‡ä¸‹é¢çš„å‡½æ•°å¤„ç† object_dispose((id)this); }} æˆ‘ä»¬è¿™é‡Œæ˜¾ç„¶ä¸æ»¡è¶³ä¸Šè¿°æ¡ä»¶ï¼Œå› ä¸ºæˆ‘ä»¬å¼±å¼•ç”¨è¿‡ï¼Œç»§ç»­è·Ÿè¿›object_dispose object_disposeobject_disposeå‡½æ•°ä¸­è°ƒç”¨äº†objc_destructInstance 1234567891011id object_dispose(id obj){ if (!obj) return nil; objc_destructInstance(obj); free(obj); return nil;} objc_destructInstanceæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å†…éƒ¨ä¼šåšé”€æ¯C++ææ„å‡½æ•°ä»¥åŠç§»é™¤å…³è”å¯¹è±¡çš„æ“ä½œï¼Œçœ‹æ¥å¼±å¼•ç”¨è¦åœ¨clearDeallocatingä¸­äº† 123456789101112131415161718void *objc_destructInstance(id obj) { if (obj) { // Read all of the flags at once for performance. bool cxx = obj-&gt;hasCxxDtor(); bool assoc = obj-&gt;hasAssociatedObjects(); // This order is important. // å¦‚æœæœ‰C++ææ„å‡½æ•°ï¼Œåˆ™è¿è¡Œç›¸å…³å‡½æ•° if (cxx) object_cxxDestruct(obj); // å¦‚æœæœ‰å…³è”å¯¹è±¡ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„å…³è”å¯¹è±¡ï¼Œå¹¶å°†å…¶è‡ªèº«ä»Association Managerçš„mapä¸­ç§»é™¤ if (assoc) _object_remove_assocations(obj); // ç»§ç»­æ¸…ç†å…¶å®ƒç›¸å…³çš„å¼•ç”¨ obj-&gt;clearDeallocating(); } return obj;} clearDeallocating12345678910111213141516inline void objc_object::clearDeallocating(){ if (slowpath(!isa.nonpointer)) { // Slow path for raw pointer isa. // å¦‚æœè¦é‡Šæ”¾çš„å¯¹è±¡æ²¡æœ‰é‡‡ç”¨äº†ä¼˜åŒ–è¿‡çš„isaå¼•ç”¨è®¡æ•° sidetable_clearDeallocating(); } else if (slowpath(isa.weakly_referenced || isa.has_sidetable_rc)) { // Slow path for non-pointer isa with weak refs and/or side table data. // âœ… å¦‚æœè¦é‡Šæ”¾çš„å¯¹è±¡é‡‡ç”¨äº†ä¼˜åŒ–è¿‡çš„isaå¼•ç”¨è®¡æ•°ï¼Œå¹¶ä¸”æœ‰å¼±å¼•ç”¨æˆ–è€…ä½¿ç”¨äº†sideTableçš„è¾…åŠ©å¼•ç”¨è®¡æ•°ï¼ˆç°åœ¨ä¸€èˆ¬éƒ½æ˜¯ä¼˜åŒ–è¿‡çš„ isaï¼‰ clearDeallocating_slow(); } assert(!sidetable_present());} clearDeallocating_slowæˆ‘ä»¬ç°åœ¨ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨ä¼˜åŒ–çš„ isa ï¼Œæ‰€ä»¥èµ°clearDeallocating_slowå‡½æ•°ã€‚ æˆ‘ä»¬é€šè¿‡æºç å¯ä»¥çœ‹åˆ°ä¸»è¦æ“ä½œæ˜¯æ‰¾åˆ°å¯¹åº”çš„SideTableï¼Œç„¶ååœ¨SideTableçš„weak_tableä¸­ï¼Œå°†å¼±å¼•ç”¨å¯¹è±¡ç½®ç©ºï¼Œä¸»è¦çš„æ–¹æ³•ä¸ºweak_clear_no_lock 123456789101112131415161718NEVER_INLINE voidobjc_object::clearDeallocating_slow(){ assert(isa.nonpointer &amp;&amp; (isa.weakly_referenced || isa.has_sidetable_rc)); // åœ¨å…¨å±€çš„SideTablesä¸­ï¼Œä»¥thisæŒ‡é’ˆ(è¦é‡Šæ”¾çš„å¯¹è±¡)ä¸ºkeyï¼Œæ‰¾åˆ°å¯¹åº”çš„SideTable SideTable&amp; table = SideTables()[this]; table.lock(); if (isa.weakly_referenced) { // âœ… è¦é‡Šæ”¾çš„å¯¹è±¡è¢«å¼±å¼•ç”¨äº†ï¼Œé€šè¿‡weak_clear_no_lockå‡½æ•°å°†æŒ‡å‘è¯¥å¯¹è±¡çš„å¼±å¼•ç”¨æŒ‡é’ˆç½®ä¸ºnil weak_clear_no_lock(&amp;table.weak_table, (id)this); } // ä½¿ç”¨äº†sideTableçš„è¾…åŠ©å¼•ç”¨è®¡æ•°,ç›´æ¥åœ¨SideTableä¸­æ“¦é™¤è¯¥å¯¹è±¡çš„å¼•ç”¨è®¡æ•° if (isa.has_sidetable_rc) { table.refcnts.erase(this); } table.unlock();} weak_clear_no_lockæˆ‘ä»¬é€šè¿‡æºç å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ–¹æ³•å’Œæ’å…¥æ—¶çš„æ–¹æ³•æ¯”è¾ƒç±»ä¼¼ï¼Œéƒ½æ˜¯æ‰¾åˆ°å¯¹åº”çš„weak_entry_tæ•°ç»„ï¼Œç„¶åé€šè¿‡éå†æ‰¾åˆ°å¯¹åº”çš„æŒ‡é’ˆåœ°å€ï¼Œç„¶åç½®ä¸ºnilï¼Œé˜²æ­¢äº†é‡æŒ‡é’ˆçš„æŠ¥é”™ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950void weak_clear_no_lock(weak_table_t *weak_table, id referent_id) { // è·å–è¢«å¼±å¼•ç”¨å¯¹è±¡çš„åœ°å€ objc_object *referent = (objc_object *)referent_id; // æ ¹æ®å¯¹è±¡åœ°å€æ‰¾åˆ°è¢«å¼±å¼•ç”¨å¯¹è±¡ referent åœ¨ weak_table ä¸­å¯¹åº”çš„ weak_entry_t weak_entry_t *entry = weak_entry_for_referent(weak_table, referent); if (entry == nil) { /// XXX shouldn't happen, but does with mismatched CF/objc //printf(&quot;XXX no entry for clear deallocating %p\\n&quot;, referent); return; } // zero out references weak_referrer_t *referrers; size_t count; // æ‰¾å‡ºå¼±å¼•ç”¨è¯¥å¯¹è±¡çš„æ‰€æœ‰ weak æŒ‡é’ˆåœ°å€æ•°ç»„ if (entry-&gt;out_of_line()) { referrers = entry-&gt;referrers; count = TABLE_SIZE(entry); } else { referrers = entry-&gt;inline_referrers; count = WEAK_INLINE_COUNT; } // éå†å–å‡ºæ¯ä¸ª weak æŒ‡é’ˆçš„åœ°å€ for (size_t i = 0; i &lt; count; ++i) { objc_object **referrer = referrers[i]; if (referrer) { // å¦‚æœweakæŒ‡é’ˆç¡®å®å¼±å¼•ç”¨äº†å¯¹è±¡ referentï¼Œåˆ™å°†weakæŒ‡é’ˆè®¾ç½®ä¸ºnil if (*referrer == referent) { *referrer = nil; } // å¦‚æœæ‰€å­˜å‚¨çš„weakæŒ‡é’ˆæ²¡æœ‰å¼±å¼•ç”¨å¯¹è±¡ referentï¼Œè¿™å¯èƒ½æ˜¯ç”±äºruntimeä»£ç çš„é€»è¾‘é”™è¯¯å¼•èµ·çš„ï¼ŒæŠ¥é”™ else if (*referrer) { _objc_inform(&quot;__weak variable at %p holds %p instead of %p. &quot; &quot;This is probably incorrect use of &quot; &quot;objc_storeWeak() and objc_loadWeak(). &quot; &quot;Break on objc_weak_error to debug.\\n&quot;, referrer, (void*)*referrer, (void*)referent); objc_weak_error(); } } } weak_entry_remove(weak_table, entry);} è‡³æ­¤ï¼Œä¸€ä¸ªå¼±å¼•ç”¨çš„é”€æ¯ä¹Ÿå®Œæˆäº†ï¼Œå¹¶è‡ªåŠ¨ç½®ä¸ºnil äº”ã€æ€»ç»“ å½“ä¸€ä¸ªå¯¹è±¡objè¢«weakæŒ‡é’ˆæŒ‡å‘æ—¶ï¼Œè¿™ä¸ªweakæŒ‡é’ˆä¼šä»¥objä½œä¸ºkeyï¼Œè¢«å­˜å‚¨åˆ°sideTableç±»çš„weak_tableè¿™ä¸ªæ•£åˆ—è¡¨ä¸Šå¯¹åº”çš„ä¸€ä¸ªweakæŒ‡é’ˆæ•°ç»„é‡Œé¢ã€‚ å½“ä¸€ä¸ªå¯¹è±¡objçš„deallocæ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼ŒRuntimeä¼šä»¥objä¸ºkeyï¼Œä»sideTableçš„weak_tableæ•£åˆ—è¡¨ä¸­ï¼Œæ‰¾å‡ºå¯¹åº”çš„weakæŒ‡é’ˆåˆ—è¡¨ï¼Œç„¶åå°†é‡Œé¢çš„weakæŒ‡é’ˆé€ä¸ªç½®ä¸ºnilã€‚ åˆ›å»ºæµç¨‹ç®€å›¾ åˆ›å»ºæµç¨‹å°ç»“Runtimeç»´æŠ¤äº†ä¸€ä¸ªå¼±å¼•ç”¨è¡¨ï¼Œå°†æ‰€æœ‰å¼±å¼•ç”¨objçš„æŒ‡é’ˆåœ°å€éƒ½ä¿å­˜åœ¨objå¯¹åº”çš„weak_entry_tä¸­ã€‚ åˆ›å»ºæ—¶ï¼Œå…ˆä»æ‰¾åˆ°å…¨å±€æ•£åˆ—è¡¨SideTablesä¸­å¯¹åº”çš„å¼±å¼•ç”¨è¡¨weak_table åœ¨weak_tableä¸­è¢«å¼±å¼•ç”¨å¯¹è±¡çš„referentä¸­åˆ›å»ºæˆ–è€…æ’å…¥å¯¹åº”çš„weak_entry_t ç„¶åappend_referrer(entry, referrer)å°†æˆ‘çš„æ–°å¼±å¼•â½¤çš„å¯¹è±¡åŠ è¿›å»entry æœ€åweak_entry_insert æŠŠentryåŠ â¼Šåˆ°æˆ‘ä»¬çš„weak_table é”€æ¯æµç¨‹ç®€å›¾ é”€æ¯æµç¨‹å°ç»“ é¦–å…ˆæ ¹æ®å¯¹è±¡åœ°å€è·å–æ‰€æœ‰weakæŒ‡é’ˆåœ°å€çš„æ•°ç»„ ç„¶åéå†è¿™ä¸ªæ•°ç»„æŠŠå¯¹åº”çš„æ•°æ®æ¸…ç©ºç½®ä¸ºnil åŒæ—¶ï¼Œå°†weak_entry_tç§»é™¤å‡ºå¼±å¼•ç”¨è¡¨weak_tableã€‚ PSobjc4-756.2æºç æœ¬æ–‡ä½¿ç”¨ï¼šobjc4-756.2æºç  è¿›è¡Œåˆ†æ å‚è€ƒiOSåº•å±‚å­¦ä¹  - å†…å­˜ç®¡ç†ä¹‹weakåŸç†æ¢ç©¶ iOS weakå®ç°åŸç†","link":"/2021/02/17/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/11-weak%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/"},{"title":"13-KVCåŸç†","text":"ä¸€ã€KVCåˆæ¢1.KVCå®šä¹‰KVC(Key-Value Coding)æ˜¯åˆ©ç”¨NSKeyValueCoding åè®®å®ç°çš„ä¸€ç§æœºåˆ¶ï¼Œå¯¹è±¡é‡‡ç”¨è¿™ç§æœºåˆ¶æ¥æä¾›å¯¹å…¶å±æ€§çš„é—´æ¥è®¿é—®ã€‚ å†™ä¸‹ KVC ä»£ç setValueå¹¶ç‚¹å‡»è·Ÿè¿›ï¼Œå‘ç°å…¶ä½äºFoundationæ¡†æ¶ä¸­ KVCåœ¨NSObjectç±»çš„æ‰©å±•NSObject(NSKeyValueCoding)ä¸­ =&gt; æ‰€æœ‰ç»§æ‰¿è‡ªNSObjectçš„ç±»å‡å¯ä»¥ä½¿ç”¨KVC NSArrayã€NSDictionaryã€NSMutableDictionaryã€NSOrderedSetã€NSSetç­‰ä¹Ÿéµå®ˆKVCåè®® é™¤å°‘æ•°ç±»å‹(ç»“æ„ä½“)ä»¥å¤–éƒ½å¯ä»¥ä½¿ç”¨KVC 2.å¸¸ç”¨ API1234567891011// é€šè¿‡ key è®¾å€¼- (void)setValue:(nullable id)value forKey:(NSString *)key;// é€šè¿‡ key å–å€¼- (nullable id)valueForKey:(NSString *)key;// é€šè¿‡ keyPath è®¾å€¼- (void)setValue:(nullable id)value forKeyPath:(NSString *)keyPath;// é€šè¿‡ keyPath å–å€¼- (nullable id)valueForKeyPath:(NSString *)keyPath; NSKeyValueCodingç±»åˆ«çš„å…¶å®ƒæ–¹æ³• 1234567891011121314151617// é»˜è®¤ä¸ºYESã€‚ å¦‚æœè¿”å›ä¸ºYES,å¦‚æœæ²¡æœ‰æ‰¾åˆ° set&lt;Key&gt; æ–¹æ³•çš„è¯, ä¼šæŒ‰ç…§_key, _isKey, key, isKeyçš„é¡ºåºæœç´¢æˆå‘˜å˜é‡, è¿”å›NOåˆ™ä¸ä¼šæœç´¢+ (BOOL)accessInstanceVariablesDirectly;// é”®å€¼éªŒè¯, å¯ä»¥é€šè¿‡è¯¥æ–¹æ³•æ£€éªŒé”®å€¼çš„æ­£ç¡®æ€§, ç„¶ååšå‡ºç›¸åº”çš„å¤„ç†- (BOOL)validateValue:(inout id _Nullable * _Nonnull)ioValue forKey:(NSString *)inKey error:(out NSError **)outError;// å¦‚æœkeyä¸å­˜åœ¨, å¹¶ä¸”æ²¡æœ‰æœç´¢åˆ°å’Œkeyæœ‰å…³çš„å­—æ®µ, ä¼šè°ƒç”¨æ­¤æ–¹æ³•, é»˜è®¤æŠ›å‡ºå¼‚å¸¸ã€‚ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«å¯¹åº” get å’Œ set çš„æƒ…å†µ- (nullable id)valueForUndefinedKey:(NSString *)key;- (void)setValue:(nullable id)value forUndefinedKey:(NSString *)key;// setValueæ–¹æ³•ä¼  nil æ—¶è°ƒç”¨çš„æ–¹æ³•// æ³¨æ„æ–‡æ¡£è¯´æ˜: å½“ä¸”ä»…å½“ NSNumber å’Œ NSValue ç±»å‹æ—¶æ‰ä¼šè°ƒç”¨æ­¤æ–¹æ³• - (void)setNilValueForKey:(NSString *)key;// ä¸€ç»„ keyå¯¹åº”çš„value, å°†å…¶è½¬æˆå­—å…¸è¿”å›, å¯ç”¨äºå°† Model è½¬æˆå­—å…¸- (NSDictionary&lt;NSString *, id&gt; *)dictionaryWithValuesForKeys:(NSArray&lt;NSString *&gt; *)keys; 3.æ‹“å±•â€”â€”è‡ªåŠ¨ç”Ÿæˆçš„setterå’Œgetteræ–¹æ³•è¯•æƒ³ä¸€ä¸‹ç¼–è¯‘å™¨è¦ä¸ºæˆåƒä¸Šä¸‡ä¸ªå±æ€§åˆ†åˆ«ç”Ÿæˆsetterå’Œgetteræ–¹æ³•é‚£ä¸å¾—æ­‡èœäº†å˜› äºæ˜¯ä¹è‹¹æœå¼€å‘è€…ä»¬å°±è¿ç”¨é€šç”¨åŸåˆ™ç»™æ‰€æœ‰å±æ€§éƒ½æä¾›äº†åŒä¸€ä¸ªå…¥å£â€”â€”objc-accessors.mmä¸­setteræ–¹æ³•æ ¹æ®ä¿®é¥°ç¬¦ä¸åŒè°ƒç”¨ä¸åŒæ–¹æ³•ï¼Œæœ€åç»Ÿä¸€è°ƒç”¨reallySetPropertyæ–¹æ³• è‡³äºæ˜¯å“ªé‡Œè°ƒç”¨çš„objc_setProperty_nonatomic_copyï¼Ÿ å¹¶ä¸æ˜¯åœ¨objcæºç ä¸­ï¼Œè€Œåœ¨llvmæºç ä¸­å‘ç°äº†å®ƒï¼Œæ ¹æ®å®ƒä¸€å±‚å±‚æ‰¾ä¸Šå»å°±èƒ½æ‰¾åˆ°æºå¤´ äºŒã€KVCä½¿ç”¨12345678910111213141516typedef struct { float x, y, z;} ThreeFloats;@interface FXPerson : NSObject@property (nonatomic, copy) NSString *name;@property (nonatomic, assign) NSInteger age;@property (nonatomic, copy) NSArray *family;@property (nonatomic) ThreeFloats threeFloats;@property (nonatomic, strong) FXFriend *friend;@end@interface FXFriend : NSObject@property (nonatomic, copy) NSString *name;@property (nonatomic, assign) NSInteger age;@end 1.åŸºæœ¬ç±»å‹æ³¨æ„ä¸€ä¸‹NSIntegerè¿™ç±»çš„å±æ€§èµ‹å€¼æ—¶è¦è½¬æˆNSNumberæˆ–NSString 123456FXPerson *person = [FXPerson new];[person setValue:@&quot;imo&quot; forKey:@&quot;name&quot;];[person setValue:@(18) forKey:@&quot;age&quot;];NSLog(@&quot;åå­—%@ å¹´é¾„%@&quot;, [person valueForKey:@&quot;name&quot;], [person valueForKey:@&quot;age&quot;]); æ‰“å°ç»“æœï¼š 1åå­—imo å¹´é¾„18 2.é›†åˆç±»å‹ä¸¤ç§æ–¹æ³•å¯¹æ•°ç»„è¿›è¡Œèµ‹å€¼ï¼Œæ›´æ¨èä½¿ç”¨ç¬¬äºŒç§æ–¹æ³• 123456789101112FXPerson *person = [FXPerson new];person.family = @[@&quot;FXPerson&quot;, @&quot;FXFather&quot;];// ç›´æ¥ç”¨æ–°çš„æ•°ç»„èµ‹å€¼NSArray *temp = @[@&quot;FXPerson&quot;, @&quot;FXFather&quot;, @&quot;FXMother&quot;];[person setValue:temp forKey:@&quot;family&quot;];NSLog(@&quot;ç¬¬ä¸€æ¬¡æ”¹å˜%@&quot;, [person valueForKey:@&quot;family&quot;]);// å–å‡ºæ•°ç»„ä»¥å¯å˜æ•°ç»„å½¢å¼ä¿å­˜ï¼Œå†ä¿®æ”¹NSMutableArray *mTemp = [person mutableArrayValueForKeyPath:@&quot;family&quot;];[mTemp addObject:@&quot;FXChild&quot;];NSLog(@&quot;ç¬¬äºŒæ¬¡æ”¹å˜%@&quot;, [person valueForKey:@&quot;family&quot;]); æ‰“å°ç»“æœï¼š 123456789101112ç¬¬ä¸€æ¬¡æ”¹å˜( FXPerson, FXFather, FXMother)ç¬¬äºŒæ¬¡æ”¹å˜( FXPerson, FXFather, FXMother, FXChild) 3.è®¿é—®éå¯¹è±¡ç±»å‹â€”â€”ç»“æ„ä½“ å¯¹äºéå¯¹è±¡ç±»å‹çš„èµ‹å€¼æ€»æ˜¯æŠŠå®ƒå…ˆè½¬æˆNSValueç±»å‹å†è¿›è¡Œå­˜å‚¨ å–å€¼æ—¶è½¬æˆå¯¹åº”ç±»å‹åå†ä½¿ç”¨ 12345678910111213FXPerson *person = [FXPerson new];// èµ‹å€¼ThreeFloats floats = {180.0, 180.0, 18.0};NSValue *value = [NSValue valueWithBytes:&amp;floats objCType:@encode(ThreeFloats)];[person setValue:value forKey:@&quot;threeFloats&quot;];NSLog(@&quot;éå¯¹è±¡ç±»å‹%@&quot;, [person valueForKey:@&quot;threeFloats&quot;]);// å–å€¼ThreeFloats th;NSValue *currentValue = [person valueForKey:@&quot;threeFloats&quot;];[currentValue getValue:&amp;th];NSLog(@&quot;éå¯¹è±¡ç±»å‹çš„å€¼%f-%f-%f&quot;, th.x, th.y, th.z); 4.é›†åˆæ“ä½œç¬¦ èšåˆæ“ä½œç¬¦ @avg: è¿”å›æ“ä½œå¯¹è±¡æŒ‡å®šå±æ€§çš„å¹³å‡å€¼ @count: è¿”å›æ“ä½œå¯¹è±¡æŒ‡å®šå±æ€§çš„ä¸ªæ•° @max: è¿”å›æ“ä½œå¯¹è±¡æŒ‡å®šå±æ€§çš„æœ€å¤§å€¼ @min: è¿”å›æ“ä½œå¯¹è±¡æŒ‡å®šå±æ€§çš„æœ€å°å€¼ @sum: è¿”å›æ“ä½œå¯¹è±¡æŒ‡å®šå±æ€§å€¼ä¹‹å’Œ æ•°ç»„æ“ä½œç¬¦ @distinctUnionOfObjects: è¿”å›æ“ä½œå¯¹è±¡æŒ‡å®šå±æ€§çš„é›†åˆâ€“å»é‡ @unionOfObjects: è¿”å›æ“ä½œå¯¹è±¡æŒ‡å®šå±æ€§çš„é›†åˆ åµŒå¥—æ“ä½œç¬¦ @distinctUnionOfArrays: è¿”å›æ“ä½œå¯¹è±¡(åµŒå¥—é›†åˆ)æŒ‡å®šå±æ€§çš„é›†åˆâ€“å»é‡ï¼Œè¿”å›çš„æ˜¯ NSArray @unionOfArrays: è¿”å›æ“ä½œå¯¹è±¡(é›†åˆ)æŒ‡å®šå±æ€§çš„é›†åˆ @distinctUnionOfSets: è¿”å›æ“ä½œå¯¹è±¡(åµŒå¥—é›†åˆ)æŒ‡å®šå±æ€§çš„é›†åˆâ€“å»é‡ï¼Œè¿”å›çš„æ˜¯ NSSet é›†åˆæ“ä½œç¬¦ç”¨å¾—å°‘ä¹‹åˆå°‘ã€‚ä¸‹é¢ä¸¾ä¸ªğŸŒ° 12345678910111213141516171819202122232425262728FXPerson *person = [FXPerson new];NSMutableArray *friendArray = [NSMutableArray array];for (int i = 0; i &lt; 6; i++) { FXFriend *f = [FXFriend new]; NSDictionary *dict = @{ @&quot;name&quot;:@&quot;Felix&quot;, @&quot;age&quot;:@(18+i), }; [f setValuesForKeysWithDictionary:dict]; [friendArray addObject:f];}NSLog(@&quot;%@&quot;, [friendArray valueForKey:@&quot;age&quot;]);float avg = [[friendArray valueForKeyPath:@&quot;@avg.age&quot;] floatValue];NSLog(@&quot;å¹³å‡å¹´é¾„%f&quot;, avg);int count = [[friendArray valueForKeyPath:@&quot;@count.age&quot;] intValue];NSLog(@&quot;è°ƒæŸ¥äººå£%d&quot;, count);int sum = [[friendArray valueForKeyPath:@&quot;@sum.age&quot;] intValue];NSLog(@&quot;å¹´é¾„æ€»å’Œ%d&quot;, sum);int max = [[friendArray valueForKeyPath:@&quot;@max.age&quot;] intValue];NSLog(@&quot;æœ€å¤§å¹´é¾„%d&quot;, max);int min = [[friendArray valueForKeyPath:@&quot;@min.age&quot;] intValue];NSLog(@&quot;æœ€å°å¹´é¾„%d&quot;, min); æ‰“å°ç»“æœï¼š 123452020-03-08 14:06:20.914503+0800 FXDemo[2998:151140] å¹³å‡å¹´é¾„20.5000002020-03-08 14:06:20.914577+0800 FXDemo[2998:151140] è°ƒæŸ¥äººå£62020-03-08 14:06:20.914652+0800 FXDemo[2998:151140] å¹´é¾„æ€»å’Œ1232020-03-08 14:06:20.914739+0800 FXDemo[2998:151140] æœ€å¤§å¹´é¾„232020-03-08 14:06:20.914832+0800 FXDemo[2998:151140] æœ€å°å¹´é¾„18 5.å±‚å±‚åµŒå¥—é€šè¿‡forKeyPathå¯¹å®ä¾‹å˜é‡ï¼ˆfriendsï¼‰è¿›è¡Œå–å€¼èµ‹å€¼ 123456789FXPerson *person = [FXPerson new];FXFriend *f = [[FXFriend alloc] init];f.name = @&quot;Felixçš„æœ‹å‹&quot;;f.age = 18;person.friend = f;[person setValue:@&quot;Feng&quot; forKeyPath:@&quot;friend.name&quot;];NSLog(@&quot;%@&quot;, [person valueForKeyPath:@&quot;friend.name&quot;]); æ‰“å°ç»“æœï¼š 1Feng ä¸‰ã€KVCåº•å±‚åŸç†ç”±äºNSKeyValueCodingçš„å®ç°åœ¨Foundationæ¡†æ¶ï¼Œä½†å®ƒåˆä¸å¼€æºï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡KVOå®˜æ–¹æ–‡æ¡£æ¥äº†è§£å®ƒ 1.è®¾å€¼è¿‡ç¨‹å®˜æ–¹æ–‡æ¡£ä¸Šå¯¹Setteræ–¹æ³•çš„è¿‡ç¨‹è¿›è¡Œäº†è¿™æ ·ä¸€æ®µè®²è§£ï¼š æŒ‰set&lt;Key&gt;:ã€_set&lt;Key&gt;:é¡ºåºæŸ¥æ‰¾å¯¹è±¡ä¸­æ˜¯å¦æœ‰å¯¹åº”çš„æ–¹æ³• æ‰¾åˆ°äº†ç›´æ¥è°ƒç”¨è®¾å€¼ æ²¡æœ‰æ‰¾åˆ°è·³è½¬ç¬¬2æ­¥ åˆ¤æ–­accessInstanceVariablesDirectlyç»“æœ ä¸ºYESæ—¶æŒ‰ç…§_&lt;key&gt;ã€_is&lt;Key&gt;ã€&lt;key&gt;ã€is&lt;Key&gt;çš„é¡ºåºæŸ¥æ‰¾æˆå‘˜å˜é‡ï¼Œæ‰¾åˆ°äº†å°±èµ‹å€¼ï¼›æ‰¾ä¸åˆ°å°±è·³è½¬ç¬¬3æ­¥ ä¸ºNOæ—¶è·³è½¬ç¬¬3æ­¥ è°ƒç”¨setValueï¼šforUndefinedKey:ã€‚é»˜è®¤æƒ…å†µä¸‹ä¼šå¼•å‘ä¸€ä¸ªå¼‚å¸¸ï¼Œä½†æ˜¯ç»§æ‰¿äºNSObjectçš„å­ç±»å¯ä»¥é‡å†™è¯¥æ–¹æ³•å°±å¯ä»¥é¿å…å´©æºƒå¹¶åšå‡ºç›¸åº”æªæ–½ 2.å–å€¼è¿‡ç¨‹åŒæ ·çš„å®˜æ–¹æ–‡æ¡£ä¸Šä¹Ÿç»™å‡ºäº†Getteræ–¹æ³•çš„è¿‡ç¨‹ï¼š æŒ‰ç…§get&lt;Key&gt;ã€&lt;key&gt;ã€is&lt;Key&gt;ã€_&lt;key&gt;é¡ºåºæŸ¥æ‰¾å¯¹è±¡ä¸­æ˜¯å¦æœ‰å¯¹åº”çš„æ–¹æ³• å¦‚æœæœ‰åˆ™è°ƒç”¨getterï¼Œæ‰§è¡Œç¬¬5æ­¥ å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œè·³è½¬åˆ°ç¬¬2æ­¥ æŸ¥æ‰¾æ˜¯å¦æœ‰countOf&lt;Key&gt;å’ŒobjectIn&lt;Key&gt;AtIndex: æ–¹æ³•(å¯¹åº”äºNSArrayç±»å®šä¹‰çš„åŸå§‹æ–¹æ³•)ï¼Œ ä»¥åŠ&lt;key&gt;AtIndexes: æ–¹æ³•(å¯¹åº”äºNSArrayæ–¹æ³•objectsAtIndexes:)ã€‚ å¦‚æœæ‰¾åˆ°å…¶ä¸­çš„ç¬¬ä¸€ä¸ª(countOf&lt;Key&gt;)ï¼Œå†æ‰¾åˆ°å…¶ä»–ä¸¤ä¸ªä¸­çš„è‡³å°‘ä¸€ä¸ªï¼Œåˆ™åˆ›å»ºä¸€ä¸ªå“åº”æ‰€æœ‰ NSArrayæ–¹æ³•çš„ä»£ç†é›†åˆå¯¹è±¡ï¼Œå¹¶è¿”å›è¯¥å¯¹è±¡(å³è¦ä¹ˆæ˜¯countOf&lt;Key&gt; + objectIn&lt;Key&gt;AtIndex:ï¼Œè¦ä¹ˆæ˜¯countOf&lt;Key&gt; + &lt;key&gt;AtIndexes:ï¼Œè¦ä¹ˆæ˜¯countOf&lt;Key&gt; + objectIn&lt;Key&gt;AtIndex: + &lt;key&gt;AtIndexes:) å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œè·³è½¬åˆ°ç¬¬3æ­¥ æŸ¥æ‰¾åä¸ºcountOf&lt;Key&gt;ã€enumeratorOf&lt;Key&gt;å’Œ memberOf&lt;Key&gt;è¿™ä¸‰ä¸ªæ–¹æ³•(å¯¹åº”äºNSSetç±»å®šä¹‰çš„åŸå§‹æ–¹æ³•ï¼‰ å¦‚æœæ‰¾åˆ°è¿™ä¸‰ä¸ªæ–¹æ³•ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªå“åº”æ‰€æœ‰NSSetæ–¹æ³•çš„ä»£ç†é›†åˆå¯¹è±¡ï¼Œå¹¶è¿”å›è¯¥å¯¹è±¡ å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œè·³è½¬åˆ°ç¬¬4æ­¥ åˆ¤æ–­accessInstanceVariablesDirectly ä¸ºYESæ—¶æŒ‰ç…§_&lt;key&gt;ã€_is&lt;Key&gt;ã€&lt;key&gt;ã€is&lt;Key&gt;çš„é¡ºåºæŸ¥æ‰¾æˆå‘˜å˜é‡ï¼Œæ‰¾åˆ°äº†å°±å–å€¼ï¼Œè·³è½¬ç¬¬5æ­¥ ä¸ºNOæ—¶è·³è½¬ç¬¬6æ­¥ åˆ¤æ–­å–å‡ºçš„å±æ€§å€¼ å±æ€§å€¼æ˜¯å¯¹è±¡ï¼Œç›´æ¥è¿”å› å±æ€§å€¼ä¸æ˜¯å¯¹è±¡ï¼Œä½†æ˜¯å¯ä»¥è½¬åŒ–ä¸ºNSNumberç±»å‹ï¼Œåˆ™å°†å±æ€§å€¼è½¬åŒ–ä¸ºNSNumber ç±»å‹è¿”å› å±æ€§å€¼ä¸æ˜¯å¯¹è±¡ï¼Œä¹Ÿä¸èƒ½è½¬åŒ–ä¸ºNSNumberç±»å‹ï¼Œåˆ™å°†å±æ€§å€¼è½¬åŒ–ä¸ºNSValueç±»å‹è¿”å› è°ƒç”¨valueForUndefinedKey:ã€‚é»˜è®¤æƒ…å†µä¸‹ä¼šå¼•å‘ä¸€ä¸ªå¼‚å¸¸ï¼Œä½†æ˜¯ç»§æ‰¿äºNSObjectçš„å­ç±»å¯ä»¥é‡å†™è¯¥æ–¹æ³•å°±å¯ä»¥é¿å…å´©æºƒå¹¶åšå‡ºç›¸åº”æªæ–½ å››ã€è‡ªå®šä¹‰KVCæ–°å»ºä¸€ä¸ªNSObject+FXKVCçš„åˆ†ç±»ï¼Œ.hå¼€æ”¾ä¸¤ä¸ªæ–¹æ³•ï¼Œ.må¼•å…¥&lt;objc/runtime.h&gt; - (void)fx_setValue:(nullable id)value forKey:(NSString *)key; - (nullable id)fx_valueForKey:(NSString *)key; 1.è‡ªå®šä¹‰setteræ–¹æ³•1.éç©ºåˆ¤æ–­ 1if (key == nil || key.length == 0) return; 2.æ‰¾åˆ°ç›¸å…³æ–¹æ³•set&lt;Key&gt;ã€_set&lt;Key&gt;ã€setIs&lt;Key&gt;ï¼Œè‹¥å­˜åœ¨å°±ç›´æ¥è°ƒç”¨ 123456789101112131415NSString *Key = key.capitalizedString;NSString *setKey = [NSString stringWithFormat:@&quot;set%@:&quot;,Key];NSString *_setKey = [NSString stringWithFormat:@&quot;_set%@:&quot;,Key];NSString *setIsKey = [NSString stringWithFormat:@&quot;setIs%@:&quot;,Key];if ([self fx_performSelectorWithMethodName:setKey value:value]) { NSLog(@&quot;*********%@**********&quot;,setKey); return;} else if ([self fx_performSelectorWithMethodName:_setKey value:value]) { NSLog(@&quot;*********%@**********&quot;,_setKey); return;} else if ([self fx_performSelectorWithMethodName:setIsKey value:value]) { NSLog(@&quot;*********%@**********&quot;,setIsKey); return;} 3.åˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿç›´æ¥èµ‹å€¼å®ä¾‹å˜é‡ï¼Œä¸èƒ½çš„æƒ…å†µä¸‹å°±è°ƒç”¨setValue:forUndefinedKey:æˆ–æŠ›å‡ºå¼‚å¸¸ 1234567891011NSString *undefinedMethodName = @&quot;setValue:forUndefinedKey:&quot;;IMP undefinedIMP = class_getMethodImplementation([self class], NSSelectorFromString(undefinedMethodName));if (![self.class accessInstanceVariablesDirectly]) { if (undefinedIMP) { [self fx_performSelectorWithMethodName:undefinedMethodName value:value key:key]; } else { @throw [NSException exceptionWithName:@&quot;FXUnknownKeyException&quot; reason:[NSString stringWithFormat:@&quot;****[%@ %@]: this class is not key value coding-compliant for the key %@.&quot;, self, NSStringFromSelector(_cmd), key] userInfo:nil]; } return;} 4.æ‰¾ç›¸å…³å®ä¾‹å˜é‡è¿›è¡Œèµ‹å€¼ 123456789101112131415161718192021NSMutableArray *mArray = [self getIvarListName];NSString *_key = [NSString stringWithFormat:@&quot;_%@&quot;,key];NSString *_isKey = [NSString stringWithFormat:@&quot;_is%@&quot;,Key];NSString *isKey = [NSString stringWithFormat:@&quot;is%@&quot;,Key];if ([mArray containsObject:_key]) { Ivar ivar = class_getInstanceVariable([self class], _key.UTF8String); object_setIvar(self , ivar, value); return;} else if ([mArray containsObject:_isKey]) { Ivar ivar = class_getInstanceVariable([self class], _isKey.UTF8String); object_setIvar(self , ivar, value); return;} else if ([mArray containsObject:key]) { Ivar ivar = class_getInstanceVariable([self class], key.UTF8String); object_setIvar(self , ivar, value); return;} else if ([mArray containsObject:isKey]) { Ivar ivar = class_getInstanceVariable([self class], isKey.UTF8String); object_setIvar(self , ivar, value); return;} 5.è°ƒç”¨setValue:forUndefinedKey:æˆ–æŠ›å‡ºå¼‚å¸¸ 12345if (undefinedIMP) { [self fx_performSelectorWithMethodName:undefinedMethodName value:value key:key];} else { @throw [NSException exceptionWithName:@&quot;FXUnknownKeyException&quot; reason:[NSString stringWithFormat:@&quot;****[%@ %@]: this class is not key value coding-compliant for the key %@.&quot;, self, NSStringFromSelector(_cmd), key] userInfo:nil];} 2.è‡ªå®šä¹‰getteræ–¹æ³•1.éç©ºåˆ¤æ–­ 1if (key == nil || key.length == 0) return nil; 2.æ‰¾ç›¸å…³æ–¹æ³•get&lt;Key&gt;ã€&lt;key&gt;ï¼Œæ‰¾åˆ°å°±è¿”å›ï¼ˆè¿™é‡Œä½¿ç”¨-Warc-performSelector-leaksæ¶ˆé™¤è­¦å‘Šï¼‰ 1234567891011NSString *Key = key.capitalizedString;NSString *getKey = [NSString stringWithFormat:@&quot;get%@&quot;,Key]; #pragma clang diagnostic push#pragma clang diagnostic ignored &quot;-Warc-performSelector-leaks&quot;if ([self respondsToSelector:NSSelectorFromString(getKey)]) { return [self performSelector:NSSelectorFromString(getKey)];} else if ([self respondsToSelector:NSSelectorFromString(key)]) { return [self performSelector:NSSelectorFromString(key)];}#pragma clang diagnostic pop 3.å¯¹NSArrayè¿›è¡Œæ“ä½œï¼šæŸ¥æ‰¾countOf&lt;Key&gt;ã€objectIn&lt;Key&gt;AtIndexæ–¹æ³• 1234567891011121314151617181920NSString *countOfKey = [NSString stringWithFormat:@&quot;countOf%@&quot;,Key];NSString *objectInKeyAtIndex = [NSString stringWithFormat:@&quot;objectIn%@AtIndex:&quot;,Key];#pragma clang diagnostic push#pragma clang diagnostic ignored &quot;-Warc-performSelector-leaks&quot;if ([self respondsToSelector:NSSelectorFromString(countOfKey)]) { if ([self respondsToSelector:NSSelectorFromString(objectInKeyAtIndex)]) { int num = (int)[self performSelector:NSSelectorFromString(countOfKey)]; NSMutableArray *mArray = [NSMutableArray arrayWithCapacity:1]; for (int i = 0; i&lt;num-1; i++) { num = (int)[self performSelector:NSSelectorFromString(countOfKey)]; } for (int j = 0; j&lt;num; j++) { id objc = [self performSelector:NSSelectorFromString(objectInKeyAtIndex) withObject:@(num)]; [mArray addObject:objc]; } return mArray; }}#pragma clang diagnostic pop 4.åˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿç›´æ¥èµ‹å€¼å®ä¾‹å˜é‡ï¼Œä¸èƒ½çš„æƒ…å†µä¸‹å°±è°ƒç”¨valueForUndefinedKey:æˆ–æŠ›å‡ºå¼‚å¸¸ 123456789101112131415NSString *undefinedMethodName = @&quot;valueForUndefinedKey:&quot;;IMP undefinedIMP = class_getMethodImplementation([self class], NSSelectorFromString(undefinedMethodName));if (![self.class accessInstanceVariablesDirectly]) { if (undefinedIMP) { #pragma clang diagnostic push#pragma clang diagnostic ignored &quot;-Warc-performSelector-leaks&quot; return [self performSelector:NSSelectorFromString(undefinedMethodName) withObject:key];#pragma clang diagnostic pop } else { @throw [NSException exceptionWithName:@&quot;FXUnknownKeyException&quot; reason:[NSString stringWithFormat:@&quot;****[%@ %@]: this class is not key value coding-compliant for the key %@.&quot;, self, NSStringFromSelector(_cmd), key] userInfo:nil]; }} 5.æ‰¾ç›¸å…³å®ä¾‹å˜é‡ï¼Œæ‰¾åˆ°äº†å°±è¿”å› 1234567891011121314151617NSMutableArray *mArray = [self getIvarListName];NSString *_key = [NSString stringWithFormat:@&quot;_%@&quot;,key];NSString *_isKey = [NSString stringWithFormat:@&quot;_is%@&quot;,Key];NSString *isKey = [NSString stringWithFormat:@&quot;is%@&quot;,Key];if ([mArray containsObject:_key]) { Ivar ivar = class_getInstanceVariable([self class], _key.UTF8String); return object_getIvar(self, ivar);;} else if ([mArray containsObject:_isKey]) { Ivar ivar = class_getInstanceVariable([self class], _isKey.UTF8String); return object_getIvar(self, ivar);;} else if ([mArray containsObject:key]) { Ivar ivar = class_getInstanceVariable([self class], key.UTF8String); return object_getIvar(self, ivar);;} else if ([mArray containsObject:isKey]) { Ivar ivar = class_getInstanceVariable([self class], isKey.UTF8String); return object_getIvar(self, ivar);;} 6.è°ƒç”¨valueForUndefinedKey:æˆ–æŠ›å‡ºå¼‚å¸¸ 123456789if (undefinedIMP) { #pragma clang diagnostic push#pragma clang diagnostic ignored &quot;-Warc-performSelector-leaks&quot; return [self performSelector:NSSelectorFromString(undefinedMethodName) withObject:key];#pragma clang diagnostic pop} else { @throw [NSException exceptionWithName:@&quot;FXUnknownKeyException&quot; reason:[NSString stringWithFormat:@&quot;****[%@ %@]: this class is not key value coding-compliant for the key %@.&quot;, self, NSStringFromSelector(_cmd), key] userInfo:nil];} 3.å°è£…çš„æ–¹æ³•è¿™é‡Œç®€å•å°è£…äº†å‡ ä¸ªç”¨åˆ°çš„æ–¹æ³• fx_performSelectorWithMethodName:value:key:å®‰å…¨è°ƒç”¨æ–¹æ³•åŠä¼ ä¸¤ä¸ªå‚æ•° 123456789101112- (BOOL)fx_performSelectorWithMethodName:(NSString *)methodName value:(id)value key:(id)key { if ([self respondsToSelector:NSSelectorFromString(methodName)]) { #pragma clang diagnostic push#pragma clang diagnostic ignored &quot;-Warc-performSelector-leaks&quot; [self performSelector:NSSelectorFromString(methodName) withObject:value withObject:key];#pragma clang diagnostic pop return YES; } return NO;} fx_performSelectorWithMethodName:key:å®‰å…¨è°ƒç”¨æ–¹æ³•åŠä¼ å‚ 123456789101112- (BOOL)fx_performSelectorWithMethodName:(NSString *)methodName key:(id)key { if ([self respondsToSelector:NSSelectorFromString(methodName)]) { #pragma clang diagnostic push#pragma clang diagnostic ignored &quot;-Warc-performSelector-leaks&quot; [self performSelector:NSSelectorFromString(methodName) withObject:key];#pragma clang diagnostic pop return YES; } return NO;} getIvarListNameå–æˆå‘˜å˜é‡ 123456789101112131415- (NSMutableArray *)getIvarListName { NSMutableArray *mArray = [NSMutableArray arrayWithCapacity:1]; unsigned int count = 0; Ivar *ivars = class_copyIvarList([self class], &amp;count); for (int i = 0; i&lt;count; i++) { Ivar ivar = ivars[i]; const char *ivarNameChar = ivar_getName(ivar); NSString *ivarName = [NSString stringWithUTF8String:ivarNameChar]; NSLog(@&quot;ivarName == %@&quot;,ivarName); [mArray addObject:ivarName]; } free(ivars); return mArray;} äº”ã€KVCå¼‚å¸¸å°æŠ€å·§1.æŠ€å·§ä¸€ï¼šè‡ªåŠ¨è½¬æ¢ç±»å‹ ç”¨intç±»å‹èµ‹å€¼ä¼šè‡ªåŠ¨è½¬æˆ__NSCFNumber 1234[person setValue:@18 forKey:@&quot;age&quot;];[person setValue:@&quot;20&quot; forKey:@&quot;age&quot;];NSLog(@&quot;%@-%@&quot;, [person valueForKey:@&quot;age&quot;], [[person valueForKey:@&quot;age&quot;] class]); ç”¨ç»“æ„ä½“ç±»å‹ç±»å‹èµ‹å€¼ä¼šè‡ªåŠ¨è½¬æˆNSConcreteValue 12345ThreeFloats floats = {1.0, 2.0, 3.0};NSValue *value = [NSValue valueWithBytes:&amp;floats objCType:@encode(ThreeFloats)];[person setValue:value forKey:@&quot;threeFloats&quot;];NSLog(@&quot;%@-%@&quot;, [person valueForKey:@&quot;threeFloats&quot;], [[person valueForKey:@&quot;threeFloats&quot;] class]); 2.æŠ€å·§äºŒï¼šè®¾ç½®ç©ºå€¼æœ‰æ—¶å€™åœ¨è®¾å€¼æ—¶è®¾ç½®ç©ºå€¼ï¼Œå¯ä»¥é€šè¿‡é‡å†™setNilValueForKeyæ¥ç›‘å¬ï¼Œä½†åªå¯¹NSNumberç±»å‹æœ‰æ•ˆã€‚ 3.æŠ€å·§ä¸‰ï¼šæœªå®šä¹‰çš„keyå¯¹äºæœªå®šä¹‰çš„keyæˆ‘ä»¬å¯ä»¥é€šè¿‡é‡å†™setValue:forUndefinedKey:ã€valueForUndefinedKey:æ¥ç›‘å¬ 123456789101112@implementation FXPerson- (void)setValue:(id)value forUndefinedKey:(NSString *)key { NSLog(@&quot;æœªå®šä¹‰çš„keyâ€”â€”%@&quot;,key);}- (id)valueForUndefinedKey:(NSString *)key { NSLog(@&quot;æœªå®šä¹‰çš„keyâ€”â€”%@&quot;,key); return @&quot;æœªå®šä¹‰çš„key&quot;;}@end","link":"/2021/03/23/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/13-KVC%E5%8E%9F%E7%90%86/"},{"title":"14-KVOåŸç†","text":"ä¸€ã€KVOç®€è¿°KVOï¼ˆKey-Value Observingï¼‰æ˜¯ä¸€å¥—äº‹ä»¶è§‚å¯Ÿ &amp; é€šçŸ¥æœºåˆ¶ï¼Œå¼€å‘è€…å¯ä»¥ä½¿ç”¨å®ƒæ¥ç›‘æµ‹å¯¹è±¡å±æ€§çš„å˜åŒ–å¹¶åšå‡ºå“åº”ã€‚ åœ¨Documentation Archieveä¸­æåˆ°ä¸€å¥æƒ³è¦ç†è§£KVOï¼Œå¿…é¡»å…ˆç†è§£KVCï¼Œå› ä¸ºé”®å€¼è§‚å¯Ÿæ˜¯å»ºç«‹åœ¨é”®å€¼ç¼–ç çš„åŸºç¡€ä¸Šã€‚ è€ŒKVOå’ŒNSNotificatioCenteréƒ½æ˜¯ iOS è§‚å¯Ÿè€…æ¨¡å¼çš„ä¸€ç§å®ç°ï¼Œä¸¤è€…çš„åŒºåˆ«åœ¨äºï¼š ç›¸å¯¹äºè¢«è§‚å¯Ÿè€…å’Œè§‚å¯Ÿè€…ä¹‹é—´çš„å…³ç³»ï¼ŒKVOæ˜¯ä¸€å¯¹ä¸€çš„ï¼ŒNSNotificatioCenteræ˜¯ä¸€å¯¹å¤šçš„ KVOå¯¹è¢«ç›‘å¬å¯¹è±¡æ— ä¾µå…¥æ€§ï¼Œä¸éœ€è¦ä¿®æ”¹å…¶å†…éƒ¨ä»£ç å³å¯å®ç°ç›‘å¬ äºŒã€KVOä½¿ç”¨åŠæ³¨æ„ç‚¹2.1 åŸºæœ¬ä½¿ç”¨KVOä½¿ç”¨ä¸‰éƒ¨æ›²ï¼š æ³¨å†Œè§‚å¯Ÿè€… 1[self.person addObserver:self forKeyPath:@&quot;name&quot; options:(NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld) context:NULL]; å®ç°å›è°ƒ 123- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change context:(void *)context { if ([keyPath isEqualToString:@&quot;name&quot;]) NSLog(@&quot;%@&quot;, change);} ç§»é™¤è§‚å¯Ÿè€… 123- (void)dealloc { [self.person removeObserver:self forKeyPath:@&quot;name&quot;];} 2.2 context è¯´æ˜å¦‚æœçˆ¶ç±»ä¸­æœ‰ä¸ªnameå±æ€§ï¼Œå­ç±»ä¸­ä¹Ÿæœ‰ä¸ªnameå±æ€§ï¼Œä¸¤è€…éƒ½æ³¨å†Œå¯¹nameçš„è§‚å¯Ÿï¼Œé‚£ä¹ˆä»…é€šè¿‡keyPathå·²ç»åŒºåˆ†ä¸äº†æ˜¯å“ªä¸ªnameå‘ç”Ÿå˜åŒ–äº†ï¼Œç°æœ‰ä¸¤ä¸ªè§£å†³åŠæ³•ï¼š å¤šåŠ ä¸€å±‚åˆ¤æ–­ï¼šåˆ¤æ–­objectï¼Œä½†æ˜¯ä¼šå‡ºç°å¾ˆå¤š ifâ€¦elseâ€¦ ä½¿ç”¨contextä¼ é€’ä¿¡æ¯ï¼Œæ›´å®‰å…¨ã€æ›´å¯æ‰©å±• contextä½¿ç”¨æ€»ç»“: ä¸ä½¿ç”¨contextä½œä¸ºè§‚å¯Ÿå€¼ 12// contextæ˜¯ void * ç±»å‹ï¼Œåº”è¯¥å¡« NULL è€Œä¸æ˜¯ nil[self.person addObserver:self forKeyPath:@&quot;name&quot; options:(NSKeyValueObservingOptionNew) context:NULL]; ä½¿ç”¨contextä¼ é€’ä¿¡æ¯ 12345678910111213static void *PersonNameContext = &amp;PersonNameContext;static void *ChildNameContext = &amp;ChildNameContext;[self.person addObserver:self forKeyPath:@&quot;name&quot; options:(NSKeyValueObservingOptionNew) context:PersonNameContext];[self.child addObserver:self forKeyPath:@&quot;name&quot; options:(NSKeyValueObservingOptionNew) context:ChildNameContext];- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change context:(void *)context { if (context == PersonNameContext) { NSLog(@&quot;%@&quot;, change); } else if (context == ChildNameContext) { NSLog(@&quot;%@&quot;, change); }} 2.3 ç§»é™¤è§‚å¯Ÿçš„å¿…è¦æ€§ä¸ç§»é™¤ä¼šå¸¦æ¥æ½œåœ¨çš„éšæ‚£ï¼š å¦‚æœè§‚å¯Ÿè€…å¯¹è±¡ dealloc çš„æ—¶å€™æ²¡æœ‰ç§»é™¤å¯¹ç›®æ ‡å±æ€§çš„è§‚å¯Ÿï¼Œå½“ç›®æ ‡å±æ€§æ”¹å˜çš„æ—¶å€™ï¼Œè¿˜æ˜¯ä¼šé€šçŸ¥è¯¥è§‚å¯Ÿè€…ï¼Œä½†æ˜¯è¯¥è§‚å¯Ÿè€…æ­¤æ—¶å·²ç»é‡Šæ”¾äº†ï¼Œå°±ä¼šå‡ºç°é‡æŒ‡é’ˆçš„æƒ…å†µã€‚ ä¾‹å¦‚ï¼šLGPersonæ˜¯ä¸€ä¸ªå•ä¾‹å¯¹è±¡ï¼Œå®ƒæœ‰ä¸ªå±æ€§nameã€‚ç„¶ååœ¨FirstViewControllerå’ŒSecondViewControllerä¸­éƒ½å¯¹LGPersonå¯¹è±¡çš„nameå±æ€§è¿›è¡Œäº†KVOè§‚å¯Ÿã€‚ æ“ä½œé¡ºåºæ˜¯ä»FirstViewControllerpushåˆ°SecondViewControllerï¼Œç„¶åä»SecondViewControllerpop åˆ°FirstViewControllerã€‚ å‡å¦‚SecondViewControlleråœ¨ dealloc çš„æ—¶å€™æ²¡æœ‰ç§»é™¤è§‚å¯Ÿè€…ï¼Œä½†æ˜¯è¿™ä¸ªLGPersonå¯¹è±¡ç”±äºæ˜¯å•ä¾‹æ‰€ä»¥æ²¡æœ‰é”€æ¯ã€‚ç„¶ååœ¨FirstViewControllerä¸­nameå±æ€§è¢«æ”¹å˜äº†ã€‚æ­¤æ—¶å°±ä¼šé€šçŸ¥å®ƒçš„è§‚å¯Ÿè€…å³SecondViewControllerï¼Œä½†æ˜¯SecondViewControllerè¿™ä¸ªè§‚å¯Ÿè€…å·²ç»é‡Šæ”¾äº†ï¼Œå†æ¬¡è®¿é—®å®ƒå°±ä¼šé€ æˆè®¿é—®é‡æŒ‡é’ˆçš„æƒ…å†µã€‚ æ‰€ä»¥è¯´ï¼Œè¯¥ç§»é™¤è§‚å¯Ÿçš„æ—¶å€™å°±è¦ç§»é™¤ã€‚ è‹¹æœå®˜æ–¹æ¨èçš„æ–¹å¼æ˜¯â€”â€”åœ¨initçš„æ—¶å€™è¿›è¡ŒaddObserverï¼Œåœ¨deallocæ—¶removeObserverï¼Œè¿™æ ·å¯ä»¥ä¿è¯addå’Œremoveæ˜¯æˆå¯¹å‡ºç°çš„ï¼Œè¿™æ˜¯ä¸€ç§æ¯”è¾ƒç†æƒ³çš„ä½¿ç”¨æ–¹å¼ 2.4 æ‰‹åŠ¨è§¦å‘é”®å€¼è§‚å¯Ÿæœ‰æ—¶å€™ä¸šåŠ¡éœ€æ±‚éœ€è¦è§‚å¯ŸæŸä¸ªå±æ€§å€¼ï¼Œä¸€ä¼šå„¿è¦è§‚å¯Ÿäº†ï¼Œä¸€ä¼šåˆä¸è¦è§‚å¯Ÿäº†â€¦å¦‚æœæŠŠKVOä¸‰éƒ¨æ›²æ•´ä½“å»æ‰ã€å†æ•´ä½“æ·»ä¸Šï¼Œå¿…ç„¶åˆæ˜¯ä¸€é¡¿ç¹çè€Œåˆä¸å¿…è¦çš„å·¥ä½œï¼Œå¥½åœ¨KVOä¸­æœ‰ä¸¤ç§åŠæ³•å¯ä»¥æ‰‹åŠ¨è§¦å‘é”®å€¼è§‚å¯Ÿï¼š å°†è¢«è§‚å¯Ÿè€…çš„automaticallyNotifiesObserversForKeyè¿”å›NOï¼ˆå¯ä»¥åªå¯¹æŸä¸ªå±æ€§è®¾ç½®ï¼‰ï¼Œè¿™æ ·å°±ä¸ä¼šè‡ªåŠ¨è§‚å¯Ÿå±æ€§çš„å˜åŒ–äº†ï¼Œè€Œæ˜¯é€šè¿‡æ‰‹åŠ¨é€šçŸ¥çš„æ–¹å¼å»è§‚å¯Ÿã€‚ 123456+ (BOOL)automaticallyNotifiesObserversForKey:(NSString *)key { if ([key isEqualToString:@&quot;name&quot;]) { return NO; } return [super automaticallyNotifiesObserversForKey:key];} ä½¿ç”¨willChangeValueForKeyã€didChangeValueForKeyé‡å†™è¢«è§‚å¯Ÿè€…çš„å±æ€§çš„setteræ–¹æ³• è¿™ä¸¤ä¸ªæ–¹æ³•ç”¨äºé€šçŸ¥ç³»ç»Ÿè¯¥ key çš„å±æ€§å€¼å³å°†å’Œå·²ç»å˜æ›´äº† 12345- (void)setName:(NSString *)name { [self willChangeValueForKey:@&quot;name&quot;]; _name = name; [self didChangeValueForKey:@&quot;name&quot;];} ä¸¤ç§æ–¹å¼ä½¿ç”¨çš„æ’åˆ—ç»„åˆå¦‚ä¸‹ï¼Œå¯ä»¥è‡ªç”±ç»„åˆå¦‚ä½•ä½¿ç”¨ æƒ…å†µ å›è°ƒæ¬¡æ•° æ­£å¸¸æƒ…å†µ 1 automaticallyNotifiesObserversForKeyä¸ºNO 0 automaticallyNotifiesObserversForKeyä¸ºNOä¸”æ·»åŠ willChangeValueForKeyã€didChangeValueForKey 1 automaticallyNotifiesObserversForKeyä¸ºYESä¸”æ·»åŠ willChangeValueForKeyã€didChangeValueForKey 2 æœ€è¿‘å‘ç°[self willChangeValueForKey:name]å’Œ[self willChangeValueForKey:â€nameâ€]ä¸¤ç§å†™æ³•æ˜¯ä¸åŒçš„ç»“æœï¼šé‡å†™setteræ–¹æ³•å–å±æ€§å€¼æ“ä½œä¸ä¼šé¢å¤–å‘é€é€šçŸ¥ï¼›è€Œä½¿ç”¨â€œnameâ€ä¼šé¢å¤–å‘é€ä¸€æ¬¡é€šçŸ¥ 2.5 Key ä¾èµ–æƒ…å†µæ¯”å¦‚æœ‰ä¸€ä¸ªä¸‹è½½ä»»åŠ¡çš„éœ€æ±‚ï¼Œæ ¹æ®æ€»ä¸‹è½½é‡Totalå’Œå½“å‰å·²ä¸‹è½½é‡Currentæ¥å¾—åˆ°å½“å‰ä¸‹è½½è¿›åº¦progressï¼Œè¿™ä¸ªéœ€æ±‚å°±æœ‰ä¸¤ç§å®ç°ï¼š åˆ†åˆ«è§‚å¯Ÿæ€»ä¸‹è½½é‡Totalå’Œå½“å‰å·²ä¸‹è½½é‡Currentä¸¤ä¸ªå±æ€§ï¼Œå…¶ä¸­ä¸€ä¸ªå±æ€§å‘ç”Ÿå˜åŒ–æ—¶è®¡ç®—æ±‚å€¼å½“å‰ä¸‹è½½è¿›åº¦Processã€å¤ªéº»çƒ¦äº†ã€‘ å®ç°keyPathsForValuesAffectingValueForKeyæ–¹æ³•ï¼Œå¹¶è§‚å¯Ÿprogresså±æ€§ã€é‡‡ç”¨ã€‘ progresså±æ€§å—åˆ°currentå’Œtotalå±æ€§å˜åŒ–çš„å½±å“ï¼Œå¦‚æœæˆ‘ä»¬æƒ³åªç›‘å¬progressï¼Œåˆä¿è¯currentå’Œtotalå˜åŒ–æ—¶èƒ½æ”¶åˆ°KVOä¸­çš„å›è°ƒå‘Šè¯‰æˆ‘ä»¬progresså˜åŒ–äº†ï¼Œæˆ‘ä»¬éœ€è¦å®ç°+keyPathsForValuesAffectingValueForKey:æ–¹æ³•æ¥å…³è”ä¸¤ä¸ªå±æ€§åˆ°progressä¸Šï¼š 12345678+ (NSSet&lt;NSString *&gt; *)keyPathsForValuesAffectingValueForKey:(NSString *)key { NSSet *keyPaths = [super keyPathsForValuesAffectingValueForKey:key]; if ([key isEqualToString:@&quot;progress&quot;]) { NSArray *affectingKeys = @[@&quot;current&quot;, @&quot;total&quot;]; keyPaths = [keyPaths setByAddingObjectsFromArray:affectingKeys]; } return keyPaths;} Person ç±»ä¸­progesså—åˆ°ä¸¤ä¸ªå±æ€§å˜åŒ–çš„å½±å“ 123- (CGFloat)progress { return self.current / self.total;} æ·»åŠ ç›‘å¬ï¼š 123456Person *p = [Person new];self.person = p;p.current = 0;p.total = 100;[self.person addObserver:self forKeyPath:@&quot;progress&quot; options:(NSKeyValueObservingOptionNew) context:NULL]; ç›‘å¬å›è°ƒï¼š 123- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change context:(void *)context { NSLog(@&quot;%@&quot;, change);} è¿™æ ·ï¼Œcurrentå’Œtotalå˜åŒ–æ—¶ï¼Œå°±èƒ½ç›‘å¬åˆ°progressçš„å˜åŒ–äº†ï¼š 1234- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event { self.person.current += 10; self.person.total += 1;} 2.6 å¯å˜æ•°ç»„é¦–å…ˆæ·»åŠ å¯¹dataArrayè¿™ä¸ªå¯å˜æ•°ç»„çš„è§‚å¯Ÿï¼š 1[self.person addObserver:self forKeyPath:@&quot;dateArray&quot; options:(NSKeyValueObservingOptionNew) context:NULL]; ç„¶åè°ƒç”¨ä¸‹é¢ä»£ç ï¼Œå¯¹dateArrayæ•°ç»„æ·»åŠ å…ƒç´  1[self.person.dateArray addObject:@&quot;hello&quot;]; è¿™æ ·ä¼šä¸ä¼šè§¦å‘KVOé€šçŸ¥å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¸ä¼šçš„ï¼Œå› ä¸ºKVOæ˜¯ç»™äºˆsetæ–¹æ³•çš„ï¼Œè¿™æ ·ä¸ä¼šè§¦å‘setæ–¹æ³•ï¼Œæ‰€ä»¥å°±ä¸ä¼šè§¦å‘KVOé€šçŸ¥ã€‚æ­£ç¡®çš„åšæ³•åº”è¯¥æ˜¯ä¸‹é¢è¿™æ · 1[[self.person mutableArrayValueForKey:@&quot;dateArray&quot;] addObject:@&quot;hello&quot;]; ä¸‰ã€KVO åº•å±‚åŸç†â€”isa-swizzling3.1 å®˜æ–¹è§£é‡Š Key-Value Observing Programming Guideä¸­æœ‰ä¸€æ®µåº•å±‚å®ç°åŸç†çš„å™è¿° KVOæ˜¯ä½¿ç”¨isa-swizzlingæŠ€æœ¯å®ç°çš„ isaæŒ‡é’ˆæŒ‡å‘å¯¹è±¡çš„ç±» åœ¨ä¸ºå¯¹è±¡çš„å±æ€§æ³¨å†Œè§‚å¯Ÿè€…æ—¶ï¼Œå°†ä¿®æ”¹è§‚å¯Ÿå¯¹è±¡çš„isaæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸­é—´ç±»è€Œä¸æ˜¯çœŸå®ç±»ã€‚æ‰€ä»¥isaæŒ‡é’ˆçš„å€¼ä¸ä¸€å®šåæ˜ å¯¹è±¡çš„å®é™…ç±»ã€‚ æ‚¨æ°¸è¿œä¸åº”ä¾é isaæŒ‡é’ˆæ¥ç¡®å®šç±»æˆå‘˜èº«ä»½ã€‚ç›¸åï¼Œæ‚¨åº”è¯¥ä½¿ç”¨classæ–¹æ³•æ¥ç¡®å®šå¯¹è±¡å®ä¾‹çš„ç±» 3.2 ä»£ç æ¢ç´¢ æ³¨å†Œè§‚å¯Ÿè€…ä¹‹å‰ï¼šç±»å¯¹è±¡ä¸º FXPersonï¼Œå®ä¾‹å¯¹è±¡isaæŒ‡å‘FXPerson æ³¨å†Œè§‚å¯Ÿè€…ä¹‹åï¼šç±»å¯¹è±¡ä¸º FXPersonï¼Œå®ä¾‹å¯¹è±¡isaæŒ‡å‘NSKVONotifying_FXPerson ä»è¿™ä¸¤å›¾ä¸­å¯ä»¥å¾—å‡ºä¸€ä¸ªç»“è®ºï¼šè§‚å¯Ÿè€…æ³¨å†Œå‰åFXPersonç±»æ²¡å‘ç”Ÿå˜åŒ–ï¼Œä½†å®ä¾‹å¯¹è±¡çš„isaæŒ‡å‘å‘ç”Ÿäº†å˜åŒ– é‚£ä¹ˆè¿™ä¸ªåŠ¨æ€ç”Ÿæˆçš„ä¸­é—´ç±»NSKVONotifying_FXPersonå’ŒFXPersonæ˜¯ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ åœ¨æ³¨å†Œè§‚å¯Ÿè€…å‰ååˆ†åˆ«æ‰“å°å­ç±»â€”â€”å‘ç°NSKVONotifying_FXPersonæ˜¯FXPersonçš„å­ç±» 3.3 åŠ¨æ€å­ç±»æ¢ç´¢â‘ é¦–å…ˆå¾—æ˜ç™½åŠ¨æ€å­ç±»è§‚å¯Ÿçš„æ˜¯ä»€ä¹ˆï¼Ÿ ä¸‹é¢è§‚å¯Ÿå±æ€§å˜é‡nameå’Œæˆå‘˜å˜é‡nicknameæ¥æ‰¾åŒºåˆ«ï¼šä¸¤ä¸ªå˜é‡åŒæ—¶å‘ç”Ÿå˜åŒ–ï¼Œä½†åªæœ‰å±æ€§å˜é‡ç›‘å¬åˆ°å›è°ƒâ€”â€”è¯´æ˜åŠ¨æ€å­ç±»è§‚å¯Ÿçš„æ˜¯setteræ–¹æ³• â‘¡é€šè¿‡runtime-APIæ‰“å°ä¸€ä¸‹åŠ¨æ€å­ç±»å’Œè§‚å¯Ÿç±»çš„æ–¹æ³• 1234567891011- (void)printClassAllMethod:(Class)cls { unsigned int count = 0; Method *methodList = class_copyMethodList(cls, &amp;count); for (int i = 0; i&lt;count; i++) { Method method = methodList[i]; SEL sel = method_getName(method); IMP imp = class_getMethodImplementation(cls, sel); NSLog(@&quot;%@-%p&quot;,NSStringFromSelector(sel),imp); } free(methodList);} é€šè¿‡æ‰“å°å¯ä»¥çœ‹å‡ºï¼š FXPersonç±»ä¸­çš„æ–¹æ³•æ²¡æœ‰æ”¹å˜ï¼ˆimpå®ç°åœ°å€æ²¡æœ‰å˜åŒ–ï¼‰ NSKVONotifying_FXPersonç±»ä¸­é‡å†™äº†çˆ¶ç±»FXPersonçš„deallocæ–¹æ³• NSKVONotifying_FXPersonç±»ä¸­é‡å†™äº†åŸºç±»NSObjectçš„classæ–¹æ³•å’Œ_isKVOAæ–¹æ³• é‡å†™çš„classæ–¹æ³•å¯ä»¥æŒ‡å›FXPersonç±» NSKVONotifying_FXPersonç±»ä¸­é‡å†™äº†çˆ¶ç±»FXPersonçš„setNameæ–¹æ³• å› ä¸ºå­ç±»åªç»§æ‰¿ã€ä¸é‡å†™æ˜¯ä¸ä¼šæœ‰æ–¹æ³•impçš„ï¼ˆé‚£ä¹ˆè°ƒç”¨æ–¹æ³•æ—¶ä¼šé—®çˆ¶ç±»è¦æ–¹æ³•å®ç°ï¼‰ ä¸”ä¸¤ä¸ªsetNameçš„åœ°å€æŒ‡é’ˆä¸ä¸€æ · æ¯è§‚å¯Ÿä¸€ä¸ªå±æ€§å˜é‡å°±é‡å†™ä¸€ä¸ªsetteræ–¹æ³•ï¼ˆå¯è‡ªè¡Œè®ºè¯ï¼‰ â‘¢deallocä¹‹åisaæŒ‡å‘è°ï¼Ÿâ€”â€”æŒ‡å›åŸç±» â‘£deallocä¹‹ååŠ¨æ€å­ç±»ä¼šé”€æ¯å—ï¼Ÿâ€”â€”ä¸ä¼š é¡µé¢popåå†æ¬¡pushè¿›æ¥æ‰“å°FXPersonç±»çš„å­ç±»ï¼Œå­ç±»NSKVONotifying_FXPersonç±»ä¾æ—§å­˜åœ¨ â‘¤automaticallyNotifiesObserversForKeyæ˜¯å¦ä¼šå½±å“åŠ¨æ€å­ç±»ç”Ÿæˆâ€”â€”ä¼š åŠ¨æ€å­ç±»ä¼šæ ¹æ®è§‚å¯Ÿå±æ€§çš„automaticallyNotifiesObserversForKeyçš„å¸ƒå°”å€¼æ¥å†³å®šæ˜¯å¦ç”Ÿæˆ 3.4 æ€»ç»“ automaticallyNotifiesObserversForKeyä¸ºYESæ—¶æ³¨å†Œè§‚å¯Ÿå±æ€§ä¼šç”ŸæˆåŠ¨æ€å­ç±»NSKVONotifying_XXX åŠ¨æ€å­ç±»è§‚å¯Ÿçš„æ˜¯setteræ–¹æ³• åŠ¨æ€å­ç±»é‡å†™äº†è§‚å¯Ÿå±æ€§çš„setteræ–¹æ³•ã€deallocã€classã€_isKVOAæ–¹æ³• setteræ–¹æ³•ç”¨äºè§‚å¯Ÿé”®å€¼ deallocæ–¹æ³•ç”¨äºé‡Šæ”¾æ—¶å°†isaæŒ‡å‘åŸæ¥çš„ç±» classæ–¹æ³•ç”¨äºæŒ‡å›åŠ¨æ€å­ç±»çš„çˆ¶ç±» _isKVOAç”¨æ¥æ ‡è¯†æ˜¯å¦æ˜¯åœ¨è§‚å¯Ÿè€…çŠ¶æ€çš„ä¸€ä¸ªæ ‡å¿—ä½ deallocä¹‹åisaæŒ‡å‘åŸæ¥çš„ç±» deallocä¹‹ååŠ¨æ€å­ç±»ä¸ä¼šé”€æ¯ 3.5 åŸç†å›¾å‡è®¾æˆ‘ä»¬è¦è§‚å¯Ÿçš„æ˜¯ Person å®ä¾‹å¯¹è±¡çš„ age å±æ€§ã€‚ æ·»åŠ è§‚å¯Ÿè€…ä¹‹å‰ æ·»åŠ è§‚å¯Ÿè€…ä¹‹å å››ã€è‡ªå·±å®ç°KVOæˆ‘çš„å®Œæ•´ä»£ç å·²æ”¾åˆ° GitHubï¼šLinkğŸ”— 4.1 å‰è¨€ä¸‹é¢æˆ‘ä»¬æ ¹æ®ç³»ç»Ÿ KVO çš„åŸç†ï¼Œç®€å•å®ç°ä¸€ä¸‹ KVOã€‚ æ­¤è¿‡ç¨‹ä¸­ä¼šæœ‰ runtime-API çš„ä½¿ç”¨å’Œæ¥å£è®¾è®¡æ€è·¯çš„è®²è§£ï¼Œæœ€ç»ˆçš„è‡ªå®šä¹‰ KVO èƒ½æ»¡è¶³åŸºæœ¬ä½¿ç”¨çš„éœ€æ±‚ä½†ä»ä¸å®Œå–„ï¼Œä½†æ­¤è¿‡ç¨‹ä¸­æœ€é‡è¦çš„æ˜¯äº†è§£å¹¶æ¨¡ä»¿ç³»ç»Ÿå®ç°åŸç†ï¼Œä»¥åŠåŠ æ·±å¯¹ runtime çš„ç†è§£ã€‚ ç³»ç»Ÿçš„ KVO æ³¨å†Œã€å›è°ƒã€è‡ªåŠ¨ç§»é™¤è§‚å¯Ÿè€…åœ¨å†™æ³•ä¸Šéƒ½æ˜¯åˆ†ç¦»çš„ï¼Œä½¿ç”¨èµ·æ¥ç¨æ˜¾ä¸ç®€æ´ï¼Œæ‰€ä»¥æˆ‘ä»¬è‡ªå®šä¹‰çš„ KVO å°†ä½¿ç”¨ block å›è°ƒå’Œè‡ªåŠ¨é‡Šæ”¾æ¥ä¼˜åŒ–è¿™ä¸€ç‚¹ä¸è¶³ã€‚ è‡ªå®šä¹‰ KVO çš„ä¼˜åŒ–å…¶å®æ˜¯å‚è€ƒäº† FBKVOController çš„å®ç°ï¼Œä½† FBKVOController æ˜¯é€šè¿‡ä¸­é—´å±‚å¯¹ç›¸åº”å±æ€§è¿›è¡Œè§‚å¯Ÿï¼Œç„¶åå›è°ƒåˆ°è§‚å¯Ÿè€…ï¼Œå…¶åœ¨å†…å­˜ç®¡ç†ä¸Šæ›´åŠ å®‰å…¨ï¼›æˆ‘ä»¬çš„è‡ªå®šä¹‰ KVO æ˜¯ç›´æ¥è¿›è¡Œè§‚å¯Ÿï¼Œé€»è¾‘ä¸Šæ›´ç®€å•æ˜“æ‡‚ã€‚ é¦–å…ˆå›é¡¾ç³»ç»Ÿ KVO çš„é€»è¾‘ï¼š 1.automaticallyNotifiesObserversForKeyä¸ºYESæ—¶ï¼Œæ³¨å†Œè§‚å¯Ÿå±æ€§ä¼šç”ŸæˆåŠ¨æ€å­ç±»NSKVONotifying_XXX 2.åŠ¨æ€å­ç±»è§‚å¯Ÿçš„æ˜¯å¯¹åº”å±æ€§çš„setteræ–¹æ³• 3.åŠ¨æ€å­ç±»é‡å†™äº†è§‚å¯Ÿå±æ€§çš„setteræ–¹æ³•ã€deallocã€classã€_isKVOAæ–¹æ³• setteræ–¹æ³•ç”¨äºè§‚å¯Ÿé”®å€¼ deallocæ–¹æ³•ç”¨äºé‡Šæ”¾æ—¶å°†isaæŒ‡å‘åŸæ¥çš„ç±» classæ–¹æ³•ç”¨äºæŒ‡å›åŠ¨æ€å­ç±»çš„çˆ¶ç±» _isKVOAç”¨æ¥æ ‡è¯†æ˜¯å¦æ˜¯åœ¨è§‚å¯Ÿè€…çŠ¶æ€çš„ä¸€ä¸ªæ ‡å¿—ä½ã€è¿™ä¸ªæ²¡å®ç°ã€‘ 4.deallocä¹‹åisaæŒ‡å‘åŸæ¥çš„ç±» 5.deallocä¹‹ååŠ¨æ€å­ç±»ä¸ä¼šé”€æ¯ 4.2 åˆå§‹åŒ–åˆ›å»ºNSObjectçš„åˆ†ç±»ï¼šNSObject+JYKVOï¼Œæä¾›æ·»åŠ è§‚å¯Ÿè€…çš„æ¥å£ï¼š 1234567891011121314151617#import &lt;Foundation/Foundation.h&gt;NS_ASSUME_NONNULL_BEGINtypedef void(^JYKVOBlock)(id observer, NSString *keyPath, id oldValue,id newValue);@interface NSObject (JYKVO)/// å¯¹å±æ€§æ·»åŠ è§‚å¯Ÿ/// @param observer è§‚å¯Ÿè€…/// @param keyPath è§‚å¯Ÿçš„å±æ€§/// @param block å±æ€§æ”¹å˜åçš„å›è°ƒ- (void)jy_addObserver:(NSObject *)observer forKeyPath:(NSString *)keyPath block:(JYKVOBlock)block;@endNS_ASSUME_NONNULL_END ä¸‹é¢å¼€å§‹å®ç°jy_addObserver:forKeyPath:block:æ–¹æ³•ï¼š 4.3 éªŒè¯æ˜¯å¦å­˜åœ¨setteræ–¹æ³•ï¼Œåªè§‚å¯Ÿå±æ€§12// åˆ¤æ–­æ˜¯å¦æœ‰å¯¹åº”çš„ setter if (![self isContainSetterMethodFromKeyPath:keyPath]) return; isContainSetterMethodFromKeyPath:æ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼š 123456789101112/// åˆ¤æ–­æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ setter/// @param keyPath å±æ€§å- (BOOL)isContainSetterMethodFromKeyPath:(NSString *)keyPath { Class class = object_getClass(self); SEL setterSeletor = NSSelectorFromString(setterForKeyPath(keyPath)); Method setterMethod = class_getInstanceMethod(class, setterSeletor); if (!setterMethod) { NSLog(@&quot;æ²¡æ‰¾åˆ°å±æ€§:%@çš„setteræ–¹æ³•&quot;, keyPath); return NO; } return YES;} 4.4 åˆ¤æ–­automaticallyNotifiesObserversForKeyæ–¹æ³•è¿”å›çš„å¸ƒå°”å€¼12BOOL isAutomatically = [self jy_performSelectorWithMethodName:@&quot;automaticallyNotifiesObserversForKey:&quot; keyPath:keyPath];if (!isAutomatically) return; ä¸ºYESæ—¶æ‰ä¼šç»§ç»­ 4.5 åŠ¨æ€ç”Ÿæˆå­ç±»12// åŠ¨æ€ç”Ÿæˆå­ç±»Class newClass = [self createChildClassWithKeyPath:keyPath]; createChildClassWithKeyPath:æ–¹æ³•æ˜¯æˆ‘ä»¬çš„æ ¸å¿ƒæ–¹æ³•ï¼Œåˆ†æ­¥æ¥çœ‹ï¼š â‘´ æ ¹æ® keyPath æ‹¼æ¥ä¸­é—´ç±»çš„åç§°ï¼Œç„¶åå¦‚æœä¸å­˜åœ¨ä¸­é—´ç±»çš„è¯ï¼Œå°±åˆ›å»ºï¼Œå¦‚æœå·²ç»å­˜åœ¨ï¼Œä¸éœ€è¦é‡å¤åˆ›å»º 123456789101112131415161718// è·å–æ–°ç±»çš„ç±»å NSString *oldClassName = NSStringFromClass([self class]); NSString *newClassName = [NSString stringWithFormat:@&quot;%@%@&quot;, kJYKVOPrefix, oldClassName]; Class newClass = NSClassFromString(newClassName); // é˜²æ­¢é‡å¤åˆ›å»ºæ–°ç±» if (newClass) return newClass; /** * ç”³è¯·ç±» * å¦‚æœå†…å­˜ä¸­ä¸å­˜åœ¨, åˆ›å»ºç”Ÿæˆ * å‚æ•°ä¸€: çˆ¶ç±» * å‚æ•°äºŒ: æ–°ç±»çš„åå­— * å‚æ•°ä¸‰: æ–°ç±»çš„å¼€è¾Ÿçš„é¢å¤–ç©ºé—´ */ newClass = objc_allocateClassPair([self class], newClassName.UTF8String, 0); // æ³¨å†Œç±» objc_registerClassPair(newClass); â‘µ æ·»åŠ +classæ–¹æ³• 12345// æ·»åŠ  +class æ–¹æ³•SEL classSEL = NSSelectorFromString(@&quot;class&quot;);Method classMethod = class_getInstanceMethod([self class], classSEL);const char *classTypes = method_getTypeEncoding(classMethod);class_addMethod(newClass, classSEL, (IMP)jy_class, classTypes); â‘¶ æ·»åŠ å¯¹åº”å±æ€§çš„setteræ–¹æ³• 12345// æ·»åŠ  setterSEL setterSEL = NSSelectorFromString(setterForKeyPath(keyPath));Method setterMethod = class_getInstanceMethod([self class], setterSEL);const char *setterTypes = method_getTypeEncoding(setterMethod);class_addMethod(newClass, setterSEL, (IMP)jy_setter, setterTypes); å…¶ä¸­jy_setteræ˜¯æˆ‘ä»¬è‡ªå·±å¯¹setteræ–¹æ³•çš„å®ç°ï¼Œæ€è·¯å¦‚ä¸‹ï¼š â‘  å› ä¸ºæˆ‘ä»¬ä½¿ç”¨KVOæ—¶å€™ï¼Œæ˜¯å¯¹æ“ä½œçš„ç±»(ä¾‹å¦‚ LGPerson)çš„å±æ€§èµ‹å€¼ï¼Œè¿™é‡Œå› ä¸ºå°† isa æŒ‡å‘äº†æ–°åˆ›å»ºçš„ä¸­é—´å­ç±»(NSKVONotifying_LGPerson)ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦è°ƒç”¨çˆ¶ç±»(LGPerson)çš„setter æ–¹æ³•è¿›è¡Œå±æ€§èµ‹å€¼ã€‚æˆ‘ä»¬è¿™é‡Œé€šè¿‡objc_msgSendSuperå‘é€æ¶ˆæ¯æ¥å®ç°ã€‚ 1234567// 1ï¸âƒ£è½¬å‘ç»™çˆ¶ç±»ï¼Œæ”¹å˜çˆ¶ç±»çš„å€¼void (*jy_msgSendSuper)(void *, SEL, id) = (void *)objc_msgSendSuper;struct objc_super superStruct = { .receiver = self, .super_class = class_getSuperclass(object_getClass(self)),};jy_msgSendSuper(&amp;superStruct, _cmd, newValue); â‘¡ å–åŸæ¥çš„å€¼ï¼Œç”¨äºå›è°ƒ 123// 2ï¸âƒ£å–æ—§å€¼NSString *keyPath = getterForSetter(NSStringFromSelector(_cmd));id oldValue = [self valueForKey:keyPath]; â‘¢ å±æ€§æ”¹å˜åæˆ‘ä»¬è¿˜éœ€è¦é€šè¿‡ block çš„æ–¹å¼å›è°ƒåˆ°æ·»åŠ è§‚å¯Ÿçš„åœ°æ–¹ 12345678910// 3ï¸âƒ£é€šçŸ¥è§‚å¯Ÿè€…// 1.æ‹¿åˆ°è§‚å¯Ÿè€…ï¼Œåœ¨æ·»åŠ è§‚å¯Ÿè€…çš„æ—¶å€™é€šè¿‡å…³è”å¯¹è±¡å°† observer å­˜å‚¨äº†èµ·æ¥ã€‚NSMutableArray *mArray = objc_getAssociatedObject(self, (__bridge const void * _Nonnull)(kJYKVOAssiociateKey));// 2.æ¶ˆæ¯å‘é€ç»™è§‚å¯Ÿè€…for (JYKVOInfo *info in mArray) { if ([info.keyPath isEqualToString:keyPath] &amp;&amp; info.handleBlock) { info.handleBlock(info.observer, keyPath, oldValue, newValue); }} â‘· ç„¶åä¸ºäº†å®ç°è‡ªåŠ¨ç§»é™¤è§‚å¯Ÿè€…ï¼Œæˆ‘ä»¬è¿˜è¦äº¤æ¢ä¸€ä¸‹ dealloc æ–¹æ³•çš„å®ç°ï¼Œåœ¨é‡Œé¢åšä¸€äº›äº‹æƒ… 12345// äº¤æ¢ dealloc å®ç°static dispatch_once_t onceToken;dispatch_once(&amp;onceToken, ^{ [self JYMethodSwizzlingWithClass:[self class] oriSEL:NSSelectorFromString(@&quot;dealloc&quot;) swizzledSEL:@selector(jy_dealloc)];}); 123456// å½“å¯¹è±¡é”€æ¯çš„æ—¶å€™ä¼šè°ƒç”¨ deallocï¼Œåœ¨è¯¥æ–¹æ³•ä¸­å°† isa æŒ‡é’ˆé‡æ–°æŒ‡å‘åŸæ¥çš„ç±»- (void)jy_dealloc { Class superClass = [self class]; object_setClass(self, superClass); [self jy_dealloc];} 4.6 å°†isaæŒ‡å‘åˆ›å»ºå¥½çš„åŠ¨æ€å­ç±»12// isaæŒ‡å‘ä¿®æ”¹-&gt;æŒ‡å‘åŠ¨æ€å­ç±»object_setClass(self, newClass); 4.7 ä¿å­˜observerä¿¡æ¯ï¼Œåœ¨setteræ–¹æ³•ä¸­é€šçŸ¥observerçš„æ—¶å€™éœ€è¦ç”¨åˆ°è¯¥ä¿¡æ¯12345678// ä¿å­˜ä¿¡æ¯JYKVOInfo *info = [[JYKVOInfo alloc] initWitObserver:observer forKeyPath:keyPath handleBlock:block];NSMutableArray *mArray = objc_getAssociatedObject(self, (__bridge const void * _Nonnull)(kJYKVOAssiociateKey));if (!mArray) { mArray = [NSMutableArray arrayWithCapacity:1]; objc_setAssociatedObject(self, (__bridge const void * _Nonnull)(kJYKVOAssiociateKey), mArray, OBJC_ASSOCIATION_RETAIN_NONATOMIC);}[mArray addObject:info]; å…¶ä¸­ä½¿ç”¨JYKVOInfoè¿™ä¸ªmodelæ¥å­˜å‚¨observerä¿¡æ¯ï¼Œå› ä¸ºå¯èƒ½ä¼šè¿˜æœ‰å¤šä¸ªobserverï¼Œæ‰€ä»¥ä½¿ç”¨æ•°ç»„çš„å½¢å¼è¿›è¡Œå­˜å‚¨ã€‚ ç°åœ¨å¯ä»¥ç»™ä¸€ä¸ªå±æ€§æ·»åŠ è§‚å¯Ÿæµ‹è¯•ä¸€ä¸‹äº†ã€‚ 4.8 æµ‹è¯•ä¾æ—§æ˜¯Personç±»ï¼Œæœ‰ä¸€ä¸ªç®€å•çš„nameæˆå‘˜å±æ€§ã€‚ ä¸‹é¢åœ¨æ§åˆ¶å™¨ä¸­æ·»åŠ å¯¹nameå±æ€§çš„è§‚å¯Ÿï¼š 12345678self.person = [Person new];self.person.name = @&quot;æ—§åå­—&quot;;[self.person jy_addObserver:self forKeyPath:@&quot;name&quot; block:^(id _Nonnull observer, NSString * _Nonnull keyPath, id _Nonnull oldValue, id _Nonnull newValue) { NSLog(@&quot;æ—§å€¼ï¼š%@&quot;, oldValue); NSLog(@&quot;æ–°å€¼ï¼š%@&quot;, newValue); NSLog(@&quot;pathï¼š%@&quot;, keyPath);}]; ç‚¹å‡»å±å¹•çš„æ—¶å€™å»æ”¹å˜è¿™ä¸ªå¯¹è±¡çš„nameçš„å€¼ï¼š 123- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event { self.person.name = @&quot;æ–°åå­—&quot;;} ç„¶åå°† demo è¿è¡Œï¼Œç‚¹å‡»è¿™ä¸ªæ§åˆ¶å™¨ï¼ŒæŸ¥çœ‹æ‰“å°ï¼š 1232021-03-30 14:48:14.483797+0800 OCTest[13317:272742] æ—§å€¼ï¼šæ—§åå­—2021-03-30 14:48:14.483927+0800 OCTest[13317:272742] æ–°å€¼ï¼šæ–°åå­—2021-03-30 14:48:14.483983+0800 OCTest[13317:272742] pathï¼šname è‡³æ­¤å°±å®Œæˆäº† KVO çš„ç®€å•å®ç°ã€‚ PSè‹¹æœå¼€å‘æ–‡æ¡£- KVO åŸç†çš„ä»‹ç» FBKVOController æˆ‘çš„å®Œæ•´ä»£ç  å‚è€ƒfacebookarchive/KVOController KVOåŸç†åˆ†æ iOSæ¢ç´¢ KVOåŸç†åŠè‡ªå®šä¹‰ è‡ªå®šä¹‰KVO","link":"/2021/03/26/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/14-KVO%E5%8E%9F%E7%90%86/"},{"title":"åŸ‹ç‚¹ SDK ä½¿ç”¨æŒ‡å—","text":"ä¸€ã€ç®€ä»‹æœ¬ SDK åŒ…å«ä¸¤å¤§åŸºç¡€åŠŸèƒ½ï¼š é€šè¿‡åŸ‹ç‚¹æ¥é‡‡é›†æ•°æ® å°†é‡‡é›†çš„æ•°æ®ä¼ è¾“åˆ°æŒ‡å®šçš„æœåŠ¡å™¨ç«¯ï¼ˆæ­¤éƒ¨åˆ†ä¸»è¦ä½¿ç”¨ Analytics ç¬¬ä¸‰æ–¹åº“å®ç°ï¼‰ ç›®å‰ï¼Œä¸šç•Œä¸»æµçš„åŸ‹ç‚¹æ–¹å¼ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç§ï¼š ä»£ç åŸ‹ç‚¹ å…¨åŸ‹ç‚¹ å¯è§†åŒ–åŸ‹ç‚¹ ä»£ç åŸ‹ç‚¹æŒ‡åº”ç”¨ç¨‹åºé›†æˆåŸ‹ç‚¹ SDK åï¼Œåœ¨å¯åŠ¨æ—¶åˆå§‹åŒ–åŸ‹ç‚¹ SDKï¼Œç„¶ååœ¨æŸä¸ªäº‹ä»¶å‘ç”Ÿçš„æ—¶å€™è°ƒç”¨åŸ‹ç‚¹ SDK æä¾›çš„æ–¹æ³•æ¥è§¦å‘äº‹ä»¶ï¼Œä»£ç åŸ‹ç‚¹æ˜¯â€œæœ€åŸå§‹â€çš„åŸ‹ç‚¹æ–¹å¼ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æœ€ä¸‡èƒ½çš„åŸ‹ç‚¹æ–¹å¼ã€‚ å…¨åŸ‹ç‚¹æŒ‡æ— éœ€ APP å¼€å‘è€…å†™ä»£ç æˆ–è€…åªå†™å°‘é‡çš„ä»£ç ï¼Œå³å¯é¢„å…ˆè‡ªåŠ¨é‡‡é›†ç”¨æˆ·çš„æ‰€æœ‰æˆ–è€…ç»å¤§éƒ¨åˆ†çš„è¡Œä¸ºæ•°æ®ï¼Œç„¶åæ ¹æ®å®é™…çš„ä¸šåŠ¡åˆ†æéœ€æ±‚ä»ä¸­ç­›é€‰å‡ºæ‰€éœ€çš„æ•°æ®å¹¶è¿›è¡Œåˆ†æã€‚ æ—§ç‰ˆ SDK ä¸­åªæœ‰ä»£ç åŸ‹ç‚¹ï¼›æ–°ç‰ˆ SDK ä¸­ï¼Œé‡‡ç”¨ä»£ç åŸ‹ç‚¹å’Œå…¨åŸ‹ç‚¹çš„æ–¹å¼è¿›è¡Œæ•°æ®é‡‡é›†ã€‚ äºŒã€SDK é›†æˆ1.Pod æ¥å…¥ä¾èµ–åº“ 1pod 'Analytics'ï¼Œ~&gt; 4.0.5 2.æ‰‹åŠ¨æŠŠXWRuster.frameworkæ‹–åˆ°åˆ°é¡¹ç›®ä¸­ (3.Target -&gt; Build Settings -&gt; Search Paths ä¸­çš„ Framework Search Paths é‡Œæ·»åŠ æœ¬ SDK çš„æœç´¢è·¯å¾„) ä¸‰ã€SDK åŸºæœ¬é…ç½®1.ä½¿ç”¨-initWithAppId:serverURL:æ–¹æ³•é…ç½® AppId å’Œä¸ŠæŠ¥åœ°å€ 2.å…¶ä»–é…ç½®é¡¹å¯æŸ¥çœ‹XWConfigOptions.hæ–‡ä»¶ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788#import &lt;Foundation/Foundation.h&gt;@interface XWConfigOptions : NSObject#pragma mark - åˆå§‹åŒ–/** æŒ‡å®šåˆå§‹åŒ–æ–¹æ³•ï¼Œè®¾ç½® serverURL @param appId å’Œåå°ç»Ÿä¸€ @param serverURL æ•°æ®æ¥æ”¶åœ°å€ @return é…ç½®å¯¹è±¡ */- (instancetype _Nonnull )initWithAppId:(NSString *_Nonnull)appId serverURL:(NSString *_Nonnull)serverURL NS_DESIGNATED_INITIALIZER;/// ç¦ç”¨ init åˆå§‹åŒ–- (instancetype _Nonnull )init NS_UNAVAILABLE;/// ç¦ç”¨ new åˆå§‹åŒ–+ (instancetype _Nonnull )new NS_UNAVAILABLE;#pragma mark - é…ç½®///åˆå§‹åŒ–SDKçš„key@property (nonatomic, copy) NSString * _Nonnull appId;///åˆå§‹åŒ–SDKçš„ä¸ŠæŠ¥åœ°å€@property (nonatomic, copy) NSString * _Nonnull serverURL;///sdkä¸ŠæŠ¥é—´éš”æ—¶é—´ é»˜è®¤ 5@property (nonatomic, assign) NSTimeInterval flushInterval;///sdkä¸ŠæŠ¥è¿›ç¨‹æ•° é»˜è®¤5@property (nonatomic, assign) NSUInteger flushQueueSize;/// æ˜¯å¦å¼€å¯æ’ç åŠŸèƒ½ï¼Œè¯¥åŠŸèƒ½é»˜è®¤æ˜¯å¼€å¯çš„ æ•´ä½“å¼€å…³ï¼Œå…³é—­åæ‰€æœ‰ä¸ŠæŠ¥ï¼ˆåŒ…æ‹¬è‡ªå®šä¹‰ç‚¹ä½éƒ½å…³é—­ è¯·è°¨æ…ä½¿ç”¨ï¼‰@property (nonatomic, assign) BOOL enableTrackAllEvent;@property (nonatomic, assign) BOOL enableTrackCustomEvent;/// æ˜¯å¦å¼€å¯æ— åŸ‹ç‚¹æ’ç åŠŸèƒ½ï¼Œè¯¥åŠŸèƒ½é»˜è®¤æ˜¯å…³é—­çš„ aopä»¥åŠç›‘å¬ç³»ç»Ÿé€šçŸ¥@property (nonatomic, assign) BOOL enableTrackAopEvent;/// æ˜¯å¦å¼€å¯é¡µé¢å£°æ˜å‘¨æœŸæ’ç åŠŸèƒ½ï¼Œè¯¥åŠŸèƒ½é»˜è®¤æ˜¯å¼€å¯çš„@property (nonatomic, assign) BOOL enableTrackPageLife;/// æ˜¯å¦å¼€å¯ç‚¹å‡»äº‹ä»¶ç»Ÿè®¡åŠŸèƒ½ï¼Œè¯¥åŠŸèƒ½é»˜è®¤æ˜¯å…³é—­çš„@property (nonatomic, assign) BOOL enableTrackTouch;/// æ˜¯å¦å¼€å¯ WKWebView çš„ H5 æ‰“é€šåŠŸèƒ½ï¼Œè¯¥åŠŸèƒ½é»˜è®¤æ˜¯å¼€å¯çš„@property (nonatomic, assign) BOOL enableJavaScriptBridge;/// æ˜¯å¦è‡ªåŠ¨æ”¶é›† App Crash æ—¥å¿—ï¼Œè¯¥åŠŸèƒ½é»˜è®¤æ˜¯å¼€å¯çš„@property (nonatomic, assign) BOOL enableTrackAppCrash;/// è€ç‰ˆæœ¬è‡ªå®šä¹‰æ’ç å¼€å…³ï¼Œè¯¥åŠŸèƒ½æ˜¯åå°æ§åˆ¶ ï¼ˆæ§åˆ¶ customTrackWithEventIdï¼š å’Œ customTrackWithEventIdï¼ševentName: ext: ä¸¤ä¸ªæ–¹æ³•ï¼‰@property (nonatomic, assign, readonly) BOOL enableOldCustomTouchEvent;/// é€šç”¨å±æ€§å‰ç¼€@property (nonatomic, copy) NSString * _Nullable autoPrefix;/// è‡ªå®šä¹‰å±æ€§å‰ç¼€@property (nonatomic, copy) NSString * _Nullable customPrefix;/// ä¼ å…¥å±æ€§çš„å‰ç¼€@property (nonatomic, copy) NSString * _Nullable h5Prefix;/// é»˜è®¤ä¸º ***@property (nonatomic, copy) NSString * _Nullable words;/// è€æ’ç æ‰“å°å¼€å…³@property (nonatomic, assign) BOOL enabledOldLog;/// æ–°æ’ç æ‰“å°å¼€å…³@property (nonatomic, assign) BOOL enabledNewLog;/** æ§åˆ¶å™¨é»‘åå•ï¼š æ§åˆ¶å“ªäº›ç±»ä¸éœ€è¦è§¦å‘AOPä¸­çš„é¡µé¢æµè§ˆäº‹ä»¶ï¼Œé»˜è®¤å·²åŒ…å«ï¼š @[ @&quot;UIInputWindowController&quot;, @&quot;UINavigationController&quot;, @&quot;UITabBarController&quot;, @&quot;UICompatibilityInputViewController&quot;, @&quot;UISystemInputAssistantViewController&quot;, @&quot;UIPredictionViewController&quot;, @&quot;UISystemKeyboardDockController&quot; ] */@property (nonatomic, strong) NSArray * _Nullable controllerBlackList;@end å››ã€åˆå§‹åŒ– SDKåœ¨ AppDelegate çš„ - application: didFinishLaunchingWithOptions: ä¸­æ·»åŠ åˆå§‹åŒ–ä»£ç ï¼š 12345678910111213141516171819202122232425262728293031#import &lt;XWRuster/XWRuster.h&gt;- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions { // é…ç½® AppId å’Œä¸ŠæŠ¥åœ°å€ XWConfigOptions *options = [[XWConfigOptions alloc] initWithAppId:@&quot;F23ED4B5C8AD4A89B0F9322973F09082&quot; serverURL:@&quot;https://m.sd.10086.cn/collector_service/&quot;]; // H5 æ‰“é€šåŠŸèƒ½ options.enableJavaScriptBridge = YES; // ç‚¹å‡»äº‹ä»¶ç»Ÿè®¡åŠŸèƒ½ options.enableTrackTouch = NO; // AOP options.enableTrackAopEvent = YES; // è‡ªåŠ¨æ”¶é›† App Crash æ—¥å¿— options.enableTrackAppCrash = YES; // å‰ç¼€ // options.autoPrefix = @&quot;$auto_&quot;; // options.customPrefix = @&quot;$cus_&quot;; // options.h5Prefix = @&quot;$h5_&quot;; // æ–°æ’ç æ‰“å°å¼€å…³ options.enabledNewLog = YES; // è€æ’ç æ‰“å°å¼€å…³ options.enabledOldLog = NO; [XWSdRuster configWithConfigOption:options]; return YES;} äº”ã€æ–°ç‰ˆ &amp; æ—§ç‰ˆ SDK è¯´æ˜æ—§ç‰ˆæ’ç  SDK åªå…·æœ‰ä»£ç åŸ‹ç‚¹åŠŸèƒ½ï¼Œä»¥ä¸‹æ˜¯å…¶å…¨éƒ¨ APIï¼š XWSdRuster.h 12345678910111213/** è‡ªå®šä¹‰ä¸Šä¼ äº‹ä»¶ eventä¸º touch @param eventId è§¦ç‚¹æ ‡è¯† */+ (void)customTrackWithEventId:(NSString *_Nonnull)eventId;/** è‡ªå®šä¹‰ä¸Šä¼ äº‹ä»¶ eventä¸º touch @param eventId è§¦ç‚¹æ ‡è¯† @param eventName è§¦ç‚¹åç§° @param ext æ‰©å±•å±æ€§ */+ (void)customTrackWithEventId:(NSString *_Nonnull)eventId eventName:(NSString *_Nonnull)eventName ext:(NSDictionary *_Nonnull)ext; æ–°ç‰ˆæ’ç  SDK å…·æœ‰å…¨åŸ‹ç‚¹å’Œä»£ç åŸ‹ç‚¹çš„åŠŸèƒ½ï¼Œä¸‹æ–‡ä¼šç€é‡è®²ã€‚ å…­ã€æ–°ç‰ˆ SDK åŠŸèƒ½è¯´æ˜6.1 ä¸ŠæŠ¥æŠ¥æ–‡è¯´æ˜ç”±äºä¸ŠæŠ¥æ˜¯é€šè¿‡Analyticsè¿›è¡Œçš„ï¼Œå¦‚è¦æŸ¥çœ‹å®Œæ•´çš„ä¸ŠæŠ¥æŠ¥æ–‡ï¼Œåˆ™éœ€è¦å°†é¡¹ç›®ä¸­çš„ï¼š Edit Schemeâ†’Runâ†’Argumentsâ†’Environment Variablesâ†’OS_ACTIVITY_MODE å¯¹åº”çš„ disable å»æ‰ã€‚ SDK ä¸­ä¸€ä¸ªäº‹ä»¶çš„å®Œæ•´ä¸ŠæŠ¥æŠ¥æ–‡ç¤ºä¾‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556{ anonymousId = &quot;291BBD31-4A7A-4339-A214-3FA4DEA4DCE5&quot;; context = { app = { build = 21050810; name = &quot;\\U5c71\\U4e1c\\U79fb\\U52a8&quot;; namespace = &quot;cn.10086.shandongmcc&quot;; version = &quot;5.5.0&quot;; }; device = { id = &quot;9C9C0A98-4E00-5453-BA5F-E489F8BA0EBB&quot;; manufacturer = Apple; model = &quot;iPad8,6&quot;; name = iPad; type = ios; }; library = { name = &quot;analytics-ios&quot;; version = &quot;4.0.5&quot;; }; locale = &quot;zh-CN&quot;; network = { cellular = 0; wifi = 1; }; os = { name = iOS; version = &quot;14.5&quot;; }; screen = { height = 667; width = 375; }; timezone = &quot;Asia/Shanghai&quot;; traits = {}; }; event = &quot;$ElementExposure&quot;; integrations = {}; messageId = &quot;01D49861-725A-42A2-BE4E-D8A8DB19E742&quot;; properties = { &quot;$clientFormatTime&quot; = &quot;2021-05-08 15:39:23 641&quot;; &quot;$clientLongTime&quot; = &quot;1620459563640.605&quot;; &quot;$event&quot; = &quot;$ElementExposure&quot;; &quot;$isFirstDay&quot; = false; &quot;$xa_className&quot; = XWHomeController; &quot;$xa_fromClassName&quot; = XWWKWebViewController; &quot;$xa_isLogin&quot; = false; &quot;$xa_orientation&quot; = V; businessId = 4230; businessName = &quot;\\U5e78\\U8fd0\\U5927\\U8f6c\\U76d8&quot;; pageName = &quot;home_floor_450&quot;; transactionType = &quot;\\U653f\\U4f01\\U4e1a\\U52a1&quot;; }; timestamp = &quot;2021-05-08T07:39:23.641Z&quot;; type = track;} å…¶ä¸­eventå­—æ®µä¸ºäº‹ä»¶åï¼Œpropertieså­—æ®µä¸ºæ­¤æ¬¡æ’ç äº‹ä»¶å¯¹åº”çš„ä¸€ç³»åˆ—å±æ€§ï¼Œè¿™äº›å±æ€§ç”±ä¸€éƒ¨åˆ†é¢„ç½®å±æ€§å’Œä¼ å…¥å±æ€§å…±åŒç»„æˆã€‚ å¦‚æœä¸éœ€è¦æŸ¥çœ‹å†—é•¿çš„å®Œæ•´æŠ¥æ–‡åˆæƒ³çŸ¥é“è§¦å‘äº†å“ªäº›äº‹ä»¶ï¼Œåˆ™å¯ä»¥é€šè¿‡æˆ‘ä»¬æä¾›çš„ SDK äº‹ä»¶æ‰“å°è¿›è¡ŒæŸ¥çœ‹ï¼Œç”±ä¸¤ä¸ªå¼€å…³æ§åˆ¶ï¼š XWConfigOptions.h 12345/// è€æ’ç æ‰“å°å¼€å…³@property (nonatomic, assign) BOOL enabledOldLog;/// æ–°æ’ç æ‰“å°å¼€å…³@property (nonatomic, assign) BOOL enabledNewLog; å¼€å¯æ—§æ’ç æ‰“å°å¼€å…³åçš„ Logï¼š 12345678910111213141516function:+[XWSdRuster customTrackWithEventId:eventName:ext:] line:245 content:{ &quot;formatTime&quot; : &quot;2021-05-08 15:52:43 540&quot;,&quot;WT.si_x&quot; : &quot;20&quot;,&quot;WT.nv&quot; : &quot;home&quot;,&quot;longTime&quot; : &quot;1620460363540&quot;,&quot;WT.transactionId&quot; : &quot;APP_T_PROVINCE_CONTENT_786569&quot;,&quot;WT.mobile&quot; : &quot;&quot;,&quot;whole_life_cycle_statistics_id&quot; : &quot;D2DFBA94-8FC4-492B-8C1A-07143B02921A_1620460343163&quot;,&quot;eventId&quot; : &quot;2200046&quot;,&quot;WT.event&quot; : &quot;2200046&quot;,&quot;eventName&quot; : &quot;é¦–é¡µ_è½®æ’­å›¾_2_æµé‡åŠ æ²¹&quot;,&quot;WT.sdnv&quot; : &quot;é¦–é¡µ_è½®æ’­å›¾_2_æµé‡åŠ æ²¹&quot;,&quot;WT.av&quot; : &quot;5.5.0&quot;,&quot;WT.action_type&quot; : &quot;exp&quot;,&quot;WT.cid&quot; : &quot;1b3a5529fcedc2c49d01f5d45e13ce384a0536d505770d6f200b2114b41c1f0d&quot;,} å¼€å¯æ–°æ’ç æ‰“å°å¼€å…³åçš„ Logï¼š 1234567891011121314151617function:-[TOEventStore track:properties:] line:382 content:äº‹ä»¶åï¼š$ElementExposureå±æ€§ï¼š{ &quot;pageName&quot; : &quot;home_floor_450&quot;,&quot;businessName&quot; : &quot;ç›´æ’­&quot;,&quot;$xa_className&quot; : &quot;XWHomeController&quot;,&quot;$xa_isLogin&quot; : &quot;false&quot;,&quot;$event&quot; : &quot;$ElementExposure&quot;,&quot;$isFirstDay&quot; : &quot;false&quot;,&quot;$xa_fromClassName&quot; : &quot;XWWKWebViewController&quot;,&quot;transactionType&quot; : &quot;æ”¿ä¼ä¸šåŠ¡&quot;,&quot;$clientFormatTime&quot; : &quot;2021-05-08 15:51:35 772&quot;,&quot;$xa_orientation&quot; : &quot;V&quot;,&quot;businessId&quot; : &quot;4621&quot;,&quot;$clientLongTime&quot; : &quot;1620460295772.308&quot;,} 6.2 åå°é…ç½®è¯´æ˜åœ¨ SDK åˆå§‹åŒ–æ—¶ä¼šå»è¯·æ±‚åå°é…ç½®é¡¹ï¼Œç”¨äºé…ç½®ä¸Šä¼ åœ°å€å’Œæ§åˆ¶æ–°è€æ’ç å¼€å…³ï¼Œå…·ä½“æŠ¥æ–‡å¦‚ä¸‹ï¼š 1234567891011121314{&quot;integrations&quot;: { &quot;Segment.io&quot;: { &quot;apiKey&quot;: &quot;XXXXXXXXXXXXXXXXXXXX&quot;,// èº«ä»½å‡­è¯ &quot;perm&quot;: &quot;0101&quot;, &quot;collectServer&quot;: &quot;https://m.sd.10086.cn/collector_service/XXXXXXXXXXXXXXXXXXXX/import&quot;// æ•°æ®ä¸Šä¼ åœ°å€ }, &quot;config&quot;: { &quot;oldTouch&quot;:0, // 1ä»£è¡¨å…³é—­è€ç‰ˆæ’ç ï¼Œå¦åˆ™è¡¨ç¤ºå¼€å¯ &quot;newTouch&quot;:0:// 1ä»£è¡¨å…³é—­æ–°ç‰ˆæ’ç ï¼Œå¦åˆ™è¡¨ç¤ºå¼€å¯ &quot;å…¶å®ƒé…ç½®é¡¹&quot;:&quot;...&quot; }}} 6.3 è®¾ç½®å±æ€§çš„å‰ç¼€XWConfigOptionsç±»ä¸­çš„autoPrefixå±æ€§å¯ä»¥é…ç½®é¢„ç½®å±æ€§çš„å‰ç¼€ï¼ŒcustomPrefixå±æ€§å¯ä»¥é…ç½®è‡ªå®šä¹‰å±æ€§å‰ç¼€ï¼Œh5Prefixå±æ€§å¯ä»¥é…ç½® H5 ä¼ å…¥å±æ€§çš„å‰ç¼€ã€‚ å‡è®¾åœ¨é¡¹ç›®ä¸­è¿›è¡Œå¦‚ä¸‹é…ç½®ï¼š 123options.autoPrefix = @&quot;$auto_&quot;;options.customPrefix = @&quot;$custom_&quot;;options.h5Prefix = @&quot;$h5_&quot;; åˆ™ä¸ŠæŠ¥æŠ¥æ–‡å¦‚ä¸‹ï¼š 12345678910...&quot;event&quot;: &quot;touch&quot;,&quot;properties&quot; = { &quot;$auto_customTouchName&quot; = &quot;11&quot;; &quot;$auto_formatTime&quot; = &quot;2021-04-08 11:03:15 647&quot;; &quot;$auto_longTime&quot; = &quot;1617850995646.862&quot;; &quot;$custom_testKey1&quot; = &quot;test&quot;; &quot;$custom_testKey2&quot; = &quot;test&quot;; };... 1234567...&quot;event&quot;: &quot;touch&quot;,&quot;properties&quot; = { &quot;$auto_dataSubmit&quot; = &quot;iOS&quot;; &quot;$h5_testkey&quot; = &quot;æµ‹è¯•ç‚¹å‡»&quot;; };... 6.4 å…¨åŸ‹ç‚¹6.4.1 å¼€å¯å’Œå…³é—­å…¨åŸ‹ç‚¹åŠŸèƒ½XWConfigOptions.hï¼š 12345/// å…¨åŸ‹ç‚¹æ€»å¼€å…³ï¼Œé»˜è®¤å…³é—­@property (nonatomic, assign) BOOL enableTrackAopEvent;/// ç‚¹å‡»å…¨åŸ‹ç‚¹å¼€å…³ï¼Œé»˜è®¤å…³é—­@property (nonatomic, assign) BOOL enableTrackTouch; enableTrackAopEventå±æ€§æ§åˆ¶å…¨åŸ‹ç‚¹çš„æ€»å¼€å…³ï¼Œé»˜è®¤å…³é—­ï¼Œéœ€æ‰‹åŠ¨æ‰“å¼€ã€‚ enableTrackTouchå±æ€§æ˜¯åœ¨å…¨åŸ‹ç‚¹æ€»å¼€å…³æ‰“å¼€çš„åŸºç¡€ä¸Šï¼Œæ§åˆ¶å…¨åŸ‹ç‚¹çš„ç‚¹å‡»å¼€å…³ï¼Œé»˜è®¤å…³é—­ï¼Œéœ€æ‰‹åŠ¨æ‰“å¼€ã€‚ 6.4.2 åº”ç”¨å¯åŠ¨äº‹ä»¶åœ¨ SDK åˆšåˆå§‹åŒ–å®Œæˆçš„æ—¶å€™ç«‹å³è§¦å‘åº”ç”¨å¯åŠ¨äº‹ä»¶ï¼Œæ‰€ä»¥åº”è¯¥å°†æ­¤ SDK çš„åˆå§‹åŒ–å†™åœ¨è‡ªå·±é¡¹ç›®ä¸­çš„-application:didFinishLaunchingWithOptions:æ–¹æ³•ä¸­ï¼Œä¸”ä½ç½®è¶Šé å‰è¶Šå¥½ã€‚ ä¸Šä¼ æŠ¥æ–‡ï¼š 12345678{ &quot;$event&quot; : &quot;$AppStart&quot;,&quot;$isFirstDay&quot; : &quot;false&quot;,&quot;$xa_bootTime&quot; : &quot;44.54398155212402&quot;,&quot;$clientLongTime&quot; : &quot;1620442030733.773&quot;,&quot;$xa_startType&quot; : &quot;3&quot;,&quot;$clientFormatTime&quot; : &quot;2021-05-08 10:47:10 734&quot;,} 6.4.3 åº”ç”¨é€€å‡ºäº‹ä»¶åº”ç”¨å³å°†è¢«æ€æ­»å‰ä¼šè§¦å‘$AppEndäº‹ä»¶ã€‚ ä¸Šä¼ æŠ¥æ–‡ï¼š 1234567891011{ &quot;$event&quot; : &quot;$AppEnd&quot;,&quot;$clientFormatTime&quot; : &quot;2021-05-08 10:48:54 903&quot;,&quot;$clientLongTime&quot; : &quot;1620442134902.711&quot;,&quot;$xa_duration&quot; : &quot;7563.519954681396&quot;,&quot;$xa_exit_time&quot; : &quot;1620442134.901742&quot;,&quot;$xa_lastUrl&quot; : &quot;&quot;,&quot;$xa_exit_format&quot; : &quot;2021-05-08 10:48:54 902&quot;,&quot;$isFirstDay&quot; : &quot;false&quot;,&quot;$xa_lastClassName&quot; : &quot;XWHomeController&quot;,} 6.4.4 åº”ç”¨å¯åŠ¨æ—¶é•¿åº”ç”¨å¯åŠ¨æ—¶é•¿ç»Ÿè®¡æ˜¯é€šè¿‡è®¡ç®—åº”ç”¨ç¨‹åºä»è¿›å…¥å‰å°å¤„äºæ´»è·ƒçŠ¶æ€åˆ°ç»“æŸè¿›ç¨‹çš„æ—¶é—´ï¼Œå‡å»åº”ç”¨å¤„äºåå°ä¸æ´»è·ƒçŠ¶æ€çš„æ•´ä¸ªè¿è¡Œæ—¶é—´é—´éš”æ¥å®Œæˆçš„ã€‚ äºä¸Šè¿°$AppEndäº‹ä»¶ä¸­ä¸Šä¼ æ­¤å€¼ï¼š 123456{&quot;$event&quot; : &quot;$AppEnd&quot;, ...&quot;$xa_duration&quot; : &quot;7563.519954681396&quot;, ...} 6.4.5 å´©æºƒé‡‡é›†è‹¹æœå…¬å¸å…¶å®åœ¨ iOS ç³»ç»Ÿä¸­æä¾›äº†è‡ªåŠ¨æ”¶é›†åº”ç”¨å´©æºƒå¹¶ä¸ŠæŠ¥çš„åŠŸèƒ½ï¼Œæ‰“å¼€æ–¹å¼ä¸ºï¼šåœ¨ iPhone ä¸­è¿›å…¥è®¾ç½® â éšç§ â åˆ†æä¸æ”¹è¿› â æ‰“å¼€â€œä¸ App å¼€å‘è€…å…±äº«â€ã€‚ä½†å¹¶ä¸æ˜¯æ‰€æœ‰çš„ iPhone ç”¨æˆ·éƒ½å¼€å¯äº†è¯¥åŠŸèƒ½ï¼Œå› æ­¤å¯¹äºé‡‡é›† SDK æ¥è¯´ï¼Œå´©æºƒé‡‡é›†ä¸ŠæŠ¥ä¹Ÿéœ€è¦æˆ‘ä»¬è‡ªå·±å®ç°ã€‚ é‡‡é›†åº”ç”¨ç¨‹åºçš„å´©æºƒåˆ†ä¸ºä»¥ä¸‹ä¸¤ç§æ–¹å¼ï¼š NSException å¼‚å¸¸ Unix ä¿¡å·å¼‚å¸¸ æ–°æ’ç  SDK ç›®å‰é‡‡é›†çš„æ˜¯ NSException å¼‚å¸¸ï¼Œå½“åº”ç”¨å´©æºƒæ—¶ï¼Œè®°å½•æ­¤æ¬¡å´©æºƒäº‹ä»¶ï¼Œäºä¸‹æ¬¡åº”ç”¨å¯åŠ¨æ—¶ä¸ŠæŠ¥ã€‚ æ­¤åŠŸèƒ½ä¹Ÿæœ‰å¼€å…³æ§åˆ¶ï¼Œä¸”ç‹¬ç«‹äºå…¨åŸ‹ç‚¹æ€»å¼€å…³ï¼š XWConfigOptions.h 12/// æ˜¯å¦è‡ªåŠ¨æ”¶é›† App Crash æ—¥å¿—ï¼Œè¯¥åŠŸèƒ½é»˜è®¤æ˜¯å¼€å¯çš„@property (nonatomic, assign) BOOL enableTrackAppCrash; ä¸Šä¼ æŠ¥æ–‡ï¼š 1234567891011121314151617181920212223242526272829303132333435363738{ &quot;$clientFormatTime&quot; = &quot;2021-05-08 11:31:26 646&quot;; &quot;$clientLongTime&quot; = &quot;1620444686645.091&quot;; &quot;$event&quot; = &quot;$AppCrashed&quot;; &quot;$isFirstDay&quot; = false; &quot;$xa_crashTrace&quot; = &quot;[ Uncaught Exception ]\\nName: NSRangeException, Reason: *** -[__NSArrayI objectAtIndexedSubscript:]: index 3 beyond bounds [0 .. 2]\\n[ Fe Symbols Start ]\\n0 CoreFoundation 0x00000001925f2a5c 7519E999-1053-3367-B9D5-8844F6D3BDC6 + 1227356\\n1 libobjc.A.dylib 0x0000000192319fa4 objc_exception_throw + 56\\n2 CoreFoundation 0x0000000192648360 7519E999-1053-3367-B9D5-8844F6D3BDC6 + 1577824\\n3 CoreFoundation 0x00000001924e92a0 7519E999-1053-3367-B9D5-8844F6D3BDC6 + 139936\\n4 XWRusterOCDemo 0x000000010446a980 -[ViewController crash] + 296\\n5 XWRusterOCDemo 0x000000010446a788 -[ViewController tableView:didSelectRowAtIndexPath:] + 344\\n6 UIKitCore 0x0000000196842948 D7630067-7A00-3CB7-99E1-E7F6C55D85C5 + 12376392\\n7 UIKitCore 0x0000000196842464 D7630067-7A00-3CB7-99E1-E7F6C55D85C5 + 12375140\\n8 UIKitCore 0x0000000196842b64 D7630067-7A00-3CB7-99E1-E7F6C55D85C5 + 12376932\\n9 UIKitCore 0x0000000196681c84 D7630067-7A00-3CB7-99E1-E7F6C55D85C5 + 10538116\\n10 UIKitCore 0x00000001966717d4 D7630067-7A00-3CB7-99E1-E7F6C55D85C5 + 10471380\\n11 UIKitCore 0x00000001966a1744 D7630067-7A00-3CB7-99E1-E7F6C55D85C5 + 10667844\\n12 CoreFoundation 0x000000019256fe68 7519E999-1053-3367-B9D5-8844F6D3BDC6 + 691816\\n13 CoreFoundation 0x000000019256ad54 7519E999-1053-3367-B9D5-8844F6D3BDC6 + 671060\\n14 CoreFoundation 0x000000019256b320 7519E999-1053-3367-B9D5-8844F6D3BDC6 + 672544\\n15 CoreFoundation 0x000000019256aadc CFRunLoopRunSpecific + 464\\n16 GraphicsServices 0x000000019c50b328 GSEventRunModal + 104\\n17 UIKitCore 0x000000019667863c UIApplicationMain + 1936\\n18 XWRusterOCDemo 0x000000010446cdbc main + 120\\n19 libdyld.dylib 0x00000001923f4360 7B531A15-3E73-3185-90E2-B88D9476DA5E + 4960\\n[ Fe Symbols End ]\\n\\n&quot;; &quot;$xa_exception&quot; = NSRangeException; &quot;$xa_formatTime&quot; = &quot;2021-05-08 11:31:10 871&quot;; &quot;$xa_lastClassName&quot; = &quot;&quot;; &quot;$xa_lastUrl&quot; = &quot;&quot;; &quot;$xa_longTime&quot; = 1620444670871; &quot;$xa_timeOutLong&quot; = 0;} 6.4.6 åŸç”Ÿé¡µé¢ç‚¹å‡»äº‹ä»¶åŒ…å«æ™®é€šæŒ‰é’®ç‚¹å‡»ã€tableView ç‚¹å‡»ã€collectionView ç‚¹å‡»ã€tabBar ç‚¹å‡»çš„å…¨åŸ‹ç‚¹ã€‚å¯è‡ªè¡Œæ‰“å° Log æŸ¥çœ‹ã€‚ é€šè¿‡æ­¤å¼€å…³è¿›è¡Œå•ç‹¬æ§åˆ¶ï¼š XWConfigOptions.hï¼š 12/// ç‚¹å‡»å…¨åŸ‹ç‚¹å¼€å…³ï¼Œé»˜è®¤å…³é—­@property (nonatomic, assign) BOOL enableTrackTouch; 6.4.7 åŸç”Ÿé¡µé¢æ‰“å¼€ã€å…³é—­åŠæµè§ˆæ—¶é•¿ç»Ÿè®¡é¡µé¢æ‰“å¼€è§¦å‘$PageLoadäº‹ä»¶ï¼ŒåŒ…å«é¡µé¢è·¯å¾„ï¼ˆä¸Šä¸€ä¸ªæ‰“å¼€çš„åŸç”Ÿé¡µé¢ï¼‰ï¼Œä¸ŠæŠ¥æŠ¥æ–‡ï¼š 123456789101112131415161718{ &quot;event&quot;: &quot;$PageLoad&quot;, &quot;properties&quot;: { â€œ$clientLongTimeâ€ï¼š1608703614208, â€$clientFormatTimeâ€œï¼š&quot;2021-01-01 00:00:00 321&quot; &quot;$isFirstDay&quot;: &quot;false&quot; // æ˜¯å¦ç¬¬ä¸€æ¬¡è®¿é—®ï¼ˆä¸æ˜¯æ¯å¤©ç¬¬ä¸€æ¬¡è€Œæ˜¯æ•´ä¸ªç”Ÿæ¶¯çš„ç¬¬ä¸€æ¬¡ï¼‰ &quot;$userMobile&quot;:&quot;67894rhtgjfeiruyhejd&quot; // åŠ å¯†åçš„ç”¨æˆ·æ ‡è¯† &quot;$event&quot;:&quot;$PageLoad&quot; &quot;$pageUrl&quot;: &quot;&quot;, // å¦‚æœæ˜¯webViewåˆ™è®°å½•H5åœ°å€ &quot;$pageReferrer&quot;: &quot;&quot;, // ä¸Šä¸€ä¸ªH5çš„åœ°å€ &quot;$pageTitle&quot;: &quot;&quot;, // H5æ ‡é¢˜ &quot;$xa_className&quot;: &quot;&quot;, &quot;$xa_fromClassName&quot;: &quot;&quot;, &quot;$xa_isLogin&quot;: &quot;true&quot;, // æ˜¯å¦ç™»å½• &quot;$xa_orientation&quot;: &quot;&quot;, // å±å¹•æ–¹å‘ï¼ŒVç«–å±ï¼ŒHæ¨ªå± &quot;$xa_screenName&quot;:&quot;&quot;// é¡µé¢æ ‡é¢˜ï¼Œä¸ä¸€å®šæœ‰ }} é¡µé¢å…³é—­è§¦å‘$PageStayLengthäº‹ä»¶ï¼ŒåŒ…å«åŸç”Ÿé¡µé¢é©»ç•™æ—¶é•¿ï¼Œä¸ŠæŠ¥æŠ¥æ–‡ï¼š 1234567891011121314151617181920{ &quot;event&quot;: &quot;$PageStayLength&quot;, &quot;properties&quot;: { &quot;$clientLongTime&quot;ï¼š1608703614208, &quot;$clientFormatTime&quot;ï¼š&quot;2021-01-01 00:00:00 321&quot;, &quot;$isFirstDay&quot;: &quot;false&quot; // æ˜¯å¦ç¬¬ä¸€æ¬¡è®¿é—®ï¼ˆä¸æ˜¯æ¯å¤©ç¬¬ä¸€æ¬¡è€Œæ˜¯æ•´ä¸ªç”Ÿæ¶¯çš„ç¬¬ä¸€æ¬¡ï¼‰ &quot;$userMobile&quot;:&quot;67894rhtgjfeiruyhejd&quot; // åŠ å¯†åçš„ç”¨æˆ·æ ‡è¯† &quot;$event&quot;:&quot;$PageStayLength&quot; &quot;$pageUrl&quot;: &quot;&quot;, // å¦‚æœæ˜¯ webView åˆ™è®°å½• H5 åœ°å€ &quot;$pageReferrer&quot;: &quot;&quot;, // ä¸Šä¸€ä¸ªH5çš„åœ°å€ &quot;$pageTitle&quot;: &quot;&quot;, // H5 æ ‡é¢˜ &quot;$pageDuration&quot;:12343 // H5 é©»ç•™æ—¶é•¿ &quot;$xa_className&quot;: &quot;&quot;, &quot;$xa_fromClassName&quot;: &quot;&quot;, &quot;$xa_isLogin&quot;: &quot;true&quot;, // æ˜¯å¦ç™»å½• &quot;$xa_orientation&quot;: &quot;&quot;, // å±å¹•æ–¹å‘ï¼ŒVç«–å±ï¼ŒHæ¨ªå± &quot;$xa_nativeDuration&quot;:16087 // åŸç”Ÿé¡µé¢é©»ç•™æ—¶é•¿ &quot;$xa_screenName&quot;:&quot;&quot; // é¡µé¢æ ‡é¢˜ }} ç”±äº iOS çš„æœºåˆ¶ï¼ŒApp åœ¨é¡µé¢æµè§ˆæ—¶ä¼šå¤¹æ‚ç€ä¸€äº›çœ‹ä¸åˆ°çš„ã€éå¼€å‘è€…å†™çš„æ§åˆ¶å™¨ï¼Œæ‰€ä»¥åœ¨é¡µé¢æ‰“å¼€æ—¶ä¼šè§¦å‘å¤šä½™çš„$PageLoadäº‹ä»¶ï¼Œäºæ˜¯æˆ‘ä»¬å¼•å…¥äº†é»‘åå•æœºåˆ¶ï¼Œå³åœ¨é»‘åå•é‡Œé…ç½®å“ªäº›æ§åˆ¶å™¨åŠå…¶å­ç±»ä¸èƒ½è§¦å‘é¡µé¢æ‰“å¼€å’Œå…³é—­äº‹ä»¶ã€‚ ä½¿ç”¨XWConfigOptionsç±»çš„@property (nonatomic, strong) NSArray * _Nullable controllerBlackList;å±æ€§è¿›è¡Œé…ç½®ã€‚é»˜è®¤å·²åŒ…å«ï¼š 123456789@[ @&quot;UIInputWindowController&quot;, @&quot;UINavigationController&quot;, @&quot;UITabBarController&quot;, @&quot;UICompatibilityInputViewController&quot;, @&quot;UISystemInputAssistantViewController&quot;, @&quot;UIPredictionViewController&quot;, @&quot;UISystemKeyboardDockController&quot;] å¼€å‘è€…é¡µå¯ä»¥è‡ªè¡Œæ·»åŠ ï¼Œæ¥è¿‡ç•¥æ‰è‡ªå·±é¡¹ç›®ä¸­ä¸éœ€è¦è§¦å‘é¡µé¢æ‰“å¼€å’Œå…³é—­äº‹ä»¶çš„æ§åˆ¶å™¨ã€‚ 6.4.8 WKWebView é¡µé¢åŠ è½½é”™è¯¯èƒ½å¤Ÿæ•è·åˆ°å¸¸è§çš„ http é”™è¯¯ã€‚ ä¸ŠæŠ¥æŠ¥æ–‡ï¼š 123456789101112131415161718192021{ &quot;event&quot;: &quot;$Error&quot;, &quot;properties&quot;: { &quot;$clientLongTime&quot;: &quot;1620454190114.114&quot;, &quot;$xa_className&quot;: &quot;XWWKWebViewController&quot;, &quot;$xa_title&quot;: &quot;&quot;, &quot;$xa_fromTitle&quot;: &quot;&quot;, &quot;$xa_path&quot;: &quot;https://m.sd.10086.cn/sd_fe_service/sd2023/index.html#/&quot;, &quot;$xa_line&quot;: &quot;&quot;, &quot;$userMobile&quot;: &quot;c46f73828bda53dfae9b084d807fae66&quot;, &quot;$isFirstDay&quot;: &quot;false&quot;, &quot;$event&quot;: &quot;$Error&quot;, &quot;$xa_fromUrl&quot;: &quot;&quot;, &quot;$xa_name&quot;: &quot;å¾®åšç­¾åˆ°&quot;, &quot;$xa_fromClassName&quot;: &quot;XWWKWebViewController&quot;, &quot;$clientFormatTime&quot;: &quot;2021-05-08 14:09:50 114&quot;, &quot;$xa_message&quot;: &quot;Error Domain=NSURLErrorDomain Code=-1002 &quot;unsupported URL&quot; UserInfo={_NSURLErrorFailingURLSessionTaskErrorKey=LocalDataTask &lt;11D57D43-E993-4CE3-B6FA-16E7EE760254&gt;.&lt;11&gt;, NSLocalizedDescription=unsupported URL, _WKRecoveryAttempterErrorKey=&lt;WKReloadFrameErrorRecoveryAttempter: 0x282480540&gt;, networkTaskDescription=LocalDataTask &lt;11D57D43-E993-4CE3-B6FA-16E7EE760254&gt;.&lt;11&gt;, NSErrorFailingURLStringKey=sinaweibo://cardlist?containerid=102803&amp;finish=true&amp;open_direct=1&amp;extparam=from_mobilesign_5310&amp;luicode=10000629&amp;lfid=sansiline_shouting_015&amp;launchid=10000629-sansiline_shouting_015&amp;callbackurl=sdmccweb://sd.10086.cn/honeybeeEden&amp;extparam=from_mobilesign_5310_18764741016_1620454189_cefe542cb8bea141851547701dc10740ffc448ad8738d9d8b5d54c3b7bff34a2, NSErrorFailingURLKey=sinaweibo://cardlist?containerid=102803&amp;finish=true&amp;open_direct=1&amp;extparam=from_mobilesign_5310&amp;luicode=10000629&amp;lfid=sansiline_shouting_015&amp;launchid=10000629-sansiline_shouting_015&amp;callbackurl=sdmccweb://sd.10086.cn/honeybeeEden&amp;extparam=from_mobilesign_5310_18764741016_1620454189_cefe542cb8bea141851547701dc10740ffc448ad8738d9d8b5d54c3b7bff34a2, NSUnderlyingError=0x282a27270 {Error Domain=kCFErrorDomainCFNetwork Code=-1002 &quot;(null)&quot;}}&quot;, &quot;$xa_url&quot;: &quot;&quot;, &quot;$xa_errorType&quot;: &quot;6&quot;, }} 6.4.9 ä¸H5æ‰“é€šå¸¸è§çš„æ‰“é€šæ–¹æ¡ˆæœ‰ä»¥ä¸‹ä¸¤ç§ï¼š é€šè¿‡æ‹¦æˆª WebView è¯·æ±‚è¿›è¡Œæ‰“é€š é€šè¿‡ JavaScript ä¸ WebView ç›¸äº’è°ƒç”¨è¿›è¡Œæ‰“é€š é€šè¿‡æ‹¦æˆªè¯·æ±‚å®ç°æ‰“é€šï¼Œæ˜¯ä¸€ç§æ¯”è¾ƒé€šç”¨çš„æ–¹æ¡ˆï¼Œä¸è¿‡å®ç°ç›¸å¯¹å¤æ‚ï¼Œå†åŠ ä¸Š UserAgent çš„ä¸ç¨³å®šæ€§ï¼Œéƒ½ä¼šå¯¼è‡´æ‰“é€šå¤±è´¥ã€‚æ‰€ä»¥æ–°æ’ç  SDK é‡‡ç”¨ç¬¬äºŒç§æ–¹æ¡ˆã€‚ é¦–å…ˆåŒæ–¹çº¦å®šå¥½äº¤äº’æ–¹æ³•ï¼Œç„¶åé€šè¿‡message.bodyä¸­çš„eventå­—æ®µçš„å€¼åŒºåˆ†äº‹ä»¶ï¼Œå½“è¿›å…¥ä¸€ä¸ª H5 é¡µé¢çš„æ—¶å€™å€¼ä¸ºpageï¼ŒH5 é¡µé¢æ¶ˆå¤±æ—¶å€¼ä¸ºunpageï¼Œç”±æ­¤æˆ‘ä»¬åœ¨è¿™ä¸¤ä¸ªæ—¶æœºè§¦å‘åŸ‹ç‚¹é‡‡é›†ã€‚ H5 é¡µé¢è¿›å…¥è§¦å‘$PageLoadäº‹ä»¶ï¼ˆä¸æ‰“å¼€åŸç”Ÿé¡µé¢äº‹ä»¶ä¿æŒä¸€è‡´ï¼‰ï¼Œä¸ŠæŠ¥æŠ¥æ–‡ï¼š 12345678910111213141516{&quot;$xa_className&quot; : &quot;XWWKWebViewController&quot;,&quot;$xa_isLogin&quot; : &quot;true&quot;,&quot;$userMobile&quot; : &quot;c46f73828bda53dfae9b084d807fae66&quot;,&quot;$event&quot; : &quot;$PageLoad&quot;,&quot;$pageTitle&quot; : &quot;segmentio project&quot;,&quot;$isFirstDay&quot; : &quot;false&quot;,&quot;$lastPageTitle&quot; : &quot;&quot;,&quot;$pageUrl&quot; : &quot;http://m.sd.10086.cn/fe_service/xwcode/index.html&quot;,&quot;$xa_fromClassName&quot; : &quot;XWWKWebViewController&quot;,&quot;$xa_screenName&quot; : &quot;segmentio project&quot;,&quot;$xa_orientation&quot; : &quot;V&quot;,&quot;$clientFormatTime&quot; : &quot;2021-05-08 14:36:45 042&quot;,&quot;$pageReferrer&quot; : &quot;&quot;,&quot;$clientLongTime&quot; : &quot;1620455805041.908&quot;,} H5 é¡µé¢ç¦»å¼€æ—¶è§¦å‘$PageStayLengthäº‹ä»¶ï¼ˆä¸æ‰“å¼€åŸç”Ÿé¡µé¢äº‹ä»¶ä¿æŒä¸€è‡´ï¼‰ï¼Œä¸ŠæŠ¥æŠ¥æ–‡ï¼š 123456789101112131415161718{&quot;$xa_className&quot; : &quot;XWWKWebViewController&quot;,&quot;$xa_isLogin&quot; : &quot;true&quot;,&quot;$userMobile&quot; : &quot;c46f73828bda53dfae9b084d807fae66&quot;,&quot;$event&quot; : &quot;$PageStayLength&quot;,&quot;$pageTitle&quot; : &quot;segmentio project&quot;,&quot;$isFirstDay&quot; : &quot;false&quot;,&quot;$xa_nativeDuration&quot; : &quot;&quot;,&quot;$lastPageTitle&quot; : &quot;segmentio project&quot;,&quot;$pageUrl&quot; : &quot;http://m.sd.10086.cn/fe_service/xwcode/index.html&quot;,&quot;$xa_fromClassName&quot; : &quot;XWWKWebViewController&quot;,&quot;$pageDuration&quot; : &quot;122.4269866943359&quot;,&quot;$xa_screenName&quot; : &quot;segmentio project&quot;,&quot;$xa_orientation&quot; : &quot;V&quot;,&quot;$clientFormatTime&quot; : &quot;2021-05-08 14:36:45 166&quot;,&quot;$pageReferrer&quot; : &quot;http://m.sd.10086.cn/fe_service/xwcode/index.html&quot;,&quot;$clientLongTime&quot; : &quot;1620455805166.079&quot;,} å…¶ä¸­ï¼š $lastPageTitleæ˜¯ä¸Šä¸€ä¸ª H5 é¡µé¢çš„æ ‡é¢˜ $pageReferreræ˜¯ä¸Šä¸€ä¸ª H5 é¡µé¢çš„ URL $pageUrlæ˜¯å½“å‰ H5 é¡µé¢çš„ URL $pageTitleæ˜¯å½“å‰ H5 é¡µé¢çš„æ ‡é¢˜ $pageDurationè®°å½•äº†å½“å‰ H5 é¡µé¢çš„é©»ç•™æ—¶é•¿ 6.5 ä»£ç åŸ‹ç‚¹6.5.1 ç”¨æˆ·ç™»å½•å½“ç”¨æˆ·æ³¨å†ŒæˆåŠŸæˆ–è€…è¿›è¡Œç™»å½•æ—¶ï¼Œéœ€è¦è°ƒç”¨SDK çš„ + loginWithUserId: 1[XWSdRuster loginWithUserId:@&quot;UserID&quot;]; 6.5.2 ç”¨æˆ·æ³¨é”€å½“ç”¨æˆ·é€€å‡ºç™»å½•æ—¶ï¼Œéœ€è¦è°ƒç”¨ SDK çš„+logoutæ¥å£ï¼š 1[XWSdRuster logout]; æ­¤æ–¹æ³•ä¸ä¼šä¸Šä¼ ä»»ä½•ä¿¡æ¯ï¼Œåªæ˜¯æŠ¹é™¤æœ¬åœ°çš„ä¸€äº›æš‚å­˜ä¿¡æ¯ã€‚ 6.5.3 é…ç½®ç”¨æˆ·ç»„å½“ç”¨æˆ·ç™»å½•åï¼Œå¯ä»¥è°ƒç”¨ SDK çš„+loginWithGroupId:æ¥å£ï¼Œå°†è¯¥ç”¨æˆ·çº³å…¥æŸä¸ªç»„å†…ï¼Œä»¥å…³è”ç”¨æˆ·å…³ç³»ï¼š 1[XWSdRuster loginWithGroupId:@&quot;GroupID&quot;]; 6.5.4 ç‚¹å‡»äº‹ä»¶æ’ç ä¸Šä¼ å¿…è¦çš„ç‚¹å‡»äº‹ä»¶ã€‚ 1234/// ç‚¹å‡»æ’ç /// @param eventName äº‹ä»¶å/// @param properties æ‰©å±•å±æ€§+ (void)touchWithEventName:(NSString *_Nullable)eventName properties:(NSDictionary *_Nonnull)properties; 6.5.5 æ›å…‰äº‹ä»¶æ’ç æŸé¡µé¢æ˜¯å¦æ›å…‰ç»™ç”¨æˆ·æ—¶ï¼Œå¯ä»¥ç”¨æ¥ä¸Šä¼ ç›¸å…³çš„ä¿¡æ¯ã€‚ 12345/** æ›å…‰æ’ç  eventä¸º customExposure @param properties æ‰©å±•å±æ€§ */+ (void)exposureEventWithProperties:(NSDictionary *_Nullable)properties; 6.5.6 ä¸Šä¼ ç”¨æˆ·ä¿¡æ¯ä¸Šä¼ ç™»å½•ç”¨æˆ·çš„ä¸ªäººä¿¡æ¯ï¼Œå†…å®¹è‡ªå®šä¹‰ã€‚ 123456/** ä¸Šä¼ è‡ªå®šä¹‰ç”¨æˆ·ä¿¡æ¯ @param properties ç”¨æˆ·ä¿¡æ¯ */+ (void)userEvent:(NSDictionary *_Nonnull)properties; 6.5.7 é”™è¯¯ä¸ŠæŠ¥H5 å†…å’ŒåŸç”Ÿä¸­å‡ºç°çš„é”™è¯¯éƒ½å¯ä»¥é€šè¿‡æ­¤æ–¹æ³•ä¸ŠæŠ¥ 123456/// H5 å’Œ åŸç”Ÿé”™è¯¯ä¸ŠæŠ¥/// @param errorType é”™è¯¯ç±»å‹:JSæŠ¥é”™ã€JSåŠ è½½å¤±è´¥ã€å›¾ç‰‡åŠ è½½å¤±è´¥ã€APIè®¿é—®é”™è¯¯ã€APIè®¿é—®å¤±è´¥ã€H5é¡µé¢åŠ è½½å¤±è´¥ã€H5é¡µé¢æŠ¥é”™/// @param path è·¯å¾„(å›¾ç‰‡æ—¶ä¸ºURL)/// @param line é”™è¯¯è¡Œå·ï¼ˆç”¨äºjsï¼‰/// @param message å¤±è´¥åŸå› ï¼Œå †æ ˆé”™è¯¯ä¿¡æ¯+ (void)errorEventType:(NSString *_Nullable)errorType path:(NSString *_Nullable)path line:(NSString *_Nullable)line message:(NSString *_Nullable)message; 6.5.8 ä¸Šä¼ ç”¨æˆ·ä½ç½®å°†è·å–åˆ°çš„ç”¨æˆ·ä½ç½®ä¿¡æ¯ä¸Šä¼ ï¼Œç»çº¬åº¦å¿…ä¼ ï¼Œå…¶ä¸­ä¸Šä¼ çš„å­—æ®µéƒ½ä¼šè¢«åŠ å¯†ã€‚ 12345678/** ä¸Šä¼ å®šä½ä¿¡æ¯ @param latitude çº¬åº¦ @param longitude ç»åº¦ @param otherInfo æ‰©å±•å±æ€§ privence city area address */+ (void)locateWithLongitude:(NSString *_Nonnull)longitude latitude:(NSString *_Nonnull)latitude otherInfo:(XWTrackLocation *_Nullable)otherInfo; 6.5.9 å®Œå…¨è‡ªå®šä¹‰æ’ç å¯ä»¥è‡ªå®šä¹‰äº‹ä»¶åï¼Œäº‹ä»¶å±æ€§ï¼Œç”šè‡³å¯ä»¥å¯¹sdkåšäºŒæ¬¡å°è£…æ‰©å±•ï¼Œé…åˆåå°å‘æŒ¥æ›´å¤§çš„ä½œç”¨ã€‚ä¸è¦å¿˜äº†ï¼Œå±æ€§ä¼šè¢«è‡ªåŠ¨æ·»åŠ å‰ç¼€ã€‚ 1234567/** å®Œå…¨è‡ªç”±çš„è‡ªå®šä¹‰äº‹ä»¶ @param event äº‹ä»¶ @param properties é¢å¤–å‚æ•° */+ (void)fullyCustomTrack:(NSString * _Nonnull)event properties:(NSDictionary * _Nullable)properties; 6.5.10 å‘é€é˜Ÿåˆ—æ¶ˆæ¯å¦‚æœé˜Ÿåˆ—ä¸­æœ‰æš‚å­˜çš„æ¶ˆæ¯ä½“ï¼Œç«‹å³å‘é€ã€‚ 1234/** ç«‹å³ä¸ŠæŠ¥æ‰€æœ‰çš„æ’ç  */+ (void)flush; 6.6 åŠ å¯†éƒ¨åˆ†App è°ƒç”¨-loginWithUserId:æ–¹æ³•æ—¶ä¼ å…¥çš„æ˜æ–‡æ‰‹æœºå·å’Œè°ƒç”¨-locateWithLongitude:latitude:otherInfo:ä¼ å…¥çš„ä½ç½®ä¿¡æ¯éƒ½ä¼šè¢« SDK è¿›è¡ŒåŠ å¯†åå†ä¸ŠæŠ¥ã€‚ ä½¿ç”¨ AES å¯¹ç§°åŠ å¯†ï¼Œç›¸å…³é…ç½®ï¼š å¯†é’¥é•¿åº¦ï¼š128 åŠ å¯†æ¨¡å¼ï¼šCBC å¡«å……æ–¹å¼ï¼šPKCS7Padding åˆå§‹å‘é‡ï¼š16-Bytesâ€“String åŠ å¯† keyï¼šé»˜è®¤ä¸º***ï¼Œå¯é€šè¿‡XWConfigOptionsç±»è¿›è¡Œæ§åˆ¶ï¼š 12/// é»˜è®¤ä¸º ***@property (nonatomic, copy) NSString * _Nullable words;","link":"/2021/04/08/iOS%C2%B7%E7%BB%9F%E8%AE%A1/%E5%9F%8B%E7%82%B9%20SDK%20%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/"},{"title":"06-åŠ¨æ€æ–¹æ³•è§£æå’Œæ¶ˆæ¯è½¬å‘æœºåˆ¶","text":"å‰è¨€OCä¸­æ–¹æ³•çš„è°ƒç”¨æ˜¯é€šè¿‡objc_msgSendï¼ˆæˆ–objc_msgSendSuperï¼Œæˆ–objc_msgSend_stretï¼Œæˆ–objc_msgSendSuper_stretï¼‰å‡½æ•°ï¼Œå‘è°ƒç”¨è€…å‘é€åä¸ºSELçš„æ¶ˆæ¯ï¼Œæ‰¾åˆ°å…·ä½“çš„å‡½æ•°åœ°å€IMPï¼Œè¿›è€Œæ‰§è¡Œè¯¥å‡½æ•°ã€‚ æ‰¾IMPæ—¶å…ˆå¿«é€ŸæŸ¥æ‰¾ï¼Œç„¶åæ…¢é€ŸæŸ¥æ‰¾ã€‚å¦‚æœæ…¢é€ŸæŸ¥æ‰¾åæ‰¾ä¸åˆ°IMPï¼Œä¼šè¿›è¡Œæ–¹æ³•çš„è§£æï¼Œè¿™ç›¸å½“äºæä¾›ä¸€æ¬¡å®¹é”™å¤„ç†ï¼›æ–¹æ³•è§£æä¹‹åï¼Œå¦‚æœä¾ç„¶æ‰¾ä¸åˆ°IMPï¼Œè¿˜æœ‰æœ€åä¸€æ¬¡æœºä¼šï¼Œé‚£å°±æ˜¯æ¶ˆæ¯çš„è½¬å‘ã€‚ æˆ‘ç”¨çš„æºç æ˜¯ objc4-756.2 ä¸€ã€æ¶ˆæ¯æŸ¥æ‰¾æµç¨‹æ¶ˆæ¯æŸ¥æ‰¾æµç¨‹éƒ¨åˆ†ä¸å†å±•å¼€è¯¦è¿°ï¼Œæ¶ˆæ¯æ…¢é€ŸæŸ¥æ‰¾ä¸»è¦ç»è¿‡ä»¥ä¸‹æµç¨‹ï¼š å…ˆæŸ¥æ‰¾æœ¬ç±»ç¼“å­˜ï¼Œå†æ‰¾æœ¬ç±»æ–¹æ³•åˆ—è¡¨ éå†çˆ¶ç±»ï¼šæŸ¥æ‰¾çˆ¶ç±»ç¼“å­˜ï¼Œå†æ‰¾çˆ¶ç±»æ–¹æ³•åˆ—è¡¨ éå†çˆ¶ç±»æ— æœåå°±æ¥åˆ°åŠ¨æ€æ–¹æ³•è§£æã€‚ äºŒã€åŠ¨æ€æ–¹æ³•è§£æåŠ¨æ€æ–¹æ³•è§£æï¼Œå³method resolverï¼ˆåˆåæ¶ˆæ¯çš„è§£æï¼Œä¹Ÿå«æ–¹æ³•å†³è®®ï¼‰ï¼Œæ–¹æ³•æŸ¥æ‰¾å¤±è´¥ä¹‹åå°±ä¼šè¿›è¡Œï¼Œæºç å¦‚ä¸‹ï¼š 12345678910// åœ¨ã€ç±»...æ ¹ç±»ã€‘çš„ã€ç¼“å­˜+æ–¹æ³•åˆ—è¡¨ã€‘ä¸­éƒ½æ²¡æ‰¾åˆ°IMPï¼Œè¿›è¡Œæ–¹æ³•è§£æif (resolver &amp;&amp; !triedResolver) { runtimeLock.unlock(); resolveMethod(cls, sel, inst); // âœ… runtimeLock.lock(); // Don't cache the result; we don't hold the lock so it may have // changed already. Re-do the search from scratch instead. triedResolver = YES; goto retry;} å®ƒä¸»è¦æ˜¯è°ƒç”¨äº†resolveMethodå‡½æ•°ã€‚resolveMethodå‡½æ•°å¤„ç†å®Œæ¯•ä¹‹åï¼Œè¿˜è¦é‡æ–°æ‰§è¡Œä¸€æ¬¡retryï¼ˆå†èµ°ä¸€éæ–¹æ³•çš„æŸ¥æ‰¾æµç¨‹ï¼‰ã€‚å…¶ä¸­ï¼ŒtriedResolverè¿™ä¸ªå˜é‡ä½¿å¾—æ¶ˆæ¯çš„è§£æåªè¿›è¡Œä¸€æ¬¡ã€‚ 2.1 resolveMethod å…¥å£æºç ï¼š 1234567891011121314151617181920212223static void resolveMethod(Class cls, SEL sel, id inst){ runtimeLock.assertUnlocked(); assert(cls-&gt;isRealized()); // åˆ¤æ–­å½“å‰æ˜¯å¦æ˜¯å…ƒç±» if (! cls-&gt;isMetaClass()) { // ç±»ï¼Œå°è¯•æ‰¾å®ä¾‹æ–¹æ³• // try [cls resolveInstanceMethod:sel] resolveInstanceMethod(cls, sel, inst); } else { // æ˜¯å…ƒç±»ï¼Œå…ˆæ‰¾ç±»æ–¹æ³• // try [nonMetaClass resolveClassMethod:sel] // and [cls resolveInstanceMethod:sel] resolveClassMethod(cls, sel, inst); if (!lookUpImpOrNil(cls, sel, inst, NO/*initialize*/, YES/*cache*/, NO/*resolver*/)) { resolveInstanceMethod(cls, sel, inst); } }} è¿™é‡Œæœ‰ä¸¤ä¸ªåˆ†æ”¯ï¼š éå…ƒç±»çš„è¯è¯´æ˜æ˜¯ç±»ï¼Œè°ƒç”¨å®ä¾‹æ–¹æ³•ï¼Œèµ°_class_resolveInstanceMethod clsæ˜¯å…ƒç±»çš„è¯è¯´æ˜è°ƒç”¨ç±»æ–¹æ³•ï¼Œèµ°_class_resolveClassMethod 2.2 å®ä¾‹æ–¹æ³•è§£æresolveInstanceMethodæºç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445static void resolveInstanceMethod(Class cls, SEL sel, id inst){ runtimeLock.assertUnlocked(); assert(cls-&gt;isRealized()); // å» cls æ‰¾æ˜¯å¦å®ç°äº† resolveInstanceMethod æ–¹æ³• // å¦‚æœæ²¡æœ‰å®ç°ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œå°±ä¸ä¼šç»™ cls å‘é€ resolveInstanceMethod æ¶ˆæ¯ï¼Œå°±ä¸ä¼šæŠ¥æ‰¾ä¸åˆ° resolveInstanceMethod if (! lookUpImpOrNil(cls-&gt;ISA(), SEL_resolveInstanceMethod, cls, NO/*initialize*/, YES/*cache*/, NO/*resolver*/)) { // Resolver not implemented. // NSObjectä¸­é»˜è®¤æœ‰å®ç°ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸ä¼šèµ°è¿™é‡Œã€‚ return; } // æœ¬ç±»å®ç°äº†ç±»æ–¹æ³• resolveInstanceMethod // å½“å¯¹è±¡æ‰¾ä¸åˆ°éœ€è¦è°ƒç”¨çš„æ–¹æ³•æ—¶ï¼Œç³»ç»Ÿå°±ä¼šä¸»åŠ¨å“åº” resolveInstanceMethod æ–¹æ³•ï¼Œå¯ä»¥åœ¨ resolveInstanceMethod è¿›è¡Œè‡ªå®šä¹‰å¤„ç† // å‘æœ¬ç±»å‘é€SEL_resolveInstanceMethodæ¶ˆæ¯ï¼Œå³è°ƒç”¨è¿™ä¸ªæ–¹æ³• BOOL (*msg)(Class, SEL, SEL) = (typeof(msg))objc_msgSend; bool resolved = msg(cls, SEL_resolveInstanceMethod, sel); // Cache the result (good or bad) so the resolver doesn't fire next time. // +resolveInstanceMethod adds to self a.k.a. cls // å†æ¬¡å»æŸ¥æ‰¾æ–¹æ³•ï¼Œæ‰¾åˆ°å°±ç¼“å­˜å¹¶ä¸”è¿”å›ï¼Œæ‰¾ä¸åˆ°å°±ç›´æ¥è¿”å› IMP imp = lookUpImpOrNil(cls, sel, inst, NO/*initialize*/, YES/*cache*/, NO/*resolver*/); // ä¸€äº›æŠ¥é”™ä¿¡æ¯ä»£ç  if (resolved &amp;&amp; PrintResolving) { if (imp) { _objc_inform(&quot;RESOLVE: method %c[%s %s] &quot; &quot;dynamically resolved to %p&quot;, cls-&gt;isMetaClass() ? '+' : '-', cls-&gt;nameForLogging(), sel_getName(sel), imp); } else { // Method resolver didn't add anything? _objc_inform(&quot;RESOLVE: +[%s resolveInstanceMethod:%s] returned YES&quot; &quot;, but no new implementation of %c[%s %s] was found&quot;, cls-&gt;nameForLogging(), sel_getName(sel), cls-&gt;isMetaClass() ? '+' : '-', cls-&gt;nameForLogging(), sel_getName(sel)); } }} æµç¨‹åˆ†æï¼š â‘ è°ƒç”¨lookUpImpOrNilæ–¹æ³•æ£€æŸ¥clsä¸­æ˜¯å¦æœ‰SEL_resolveInstanceMethod(resolveInstanceMethod)æ–¹æ³•ã€‚NSObjectç±»ä¸­æœ‰å®ç°è¿™ä¸ªç±»æ–¹æ³•ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¼šæ¥ç€å¾€ä¸‹èµ°ã€‚ lookUpImpOrNilå‡½æ•°æºç ï¼š 1234567IMP lookUpImpOrNil(Class cls, SEL sel, id inst, bool initialize, bool cache, bool resolver){ IMP imp = lookUpImpOrForward(cls, sel, inst, initialize, cache, resolver); if (imp == _objc_msgForward_impcache) return nil; else return imp;} NSObjectç±»ä¸­å®ç°äº†resolveInstanceMethodæ–¹æ³•ï¼š 12345678// å…·ä½“æœç´¢ NSObject.mm+ (BOOL)resolveClassMethod:(SEL)sel { return NO;}+ (BOOL)resolveInstanceMethod:(SEL)sel { return NO;} â‘¡å‘æœ¬ç±»å‘é€SEL_resolveInstanceMethodæ¶ˆæ¯ï¼Œå³è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚resolveInstanceMethod æ˜¯ç³»ç»Ÿç»™æˆ‘ä»¬çš„ä¸€æ¬¡æœºä¼šï¼Œè®©æˆ‘ä»¬å¯ä»¥é’ˆå¯¹æ²¡æœ‰å®ç°çš„ sel è¿›è¡Œè‡ªå®šä¹‰æ“ä½œã€‚ â‘¢lookUpImpOrNilå†æ¬¡æŸ¥æ‰¾å½“å‰å®ä¾‹æ–¹æ³•IMPï¼Œæ‰¾åˆ°å°±ç¼“å­˜å¹¶è¿”å›ï¼Œæ‰¾ä¸åˆ°å°±ç›´æ¥è¿”å›ã€‚ å‡å¦‚ä½ åœ¨+(BOOL)resolveInstanceMethod:(SEL)selä¸­æ·»åŠ äº†selçš„å‡½æ•°åœ°å€IMPï¼Œæ­¤æ—¶å†æ¬¡å»æŸ¥æ‰¾è¿™ä¸ªIMPå°±èƒ½æ‰¾åˆ°ã€‚ æ³¨æ„åˆ°ä¸¤æ¬¡è°ƒç”¨lookUpImpOrNilä¸­ï¼Œresolveréƒ½æ˜¯NOï¼Œå› æ­¤åœ¨å…¶è°ƒç”¨lookUpImpOrForwardæ—¶ä¸ä¼šè§¦å‘ åŠ¨æ€æ–¹æ³•è§£æï¼Œä»…ä»…æ˜¯ä»â€œç±»ã€çˆ¶ç±»ã€â€¦ã€æ ¹ç±»â€çš„ç¼“å­˜ä¸­å’Œæ–¹æ³•åˆ—è¡¨ä¸­æ‰¾IMPã€‚ â‘£ç»“æŸåŠ¨æ€æ–¹æ³•è§£æï¼Œå›åˆ°lookUpImpOrForwardæ–¹æ³•å°†triedResolverç½®YESå¹¶goto retryé‡æ–°æŸ¥æ‰¾ç¼“å­˜å’Œæ–¹æ³•åˆ—è¡¨ å®ä¾‹æ–¹æ³•è§£ææµç¨‹å›¾ï¼š 2.3 ç±»æ–¹æ³•è§£æresolveClassMethod å’Œ resolveInstanceMethod é€»è¾‘å·®ä¸å¤šï¼Œåªä¸è¿‡ç±»æ–¹æ³•æ˜¯å»å…ƒç±»é‡Œå¤„ç†ï¼Œæºç ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556// è¿™é‡Œçš„clsæ˜¯å…ƒç±»ï¼Œå› ä¸ºç±»æ–¹æ³•å­˜å‚¨åœ¨å…ƒç±»static void resolveClassMethod(Class cls, SEL sel, id inst){ runtimeLock.assertUnlocked(); assert(cls-&gt;isRealized()); assert(cls-&gt;isMetaClass()); if (! lookUpImpOrNil(cls, SEL_resolveClassMethod, inst, NO/*initialize*/, YES/*cache*/, NO/*resolver*/)) { // Resolver not implemented. // å¦‚æœä½ æ²¡æœ‰å®ç°ç±»æ–¹æ³• +(BOOL)resolveClassMethod:(SEL)selï¼Œ // NSObjectä¸­ä¹Ÿæœ‰å®ç°ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸ä¼šèµ°è¿™é‡Œ // æ³¨æ„è¿™é‡Œçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯clsï¼Œæ˜¯å…ƒç±» return; } Class nonmeta; { mutex_locker_t lock(runtimeLock); // è·å– å…ƒç±»çš„å¯¹è±¡ï¼Œå³ç±»ã€‚ nonmeta = getMaybeUnrealizedNonMetaClass(cls, inst); // +initialize path should have realized nonmeta already if (!nonmeta-&gt;isRealized()) { _objc_fatal(&quot;nonmeta class %s (%p) unexpectedly not realized&quot;, nonmeta-&gt;nameForLogging(), nonmeta); } } BOOL (*msg)(Class, SEL, SEL) = (typeof(msg))objc_msgSend; // è°ƒç”¨ç±»æ–¹æ³•ï¼š +(BOOL)resolveClassMethod:(SEL)sel bool resolved = msg(nonmeta, SEL_resolveClassMethod, sel); // Cache the result (good or bad) so the resolver doesn't fire next time. // +resolveClassMethod adds to self-&gt;ISA() a.k.a. cls // å†æ‰¾ä¸€æ¬¡imp IMP imp = lookUpImpOrNil(cls, sel, inst, NO/*initialize*/, YES/*cache*/, NO/*resolver*/); // ä¸€äº›æ‰“å° if (resolved &amp;&amp; PrintResolving) { if (imp) { _objc_inform(&quot;RESOLVE: method %c[%s %s] &quot; &quot;dynamically resolved to %p&quot;, cls-&gt;isMetaClass() ? '+' : '-', cls-&gt;nameForLogging(), sel_getName(sel), imp); } else { // Method resolver didn't add anything? _objc_inform(&quot;RESOLVE: +[%s resolveClassMethod:%s] returned YES&quot; &quot;, but no new implementation of %c[%s %s] was found&quot;, cls-&gt;nameForLogging(), sel_getName(sel), cls-&gt;isMetaClass() ? '+' : '-', cls-&gt;nameForLogging(), sel_getName(sel)); } }} æµç¨‹å¦‚ä¸‹ï¼š â‘ lookUpImpOrNilæŸ¥æ‰¾SEL_resolveClassMethod(resolveClassMethod)æ˜¯å¦å®ç° â‘¡è°ƒç”¨ç±»æ–¹æ³•ï¼š +(BOOL)resolveClassMethod:(SEL)sel â‘¢lookUpImpOrNilå†æ¬¡æŸ¥æ‰¾å½“å‰å®ä¾‹æ–¹æ³•impï¼Œæ‰¾åˆ°å°±å¡«å……ç¼“å­˜å¹¶è¿”å›ï¼Œæ‰¾ä¸åˆ°å°±ç›´æ¥è¿”å› â‘£ç»“æŸresolveClassMethodï¼Œè¿”å›åˆ°resolveMethodæ–¹æ³•ã€‚æ­¤æ—¶lookUpImpOrNilå†æ¬¡æŸ¥æ‰¾selçš„impï¼Œè‹¥æœ‰impåˆ™é€€å‡ºåŠ¨æ€æ–¹æ³•è§£æï¼Œè‹¥æ— åˆ™è¿›å…¥_class_resolveInstanceMethodå¼€å§‹å®ä¾‹æ–¹æ³•è§£æï¼Œè·Ÿä¹‹å‰çš„æµç¨‹ä¸€æ ·ã€‚ â‘¤ æ£€æŸ¥clsä¸­æ˜¯å¦æœ‰SEL_resolveInstanceMethod(resolveInstanceMethod)æ–¹æ³• â‘¥å‘æœ¬ç±»å‘é€SEL_resolveInstanceMethodæ¶ˆæ¯ â‘¦lookUpImpOrNilå†æ¬¡æŸ¥æ‰¾å½“å‰å®ä¾‹æ–¹æ³•IMPï¼Œæ‰¾åˆ°å°±ç¼“å­˜å¹¶è¿”å›ï¼Œæ‰¾ä¸åˆ°å°±ç›´æ¥è¿”å›ã€‚ â‘§ç»“æŸåŠ¨æ€æ–¹æ³•è§£æï¼Œå›åˆ°lookUpImpOrForwardæ–¹æ³•å°†triedResolverç½®å¦å¹¶goto retryé‡æ–°æŸ¥æ‰¾ç¼“å­˜å’Œæ–¹æ³•åˆ—è¡¨ ç±»æ–¹æ³•è§£ææµç¨‹å›¾ï¼š 2.4 åŠ¨æ€æ–¹æ³•å†³è®®resolveMethodä¸­è¿›è¡Œç±»æ–¹æ³•è§£æä¹‹åè¿˜è¦åœ¨è¿›è¡Œä¸€æ¬¡å®ä¾‹æ–¹æ³•è§£æï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ 123456789101112131415161718192021222324static void resolveMethod(Class cls, SEL sel, id inst){ runtimeLock.assertUnlocked(); assert(cls-&gt;isRealized()); // åˆ¤æ–­å½“å‰æ˜¯å¦æ˜¯å…ƒç±» if (! cls-&gt;isMetaClass()) { // ç±»ï¼Œå°è¯•æ‰¾å®ä¾‹æ–¹æ³• // try [cls resolveInstanceMethod:sel] resolveInstanceMethod(cls, sel, inst); } else { // æ˜¯å…ƒç±»ï¼Œå…ˆæ‰¾ç±»æ–¹æ³• // try [nonMetaClass resolveClassMethod:sel] // and [cls resolveInstanceMethod:sel] resolveClassMethod(cls, sel, inst); if (!lookUpImpOrNil(cls, sel, inst, NO/*initialize*/, YES/*cache*/, NO/*resolver*/)) { // âœ…ä¸ºä»€ä¹ˆè¿™é‡Œè¿˜è¦æŸ¥æ‰¾ä¸€æ¬¡å‘¢ï¼Ÿ resolveInstanceMethod(cls, sel, inst); } }} æ—¢ç„¶ä¸Šé¢çš„å¯¹è±¡æ–¹æ³•å†³è®®å’Œç±»æ–¹æ³•è§£æéƒ½ä¼šèµ° _class_resolveInstanceMethodï¼Œè€Œæœ€ç»ˆéƒ½ä¼šæ‰¾åˆ°çˆ¶ç±» NSObjecté‡Œé¢å»ï¼Œé‚£æˆ‘ä»¬ä¸å°±å¯ä»¥åœ¨ NSObject åˆ†ç±»é‡Œé¢é‡å†™ resolveInstanceMethod æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢å¯¹æ²¡æœ‰å®ç°çš„æ–¹æ³•(ä¸ç®¡æ˜¯ç±»æ–¹æ³•è¿˜æ˜¯å¯¹è±¡æ–¹æ³•)è¿›è¡ŒåŠ¨æ€æ·»åŠ  impï¼Œç„¶åå°±å¯ä»¥è¿›è¡Œè‡ªå®šä¹‰å¤„ç†ï¼Œæ¯”å¦‚å¼¹ä¸ªæ¡†è¯´ç½‘ç»œä¸ä½³ï¼Œæˆ–è€…åšbugæ”¶é›†ç­‰ã€‚ è¿™å…¶å®å°±æ˜¯Objective-Cæä¾›äº†ä¸€ç§åä¸ºåŠ¨æ€æ–¹æ³•å†³è®®çš„æ‰‹æ®µï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€åœ°ä¸ºä¸€ä¸ªselector æä¾›å®ç°ã€‚ ä¸¾ä¸ªä¾‹å­çœ‹çœ‹ï¼š 12345678910@interface Person : NSObject+ (void)personClassMethod1;- (void)personInstanceMethod1;@end@implementation Person@end ä¸€ä¸ªç®€å•çš„Personç±»ï¼Œé‡Œé¢åˆ†åˆ«æœ‰ä¸€ä¸ªç±»æ–¹æ³•å’Œä¸€ä¸ªå®ä¾‹æ–¹æ³•ï¼Œä½†æ˜¯éƒ½æ²¡æœ‰å®ç°ã€‚ æ¥ç€æ·»åŠ å¯¹è¿™ä¸¤ä¸ªæ–¹æ³•çš„è§£æï¼š 12345678910111213141516171819202122232425- (void)unimplementedMethod:(SEL)sel { NSLog(@&quot;æ²¡å®ç°ï¼Ÿæ²¡å…³ç³»ï¼Œç»ä¸å´©æºƒ&quot;);}+ (BOOL)resolveInstanceMethod:(SEL)sel { NSLog(@&quot;åŠ¨æ€å®ä¾‹æ–¹æ³•è§£æï¼š%@&quot;, NSStringFromSelector(sel)); if (sel == @selector(personInstanceMethod1)) { IMP methodIMP = class_getMethodImplementation(self, @selector(unimplementedMethod:)); Method method = class_getInstanceMethod(Person.class, @selector(unimplementedMethod:)); const char *methodType = method_getTypeEncoding(method); return class_addMethod(Person.class, sel, methodIMP, methodType); } return [super resolveInstanceMethod:sel];}+ (BOOL)resolveClassMethod:(SEL)sel { NSLog(@&quot;åŠ¨æ€ç±»æ–¹æ³•è§£æï¼š%@&quot;, NSStringFromSelector(sel)); if (sel == @selector(personClassMethod1)) { IMP methodIMP = class_getMethodImplementation(self, @selector(unimplementedMethod:)); Method method = class_getInstanceMethod(Person.class, @selector(unimplementedMethod:)); const char *methodType = method_getTypeEncoding(method); return class_addMethod(objc_getMetaClass(&quot;Person&quot;), sel, methodIMP, methodType); } return [super resolveClassMethod:sel];} è°ƒç”¨å¹¶æ‰“å°ï¼š åŠ¨æ€æ–¹æ³•å†³è®®æ€»ç»“ï¼š å®ä¾‹æ–¹æ³•å¯ä»¥é‡å†™resolveInstanceMethodæ·»åŠ imp ç±»æ–¹æ³•å¯ä»¥åœ¨æœ¬ç±»é‡å†™resolveClassMethodå¾€å…ƒç±»æ·»åŠ impï¼Œæˆ–è€…åœ¨NSObjectåˆ†ç±»é‡å†™resolveInstanceMethodæ·»åŠ imp åŠ¨æ€æ–¹æ³•è§£æåªè¦åœ¨ä»»æ„ä¸€æ­¥lookUpImpOrNilæŸ¥æ‰¾åˆ°impå°±ä¸ä¼šæŸ¥æ‰¾ä¸‹å»â€”â€”å³æœ¬ç±»åšäº†åŠ¨æ€æ–¹æ³•å†³è®®ï¼Œä¸ä¼šèµ°åˆ°NSObjctåˆ†ç±»çš„åŠ¨æ€æ–¹æ³•å†³è®® æ‰€æœ‰æ–¹æ³•éƒ½å¯ä»¥é€šè¿‡åœ¨NSObjectåˆ†ç±»é‡å†™resolveInstanceMethodæ·»åŠ impè§£å†³å´©æºƒ é‚£ä¹ˆæŠŠæ‰€æœ‰å´©æºƒéƒ½åœ¨NSObjctåˆ†ç±»ä¸­å¤„ç†ï¼ŒåŠ ä»¥å‰ç¼€åŒºåˆ†ä¸šåŠ¡é€»è¾‘ï¼Œå²‚ä¸æ˜¯ç¾æ»‹æ»‹ï¼Ÿé”™ï¼ ç»Ÿä¸€å¤„ç†èµ·æ¥è€¦åˆåº¦é«˜ é€»è¾‘åˆ¤æ–­å¤š å¯èƒ½åœ¨NSObjctåˆ†ç±»åŠ¨æ€æ–¹æ³•å†³è®®ä¹‹å‰å·²ç»åšäº†å¤„ç† SDKå°è£…çš„æ—¶å€™éœ€è¦ç»™ä¸€ä¸ªå®¹é”™ç©ºé—´ è¿™ä¹Ÿä¸è¡Œï¼Œé‚£ä¹Ÿä¸è¡Œï¼Œé‚£è¯¥æ€ä¹ˆåŠï¼Ÿæ”¾å¿ƒï¼Œè‹¹æœå·²ç»ç»™æˆ‘ä»¬å‡†å¤‡å¥½åè·¯äº†ï¼ ä¸‰ã€æ¶ˆæ¯è½¬å‘æ–¹æ³•çš„è°ƒç”¨ç»è¿‡äº†æŸ¥æ‰¾ã€è§£æï¼Œå¦‚æœè¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°IMPï¼Œå°±ä¼šæ¥åˆ°æ¶ˆæ¯è½¬å‘æµç¨‹ã€‚å®ƒçš„å…¥å£åœ¨lookUpImpOrForwardå‡½æ•°é åçš„ä½ç½®ï¼š 12345// No implementation found, and method resolver didn't help. // Use forwarding.// å¼€å§‹æ¶ˆæ¯è½¬å‘imp = (IMP)_objc_msgForward_impcache;cache_fill(cls, sel, imp, inst); ç»§ç»­è·Ÿè¿›ï¼Œæ¥åˆ°objc-msg-arm64.sæ–‡ä»¶ä¸­ï¼š __objc_msgForward_impcacheæ–¹æ³•ä¸­è°ƒç”¨__objc_msgForwardï¼Œæœ€åä¼šæ¥åˆ°c++ä¸­_objc_forward_handlerï¼š 123456789void *_objc_forward_handler = (void*)objc_defaultForwardHandler;objc_defaultForwardHandler(id self, SEL sel){ _objc_fatal(&quot;%c[%s %s]: unrecognized selector sent to instance %p &quot; &quot;(no message forward handler is installed)&quot;, class_isMetaClass(object_getClass(self)) ? '+' : '-', object_getClassName(self), sel_getName(sel), self);} å½“æˆ‘ä»¬è°ƒç”¨ä¸€ä¸ªæ²¡å®ç°çš„æ–¹æ³•æ—¶ï¼ŒæŠ¥çš„é”™å°±æ˜¯unrecognized selector sent to ... ä½†æ˜¯åˆ°è¿™é‡Œå¹¶æ²¡æœ‰ç»“æŸï¼Œæˆ‘ä»¬åˆ›é€ ä¸€ä¸ªå´©æºƒï¼Œç„¶åçœ‹æ‰“å°ä¿¡æ¯ï¼š å´©æºƒä¹‹å‰åº•å±‚è¿˜è°ƒç”¨äº†___forwarding___å’Œ_CF_forwarding_prep_0ç­‰æ–¹æ³•ï¼Œä½†æ˜¯CoreFoundationåº“ä¸å¼€æºï¼Œåœ¨æ— ä»ä¸‹æ‰‹ä¹‹é™…ï¼Œåªèƒ½æ ¹æ®å‰è¾ˆä»¬çš„ç»éªŒå¼€å§‹ç€æ‰‹â€”â€”ç„¶ååœ¨logMessageSendæ–¹æ³•ä¸­æ‰¾åˆ°äº†æ¢ç´¢æ–¹å‘(lookUpImpOrForward-&gt;log_and_fill_cache-&gt;logMessageSend) é€šè¿‡logMessageSendæ–¹æ³•æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ—¥å¿—ä¼šè®°å½•åœ¨/tmp/msgSendsç›®å½•ä¸‹ï¼Œå¹¶ä¸”é€šè¿‡objcMsgLogEnabledå˜é‡æ¥æ§åˆ¶æ˜¯å¦å­˜å‚¨æ—¥å¿—ï¼š 123456789101112131415161718192021222324252627282930313233343536bool logMessageSend(bool isClassMethod, const char *objectsClass, const char *implementingClass, SEL selector){ char buf[ 1024 ]; // Create/open the log file if (objcMsgLogFD == (-1)) { // æ—¥å¿—ä¼šè®°å½•åœ¨/tmp/msgSendsç›®å½•ä¸‹ snprintf (buf, sizeof(buf), &quot;/tmp/msgSends-%d&quot;, (int) getpid ()); objcMsgLogFD = secure_open (buf, O_WRONLY | O_CREAT, geteuid()); if (objcMsgLogFD &lt; 0) { // no log file - disable logging // é€šè¿‡objcMsgLogEnabledå˜é‡æ¥æ§åˆ¶æ˜¯å¦å­˜å‚¨æ—¥å¿— objcMsgLogEnabled = false; objcMsgLogFD = -1; return true; } } // Make the log entry snprintf(buf, sizeof(buf), &quot;%c %s %s %s\\n&quot;, isClassMethod ? '+' : '-', objectsClass, implementingClass, sel_getName(selector)); objcMsgLogLock.lock(); write (objcMsgLogFD, buf, strlen(buf)); objcMsgLogLock.unlock(); // Tell caller to not cache the method return false;} ç´§æ¥ç€ä»–ä¸‹é¢çš„instrumentObjcMessageSendsæ–¹æ³•å¯ä»¥æ”¹å˜objcMsgLogEnabledçš„å€¼ï¼š 123456789101112131415161718void instrumentObjcMessageSends(BOOL flag){ bool enable = flag; // Shortcut NOP if (objcMsgLogEnabled == enable) return; // If enabling, flush all method caches so we get some traces if (enable) _objc_flush_caches(Nil); // Sync our log file if (objcMsgLogFD != -1) fsync (objcMsgLogFD); objcMsgLogEnabled = enable;} æ‰€ä»¥ï¼Œè™½ç„¶æˆ‘ä»¬åˆ°è¿™é‡Œå°±ä¸èƒ½æŸ¥çœ‹CoreFoundationåº“çš„æºä»£ç äº†ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥æ ¹æ®ä»¥ä¸‹ä»£ç æ¥è®°å½•å¹¶æŸ¥çœ‹å´©æºƒæ—¥å¿—ï¼ˆä»¿ä½›ä¸èƒ½åœ¨æºç å·¥ç¨‹ä¸­æ“ä½œï¼‰ï¼š 1234567891011extern void instrumentObjcMessageSends(BOOL flag);int main(int argc, const char * argv[]) { @autoreleasepool { FXSon *son = [[FXSon alloc] init]; instrumentObjcMessageSends(true); [son doInstanceNoImplementation]; // è°ƒç”¨ä¸€ä¸ªå£°æ˜äº†ä½†æ˜¯æ²¡å®ç°çš„æ–¹æ³• instrumentObjcMessageSends(false); }} å´©æºƒåï¼Œåœ¨è®¿è¾¾ä¸­command+shift+Gå‰å¾€/tmp/msgSendsï¼Œæ‰¾åˆ°æœ€æ–°çš„ä¸€ä»½æ—¥å¿—æ–‡ä»¶ï¼ˆæ•°å­—æœ€å¤§ï¼‰ï¼š æ‰“å¼€æŸ¥çœ‹åå‘ç°ï¼Œåœ¨åŠ¨æ€æ–¹æ³•è§£æå’ŒdoesNotRecognizeSelectorå´©æºƒä¹‹é—´ï¼Œå°±æ˜¯æ¶ˆæ¯è½¬å‘æµç¨‹ï¼Œåˆ†ä¸ºï¼š å¿«é€Ÿè½¬å‘forwardingTargetForSelector æ…¢é€Ÿè½¬å‘methodSignatureForSelector 3.1 æ¶ˆæ¯çš„å¿«é€Ÿè½¬å‘forwardingTargetForSelector:å¯¹åº”çš„å°±æ˜¯æ¶ˆæ¯çš„å¿«é€Ÿè½¬å‘æµç¨‹ï¼Œå®ƒåœ¨æºç ä¸­åªæ˜¯ç®€å•çš„è¿”å›nilï¼ˆå¯åœ¨å­ç±»æˆ–åˆ†ç±»ä¸­é‡å†™ï¼‰ 1234567+ (id)forwardingTargetForSelector:(SEL)sel { return nil;}- (id)forwardingTargetForSelector:(SEL)sel { return nil;} ä¸è¿‡æˆ‘ä»¬å¯ä»¥åœ¨å¼€å‘æ–‡æ¡£ä¸­æ‰¾åˆ°è¯´æ˜ï¼ˆcmd + shift + 0ï¼‰ æ¦‚æ‹¬åœ°è¯´ï¼ŒforwardingTargetForSelector:ä¸»è¦æ˜¯è¿”å›ä¸€ä¸ªæ–°çš„receiverï¼Œå»å¤„ç†selè¿™ä¸ªå½“å‰ç±»æ— æ³•å¤„ç†çš„æ¶ˆæ¯ï¼Œå¦‚æœå¤„ç†ä¸äº†ï¼Œä¼šè½¬åˆ°æ•ˆç‡ä½ä¸‹çš„forwardInvocation:ã€‚ åœ¨æ•ˆç‡æ–¹é¢ï¼ŒforwardingTargetForSelector:é¢†å…ˆforwardInvocation:ä¸€ä¸ªæ•°é‡çº§ï¼Œå› æ­¤ï¼Œæœ€å¥½ä¸è¦ç”¨åè€…çš„æ–¹å¼å¤„ç†æ¶ˆæ¯çš„è½¬å‘é€»è¾‘ã€‚ å…³äºforwardingTargetForSelector:è¿”å›çš„æ–°çš„receiverï¼Œéœ€è¦æ³¨æ„ä¸€ä¸‹å‡ ç‚¹ï¼š ç»å¯¹ä¸èƒ½è¿”å›selfï¼Œå¦åˆ™ä¼šé™·å…¥æ— é™å¾ªç¯ï¼› ä¸å¤„ç†çš„è¯ï¼Œå¯ä»¥è¿”å›nilï¼Œæˆ–è€…[super forwardingTargetForSelector:sel]ï¼ˆéæ ¹ç±»çš„æƒ…å†µï¼‰ï¼Œæ­¤æ—¶ä¼šèµ°methodSignatureForSelector:æ…¢é€Ÿè½¬å‘æµç¨‹ï¼› å¦‚æœæœ‰è¿™ä¸ªreceiverï¼Œæ­¤æ—¶ç›¸å½“äºæ‰§è¡Œobjc_msgSend(newReceiver, sel, ...)ï¼Œé‚£ä¹ˆå®ƒå¿…é¡»æ‹¥æœ‰å’Œè¢«è°ƒç”¨çš„æ–¹æ³•ç›¸åŒæ–¹æ³•ç­¾åçš„æ–¹æ³•ï¼ˆæ–¹æ³•åã€å‚æ•°åˆ—è¡¨ã€è¿”å›å€¼ç±»å‹éƒ½å¿…é¡»ä¸€è‡´ï¼‰ã€‚ ä¸¾ä¾‹è¯´æ˜ï¼š Personç±»ä¸­ï¼š 1234567891011121314151617181920@interface Person : NSObject+ (void)personClassMethod1;- (void)personInstanceMethod1;@end@implementation Person- (id)forwardingTargetForSelector:(SEL)aSelector { NSLog(@&quot;å®ä¾‹æ–¹æ³•å¼€å§‹è½¬å‘&quot;); return [ForwardObject alloc];}+ (id)forwardingTargetForSelector:(SEL)sel { NSLog(@&quot;ç±»æ–¹æ³•å¼€å§‹è½¬å‘&quot;); return [ForwardObject class];}@end ForwardObjectç±»ä¸­ï¼š 123456789101112131415@interface ForwardObject : NSObject@end@implementation ForwardObject+ (void)personClassMethod1 { NSLog(@&quot;ç±»æ–¹æ³•è½¬å‘ç»™%@ï¼Œæ‰§è¡Œ%s&quot;, [self className], __FUNCTION__);}- (void)personInstanceMethod1 { NSLog(@&quot;å®ä¾‹æ–¹æ³•è½¬å‘ç»™%@ï¼Œæ‰§è¡Œ%s&quot;, [self className], __FUNCTION__);}@end æ˜¾ç„¶ï¼ŒForwardObjectä½œä¸ºæ¶ˆæ¯è½¬å‘åçš„å¤„ç†ç±»ï¼Œæ‹¥æœ‰Personç±»çš„åŒåç±»æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•ã€‚ç°åœ¨å¼€å§‹éªŒè¯ï¼Œç»“æœå¦‚ä¸‹ï¼š äº‹å®è¯æ˜ç¡®å®æœ‰æ•ˆï¼æ¥ä¸‹æ¥çœ‹æ¶ˆæ¯çš„æ…¢é€Ÿè½¬å‘æµç¨‹ã€‚ 3.2 æ¶ˆæ¯çš„æ…¢é€Ÿè½¬å‘å¦‚æœforwardingTargetForSelector:æ²¡æœ‰å¤„ç†æ¶ˆæ¯ï¼ˆå¦‚è¿”å›nilï¼‰ï¼Œå°±ä¼šå¯åŠ¨æ…¢é€Ÿè½¬å‘æµç¨‹ï¼Œä¹Ÿå°±æ˜¯methodSignatureForSelector:æ–¹æ³•ï¼ŒåŒæ ·éœ€è¦åœ¨å­ç±»æˆ–åˆ†ç±»ä¸­é‡å†™ 1234567891011// Replaced by CF (returns an NSMethodSignature)+ (NSMethodSignature *)methodSignatureForSelector:(SEL)sel { _objc_fatal(&quot;+[NSObject methodSignatureForSelector:] &quot; &quot;not available without CoreFoundation&quot;);}// Replaced by CF (returns an NSMethodSignature)- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel { _objc_fatal(&quot;-[NSObject methodSignatureForSelector:] &quot; &quot;not available without CoreFoundation&quot;);} é€šè¿‡é˜…è¯»å®˜æ–¹æ–‡æ¡£ï¼Œæˆ‘ä»¬å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š methodSignatureForSelector:æ–¹æ³•æ˜¯è·ŸforwardInvocation:æ–¹æ³•æ­é…ä½¿ç”¨çš„ï¼Œå‰è€…éœ€è¦æˆ‘ä»¬æ ¹æ®selè¿”å›ä¸€ä¸ªæ–¹æ³•ç­¾åï¼Œåè€…ä¼šæŠŠè¿™ä¸ªæ–¹æ³•ç­¾åå°è£…æˆä¸€ä¸ªNSInvocationå¯¹è±¡ï¼Œå¹¶å°†å…¶ä½œä¸ºå½¢å‚ã€‚ å¦‚æœæœ‰ç›®æ ‡å¯¹è±¡èƒ½å¤„ç†Invocationä¸­çš„selï¼ŒInvocationå¯ä»¥æŒ‡æ´¾è¿™ä¸ªå¯¹è±¡å¤„ç†ï¼›å¦åˆ™ä¸å¤„ç†ã€‚ Invocationå¯ä»¥æŒ‡æ´¾å¤šä¸ªå¯¹è±¡å¤„ç† æ³¨æ„ï¼šæ¶ˆæ¯çš„æ…¢é€Ÿè½¬å‘æµç¨‹æ€§èƒ½è¾ƒä½ï¼Œå¦‚æœå¯ä»¥çš„è¯ï¼Œä½ åº”è¯¥å°½å¯èƒ½æ—©åœ°å¤„ç†æ‰æ¶ˆæ¯ï¼ˆå¦‚åœ¨æ–¹æ³•è§£ææ—¶ï¼Œæˆ–åœ¨æ¶ˆæ¯çš„å¿«é€Ÿè½¬å‘æµç¨‹æ—¶ï¼Œé™¤éæœ‰ç‰¹æ®Šéœ€æ±‚ï¼‰ã€‚ ä¸¾ä¾‹è¯´æ˜: è¿™é‡ŒæŠŠå¿«é€Ÿè½¬å‘ä¾‹å­ä¸­çš„Personç±»ä¿®æ”¹ä¸€ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243@implementation Person// MARK: æ…¢é€Ÿè½¬å‘--ç±»æ–¹æ³•+ (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector { NSLog(@&quot;ç±»æ–¹æ³•æ…¢é€Ÿè½¬å‘ï¼š%s, selï¼š%@&quot;, __FUNCTION__, NSStringFromSelector(aSelector)); if (aSelector == @selector(personClassMethod1)) { return [NSMethodSignature signatureWithObjCTypes:&quot;v@:&quot;]; } return [super methodSignatureForSelector:aSelector];}+ (void)forwardInvocation:(NSInvocation *)anInvocation { SEL aSelector = [anInvocation selector]; NSLog(@&quot;ç±»æ–¹æ³•æ…¢é€Ÿè½¬å‘ï¼š%s, selï¼š%@&quot;, __FUNCTION__, NSStringFromSelector(aSelector)); id target = [ForwardObject class]; if ([target respondsToSelector:aSelector]) { [anInvocation invokeWithTarget:target]; } { else [super forwardInvocation:anInvocation]; }}// MARK: æ…¢é€Ÿè½¬å‘--å®ä¾‹æ–¹æ³•- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector { NSLog(@&quot;å®ä¾‹æ–¹æ³•æ…¢é€Ÿè½¬å‘ï¼š%s, selï¼š%@&quot;, __FUNCTION__, NSStringFromSelector(aSelector)); if (aSelector == @selector(personInstanceMethod1)) { return [NSMethodSignature signatureWithObjCTypes:&quot;v@:&quot;]; } return [super methodSignatureForSelector:aSelector];}- (void)forwardInvocation:(NSInvocation *)anInvocation { SEL aSelector = [anInvocation selector]; NSLog(@&quot;å®ä¾‹æ–¹æ³•æ…¢é€Ÿè½¬å‘ï¼š%s, selï¼š%@&quot;, __FUNCTION__, NSStringFromSelector(aSelector)); ForwardObject *obj = [ForwardObject alloc]; if ([obj respondsToSelector:aSelector]) { [anInvocation invokeWithTarget:obj]; } else { [super forwardInvocation:anInvocation]; } }@end ForwardObjectç±»ä¸­ï¼š 123456789101112131415@interface ForwardObject : NSObject@end@implementation ForwardObject+ (void)personClassMethod1 { NSLog(@&quot;ç±»æ–¹æ³•è½¬å‘ç»™%@ï¼Œæ‰§è¡Œ%s&quot;, [self className], __FUNCTION__);}- (void)personInstanceMethod1 { NSLog(@&quot;å®ä¾‹æ–¹æ³•è½¬å‘ç»™%@ï¼Œæ‰§è¡Œ%s&quot;, [self className], __FUNCTION__);}@end å…¶ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ˜¾ç„¶ä¹Ÿæ²¡æœ‰å´©æºƒ: å¯¹æ–¹æ³•ç­¾åç±»å‹ç¼–ç ä¸ç†Ÿæ‚‰çš„å¯ä»¥æŸ¥çœ‹ è‹¹æœå®˜æ–¹çš„ç±»å‹ç¼–ç ä»‹ç» 3.3 æ¶ˆæ¯è½¬å‘çš„åº”ç”¨ - NSProxy3.3.1 æ¨¡æ‹Ÿå®ç°å¤šç»§æ‰¿ã€å­¦ä¹ ä½¿ç”¨ã€‘TestProxyç»§æ‰¿è‡ªNSProxyï¼ŒTestProxy.hæ–‡ä»¶ï¼š 123456789101112#import &lt;Foundation/Foundation.h&gt;NS_ASSUME_NONNULL_BEGIN@interface TestProxy : NSProxy- (instancetype)initWithObject:(id)object;- (void)transformToObject:(id)object;@endNS_ASSUME_NONNULL_END TestProxy.mï¼š 1234567891011121314151617181920212223242526272829303132333435363738#import &quot;TestProxy.h&quot;@interface TestProxy ()// ä¸ºè¿™ä¸ªå¯¹è±¡è½¬å‘æ¶ˆæ¯@property (nonatomic, weak) id object;@end@implementation TestProxy- (instancetype)initWithObject:(id)object { self.object = object; return self;}- (void)transformToObject:(id)object { self.object = object;}// é‡å†™-methodSignatureForSelector:æ–¹æ³•è·å¾—æ–¹æ³•ç­¾å- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel { if (self.object &amp;&amp; [self.object respondsToSelector:sel]) { return [self.object methodSignatureForSelector:sel]; } return [super methodSignatureForSelector:sel];}// é‡å†™-forwardInvocation:ä¸ºè°ƒç”¨è®¾ç½®ç›®æ ‡- (void)forwardInvocation:(NSInvocation *)invocation { SEL sel = [invocation selector]; if (self.object &amp;&amp; [self.object respondsToSelector:sel]) { [invocation invokeWithTarget:self.object]; } else { [super forwardInvocation:invocation]; }}@end ClassAç±»ä¸­æœ‰funcAæ–¹æ³•ï¼ŒClassBç±»ä¸­æœ‰funcBæ–¹æ³•ï¼š 1234567891011121314151617181920212223#import &lt;Foundation/Foundation.h&gt;NS_ASSUME_NONNULL_BEGIN@interface ClassA : NSObject- (void)funcA;@endNS_ASSUME_NONNULL_END #import &quot;ClassA.h&quot;@implementation ClassA- (void)funcA { NSLog(@&quot;è°ƒç”¨äº†funcA*************&quot;);}@end 1234567891011121314151617181920212223#import &lt;Foundation/Foundation.h&gt;NS_ASSUME_NONNULL_BEGIN@interface ClassB : NSObject- (void)funcB;@endNS_ASSUME_NONNULL_END #import &quot;ClassB.h&quot;@implementation ClassB- (void)funcB { NSLog(@&quot;è°ƒç”¨äº†funcB*************&quot;);}@end ä½¿ç”¨ä¸€ä¸‹ï¼š 123456789101112131415- (void)test2 { // å˜ä¸ºclsAçš„ä»£ç†ï¼Œå³proxyæŠŠæ¶ˆæ¯è½¬å‘ç»™äº†clsA ClassA *clsA = [ClassA new];// TestProxy *proxy = [[TestProxy alloc] initWithObject:clsA];// [proxy performSelector:@selector(funcA)]; // å˜ä¸ºclsBçš„ä»£ç†ï¼Œå³proxy1æŠŠæ¶ˆæ¯è½¬å‘ç»™äº†clsB ClassB *clsB = [ClassB new]; TestProxy *proxy1 = [[TestProxy alloc] initWithObject:clsB]; [proxy1 performSelector:@selector(funcB)]; // åˆæŠŠæ¶ˆæ¯è½¬å‘ç»™äº†clsA [proxy1 transformToObject:clsA]; [proxy1 performSelector:@selector(funcA)];} æ‰“å°ï¼š 122021-01-04 17:51:33.533056+0800 Demo[62114:6062041] è°ƒç”¨äº†funcB*************2021-01-04 17:51:33.533094+0800 Demo[62114:6062041] è°ƒç”¨äº†funcA************* ç»“æœï¼š å°±æ˜¯proxy1è¿™ä¸ªå¯¹è±¡æ—¢èƒ½è°ƒç”¨ClassAä¸­çš„æ–¹æ³•ï¼Œåˆèƒ½è°ƒç”¨ClassBä¸­çš„æ–¹æ³•ï¼Œçœ‹èµ·æ¥å°±åƒæ˜¯ç»§æ‰¿è‡ªè¿™ä¸¤ä¸ªç±»ä¸€æ ·ã€‚ ä½†å®é™…ä¸Šproxy1åªæ˜¯æ¶ˆæ¯è½¬å‘çš„ä¸­é—´ç«™ï¼Œå®é™…ä¸Šè¿˜æ˜¯ClassAå’ŒClassBçš„å®ä¾‹å»è°ƒç”¨å„è‡ªçš„æ–¹æ³•ã€‚ 3.3.2 æ‹¦æˆªæ–¹æ³•çš„è°ƒç”¨ï¼Œä»ä¸­å®ç°ä¸€äº›æˆ‘ä»¬è‡ªå·±éœ€è¦çš„åŠŸèƒ½æ¯”å¦‚åŸ‹ç‚¹SDKä¸­éœ€è¦å®ç°çš„UITableViewç‚¹å‡»äº‹ä»¶å…¨åŸ‹ç‚¹ï¼Œå°±å¯ä»¥æŠŠNSProxyç±»ä½œä¸ºUITableViewçš„ä¸­é—´ä»£ç†ï¼Œä»¥å®ç°åœ¨ä¸­é—´æ‹¦æˆªä»£ç†æ–¹æ³•å¹¶åœ¨å…¶ä¸­æ·»åŠ åŸ‹ç‚¹äº‹ä»¶çš„åŠŸèƒ½ã€‚ è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨æ…¢é€Ÿæ¶ˆæ¯è½¬å‘ï¼ŒåŸå› æ˜¯è‹¹æœåœ¨å®˜æ–¹æ–‡æ¡£ä¸­å†™é“ï¼š 12DiscussionThis method is used in the implementation of protocols. This method is also used in situations where an NSInvocation object must be created, such as during message forwarding. If your object maintains a delegate or is capable of handling messages that it does not directly implement, you should override this method to return an appropriate method signature. 1è¯¥æ–¹æ³•ç”¨äºåè®®çš„å®ç°ã€‚åœ¨å¿…é¡»åˆ›å»ºNSInvocationå¯¹è±¡çš„æƒ…å†µä¸‹ï¼Œä¾‹å¦‚åœ¨æ¶ˆæ¯è½¬å‘æœŸé—´ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•ã€‚å¦‚æœå¯¹è±¡ç®¡ç†ä»£ç†æˆ–èƒ½å¤Ÿå¤„ç†å®ƒæ²¡æœ‰ç›´æ¥å®ç°çš„æ¶ˆæ¯ï¼Œåˆ™åº”é‡å†™æ­¤æ–¹æ³•ä»¥è¿”å›é€‚å½“çš„æ–¹æ³•ç­¾åã€‚ æˆ‘ä»¬åœ¨è¿™é‡Œéœ€è¦ç®¡ç†ä»£ç†ï¼Œæ‰€ä»¥ä½¿ç”¨æ…¢é€Ÿæ¶ˆæ¯è½¬å‘ã€‚ æ­¥éª¤ï¼š 1.è‡ªå®šä¸€ä¸ªXWTrackingAnalyticsDelegateProxyç±»ï¼Œç»§æ‰¿è‡ªNSProxyï¼Œå¹¶åœ¨å…¶ä¸­è¿›è¡Œæ‹¦æˆªå’Œæ¶ˆæ¯è½¬å‘ã€‚ XWTrackingAnalyticsDelegateProxy.hï¼š 1234567891011#import &lt;UIKit/UIKit.h&gt;NS_ASSUME_NONNULL_BEGIN@interface XWTrackingAnalyticsDelegateProxy : NSProxy &lt;UITableViewDelegate&gt;+ (instancetype)proxyWithTableViewDelegate:(id&lt;UITableViewDelegate&gt;)delegate;@endNS_ASSUME_NONNULL_END XWTrackingAnalyticsDelegateProxy.mï¼š 12345678910111213141516171819202122232425262728293031323334353637383940#import &quot;XWTrackingAnalyticsDelegateProxy.h&quot;#import &quot;XWTrackingAnalysisSDK.h&quot;@interface XWTrackingAnalyticsDelegateProxy ()@property (nonatomic, weak) id delegate;@end@implementation XWTrackingAnalyticsDelegateProxy+ (instancetype)proxyWithTableViewDelegate:(id&lt;UITableViewDelegate&gt;)delegate { XWTrackingAnalyticsDelegateProxy *proxy = [XWTrackingAnalyticsDelegateProxy alloc]; proxy.delegate = delegate; return proxy;}- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel { // è¿”å› delegate å¯¹è±¡ä¸­å¯¹åº”çš„æ–¹æ³•ç­¾å return [(NSObject *)self.delegate methodSignatureForSelector:sel];}- (void)forwardInvocation:(NSInvocation *)invocation { // å…ˆæ‰§è¡Œ delegate å¯¹è±¡ä¸­çš„æ–¹æ³• [invocation invokeWithTarget:self.delegate]; // åˆ¤æ–­æ˜¯å¦æ˜¯ cell çš„ç‚¹å‡»äº‹ä»¶çš„ä»£ç†æ–¹æ³• if (invocation.selector == @selector(tableView:didSelectRowAtIndexPath:)) { // å°†æ–¹æ³•ä¿®æ”¹ä¸ºè¿›è¡Œæ•°æ®é‡‡é›†çš„æ–¹æ³• invocation.selector = NSSelectorFromString(@&quot;xwtracking_tableView:didSelectRowAtIndexPath:&quot;); // æ‰§è¡Œæ•°æ®é‡‡é›†ç›¸å…³çš„æ–¹æ³• [invocation invokeWithTarget:self]; }}- (void)xwtracking_tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath { // æ•°æ®é‡‡é›†ç›¸å…³ [XWTrackingAnalysisSDK.shareInstance trackAppClickWithTableView:tableView didSelectRowAtIndexPath:indexPath properties:nil];}@end 2.ä½¿ç”¨æ–¹æ³•äº¤æ¢æŠŠä»£ç†è®¾ç½®ä¸ºproxy UITableView+XWTracking.mï¼š 123456789101112131415161718192021222324252627282930313233343536#import &quot;UITableView+XWTracking.h&quot;#import &quot;NSObject+XWSwizzler.h&quot;#import &lt;objc/message.h&gt;#import &quot;XWTrackingAnalysisSDK.h&quot;#import &quot;XWTrackingAnalyticsDelegateProxy.h&quot;#import &quot;UIScrollView+XWTracking.h&quot;@implementation UITableView (XWTracking)+ (void)load { [UITableView xwtracking_swizzleMethod:@selector(setDelegate:) withMethod:@selector(xwtracking_setDelegate:)];}- (void)xwtracking_setDelegate:(id&lt;UITableViewDelegate&gt;)delegate {// [self xwtracking_setDelegate:delegate]; // // æ–¹æ¡ˆä¸€ï¼šäº¤æ¢æ–¹æ³•// // äº¤æ¢ delegate ä¸­çš„ tableView:didSelectRowAtIndexPath: æ–¹æ³•// [self xwtracking_swizzleDidSelectRowAtIndexPathMethodWithDelegate:delegate]; // æ–¹æ¡ˆä¸‰ï¼šNSProxy æ¶ˆæ¯è½¬å‘ // é”€æ¯ä¿å­˜çš„å§”æ‰˜å¯¹è±¡ self.xwtracking_delegateProxy = nil; if (delegate) { XWTrackingAnalyticsDelegateProxy *proxy = [XWTrackingAnalyticsDelegateProxy proxyWithTableViewDelegate:delegate]; // ä¿å­˜å§”æ‰˜å¯¹è±¡ self.xwtracking_delegateProxy = proxy; // è°ƒç”¨åŸå§‹æ–¹æ³•ï¼Œå°†ä»£ç†è®¾ç½®ä¸ºå§”æ‰˜å¯¹è±¡ [self xwtracking_setDelegate:proxy]; } else { // è°ƒç”¨åŸå§‹æ–¹æ³•ï¼Œå°†ä»£ç†è®¾ç½®ä¸ºnil [self xwtracking_setDelegate:nil]; }}... 3.ä¸ºäº†è§£å†³proxyè¿™ä¸ªå±€éƒ¨å˜é‡å‡ºä»£ç å—è¢«é‡Šæ”¾ï¼Œç„¶åproxyè¿™ä¸ªä¸­é—´ä»£ç†ä¸å­˜åœ¨çš„æƒ…å†µä¸‹è¿˜å»è°ƒç”¨ä»£ç†æ–¹æ³•æ—¶çš„å´©æºƒï¼Œéœ€è¦åŠ ä¸€ä¸ªå¯¹è¿™ä¸ªå§”æ‰˜å¯¹è±¡åŠ ä¸€ä¸ªå¼ºå¼•ç”¨ã€‚ ä¸ºäº†å¯ä»¥åŒæ—¶æ”¯æŒUICollectionViewæ§ä»¶ï¼Œç›´æ¥åœ¨UIScrollViewä¸­æ‰©å±•xwtracking_delegateProxyè¿™ä¸ªå±æ€§ï¼š UIScrollView+XWTracking.hï¼š 12345678#import &lt;UIKit/UIKit.h&gt;#import &quot;XWTrackingAnalyticsDelegateProxy.h&quot;@interface UIScrollView (XWTracking)@property (nonatomic, strong) XWTrackingAnalyticsDelegateProxy *xwtracking_delegateProxy;@end UIScrollView+XWTracking.mï¼š 1234567891011121314#import &quot;UIScrollView+XWTracking.h&quot;#include &lt;objc/runtime.h&gt;@implementation UIScrollView (XWTracking)- (void)setXwtracking_delegateProxy:(XWTrackingAnalyticsDelegateProxy *)xwtracking_delegateProxy { objc_setAssociatedObject(self, @selector(setXwtracking_delegateProxy:), xwtracking_delegateProxy, OBJC_ASSOCIATION_RETAIN_NONATOMIC);}- (XWTrackingAnalyticsDelegateProxy *)xwtracking_delegateProxy { return objc_getAssociatedObject(self, @selector(xwtracking_delegateProxy));}@end è‡³æ­¤å°±å·²ç»èƒ½å¤Ÿæ‹¦æˆªåˆ°tableView:didSelectRowAtIndexPath:æ–¹æ³•å¹¶ä¸”åœ¨å…¶ä¸­åŸ‹ç‚¹äº†ã€‚ åŸç†å›¾ï¼š å››ã€æ€»ç»“ç»¼ä¸Šæ‰€è¿°ï¼Œå½“æˆ‘ä»¬è°ƒç”¨æ–¹æ³•æ—¶ï¼š â‘ é¦–å…ˆè¿›è¡Œæ–¹æ³•çš„æŸ¥æ‰¾ â‘¡å¦‚æœæŸ¥æ‰¾å¤±è´¥ï¼Œä¼šè¿›è¡ŒåŠ¨æ€æ–¹æ³•è§£æï¼Œæ­¤æ—¶OCä¼šç»™æˆ‘ä»¬ä¸€æ¬¡å¯¹selçš„å¤„ç†æœºä¼šï¼Œä½ å¯ä»¥åœ¨resolveInstanceMethod:ï¼ˆç±»æ–¹æ³•å¯¹åº”resolveClassMethod:ï¼‰ä¸­æ·»åŠ ä¸€ä¸ªIMP â‘¢å¦‚æœä½ æ²¡æŠŠæ¡ä½è¿™æ¬¡æœºä¼šï¼Œä¹Ÿå°±æ˜¯è§£æå¤±è´¥æ—¶ï¼Œä¼šæ¥åˆ°æ¶ˆæ¯è½¬å‘é˜¶æ®µï¼Œè¿™ä¸ªé˜¶æ®µæœ‰ä¸¤ä¸ªæœºä¼šå»å¤„ç†selï¼Œåˆ†åˆ«æ˜¯å¿«é€Ÿè½¬å‘çš„forwardingTargetForSelector:ï¼Œä»¥åŠæ…¢é€Ÿè½¬å‘çš„methodSignatureForSelector:ã€‚ æ¶ˆæ¯å¿«é€Ÿè½¬å‘é˜¶æ®µforwardingTargedForSelectorï¼Œå¦‚æœæœ‰å¤„ç†ï¼Œå°±äº¤ç»™å¤„ç†çš„å¯¹è±¡æ¥å®ç°ï¼Œæ²¡æœ‰å°±äº¤ç»™å…¶ä»–å¯¹è±¡å¤„ç†ï¼Œè¿›å…¥æ…¢é€Ÿè½¬å‘é˜¶æ®µã€‚ æ¶ˆæ¯æ…¢é€Ÿè½¬å‘é˜¶æ®µmethodSignatureForSelectorï¼Œè¿›è¡Œæ–¹æ³•ç­¾åï¼ŒæŠŠæ–¹æ³•ä¸¢å‡ºå»ï¼ŒforwardInvocationæ¥å¯¹æ¶ˆæ¯å¤„ç†ã€‚ â‘£å½“ç„¶ï¼Œå¦‚æœè¿™äº›æœºä¼šä½ éƒ½æ”¾å¼ƒäº†ï¼Œé‚£OCåªå¥½è®©ç¨‹åºå´©æºƒï¼Œå°±è¿›å…¥åˆ°äº†doesNotRecognizeSelectoræŠ¥é”™ã€‚ ä¸‹é¢ç”¨ä¸€å‰¯å›¾æ€»ç»“æ–¹æ³•çš„è§£æå’Œè½¬å‘æµç¨‹ï¼š äº”ã€é—®é¢˜è®¨è®ºä¸ºä»€ä¹ˆå¼•å…¥æ¶ˆæ¯è½¬å‘æœºåˆ¶ï¼Ÿåœ¨ä¸€ä¸ªæ–¹æ³•è¢«è°ƒç”¨ä¹‹å‰ï¼Œæˆ‘ä»¬æ˜¯æ²¡åŠæ³•ç¡®å®šå®ƒçš„å®ç°åœ°å€çš„ï¼Œç›´åˆ°è¿è¡Œæ—¶ï¼Œè¿™ä¸ªæ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ‰èƒ½çœŸæ­£çŸ¥é“å®ƒæ˜¯å¦æœ‰å®ç°ï¼Œä»¥åŠå…¶å…·ä½“çš„å®ç°åœ°å€ã€‚è¿™ä¹Ÿå°±æ˜¯æ‰€è°“çš„â€œåŠ¨æ€ç»‘å®šâ€ã€‚ åœ¨ç¼–è¯‘æœŸï¼Œå¦‚æœç¼–è¯‘å™¨å‘ç°æ–¹æ³•ä¸å­˜åœ¨ï¼Œä¼šç›´æ¥æŠ¥é”™ï¼›åŒæ ·ï¼Œåœ¨è¿è¡Œæ—¶ï¼Œä¹Ÿæœ‰doesNotRecognizeSelectorçš„å¤„ç†ã€‚ åœ¨æŠ›å‡ºdoesNotRecognizeSelectorè¿™ä¸ªå¼‚å¸¸ä¿¡æ¯ä¹‹å‰ï¼ŒOCåˆ©ç”¨å…¶åŠ¨æ€ç»‘å®šçš„ç‰¹æ€§ï¼Œå¼•å…¥äº†æ¶ˆæ¯è½¬å‘æœºåˆ¶ï¼Œç»™äºˆäº†æˆ‘ä»¬é¢å¤–çš„æœºä¼šå¤„ç†æ¶ˆæ¯ï¼ˆè§£æ or è½¬å‘ï¼‰ï¼Œè¿™æ ·çš„åšæ³•æ˜¾ç„¶æ›´åŠ å‘¨å…¨åˆç†ã€‚ å‚è€ƒOCæºç åˆ†æä¹‹æ–¹æ³•çš„è§£æä¸è½¬å‘åŸç†-çº¢é…’ç‰›æ’ iOSæ¢ç´¢ åŠ¨æ€æ–¹æ³•è§£æå’Œæ¶ˆæ¯è½¬å‘æœºåˆ¶-æˆ‘æ˜¯å¥½å®å® iOS åº•å±‚æ¢ç´¢ç¯‡ â€”â€” æ–¹æ³•çš„è½¬å‘æµç¨‹-Eating iOS å¸¦ä½ èµ°è¿›æ¶ˆæ¯è½¬å‘æµç¨‹åŠé˜²å´©æºƒå¤„ç†-æµå¹´åŒ†åŒ†i ã€ŠiOSå…¨åŸ‹ç‚¹è§£å†³æ–¹æ¡ˆã€‹","link":"/2021/01/03/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/06-%E5%8A%A8%E6%80%81%E6%96%B9%E6%B3%95%E8%A7%A3%E6%9E%90%E5%92%8C%E6%B6%88%E6%81%AF%E8%BD%AC%E5%8F%91%E6%9C%BA%E5%88%B6/"},{"title":"07ä¸‹-dyldåˆ†æ","text":"å‰è¨€æˆ‘ä»¬å¹³æ—¶ç¼–å†™çš„ç¨‹åºçš„å…¥å£å‡½æ•°éƒ½æ˜¯main.mæ–‡ä»¶é‡Œé¢çš„mainå‡½æ•°ï¼Œä½†æ˜¯è¿™å°±æ˜¯Appçš„ç”Ÿå‘½èµ·ç‚¹äº†å—ï¼Ÿ +loadæ–¹æ³•å…ˆäºmainå‡½æ•°æ‰§è¡Œï¼Œé‚£ä¹ˆmainå‡½æ•°ä¹‹å‰éƒ½å‘ç”Ÿäº†å“ªäº›æœ‰è¶£çš„äº‹å‘¢ï¼Ÿ ä¸€ã€é™æ€åº“ä¸åŠ¨æ€åº“1.ç¼–è¯‘è¿‡ç¨‹åœ¨æ—¥å¸¸å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¼€å‘è€…ä¼šä½¿ç”¨æˆåƒä¸Šä¸‡æ¬¡çš„Command + B/Rè¿›è¡Œå¼€å‘è°ƒè¯•ï¼Œä½†å¯èƒ½å¾ˆå°‘æœ‰äººå…³æ³¨è¿‡è¿™ä¸ªè¿‡ç¨‹ä¸­ Xcodeå¸®æˆ‘ä»¬åšäº†å“ªäº›äº‹æƒ… äº‹å®ä¸Šï¼Œè¿™ä¸ªè¿‡ç¨‹åˆ†è§£ä¸º4ä¸ªæ­¥éª¤ï¼Œåˆ†åˆ«æ˜¯é¢„å¤„ç†(Prepressing)ã€ç¼–è¯‘(Compilation)ã€æ±‡ç¼–(Assembly)å’Œé“¾æ¥(Linking)â€”â€”æ‘˜è‡ªã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»â€“ é“¾æ¥ã€è£…è½½ä¸åº“ã€‹ åœ¨ä»¥ä¸Š4ä¸ªæ­¥éª¤ä¸­ï¼ŒIDEä¸»è¦åšäº†ä»¥ä¸‹å‡ ä»¶äº‹: **é¢„ç¼–è¯‘**ï¼šå¤„ç†ä»£ç ä¸­çš„# å¼€å¤´çš„é¢„ç¼–è¯‘æŒ‡ä»¤ã€‚æ¯”å¦‚åˆ é™¤#defineå¹¶å±•å¼€å®å®šä¹‰ï¼Œå°†#includeåŒ…å«çš„æ–‡ä»¶æ’å…¥åˆ°è¯¥æŒ‡ä»¤ä½ç½®ç­‰ **ç¼–è¯‘**ï¼šå¯¹é¢„ç¼–è¯‘å¤„ç†è¿‡çš„æ–‡ä»¶è¿›è¡Œè¯æ³•åˆ†æã€è¯­æ³•åˆ†æå’Œè¯­ä¹‰åˆ†æï¼Œå¹¶è¿›è¡Œæºä»£ç ä¼˜åŒ–ï¼Œç„¶åç”Ÿæˆæ±‡ç¼–ä»£ç  **æ±‡ç¼–**ï¼šé€šè¿‡æ±‡ç¼–å™¨å°†æ±‡ç¼–ä»£ç è½¬æ¢ä¸ºæœºå™¨å¯ä»¥æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œå¹¶ç”Ÿæˆç›®æ ‡æ–‡ä»¶.oæ–‡ä»¶ **é“¾æ¥**ï¼šå°†ç›®æ ‡æ–‡ä»¶é“¾æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚è¿™ä¸€è¿‡ç¨‹ä¸­ï¼Œé“¾æ¥å™¨å°†ä¸åŒçš„ç›®æ ‡æ–‡ä»¶é“¾æ¥èµ·æ¥ï¼Œå› ä¸ºä¸åŒçš„ç›®æ ‡æ–‡ä»¶ä¹‹é—´å¯èƒ½æœ‰ç›¸äº’å¼•ç”¨çš„å˜é‡æˆ–è°ƒç”¨çš„å‡½æ•°ï¼Œå¦‚æˆ‘ä»¬ç»å¸¸è°ƒç”¨Foundationæ¡†æ¶å’ŒUIKitæ¡†æ¶ä¸­çš„æ–¹æ³•å’Œå˜é‡ï¼Œä½†æ˜¯è¿™äº›æ¡†æ¶è·Ÿæˆ‘ä»¬çš„ä»£ç å¹¶ä¸åœ¨ä¸€ä¸ªç›®æ ‡æ–‡ä»¶ä¸­ï¼Œè¿™å°±éœ€è¦é“¾æ¥å™¨å°†å®ƒä»¬ä¸æˆ‘ä»¬è‡ªå·±çš„ä»£ç é“¾æ¥èµ·æ¥ Foundationå’ŒUIKitè¿™ç§å¯ä»¥å…±äº«ä»£ç ã€å®ç°ä»£ç çš„å¤ç”¨ç»Ÿç§°ä¸ºåº“â€”â€”æ˜¯å¯æ‰§è¡Œä»£ç çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¯ä»¥è¢«æ“ä½œç³»ç»Ÿå†™å…¥å†…å­˜ï¼Œå®ƒåˆåˆ†ä¸ºé™æ€åº“å’ŒåŠ¨æ€åº“ 2.é™æ€åº“é™æ€åº“æ˜¯æŒ‡é“¾æ¥æ—¶å®Œæ•´çš„æ‹·è´åˆ°å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¤šæ¬¡ä½¿ç”¨å¤šæ¬¡æ‹·è´ï¼Œé€ æˆå†—ä½™ï¼Œä½¿åŒ…å˜çš„æ›´å¤§ å¦‚.aã€.libéƒ½æ˜¯é™æ€åº“ 3.åŠ¨æ€åº“åŠ¨æ€åº“æ˜¯æŒ‡é“¾æ¥æ—¶ä¸å¤åˆ¶ï¼Œç¨‹åºè¿è¡Œæ—¶ç”±ç³»ç»ŸåŠ åœ¨åˆ°å†…å­˜ä¸­ï¼Œä¾›ç³»ç»Ÿè°ƒç”¨ï¼Œç³»ç»Ÿåªéœ€åŠ è½½ä¸€æ¬¡ï¼Œå¤šæ¬¡ä½¿ç”¨ï¼Œå…±ç”¨èŠ‚çœå†…å­˜ã€‚ å¦‚.dylibã€.frameworkéƒ½æ˜¯åŠ¨æ€åº“ ç³»ç»Ÿçš„frameworkæ˜¯åŠ¨æ€çš„ï¼Œå¼€å‘è€…åˆ›å»ºçš„frameworkæ˜¯é™æ€çš„ é‚£ä¹ˆé“¾æ¥å™¨åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå®ƒæ˜¯æ€ä¹ˆé“¾æ¥ä¸åŒçš„ç›®æ ‡æ–‡ä»¶çš„å‘¢ï¼Ÿ äºŒã€dyld1.dyldç®€ä»‹dyld(dynamic link editor / dynamic loader)æ˜¯è‹¹æœçš„åŠ¨æ€é“¾æ¥å™¨ï¼Œè´Ÿè´£ç¨‹åºçš„é“¾æ¥åŠåŠ è½½å·¥ä½œï¼Œæ˜¯è‹¹æœæ“ä½œç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå­˜åœ¨äºMacOSç³»ç»Ÿçš„(/usr/lib/dyld)ç›®å½•ä¸‹ã€‚ åœ¨åº”ç”¨è¢«ç¼–è¯‘æ‰“åŒ…æˆå¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼çš„Mach-Oæ–‡ä»¶ä¹‹å ï¼Œäº¤ç”±dyldè´Ÿè´£é“¾æ¥ï¼ŒåŠ è½½ç¨‹åºã€‚ 2.dyld_shared_cacheç”±äºä¸æ­¢ä¸€ä¸ªç¨‹åºéœ€è¦ä½¿ç”¨UIKitç³»ç»ŸåŠ¨æ€åº“ï¼Œæ‰€ä»¥ä¸å¯èƒ½åœ¨æ¯ä¸ªç¨‹åºåŠ è½½æ—¶éƒ½å»åŠ è½½æ‰€æœ‰çš„ç³»ç»ŸåŠ¨æ€åº“ã€‚ ä¸ºäº†ä¼˜åŒ–ç¨‹åºå¯åŠ¨é€Ÿåº¦å’Œåˆ©ç”¨åŠ¨æ€åº“ç¼“å­˜ï¼Œè‹¹æœä»iOS3.1ä¹‹åï¼Œå°†æ‰€æœ‰ç³»ç»Ÿåº“ï¼ˆç§æœ‰ä¸å…¬æœ‰ï¼‰ç¼–è¯‘æˆä¸€ä¸ªå¤§çš„ç¼“å­˜æ–‡ä»¶ï¼Œè¿™å°±æ˜¯dyld_shared_cacheï¼Œè¯¥ç¼“å­˜æ–‡ä»¶å­˜åœ¨iOSç³»ç»Ÿä¸‹çš„/System/Library/Caches/com.apple.dyld/ç›®å½•ä¸‹ ä¸‰ã€dyldåŠ è½½æµç¨‹æ–°å»ºç©ºå·¥ç¨‹ï¼Œå†™ä¸‹loadæ–¹æ³•ï¼Œå¹¶åœ¨mainæ–¹æ³•å’Œloadæ–¹æ³•åˆ†åˆ«ä¸‹æ–­ç‚¹ ç‚¹å‡»å‡½æ•°è°ƒç”¨æ ˆ/ä½¿ç”¨LLVMâ€”â€”btæŒ‡ä»¤æ‰“å°ï¼Œéƒ½èƒ½çœ‹åˆ°æœ€åˆçš„èµ·ç‚¹_dyld_start æ¥ä¸‹æ¥é€šè¿‡dyldæºç (ç‰ˆæœ¬ï¼šdyld-635.2)å±•å¼€åˆ†æ_dyld_startï¼š 1._dyld_startåœ¨æºç ä¸­å…¨å±€æœç´¢_dyld_startï¼Œä¼šå‘ç°å®ƒæ˜¯ç”±æ±‡ç¼–å®ç°çš„ åœ¨arm64ä¸­ï¼Œ_dyld_startè°ƒç”¨äº†ä¸€ä¸ªçœ‹ä¸æ‡‚çš„æ–¹æ³• ä»æ³¨é‡Šä¸­å¾—å‡ºå¯èƒ½æ˜¯dyldbootstrap::startæ–¹æ³•ï¼ˆå…¶å®åœ¨â€œå‡½æ•°è°ƒç”¨æ ˆâ€é‚£å¼ å›¾ä¸­æ±‡ç¼–ä»£ç å·²ç»æŠŠè¿™ä¸ªæ–¹æ³•æš´éœ²å‡ºæ¥äº†ï¼‰ 2.dyldbootstrap::startå…¨å±€æœç´¢dyldbootstrap::startå¹¶æ²¡æœ‰ä»»ä½•æœ‰æ„ä¹‰ç»“æœï¼Œé‚£ä¹ˆåªèƒ½æ ¹æ®ç»éªŒæ¥çè’™ä¸€ä¸‹äº†â€”â€”å…¨å±€æœç´¢ç©ºæ ¼start(â€œä¾¥å¹¸â€å¾—åˆ°äº†ç»“æœ å…¶å®dyldbootstrap::startæ˜¯æŒ‡dyldbootstrapè¿™ä¸ªå‘½åç©ºé—´ä½œç”¨åŸŸé‡Œçš„ startå‡½æ•° 1234567891011121314151617181920212223242526272829303132333435363738uintptr_t start(const struct macho_header* appsMachHeader, int argc, const char* argv[], intptr_t slide, const struct macho_header* dyldsMachHeader, uintptr_t* startGlue){ // if kernel had to slide dyld, we need to fix up load sensitive locations // we have to do this before using any global variables slide = slideOfMainExecutable(dyldsMachHeader); bool shouldRebase = slide != 0;#if __has_feature(ptrauth_calls) shouldRebase = true;#endif if ( shouldRebase ) { rebaseDyld(dyldsMachHeader, slide); } // allow dyld to use mach messaging mach_init(); // kernel sets up env pointer to be just past end of agv array const char** envp = &amp;argv[argc+1]; // kernel sets up apple pointer to be just past end of envp array const char** apple = envp; while(*apple != NULL) { ++apple; } ++apple; // set up random value for stack canary __guard_setup(apple);#if DYLD_INITIALIZER_SUPPORT // run all C++ initializers inside dyld runDyldInitializers(dyldsMachHeader, slide, argc, argv, envp, apple);#endif // now that we are done bootstrapping dyld, call dyld's main uintptr_t appsSlide = slideOfMainExecutable(appsMachHeader); return dyld::_main(appsMachHeader, appsSlide, argc, argv, envp, apple, startGlue);} åœ¨start()å‡½æ•°ä¸­ä¸»è¦åšäº†ä¸€ä¸‹å‡ ä»¶äº‹ï¼š æ ¹æ®dyldsMachHeaderè®¡ç®—å‡ºslideï¼Œ é€šè¿‡slideåˆ¤å®šæ˜¯å¦éœ€è¦é‡å®šä½ï¼›è¿™é‡Œçš„slideæ˜¯æ ¹æ®ASLRæŠ€æœ¯ è®¡ç®—å‡ºçš„ä¸€ä¸ªéšæœºå€¼ï¼Œä½¿å¾—ç¨‹åºæ¯ä¸€æ¬¡è¿è¡Œçš„åç§»å€¼éƒ½ä¸ä¸€æ ·ï¼Œé˜²æ­¢æ”»å‡»è€…é€šè¿‡å›ºå®šåœ°å€å‘èµ·æ¶æ„æ”»å‡» mach_init()åˆå§‹åŒ–ï¼ˆå…è®¸dyldä½¿ç”¨machæ¶ˆæ¯ä¼ é€’ï¼‰ æ ˆæº¢å‡ºä¿æŠ¤ è®¡ç®—appsMachHeaderçš„åç§»ï¼Œè°ƒç”¨dyld::_main()å‡½æ•° 3.dyld::_main()ç‚¹å‡»è¿›å…¥dyld::_main()å‡½æ•° 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514uintptr_t_main(const macho_header* mainExecutableMH, uintptr_t mainExecutableSlide, int argc, const char* argv[], const char* envp[], const char* apple[], uintptr_t* startGlue){ if (dyld3::kdebug_trace_dyld_enabled(DBG_DYLD_TIMING_LAUNCH_EXECUTABLE)) { launchTraceID = dyld3::kdebug_trace_dyld_duration_start(DBG_DYLD_TIMING_LAUNCH_EXECUTABLE, (uint64_t)mainExecutableMH, 0, 0); } // Grab the cdHash of the main executable from the environment uint8_t mainExecutableCDHashBuffer[20]; const uint8_t* mainExecutableCDHash = nullptr; // è·å–ä¸»ç¨‹åºhash if ( hexToBytes(_simple_getenv(apple, &quot;executable_cdhash&quot;), 40, mainExecutableCDHashBuffer) ) mainExecutableCDHash = mainExecutableCDHashBuffer; // Trace dyld's load // é€šçŸ¥kernalå†…æ ¸dyldæ–‡ä»¶å·²åŠ è½½ notifyKernelAboutImage((macho_header*)&amp;__dso_handle, _simple_getenv(apple, &quot;dyld_file&quot;));#if !TARGET_IPHONE_SIMULATOR // Trace the main executable's load // é€šçŸ¥kernalå†…æ ¸mach-oæ–‡ä»¶å·²åŠ è½½ notifyKernelAboutImage(mainExecutableMH, _simple_getenv(apple, &quot;executable_file&quot;));#endif uintptr_t result = 0; // ä¿å­˜ä¼ å…¥çš„å¯æ‰§è¡Œæ–‡ä»¶çš„å¤´éƒ¨ï¼ˆæ˜¯ä¸€ä¸ªstruct macho_headerç»“æ„ä½“ï¼‰ï¼Œåé¢æ ¹æ®å¤´éƒ¨è®¿é—®ä¿¡æ¯ sMainExecutableMachHeader = mainExecutableMH; sMainExecutableSlide = mainExecutableSlide;#if __MAC_OS_X_VERSION_MIN_REQUIRED // if this is host dyld, check to see if iOS simulator is being run const char* rootPath = _simple_getenv(envp, &quot;DYLD_ROOT_PATH&quot;); if ( (rootPath != NULL) ) { // look to see if simulator has its own dyld char simDyldPath[PATH_MAX]; strlcpy(simDyldPath, rootPath, PATH_MAX); strlcat(simDyldPath, &quot;/usr/lib/dyld_sim&quot;, PATH_MAX); int fd = my_open(simDyldPath, O_RDONLY, 0); if ( fd != -1 ) { const char* errMessage = useSimulatorDyld(fd, mainExecutableMH, simDyldPath, argc, argv, envp, apple, startGlue, &amp;result); if ( errMessage != NULL ) halt(errMessage); return result; } }#endif CRSetCrashLogMessage(&quot;dyld: launch started&quot;); // ä¸»è¦åŠŸèƒ½1âƒ£ï¸ï¼šæ ¹æ®å¯æ‰§è¡Œæ–‡ä»¶å¤´éƒ¨ï¼Œå‚æ•°ç­‰è®¾ç½®ä¸Šä¸‹æ–‡ä¿¡æ¯ setContext(mainExecutableMH, argc, argv, envp, apple); // Pickup the pointer to the exec path. // è·å–å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ sExecPath = _simple_getenv(apple, &quot;executable_path&quot;); // &lt;rdar://problem/13868260&gt; Remove interim apple[0] transition code from dyld if (!sExecPath) sExecPath = apple[0]; // mach-o ç»å¯¹è·¯å¾„ if ( sExecPath[0] != '/' ) { // have relative path, use cwd to make absolute char cwdbuff[MAXPATHLEN]; if ( getcwd(cwdbuff, MAXPATHLEN) != NULL ) { // maybe use static buffer to avoid calling malloc so early... char* s = new char[strlen(cwdbuff) + strlen(sExecPath) + 2]; strcpy(s, cwdbuff); strcat(s, &quot;/&quot;); strcat(s, sExecPath); sExecPath = s; } } // Remember short name of process for later logging // è·å–å¯æ‰§è¡Œæ–‡ä»¶çš„åå­— sExecShortName = ::strrchr(sExecPath, '/'); if ( sExecShortName != NULL ) ++sExecShortName; else sExecShortName = sExecPath; // ä¸»è¦åŠŸèƒ½1âƒ£ï¸ï¼šæ£€æµ‹è¿›ç¨‹æ˜¯å¦å—é™ configureProcessRestrictions(mainExecutableMH);#if __MAC_OS_X_VERSION_MIN_REQUIRED if ( !gLinkContext.allowEnvVarsPrint &amp;&amp; !gLinkContext.allowEnvVarsPath &amp;&amp; !gLinkContext.allowEnvVarsSharedCache ) { pruneEnvironmentVariables(envp, &amp;apple); // set again because envp and apple may have changed or moved setContext(mainExecutableMH, argc, argv, envp, apple); } else#endif { // ä¸»è¦åŠŸèƒ½2âƒ£ï¸ï¼šæ£€æŸ¥è®¾ç½®ç¯å¢ƒå˜é‡ checkEnvironmentVariables(envp); // å¦‚æœDYLD_FALLBACKä¸ºnilï¼Œå°†å…¶è®¾ç½®ä¸ºé»˜è®¤å€¼ defaultUninitializedFallbackPaths(envp); }#if __MAC_OS_X_VERSION_MIN_REQUIRED if ( ((dyld3::MachOFile*)mainExecutableMH)-&gt;supportsPlatform(dyld3::Platform::iOSMac) &amp;&amp; !((dyld3::MachOFile*)mainExecutableMH)-&gt;supportsPlatform(dyld3::Platform::macOS)) { gLinkContext.rootPaths = parseColonList(&quot;/System/iOSSupport&quot;, NULL); gLinkContext.marzipan = true; if ( sEnv.DYLD_FALLBACK_LIBRARY_PATH == sLibraryFallbackPaths ) sEnv.DYLD_FALLBACK_LIBRARY_PATH = sRestrictedLibraryFallbackPaths; if ( sEnv.DYLD_FALLBACK_FRAMEWORK_PATH == sFrameworkFallbackPaths ) sEnv.DYLD_FALLBACK_FRAMEWORK_PATH = sRestrictedFrameworkFallbackPaths; }#endif // å¦‚æœè®¾ç½®äº†DYLD_PRINT_OPTSç¯å¢ƒå˜é‡ï¼Œåˆ™æ‰“å°å‚æ•° if ( sEnv.DYLD_PRINT_OPTS ) printOptions(argv); // å¦‚æœè®¾ç½®äº†DYLD_PRINT_ENVç¯å¢ƒå˜é‡ï¼Œåˆ™æ‰“å°ç¯å¢ƒå˜é‡ if ( sEnv.DYLD_PRINT_ENV ) printEnvironmentVariables(envp); // ä¸»è¦åŠŸèƒ½2âƒ£ï¸ï¼šæ ¹æ®Mach-Oå¤´éƒ¨è·å–å½“å‰è¿è¡Œæ¶æ„ä¿¡æ¯ getHostInfo(mainExecutableMH, mainExecutableSlide); // load shared cache // ä¸»è¦åŠŸèƒ½3âƒ£ï¸ï¼šæ£€æŸ¥å…±äº«ç¼“å­˜æ˜¯å¦å¼€å¯ï¼ŒiOSä¸­å¿…é¡»å¼€å¯ checkSharedRegionDisable((dyld3::MachOLoaded*)mainExecutableMH, mainExecutableSlide);#if TARGET_IPHONE_SIMULATOR // &lt;HACK&gt; until &lt;rdar://30773711&gt; is fixed gLinkContext.sharedRegionMode = ImageLoader::kUsePrivateSharedRegion; // &lt;/HACK&gt;#endif if ( gLinkContext.sharedRegionMode != ImageLoader::kDontUseSharedRegion ) { // ä¸»è¦åŠŸèƒ½3âƒ£ï¸ï¼šåŠ è½½å…±äº«ç¼“å­˜åº“ mapSharedCache(); } bool cacheCompatible = (sSharedCacheLoadInfo.loadAddress == nullptr) || (sSharedCacheLoadInfo.loadAddress-&gt;header.formatVersion == dyld3::closure::kFormatVersion); if ( cacheCompatible &amp;&amp; (sEnableClosures || inWhiteList(sExecPath)) ) { const dyld3::closure::LaunchClosure* mainClosure = nullptr; dyld3::closure::LoadedFileInfo mainFileInfo; mainFileInfo.fileContent = mainExecutableMH; mainFileInfo.path = sExecPath; // FIXME: If we are saving this closure, this slice offset/length is probably wrong in the case of FAT files. mainFileInfo.sliceOffset = 0; mainFileInfo.sliceLen = std::numeric_limits&lt;__typeof(mainFileInfo.sliceLen)&gt;::max(); struct stat mainExeStatBuf; if ( ::stat(sExecPath, &amp;mainExeStatBuf) == 0 ) { mainFileInfo.inode = mainExeStatBuf.st_ino; mainFileInfo.mtime = mainExeStatBuf.st_mtime; } // check for closure in cache first if ( sSharedCacheLoadInfo.loadAddress != nullptr ) { mainClosure = sSharedCacheLoadInfo.loadAddress-&gt;findClosure(sExecPath); if ( gLinkContext.verboseWarnings &amp;&amp; (mainClosure != nullptr) ) dyld::log(&quot;dyld: found closure %p (size=%lu) in dyld shared cache\\n&quot;, mainClosure, mainClosure-&gt;size()); } #if !TARGET_IPHONE_SIMULATOR if ( (mainClosure == nullptr) || !closureValid(mainClosure, mainFileInfo, mainExecutableCDHash, true, envp) ) { mainClosure = nullptr; if ( sEnableClosures || isStagedApp((dyld3::MachOFile*)mainExecutableMH, sExecPath) ) { // if forcing closures, and no closure in cache, or it is invalid, check for cached closure mainClosure = findCachedLaunchClosure(mainExecutableCDHash, mainFileInfo, envp); if ( mainClosure == nullptr ) { // if no cached closure found, build new one mainClosure = buildLaunchClosure(mainExecutableCDHash, mainFileInfo, envp); } } } #endif // try using launch closure if ( mainClosure != nullptr ) { CRSetCrashLogMessage(&quot;dyld3: launch started&quot;); bool launched = launchWithClosure(mainClosure, sSharedCacheLoadInfo.loadAddress, (dyld3::MachOLoaded*)mainExecutableMH, mainExecutableSlide, argc, argv, envp, apple, &amp;result, startGlue); #if !TARGET_IPHONE_SIMULATOR if ( !launched ) { // closure is out of date, build new one mainClosure = buildLaunchClosure(mainExecutableCDHash, mainFileInfo, envp); if ( mainClosure != nullptr ) { launched = launchWithClosure(mainClosure, sSharedCacheLoadInfo.loadAddress, (dyld3::MachOLoaded*)mainExecutableMH, mainExecutableSlide, argc, argv, envp, apple, &amp;result, startGlue); } } #endif if ( launched ) {#if __has_feature(ptrauth_calls) // start() calls the result pointer as a function pointer so we need to sign it. result = (uintptr_t)__builtin_ptrauth_sign_unauthenticated((void*)result, 0, 0);#endif if (sSkipMain) result = (uintptr_t)&amp;fake_main; return result; } else { if ( gLinkContext.verboseWarnings ) dyld::log(&quot;dyld: unable to use closure %p\\n&quot;, mainClosure); } } } else { if ( gLinkContext.verboseWarnings ) dyld::log(&quot;dyld: not using closure because shared cache format version does not match dyld's\\n&quot;); } // could not use closure info, launch old way // install gdb notifier stateToHandlers(dyld_image_state_dependents_mapped, sBatchHandlers)-&gt;push_back(notifyGDB); stateToHandlers(dyld_image_state_mapped, sSingleHandlers)-&gt;push_back(updateAllImages); // make initial allocations large enough that it is unlikely to need to be re-alloced sImageRoots.reserve(16); sAddImageCallbacks.reserve(4); sRemoveImageCallbacks.reserve(4); sAddLoadImageCallbacks.reserve(4); sImageFilesNeedingTermination.reserve(16); sImageFilesNeedingDOFUnregistration.reserve(8);#if !TARGET_IPHONE_SIMULATOR#ifdef WAIT_FOR_SYSTEM_ORDER_HANDSHAKE // &lt;rdar://problem/6849505&gt; Add gating mechanism to dyld support system order file generation process WAIT_FOR_SYSTEM_ORDER_HANDSHAKE(dyld::gProcessInfo-&gt;systemOrderFlag);#endif#endif try { // add dyld itself to UUID list // ä¸»è¦åŠŸèƒ½4âƒ£ï¸ï¼šå°†dyldæœ¬èº«æ·»åŠ åˆ°UUIDåˆ—è¡¨ addDyldImageToUUIDList();#if SUPPORT_ACCELERATE_TABLES#if __arm64e__ // Disable accelerator tables when we have threaded rebase/bind, which is arm64e executables only for now. if (sMainExecutableMachHeader-&gt;cpusubtype == CPU_SUBTYPE_ARM64_E) sDisableAcceleratorTables = true;#endif bool mainExcutableAlreadyRebased = false; if ( (sSharedCacheLoadInfo.loadAddress != nullptr) &amp;&amp; !dylibsCanOverrideCache() &amp;&amp; !sDisableAcceleratorTables &amp;&amp; (sSharedCacheLoadInfo.loadAddress-&gt;header.accelerateInfoAddr != 0) ) { struct stat statBuf; if ( ::stat(IPHONE_DYLD_SHARED_CACHE_DIR &quot;no-dyld2-accelerator-tables&quot;, &amp;statBuf) != 0 ) sAllCacheImagesProxy = ImageLoaderMegaDylib::makeImageLoaderMegaDylib(&amp;sSharedCacheLoadInfo.loadAddress-&gt;header, sSharedCacheLoadInfo.slide, mainExecutableMH, gLinkContext); }reloadAllImages:#endif CRSetCrashLogMessage(sLoadingCrashMessage); // instantiate ImageLoader for main executable // ä¸»è¦åŠŸèƒ½5âƒ£ï¸ï¼šå®ä¾‹åŒ–ä¸»ç¨‹åº // åŠ è½½å¯æ‰§è¡Œæ–‡ä»¶å¹¶ç”Ÿæˆä¸€ä¸ªImageLoaderå®ä¾‹å¯¹è±¡ // è¿™é‡Œè°ƒç”¨æ¯”è¾ƒæ·±,åç»­å†çœ‹ sMainExecutable = instantiateFromLoadedImage(mainExecutableMH, mainExecutableSlide, sExecPath); gLinkContext.mainExecutable = sMainExecutable; gLinkContext.mainExecutableCodeSigned = hasCodeSignatureLoadCommand(mainExecutableMH);#if TARGET_IPHONE_SIMULATOR // check main executable is not too new for this OS { if ( ! isSimulatorBinary((uint8_t*)mainExecutableMH, sExecPath) ) { throwf(&quot;program was built for a platform that is not supported by this runtime&quot;); } uint32_t mainMinOS = sMainExecutable-&gt;minOSVersion(); // dyld is always built for the current OS, so we can get the current OS version // from the load command in dyld itself. uint32_t dyldMinOS = ImageLoaderMachO::minOSVersion((const mach_header*)&amp;__dso_handle); if ( mainMinOS &gt; dyldMinOS ) { #if TARGET_OS_WATCH throwf(&quot;app was built for watchOS %d.%d which is newer than this simulator %d.%d&quot;, mainMinOS &gt;&gt; 16, ((mainMinOS &gt;&gt; 8) &amp; 0xFF), dyldMinOS &gt;&gt; 16, ((dyldMinOS &gt;&gt; 8) &amp; 0xFF)); #elif TARGET_OS_TV throwf(&quot;app was built for tvOS %d.%d which is newer than this simulator %d.%d&quot;, mainMinOS &gt;&gt; 16, ((mainMinOS &gt;&gt; 8) &amp; 0xFF), dyldMinOS &gt;&gt; 16, ((dyldMinOS &gt;&gt; 8) &amp; 0xFF)); #else throwf(&quot;app was built for iOS %d.%d which is newer than this simulator %d.%d&quot;, mainMinOS &gt;&gt; 16, ((mainMinOS &gt;&gt; 8) &amp; 0xFF), dyldMinOS &gt;&gt; 16, ((dyldMinOS &gt;&gt; 8) &amp; 0xFF)); #endif } }#endif #if __MAC_OS_X_VERSION_MIN_REQUIRED // &lt;rdar://problem/22805519&gt; be less strict about old mach-o binaries uint32_t mainSDK = sMainExecutable-&gt;sdkVersion(); gLinkContext.strictMachORequired = (mainSDK &gt;= DYLD_MACOSX_VERSION_10_12) || gLinkContext.allowInsertFailures; #else // simulators, iOS, tvOS, and watchOS are always strict gLinkContext.strictMachORequired = true; #endif #if SUPPORT_ACCELERATE_TABLES sAllImages.reserve((sAllCacheImagesProxy != NULL) ? 16 : INITIAL_IMAGE_COUNT); #else sAllImages.reserve(INITIAL_IMAGE_COUNT); #endif // Now that shared cache is loaded, setup an versioned dylib overrides #if SUPPORT_VERSIONED_PATHS //æ£€æŸ¥åº“çš„ç‰ˆæœ¬æ˜¯å¦æœ‰æ›´æ–°ï¼Œæœ‰åˆ™è¦†ç›–åŸæœ‰çš„ checkVersionedPaths(); #endif // dyld_all_image_infos image list does not contain dyld // add it as dyldPath field in dyld_all_image_infos // for simulator, dyld_sim is in image list, need host dyld added#if TARGET_IPHONE_SIMULATOR // get path of host dyld from table of syscall vectors in host dyld void* addressInDyld = gSyscallHelpers;#else // get path of dyld itself void* addressInDyld = (void*)&amp;__dso_handle;#endif char dyldPathBuffer[MAXPATHLEN+1]; int len = proc_regionfilename(getpid(), (uint64_t)(long)addressInDyld, dyldPathBuffer, MAXPATHLEN); if ( len &gt; 0 ) { dyldPathBuffer[len] = '\\0'; // proc_regionfilename() does not zero terminate returned string if ( strcmp(dyldPathBuffer, gProcessInfo-&gt;dyldPath) != 0 ) gProcessInfo-&gt;dyldPath = strdup(dyldPathBuffer); } // load any inserted libraries // ä¸»è¦åŠŸèƒ½6âƒ£ï¸ï¼šæ’å…¥åŠ¨æ€åº“:åŠ è½½æ‰€æœ‰ DYLD_INSERT_LIBRARIES æŒ‡å®šçš„åº“ if ( sEnv.DYLD_INSERT_LIBRARIES != NULL ) { for (const char* const* lib = sEnv.DYLD_INSERT_LIBRARIES; *lib != NULL; ++lib) loadInsertedDylib(*lib); } // record count of inserted libraries so that a flat search will look at // inserted libraries, then main, then others. sInsertedDylibCount = sAllImages.size()-1; // link main executable gLinkContext.linkingMainExecutable = true;#if SUPPORT_ACCELERATE_TABLES if ( mainExcutableAlreadyRebased ) { // previous link() on main executable has already adjusted its internal pointers for ASLR // work around that by rebasing by inverse amount sMainExecutable-&gt;rebase(gLinkContext, -mainExecutableSlide); }#endif // ä¸»è¦åŠŸèƒ½7âƒ£ï¸ï¼šé“¾æ¥ä¸»ç¨‹åº // linkè°ƒç”¨æ¯”è¾ƒæ·±,åç»­æ¥çœ‹ link(sMainExecutable, sEnv.DYLD_BIND_AT_LAUNCH, true, ImageLoader::RPathChain(NULL, NULL), -1); sMainExecutable-&gt;setNeverUnloadRecursive(); if ( sMainExecutable-&gt;forceFlat() ) { gLinkContext.bindFlat = true; gLinkContext.prebindUsage = ImageLoader::kUseNoPrebinding; } // link any inserted libraries // do this after linking main executable so that any dylibs pulled in by inserted // dylibs (e.g. libSystem) will not be in front of dylibs the program uses // ä¸»è¦åŠŸèƒ½7âƒ£ï¸ï¼šé“¾æ¥ä¸»ç¨‹åºå’Œæ‰€æœ‰æ’å…¥çš„åŠ¨æ€åº“ if ( sInsertedDylibCount &gt; 0 ) { for(unsigned int i=0; i &lt; sInsertedDylibCount; ++i) { ImageLoader* image = sAllImages[i+1]; link(image, sEnv.DYLD_BIND_AT_LAUNCH, true, ImageLoader::RPathChain(NULL, NULL), -1); image-&gt;setNeverUnloadRecursive(); } // only INSERTED libraries can interpose // register interposing info after all inserted libraries are bound so chaining works for(unsigned int i=0; i &lt; sInsertedDylibCount; ++i) { ImageLoader* image = sAllImages[i+1]; // æ³¨å†Œç¬¦å·æ’å…¥ image-&gt;registerInterposing(gLinkContext); } } // &lt;rdar://problem/19315404&gt; dyld should support interposition even without DYLD_INSERT_LIBRARIES for (long i=sInsertedDylibCount+1; i &lt; sAllImages.size(); ++i) { ImageLoader* image = sAllImages[i]; if ( image-&gt;inSharedCache() ) continue; image-&gt;registerInterposing(gLinkContext); } #if SUPPORT_ACCELERATE_TABLES if ( (sAllCacheImagesProxy != NULL) &amp;&amp; ImageLoader::haveInterposingTuples() ) { // Accelerator tables cannot be used with implicit interposing, so relaunch with accelerator tables disabled ImageLoader::clearInterposingTuples(); // unmap all loaded dylibs (but not main executable) for (long i=1; i &lt; sAllImages.size(); ++i) { ImageLoader* image = sAllImages[i]; if ( image == sMainExecutable ) continue; if ( image == sAllCacheImagesProxy ) continue; image-&gt;setCanUnload(); ImageLoader::deleteImage(image); } // note: we don't need to worry about inserted images because if DYLD_INSERT_LIBRARIES was set we would not be using the accelerator table sAllImages.clear(); sImageRoots.clear(); sImageFilesNeedingTermination.clear(); sImageFilesNeedingDOFUnregistration.clear(); sAddImageCallbacks.clear(); sRemoveImageCallbacks.clear(); sAddLoadImageCallbacks.clear(); sDisableAcceleratorTables = true; sAllCacheImagesProxy = NULL; sMappedRangesStart = NULL; mainExcutableAlreadyRebased = true; gLinkContext.linkingMainExecutable = false; resetAllImages(); goto reloadAllImages; } #endif // apply interposing to initial set of images for(int i=0; i &lt; sImageRoots.size(); ++i) { //åº”ç”¨ç¬¦å·æ’å…¥ sImageRoots[i]-&gt;applyInterposing(gLinkContext); } ImageLoader::applyInterposingToDyldCache(gLinkContext); gLinkContext.linkingMainExecutable = false; // Bind and notify for the main executable now that interposing has been registered uint64_t bindMainExecutableStartTime = mach_absolute_time(); sMainExecutable-&gt;recursiveBindWithAccounting(gLinkContext, sEnv.DYLD_BIND_AT_LAUNCH, true); uint64_t bindMainExecutableEndTime = mach_absolute_time(); ImageLoaderMachO::fgTotalBindTime += bindMainExecutableEndTime - bindMainExecutableStartTime; gLinkContext.notifyBatch(dyld_image_state_bound, false); // Bind and notify for the inserted images now interposing has been registered if ( sInsertedDylibCount &gt; 0 ) { for(unsigned int i=0; i &lt; sInsertedDylibCount; ++i) { ImageLoader* image = sAllImages[i+1]; // é€’å½’ç»‘å®šç¬¦å·è¡¨ image-&gt;recursiveBind(gLinkContext, sEnv.DYLD_BIND_AT_LAUNCH, true); } } // &lt;rdar://problem/12186933&gt; do weak binding only after all inserted images linked // å¼±ç¬¦å·ç»‘å®š sMainExecutable-&gt;weakBind(gLinkContext); // If cache has branch island dylibs, tell debugger about them if ( (sSharedCacheLoadInfo.loadAddress != NULL) &amp;&amp; (sSharedCacheLoadInfo.loadAddress-&gt;header.mappingOffset &gt;= 0x78) &amp;&amp; (sSharedCacheLoadInfo.loadAddress-&gt;header.branchPoolsOffset != 0) ) { uint32_t count = sSharedCacheLoadInfo.loadAddress-&gt;header.branchPoolsCount; dyld_image_info info[count]; const uint64_t* poolAddress = (uint64_t*)((char*)sSharedCacheLoadInfo.loadAddress + sSharedCacheLoadInfo.loadAddress-&gt;header.branchPoolsOffset); // &lt;rdar://problem/20799203&gt; empty branch pools can be in development cache if ( ((mach_header*)poolAddress)-&gt;magic == sMainExecutableMachHeader-&gt;magic ) { for (int poolIndex=0; poolIndex &lt; count; ++poolIndex) { uint64_t poolAddr = poolAddress[poolIndex] + sSharedCacheLoadInfo.slide; info[poolIndex].imageLoadAddress = (mach_header*)(long)poolAddr; info[poolIndex].imageFilePath = &quot;dyld_shared_cache_branch_islands&quot;; info[poolIndex].imageFileModDate = 0; } // add to all_images list addImagesToAllImages(count, info); // tell gdb about new branch island images gProcessInfo-&gt;notification(dyld_image_adding, count, info); } } CRSetCrashLogMessage(&quot;dyld: launch, running initializers&quot;); // åˆå§‹åŒ–ä¸»ç¨‹åº #if SUPPORT_OLD_CRT_INITIALIZATION // Old way is to run initializers via a callback from crt1.o if ( ! gRunInitializersOldWay ) initializeMainExecutable(); #else // run all initializers // ä¸»è¦åŠŸèƒ½8âƒ£ï¸ï¼šæ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•ï¼ï¼ initializeMainExecutable(); #endif // notify any montoring proccesses that this process is about to enter main() if (dyld3::kdebug_trace_dyld_enabled(DBG_DYLD_TIMING_LAUNCH_EXECUTABLE)) { dyld3::kdebug_trace_dyld_duration_end(launchTraceID, DBG_DYLD_TIMING_LAUNCH_EXECUTABLE, 0, 0, 2); } notifyMonitoringDyldMain(); // find entry point for main executable // ä¸»è¦åŠŸèƒ½9âƒ£ï¸ï¼šå¯»æ‰¾ç›®æ ‡å¯æ‰§è¡Œæ–‡ä»¶å…¥å£å¹¶æ‰§è¡Œ // ä» mach-o ä¸­è¯»å–ç¨‹åºå…¥å£, ä¸»ç¨‹åºåˆ™è¯»å–LC_UNIXTHREAD, å°±æ˜¯ main.m result = (uintptr_t)sMainExecutable-&gt;getEntryFromLC_MAIN(); if ( result != 0 ) { // main executable uses LC_MAIN, we need to use helper in libdyld to call into main() if ( (gLibSystemHelpers != NULL) &amp;&amp; (gLibSystemHelpers-&gt;version &gt;= 9) ) *startGlue = (uintptr_t)gLibSystemHelpers-&gt;startGlueToCallExit; else halt(&quot;libdyld.dylib support not present for LC_MAIN&quot;); } else { // main executable uses LC_UNIXTHREAD, dyld needs to let &quot;start&quot; in program set up for main() // æ‰¾åˆ°çœŸæ­£ main å‡½æ•°å…¥å£ result = (uintptr_t)sMainExecutable-&gt;getEntryFromLC_UNIXTHREAD(); *startGlue = 0; }#if __has_feature(ptrauth_calls) // start() calls the result pointer as a function pointer so we need to sign it. result = (uintptr_t)__builtin_ptrauth_sign_unauthenticated((void*)result, 0, 0);#endif } catch(const char* message) { syncAllImages(); halt(message); } catch(...) { dyld::log(&quot;dyld: launch failed\\n&quot;); } CRSetCrashLogMessage(&quot;dyld2 mode&quot;); if (sSkipMain) { if (dyld3::kdebug_trace_dyld_enabled(DBG_DYLD_TIMING_LAUNCH_EXECUTABLE)) { dyld3::kdebug_trace_dyld_duration_end(launchTraceID, DBG_DYLD_TIMING_LAUNCH_EXECUTABLE, 0, 0, 2); } result = (uintptr_t)&amp;fake_main; *startGlue = (uintptr_t)gLibSystemHelpers-&gt;startGlueToCallExit; } // æ‰¾åˆ°çœŸæ­£ main å‡½æ•°å…¥å£åè¿”å› return result;} dyld::_main()ä¸»è¦æµç¨‹ä¸ºï¼š è®¾ç½®ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œæ£€æµ‹è¿›ç¨‹æ˜¯å¦å—é™ é…ç½®ç¯å¢ƒå˜é‡ï¼Œè·å–å½“å‰è¿è¡Œæ¶æ„ æ£€æŸ¥æ˜¯å¦å¼€å¯å…±äº«ç¼“å­˜ï¼Œå¹¶åŠ è½½å…±äº«ç¼“å­˜åº“ å°† dyld æœ¬èº«æ·»åŠ åˆ° UUID åˆ—è¡¨ å®ä¾‹åŒ–ä¸»ç¨‹åº åŠ è½½æ’å…¥åŠ¨æ€åº“ é“¾æ¥ä¸»ç¨‹åºå’Œæ’å…¥çš„åº“ï¼Œæ‰§è¡Œç¬¦å·æ›¿æ¢ æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³• å¯»æ‰¾ä¸»ç¨‹åºå…¥å£ 3.1 è®¾ç½®ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œæ£€æµ‹è¿›ç¨‹æ˜¯å¦å—é™ è°ƒç”¨setContextå‡½æ•°ï¼Œä¼ å…¥Mach-Oå¤´éƒ¨ä»¥åŠä¸€äº›å‚æ•°è®¾ç½®ä¸Šä¸‹æ–‡ configureProcessRestrictionsæ£€æµ‹è¿›ç¨‹æ˜¯å¦å—é™ï¼Œåœ¨ä¸Šä¸‹æ–‡ä¸­åšå‡ºå¯¹åº”å¤„ç† 1234/// _mainå‡½æ•°ä¸­setContext(mainExecutableMH, argc, argv, envp, apple);...configureProcessRestrictions(mainExecutableMH); 3.2 é…ç½®ç¯å¢ƒå˜é‡ï¼Œè·å–å½“å‰è¿è¡Œæ¶æ„ ä»ç¯å¢ƒå˜é‡ä¸­è·å–ä¸»è¦å¯æ‰§è¡Œæ–‡ä»¶çš„cdHash checkEnvironmentVariables(envp)æ£€æŸ¥è®¾ç½®ç¯å¢ƒå˜é‡ defaultUninitializedFallbackPaths(envp)åœ¨DYLD_FALLBACKä¸ºç©ºæ—¶è®¾ç½®é»˜è®¤å€¼ getHostInfo(mainExecutableMH, mainExecutableSlide)è·å–ç¨‹åºæ¶æ„ 1234567/// _mainå‡½æ•°ä¸­//å¦‚æœè®¾ç½®äº†DYLD_PRINT_OPTSç¯å¢ƒå˜é‡ï¼Œåˆ™æ‰“å°å‚æ•°if ( sEnv.DYLD_PRINT_OPTS ) printOptions(argv);//å¦‚æœè®¾ç½®äº†DYLD_PRINT_ENVç¯å¢ƒå˜é‡ï¼Œåˆ™æ‰“å°ç¯å¢ƒå˜é‡if ( sEnv.DYLD_PRINT_ENV ) printEnvironmentVariables(envp); åªè¦è®¾ç½®äº†è¿™ä¸¤ä¸ªç¯å¢ƒå˜é‡å‚æ•°ï¼Œåœ¨Appå¯åŠ¨æ—¶å°±ä¼šæ‰“å°ç›¸å…³å‚æ•°ã€ç¯å¢ƒå˜é‡ä¿¡æ¯ï¼ˆè‡ªè¡Œå°è¯•ï¼‰ 3.3 æ£€æŸ¥æ˜¯å¦å¼€å¯å…±äº«ç¼“å­˜ï¼Œå¹¶åŠ è½½å…±äº«ç¼“å­˜åº“ checkSharedRegionDisableæ£€æŸ¥æ˜¯å¦å¼€å¯å…±äº«ç¼“å­˜ï¼ˆiOS ä¸‹ä¸ä¼šè¢«ç¦ç”¨ï¼‰ mapSharedCacheåŠ è½½å…±äº«ç¼“å­˜åº“ï¼Œå…¶ä¸­è°ƒç”¨loadDyldCacheå‡½æ•°æœ‰è¿™ä¹ˆå‡ ç§æƒ…å†µï¼š ä»…åŠ è½½åˆ°å½“å‰è¿›ç¨‹mapCachePrivateï¼ˆæ¨¡æ‹Ÿå™¨ä»…æ”¯æŒåŠ è½½åˆ°å½“å‰è¿›ç¨‹ï¼‰ å…±äº«ç¼“å­˜æ˜¯ç¬¬ä¸€æ¬¡è¢«åŠ è½½ï¼Œå°±å»åšåŠ è½½æ“ä½œmapCacheSystemWide å…±äº«ç¼“å­˜ä¸æ˜¯ç¬¬ä¸€æ¬¡è¢«åŠ è½½ï¼Œé‚£ä¹ˆå°±ä¸åšä»»ä½•å¤„ç† 3.4 å°†dyldæœ¬èº«æ·»åŠ åˆ°UUIDåˆ—è¡¨addDyldImageToUUIDListå°†dyldæœ¬èº«æ·»åŠ åˆ°UUIDåˆ—è¡¨ 3.5 å®ä¾‹åŒ–ä¸»ç¨‹åº1sMainExecutable = instantiateFromLoadedImage(mainExecutableMH, mainExecutableSlide, sExecPath); å®ä¾‹åŒ–ä¸»ç¨‹åº , æ£€æµ‹å¯æ‰§è¡Œç¨‹åºæ ¼å¼ . 1234567891011static ImageLoaderMachO* instantiateFromLoadedImage(const macho_header* mh, uintptr_t slide, const char* path){ // try mach-o loader if ( isCompatibleMachO((const uint8_t*)mh, path) ) { ImageLoader* image = ImageLoaderMachO::instantiateMainExecutable(mh, slide, path, gLinkContext); addImage(image); return (ImageLoaderMachO*)image; } throw &quot;main executable not a known format&quot;;} isCompatibleMachO é‡Œå°±ä¼šé€šè¿‡ header é‡Œçš„ magic , cputype , cpusubtype å»æ£€æµ‹æ˜¯å¦å…¼å®¹ instantiateMainExecutableä¸­è°ƒç”¨ImageLoaderMachO::sniffLoadCommandsï¼Œè¿™æ‰æ˜¯çœŸæ­£å®ä¾‹åŒ–ä¸»ç¨‹åºçš„å‡½æ•° 1234567891011121314151617181920212223242526// determine if this mach-o file has classic or compressed LINKEDIT and number of segments it hasvoid ImageLoaderMachO::sniffLoadCommands(const macho_header* mh, const char* path, bool inCache, bool* compressed, unsigned int* segCount, unsigned int* libCount, const LinkContext&amp; context, const linkedit_data_command** codeSigCmd, const encryption_info_command** encryptCmd){ *compressed = false; *segCount = 0; *libCount = 0; *codeSigCmd = NULL; *encryptCmd = NULL; /* ... */ // fSegmentsArrayCount is only 8-bits if ( *segCount &gt; 255 ) dyld::throwf(&quot;malformed mach-o image: more than 255 segments in %s&quot;, path); // fSegmentsArrayCount is only 8-bits if ( *libCount &gt; 4095 ) dyld::throwf(&quot;malformed mach-o image: more than 4095 dependent libraries in %s&quot;, path); if ( needsAddedLibSystemDepency(*libCount, mh) ) *libCount = 1; ...} è¿™é‡Œå‡ ä¸ªå­—æ®µéƒ½ä¸MachOæœ‰å…³ï¼š compressedï¼šæ ¹æ®LC_DYLD_INFO_ONYLæ¥å†³å®š segCount: MachOæ–‡ä»¶ä¸­segmentæ•°é‡ï¼Œæœ€å¤šä¸è¶…è¿‡255ä¸ª libCount: MachOæ–‡ä»¶ä¸­ä¾èµ–çš„åŠ¨æ€åº“çš„æ•°é‡ codeSigCmd: ç­¾åä¿¡æ¯ encryptCmd: åŠ å¯†ä¿¡æ¯ï¼Œå¦‚cryptidç­‰ ç»è¿‡ä»¥ä¸Šæ­¥éª¤ , ä¸»ç¨‹åºçš„å®ä¾‹åŒ–å°±å·²ç»å®Œæˆäº† 3.6 åŠ è½½æ’å…¥åŠ¨æ€åº“123456/// _mainå‡½æ•°ä¸­// load any inserted librariesif ( sEnv.DYLD_INSERT_LIBRARIES != NULL ) { for (const char* const* lib = sEnv.DYLD_INSERT_LIBRARIES; *lib != NULL; ++lib) loadInsertedDylib(*lib);} éå†DYLD_INSERT_LIBRARIESç¯å¢ƒå˜é‡ï¼Œè°ƒç”¨loadInsertedDylibåŠ è½½ï¼Œé€šè¿‡è¯¥ç¯å¢ƒå˜é‡æˆ‘ä»¬å¯ä»¥æ³¨å…¥è‡ªå®šä¹‰çš„ä¸€äº›åŠ¨æ€åº“ä»£ç ä»è€Œå®Œæˆå®‰å…¨æ”»é˜²ï¼ŒloadInsertedDylibå†…éƒ¨ä¼šä»DYLD_ROOT_PATHã€LD_LIBRARY_PATHã€DYLD_FRAMEWORK_PATHç­‰è·¯å¾„æŸ¥æ‰¾dylibå¹¶ä¸”æ£€æŸ¥ä»£ç ç­¾åï¼Œæ— æ•ˆåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ 3.7 é“¾æ¥ä¸»ç¨‹åºå’Œæ’å…¥çš„åº“ï¼Œæ‰§è¡Œç¬¦å·æ›¿æ¢123456789101112131415161718192021// link main executablegLinkContext.linkingMainExecutable = true;link(sMainExecutable, sEnv.DYLD_BIND_AT_LAUNCH, true, ImageLoader::RPathChain(NULL, NULL), -1);sMainExecutable-&gt;setNeverUnloadRecursive();if ( sMainExecutable-&gt;forceFlat() ) { gLinkContext.bindFlat = true; gLinkContext.prebindUsage = ImageLoader::kUseNoPrebinding;}if ( sInsertedDylibCount &gt; 0 ) { for(unsigned int i=0; i &lt; sInsertedDylibCount; ++i) { ImageLoader* image = sAllImages[i+1]; link(image, sEnv.DYLD_BIND_AT_LAUNCH, true, ImageLoader::RPathChain(NULL, NULL), -1); image-&gt;setNeverUnloadRecursive(); } for(unsigned int i=0; i &lt; sInsertedDylibCount; ++i) { ImageLoader* image = sAllImages[i+1]; image-&gt;registerInterposing(gLinkContext); }} ç‚¹å‡»è¿›å…¥ link å‡½æ•° , link å‡½æ•°ä¸­æœ‰ä¸€ç³»åˆ— recursiveLoadLibraries , recursiveBindWithAccounting -&gt; recursiveBind , ä¹Ÿå°±æ˜¯é€’å½’è¿›è¡Œç¬¦å·ç»‘å®šçš„è¿‡ç¨‹ . link å‡½æ•°æ‰§è¡Œå®Œæ¯•ä¹‹å , dyld :: main ä¼šè°ƒç”¨ sMainExecutable-&gt;weakBind(gLinkContext); è¿›è¡Œå¼±ç»‘å®š , æ‡’åŠ è½½ç»‘å®š , ä¹Ÿå°±æ˜¯è¯´å¼±ç»‘å®šä¸€å®šå‘ç”Ÿåœ¨ å…¶ä»–åº“é“¾æ¥ç»‘å®šå®Œæˆä¹‹å . ç»‘å®šçš„è¿‡ç¨‹å°±æ˜¯æˆ‘ä»¬ä¹‹å‰åˆ†æçš„å…±äº«ç¼“å­˜ç»‘å®šçš„è¿‡ç¨‹ . èµ°åˆ°äº†è¿™é‡Œ , ä¸»ç¨‹åºå·²ç»å®ä¾‹åŒ–å®Œæ¯• , ä½†è¿˜æ²¡æœ‰åŠ è½½ , framework å·²ç»åŠ è½½å®Œæ¯•äº† , é‚£è®²åˆ°è¿™æ’ä¸€å¥é¢˜å¤–è¯ , ä¸åŒ framework , è°å…ˆä¼šè¢«åŠ è½½ ? å…¶å®æ ¹æ®äºŒè¿›åˆ¶é¡ºåºæœ‰å…³ , Xcode ä¸­å¯ä»¥è‡ªç”±è°ƒæ•´ : æ‹–åŠ¨å°±å¯ä»¥è‡ªå·±è°ƒæ•´é¡ºåºäº† , ç¼–è¯‘é¡ºåºå°±ä¼šæ ¹æ®è¿™ä¸ªé¡ºåºæ¥ , åŒæ ·ä½ å¯ä»¥ä½¿ç”¨ MachOView æ¥æŸ¥çœ‹äºŒè¿›åˆ¶é¡ºåº . è‡³æ­¤ , é…ç½®ç¯å¢ƒå˜é‡ -&gt; åŠ è½½å…±äº«ç¼“å­˜ -&gt; å®ä¾‹åŒ–ä¸»ç¨‹åº -&gt; åŠ è½½åŠ¨æ€åº“ -&gt; é“¾æ¥åŠ¨æ€åº“ å°±å·²ç»å®Œæˆäº† . æ¥ä¸‹æ¥æ˜¯é‡ä¸­ä¹‹é‡ 3.8 æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•å›é¡¾ä¸€ä¸‹å‡½æ•°è°ƒç”¨æ ˆï¼š â‘ initializeMainExecutableæ–¹æ³•è°ƒç”¨runInitializers 12345678910111213141516171819202122232425262728void initializeMainExecutable(){ // record that we've reached this step gLinkContext.startedInitializingMainExecutable = true; // run initialzers for any inserted dylibs ImageLoader::InitializerTimingList initializerTimes[allImagesCount()]; initializerTimes[0].count = 0; const size_t rootCount = sImageRoots.size(); if ( rootCount &gt; 1 ) { for(size_t i=1; i &lt; rootCount; ++i) { sImageRoots[i]-&gt;runInitializers(gLinkContext, initializerTimes[0]); } } // run initializers for main executable and everything it brings up sMainExecutable-&gt;runInitializers(gLinkContext, initializerTimes[0]); // register cxa_atexit() handler to run static terminators in all loaded images when this process exits if ( gLibSystemHelpers != NULL ) (*gLibSystemHelpers-&gt;cxa_atexit)(&amp;runAllStaticTerminators, NULL, NULL); // dump info if requested if ( sEnv.DYLD_PRINT_STATISTICS ) ImageLoader::printStatistics((unsigned int)allImagesCount(), initializerTimes[0]); if ( sEnv.DYLD_PRINT_STATISTICS_DETAILS ) ImageLoaderMachO::printStatisticsDetails((unsigned int)allImagesCount(), initializerTimes[0]);} â‘¡runInitializersè°ƒç”¨processInitializersä¸ºåˆå§‹åŒ–åšå‡†å¤‡ 12345678910111213void ImageLoader::runInitializers(const LinkContext&amp; context, InitializerTimingList&amp; timingInfo){ uint64_t t1 = mach_absolute_time(); mach_port_t thisThread = mach_thread_self(); ImageLoader::UninitedUpwards up; up.count = 1; up.images[0] = this; processInitializers(context, thisThread, timingInfo, up); context.notifyBatch(dyld_image_state_initialized, false); mach_port_deallocate(mach_task_self(), thisThread); uint64_t t2 = mach_absolute_time(); fgTotalInitTime += (t2 - t1);} â‘¢processInitializersä¸­éå†imageï¼ŒrecursiveInitializationé€’å½’åˆå§‹åŒ–é•œåƒ 12345678910111213141516void ImageLoader::processInitializers(const LinkContext&amp; context, mach_port_t thisThread, InitializerTimingList&amp; timingInfo, ImageLoader::UninitedUpwards&amp; images){ uint32_t maxImageCount = context.imageCount()+2; ImageLoader::UninitedUpwards upsBuffer[maxImageCount]; ImageLoader::UninitedUpwards&amp; ups = upsBuffer[0]; ups.count = 0; // Calling recursive init on all images in images list, building a new list of // uninitialized upward dependencies. for (uintptr_t i=0; i &lt; images.count; ++i) { images.images[i]-&gt;recursiveInitialization(context, thisThread, images.images[i]-&gt;getPath(), timingInfo, ups); } // If any upward dependencies remain, init them. if ( ups.count &gt; 0 ) processInitializers(context, thisThread, timingInfo, ups);} ç‚¹è¿›å»å´åªæœ‰å£°æ˜ï¼Œshift+cmd+Oæœç´¢recursiveInitialization â‘£recursiveInitializationè·å–åˆ°é•œåƒçš„åˆå§‹åŒ– 1234567891011121314151617void ImageLoader::recursiveInitialization(const LinkContext&amp; context, mach_port_t this_thread, const char* pathToInitialize, InitializerTimingList&amp; timingInfo, UninitedUpwards&amp; uninitUps){ ... uint64_t t1 = mach_absolute_time(); fState = dyld_image_state_dependents_initialized; oldState = fState; context.notifySingle(dyld_image_state_dependents_initialized, this, &amp;timingInfo); // initialize this image bool hasInitializers = this-&gt;doInitialization(context); // let anyone know we finished initializing this image fState = dyld_image_state_initialized; oldState = fState; context.notifySingle(dyld_image_state_initialized, this, NULL); ...} â‘¤notifySingleè·å–åˆ°é•œåƒçš„å›è°ƒ 1234567891011121314151617static void notifySingle(dyld_image_states state, const ImageLoader* image, ImageLoader::InitializerTimingList* timingInfo){ ... if ( (state == dyld_image_state_dependents_initialized) &amp;&amp; (sNotifyObjCInit != NULL) &amp;&amp; image-&gt;notifyObjC() ) { uint64_t t0 = mach_absolute_time(); dyld3::ScopedTimer timer(DBG_DYLD_TIMING_OBJC_INIT, (uint64_t)image-&gt;machHeader(), 0, 0); (*sNotifyObjCInit)(image-&gt;getRealPath(), image-&gt;machHeader()); uint64_t t1 = mach_absolute_time(); uint64_t t2 = mach_absolute_time(); uint64_t timeInObjC = t1-t0; uint64_t emptyTime = (t2-t1)*100; if ( (timeInObjC &gt; emptyTime) &amp;&amp; (timingInfo != NULL) ) { timingInfo-&gt;addTime(image-&gt;getShortName(), timeInObjC); } } ...} notifySingleä¸­å¹¶æ²¡æœ‰æ‰¾åˆ°å‡½æ•°è°ƒç”¨æ ˆä¸­çš„load_imagesï¼Œå…¶å®è¿™æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°çš„è°ƒç”¨ ã€â‘¥ã€‘sNotifyObjCInitåœ¨registerObjCNotifierså‡½æ•°ä¸­èµ‹å€¼ 1234567void registerObjCNotifiers(_dyld_objc_notify_mapped mapped, _dyld_objc_notify_init init, _dyld_objc_notify_unmapped unmapped){ // record functions to call sNotifyObjCMapped = mapped; sNotifyObjCInit = init; sNotifyObjCUnmapped = unmapped;} â‘¦registerObjCNotifiersåœ¨_dyld_objc_notify_registerå‡½æ•°ä¸­è¢«è°ƒç”¨ï¼Œè¿™ä¸ªå‡½æ•°åªåœ¨è¿è¡Œæ—¶æä¾›ç»™objcä½¿ç”¨ 1234567891011121314151617181920212223void _dyld_objc_notify_register(_dyld_objc_notify_mapped mapped, _dyld_objc_notify_init init, _dyld_objc_notify_unmapped unmapped){ dyld::registerObjCNotifiers(mapped, init, unmapped);}// _objc_init è°ƒç”¨`_dyld_objc_notify_register`ï¼Œå¹¶è°ƒç”¨`load_image`void _objc_init(void){ static bool initialized = false; if (initialized) return; initialized = true; // fixme defer initialization until an objc-using image is found? environ_init(); tls_init(); static_init(); lock_init(); exception_init(); _dyld_objc_notify_register(&amp;map_images, load_images, unmap_image);} â‘§context.notifySingleä¹‹åï¼Œè°ƒç”¨ImageLoaderMachO::doInitializationï¼Œå†…éƒ¨è°ƒç”¨ doImageInit ImageLoaderMachO::doModInitFunctions â‘¨doImageInit-&gt;libSystemInitialized-&gt;ã€æ ¹æ®libObjcæºç åˆ†æå¾—åˆ°ã€‘libdispatch_init-&gt;_os_object_initï¼Œå†…éƒ¨è°ƒç”¨_objc_init éªŒè¯ï¼š æˆ‘ä»¬ç›´æ¥é€šè¿‡ LLDB å¤§æ³•æ¥æ–­ç‚¹è°ƒè¯• libObjc æºç ä¸­çš„ _objc_initï¼Œç„¶åé€šè¿‡ bt å‘½ä»¤æ‰“å°å‡ºå½“å‰çš„è°ƒç”¨å †æ ˆï¼Œæ­¤åˆ»ä¸€åˆ‡çš„ä¸€åˆ‡éƒ½æ˜¯é‚£ä¹ˆçš„æ¸…æ™°æ˜äº†ï¼š â‘©doModInitFunctionså†…éƒ¨è°ƒç”¨__mod_init_funcs sectionï¼Œä¹Ÿå°±æ˜¯constructoræ–¹æ³•â€”â€”C++æ„é€ æ–¹æ³• initializeMainExecutableæ€»ç»“ï¼š runInitializers-&gt;processInitializersä¸­ï¼Œéå†recursiveInitialization ç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶ï¼Œè¿›è¡Œlibsystemåˆå§‹åŒ–â€”â€”doInitialization-&gt;doImageInit-&gt; libSystemInitialized libsystemçš„åˆå§‹åŒ–ï¼Œä¼šè°ƒç”¨èµ·libdispatch_initï¼Œlibdispatchåˆå§‹åŒ–ä¼šè°ƒç”¨_os_object_initï¼Œ å†…éƒ¨è°ƒç”¨äº†_objc_init _objc_initä¸­æ³¨å†Œå¹¶ä¿å­˜äº†map_imagesã€load_imagesã€unmap_imageå‡½æ•°åœ°å€ æ³¨å†Œå®Œæ¯•ç»§ç»­å›åˆ°recursiveInitializationé€’å½’ä¸‹ä¸€æ¬¡è°ƒç”¨ 3.9 å¯»æ‰¾ä¸»ç¨‹åºå…¥å£12// find entry point for main executableresult = (uintptr_t)sMainExecutable-&gt;getEntryFromLC_MAIN(); å››ã€dyldåŠ è½½è¿‡ç¨‹ç¤ºæ„å›¾ dyldåŠ è½½æµç¨‹ä»£ç è¾ƒå¤šï¼Œç¬¬ä¸€æ¬¡çœ‹å¤§æ¦‚äº†è§£è¿™ä¸ªè¿‡ç¨‹å³å¯ äº”ã€æ€»ç»“ PSæˆ‘çš„dyldæºç (ç‰ˆæœ¬ï¼šdyld-635.2) å‚è€ƒiOSæ¢ç´¢ æµ…å°è¾„æ­¢dyldåŠ è½½æµç¨‹ æ›´æ·±å…¥ï¼šiOS åº•å±‚ - ä»å¤´æ¢³ç† dyld åŠ è½½æµç¨‹ iOS åº•å±‚æ¢ç´¢ - åº”ç”¨åŠ è½½","link":"/2021/01/16/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/07%E4%B8%8B-dyld%E5%88%86%E6%9E%90/"},{"title":"09-åˆ†ç±»ã€ç±»æ‹“å±•çš„åŠ è½½è¿‡ç¨‹ &amp; loadã€initializeåˆ†æ","text":"å‰è¨€åœ¨å¼€å§‹æ­£æ–‡å‰ï¼Œå…ˆçœ‹ä¸€ä¸‹runtimeç›¸å…³çŸ¥è¯†çš„è¿ç”¨ roå’Œrwè¡ç”Ÿå‡ºæ¥çš„é—®é¢˜1.åŠ¨æ€åˆ›å»ºç±»çš„æ—¶å€™ï¼Œèƒ½å¦å…ˆæ³¨å†Œåˆ°å†…å­˜ç„¶åå†æ·»åŠ æˆå‘˜å˜é‡ï¼Ÿå³ä¸‹é¢2ã€3ä¸¤æ­¥èƒ½å¦è°ƒæ¢é¡ºåºï¼Ÿ 1234567// è¿™æ˜¯æ­£ç¡®é¡ºåºï¼š// 1: åŠ¨æ€åˆ›å»ºç±»Class LGPerson = objc_allocateClassPair([NSObject class], &quot;LGPerson&quot;, 0);// 2: æ·»åŠ æˆå‘˜å˜é‡ class_addIvar(LGPerson, &quot;lgName&quot;, sizeof(NSString *), log2(sizeof(NSString *)), &quot;@&quot;);// 3: æ³¨å†Œåˆ°å†…å­˜objc_registerClassPair(LGPerson); ç­”ï¼šä¸å¯ä»¥ åŸå› ï¼š æˆå‘˜å˜é‡å­˜å‚¨åœ¨roå½“ä¸­ï¼Œroåœ¨ç¼–è¯‘åå°±ä¸èƒ½æ”¹äº†ã€‚è·Ÿå±æ€§ä¸ä¸€æ · å¯ä»¥é€šè¿‡è·‘æºç æ–­ç‚¹è°ƒè¯•çœ‹ä¸€ä¸‹ï¼š æ³¨å†Œåˆ°å†…å­˜çš„objc_registerClassPairæ–¹æ³•ä¸­ä¼šè°ƒç”¨changeInfoæ–¹æ³•ï¼Œæ”¹å˜äº†ä¿¡æ¯ã€‚å¦‚æœåœ¨è¿™ä¹‹åè°ƒç”¨class_addIvaræ–¹æ³•ï¼Œä¼šèµ°åˆ°åˆ†æ”¯ä¸­ï¼Œç›´æ¥è¿”å›NOï¼Œå¯¼è‡´æ·»åŠ å¤±è´¥ã€‚å› æ­¤é¡ºåºä¸èƒ½è°ƒæ¢ã€‚ 2.æ³¨æ„ç‚¹ï¼šåŠ¨æ€æ·»åŠ property(æˆå‘˜å±æ€§)åï¼Œè®°å¾—è¦æ·»åŠ ç›¸åº”çš„getterå’Œsetteræ–¹æ³•ï¼Œå¦åˆ™ç»™å±æ€§è®¾å€¼ä¼šä¸æˆåŠŸã€‚ 123456789101112131415// 1.åŠ¨æ€åˆ›å»ºç±»Class LGPerson = objc_allocateClassPair([NSObject class], &quot;LGPerson&quot;, 0);// 2.æ³¨å†Œåˆ°å†…å­˜objc_registerClassPair(LGPerson);// 3.æ·»åŠ propertylg_class_addProperty(LGPerson, &quot;subject&quot;);// 4.æ·»åŠ setter + getter æ–¹æ³•class_addMethod(LGPerson, @selector(setSubject:), (IMP)lgSetter, &quot;v@:@&quot;);class_addMethod(LGPerson, @selector(subject), (IMP)lgName, &quot;@@:&quot;);// å¼€å§‹ä½¿ç”¨id person = [LGPerson alloc];[person setValue:@&quot;master&quot; forKey:@&quot;subject&quot;];NSLog(@&quot;%@&quot;,[person valueForKey:@&quot;subject&quot;]); ç•™æ„è¿™é‡Œçš„2ã€3ä¸¤æ­¥ï¼Œå…ˆæ³¨å†Œåˆ°å†…å­˜ï¼Œç„¶åå†æ·»åŠ çš„æˆå‘˜å±æ€§ï¼Œä¸ºä»€ä¹ˆè¿™é‡Œå°±å¯ä»¥äº†ï¼Ÿ å› ä¸ºpropertieså­˜å‚¨åœ¨rwå½“ä¸­ï¼Œæ˜¯å¯ä»¥åŠ¨æ€æ”¹å˜çš„ã€‚ 3.ç»ƒä¹ ä½¿ç”¨api-ç”¨runtimeåŠ¨æ€åˆ›å»ºç±» 12345678910111213141516171819202122232425// 1: åŠ¨æ€åˆ›å»ºç±»Class LGPerson = objc_allocateClassPair([NSObject class], &quot;LGPerson&quot;, 0);// 2: æ·»åŠ æˆå‘˜å˜é‡ class_addIvar(LGPerson, &quot;lgName&quot;, sizeof(NSString *), log2(sizeof(NSString *)), &quot;@&quot;);// 3: æ³¨å†Œåˆ°å†…å­˜objc_registerClassPair(LGPerson); // 3.1 æ·»åŠ property - rwlg_class_addProperty(LGPerson, &quot;subject&quot;);lg_printerProperty(LGPerson);// 3.2 æ·»åŠ setter + getter æ–¹æ³•class_addMethod(LGPerson, @selector(setSubject:), (IMP)lgSetter, &quot;v@:@&quot;);class_addMethod(LGPerson, @selector(subject), (IMP)lgName, &quot;@@:&quot;);// å¼€å§‹ä½¿ç”¨id person = [LGPerson alloc];[person setValue:@&quot;KC&quot; forKey:@&quot;lgName&quot;];NSLog(@&quot;%@&quot;,[person valueForKey:@&quot;lgName&quot;]);[person setValue:@&quot;master&quot; forKey:@&quot;subject&quot;];NSLog(@&quot;%@&quot;,[person valueForKey:@&quot;subject&quot;]); å¸¦æ³¨é‡Šçš„ç›¸å…³api 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758/** * åˆ›å»ºç±»å¯¹ *superClass: çˆ¶ç±»ï¼Œä¼ Nilä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ ¹ç±» *name: ç±»å *extraBytes: 0 *return:è¿”å›æ–°ç±»ï¼Œåˆ›å»ºå¤±è´¥è¿”å›Nilï¼Œå¦‚æœç±»åå·²ç»å­˜åœ¨ï¼Œåˆ™åˆ›å»ºå¤±è´¥ objc_allocateClassPair(&lt;#Class _Nullable __unsafe_unretained superclass#&gt;, &lt;#const char * _Nonnull name#&gt;, &lt;#size_t extraBytes#&gt;) *//** *æ·»åŠ æˆå‘˜å˜é‡ * *cls å¾€å“ªä¸ªç±»æ·»åŠ  *name æ·»åŠ çš„åå­— *size å¤§å° *alignment å¯¹é½å¤„ç†æ–¹å¼ *types ç­¾å * *è¿™ä¸ªå‡½æ•°åªèƒ½åœ¨objc_allocateClassPairå’Œobjc_registerClassPairä¹‹å‰è°ƒç”¨ã€‚ä¸æ”¯æŒå‘ç°æœ‰ç±»æ·»åŠ ä¸€ä¸ªå®ä¾‹å˜é‡ã€‚ *è¿™ä¸ªç±»ä¸èƒ½æ˜¯å…ƒç±»ã€‚ä¸æ”¯æŒåœ¨å…ƒç±»ä¸­æ·»åŠ ä¸€ä¸ªå®ä¾‹å˜é‡ã€‚ *å®ä¾‹å˜é‡çš„æœ€å°å¯¹é½ä¸º1 &lt;&lt; alignã€‚å®ä¾‹å˜é‡çš„æœ€å°å¯¹é½ä¾èµ–äºivarçš„ç±»å‹å’Œæœºå™¨æ¶æ„ã€‚å¯¹äºä»»ä½•æŒ‡é’ˆç±»å‹çš„å˜é‡ï¼Œè¯·é€šè¿‡log2(sizeof(pointer_type))ã€‚ class_addIvar(&lt;#Class _Nullable __unsafe_unretained cls#&gt;, &lt;#const char * _Nonnull name#&gt;, &lt;#size_t size#&gt;, &lt;#uint8_t alignment#&gt;, &lt;#const char * _Nullable types#&gt;) *//** *å¾€å†…å­˜æ³¨å†Œç±» * * cls è¦æ³¨å†Œçš„ç±» * * objc_registerClassPair(&lt;#Class _Nonnull __unsafe_unretained cls#&gt;) *//** *å¾€ç±»é‡Œé¢æ·»åŠ æ–¹æ³• * *cls è¦æ·»åŠ æ–¹æ³•çš„ç±» *sel æ–¹æ³•ç¼–å· *imp å‡½æ•°å®ç°æŒ‡é’ˆ *types ç­¾å * *class_addMethod(&lt;#Class _Nullable __unsafe_unretained cls#&gt;, &lt;#SEL _Nonnull name#&gt;, &lt;#IMP _Nonnull imp#&gt;, &lt;#const char * _Nullable types#&gt;) *//** *å¾€ç±»é‡Œé¢æ·»åŠ å±æ€§ * *cls è¦æ·»åŠ å±æ€§çš„ç±» *name å±æ€§åå­— *attributes å±æ€§çš„å±æ€§æ•°ç»„ã€‚ *attriCount å±æ€§ä¸­å±æ€§çš„æ•°é‡ã€‚ * *class_addProperty(&lt;#Class _Nullable __unsafe_unretained cls#&gt;, &lt;#const char * _Nonnull name#&gt;, &lt;#const objc_property_attribute_t * _Nullable attributes#&gt;, &lt;#unsigned int attributeCount#&gt;) */ ä¸€ã€åˆæ¢æ‡’åŠ è½½ç±»ä¸Šä¸€ç« æˆ‘ä»¬æ¢ç´¢äº† iOS ä¸­ç±»çš„åŠ è½½ï¼Œè®©æˆ‘ä»¬ç®€å•å›é¡¾ä¸€ä¸‹å¤§æ¦‚çš„æµç¨‹ã€‚ 1.1 ç±»çš„åŠ è½½å›é¡¾ libObjc å‘ dyld æ³¨å†Œäº†å›è°ƒ _dyld_objc_notify_registerï¼Œå½“ dyld æŠŠ App ä»¥åŠ App æ‰€ä¾èµ–çš„ä¸€ç³»åˆ— Mach-O é•œåƒåŠ è½½åˆ°å½“å‰ App è¢«åˆ†é…çš„å†…å­˜ç©ºé—´ä¹‹åï¼Œdyld ä¼šé€šè¿‡ _dyld_objc_notify_mapped ä¹Ÿå°±æ˜¯ map_imagesæ¥é€šçŸ¥ libObjc æ¥å®Œæˆå…·ä½“çš„åŠ è½½å·¥ä½œï¼Œmap_images è¢«è°ƒç”¨ä¹‹åä¼šæ¥åˆ° _read_images _read_images ä¸»è¦ä¼šè¿›è¡Œç±»çš„åŠ è½½å·¥ä½œï¼Œä¼šæ’å…¥ æ‰€æœ‰çš„ç±» åˆ° gdb_objc_realized_classes å“ˆå¸Œè¡¨ä¸­ï¼ˆæ’å…¥æ–¹å¼ä¸º ç±»åä¸º keyï¼Œç±»å¯¹è±¡ä¸ºvalue, ä¸åŒ…æ‹¬é€šè¿‡ å…±äº«ç¼“å­˜ é‡Œé¢çš„ç±»ï¼‰ï¼Œè¿™ä¸ªè¡¨çš„ç±»å‹ä¸º NXMapTableï¼Œå¯ä»¥ç±»æ¯”ä¸º NSDictionaryï¼›åŒæ—¶è¿˜ä¼šæŠŠç±»æ’å…¥åˆ° allocatedClasses è¿™ä¸ªé›†åˆé‡Œé¢ï¼Œé›†åˆçš„ç±»å‹ä¸º NXHashTableï¼Œå¯ä»¥ç±»æ¯”ä¸º NSSetã€‚ å¯¹æ‰€æœ‰çš„ç±»è¿›è¡Œé‡æ˜ å°„ å°†æ‰€æœ‰çš„ SEL æ’å…¥åˆ° namedSelectors å“ˆå¸Œè¡¨ä¸­(æ’å…¥æ–¹å¼ä¸ºï¼šSEL åç§°ä¸º keyï¼ŒSEL ä¸ºvalue) ä¿®å¤å‡½æ•°æŒ‡é’ˆé—ç•™ å°†æ‰€æœ‰çš„ Protocol æ’å…¥åˆ° readProtocol å“ˆå¸Œè¡¨ä¸­(æ’å…¥æ–¹å¼ä¸ºï¼šProtocol åç§°ä¸º keyï¼ŒProtocol ä¸º value) å¯¹æ‰€æœ‰çš„ Protocol åšé‡æ˜ å°„ åˆå§‹åŒ–æ‰€æœ‰çš„éæ‡’åŠ è½½ç±»ï¼ŒåŒ…æ‹¬ rw å’Œ ro çš„åˆå§‹åŒ–æ“ä½œ å¤„ç†æ‰€æœ‰çš„åˆ†ç±»(åŒ…æ‹¬ç±»çš„åˆ†ç±»å’Œå…ƒç±»çš„åˆ†ç±») 1.2 éªŒè¯ç±»çš„åŠ è½½æµç¨‹æˆ‘ä»¬å¤§è‡´æ˜ç™½äº†ç±»çš„åŠ è½½æµç¨‹ï¼Œæ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬åœ¨ _read_images æºç ä¸­æ‰“å°ä¸€ä¸‹ç±»åŠ è½½ä¹‹åçš„ç»“æœéªŒè¯ä¸€ä¸‹æ˜¯å¦åŠ è½½äº†æˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„ç±»ã€‚ å‡†å¤‡ä»£ç ï¼šæœ‰ä¸‰ä¸ªéå¸¸çº¯å‡€çš„ç±»ï¼š LGPerson ã€ LGStudent ã€ LGTeacher å…¶ä¸­ LGStudent å’Œ LGTeacher å†…éƒ¨å®ç°äº† +load æ–¹æ³•ã€‚è€Œ LGPerson æ²¡æœ‰å®ç° +load æ–¹æ³•ã€‚ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å¢åŠ ä¸€è¡Œä»£ç : 1printf(&quot;_getObjc2NonlazyClassList Class:%s\\n&quot;,cls-&gt;mangledName()); æ¥ç€æˆ‘ä»¬è§‚å¯Ÿæ‰“å°ç»“æœ: 1.3 æ‡’åŠ è½½ç±»çš„å‘ç°æˆ‘ä»¬è¿™ä¸ªæ—¶å€™è§‚å¯Ÿ _read_images æºç è¿™éƒ¨åˆ†çš„æ³¨é‡Š: Realize non-lazy classes (for +load methods and static instances) å®ç°éæ‡’åŠ è½½ç±»(å®ç°äº† +load æ–¹æ³•å’Œé™æ€å®ä¾‹) æ„æ€å°±æ˜¯æ²¡æœ‰å®ç° +load æ–¹æ³•çš„ç±»å°±æ˜¯**æ‡’åŠ è½½ç±»ï¼Œè¿™ç§ç±»å¹¶ä¸ä¼šåœ¨ **_read_images ç¯èŠ‚è¢«åŠ è½½ã€‚æˆ‘ä»¬è‡ªå·±å®ç°äº† +load æ–¹æ³•çš„ä¸¤ä¸ªç±»å’Œå…¶ä»–ç³»ç»Ÿå†…ç½®çš„ç±»ç”±äºæ˜¯éæ‡’åŠ è½½ç±»ï¼Œæ‰€ä»¥ä¼šåœ¨è¿™é‡Œæ‰“å°ã€‚ é‚£ä¹ˆæ‡’åŠ è½½ç±»åº”è¯¥æ˜¯åœ¨å“ªé‡ŒåŠ è½½å‘¢ï¼Ÿæˆ‘ä»¬ç¨å¾®æ€è€ƒä¸€ä¸‹ï¼Œæˆ‘ä»¬ä¸€èˆ¬ç¬¬ä¸€æ¬¡æ“ä½œä¸€ä¸ªç±»æ˜¯ä¸æ˜¯åœ¨åˆå§‹åŒ–è¿™ä¸ªç±»çš„æ—¶å€™ï¼Œè€Œåˆå§‹åŒ–ç±»ä¸å°±æ˜¯å‘é€ alloc æ¶ˆæ¯å—ï¼Œè€Œæ ¹æ®æˆ‘ä»¬å‰é¢æ¢ç´¢æ¶ˆæ¯æŸ¥æ‰¾çš„çŸ¥è¯†ï¼Œåœ¨ç¬¬ä¸€æ¬¡å‘é€æŸä¸ªæ¶ˆæ¯çš„æ—¶å€™ï¼Œæ˜¯æ²¡æœ‰ç¼“å­˜çš„ï¼Œæ‰€ä»¥ä¼šèµ°æ¶ˆæ¯çš„æ…¢é€ŸæŸ¥æ‰¾è¿‡ç¨‹ï¼Œç„¶åå°±æ¥åˆ°ä¸€ä¸ªéå¸¸é‡è¦çš„æ–¹æ³•ï¼šlookUpImpOrForward ï¼Œæˆ‘ä»¬åœ¨ main.m ä¸­ LGPerson ç±»åˆå§‹åŒ–çš„åœ°æ–¹å’Œ lookUpImpOrForward å…¥å£å¤„æ‰“ä¸Šæ–­ç‚¹: Tips: è¿™é‡Œæœ‰ä¸ªå°æŠ€å·§ï¼Œæˆ‘ä»¬å…ˆæ‰“å¼€ main.m æ–‡ä»¶ä¸­lookUpImpOrForward å¤„çš„æ–­ç‚¹çš„æ–­ç‚¹ï¼Œç­‰æ–­ç‚¹æ¥åˆ°äº†æˆ‘ä»¬æƒ³è¦æ¢ç´¢çš„ LGPerson åˆå§‹åŒ–çš„ä½ç½®çš„æ—¶å€™ï¼Œæˆ‘ä»¬å†æ‰“å¼€ lookUpImpOrForward å¤„çš„æ–­ç‚¹ï¼Œè¿™æ ·æ‰èƒ½ç¡®ä¿å½“å‰æ‰§è¡Œ lookUpImpOrForward çš„æ˜¯æˆ‘ä»¬çš„ç ”ç©¶å¯¹è±¡ LGPerson å› ä¸ºæˆ‘ä»¬æ–­ç‚¹çš„ä½ç½®æ˜¯ LGPerson ç±»å‘é€ alloc æ¶ˆæ¯ï¼Œè€Œæ˜¾ç„¶ alloc ä½œä¸ºç±»æ–¹æ³•æ˜¯å­˜å‚¨åœ¨å…ƒç±»ä¸Šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ lookUpImpOrForward çš„ cls å…¶å®æ˜¯ LGPerson å…ƒç±»ã€‚é‚£ä¹ˆ inst å°±åº”è¯¥æ˜¯çœŸæ­£çš„LGPersonç±»å¯¹è±¡ï¼Œå¯å®é™…å¦‚ä¸‹å›¾æ‰€ç¤ºï¼šï¼ˆæœªåˆå§‹åŒ–æ‰€ä»¥çœ‹ä¸å‡ºæ˜¯å“ªä¸ªç±»ï¼‰ æ­¤æ—¶çš„ inst åªæ˜¯ä¸€ä¸ªåœ°å€ï¼Œè¯´æ˜è¿˜æ²¡æœ‰åˆå§‹åŒ–ã€‚æˆ‘ä»¬è®©ç¨‹åºæ¥ç€ä¸‹é¢èµ°ï¼Œä¼šæ¥åˆ°è¿™æ ·ä¸€è¡Œä»£ç : è¿™é‡Œçš„ if åˆ¤æ–­é€šè¿‡æ–¹æ³•åæˆ‘ä»¬ä¸éš¾çœ‹å‡ºæ˜¯åªæœ‰å½“ cls æœªå®ç°çš„æ—¶å€™æ‰ä¼šèµ°é‡Œé¢çš„realizeClassMaybeSwiftAndLeaveLocked æ–¹æ³•ï¼Œé‚£ä¹Ÿå°±æ˜¯è¯´ LGPerson å…ƒç±»æ²¡æœ‰è¢«å®ç°ï¼Œä¹Ÿå°±æ˜¯ LGPerson ç±»æ²¡æœ‰å®ç°æˆ–è€…è¯´æ²¡æœ‰è¢«åŠ è½½ã€‚ æˆ‘ä»¬å°±é¡ºç€ realizeClassMaybeSwiftAndLeaveLocked æ–¹æ³•å¾€ä¸‹é¢èµ°èµ°çœ‹ï¼Œçœ‹åˆ°åº•æ˜¯åœ¨å“ªæŠŠæˆ‘ä»¬è¿™ä¸ªæ‡’åŠ è½½ç±»ç»™åŠ è½½å‡ºæ¥çš„: 123456789101112131415161718192021static ClassrealizeClassMaybeSwiftMaybeRelock(Class cls, mutex_t&amp; lock, bool leaveLocked){ lock.assertLocked(); if (!cls-&gt;isSwiftStable_ButAllowLegacyForNow()) { // Non-Swift class. Realize it now with the lock still held. // fixme wrong in the future for objc subclasses of swift classes realizeClassWithoutSwift(cls); if (!leaveLocked) lock.unlock(); } else { // Swift class. We need to drop locks and call the Swift // runtime to initialize it. lock.unlock(); cls = realizeSwiftClass(cls); assert(cls-&gt;isRealized()); // callback must have provoked realization if (leaveLocked) lock.lock(); } return cls;} æˆ‘ä»¬ä¸€è·¯è·Ÿéšæ–­ç‚¹æ¥åˆ°äº† realizeClassMaybeSwiftMaybeRelock æ–¹æ³•ï¼Œç„¶åæˆ‘ä»¬çœ‹åˆ°äº†æˆ‘ä»¬ç†Ÿæ‚‰çš„ä¸€ä¸ªæ–¹æ³• realizeClassWithoutSwift ï¼Œè¿™ä¸ªæ–¹æ³•å†…éƒ¨ä¼šè¿›è¡Œ ro/rw çš„èµ‹å€¼æ“ä½œä»¥åŠ category çš„ attatch ï¼Œå…³äºè¿™ä¸ªæ–¹æ³•æ›´å¤šå†…å®¹å¯ä»¥æŸ¥çœ‹ä¸Šä¸€ç¯‡æ–‡ç« ã€‚ æ¥ç€æˆ‘ä»¬è¿”å›åˆ° lookUpImpOrForward æ–¹æ³•ä¸­æ¥ï¼Œç„¶åè¿›è¡Œä¸€ä¸‹ LLDB æ‰“å°ï¼Œçœ‹ä¸€ä¸‹å½“å‰è¿™ä¸ª inst ä¹Ÿå°±æ˜¯ LGPerson å¯¹è±¡æ˜¯å¦å·²ç»è¢«åŠ è½½äº†ã€‚ é€šè¿‡ä¸Šé¢çš„æ‰“å°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° rw å·²ç»æœ‰å€¼äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ LGPerson ç±»è¢«åŠ è½½äº†ã€‚ æ€»ç»“ï¼š å¦‚æœç±»æ²¡æœ‰å®ç° load æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»å°±æ˜¯æ‡’åŠ è½½ç±»ï¼ˆç”¨åˆ°å†åŠ è½½ï¼‰ å¦‚æœç±»å®ç°äº† load æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»å°±æ˜¯éæ‡’åŠ è½½ç±»ï¼ˆæå‰åŠ è½½ï¼‰ã€‚ è°ƒç”¨å †æ ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š 1.4 æ‡’åŠ è½½ç±»çš„æµç¨‹å…³äºéæ‡’åŠ è½½ç±»çš„åŠ è½½æµç¨‹æˆ‘ä»¬å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œæˆ‘ä»¬æ€»ç»“ä¸‹æ‡’åŠ è½½ç±»çš„æµç¨‹ï¼š ç±»ç¬¬ä¸€æ¬¡å‘é€æ¶ˆæ¯çš„æ—¶å€™æ˜¯æ²¡æœ‰ç¼“å­˜çš„ï¼Œæ‰€ä»¥ä¼šæ¥åˆ° _class_lookupMethodAndLoadCache3 ï¼ˆè¿™ä¸ªæ–¹æ³•åœ¨05-æ–¹æ³•çš„æœ¬è´¨å’Œæ¶ˆæ¯æŸ¥æ‰¾æµç¨‹å·²ç»åˆ†æè¿‡äº†ï¼‰ _class_lookupMethodAndLoadCache3 ä¼šè°ƒç”¨ lookUpImpOrForward ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨å­¦ä¹  Runtime çš„è¿‡ç¨‹ä¸­éå¸¸é‡è¦ï¼ lookUpImpOrForward å†…éƒ¨ä¼šè¿›è¡Œä¸€ä¸‹åˆ¤æ–­ï¼Œå¦‚æœ cls æ²¡æœ‰è¢«å®ç°ï¼Œä¼šè°ƒç”¨ realizeClassMaybeSwiftAndLeaveLocked æ–¹æ³• realizeClassMaybeSwiftAndLeaveLocked æ–¹æ³•åˆä¼šè°ƒç”¨ realizeClassMaybeSwiftMaybeRelock æ–¹æ³• realizeClassMaybeSwiftMaybeRelock æ–¹æ³•å†…éƒ¨ä¼šè¿›è¡Œä¸€ä¸‹æ˜¯å¦æ˜¯ Swift çš„åˆ¤æ–­ï¼Œå¦‚æœä¸æ˜¯ Swift ç¯å¢ƒçš„è¯ï¼Œå°±ä¼šæ¥åˆ° realizeClassWithoutSwift ï¼Œæœ€ç»ˆæ‡’åŠ è½½çš„ç±»å°±åœ¨è¿™é‡ŒåŠ è½½ äºŒã€åˆ†ç±»çš„åº•å±‚å®ç°ç±»åˆ†ä¸ºæ‡’åŠ è½½ç±»å’Œéæ‡’åŠ è½½ç±»ï¼Œåˆ†ç±»åŒæ ·åˆ†ä¸ºæ‡’åŠ è½½åˆ†ç±»å’Œéæ‡’åŠ è½½åˆ†ç±»ã€‚åœ¨ç ”ç©¶åˆ†ç±»ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦äº†è§£ä¸‹åˆ†ç±»çš„åº•å±‚å®ç°ã€‚ 2.1 é‡å†™åˆ†ç±»æºæ–‡ä»¶é¦–å…ˆå‡†å¤‡ä¸€ä»½LGTeacher+test.mæ–‡ä»¶ï¼š åœ¨ç»ˆç«¯ä¸­ç”¨ clang å‘½ä»¤é‡å†™è¿™ä¸ªåˆ†ç±»æ–‡ä»¶ä¸ºc++æ–‡ä»¶ï¼š 1clang -rewrite-objc LGTeacher+test.m -o category.cpp ç„¶åæŸ¥çœ‹ category.cpp è¿™ä¸ªæ–‡ä»¶ï¼Œæ¥åˆ°æ–‡ä»¶å°¾éƒ¨å¯ä»¥çœ‹åˆ°: 123456789static struct _category_t _OBJC_$_CATEGORY_LGTeacher_$_test __attribute__ ((used, section (&quot;__DATA,__objc_const&quot;))) = { &quot;LGTeacher&quot;, 0, // &amp;OBJC_CLASS_$_LGTeacher, (const struct _method_list_t *)&amp;_OBJC_$_CATEGORY_INSTANCE_METHODS_LGTeacher_$_test, (const struct _method_list_t *)&amp;_OBJC_$_CATEGORY_CLASS_METHODS_LGTeacher_$_test, 0, (const struct _prop_list_t *)&amp;_OBJC_$_PROP_LIST_LGTeacher_$_test,}; å¯ä»¥çœ‹åˆ° LGTeacher+test åˆ†ç±»åœ¨åº•å±‚çš„å®ç°æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œå…¶åå­—ä¸º _OBJC_$_CATEGORY_LGTeacher_$_test ï¼Œå¾ˆæ˜æ˜¾è¿™æ˜¯ä¸€ä¸ªæŒ‰è§„åˆ™ç”Ÿæˆçš„ç¬¦å·ï¼Œä¸­é—´çš„ LGTeacher æ˜¯ç±»åï¼Œåé¢çš„ test æ˜¯åˆ†ç±»çš„åå­—ã€‚ åŒæ—¶ï¼Œæˆ‘ä»¬åœ¨åé¢å¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„ä»£ç ï¼š 123static struct _category_t *L_OBJC_LABEL_CATEGORY_$ [1] __attribute__((used, section (&quot;__DATA, __objc_catlist,regular,no_dead_strip&quot;)))= { &amp;_OBJC_$_CATEGORY_LGTeacher_$_test,}; è¿™è¡¨æ˜åˆ†ç±»æ˜¯å­˜å‚¨åœ¨ __DATA æ®µçš„ __objc_catlist section é‡Œé¢çš„ã€‚ 2.2 åˆ†ç±»çš„å®šä¹‰æˆ‘ä»¬æ ¹æ® _category_t æ¥åˆ° libObjc æºç ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œä¸è¿‡æˆ‘ä»¬éœ€è¦å»æ‰ä¸€ä¸‹ _category_t çš„ä¸‹åˆ’çº¿ï¼Œç„¶åä¸éš¾æ‰¾åˆ°åˆ†ç±»çœŸæ­£çš„å®šä¹‰æ‰€åœ¨ï¼š 1234567891011121314151617struct category_t { const char *name; classref_t cls; struct method_list_t *instanceMethods; struct method_list_t *classMethods; struct protocol_list_t *protocols; struct property_list_t *instanceProperties; // Fields below this point are not always present on disk. struct property_list_t *_classProperties; method_list_t *methodsForMeta(bool isMeta) { if (isMeta) return classMethods; else return instanceMethods; } property_list_t *propertiesForMeta(bool isMeta, struct header_info *hi);}; æ ¹æ®åˆšæ‰ clang é‡å†™ä¹‹åçš„å†…å®¹ï¼Œæˆ‘ä»¬ä¸éš¾çœ‹å‡º name : æ˜¯åˆ†ç±»æ‰€å…³è”çš„ç±»ï¼Œä¹Ÿå°±æ˜¯ç±»çš„åå­—ï¼Œè€Œä¸æ˜¯åˆ†ç±»çš„åå­— cls : æˆ‘ä»¬åœ¨å‰é¢å¯ä»¥çœ‹åˆ° clang é‡å†™åè¿™ä¸ªå€¼ä¸º 0ï¼Œä½†æ˜¯åé¢æœ‰æ³¨é‡Šä¸º &amp;OBJC_CLASS_$_LGTeacher ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ç±»å¯¹è±¡çš„å®šä¹‰ï¼Œæ‰€ä»¥è¿™é‡Œå…¶å®å°±æ˜¯æˆ‘ä»¬è¦æ‰©å±•çš„ç±»å¯¹è±¡ï¼Œåªæ˜¯åœ¨ç¼–è¯‘æœŸè¿™ä¸ªå€¼å¹¶ä¸å­˜åœ¨ instanceMethods : åˆ†ç±»ä¸Šå­˜å‚¨çš„å®ä¾‹æ–¹æ³• classMethods ï¼šåˆ†ç±»ä¸Šå­˜å‚¨çš„ç±»æ–¹æ³• protocols ï¼šåˆ†ç±»æ‰€å®ç°çš„åè®® instanceProperties ï¼šåˆ†ç±»æ‰€å®šä¹‰çš„å®ä¾‹å±æ€§ï¼Œä¸è¿‡æˆ‘ä»¬ä¸€èˆ¬åœ¨åˆ†ç±»ä¸­æ·»åŠ å±æ€§éƒ½æ˜¯é€šè¿‡å…³è”å¯¹è±¡æ¥å®ç°çš„ _classProperties ï¼šåˆ†ç±»æ‰€å®šä¹‰çš„ç±»å±æ€§ã€‚ ä¸‰ã€åˆ†ç±»çš„åŠ è½½æˆ‘ä»¬ç°åœ¨çŸ¥é“äº†ç±»åˆ†ä¸ºäº† æ‡’åŠ è½½ç±» å’Œ éæ‡’åŠ è½½ç±» ï¼Œå®ƒä»¬çš„åŠ è½½æ—¶æœºæ˜¯ä¸ä¸€æ ·çš„ï¼Œåˆ†ç±»åŒæ ·åˆ†ä¸ºæ‡’åŠ è½½åˆ†ç±»å’Œéæ‡’åŠ è½½åˆ†ç±»ã€‚ åˆ†ç±»å¿…é¡»ä¾é™„äºç±»è€Œå­˜åœ¨ï¼Œå¦‚æœåªæœ‰åˆ†ç±»ï¼Œæ²¡æœ‰ç±»ï¼Œé‚£ä¹ˆä»é€»è¾‘ä¸Šæ˜¯è¯´ä¸é€šçš„ï¼Œå°±ç®—å®ç°äº†ï¼Œç¼–è¯‘å™¨ä¹Ÿä¼šå¿½ç•¥æ‰ã€‚ æ¥ä¸‹æ¥å¼€å§‹ç ”ç©¶ï¼š 3.1 æ‡’åŠ è½½åˆ†ç±»æ²¡æœ‰å®ç° load çš„åˆ†ç±»-&gt;æ²¡æœ‰æå‰åŠ è½½ï¼Œæ‰€ä»¥æ˜¯æ‡’åŠ è½½åˆ†ç±»ã€‚ 3.1.1 æ‡’åŠ è½½åˆ†ç±» + æ‡’åŠ è½½ç±»ä¹Ÿå°±æ˜¯ç±»å’Œåˆ†ç±»éƒ½ä¸å®ç° load æ–¹æ³•çš„æƒ…å†µã€‚ æ‡’åŠ è½½ç±»å‰é¢åˆ†æè¿‡äº†ï¼Œåœ¨å‘ç±»ç¬¬ä¸€æ¬¡å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œæ‡’åŠ è½½ç±»æ‰ä¼šå¼€å§‹åŠ è½½ã€‚ æ‡’åŠ è½½åˆ†ç±»æ¢ç´¢ï¼šåœ¨ realizeClassWithoutSwift æ–¹æ³•çš„æœ€åæœ‰ä¸€ä¸ª methodizeClass æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢ä¼šæœ‰ä¸€ä¸ª Attach categories çš„åœ°æ–¹ï¼ŒçŒœæµ‹æ‡’åŠ è½½åˆ†ç±»æ˜¯ä¸æ˜¯åœ¨è¿™é‡ŒåŠ è½½äº†ï¼Ÿ ä½†æ˜¯æˆ‘ä»¬æ–­ç‚¹ä¹‹åå‘ç°è¿™ä¸ªæ—¶å€™é€šè¿‡ unattachedCategoriesForClass æ–¹æ³•å¹¶æ²¡æœ‰å–åˆ°åˆ†ç±»ã€‚æ­¤æ—¶é€šè¿‡ LLDB æ‰“å°ä¸€ä¸‹å½“å‰ç±»é‡Œé¢æ˜¯å¦å·²ç»æŠŠåˆ†ç±»çš„å†…å®¹é™„åŠ ä¸Šäº†ã€‚å‰é¢çš„æµç¨‹å¤§å®¶éƒ½å¾ˆç†Ÿæ‚‰äº†ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹ cls çš„ rw ä¸­çš„ methods æ˜¯å¦æœ‰å†…å®¹ï¼š æ­¤æ—¶ LGTeacher ç±»é‡Œé¢æ˜¯æ²¡æœ‰æ–¹æ³•çš„ï¼Œè¿™é‡Œè¯»å– rw å´æœ‰ä¸€ä¸ªç»“æœï¼Œæˆ‘ä»¬ä¸éš¾çœ‹å‡ºè¿™æ˜¯ä½äº LGTeacher+test åˆ†ç±»ä¸­çš„ä¸€ä¸ª initialize æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯æˆ‘æ‰‹åŠ¨åŠ åˆ°è¿™ä¸ªåˆ†ç±»çš„ã€‚ è¿™æ ·è¿›ä¸€æ­¥è¯æ˜äº†ï¼Œå¦‚æœæ˜¯æ‡’åŠ è½½ç±»ï¼Œå¹¶ä¸”åˆ†ç±»ä¹Ÿæ˜¯æ‡’åŠ è½½ï¼Œé‚£ä¹ˆåˆ†ç±»çš„åŠ è½½å¹¶ä¸ä¼šæ¥åˆ° unattachedCategoriesForClass ï¼Œè€Œæ˜¯ç›´æ¥åœ¨ç¼–è¯‘æ—¶åŠ è½½åˆ°äº†ç±»çš„ ro é‡Œé¢ï¼Œç„¶ååœ¨è¿è¡Œæ—¶è¢«æ‹·è´åˆ°äº†ç±»çš„ rw é‡Œé¢ã€‚è¿™ä¸€ç‚¹å¯ä»¥é€šè¿‡ä¸‹é¢çš„ LLDB æ‰“å°æ¥è¯æ˜ã€‚ çªç„¶æƒ³èµ·æ¥ï¼Œä¸æ˜¯åœ¨ _read_images çš„æœ€åé‚£å—æœ‰ä¸€ä¸ª Discover categories å—ï¼Œä¸‡ä¸€æ‡’åŠ è½½åˆ†ç±»æ˜¯åœ¨è¿™é‡ŒåŠ è½½çš„å‘¢ï¼Ÿæˆ‘ä»¬ä¸€è¯•ä¾¿çŸ¥ï¼š è¿™é‡Œåœ¨ Discover categories å†…éƒ¨åšäº†ä¸€ä¸‹åˆ¤æ–­ï¼Œå¦‚æœæ˜¯ LGTeacher ç±»è¿›æ¥äº†ï¼Œå°±æ‰“å°ä¸€ä¸‹ï¼Œç»“æœå‘ç°å¹¶æ²¡æœ‰æ‰“å°ï¼Œè¯´æ˜åˆ†ç±»ä¹Ÿä¸æ˜¯åœ¨è¿™é‡Œè¢«åŠ è½½çš„ï¼Œæ˜¯åœ¨ç¼–è¯‘æ—¶ç›´æ¥åŠ è½½çš„ã€‚ 3.1.2 æ‡’åŠ è½½åˆ†ç±»+éæ‡’åŠ è½½ç±»éæ‡’åŠ è½½ç±»å½“ç±»ä¸ºéæ‡’åŠ è½½ç±»çš„æ—¶å€™ï¼ŒåŒæ ·æ˜¯èµ° _read_images =&gt;Realize non-lazy classes=&gt;realizeClassWithoutSwift=&gt;methodizeClassã€‚ æ‡’åŠ è½½åˆ†ç±»æˆ‘ä»¬ç›´æ¥åœ¨ methodizeClass æ–¹æ³•ä¸­æ‰“ä¸Šæ–­ç‚¹ï¼Œå¹¶åšäº†ä¸€ä¸‹ç®€å•çš„åˆ¤æ–­: 12345const char *cname = ro-&gt;name;const char *oname = &quot;LGTeacher&quot;;if (strcmp(cname, oname) == 0) { printf(&quot;methodizeClass :%s \\n&quot;,cname);} ç»“æœå¯ä»¥çœ‹åˆ°catsä¸ºç©ºï¼Œæ‰€ä»¥åˆ†ç±»ä¸åœ¨è¿™è¿›è¡Œæ·»åŠ ã€‚ åŒæ—¶é€šè¿‡ LLDB æ‰“å°ï¼Œå‘ç°åˆ†ç±»çš„æ–¹æ³•å·²ç»åœ¨ç±»çš„ ro é‡Œé¢äº†ï¼Œè¯´æ˜æ‡’åŠ è½½çš„åˆ†ç±»åœ¨ç¼–è¯‘æ—¶æœŸå°±è¢«åŠ è½½äº†ã€‚ 3.1.3 æ‡’åŠ è½½åˆ†ç±»æ€»ç»“ æ‡’åŠ è½½åˆ†ç±»çš„åˆå§‹åŒ–å…¶å®è·Ÿç±»çš„æ‡’åŠ è½½ä¸å¦å¹¶æ²¡æœ‰å…³ç³»ï¼Œä¹Ÿå°±æ˜¯è¯´æ‡’åŠ è½½çš„åˆ†ç±»éƒ½æ˜¯åœ¨ç¼–è¯‘æ—¶æœŸè¢«åŠ è½½çš„ã€‚ æ‡’åŠ è½½ç±»å’Œéæ‡’åŠ è½½ç±»è¿˜æ˜¯1.3ä¸­æ‰€è¿°çš„æµç¨‹ã€‚ 3.2 éæ‡’åŠ è½½åˆ†ç±»å®ç°äº† load çš„åˆ†ç±»-&gt;æå‰åŠ è½½ï¼Œæ‰€ä»¥æ˜¯éæ‡’åŠ è½½åˆ†ç±» ä»–å’Œç±»é…åˆåŠ è½½åˆ†ä¸‹é¢ä¸¤ç§æƒ…å†µï¼š éæ‡’åŠ è½½åˆ†ç±»ä¸æ‡’åŠ è½½ç±» éæ‡’åŠ è½½åˆ†ç±»å’Œéæ‡’åŠ è½½ç±» 3.2.1 éæ‡’åŠ è½½åˆ†ç±» + æ‡’åŠ è½½ç±»æ‡’åŠ è½½çš„ç±»æˆ‘ä»¬å‰é¢å·²ç»çŸ¥é“äº†ï¼Œæ˜¯åœ¨ç¬¬ä¸€æ¬¡å‘é€æ¶ˆæ¯çš„æ—¶å€™æ‰ä¼šè¢«åŠ è½½çš„ï¼Œé‚£æˆ‘ä»¬ç›´æ¥åœ¨lookupImpOrForward =&gt;realizeClassMaybeSwiftAndLeaveLocked =&gt; realizeClassMaybeSwiftMaybeRelock =&gt; realizeClassWithoutSwift =&gt; methodizeClass æµç¨‹ä¸­çš„ methodizeClass æ‰“ä¸Šæ–­ç‚¹ï¼Œçœ‹ä¸‹åœ¨è¿™é‡Œåˆ†ç±»ä¼šä¸ä¼šè¢«åŠ è½½ï¼š è¿™ä¸€æ¬¡é€šè¿‡ unattachedCategoriesForClass å–å‡ºæ¥å€¼äº†ï¼Œå¹¶ä¸”åœ¨è¿™ä¹‹å‰ cls çš„ ro ä¸­å¹¶æ²¡æœ‰åˆ†ç±»çš„ initialize æ–¹æ³•ï¼š ä½†æ˜¯æˆ‘ä»¬æ³¨æ„è§‚å¯Ÿæ­¤æ—¶çš„è°ƒç”¨å †æ ˆï¼š ä¸ºä»€ä¹ˆèµ°çš„æ˜¯ load_images é‡Œé¢çš„ prepare_load_methods æ–¹æ³•å‘¢ï¼Ÿæˆ‘ä»¬æ¥åˆ° prepare_load_methods æ–¹æ³•å¤„ï¼š å¯ä»¥çœ‹åˆ°ï¼Œå…¶å®åœ¨è¿™é‡Œè°ƒç”¨äº† realizeClassWithoutSwift æ–¹æ³•æ¥æå‰åŠ è½½ç±»ã€‚ è€Œä¸Šé¢çš„ _getObjc2NonlazyCategoryList æ–¹æ³•æ˜¾ç¤ºå°±æ˜¯è·å–åˆ°æ‰€æœ‰çš„éæ‡’åŠ è½½åˆ†ç±»ï¼Œç„¶åéå†è¿™äº›éæ‡’åŠ è½½åˆ†ç±»ï¼Œç„¶åå»åŠ è½½è¿™äº›åˆ†ç±»æ‰€ä¾èµ–çš„ç±»ã€‚ è¿™ä¸ªé€»è¾‘å¾ˆå¥½ç†è§£ï¼Œéæ‡’åŠ è½½åˆ†ç±»è®©æˆ‘ä»¬çš„æ‡’åŠ è½½ç±»å®ç°æå‰äº†ï¼Œæ‰€ä»¥è¯´æ‡’åŠ è½½ç±»å¹¶ä¸ä¸€å®šåªä¼šåœ¨ç¬¬ä¸€æ¬¡æ¶ˆæ¯å‘é€çš„æ—¶å€™åŠ è½½ï¼Œè¿˜è¦å–å†³äºæœ‰æ²¡æœ‰éæ‡’åŠ è½½çš„åˆ†ç±»ï¼Œå¦‚æœæœ‰éæ‡’åŠ è½½çš„åˆ†ç±»ï¼Œé‚£ä¹ˆç±»å°±æ˜¯åœ¨ load_images =&gt; prepare_load_methods =&gt; realizeClassWithoutSwift åŠ è½½çš„ã€‚ åˆ†ç±»çš„åŠ è½½åœ¨ç±»åŠ è½½ä¹‹åçš„ methodizeClassã€‚ 3.2.2 éæ‡’åŠ è½½åˆ†ç±» + éæ‡’åŠ è½½ç±»éæ‡’åŠ è½½ç±»çš„æµç¨‹æˆ‘ä»¬ä¹Ÿååˆ†ç†Ÿæ‚‰äº†ï¼Œåœ¨ _read_images é‡Œé¢è¿›è¡ŒåŠ è½½ã€‚è€Œæ­¤æ—¶ï¼Œåˆ†ç±»ä¹Ÿæ˜¯éæ‡’åŠ è½½ã€‚æˆ‘ä»¬è¿˜æ˜¯åœ¨ methodizeClass é‡Œé¢è¿›è¡Œæ–­ç‚¹ï¼š ç»“æœå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œè¿™æ¬¡ä» unattachedCategoriesForClass æ–¹æ³•å–å‡ºæ¥çš„æ˜¯ NULL å€¼ï¼Œæ˜¾ç„¶åˆ†ç±»ä¸æ˜¯åœ¨è¿™ä¸ªåœ°æ–¹è¢«åŠ è½½çš„ï¼Œæˆ‘ä»¬å›åˆ° _read_images æ–¹æ³•ï¼Œè¿˜è®°å¾—é‚£ä¸ª Discover categories æµç¨‹å—ï¼Œæˆ‘ä»¬æ‰“å¼€é‡Œé¢çš„æ–­ç‚¹ï¼š å› ä¸ºå½“å‰ç±»å·²ç»åœ¨å‰é¢çš„éæ‡’åŠ è½½ç±»åŠ è½½æµç¨‹ä¸­è¢«åŠ è½½å®Œæˆï¼Œæ‰€ä»¥è¿™é‡Œä¼šæ¥åˆ° remethodizeClass æ–¹æ³•ï¼Œæˆ‘ä»¬è¿›å…¥å…¶å†…éƒ¨å®ç°ï¼š 1234567891011121314151617181920static void remethodizeClass(Class cls){ category_list *cats; bool isMeta; runtimeLock.assertLocked(); isMeta = cls-&gt;isMetaClass(); // Re-methodizing: check for more categories if ((cats = unattachedCategoriesForClass(cls, false/*not realizing*/))) { if (PrintConnecting) { _objc_inform(&quot;CLASS: attaching categories to class '%s' %s&quot;, cls-&gt;nameForLogging(), isMeta ? &quot;(meta)&quot; : &quot;&quot;); } attachCategories(cls, cats, true /*flush caches*/); free(cats); }} å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ª attachCategories æ–¹æ³•ï¼Œæ–­ç‚¹ä¹Ÿç¡®å®æ¥åˆ°äº†è¿™ä¸ªåœ°æ–¹ï¼Œæ‰€ä»¥éæ‡’åŠ è½½åˆ†ç±»åœ¨è¿™é‡ŒåŠ è½½ã€‚ 3.2.3 éæ‡’åŠ è½½åˆ†ç±»æ€»ç»“ éæ‡’åŠ è½½åˆ†ç±» + æ‡’åŠ è½½ç±» ç±»çš„åŠ è½½åœ¨ load_images å¤„ ï¼Œåˆ†ç±»çš„åŠ è½½åœ¨ç±»åŠ è½½ä¹‹åçš„ methodizeClass éæ‡’åŠ è½½åˆ†ç±» + éæ‡’åŠ è½½ç±» ç±»çš„åŠ è½½åœ¨ _read_images å¤„ï¼Œåˆ†ç±»çš„åŠ è½½åœ¨ç±»åŠ è½½ä¹‹åçš„ reMethodizeClass 3.3 æ€»ç»“åˆ†ç±»çš„åŠ è½½å…¶å®å¯ä»¥ç¬¼ç»Ÿçš„åˆ†ä¸ºå®ç° load æ–¹æ³•å’Œæ²¡æœ‰å®ç° load æ–¹æ³•ï¼š æ²¡æœ‰å®ç° load æ–¹æ³•çš„åˆ†ç±»ï¼ˆä¸éœ€æå‰åŠ è½½-æ‡’åŠ è½½åˆ†ç±»ï¼‰ç”±ç¼–è¯‘æ—¶ç¡®å®š å®ç°äº† load æ–¹æ³•çš„åˆ†ç±»ï¼ˆéœ€æå‰åŠ è½½-éæ‡’åŠ è½½åˆ†ç±»ï¼‰ç”±è¿è¡Œæ—¶å»ç¡®å®š è¿™ä¹Ÿè¯´æ˜åˆ†ç±»çš„åŠ è½½å’Œç±»çš„åŠ è½½æ˜¯ä¸ä¸€æ ·çš„ï¼Œè€Œç»“åˆç€ç±»çš„æ‡’åŠ è½½ä¸å¦ï¼Œæˆ‘ä»¬æœ‰ä»¥ä¸‹çš„ç»“è®ºï¼š æ‡’åŠ è½½åˆ†ç±» + æ‡’åŠ è½½ç±» ç±»çš„åŠ è½½åœ¨ç¬¬ä¸€æ¬¡æ¶ˆæ¯å‘é€çš„æ—¶å€™ï¼Œè€Œåˆ†ç±»çš„åŠ è½½åˆ™åœ¨ç¼–è¯‘æ—¶ æ‡’åŠ è½½åˆ†ç±» + éæ‡’åŠ è½½ç±» ç±»çš„åŠ è½½åœ¨ _read_images å¤„ï¼Œåˆ†ç±»çš„åŠ è½½è¿˜æ˜¯åœ¨ç¼–è¯‘æ—¶ éæ‡’åŠ è½½åˆ†ç±» + æ‡’åŠ è½½ç±» ç±»çš„åŠ è½½åœ¨ load_images å†…éƒ¨ï¼Œåˆ†ç±»çš„åŠ è½½åœ¨ç±»åŠ è½½ä¹‹åçš„ methodizeClass éæ‡’åŠ è½½åˆ†ç±» + éæ‡’åŠ è½½ç±» ç±»çš„åŠ è½½åœ¨ _read_images å¤„ï¼Œåˆ†ç±»çš„åŠ è½½åœ¨ç±»åŠ è½½ä¹‹åçš„ reMethodizeClass å››ã€ç±»æ‹“å±•çš„åŠ è½½ç±»æ‹“å±•extensionåˆç§°ä½œåŒ¿åçš„åˆ†ç±»ï¼Œä¸ºäº†ç»™å½“å‰ç±»å¢åŠ å±æ€§å’Œæ–¹æ³• å…·ä½“æœ‰ä¸¤ç§å½¢å¼ï¼š ç›´æ¥åœ¨.mæ–‡ä»¶ä¸­æ–°å¢ç±»æ‹“å±• æ–°å»ºç±»æ‹“å±•çš„.hæ–‡ä»¶ 4.1 ç±»æ‹“å±•çš„åŠ è½½æ•°æ®å¾ˆæ—©çš„æ—¶å€™éƒ½ä¼šæ¥åˆ°_read_imageï¼Œåœ¨è¿™é‡Œæ–­ç‚¹åˆ†æä¸€ä¸‹ï¼š ä½†æ˜¯ä»”ç»†ä¸€æƒ³ä¸å¯¹å‘€ï¼Œå·²ç»åœ¨ç±»ä¸­æœ‰äº†æ–¹æ³•å®ç°äº†ï¼Œæ­¤æ—¶çš„do_hExtensionä¸è¶³ä»¥è¯´æ˜é—®é¢˜ é‚£ä¹ˆå¯ä»¥é€šè¿‡æŸ¥çœ‹å±æ€§çš„setterå’Œgetteræ–¹æ³•æ¥éªŒè¯ åœ¨æ¥åˆ°_read_imageæ–¹æ³•ä¹‹å‰å°±æœ‰äº†ç›¸åº”çš„getterå’Œsetterï¼Œè¯´æ˜ ç±»æ‹“å±•åœ¨ç¼–è¯‘æ—¶ä¾¿ä½œä¸ºç±»çš„ä¸€éƒ¨åˆ†è¿›è¡Œç¼–è¯‘ï¼Œå­˜åˆ°ç±»çš„roä¸­ 4.2 ç±»æ‹“å±•çš„ç»†èŠ‚ç‚¹å¦‚æœç±»æ‹“å±•æ²¡æœ‰è¢«å¼•ç”¨ï¼ˆ#importï¼‰-åœ¨ä»£ç ä¸­æ²¡æœ‰è¢«ç”¨åˆ°ï¼Œå°±ä¸ä¼šç¼–è¯‘åˆ°åˆ°å†…å­˜ä¸­ äº”ã€load_imageåˆ†æä¸Šç¯‡æ–‡ç« è®²åˆ°dyldåˆå§‹åŒ–imageä¼šè§¦å‘load_imageï¼Œæœ¬æ–‡åˆæåˆ°äº†æ‡’åŠ è½½ç±»å’Œéæ‡’åŠ è½½åˆ†ç±»æƒ…å†µä¸‹ï¼Œåˆ†ç±»åŠ è½½åˆ°å†…å­˜æ—¶çš„è°ƒç”¨æ ˆä¸­æœ‰load_imageï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨è¯¥ç§æƒ…å†µä¸‹è¿›è¡Œæ¢ç´¢ã€‚ åœ¨load_imageå®ç°å¤„æ‰“ä¸‹æ–­ç‚¹ï¼Œå‘ç°ç±»å’Œåˆ†ç±»éƒ½æ²¡æœ‰æ‰“å°+loadæ–¹æ³•â€”â€”load_imageå…ˆäº+loadæ–¹æ³• æ¥ç€æŠŠç›®å…‰ç§»å‘ä¸¤æ¡æ³¨é‡Šï¼š Discover load methodsâ€”â€”prepare_load_methods Call +load methodsâ€”â€”call_load_methods 5.1 prepare_load_methodså‘ç°å¹¶å‡†å¤‡+loadæ–¹æ³• 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879void prepare_load_methods(const headerType *mhdr){ size_t count, i; runtimeLock.assertLocked(); classref_t *classlist = _getObjc2NonlazyClassList(mhdr, &amp;count); for (i = 0; i &lt; count; i++) { schedule_class_load(remapClass(classlist[i])); } category_t **categorylist = _getObjc2NonlazyCategoryList(mhdr, &amp;count); for (i = 0; i &lt; count; i++) { category_t *cat = categorylist[i]; Class cls = remapClass(cat-&gt;cls); if (!cls) continue; // category for ignored weak-linked class if (cls-&gt;isSwiftStable()) { _objc_fatal(&quot;Swift class extensions and categories on Swift &quot; &quot;classes are not allowed to have +load methods&quot;); } realizeClassWithoutSwift(cls); assert(cls-&gt;ISA()-&gt;isRealized()); add_category_to_loadable_list(cat); }}/************************************************************************ prepare_load_methods* Schedule +load for classes in this image, any un-+load-ed * superclasses in other images, and any categories in this image.**********************************************************************/// Recursively schedule +load for cls and any un-+load-ed superclasses.// cls must already be connected.static void schedule_class_load(Class cls){ if (!cls) return; assert(cls-&gt;isRealized()); // _read_images should realize if (cls-&gt;data()-&gt;flags &amp; RW_LOADED) return; // Ensure superclass-first ordering schedule_class_load(cls-&gt;superclass); add_class_to_loadable_list(cls); cls-&gt;setInfo(RW_LOADED); }/************************************************************************ add_class_to_loadable_list* Class cls has just become connected. Schedule it for +load if* it implements a +load method.**********************************************************************/void add_class_to_loadable_list(Class cls){ IMP method; loadMethodLock.assertLocked(); method = cls-&gt;getLoadMethod(); if (!method) return; // Don't bother if cls has no +load method if (PrintLoading) { _objc_inform(&quot;LOAD: class '%s' scheduled for +load&quot;, cls-&gt;nameForLogging()); } if (loadable_classes_used == loadable_classes_allocated) { loadable_classes_allocated = loadable_classes_allocated*2 + 16; loadable_classes = (struct loadable_class *) realloc(loadable_classes, loadable_classes_allocated * sizeof(struct loadable_class)); } loadable_classes[loadable_classes_used].cls = cls; loadable_classes[loadable_classes_used].method = method; loadable_classes_used++;} prepare_load_methodsåˆ†æï¼š é€šè¿‡_getObjc2NonlazyClassListè·å–éæ‡’åŠ è½½ç±»åˆ—è¡¨ é€šè¿‡schedule_class_loadéå†è¿™äº›ç±» é€’å½’è°ƒç”¨éå†çˆ¶ç±»çš„+loadæ–¹æ³•ï¼Œç¡®ä¿çˆ¶ç±»çš„+loadæ–¹æ³•é¡ºåºæ’åœ¨å­ç±»çš„å‰é¢ è°ƒç”¨add_class_to_loadable_listæŠŠç±»çš„+loadæ–¹æ³•å­˜åœ¨loadable_classesé‡Œé¢ è°ƒç”¨_getObjc2NonlazyCategoryListå–å‡ºéæ‡’åŠ è½½åˆ†ç±»åˆ—è¡¨ éå†åˆ†ç±»åˆ—è¡¨ é€šè¿‡realizeClassWithoutSwiftæ¥é˜²æ­¢ç±»æ²¡æœ‰åˆå§‹åŒ–ï¼ˆè‹¥å·²ç»åˆå§‹åŒ–äº†åˆ™ä¸å½±å“ï¼‰ è°ƒç”¨add_category_to_loadable_liståŠ è½½åˆ†ç±»ä¸­çš„+loadæ–¹æ³•åˆ°loadable_categories æ­¤æ—¶å°±èƒ½çœ‹æ‡‚ä¹‹å‰æ‡’åŠ è½½ç±»å’Œéæ‡’åŠ è½½åˆ†ç±»çš„å‡½æ•°è°ƒç”¨æ ˆäº† 5.2 call_load_methodså”¤é†’+loadæ–¹æ³• 1234567891011121314151617181920212223242526272829void call_load_methods(void){ static bool loading = NO; bool more_categories; loadMethodLock.assertLocked(); // Re-entrant calls do nothing; the outermost call will finish the job. if (loading) return; loading = YES; void *pool = objc_autoreleasePoolPush(); do { // 1. Repeatedly call class +loads until there aren't any more while (loadable_classes_used &gt; 0) { call_class_loads(); } // 2. Call category +loads ONCE more_categories = call_category_loads(); // 3. Run more +loads if there are classes OR more untried categories } while (loadable_classes_used &gt; 0 || more_categories); objc_autoreleasePoolPop(pool); loading = NO;} é€šè¿‡objc_autoreleasePoolPushå‹æ ˆä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ±  do-whileå¾ªç¯å¼€å§‹ å¾ªç¯è°ƒç”¨ç±»çš„+loadæ–¹æ³•ç›´åˆ°æ‰¾ä¸åˆ°ä¸ºæ­¢ è°ƒç”¨ä¸€æ¬¡åˆ†ç±»ä¸­çš„+loadæ–¹æ³• é€šè¿‡objc_autoreleasePoolPopå‡ºæ ˆä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ±  5.3 å…³äºloadæ–¹æ³•æˆ‘ä»¬éœ€è¦çŸ¥é“çš„ loadæ–¹æ³•åœ¨mainå‡½æ•°å‰è°ƒç”¨ å¦‚æœä¸€ä¸ªç±»å®ç°äº†loadæ–¹æ³•ï¼Œåœ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•å‰ä¼šå…ˆè°ƒç”¨çˆ¶ç±»çš„loadæ–¹æ³• å› ä¸ºåŠ è½½æ—¶é—´ç‰¹åˆ«æ—©ï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨è¿™ä¸ªç‰¹æ€§è¿›è¡Œä¸€äº›ç‰¹æ®Šå¤„ç† å…­ã€initalizeåˆ†æå…³äºinitalizeè‹¹æœæ–‡æ¡£æ˜¯è¿™ä¹ˆæè¿°çš„ 1.åœ¨ç±»æˆ–è€…å…¶å­ç±»çš„ç¬¬ä¸€ä¸ªæ–¹æ³•è¢«è°ƒç”¨å‰ï¼ˆå‘é€æ¶ˆæ¯å‰ï¼‰è°ƒç”¨2.çˆ¶ç±»çš„è°ƒç”¨åœ¨å­ç±»ä¹‹å‰è¡¥å……ï¼šé€šå¸¸åº”è¯¥åœ¨é‡Œé¢åˆ¤æ–­å½“å‰è¦åˆå§‹åŒ–çš„ç±»ï¼Œé˜²æ­¢å¤šæ¬¡è°ƒç”¨ ç„¶åæˆ‘ä»¬åœ¨objcæºç ä¸­lookUpImpOrForwardæ‰¾åˆ°äº†å®ƒçš„è¸ªè¿¹ lookUpImpOrForward-&gt;initializeAndLeaveLocked-&gt;initializeAndMaybeRelock-&gt;initializeNonMetaClass 1234567891011121314151617181920212223IMP lookUpImpOrForward(Class cls, SEL sel, id inst, bool initialize, bool cache, bool resolver){ ... if (initialize &amp;&amp; !cls-&gt;isInitialized()) { cls = initializeAndLeaveLocked(cls, inst, runtimeLock); ... } ...}static Class initializeAndLeaveLocked(Class cls, id obj, mutex_t&amp; lock){ return initializeAndMaybeRelock(cls, obj, lock, true);}static Class initializeAndMaybeRelock(Class cls, id inst, mutex_t&amp; lock, bool leaveLocked){ Â·Â·Â· initializeNonMetaClass(nonmeta); Â·Â·Â·} åœ¨initializeNonMetaClassé€’å½’è°ƒç”¨çˆ¶ç±»çš„initializeï¼Œç„¶åè°ƒç”¨callInitialize 12345678910111213141516171819202122/************************************************************************ class_initialize. Send the '+initialize' message on demand to any* uninitialized class. Force initialization of superclasses first.**********************************************************************/void initializeNonMetaClass(Class cls){ ... supercls = cls-&gt;superclass; if (supercls &amp;&amp; !supercls-&gt;isInitialized()) { initializeNonMetaClass(supercls); } ... { callInitialize(cls); if (PrintInitializing) { _objc_inform(&quot;INITIALIZE: thread %p: finished +[%s initialize]&quot;, pthread_self(), cls-&gt;nameForLogging()); } } ...} callInitializeæ˜¯ä¸€ä¸ªæ™®é€šçš„æ¶ˆæ¯å‘é€ 12345void callInitialize(Class cls){ ((void(*)(Class, SEL))objc_msgSend)(cls, SEL_initialize); asm(&quot;&quot;);} æ€»ç»“ initializeåœ¨ç±»æˆ–è€…å…¶å­ç±»çš„ç¬¬ä¸€ä¸ªæ–¹æ³•è¢«è°ƒç”¨å‰ï¼ˆå‘é€æ¶ˆæ¯å‰ï¼‰è°ƒç”¨ åªåœ¨ç±»ä¸­æ·»åŠ initializeä½†ä¸ä½¿ç”¨çš„æƒ…å†µä¸‹ï¼Œæ˜¯ä¸ä¼šè°ƒç”¨initialize çˆ¶ç±»çš„initializeæ–¹æ³•ä¼šæ¯”å­ç±»å…ˆæ‰§è¡Œ å½“å­ç±»æœªå®ç°initializeæ–¹æ³•æ—¶ï¼Œä¼šè°ƒç”¨çˆ¶ç±»initializeæ–¹æ³•ï¼›å­ç±»å®ç°initializeæ–¹æ³•æ—¶ï¼Œä¼šè¦†ç›–çˆ¶ç±»initializeæ–¹æ³• å½“æœ‰å¤šä¸ªåˆ†ç±»éƒ½å®ç°äº†initializeæ–¹æ³•ï¼Œä¼šè¦†ç›–ç±»ä¸­çš„æ–¹æ³•ï¼Œåªæ‰§è¡Œä¸€ä¸ª(ä¼šæ‰§è¡Œæœ€åè¢«åŠ è½½åˆ°å†…å­˜ä¸­çš„åˆ†ç±»çš„æ–¹æ³•) ä¸ƒã€ç›¸å…³é¢è¯•é¢˜7.1 ç±»æ‹“å±•å’Œåˆ†ç±»çš„åŒºåˆ«â‘ åŒºåˆ«ï¼š ç±»æ‹“å±•å¯ä»¥æ·»åŠ å±æ€§(ç¼–è¯‘å™¨ä¼šå¸®åŠ©æˆ‘ä»¬ç”Ÿæˆå±æ€§å¯¹åº”çš„getå’Œsetæ–¹æ³•)ï¼Œæ–¹æ³• åˆ†ç±»åªèƒ½æ·»åŠ æ–¹æ³•ï¼Œé€šå¸¸ä¸èƒ½æ·»åŠ å±æ€§ï¼ˆæ·»åŠ çš„è¯éœ€è¦ä½¿ç”¨å…³è”å¯¹è±¡ï¼‰ åŸå› ï¼š ç±»æ‹“å±•åœ¨ç¼–è¯‘æ—¶å®ŒæˆåŠ è½½ï¼Œæ•°æ®å†™å…¥åˆ°roä¸­ï¼› è€Œåˆ†ç±»åœ¨è¿è¡Œæ—¶åŠ è½½ï¼Œæ‰€ä»¥æ•°æ®å†™å…¥åˆ°rwä¸­ï¼Œæ²¡æœ‰å®ç°å¯¹åº”çš„setå’Œgetæ–¹æ³•ï¼Œæ‰€ä»¥æ— æ³•å°†å±æ€§çš„å€¼èµ‹å€¼è¿›å»ï¼Œä¹Ÿæ— æ³•å–åˆ°ã€‚ â‘¡ç±»æ‹“å±•åœ¨ä»£ç å®ç°å½¢å¼æœ‰2ç§æ–¹å¼ï¼Œç¬¬ä¸€ç§å†™åˆ°æ‰€åœ¨æœ¬ç±»çš„.mæ–‡ä»¶ä¸­ï¼Œç¬¬äºŒç§å¦ä¸€ä¸ªå•å†™ä¸€ä¸ª.hæ–‡ä»¶ã€‚ å¸¸ç”¨ç¬¬ä¸€ç§ï¼š ç¬¬äºŒç§ï¼š **â‘¢åŠ è½½æ—¶æœºçš„åŒºåˆ«ï¼š ** åœ¨ç±»çš„åŠ è½½è¿‡ç¨‹ä¸­â€”read_imageså¤„è®¾ç½®æ–­ç‚¹ï¼Œè¿è¡Œè¿›å…¥æ–­ç‚¹ï¼Œæ‰“å°å‘ç°roä¸­åŒ…å«ç±»æ‹“å±•çš„å±æ€§å’Œç›¸åº”çš„getï¼Œsetæ–¹æ³•ï¼Œå¯ä»¥åˆ¤æ–­å‡ºç±»æ‹“å±•åœ¨ç¼–è¯‘æ—¶å°±åŠ è½½äº†ã€‚è€Œæ­¤æ—¶ç±»åŠ è½½åæ²¡æœ‰åˆ†ç±»çš„ä¿¡æ¯ï¼Œç”±æ­¤å¯ä»¥åˆ¤æ–­åˆ†ç±»æ˜¯åœ¨è¿è¡Œæ—¶åŠ è½½è¿›æ¥çš„ã€‚ ä¸‹å›¾æ–­ç‚¹ä¿¡æ¯å›¾ï¼š ä¸‹å›¾roä¸­æŸ¥æ‰¾ä¿¡æ¯å›¾ï¼š â‘£ç±»æ‹“å±•å’Œåˆ†ç±»çš„åŒºåˆ« ç ”ç©¶å¯¹è±¡ åŠ è½½æ—¶æœº æ“ä½œå¯¹è±¡ èƒ½å¦é€šè¿‡@propertyå£°æ˜å±æ€§ç”Ÿæˆ getter å’Œ setter åˆ†ç±»(å®ç°äº†loadæ–¹æ³•) è¿è¡Œæ—¶ rw ä¸èƒ½ï¼Œéœ€è¦å€ŸåŠ©å…³è”å¯¹è±¡æ¥å®ç° åˆ†ç±»(æ²¡æœ‰å®ç°loadæ–¹æ³•) ç¼–è¯‘æ—¶ ro ä¸èƒ½ï¼Œéœ€è¦å€ŸåŠ©å…³è”å¯¹è±¡æ¥å®ç° ç±»æ‹“å±• ç¼–è¯‘æ—¶ ro å¯ä»¥ 7.2 åˆ†ç±»ä¸­å¯ä»¥é€šè¿‡å…³è”å¯¹è±¡æ·»åŠ å±æ€§7.2.1 å…³è”å¯¹è±¡çš„å®šä¹‰å’ŒåŸºæœ¬ä½¿ç”¨ é€šè¿‡ä½¿ç”¨å…³è”å¼•ç”¨ï¼Œä½ å¯ä»¥åœ¨ä¸ä¿®æ”¹ç±»å£°æ˜çš„å‰æä¸‹ä¸ºå¯¹è±¡æ·»åŠ å†…å®¹ã€‚å¦‚æœä½ æ— æƒè®¿é—®è¯¥ç±»çš„æºä»£ç ï¼Œæˆ–è€…ç”±äºäºŒè¿›åˆ¶å…¼å®¹æ€§åŸå› è€Œæ— æ³•æ›´æ”¹è¯¥å¯¹è±¡çš„å¸ƒå±€ï¼Œåˆ™è¿™å¯èƒ½å¾ˆæœ‰ç”¨ã€‚ å…³è”å¼•ç”¨æœºåˆ¶åŸºäº keyã€‚å¯¹äºä»»ä½•å¯¹è±¡ï¼Œä½ éƒ½å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ ä»»æ„æ•°é‡çš„å…³è”å¼•ç”¨ï¼Œæ¯ä¸ªå…³è”éƒ½ä½¿ç”¨ä¸åŒçš„ keyã€‚ ä»è‹¹æœå®˜æ–¹æ–‡æ¡£å¯ä»¥çœ‹åˆ°ï¼Œå…³è”å¼•ç”¨å…¶å®ä¸æ˜¯åªèƒ½åœ¨åˆ†ç±»ä¸­ä½¿ç”¨ï¼Œåªä¸è¿‡å¯¹äºæˆ‘ä»¬æ—¥å¸¸å¼€å‘æ¥è¯´ï¼Œåˆ†ç±»ä¸­ä½¿ç”¨å…³è”å¼•ç”¨è¿˜æ˜¯æ›´å¸¸ç”¨çš„åœºæ™¯ã€‚å…³è”å¯¹è±¡ä½¿ç”¨èµ·æ¥å¾ˆç®€å•ï¼Œä¸å¤–ä¹ä¸¤ä¸ªæ–¹æ³•ï¼š 12345// è®¾ç½®å…³è”å¯¹è±¡objc_setAssociatedObject()// è·å–å…³è”å¯¹è±¡objc_getAssociatedObject() æˆ‘ä»¬å¦‚æœè¦ç»™ä¸€ä¸ªåˆ†ç±»ä¸­çš„å±æ€§è®¾ç½®å…³è”å¯¹è±¡ï¼Œéœ€è¦é‡å†™å±æ€§çš„ setter æ–¹æ³•ï¼Œç„¶åä½¿ç”¨ objc_setAssociatedObjectï¼š 123- (void)setXXX:(å…³è”å€¼æ•°æ®ç±»å‹)å…³è”å€¼ objc_setAssociatedObject(self, å…³è”çš„key, å…³è”å€¼, å…³è”å¯¹è±¡å†…å­˜ç®¡ç†ç­–ç•¥);} ç„¶åè¿˜éœ€è¦é‡å†™ getter æ–¹æ³•ï¼Œç„¶åä½¿ç”¨ objc_getAssociatedObjectï¼š 123- (å…³è”å€¼æ•°æ®ç±»å‹)å…³è”å€¼{ return objc_getAssociatedObject(self, å…³è”çš„key);} è¿™å…¶ä¸­çš„å…³è”å¯¹è±¡å†…å­˜ç®¡ç†ç­–ç•¥å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š å…³è”ç­–ç•¥ ç­‰åŒçš„ @property æè¿° OBJC_ASSOCIATION_ASSIGN @property (assign) æˆ– @property (unsafe_unretained) æŒ‡å®šä¸€ä¸ªå…³è”å¯¹è±¡çš„å¼±å¼•ç”¨ã€‚ æŒ‡å®šä¸€ä¸ªå…³è”å¯¹è±¡çš„å¼±å¼•ç”¨ã€‚ OBJC_ASSOCIATION_RETAIN_NONATOMIC @property (nonatomic, strong) æŒ‡å®šä¸€ä¸ªå…³è”å¯¹è±¡çš„å¼ºå¼•ç”¨ï¼Œä¸èƒ½è¢«åŸå­åŒ–ä½¿ç”¨ã€‚ OBJC_ASSOCIATION_COPY_NONATOMIC @property (nonatomic, copy) æŒ‡å®šä¸€ä¸ªå…³è”å¯¹è±¡çš„copyå¼•ç”¨ï¼Œä¸èƒ½è¢«åŸå­åŒ–ä½¿ç”¨ã€‚ OBJC_ASSOCIATION_RETAIN @property (atomic, strong) æŒ‡å®šä¸€ä¸ªå…³è”å¯¹è±¡çš„å¼ºå¼•ç”¨ï¼Œèƒ½è¢«åŸå­åŒ–ä½¿ç”¨ã€‚ OBJC_ASSOCIATION_COPY @property (atomic, copy) æŒ‡å®šä¸€ä¸ªå…³è”å¯¹è±¡çš„copyå¼•ç”¨ï¼Œèƒ½è¢«åŸå­åŒ–ä½¿ç”¨ã€‚ 7.2.3 å…³è”å¯¹è±¡çš„åº•å±‚åŸç†æ€»ç»“å›¾ï¼š objc_setAssociatedObject1234// objc-runtime.mmvoid objc_setAssociatedObject(id object, const void *key, id value, objc_AssociationPolicy policy) { _object_set_associative_reference(object, (void *)key, value, policy);} objc_setAssociatedObject æ–¹æ³•çš„å®ç°åˆåŒ…è£¹äº†ä¸€å±‚ï¼Œå…¶å®ç°ä¸º _object_set_associative_reference åˆ†æ_object_set_associative_referenceæ–¹æ³•ï¼Œç›´æ¥çœ‹æ·»åŠ æ³¨é‡Šåçš„ä»£ç å°±èƒ½æ˜ç™½ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970void _object_set_associative_reference(id object, void *key, id value, uintptr_t policy) { // This code used to work when nil was passed for object and key. Some code // probably relies on that to not crash. Check and handle it explicitly. // rdar://problem/44094390 // å®¹é”™å¤„ç† if (!object &amp;&amp; !value) return; assert(object); // åˆ¤æ–­è¦è¿›è¡Œå…³è”çš„å¯¹è±¡æ˜¯å¦ç¦ç”¨æ‰äº†å…³è”å¼•ç”¨ if (object-&gt;getIsa()-&gt;forbidsAssociatedObjects()) _objc_fatal(&quot;objc_setAssociatedObject called on instance (%p) of class %s which does not allow associated objects&quot;, object, object_getClassName(object)); // retain the new value (if any) outside the lock. // åˆå§‹åŒ–ä¸€ä¸ª ObjcAssociation å¯¹è±¡ï¼Œç”¨äºæŒæœ‰åŸæœ‰çš„å…³è”å¯¹è±¡ ObjcAssociation old_association(0, nil); // åˆ¤æ–­ä¼ å…¥çš„å…³è”å¯¹è±¡å€¼æ˜¯å¦å­˜åœ¨ id new_value = value ? acquireValue(value, policy) : nil; { // å…³è”å¯¹è±¡çš„ç®¡ç†ç±» AssociationsManager manager; // è·å–å…³è”çš„ HashMap -&gt; å­˜å‚¨å½“å‰å…³è”å¯¹è±¡ AssociationsHashMap &amp;associations(manager.associations()); // å¯¹å½“å‰å¯¹è±¡çš„åœ°å€åšæŒ‰ä½å–åæ“ä½œ - å°±æ˜¯ HashMap çš„key (å“ˆå¸Œå‡½æ•°) disguised_ptr_t disguised_object = DISGUISE(object); if (new_value) { // break any existing association. // è·å– AssociationsHashMap çš„è¿­ä»£å™¨ - (å¯¹è±¡çš„) è¿›è¡Œéå† AssociationsHashMap::iterator i = associations.find(disguised_object); if (i != associations.end()) { // secondary table exists ObjectAssociationMap *refs = i-&gt;second; // æ ¹æ®keyå»è·å–å…³è”å±æ€§çš„è¿­ä»£å™¨ ObjectAssociationMap::iterator j = refs-&gt;find(key); if (j != refs-&gt;end()) { old_association = j-&gt;second; // æ›¿æ¢è®¾ç½®æ–°å€¼ j-&gt;second = ObjcAssociation(policy, new_value); } else { // åˆ°æœ€åäº†â€”â€”ç›´æ¥è®¾ç½®æ–°å€¼ (*refs)[key] = ObjcAssociation(policy, new_value); } } else { // create the new association (first time). // å¦‚æœAssocistionsHashMapæ²¡æœ‰å¯¹è±¡çš„å…³è”ä¿¡æ¯è¡¨ // é‚£ä¹ˆå°±åˆ›å»ºä¸€ä¸ªmapå¹¶é€šè¿‡ä¼ å…¥çš„keyæŠŠvalueå­˜è¿›å» ObjectAssociationMap *refs = new ObjectAssociationMap; associations[disguised_object] = refs; (*refs)[key] = ObjcAssociation(policy, new_value); object-&gt;setHasAssociatedObjects(); } } else { // setting the association to nil breaks the association. // å¦‚æœä¼ å…¥çš„valueæ˜¯nilï¼Œå¹¶ä¸”ä¹‹å‰ä½¿ç”¨ç›¸åŒçš„keyå­˜å‚¨è¿‡å…³è”å¯¹è±¡ï¼Œ // é‚£ä¹ˆå°±æŠŠè¿™ä¸ªå…³è”çš„valueç§»é™¤ï¼ˆè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¼ å…¥nilå¯¹è±¡èƒ½å¤ŸæŠŠå¯¹è±¡çš„å…³è”valueç§»é™¤ï¼‰ AssociationsHashMap::iterator i = associations.find(disguised_object); if (i != associations.end()) { ObjectAssociationMap *refs = i-&gt;second; ObjectAssociationMap::iterator j = refs-&gt;find(key); if (j != refs-&gt;end()) { old_association = j-&gt;second; refs-&gt;erase(j); } } } } // release the old value (outside of the lock). // æœ€åæŠŠä¹‹å‰ä½¿ç”¨ä¼ å…¥çš„è¿™ä¸ªkeyå­˜å‚¨çš„å…³è”çš„valueé‡Šæ”¾ï¼ˆOBJC_ASSOCIATION_SETTER_RETAINç­–ç•¥å­˜å‚¨çš„ï¼‰ if (old_association.hasValue()) ReleaseValue()(old_association);} objc_getAssociatedObject123id objc_getAssociatedObject(id object, const void *key) { return _object_get_associative_reference(object, (void *)key);} åŒæ ·ä¹Ÿæ˜¯åŒ…è£…äº†ä¸€å±‚ï¼Œåˆ†æ_object_get_associative_referenceæ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132id _object_get_associative_reference(id object, void *key) { id value = nil; uintptr_t policy = OBJC_ASSOCIATION_ASSIGN; { // å…³è”å¯¹è±¡çš„ç®¡ç†ç±» AssociationsManager manager; AssociationsHashMap &amp;associations(manager.associations()); // ç”Ÿæˆä¼ªè£…åœ°å€ã€‚å¤„ç†å‚æ•° object åœ°å€ disguised_ptr_t disguised_object = DISGUISE(object); // æ‰€æœ‰å¯¹è±¡çš„é¢è¿­ä»£å™¨ AssociationsHashMap::iterator i = associations.find(disguised_object); if (i != associations.end()) { // è¿˜æ²¡åˆ°æœ€åå°±æ‰¾åˆ°äº† ObjectAssociationMap *refs = i-&gt;second; // å†…éƒ¨å¯¹è±¡çš„è¿­ä»£å™¨ ObjectAssociationMap::iterator j = refs-&gt;find(key); if (j != refs-&gt;end()) { // æ‰¾åˆ° - æŠŠå€¼å’Œç­–ç•¥è¯»å–å‡ºæ¥ ObjcAssociation &amp;entry = j-&gt;second; value = entry.value(); policy = entry.policy(); // å¦‚æœç­–ç•¥æ˜¯ OBJC_ASSOCIATION_GETTER_RETAIN - å°±ä¼šæŒæœ‰ä¸€ä¸‹ if (policy &amp; OBJC_ASSOCIATION_GETTER_RETAIN) { objc_retain(value); } } } } if (value &amp;&amp; (policy &amp; OBJC_ASSOCIATION_GETTER_AUTORELEASE)) { objc_autorelease(value); } return value;} objc_removeAssociatedObjectsobjc_removeAssociatedObjects æ–¹æ³•æˆ‘ä»¬å¹³æ—¶å¯èƒ½ç”¨çš„ä¸å¤šï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥åˆ é™¤å…³è”å¯¹è±¡ã€‚æˆ‘ä»¬æ¥åˆ°å®ƒçš„å®šä¹‰å¤„ï¼š 123456void objc_removeAssociatedObjects(id object) { if (object &amp;&amp; object-&gt;hasAssociatedObjects()) { _object_remove_assocations(object); }} åˆ†æ_object_remove_assocationsæ–¹æ³•ï¼š 123456789101112131415161718192021222324252627void _object_remove_assocations(id object) { vector&lt; ObjcAssociation,ObjcAllocator&lt;ObjcAssociation&gt; &gt; elements; { // å…³è”å¯¹è±¡çš„ç®¡ç†ç±» AssociationsManager manager; // è·å–å…³è”çš„ HashMap -&gt; å­˜å‚¨å½“å‰å…³è”å¯¹è±¡ AssociationsHashMap &amp;associations(manager.associations()); if (associations.size() == 0) return; // å¯¹å½“å‰å¯¹è±¡çš„åœ°å€åšæŒ‰ä½å–åæ“ä½œ disguised_ptr_t disguised_object = DISGUISE(object); // è·å– AssociationsHashMap çš„è¿­ä»£å™¨ - (å¯¹è±¡çš„) è¿›è¡Œéå† AssociationsHashMap::iterator i = associations.find(disguised_object); if (i != associations.end()) { // è¿˜æ²¡åˆ°æœ€åæ‰¾åˆ°äº† // copy all of the associations that need to be removed. ObjectAssociationMap *refs = i-&gt;second; for (ObjectAssociationMap::iterator j = refs-&gt;begin(), end = refs-&gt;end(); j != end; ++j) { elements.push_back(j-&gt;second); } // remove the secondary table. delete refs; associations.erase(i); } } // the calls to releaseValue() happen outside of the lock. // è¿™é‡Œä¼šå°†å¯¹è±¡åŒ…å«çš„æ‰€æœ‰å…³è”å¯¹è±¡åŠ å…¥åˆ°ä¸€ä¸ª `vector` ä¸­ï¼Œç„¶åå¯¹æ‰€æœ‰çš„ `ObjcAssociation` å¯¹è±¡è°ƒç”¨ `ReleaseValue()` æ–¹æ³•ï¼Œé‡Šæ”¾ä¸å†è¢«éœ€è¦çš„å€¼ for_each(elements.begin(), elements.end(), ReleaseValue());} PSobjc4-756.2æºç æœ¬æ–‡ä½¿ç”¨ï¼šobjc4-756.2æºç  è¿›è¡Œåˆ†æ å‚è€ƒiOS åº•å±‚æ¢ç´¢ - åˆ†ç±»çš„åŠ è½½ iOSæ¢ç´¢ åˆ†ç±»ã€ç±»æ‹“å±•çš„åŠ è½½è¿‡ç¨‹ iOS åº•å±‚æ¢ç´¢ - ç±»æ‹“å±•å’Œå…³è”å¯¹è±¡","link":"/2021/01/25/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/09-%E5%88%86%E7%B1%BB%E3%80%81%E7%B1%BB%E6%8B%93%E5%B1%95%E7%9A%84%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B/"},{"title":"ã€Šæ©˜å­ä¸æ˜¯å”¯ä¸€çš„æ°´æœã€‹è¯»ä¹¦ç¬”è®°","text":"è¿™æœ¬ä¹¦å‰åŠéƒ¨åˆ†è¿˜æŒºå…·æœ‰è‹±å¼å¹½é»˜çš„ï¼Œå½“åˆåœ¨ä¹¦åº—çœ‹åˆ°ä¸€äº›ç‰‡æ®µçš„æ—¶å€™éƒ½æœ‰ç‚¹å¿ä¸ä½ã€‚ä¸è¿‡åœ¨ååŠéƒ¨åˆ†ï¼Œå½“ä½œè€…ç»å†äº†ä¸€äº›å˜æ•…åï¼Œæ›´å¤šæ˜¯å¸¦æœ‰ä¸€ç§å¿§éƒå’Œæ·¡ç„¶çš„å¿ƒæ€åœ¨è®²è¿°ã€‚æˆ‘è¾¹è¯»è¾¹æƒ³è±¡ä½œè€…çå¦®ç‰¹Â·æ¸©ç‰¹æ£®çš„æ ·å­ï¼Œæˆ‘å¯¹äºä½œè€…æœ¬äººçš„å¹»æƒ³æ˜¯è¿™æ ·çš„ï¼š ä¸€åŒå¿§éƒåˆå¸¦æœ‰è´¨ç–‘çš„çœ¼ç›ï¼Œä»¥åŠåˆ©è½ä¸åŠ ä¿®é¥°å°±é€éœ²å‡ºæ¥çš„è¿·äººæ°”æ¯ã€‚ åæ¥æœäº†ä¸‹æœ¬äººç…§ç‰‡ï¼š æƒ³è±¡ä¸å‡ºå¥¹èƒ½å†™å‡ºæƒ…æ„Ÿå˜åŒ–å¦‚æ­¤ç»†è…»çš„æ–‡å­—ã€‚ æ¢—æ¦‚ï¼šä½œè€…å‡ºç”Ÿåè¢«ä¸€ä¸ªä¿¡æ•™çš„å®¶åº­æ”¶å…»ï¼Œåœ¨æ¯äº²çš„æ•™è‚²ä¸‹ï¼Œè™”è¯šçš„æ•™å¾’æ€æƒ³æ„ç­‘äº†å¥¹çš„åŸºæœ¬ä¸–ç•Œè§‚ã€‚ç„¶è€Œä¸Šå¸å¹¶ä¸èƒ½å¸®å¥¹ä»å¤–ç•Œè®¤ä¸ºçš„â€œç½ªæ¶â€å’Œä¸å¯æŠ‘åˆ¶çš„çˆ±ä¸Šä¸€ä¸ªå¥³å­©çš„çœŸå®æƒ…æ„«ä¸­è§£è„±ï¼Œç”šè‡³å¯¼è‡´è¢«æ¯äº²é€å‡ºå®¶é—¨ã€‚ä½œè€…å°±æ˜¯åœ¨è¿™ç§çŸ›ç›¾å’Œå¯¹ä¸–ç•Œçš„æ‰¹åˆ¤ä¸­è—åŒ¿ã€æˆé•¿ã€‚å¤šå¹´åå†å›å®¶ï¼Œæ¯äº²å·²å®Œå…¨é‡Šç„¶ï¼Œæ­¤æ—¶çš„ä½œè€…åˆæ˜¯å¦ä¸€ç§ä¸åŒçš„å¿ƒå¢ƒã€‚ ä½œè€…ä»å°åŸºæœ¬ä¸Šå°±åªåƒæ©˜å­è¿™ä¸€ç§æ°´æœï¼Œç‚¹ç›ä¹‹ç¬”ä¹Ÿæ­£æ˜¯é¢˜ç›®è¿™å¥ä»æ¯äº²å£ä¸­è¯´å‡ºçš„â€œæ©˜å­ä¸æ˜¯å”¯ä¸€çš„æ°´æœâ€ï¼Œæ„æ€æ˜¯è¿™ä¸–ç•Œä¸Šæ¯ä¸ªäººéƒ½æ˜¯ä¸åŒçš„å­˜åœ¨ï¼Œä¸èƒ½ç”¨åŒæ ·çš„è§‚ç‚¹å»å®¡è§†å’Œè¯„ä»·ä¸€ä¸ªäººï¼Œä½ ä¸ç†è§£å¹¶ä¸ä»£è¡¨åˆ«äººçš„äººç”Ÿå°±æ˜¯ç½ªæ¶çš„ï¼Œè¿™ä¹Ÿæ˜¯ä¸–ç•Œä¸°å¯Œå¤šå½©çš„åŸå› ã€‚ è¿™æœ¬ä¹¦çªå‡ºäº†å®¶åº­å¯¹ä¸ªäººæˆé•¿çš„é‡è¦ä½œç”¨ï¼Œè¿™æ˜¯ä½ æ— æ³•æ‘†è„±çš„æ—¢å®šäº‹å®ï¼Œä¸ªäººçœ‹å¾…è¿™ä¸ªä¸–ç•Œçš„æ–¹å¼ä¹Ÿä¸€å®šä¼šå—åˆ°å…¶å½±å“ã€‚åŒæ—¶å‘Šè¯«æˆ‘ä»¬ä¸å¿…å¯¹è¿™ä¸ªä¸–ç•Œå®Œå…¨å±ˆä»ï¼Œå¯ä»¥æŒæœ‰ä½ è‡ªå·±çš„æ€€ç–‘å’Œåå›ï¼Œè™½ç„¶ç»“æœä¸ä¸€å®šå®Œç¾ï¼Œä½†è¿™å°±æ˜¯ä½ çœŸå®çš„è‡ªå·±ã€‚ä½œè€…æ•æ‰äº†ç‰¹åˆ«å¤šå¾®å°çš„ç»†èŠ‚ï¼Œè®©æˆ‘æ„Ÿè§‰å¥¹çš„å¿ƒæ€éå¸¸ç»†è…»ã€‚ é¢˜å¤–è¯ï¼š æ–‡ä¸­æåˆ°äº†å†°æ·‡æ·‹è–„è„†ï¼Œå¬åå­—åº”è¯¥æŒºå¥½åƒçš„ã€‚ ä½œè€…èƒ½æ­¥è¡Œå¥½å‡ è‹±é‡Œå»æ‰¾æ¢…å…°å¦®ã€‚å¥¹éšä¾¿ä¸€èµ°å°±æ˜¯å‡ è‹±é‡Œè®©æˆ‘è§‰å¾—ç°ä»£äººçš„è¿åŠ¨é‡çœŸçš„æ˜¯å¤ªå°‘äº†ï¼ˆè¿™é‡Œçš„ç°ä»£äººä¹ŸåŒ…å«æˆ‘è‡ªå·±ï¼‰ã€‚","link":"/2021/05/10/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E3%80%8A%E6%A9%98%E5%AD%90%E4%B8%8D%E6%98%AF%E5%94%AF%E4%B8%80%E7%9A%84%E6%B0%B4%E6%9E%9C%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"},{"title":"15-å¤šçº¿ç¨‹ä¹‹åŸºç¡€åŸç†","text":"ä¸€ã€è¿›ç¨‹ã€çº¿ç¨‹ã€é˜Ÿåˆ—1.1 è¿›ç¨‹è¿›ç¨‹æ˜¯æŒ‡åœ¨ç³»ç»Ÿä¸­æ­£åœ¨è¿è¡Œçš„ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œæ¯ä¸ªè¿›ç¨‹ä¹‹é—´æ˜¯ç‹¬ç«‹çš„ï¼Œæ¯ä¸ªè¿›ç¨‹å‡è¿è¡Œåœ¨å…¶ä¸“ç”¨ä¸”å—ä¿æŠ¤çš„å†…å­˜ç©ºé—´å†…ã€‚ 1.2 çº¿ç¨‹çº¿ç¨‹ï¼ˆThreadï¼‰ï¼Œæ˜¯ç¨‹åºæ‰§è¡Œæµçš„æœ€å°å•ä½ã€‚ ä¸€ä¸ªæ ‡å‡†çš„çº¿ç¨‹ç”±çº¿ç¨‹IDã€å½“å‰æŒ‡ä»¤æŒ‡é’ˆï¼ˆPCï¼‰ã€å¯„å­˜å™¨é›†åˆå’Œå †æ ˆç»„æˆã€‚é€šå¸¸ä¸€ä¸ªè¿›ç¨‹ç”±ä¸€ä¸ªåˆ°å¤šä¸ªçº¿ç¨‹ç»„æˆï¼Œå„ä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«ç¨‹åºçš„å†…å­˜ç©ºé—´ï¼ˆåŒ…æ‹¬ä»£ç æ®µã€æ•°æ®æ®µã€å †ç­‰ï¼‰åŠä¸€äº›è¿›ç¨‹çº§ç­‰èµ„æºï¼ˆå¦‚æ‰“å¼€æ–‡ä»¶å’Œä¿¡å·ï¼‰ã€‚ä¸€ä¸ªç»å…¸çš„çº¿ç¨‹ä¸è¿›ç¨‹å…³ç³»å¦‚å›¾æ‰€ç¤ºï¼š 1.3 è¿›ç¨‹ä¸çº¿ç¨‹çš„å…³ç³» åœ°å€ç©ºé—´ï¼š åŒä¸€è¿›ç¨‹çš„çº¿ç¨‹å…±äº«æœ¬è¿›ç¨‹çš„åœ°å€ç©ºé—´ è¿›ç¨‹ä¹‹é—´æ˜¯ç‹¬ç«‹çš„åœ°å€ç©ºé—´ èµ„æºæ‹¥æœ‰ï¼š åŒä¸€è¿›ç¨‹å†…çš„çº¿ç¨‹å…±äº«æœ¬è¿›ç¨‹çš„èµ„æºå¦‚å†…å­˜ã€I/Oã€cpu ç­‰ è¿›ç¨‹ä¹‹é—´çš„èµ„æºæ˜¯ç‹¬ç«‹çš„ å¥å£®æ€§ï¼š ä¸€ä¸ªè¿›ç¨‹å´©æºƒåï¼Œåœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ä¸ä¼šå¯¹å…¶ä»–è¿›ç¨‹äº§ç”Ÿå½±å“ ä½†æ˜¯ä¸€ä¸ªçº¿ç¨‹å´©æºƒæ•´ä¸ªè¿›ç¨‹éƒ½æ­»æ‰ï¼Œæ‰€ä»¥å¤šè¿›ç¨‹è¦æ¯”å¤šçº¿ç¨‹å¥å£® èµ„æºæ¶ˆè€—ï¼š è¿›ç¨‹åˆ‡æ¢æ—¶ï¼Œæ¶ˆè€—çš„èµ„æºå¤§ã€‚ çº¿ç¨‹æ— æ³•åˆ‡æ¢ï¼Œåªèƒ½äº’ç›¸é€šä¿¡ï¼Œæ¶ˆè€—çš„èµ„æºè¾ƒå° æ‰§è¡Œè¿‡ç¨‹ï¼š æ¯ä¸ªç‹¬ç«‹çš„è¿›ç¨‹æœ‰ä¸€ä¸ªç¨‹åºè¿è¡Œçš„å…¥å£ã€é¡ºåºæ‰§è¡Œåºåˆ—å’Œç¨‹åºå…¥å£ã€‚ ä½†æ˜¯çº¿ç¨‹ä¸èƒ½ç‹¬ç«‹æ‰§è¡Œï¼Œå¿…é¡»ä¾å­˜åœ¨åº”ç”¨ç¨‹åºä¸­ï¼Œç”±åº”ç”¨ç¨‹åºæä¾›å¤šä¸ªçº¿ç¨‹æ‰§è¡Œæ§åˆ¶ çº¿ç¨‹æ˜¯å¤„ç†å™¨è°ƒåº¦çš„åŸºæœ¬å•ä½ï¼Œä½†è¿›ç¨‹ä¸æ˜¯ 1.4 é˜Ÿåˆ—é˜Ÿåˆ—ï¼Œæ˜¯å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼š First-In-First-Outï¼‰çš„çº¿æ€§è¡¨ï¼Œåœ¨å…·ä½“åº”ç”¨ä¸­é€šå¸¸ç”¨é“¾è¡¨æˆ–è€…æ•°ç»„æ¥å®ç°ã€‚è£…è½½çº¿ç¨‹ä»»åŠ¡çš„é˜Ÿå½¢ç»“æ„ã€‚é˜Ÿåˆ—åªå…è®¸åœ¨åç«¯è¿›è¡Œæ’å…¥æ“ä½œï¼Œåœ¨å‰ç«¯è¿›è¡Œåˆ é™¤æ“ä½œã€‚é˜Ÿåˆ—çš„æ“ä½œæ–¹å¼å’Œå †æ ˆç±»ä¼¼ï¼Œå”¯ä¸€çš„åŒºåˆ«åœ¨äºé˜Ÿåˆ—åªå…è®¸æ–°æ•°æ®åœ¨åç«¯è¿›è¡Œæ·»åŠ  é˜Ÿåˆ—è´Ÿè´£è°ƒåº¦ä»»åŠ¡ï¼Œçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ 1.5 çº¿ç¨‹å’Œ runloop çš„å…³ç³» runloop ä¸çº¿ç¨‹æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼šä¸€ä¸ªrunloopå¯¹åº”ä¸€ä¸ªæ ¸å¿ƒçš„çº¿ç¨‹ï¼Œä¸ºä»€ä¹ˆè¯´æ˜¯æ ¸å¿ƒçš„ï¼Œæ˜¯å› ä¸º runloop æ˜¯å¯ä»¥åµŒå¥—çš„ï¼Œä½†æ˜¯æ ¸å¿ƒçš„åªèƒ½æœ‰ä¸€ä¸ªï¼Œä»–ä»¬çš„å…³ç³»ä¿å­˜åœ¨ä¸€ä¸ªå…¨å±€çš„å­—å…¸é‡Œ runloop æ˜¯æ¥ç®¡ç†çº¿ç¨‹çš„ï¼šå½“çº¿ç¨‹çš„runloopè¢«å¼€å¯åï¼Œçº¿ç¨‹ä¼šåœ¨æ‰§è¡Œå®Œä»»åŠ¡åè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œæœ‰äº†ä»»åŠ¡å°±ä¼šè¢«å”¤é†’å»æ‰§è¡Œä»»åŠ¡ runloopåœ¨ç¬¬ä¸€æ¬¡è·å–æ—¶è¢«åˆ›å»ºï¼Œåœ¨çº¿ç¨‹ç»“æŸæ—¶è¢«é”€æ¯ å¯¹äºä¸»çº¿ç¨‹æ¥è¯´ï¼Œrunloopåœ¨ç¨‹åºä¸€å¯åŠ¨å°±é»˜è®¤åˆ›å»ºå¥½äº† å¯¹äºå­çº¿ç¨‹æ¥è¯´ï¼Œrunloopæ˜¯æ‡’åŠ è½½çš„â€”â€”åªæœ‰å½“æˆ‘ä»¬ä½¿ç”¨çš„æ—¶å€™æ‰ä¼šåˆ›å»ºï¼Œæ‰€ä»¥åœ¨å­çº¿ç¨‹ç”¨å®šæ—¶å™¨è¦æ³¨æ„ï¼šç¡®ä¿å­çº¿ç¨‹çš„runloopè¢«åˆ›å»ºï¼Œä¸ç„¶å®šæ—¶å™¨ä¸ä¼šå›è°ƒ äºŒã€å¤šçº¿ç¨‹2.1 å¤šçº¿ç¨‹åŸç† åŒä¸€æ—¶é—´ï¼ŒCPU åªèƒ½å¤„ç†ä¸€æ¡çº¿ç¨‹ï¼Œåªæœ‰ä¸€æ¡çº¿ç¨‹åœ¨æ‰§è¡Œ å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œï¼Œå…¶å®å°±æ˜¯ CPU æ‰§è¡Œå¿«é€Ÿåœ°åœ¨å¤šæ¡çº¿ç¨‹ä¹‹é—´åˆ‡æ¢ 2.2 å¤šçº¿ç¨‹æ„ä¹‰ ä¼˜ç‚¹ èƒ½é€‚å½“æé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ èƒ½é€‚å½“æé«˜èµ„æºçš„åˆ©ç”¨ç‡ï¼ˆCPUã€å†…å­˜ï¼‰ çº¿ç¨‹ä¸Šçš„ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œçº¿ç¨‹ä¼šè‡ªåŠ¨é”€æ¯ ç¼ºç‚¹ å¼€å¯çº¿ç¨‹éœ€è¦å ç”¨ä¸€å®šçš„å†…å­˜ç©ºé—´ï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½å 512KBï¼Œåˆ›å»ºçº¿ç¨‹å¤§çº¦éœ€è¦90æ¯«ç§’çš„åˆ›å»ºæ—¶é—´ï¼‰ å¦‚æœå¼€å¯å¤§é‡çš„çº¿ç¨‹ï¼Œä¼šå ç”¨å¤§é‡çš„å†…å­˜ç©ºé—´ï¼Œé™ä½ç¨‹åºçš„æ€§èƒ½ çº¿ç¨‹è¶Šå¤šï¼ŒCPUåœ¨è°ƒç”¨çº¿ç¨‹ä¸Šçš„å¼€é”€å°±è¶Šå¤§ ç¨‹åºè®¾è®¡æ›´åŠ å¤æ‚ï¼Œæ¯”å¦‚çº¿ç¨‹é—´çš„é€šä¿¡ã€å¤šçº¿ç¨‹çš„æ•°æ®å…±äº« 2.3 å¤šçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ å¤šçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ï¼šæ–°å»º - å°±ç»ª - è¿è¡Œ - é˜»å¡ - æ­»äº¡ æ–°å»ºï¼šå®ä¾‹åŒ–çº¿ç¨‹å¯¹è±¡ å°±ç»ªï¼šå‘çº¿ç¨‹å¯¹è±¡å‘é€ start æ¶ˆæ¯ï¼Œçº¿ç¨‹å¯¹è±¡è¢«åŠ å…¥å¯è°ƒåº¦çº¿ç¨‹æ± ç­‰å¾… CPU è°ƒåº¦ã€‚ è¿è¡Œï¼šCPU è´Ÿè´£è°ƒåº¦å¯è°ƒåº¦çº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„æ‰§è¡Œã€‚çº¿ç¨‹æ‰§è¡Œå®Œæˆä¹‹å‰ï¼ŒçŠ¶æ€å¯èƒ½ä¼šåœ¨å°±ç»ªå’Œè¿è¡Œä¹‹é—´æ¥å›åˆ‡æ¢ã€‚å°±ç»ªå’Œè¿è¡Œä¹‹é—´çš„çŠ¶æ€å˜åŒ–ç”± CPU è´Ÿè´£ï¼Œç¨‹åºå‘˜ä¸èƒ½å¹²é¢„ã€‚ é˜»å¡ï¼šå½“æ»¡è¶³æŸä¸ªé¢„å®šæ¡ä»¶æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ä¼‘çœ æˆ–é”ï¼Œé˜»å¡çº¿ç¨‹æ‰§è¡Œã€‚sleepForTimeIntervalï¼ˆä¼‘çœ æŒ‡å®šæ—¶é•¿ï¼‰ï¼ŒsleepUntilDateï¼ˆä¼‘çœ åˆ°æŒ‡å®šæ—¥æœŸï¼‰ï¼Œ@synchronized(self)ï¼šï¼ˆäº’æ–¥é”ï¼‰ã€‚ æ­»äº¡ï¼šæ­£å¸¸æ­»äº¡ï¼Œçº¿ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚éæ­£å¸¸æ­»äº¡ï¼Œå½“æ»¡è¶³æŸä¸ªæ¡ä»¶åï¼Œåœ¨çº¿ç¨‹å†…éƒ¨ä¸­æ­¢æ‰§è¡Œ/åœ¨ä¸»çº¿ç¨‹ä¸­æ­¢çº¿ç¨‹å¯¹è±¡ 2.4 çº¿ç¨‹æ± çš„åŸç† è‹¥çº¿ç¨‹æ± å¤§å°å°äºæ ¸å¿ƒçº¿ç¨‹æ± å¤§å°æ—¶ åˆ›å»ºçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ è‹¥çº¿ç¨‹æ± å¤§å°å¤§äºç­‰äºæ ¸å¿ƒçº¿ç¨‹æ± å¤§å°æ—¶ å…ˆåˆ¤æ–­çº¿ç¨‹æ± å·¥ä½œé˜Ÿåˆ—æ˜¯å¦å·²æ»¡ è‹¥æ²¡æ»¡å°±å°†ä»»åŠ¡pushè¿›é˜Ÿåˆ— è‹¥å·²æ»¡æ—¶ï¼Œä¸”maximumPoolSize&gt;corePoolSizeï¼Œå°†åˆ›å»ºæ–°çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ åä¹‹åˆ™äº¤ç»™é¥±å’Œç­–ç•¥å»å¤„ç† å‚æ•°å ä»£è¡¨æ„ä¹‰ corePoolSize çº¿ç¨‹æ± çš„åŸºæœ¬å¤§å°ï¼ˆæ ¸å¿ƒçº¿ç¨‹æ± å¤§å°ï¼‰ maximumPool çº¿ç¨‹æ± çš„æœ€å¤§å¤§å° keepAliveTime çº¿ç¨‹æ± ä¸­è¶…è¿‡corePoolSizeæ ‘æœ¨çš„ç©ºé—²çº¿ç¨‹çš„æœ€å¤§å­˜æ´»æ—¶é—´ unit keepAliveTimeå‚æ•°çš„æ—¶é—´å•ä½ workQueue ä»»åŠ¡é˜»å¡é˜Ÿåˆ— threadFactory æ–°å»ºçº¿ç¨‹çš„å·¥å‚ handler å½“æäº¤çš„ä»»åŠ¡æ•°è¶…è¿‡maxmumPoolSizeä¸workQueueä¹‹å’Œæ—¶ï¼Œ ä»»åŠ¡ä¼šäº¤ç»™RejectedExecutionHandleræ¥å¤„ç† é¥±å’Œç­–ç•¥æœ‰å¦‚ä¸‹å››ä¸ªï¼š AbortPolicyç›´æ¥æŠ›å‡ºRejectedExecutionExeceptionå¼‚å¸¸æ¥é˜»æ­¢ç³»ç»Ÿæ­£å¸¸è¿è¡Œ CallerRunsPolicyå°†ä»»åŠ¡å›é€€åˆ°è°ƒç”¨è€… DisOldestPolicyä¸¢æ‰ç­‰å¾…æœ€ä¹…çš„ä»»åŠ¡ DisCardPolicyç›´æ¥ä¸¢å¼ƒä»»åŠ¡ 2.5 iOS ä¸­çš„å¤šçº¿ç¨‹æ–¹æ¡ˆ æŠ€æœ¯æ–¹æ¡ˆ ç®€ä»‹ è¯­è¨€ çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸ ä½¿ç”¨é¢‘ç‡ pthread ä¸€å¥—é€šç”¨çš„å¤šçº¿ç¨‹API é€‚ç”¨äºUnix/Linux/Windowsç­‰ç³»ç»Ÿ è·¨å¹³å°/å¯ç§»æ¤ ä½¿ç”¨éš¾åº¦å¤§ C ç¨‹åºå‘˜ç®¡ç† å‡ ä¹ä¸ç”¨ NSThread ä½¿ç”¨æ›´åŠ é¢å‘å¯¹è±¡ ç®€å•æ˜“ç”¨ï¼Œå¯ç›´æ¥æ“ä½œçº¿ç¨‹å¯¹è±¡ OC ç¨‹åºå‘˜ç®¡ç† å¶å°”ä½¿ç”¨ GCD æ—¨åœ¨æ›¿ä»£NSThreadç­‰çº¿ç¨‹æŠ€æœ¯ å……åˆ†åˆ©ç”¨è®¾å¤‡çš„å¤šæ ¸ C è‡ªåŠ¨ç®¡ç† ç»å¸¸ä½¿ç”¨ NSOperation åŸºäºGCDï¼ˆåº•å±‚æ˜¯GCDï¼‰ æ¯”GCDå¤šäº†ä¸€äº›æ›´ç®€å•å®ç”¨çš„åŠŸèƒ½ ä½¿ç”¨æ›´åŠ é¢å‘å¯¹è±¡ OC è‡ªåŠ¨ç®¡ç† ç»å¸¸ä½¿ç”¨ å¸¸ç”¨çš„å°±æ˜¯ GCD å’Œ NSOperationï¼ŒåŒºåˆ«ï¼š GCDä»…ä»…æ”¯æŒFIFOé˜Ÿåˆ—ï¼Œä¸æ”¯æŒå¼‚æ­¥æ“ä½œä¹‹é—´çš„ä¾èµ–å…³ç³»è®¾ç½®ã€‚è€ŒNSOperationä¸­çš„é˜Ÿåˆ—å¯ä»¥è¢«é‡æ–°è®¾ç½®ä¼˜å…ˆçº§ï¼Œä»è€Œå®ç°ä¸åŒæ“ä½œçš„æ‰§è¡Œé¡ºåºè°ƒæ•´ NSOperationæ”¯æŒKVOï¼Œå¯ä»¥è§‚å¯Ÿä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€ GCDæ›´æ¥è¿‘åº•å±‚ï¼ŒGCDåœ¨è¿½æ±‚æ€§èƒ½çš„åº•å±‚æ“ä½œæ¥è¯´ï¼Œæ˜¯é€Ÿåº¦æœ€å¿«çš„ ä»å¼‚æ­¥æ“ä½œä¹‹é—´çš„äº‹åŠ¡æ€§ï¼Œé¡ºåºè¡Œï¼Œä¾èµ–å…³ç³»ã€‚GCDéœ€è¦è‡ªå·±å†™æ›´å¤šçš„ä»£ç æ¥å®ç°ï¼Œè€ŒNSOperationå·²ç»å†…å»ºäº†è¿™äº›æ”¯æŒ å¦‚æœå¼‚æ­¥æ“ä½œçš„è¿‡ç¨‹éœ€è¦æ›´å¤šçš„è¢«äº¤äº’å’ŒUIå‘ˆç°å‡ºæ¥ï¼ŒNSOperationæ›´å¥½ï¼›åº•å±‚ä»£ç ä¸­ï¼Œä»»åŠ¡ä¹‹é—´ä¸å¤ªäº’ç›¸ä¾èµ–ï¼Œè€Œéœ€è¦æ›´é«˜çš„å¹¶å‘èƒ½åŠ›ï¼ŒGCDåˆ™æ›´æœ‰ä¼˜åŠ¿ 2.6 çº¿ç¨‹é—´é€šè®¯è‹¹æœå®˜æ–¹ çº¿ç¨‹ç›¸å…³çš„æ–‡æ¡£æ˜¯è¿™æ ·ä»‹ç»çš„ï¼š ç›´æ¥æ¶ˆæ¯ä¼ é€’: é€šè¿‡performSelectorçš„ä¸€ç³»åˆ—æ–¹æ³•ï¼Œå¯ä»¥å®ç°ç”±æŸä¸€çº¿ç¨‹æŒ‡å®šåœ¨å¦å¤–çš„çº¿ç¨‹ä¸Šæ‰§è¡Œä»»åŠ¡ã€‚ å…¨å±€å˜é‡ã€å…±äº«å†…å­˜å—å’Œå¯¹è±¡: å°½ç®¡å…±äº«å˜é‡æ—¢å¿«é€Ÿåˆç®€å•ï¼Œä½†æ˜¯å®ƒä»¬æ¯”ç›´æ¥æ¶ˆæ¯ä¼ é€’æ›´è„†å¼±ã€‚ä½†æ˜¯å¿…é¡»ä½¿ç”¨é”æˆ–å…¶ä»–åŒæ­¥æœºåˆ¶ä¿æŠ¤å…±äº«å˜é‡ï¼Œå¦åˆ™å¯èƒ½ä¼šå¯¼è‡´æ•°æ®æŸåæˆ–å´©æºƒã€‚ æ¡ä»¶æ‰§è¡Œ: æ¡ä»¶æ˜¯ä¸€ç§åŒæ­¥å·¥å…·ï¼Œå¯ç”¨äºæ§åˆ¶çº¿ç¨‹ä½•æ—¶æ‰§è¡Œä»£ç çš„ç‰¹å®šéƒ¨åˆ†ã€‚ Runloop èµ„æº: ä¸€ä¸ªè‡ªå®šä¹‰çš„ Runloop source é…ç½®å¯ä»¥è®©ä¸€ä¸ªçº¿ç¨‹ä¸Šæ”¶åˆ°ç‰¹å®šçš„åº”ç”¨ç¨‹åºæ¶ˆæ¯ã€‚ç”±äº Runloop source æ˜¯äº‹ä»¶é©±åŠ¨çš„ï¼Œå› æ­¤åœ¨æ— äº‹å¯åšæ—¶ï¼Œçº¿ç¨‹ä¼šè‡ªåŠ¨è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œä»è€Œæé«˜äº†çº¿ç¨‹çš„æ•ˆç‡ ç«¯å£å’Œå¥—æ¥å­—:åŸºäºç«¯å£çš„é€šä¿¡æ˜¯åœ¨ä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´è¿›è¡Œé€šä¿¡çš„ä¸€ç§æ›´ä¸ºå¤æ‚çš„æ–¹æ³•ï¼Œä½†å®ƒä¹Ÿæ˜¯ä¸€ç§éå¸¸å¯é çš„æŠ€æœ¯ã€‚ æ¶ˆæ¯é˜Ÿåˆ—: ä¼ ç»Ÿçš„å¤šå¤„ç†æœåŠ¡å®šä¹‰äº†å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰é˜Ÿåˆ—æŠ½è±¡ï¼Œç”¨äºç®¡ç†ä¼ å…¥å’Œä¼ å‡ºæ•°æ®ã€‚å°½ç®¡æ¶ˆæ¯é˜Ÿåˆ—æ—¢ç®€å•åˆæ–¹ä¾¿ï¼Œä½†æ˜¯å®ƒä»¬ä¸å¦‚å…¶ä»–ä¸€äº›é€šä¿¡æŠ€æœ¯é«˜æ•ˆ å¯¹è±¡åˆ†å‘: å¯¹è±¡åˆ†å‘æ˜¯ä¸€ç§Cocoa æŠ€æœ¯ï¼Œæä¾›äº†åŸºäºç«¯å£é«˜çº§å®ç°ã€‚å°½ç®¡åœ¨çº¿ç¨‹å†…ä½¿ç”¨è¿™é—¨æŠ€æœ¯ä¹Ÿèƒ½ç”¨ï¼Œä½†é‰´äºä½¿ç”¨å®ƒä¼šå¸¦æ¥çš„æ€§èƒ½å¼€æ”¯ï¼Œé«˜åº¦ä¸å»ºè®®ä½¿ç”¨ã€‚åˆ†å‘å¯¹è±¡æ›´é€‚åˆäºè¿›ç¨‹é—´çš„é€šä¿¡ï¼Œå°¤å…¶æ˜¯å½“è¿›ç¨‹æ¶ˆè€—å·²ç»å¾ˆé«˜çš„æƒ…å†µä¸‹ 2.7 çº¿ç¨‹çš„å…³é—­å»ºè®®åœ¨åˆ›å»ºçº¿ç¨‹çš„æ—¶å€™ï¼Œå°±è®¾è®¡å¥½å“åº”å–æ¶ˆå’Œé€€å‡ºçº¿ç¨‹çš„æ¶ˆæ¯ã€‚å¦‚æœç¡®å®æœ‰æ¶ˆæ¯è¿›æ¥â€”â€”è¦æ±‚çº¿ç¨‹é€€å‡ºï¼Œçº¿ç¨‹å¯èƒ½æ¥ä¸‹æ¥å¯ä»¥å®ç°ä¸€äº›å¿…é¡»çš„æ¸…ç†å·¥ä½œï¼Œç„¶åä¼˜é›…çš„é€€å‡ºã€‚ å“åº”å–æ¶ˆæ¶ˆæ¯çš„æ–¹æ³•æ˜¯ä½¿ç”¨Runloopï¼Œçœ‹çœ‹ä¸‹é¢çš„ä»£ç ï¼š 12345678910111213141516171819202122232425- (void)threadMainRoutine{ BOOL moreWorkToDo = YES; BOOL exitNow = NO; NSRunLoop* runLoop = [NSRunLoop currentRunLoop]; // Add the exitNow BOOL to the thread dictionary. NSMutableDictionary* threadDict = [[NSThread currentThread] threadDictionary]; [threadDict setValue:[NSNumber numberWithBool:exitNow] forKey:@&quot;ThreadShouldExitNow&quot;]; // Install an input source. [self myInstallCustomInputSource]; while (moreWorkToDo &amp;&amp; !exitNow) { // Do one chunk of a larger body of work here. // Change the value of the moreWorkToDo Boolean when done. // Run the run loop but timeout immediately if the input source isn't waiting to fire. [runLoop runUntilDate:[NSDate date]]; // Check to see if an input source handler changed the exitNow value. exitNow = [[threadDict valueForKey:@&quot;ThreadShouldExitNow&quot;] boolValue]; }} ä¸‰ã€å¤šçº¿ç¨‹æ–¹æ¡ˆè„‘å›¾ è¡¥å……atomic ä¸ nonatomic çš„åŒºåˆ«nonatomicï¼šéåŸå­æ€§ï¼Œéçº¿ç¨‹å®‰å…¨ï¼Œé€‚åˆå†…å­˜å°çš„ç§»åŠ¨è®¾å¤‡ atomicï¼šåŸå­å±æ€§ï¼Œé’ˆå¯¹å¤šçº¿ç¨‹è®¾è®¡çš„ï¼Œæ˜¯å±æ€§çš„é»˜è®¤å€¼ï¼Œä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿå†™å…¥ï¼ˆä½†æ˜¯åŒä¸€æ—¶é—´èƒ½æœ‰å¤šä¸ªçº¿ç¨‹å–å€¼ï¼‰ï¼Œatomicæœ¬èº«å°±æœ‰ä¸€æŠŠé”ï¼ˆè‡ªæ—‹é”ï¼‰ï¼Œæ‰€ä»¥æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯éœ€è¦æ¶ˆè€—å¤§é‡èµ„æº å¼€å‘å»ºè®®ï¼š æ‰€æœ‰å±æ€§éƒ½å£°æ˜ä¸º nonatomic å°½é‡é¿å…å¤šçº¿ç¨‹æŠ¢å¤ºåŒä¸€å¿«èµ„æº å°½é‡å°†åŠ é”ã€èµ„æºæŠ¢å¤ºçš„ä¸šåŠ¡é€»è¾‘äº¤ç»™æœåŠ¡å™¨æ¥å¤„ç†ï¼Œå‡å°ç§»åŠ¨å®¢æˆ·ç«¯çš„å‹åŠ› å‚è€ƒiOSåº•å±‚å­¦ä¹  - å¤šçº¿ç¨‹ä¹‹åŸºç¡€åŸç†ç¯‡ iOSæ¢ç´¢ å¤šçº¿ç¨‹åŸç† å¤šçº¿ç¨‹","link":"/2021/04/06/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/15-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8B%E5%9F%BA%E7%A1%80%E5%8E%9F%E7%90%86/"},{"title":"16-å¤šçº¿ç¨‹ä¹‹GCDåˆæ¢","text":"ä¸€ã€GCDç®€ä»‹1.1 å®šä¹‰GCDå…¨ç¨‹ä¸ºGrand Central Dispatchï¼Œç”±Cè¯­è¨€å®ç°ï¼Œæ˜¯è‹¹æœä¸ºå¤šæ ¸çš„å¹¶è¡Œè¿ç®—æå‡ºçš„è§£å†³æ–¹æ¡ˆï¼ŒCGDä¼šè‡ªåŠ¨åˆ©ç”¨æ›´å¤šçš„CPUå†…æ ¸ï¼Œè‡ªåŠ¨ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼Œç¨‹åºå‘˜åªéœ€è¦å‘Šè¯‰GCDéœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæ— éœ€ç¼–å†™ä»»ä½•ç®¡ç†çº¿ç¨‹çš„ä»£ç ã€‚GCDä¹Ÿæ˜¯iOSä½¿ç”¨é¢‘ç‡æœ€é«˜çš„å¤šçº¿ç¨‹æŠ€æœ¯ã€‚ ä¼˜åŠ¿ï¼š GCD æ˜¯è‹¹æœå…¬å¸ä¸ºå¤šæ ¸çš„å¹¶è¡Œè¿ç®—æå‡ºçš„è§£å†³æ–¹æ¡ˆ GCD ä¼šè‡ªåŠ¨åˆ©ç”¨æ›´å¤šçš„CPUå†…æ ¸ï¼ˆæ¯”å¦‚åŒæ ¸ã€å››æ ¸ï¼‰ GCD ä¼šè‡ªåŠ¨ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼ˆåˆ›å»ºçº¿ç¨‹ã€è°ƒåº¦ä»»åŠ¡ã€é”€æ¯çº¿ç¨‹ï¼‰ ç¨‹åºå‘˜åªéœ€è¦å‘Šè¯‰ GCD æƒ³è¦æ‰§è¡Œä»€ä¹ˆä»»åŠ¡ï¼Œä¸éœ€è¦ç¼–å†™ä»»ä½•çº¿ç¨‹ç®¡ç†ä»£ç  1.2 åŒæ­¥å‡½æ•°å’Œå¼‚æ­¥å‡½æ•°åŒæ­¥å‡½æ•°ï¼š 12//queueï¼šé˜Ÿåˆ— blockï¼šä»»åŠ¡dispatch_sync(dispatch_queue_t queue, dispatch_block_t block); å¼‚æ­¥å‡½æ•°ï¼š 12//queueï¼šé˜Ÿåˆ— blockï¼šä»»åŠ¡dispatch_async(dispatch_queue_t queue, dispatch_block_t block); 1.3 ä»»åŠ¡é€šè¿‡æŸ¥çœ‹å…¶å®šä¹‰å¯å¾—ï¼Œè¯¥å‚æ•°å…¶å®å°±æ˜¯ä¸€ä¸ªæ²¡æœ‰å‚æ•°çš„blockå›è°ƒï¼Œç”¨æ¥æ‰§è¡Œä»»åŠ¡çš„ã€‚ 1typedef void (^dispatch_block_t)(void); 1.4 é˜Ÿåˆ—ä¸»é˜Ÿåˆ—ç”±ç³»ç»Ÿåˆ›å»ºçš„ä¸²è¡Œé˜Ÿåˆ—ã€‚ è·å–æ–¹å¼ï¼šdispatch_get_main_queue() è‡ªå®šä¹‰çš„ä¸²è¡Œé˜Ÿåˆ—è·å–æ–¹å¼ï¼šdispatch_queue_create(@&quot;é˜Ÿåˆ—å&quot;,DISPATCH_QUEUE_SERIAL) å…¨å±€é˜Ÿåˆ—å¹¶å‘ç”±ç³»ç»Ÿåˆ›å»ºçš„å¹¶å‘é˜Ÿåˆ— è·å–æ–¹å¼ï¼šdispatch_get_global_queue(long identifier, unsigned long flags); è‡ªå®šä¹‰çš„å¹¶å‘é˜Ÿåˆ—è·å–æ–¹å¼ï¼šdispatch_queue_create(@&quot;é˜Ÿåˆ—å&quot;,DISPATCH_QUEUE_CONCURRENT); å…¶ä¸­ï¼Œå…¨å±€é˜Ÿåˆ—æ ¹æ®å…¥å‚çš„ä¸åŒï¼Œä¼šè·å–åˆ°ä¸åŒçš„é˜Ÿåˆ—ï¼Œåœ¨æ—¥å¸¸çš„å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬å…¥å‚0,æ¥è·å–åˆ°ä¸»å¹¶å‘é˜Ÿåˆ—ã€‚ è‡ªå®šä¹‰çš„é˜Ÿåˆ—éƒ½æ˜¯è°ƒç”¨dispatch_queue_create(const char *_Nullable label,dispatch_queue_attr_t _Nullable attr)æ–¹æ³•æ¥è¿›è¡Œåˆ›å»ºï¼Œä¸¤ä¸ªå‚æ•°åˆ†åˆ«ä¸ºè‡ªå®šä¹‰é˜Ÿåˆ—åç§°å’Œé˜Ÿåˆ—ç±»å‹ã€‚ å…¶ä¸­ä¸²è¡Œé˜Ÿåˆ—DISPATCH_QUEUE_SERIALä¸ºå®å®šä¹‰çš„NULLï¼Œæ‰€ä»¥ä¼ NULLä¹Ÿè¡¨ç¤ºä¸ºä¸²è¡Œé˜Ÿåˆ—ã€‚ äºŒã€GCDçš„ä½¿ç”¨2.1 å¸¸è§„ä½¿ç”¨åŒæ­¥ + ä¸²å‹é˜Ÿåˆ—ã€æ­»é”ã€‘1234567891011- (void)viewDidLoad { [super viewDidLoad]; NSLog(@&quot;ä»»åŠ¡1:%@&quot;,[NSThread currentThread]); dispatch_queue_t queue = dispatch_get_main_queue(); dispatch_sync(queue, ^{ NSLog(@&quot;ä»»åŠ¡2&quot;,[NSThread currentThread]); }); NSLog(@&quot;ä»»åŠ¡3:%@&quot;,[NSThread currentThread]);} è¿è¡Œç»“æœï¼š 1æ‰“å°å‡ºä»»åŠ¡1åï¼Œç¨‹åºæ­»é”å´©æºƒ åŸå› ï¼š ä¸²å‹é˜Ÿåˆ—çš„ç‰¹ç‚¹æ˜¯FIFOï¼Œä¸»é˜Ÿåˆ—ä¸­å·²ç»å­˜åœ¨ä»»åŠ¡viewDidLoadï¼Œå¾€ä¸»é˜Ÿåˆ—åŠ å…¥ä»»åŠ¡2ï¼Œå°±éœ€è¦æ‰§è¡Œå®ŒviewDidLoadæ‰èƒ½æ‰§è¡Œä»»åŠ¡2ã€‚ä½†æ˜¯æƒ³è¦æ‰§è¡Œå®ŒviewDidLoadåˆå¿…é¡»å…ˆæ‰§è¡ŒviewDidLoadå†…çš„ä»»åŠ¡2å’Œä»»åŠ¡3ã€‚è¿™å°±é€ æˆäº†æ­»é”ã€‚ å¼‚æ­¥ +ï¼ˆä¸»é˜Ÿåˆ— / è‡ªå®šä¹‰ä¸²è¡Œé˜Ÿåˆ—ï¼‰å¼‚æ­¥å‡½æ•° + ä¸»é˜Ÿåˆ—ï¼š 1234567891011121314151617- (void)viewDidLoad { [super viewDidLoad]; NSLog(@&quot;ä»»åŠ¡1:%@&quot;,[NSThread currentThread]); dispatch_queue_t queue = dispatch_get_main_queue(); dispatch_async(queue, ^{ sleep(3); NSLog(@&quot;ä»»åŠ¡2:%@&quot;,[NSThread currentThread]); }); dispatch_async(queue, ^{ NSLog(@&quot;ä»»åŠ¡3:%@&quot;,[NSThread currentThread]); }); NSLog(@&quot;ä»»åŠ¡4:%@&quot;,[NSThread currentThread]);} è¿è¡Œç»“æœï¼š 1234ä»»åŠ¡1:&lt;NSThread: 0x600003a10500&gt;{number = 1, name = main}ä»»åŠ¡4:&lt;NSThread: 0x600003a10500&gt;{number = 1, name = main}ä»»åŠ¡2:&lt;NSThread: 0x600003a10500&gt;{number = 1, name = main}ä»»åŠ¡3:&lt;NSThread: 0x600003a10500&gt;{number = 1, name = main} å¯ä»¥çœ‹åˆ°ï¼š æ²¡æœ‰é€ æˆå µå¡ï¼Œæ²¡æœ‰å¼€å¯æ–°çš„çº¿ç¨‹ï¼Œä¸²å‹çš„æ‰§è¡Œä»»åŠ¡ å¼‚æ­¥å‡½æ•° + è‡ªå®šä¹‰ä¸²å‹é˜Ÿåˆ—ï¼š 1234567891011121314151617- (void)viewDidLoad { [super viewDidLoad]; NSLog(@&quot;ä»»åŠ¡1:%@&quot;,[NSThread currentThread]); dispatch_queue_t queue = dispatch_queue_create(&quot;aa&quot;, DISPATCH_QUEUE_SERIAL); dispatch_async(queue, ^{ sleep(3); NSLog(@&quot;ä»»åŠ¡2:%@&quot;,[NSThread currentThread]); }); dispatch_async(queue, ^{ NSLog(@&quot;ä»»åŠ¡3:%@&quot;,[NSThread currentThread]); }); NSLog(@&quot;ä»»åŠ¡4:%@&quot;,[NSThread currentThread]);} è¿è¡Œç»“æœï¼š 1234ä»»åŠ¡1:&lt;NSThread: 0x600000a7c500&gt;{number = 1, name = main}ä»»åŠ¡4:&lt;NSThread: 0x600000a7c500&gt;{number = 1, name = main}ä»»åŠ¡2:&lt;NSThread: 0x600000a0b700&gt;{number = 5, name = (null)}ä»»åŠ¡3:&lt;NSThread: 0x600000a0b700&gt;{number = 5, name = (null)} å¯ä»¥çœ‹åˆ°ï¼š æ²¡æœ‰é€ æˆå µå¡ï¼Œå¼€å¯æ–°çº¿ç¨‹ï¼Œä¸²å‹æ‰§è¡Œä»»åŠ¡ã€‚ åŒæ­¥ +ï¼ˆå…¨å±€é˜Ÿåˆ— / è‡ªå®šä¹‰å¹¶å‘é˜Ÿåˆ—ï¼‰12345678910111213141516- (void)viewDidLoad { [super viewDidLoad]; dispatch_queue_t queue = dispatch_get_global_queue(0, 0); dispatch_sync(queue, ^{ for (int i = 0; i&lt;3; i++) { NSLog(@&quot;ä»»åŠ¡ä¸€ï¼š%@&quot;,[NSThread currentThread]); } }); dispatch_sync(queue, ^{ for (int i = 0; i&lt;3; i++) { NSLog(@&quot;ä»»åŠ¡äºŒï¼š%@&quot;,[NSThread currentThread]); } });} è¿è¡Œç»“æœï¼š æˆ‘ä»¬åœ¨å…¨å±€é˜Ÿåˆ—ä¸­åŒæ­¥æ‰§è¡Œä»»åŠ¡1å’Œä»»åŠ¡2ï¼Œé€šè¿‡æ‰“å°å¯ä»¥çœ‹å‡ºï¼ŒåŒæ­¥æ‰§è¡Œæ˜¯æŒ‰é¡ºåºæ‰§è¡Œä»»åŠ¡ï¼Œæ‰§è¡Œå®Œä»»åŠ¡1å†æ‰§è¡Œä»»åŠ¡2ã€‚å¹¶ä¸”æ‰“å°å½“å‰çº¿ç¨‹ï¼ŒåŒæ­¥æ‰§è¡Œæ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œæ²¡æœ‰å¼€å¯æ–°çº¿ç¨‹ã€‚ä¸”ç”±äºé˜Ÿåˆ—æ˜¯å¹¶å‘çš„ï¼Œå¹¶ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚ å¼‚æ­¥ +ï¼ˆå…¨å±€é˜Ÿåˆ— / è‡ªå®šä¹‰å¹¶å‘é˜Ÿåˆ—ï¼‰12345678910111213141516- (void)viewDidLoad { [super viewDidLoad]; dispatch_queue_t queue = dispatch_get_global_queue(0, 0); dispatch_async(queue, ^{ for (int i = 0; i&lt;3; i++) { NSLog(@&quot;ä»»åŠ¡ä¸€ï¼š%@&quot;,[NSThread currentThread]); } }); dispatch_async(queue, ^{ for (int i = 0; i&lt;3; i++) { NSLog(@&quot;ä»»åŠ¡äºŒï¼š%@&quot;,[NSThread currentThread]); } });} è¿è¡Œç»“æœï¼š å¯ä»¥çœ‹å‡ºä»»åŠ¡1å’Œä»»åŠ¡2äº¤é”™æ‰§è¡Œï¼Œå¹¶éåŒæ­¥æ‰§è¡Œé‚£æ ·æ‰§è¡Œå®Œä»»åŠ¡1å†æ‰§è¡Œä»»åŠ¡2ã€‚è€Œä¸”é€šè¿‡çº¿ç¨‹ç¼–å·å¯ä»¥çœ‹å‡ºï¼Œçš„ç¡®å¼€å¯äº†æ–°çš„çº¿ç¨‹ã€‚è¯´æ˜å¼‚æ­¥æ‰§è¡Œå…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ã€‚ 2.2 éå¸¸è§„ä½¿ç”¨ï¼Œå‘ç‚¹åŒä¸€ä¸²è¡Œé˜Ÿåˆ—åµŒå¥—12345678910111213141516171819- (void)viewDidLoad { [super viewDidLoad]; NSLog(@&quot;ä»»åŠ¡1&quot;); // è‡ªå®šä¹‰ä¸²å‹é˜Ÿåˆ— dispatch_queue_t queue = dispatch_queue_create(&quot;myQueue&quot;, DISPATCH_QUEUE_SERIAL); dispatch_async(queue, ^{ NSLog(@&quot;ä»»åŠ¡2&quot;); dispatch_sync(queue, ^{ NSLog(@&quot;ä»»åŠ¡3&quot;); }); NSLog(@&quot;ä»»åŠ¡4&quot;); }); NSLog(@&quot;ä»»åŠ¡5&quot;);} è¿è¡Œç»“æœ 1ä»»åŠ¡1ï¼Œä»»åŠ¡5ï¼Œä»»åŠ¡2ï¼Œç„¶åç¨‹åºå´©æºƒ è¿™é‡Œé€ æˆæ­»é”å´©æºƒçš„åŸå› å’Œä¸Šé¢åŒæ­¥+ä¸²è¡Œé˜Ÿåˆ—çš„åŸå› ä¸€æ ·ã€‚ ä¸åŒä¸²è¡Œé˜Ÿåˆ—åµŒå¥—1234567891011121314151617181920- (void)viewDidLoad { [super viewDidLoad]; NSLog(@&quot;ä»»åŠ¡1&quot;); dispatch_queue_t queue = dispatch_queue_create(&quot;myQueue&quot;, DISPATCH_QUEUE_SERIAL); dispatch_queue_t queue2 = dispatch_queue_create(&quot;myQueue2&quot;, DISPATCH_QUEUE_SERIAL); dispatch_async(queue, ^{ NSLog(@&quot;ä»»åŠ¡2&quot;); dispatch_sync(queue2, ^{ NSLog(@&quot;ä»»åŠ¡3&quot;); }); NSLog(@&quot;ä»»åŠ¡4&quot;); }); NSLog(@&quot;ä»»åŠ¡5&quot;);} è¿è¡Œç»“æœ 1ä»»åŠ¡1ï¼Œä»»åŠ¡5ï¼Œä»»åŠ¡2ï¼Œä»»åŠ¡3ï¼Œä»»åŠ¡4 é€šè¿‡è¿è¡Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå½“åµŒå¥—æ‰§è¡Œæ—¶ï¼ŒåŒæ­¥å¼‚æ­¥åœ¨ä¸åŒçš„ä¸²è¡Œé˜Ÿåˆ—æ‰§è¡Œï¼Œå¹¶ä¸ä¼šé€ æˆæ­»é”å´©æºƒã€‚è€Œæ˜¯æŒ‰ç…§ä¸²è¡Œçš„é¡ºåºï¼Œæ‰§è¡Œä»£ç ã€‚è¿™äº‹å› ä¸ºdispatch_syncé˜»å¡çš„å¹¶ä¸æ˜¯å½“å‰çš„çº¿ç¨‹ï¼Œè€Œæ˜¯å…¶ä»–çš„çº¿ç¨‹ï¼Œæ‰€ä»¥ä¸ä¼šé€ æˆæ­»é”ç­‰å¾…ã€‚ åŒä¸€å¹¶å‘é˜Ÿåˆ—åµŒå¥—1234567891011121314151617181920- (void)viewDidLoad { [super viewDidLoad]; NSLog(@&quot;ä»»åŠ¡1&quot;); // è‡ªå®šä¹‰å¹¶å‘é˜Ÿåˆ— dispatch_queue_t queue = dispatch_queue_create(&quot;myQueue&quot;, DISPATCH_QUEUE_CONCURRENT); dispatch_async(queue, ^{ NSLog(@&quot;ä»»åŠ¡2&quot;); dispatch_sync(queue, ^{ NSLog(@&quot;ä»»åŠ¡3&quot;); }); NSLog(@&quot;ä»»åŠ¡4&quot;); }); NSLog(@&quot;ä»»åŠ¡5&quot;);} è¿è¡Œç»“æœï¼š 1ä»»åŠ¡1ï¼Œä»»åŠ¡5ï¼Œä»»åŠ¡2ï¼Œä»»åŠ¡3ï¼Œä»»åŠ¡4 ä¸åŒå¹¶å‘é˜Ÿåˆ—åµŒå¥—1234567891011121314151617181920- (void)viewDidLoad { [super viewDidLoad]; NSLog(@&quot;ä»»åŠ¡1&quot;); dispatch_queue_t queue = dispatch_queue_create(&quot;myQueue&quot;, DISPATCH_QUEUE_SERIAL); dispatch_queue_t queue2 = dispatch_queue_create(&quot;myQueue2&quot;, DISPATCH_QUEUE_CONCURRENT); dispatch_async(queue, ^{ NSLog(@&quot;ä»»åŠ¡2&quot;); dispatch_sync(queue2, ^{ NSLog(@&quot;ä»»åŠ¡3&quot;); }); NSLog(@&quot;ä»»åŠ¡4&quot;); }); NSLog(@&quot;ä»»åŠ¡5&quot;);} è¿è¡Œç»“æœï¼š ä»»åŠ¡1ï¼Œä»»åŠ¡5ï¼Œä»»åŠ¡2ï¼Œä»»åŠ¡3ï¼Œä»»åŠ¡4 è¿™ä¸ªä»£ç çš„åˆ†æå’Œä¸åŒä¸²è¡Œé˜Ÿåˆ—åµŒå¥—çš„ç±»ä¼¼ï¼Œåˆ›å»ºäº†æ–°çš„é˜Ÿåˆ—ï¼Œæ‰€ä»¥æ˜¯ä¸ä¼šé€ æˆå½“å‰é˜Ÿåˆ—çš„é˜»å¡çš„ã€‚ ä¸‰ã€æ€»ç»“ åŒæ­¥å‡½æ•°æ²¡æœ‰å¼€è¾Ÿçº¿ç¨‹èƒ½åŠ›ï¼Œä¸”ä»£ç é¡ºåºæ‰§è¡Œï¼Œä¼šäº§ç”Ÿå µå¡ åŒæ­¥æ‰§è¡Œåœ¨åŒä¸€ä¸²è¡Œé˜Ÿåˆ—æ—¶ï¼Œä¼šé€ æˆæ­»é”ç­‰å¾… å¼‚æ­¥å‡½æ•°å…·æœ‰å¼€è¾Ÿæ–°çº¿ç¨‹çš„èƒ½åŠ›ï¼Œåœ¨å¹¶å‘é˜Ÿåˆ—æ‰§è¡Œæ—¶ï¼Œæ‰§è¡Œé¡ºåºä¸ç¡®å®šï¼Œåœ¨ä¸²è¡Œé˜Ÿåˆ—æ‰§è¡Œæ—¶ï¼ŒæŒ‰ç…§é¡ºåºæ‰§è¡Œï¼Œä¸”ä¸»é˜Ÿåˆ—æ—¶ä¸ä¼šå¼€è¾Ÿæ–°çº¿ç¨‹ å‚è€ƒè‹¹æœå¤šçº¿ç¨‹å¼€æºä»£ç  iOSåº•å±‚åŸç†æ¢ç´¢â€”å¤šçº¿ç¨‹çš„æœ¬è´¨","link":"/2021/05/13/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/16-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BGCD%E5%88%9D%E6%8E%A2/"},{"title":"17-å¤šçº¿ç¨‹ä¹‹GCDé˜Ÿåˆ—åŸç†","text":"å¦‚ä½•å®šä½æºç å·²çŸ¥è¦ç ”ç©¶GCDï¼Œæ‰€ä»¥æœ‰ä»¥ä¸‹å‡ ç§é€‰æ‹©æºç çš„æ–¹æ³•ï¼š Baidu/Google ä¸‹ç¬¦å·æ–­ç‚¹dispatch_queue_create é¦–å…ˆå†™ä¸‹æµ‹è¯•ä»£ç ï¼š 1dispatch_queue_t aaqueue = dispatch_queue_create(&quot;aa&quot;, NULL); ç„¶åæ·»åŠ ç¬¦å·æ–­ç‚¹ï¼š ä»…ä½¿ç”¨Debug-&gt;Debug Workflow-&gt;Always show Disassemblyï¼Œæ–­ç‚¹åˆ°ä¸Šé¢çš„æµ‹è¯•ä»£ç ï¼ŒæŸ¥çœ‹æ±‡ç¼–ä¹Ÿèƒ½çœ‹åˆ°å®šä½åœ¨libdispatch.dylib è‹¹æœå®˜ç½‘çš„ï¼šlibdispatchæºç  ä¸€ã€å¼€å§‹ç ”ç©¶ GCDé¦–å…ˆåˆ›å»ºä¸¤ä¸ªå¸¸è§çš„é˜Ÿåˆ—ï¼Œä¸²è¡Œé˜Ÿåˆ—å’Œå¹¶å‘é˜Ÿåˆ—ï¼Œç„¶ååˆ†åˆ« po ä¸€ä¸‹ï¼Œå†é¡ºä¾¿æŠŠä¸»é˜Ÿåˆ—å’Œå…¨å±€é˜Ÿåˆ—åˆ†åˆ«ä¸€èµ·ç»™çœ‹äº†ã€‚ å‘ç°ä¸»é˜Ÿåˆ—çš„ width å’Œä¸²è¡Œé˜Ÿåˆ—çš„ width æ˜¯ä¸€æ ·çš„ï¼Œå…¶ä»–çš„ä¹Ÿæœ‰å¾ˆå¤šç›¸åŒçš„ï¼Œéš¾æ€ªè¯´ä¸»é˜Ÿåˆ—æ˜¯ç‰¹æ®Šçš„ä¸²è¡Œé˜Ÿåˆ—ã€‚ ä½†æ˜¯å¹¶å‘é˜Ÿåˆ—å’Œå…¨å±€é˜Ÿåˆ—çš„ width å´ç›¸å·® 1ï¼Œæœ‰ç‚¹å¥‡æ€ªã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°±åˆ°æºç ä¸­ä¸€æ¢ç©¶ç«Ÿå§ã€‚ äºŒã€åˆ›å»ºé˜Ÿåˆ—åœ¨åº•å±‚æ˜¯æ€æ ·å®ç°çš„å…ˆä¸Šç»“è®ºï¼š è‡ªå®šä¹‰å¹¶å‘é˜Ÿåˆ—å’Œä¸²è¡Œé˜Ÿåˆ—ï¼Œæ˜¯ä»æ ¹é˜Ÿåˆ—æ•°ç»„ä¸­å–å‡ºæ¨¡æ¿å±æ€§ï¼Œç„¶åç»è¿‡äº†ä¸€ç³»åˆ—çš„å¼€è¾Ÿç©ºé—´ã€æ„é€ ã€èµ‹å€¼ç­‰æ“ä½œåˆ›å»ºå‡ºæ¥çš„ã€‚ æ ¹é˜Ÿåˆ—æ•°ç»„æ˜¯åœ¨libdispatch_initä¹‹åè°ƒç”¨_dispatch_introspection_initï¼Œé€šè¿‡ for å¾ªç¯ï¼Œè°ƒç”¨_dispatch_trace_queue_createï¼Œå†å–å‡º_dispatch_root_queuesé‡Œçš„åœ°å€æŒ‡é’ˆä¸€ä¸ªä¸ªåˆ›å»ºå‡ºæ¥çš„ã€‚ 2.1 è‡ªå®šä¹‰é˜Ÿåˆ—çš„åˆ›å»ºæ ¹æ®æˆ‘ä»¬çš„è°ƒç”¨ï¼šdispatch_queue_create(&quot;aa&quot;, NULL);ï¼Œå…¨å±€æœç´¢dispatch_queue_createã€‚ä½†æ˜¯ä¼šå‡ºç°æœç´¢ç»“æœå·¨å¤šçš„æƒ…å†µï¼ˆ66 results in 17 filesï¼‰ï¼Œæ­¤æ—¶æˆ‘ä»¬åº”è¯¥ä¿®æ”¹æœç´¢æ¡ä»¶ï¼š ç”±äºåˆ›å»ºé˜Ÿåˆ—ä»£ç ä¸ºdispatch_queue_create(&quot;&quot;, NULL)ï¼Œæ‰€ä»¥æœç´¢dispatch_queue_create(â€”â€”å°†ç­›é€‰ç»“æœé™è‡³ï¼ˆ21 results in 6 filesï¼‰ ç”±äºç¬¬ä¸€ä¸ªå‚æ•°ä¸ºå­—ç¬¦ä¸²ï¼Œåœ¨cè¯­è¨€ä¸­ç”¨constä¿®é¥°ï¼Œæ‰€ä»¥æœç´¢dispatch_queue_create(constâ€”â€”å°†ç­›é€‰ç»“æœé™è‡³ï¼ˆ2 results in 2 filesï¼‰ï¼Œç”±æ­¤æ‰¾åˆ°äº†æˆ‘ä»¬éœ€è¦çœ‹çš„åº•å±‚ä»£ç  2.1.1 dispatch_queue_create123456dispatch_queue_tdispatch_queue_create(const char *label, dispatch_queue_attr_t attr){ return _dispatch_lane_create_with_target(label, attr, DISPATCH_TARGET_QUEUE_DEFAULT, true);} å‘ç°å»è°ƒç”¨äº† _dispatch_lane_create_with_targetæ–¹æ³•ï¼Œå¸¸è§„çš„æ¥å£éš”ç¦»æ“ä½œã€‚ 2.1.2 _dispatch_lane_create_with_target123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135DISPATCH_NOINLINEstatic dispatch_queue_t_dispatch_lane_create_with_target(const char *label, dispatch_queue_attr_t dqa, dispatch_queue_t tq, bool legacy){ // âœ…2.3 dispatch_queue_attr_info_t dqai = _dispatch_queue_attr_to_info(dqa); // // Step 1: Normalize arguments (qos, overcommit, tq) // dispatch_qos_t qos = dqai.dqai_qos;#if !HAVE_PTHREAD_WORKQUEUE_QOS if (qos == DISPATCH_QOS_USER_INTERACTIVE) { dqai.dqai_qos = qos = DISPATCH_QOS_USER_INITIATED; } if (qos == DISPATCH_QOS_MAINTENANCE) { dqai.dqai_qos = qos = DISPATCH_QOS_BACKGROUND; }#endif // !HAVE_PTHREAD_WORKQUEUE_QOS _dispatch_queue_attr_overcommit_t overcommit = dqai.dqai_overcommit; if (overcommit != _dispatch_queue_attr_overcommit_unspecified &amp;&amp; tq) { if (tq-&gt;do_targetq) { DISPATCH_CLIENT_CRASH(tq, &quot;Cannot specify both overcommit and &quot; &quot;a non-global target queue&quot;); } } if (tq &amp;&amp; dx_type(tq) == DISPATCH_QUEUE_GLOBAL_ROOT_TYPE) { // Handle discrepancies between attr and target queue, attributes win if (overcommit == _dispatch_queue_attr_overcommit_unspecified) { if (tq-&gt;dq_priority &amp; DISPATCH_PRIORITY_FLAG_OVERCOMMIT) { // å¹¶å‘é˜Ÿåˆ— overcommit = _dispatch_queue_attr_overcommit_enabled; } else { // ä¸²è¡Œé˜Ÿåˆ— overcommit = _dispatch_queue_attr_overcommit_disabled; } } if (qos == DISPATCH_QOS_UNSPECIFIED) { qos = _dispatch_priority_qos(tq-&gt;dq_priority); } tq = NULL; } else if (tq &amp;&amp; !tq-&gt;do_targetq) { // target is a pthread or runloop root queue, setting QoS or overcommit // is disallowed if (overcommit != _dispatch_queue_attr_overcommit_unspecified) { DISPATCH_CLIENT_CRASH(tq, &quot;Cannot specify an overcommit attribute &quot; &quot;and use this kind of target queue&quot;); } } else { if (overcommit == _dispatch_queue_attr_overcommit_unspecified) { // Serial queues default to overcommit! overcommit = dqai.dqai_concurrent ? _dispatch_queue_attr_overcommit_disabled : _dispatch_queue_attr_overcommit_enabled; // å¹¶å‘æ˜¯...disableï¼Œä¸²è¡Œæ˜¯...enable } } if (!tq) { // âœ…ä¸€å®šä¼šèµ°è¿™é‡Œ // 2.7 ä»æ ¹é˜Ÿåˆ—è·å– tq tq = _dispatch_get_root_queue( qos == DISPATCH_QOS_UNSPECIFIED ? DISPATCH_QOS_DEFAULT : qos, // 4 overcommit == _dispatch_queue_attr_overcommit_enabled)-&gt;_as_dq; // å¹¶å‘ä¸º0 ä¸²è¡Œä¸º1 if (unlikely(!tq)) { DISPATCH_CLIENT_CRASH(qos, &quot;Invalid queue attribute&quot;); } } // // Step 2: Initialize the queue // if (legacy) { // if any of these attributes is specified, use non legacy classes if (dqai.dqai_inactive || dqai.dqai_autorelease_frequency) { legacy = false; } } const void *vtable; dispatch_queue_flags_t dqf = legacy ? DQF_MUTABLE : 0; if (dqai.dqai_concurrent) { vtable = DISPATCH_VTABLE(queue_concurrent); } else { vtable = DISPATCH_VTABLE(queue_serial); } switch (dqai.dqai_autorelease_frequency) { case DISPATCH_AUTORELEASE_FREQUENCY_NEVER: dqf |= DQF_AUTORELEASE_NEVER; break; case DISPATCH_AUTORELEASE_FREQUENCY_WORK_ITEM: dqf |= DQF_AUTORELEASE_ALWAYS; break; } if (label) { const char *tmp = _dispatch_strdup_if_mutable(label); if (tmp != label) { dqf |= DQF_LABEL_NEEDS_FREE; label = tmp; } } // 2.4 å¼€è¾Ÿå†…å­˜ - ç”Ÿæˆç›¸åº”çš„å¯¹è±¡ queue dispatch_lane_t dq = _dispatch_object_alloc(vtable, sizeof(struct dispatch_lane_s)); // 2.5 æ„é€ æ–¹æ³• _dispatch_queue_init(dq, dqf, dqai.dqai_concurrent ? DISPATCH_QUEUE_WIDTH_MAX : 1, DISPATCH_QUEUE_ROLE_INNER | (dqai.dqai_inactive ? DISPATCH_QUEUE_INACTIVE : 0)); // æ ‡ç­¾ dq-&gt;dq_label = label; // ä¼˜å…ˆçº§ dq-&gt;dq_priority = _dispatch_priority_make((dispatch_qos_t)dqai.dqai_qos, dqai.dqai_relpri); if (overcommit == _dispatch_queue_attr_overcommit_enabled) { dq-&gt;dq_priority |= DISPATCH_PRIORITY_FLAG_OVERCOMMIT; } if (!dqai.dqai_inactive) { _dispatch_queue_priority_inherit_from_target(dq, tq); _dispatch_lane_inherit_wlh_from_target(dq, tq); } _dispatch_retain(tq); // âœ…2.6 dq-&gt;do_targetq = tq; _dispatch_object_debug(dq, &quot;%s&quot;, __func__); return _dispatch_trace_queue_create(dq)._dq;} è¿™ä¸ªæ–¹æ³•è¾ƒé•¿ï¼Œæˆ‘ä»¬æ‹†å¼€é‡ç‚¹ä»£ç è¿›è¡Œåˆ†æã€‚ 2.1.3 _dispatch_queue_attr_to_info1dispatch_queue_attr_info_t dqai = _dispatch_queue_attr_to_info(dqa); å…¶ä¸­ä¼ å…¥è¿™ä¸ªæ–¹æ³•çš„å‚æ•°dqaä¸ºdispatch_queue_attr_tç±»å‹çš„ï¼Œä¸²è¡Œé˜Ÿåˆ—ä¼ å…¥çš„æ˜¯NULLï¼Œå¹¶å‘ä¼ å…¥çš„æ˜¯DISPATCH_QUEUE_CONCURRENTã€‚ å°†dqaå‚æ•°ä¼ å…¥åï¼Œç”Ÿæˆäº†dispatch_queue_attr_info_tå¯¹è±¡dqaiã€‚ æˆ‘ä»¬å¯ä»¥å‘ç°dispatch_queue_attr_info_tæ˜¯ä¸€ä¸ªç»“æ„ä½“ä½åŸŸçš„å½¢å¼ï¼Œé‡Œé¢åŒ…å«äº†ä¸€äº›dispatch_qos_tç­‰ä¼˜å…ˆçº§çš„å€¼ã€‚ 12345678typedef struct dispatch_queue_attr_info_s { dispatch_qos_t dqai_qos : 8; int dqai_relpri : 8; uint16_t dqai_overcommit:2; uint16_t dqai_autorelease_frequency:2; uint16_t dqai_concurrent:1; uint16_t dqai_inactive:1;} dispatch_queue_attr_info_t; è¿›å…¥æ–¹æ³•æŸ¥çœ‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748dispatch_queue_attr_info_t_dispatch_queue_attr_to_info(dispatch_queue_attr_t dqa){ // åˆå§‹åŒ– dispatch_queue_attr_info_t dqai = { }; // ä¸²è¡Œé˜Ÿåˆ—ç›´æ¥è¿”å›ç©ºç»“æ„ä½“ã€‚åç»­ä»£ç éƒ½æ˜¯å¯¹å¹¶å‘é˜Ÿåˆ—è¿›è¡Œçš„æ“ä½œ if (!dqa) return dqai;#if DISPATCH_VARIANT_STATIC if (dqa == &amp;_dispatch_queue_attr_concurrent) { dqai.dqai_concurrent = true; return dqai; }#endif if (dqa &lt; _dispatch_queue_attrs || dqa &gt;= &amp;_dispatch_queue_attrs[DISPATCH_QUEUE_ATTR_COUNT]) { DISPATCH_CLIENT_CRASH(dqa-&gt;do_vtable, &quot;Invalid queue attribute&quot;); } // è‹¹æœçš„ç®—æ³• size_t idx = (size_t)(dqa - _dispatch_queue_attrs); // å¹¶å‘é˜Ÿåˆ—ç»“æ„ä½“ä½åŸŸçš„é»˜è®¤é…ç½®å’Œèµ‹å€¼ dqai.dqai_inactive = (idx % DISPATCH_QUEUE_ATTR_INACTIVE_COUNT); idx /= DISPATCH_QUEUE_ATTR_INACTIVE_COUNT; // å¹¶å‘æ•°ã€‚âœ…é‡ç‚¹å…³æ³¨ã€‚åªæœ‰å¹¶å‘é˜Ÿåˆ—æ‰æœ‰è¿™ä¸ªå€¼ dqai.dqai_concurrent = !(idx % DISPATCH_QUEUE_ATTR_CONCURRENCY_COUNT); idx /= DISPATCH_QUEUE_ATTR_CONCURRENCY_COUNT; dqai.dqai_relpri = -(int)(idx % DISPATCH_QUEUE_ATTR_PRIO_COUNT); idx /= DISPATCH_QUEUE_ATTR_PRIO_COUNT; // ä¼˜å…ˆçº§ dqai.dqai_qos = idx % DISPATCH_QUEUE_ATTR_QOS_COUNT; idx /= DISPATCH_QUEUE_ATTR_QOS_COUNT; dqai.dqai_autorelease_frequency = idx % DISPATCH_QUEUE_ATTR_AUTORELEASE_FREQUENCY_COUNT; idx /= DISPATCH_QUEUE_ATTR_AUTORELEASE_FREQUENCY_COUNT; dqai.dqai_overcommit = idx % DISPATCH_QUEUE_ATTR_OVERCOMMIT_COUNT; idx /= DISPATCH_QUEUE_ATTR_OVERCOMMIT_COUNT; return dqai;} å½“ä¸ºä¸²è¡Œé˜Ÿåˆ—çš„æ—¶å€™ï¼Œä¼ å…¥çš„å‚æ•°ä¸ºNULLï¼Œç›´æ¥è¿”å›ä¸€ä¸ªç©ºç»“æ„ä½“ã€‚æ‰€ä»¥ä»£ç åç»­å¯¹dqaiçš„æ“ä½œéƒ½æ˜¯åŸºäºå¹¶å‘é˜Ÿåˆ—çš„ï¼Œå¹¶é€šè¿‡æ­¤æ¥è¿›è¡Œåˆ¤æ–­å–å€¼ã€‚ é‚£ä¹ˆå¯¹äºå¹¶å‘é˜Ÿåˆ—ï¼Œä¼šæ ¹æ®ä¼ å…¥çš„å®å®šä¹‰å‚æ•°ï¼Œé€šè¿‡ä½è¿ç®—ï¼Œæ¥ç»™dqaiè¿›è¡Œèµ‹å€¼ï¼Œæ¯”è¾ƒä¸»è¦çš„æœ‰å¹¶å‘æ•°ï¼ˆdqai_concurrentï¼‰ï¼Œä¼˜å…ˆçº§ï¼ˆdqai_qosï¼‰ç­‰ã€‚ 2.1.4 _dispatch_object_allocè™½ç„¶åœ¨ä¸Šä¸€æ­¥è·å–åˆ°äº†dispatch_queue_attr_info_tç›¸å…³çš„å€¼ï¼Œä½†æ˜¯å®ƒå¹¶ä¸æ˜¯æœ€ç»ˆè¿”å›çš„çº¿ç¨‹ï¼Œåªæ˜¯æˆ‘ä»¬ç”¨æ¥è·å–ä¸€äº›é…ç½®çš„ä¸´æ—¶å˜é‡è€Œå·²ã€‚ çœ‹_dispatch_lane_create_with_targetæ–¹æ³•æœ€åä¸€è¡Œï¼Œå‘ç°æœ€ç»ˆè¿”å›çš„æ˜¯ä¸€ä¸ªdispatch_lane_tç±»å‹çš„dqçš„å¯¹è±¡ï¼Œæ‰€ä»¥dispatch_lane_tåº”è¯¥æ˜¯æœ€ç»ˆç”Ÿæˆçš„é˜Ÿåˆ—ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°å®ƒæ˜¯ç”±_dispatch_object_allocæ–¹æ³•åˆ›å»ºå‡ºæ¥çš„ã€‚ ä½†æ˜¯_dispatch_object_allocæ–¹æ³•å¹¶æ²¡æœ‰å¼€æºï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸çŸ¥é“é‡Œé¢æ˜¯å¦‚ä½•å®ç°çš„ã€‚ ä¸è¿‡_dispatch_objectå¾ˆåƒOCä¸­çš„NSObjectã€‚ 12dispatch_lane_t dq = _dispatch_object_alloc(vtable, sizeof(struct dispatch_lane_s)); dispatch_object_t é€šè¿‡æœç´¢dispatch_objectï¼Œå‘ç°å¹¶æ‰¾ä¸åˆ°æˆ‘ä»¬éœ€è¦çš„å¤šçº¿ç¨‹æŠ½è±¡ç±»ï¼Œä¸è¿‡æˆ‘ä»¬å‘ç°ï¼Œä¸€èˆ¬å¤šçº¿ç¨‹çš„å¯¹è±¡åé¢éƒ½æœ‰_tï¼Œæ‰€ä»¥æˆ‘ä»¬æ‰¾åˆ°äº†dispatch_object_tè¿™ä¸ªå¤šçº¿ç¨‹çš„æŠ½è±¡ç±»ã€‚ æˆ‘ä»¬å¯ä»¥å‘ç°å…¶æ˜¯ä¸€ä¸ªè”åˆä½“ï¼Œå’Œæˆ‘ä»¬isaçš„ç»“æœæå…¶ç±»ä¼¼ï¼Œé‡Œé¢åŒ…å«äº†æˆ‘ä»¬å¸¸ç”¨çš„å¾ˆå¤šä¿¡æ¯ã€‚å› ä¸ºè”åˆä½“äº’æ–¥ï¼Œè¿™æ ·åšæœ‰åˆ©äºå†…å­˜çš„ä¼˜åŒ–ï¼Œå’Œæ›´å¥½çš„å®ç°å¤šæ€ã€‚ 1234567891011121314typedef union { struct _os_object_s *_os_obj; // ç»“æ„ä½“æŒ‡é’ˆ struct dispatch_object_s *_do; struct dispatch_queue_s *_dq; // é˜Ÿåˆ— struct dispatch_queue_attr_s *_dqa; // å‚æ•°å€¼ struct dispatch_group_s *_dg; // ç»„ struct dispatch_source_s *_ds; struct dispatch_channel_s *_dch; struct dispatch_mach_s *_dm; struct dispatch_mach_msg_s *_dmsg; struct dispatch_semaphore_s *_dsema; // ä¿¡å·é‡ struct dispatch_data_s *_ddata; struct dispatch_io_s *_dchannel;} dispatch_object_t DISPATCH_TRANSPARENT_UNION; 2.1.5 _dispatch_queue_initå½“æˆ‘ä»¬åˆ›å»ºå‡ºdispatch_lane_tå¯¹è±¡dqåï¼Œç´§æ¥ç€å°±æ‰§è¡Œ_dispatch_queue_initæ„é€ æ–¹æ³•ã€‚ 123_dispatch_queue_init(dq, dqf, dqai.dqai_concurrent ? DISPATCH_QUEUE_WIDTH_MAX : 1, DISPATCH_QUEUE_ROLE_INNER | (dqai.dqai_inactive ? DISPATCH_QUEUE_INACTIVE : 0)); æŸ¥çœ‹æ–¹æ³•å†…éƒ¨å®ç°ï¼Œå‘ç°é€šè¿‡dispatch_queue_t dq = dqu._dq;å–å‡ºé˜Ÿåˆ—åï¼Œå¯¹é˜Ÿåˆ—åˆè¿›è¡Œäº†ä¸€ç³»åˆ—çš„èµ‹å€¼ï¼Œç„¶ååˆè¿”å›äº† 1234567891011121314151617181920212223242526272829static inline dispatch_queue_class_t_dispatch_queue_init(dispatch_queue_class_t dqu, dispatch_queue_flags_t dqf, uint16_t width, uint64_t initial_state_bits){ uint64_t dq_state = DISPATCH_QUEUE_STATE_INIT_VALUE(width); // å–å‡ºé˜Ÿåˆ— dispatch_queue_t dq = dqu._dq; dispatch_assert((initial_state_bits &amp; ~(DISPATCH_QUEUE_ROLE_MASK | DISPATCH_QUEUE_INACTIVE)) == 0); if (initial_state_bits &amp; DISPATCH_QUEUE_INACTIVE) { dq-&gt;do_ref_cnt += 2; // rdar://8181908 see _dispatch_lane_resume if (dx_metatype(dq) == _DISPATCH_SOURCE_TYPE) { dq-&gt;do_ref_cnt++; // released when DSF_DELETED is set } } // è¿›è¡Œäº†ä¸€ç³»åˆ—èµ‹å€¼ dq_state |= initial_state_bits; dq-&gt;do_next = DISPATCH_OBJECT_LISTLESS; dqf |= DQF_WIDTH(width); os_atomic_store2o(dq, dq_atomic_flags, dqf, relaxed); dq-&gt;dq_state = dq_state; dq-&gt;dq_serialnum = os_atomic_inc_orig(&amp;_dispatch_queue_serial_numbers, relaxed); // åˆè¿”å›äº† return dqu;} å…³æ³¨ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•ä¸­çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œæ˜¯ä¸€ä¸ªåˆ¤æ–­ï¼š 12dqai.dqai_concurrent ? DISPATCH_QUEUE_WIDTH_MAX : 1 åˆ¤æ–­äº†dqai.dqai_concurrentï¼Œæˆ‘ä»¬çŸ¥é“ä¸²è¡Œæ˜¯æ²¡æœ‰dqai_concurrentçš„ï¼Œæ‰€ä»¥ä¸²è¡Œé˜Ÿåˆ—çš„è¿™ä¸ªå±æ€§ä¸º1ï¼Œå°±è¡¨ç¤ºä¸²è¡Œé˜Ÿåˆ—çš„å¹¶å‘æ•°ä¸º1ã€‚ é‚£ä¹ˆå¹¶å‘é˜Ÿåˆ—çš„è¿™ä¸ªå±æ€§å°±ä¸ºï¼šDISPATCH_QUEUE_WIDTH_MAXã€‚ æŸ¥çœ‹DISPATCH_QUEUE_WIDTH_MAXå®å®šä¹‰ï¼Œæˆ‘ä»¬å‘ç°å®ƒçš„å€¼ä¸ºDISPATCH_QUEUE_WIDTH_FULL-2ï¼Œå³0xFFEï¼Œæ‰€ä»¥å¹¶å‘é˜Ÿåˆ—çš„æœ€å¤§å¹¶å‘æ•°ä¸º0xFFEã€‚ è‡³äº-2åˆ™æ˜¯å› ä¸º-1æ˜¯ä¸ºäº†ä¸é¥±å’Œï¼Œå†-1æ˜¯å› ä¸ºDISPATCH_QUEUE_WIDTH_POOLä¸ºåˆ›å»ºå…¨å±€é˜Ÿåˆ—æ—¶å€™æ‰€ä½¿ç”¨çš„ï¼Œé¿å…ç›¸åŒã€‚ 2.1.6 dq-&gt;do_targetq = tq;æ‰§è¡Œå®Œæ„é€ å‡½æ•°ä¹‹åï¼Œæ¥ç€åˆå¯¹dqè¿›è¡Œäº†ä¸€äº›åˆ—èµ‹å€¼ã€‚ ä½†æ˜¯å¦‚æœæ¯æ¬¡åˆ›å»ºçº¿ç¨‹ï¼Œæ‰€æœ‰çš„å±æ€§éƒ½è¦é‡æ–°èµ‹å€¼çš„è¯ï¼Œæ˜¯æ¯”è¾ƒè€—æ€§èƒ½çš„ã€‚æ‰€ä»¥è‹¹æœè®¾è®¡äº†åŸºäºâ€œæ¨¡æ¿â€çš„é˜Ÿåˆ—åˆ›å»ºæ–¹å¼ï¼Œè¿™ä¸ªâ€æ¨¡æ¿â€å°±æ˜¯æˆ‘ä»¬çš„do_targetqå±æ€§ã€‚ 12345678910111213141516171819// æ ‡ç­¾dq-&gt;dq_label = label;// ä¼˜å…ˆçº§dq-&gt;dq_priority = _dispatch_priority_make((dispatch_qos_t)dqai.dqai_qos, dqai.dqai_relpri);if (overcommit == _dispatch_queue_attr_overcommit_enabled) { dq-&gt;dq_priority |= DISPATCH_PRIORITY_FLAG_OVERCOMMIT;}if (!dqai.dqai_inactive) { _dispatch_queue_priority_inherit_from_target(dq, tq); _dispatch_lane_inherit_wlh_from_target(dq, tq);}_dispatch_retain(tq);// âœ…2.6dq-&gt;do_targetq = tq;_dispatch_object_debug(dq, &quot;%s&quot;, __func__);return _dispatch_trace_queue_create(dq)._dq; åœ¨æ–¹æ³•ä¸­å¯»æ‰¾ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°tqçš„åˆ›å»ºæ˜¯é€šè¿‡_dispatch_get_root_queueæ–¹æ³•ï¼Œå³åœ¨æ ¹é˜Ÿåˆ—çš„åŸºç¡€ä¸Šåˆ›å»ºï¼Œç„¶åèµ‹å€¼äº†ä¼˜å…ˆçº§qoså’Œovercommitã€‚ 12345678910if (!tq) { // âœ…ä¸€å®šä¼šèµ°è¿™é‡Œ // 2.7 ä»æ ¹é˜Ÿåˆ—è·å– tq tq = _dispatch_get_root_queue( qos == DISPATCH_QOS_UNSPECIFIED ? DISPATCH_QOS_DEFAULT : qos, // 4 overcommit == _dispatch_queue_attr_overcommit_enabled)-&gt;_as_dq; // å¹¶å‘ä¸º0 ä¸²è¡Œä¸º1 if (unlikely(!tq)) { DISPATCH_CLIENT_CRASH(qos, &quot;Invalid queue attribute&quot;); }} é¦–å…ˆçœ‹qosçš„å€¼ï¼Œæˆ‘ä»¬å‘ç°DISPATCH_QOS_UNSPECIFIEDä¸º0ï¼Œä¸”ä¹‹å‰æˆ‘ä»¬å¹¶æ²¡æœ‰èµ‹å€¼ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹å³æ‰§è¡ŒDISPATCH_QOS_DEFAULTï¼Œä¸º4ï¼Œæ‰€ä»¥qosæ²¡æŒ‡å®šçš„æƒ…å†µä¸‹ä¸º4ã€‚ æ¥ç€çœ‹overcommitçš„å€¼ï¼Œæ ¹æ®ä¸Šé¢dqaiå¯ä»¥åˆ¤æ–­å‡ºï¼Œä¸²è¡Œä¸º1ï¼Œå¹¶å‘ä¸º0 2.1.7 _dispatch_get_root_queue12345678910static inline dispatch_queue_global_t_dispatch_get_root_queue(dispatch_qos_t qos, bool overcommit){ if (unlikely(qos &lt; DISPATCH_QOS_MIN || qos &gt; DISPATCH_QOS_MAX)) { DISPATCH_CLIENT_CRASH(qos, &quot;Corrupted priority&quot;); } // 4 - 1 = 3 // 2 * 3 + 0/1 = 6/7 return &amp;_dispatch_root_queues[2 * (qos - 1) + overcommit];} æˆ‘ä»¬å‘ç°ï¼Œæœ€ç»ˆå°±æ˜¯ä»==æ ¹é˜Ÿåˆ—æ•°ç»„==é‡Œé€šè¿‡ä¸‹æ ‡æ¥å–å‡ºé˜Ÿåˆ—ã€‚ æ ¹æ®å…¥å‚å¯ä»¥çŸ¥é“ï¼Œä¸‹æ ‡ä¸º6æˆ–è€…7ã€‚ä¹Ÿå°±æ˜¯è¯´ä»æ ¹é˜Ÿåˆ—æ•°ç»„ä¸­å–å‡ºç¬¬å…­ä¸ªå’Œç¬¬ä¸ƒä¸ªé˜Ÿåˆ—ã€‚ 2.1.8 _dispatch_root_queues[]123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566struct dispatch_queue_global_s _dispatch_root_queues[] = {#define _DISPATCH_ROOT_QUEUE_IDX(n, flags) \\ ((flags &amp; DISPATCH_PRIORITY_FLAG_OVERCOMMIT) ? \\ DISPATCH_ROOT_QUEUE_IDX_##n##_QOS_OVERCOMMIT : \\ DISPATCH_ROOT_QUEUE_IDX_##n##_QOS)#define _DISPATCH_ROOT_QUEUE_ENTRY(n, flags, ...) \\ [_DISPATCH_ROOT_QUEUE_IDX(n, flags)] = { \\ DISPATCH_GLOBAL_OBJECT_HEADER(queue_global), \\ .dq_state = DISPATCH_ROOT_QUEUE_STATE_INIT_VALUE, \\ .do_ctxt = _dispatch_root_queue_ctxt(_DISPATCH_ROOT_QUEUE_IDX(n, flags)), \\ .dq_atomic_flags = DQF_WIDTH(DISPATCH_QUEUE_WIDTH_POOL), \\ .dq_priority = flags | ((flags &amp; DISPATCH_PRIORITY_FLAG_FALLBACK) ? \\ _dispatch_priority_make_fallback(DISPATCH_QOS_##n) : \\ _dispatch_priority_make(DISPATCH_QOS_##n, 0)), \\ __VA_ARGS__ \\ } _DISPATCH_ROOT_QUEUE_ENTRY(MAINTENANCE, 0, .dq_label = &quot;com.apple.root.maintenance-qos&quot;, .dq_serialnum = 4, ), _DISPATCH_ROOT_QUEUE_ENTRY(MAINTENANCE, DISPATCH_PRIORITY_FLAG_OVERCOMMIT, .dq_label = &quot;com.apple.root.maintenance-qos.overcommit&quot;, .dq_serialnum = 5, ), _DISPATCH_ROOT_QUEUE_ENTRY(BACKGROUND, 0, .dq_label = &quot;com.apple.root.background-qos&quot;, .dq_serialnum = 6, ), _DISPATCH_ROOT_QUEUE_ENTRY(BACKGROUND, DISPATCH_PRIORITY_FLAG_OVERCOMMIT, .dq_label = &quot;com.apple.root.background-qos.overcommit&quot;, .dq_serialnum = 7, ), _DISPATCH_ROOT_QUEUE_ENTRY(UTILITY, 0, .dq_label = &quot;com.apple.root.utility-qos&quot;, .dq_serialnum = 8, ), _DISPATCH_ROOT_QUEUE_ENTRY(UTILITY, DISPATCH_PRIORITY_FLAG_OVERCOMMIT, .dq_label = &quot;com.apple.root.utility-qos.overcommit&quot;, .dq_serialnum = 9, // è‡ªå®šä¹‰ä¸²è¡Œé˜Ÿåˆ—ç”¨è¿™ä¸ª ), _DISPATCH_ROOT_QUEUE_ENTRY(DEFAULT, DISPATCH_PRIORITY_FLAG_FALLBACK, .dq_label = &quot;com.apple.root.default-qos&quot;, .dq_serialnum = 10, // è‡ªå®šä¹‰å¹¶å‘é˜Ÿåˆ—ç”¨è¿™ä¸ª ), _DISPATCH_ROOT_QUEUE_ENTRY(DEFAULT, DISPATCH_PRIORITY_FLAG_FALLBACK | DISPATCH_PRIORITY_FLAG_OVERCOMMIT, .dq_label = &quot;com.apple.root.default-qos.overcommit&quot;, .dq_serialnum = 11, ), _DISPATCH_ROOT_QUEUE_ENTRY(USER_INITIATED, 0, .dq_label = &quot;com.apple.root.user-initiated-qos&quot;, .dq_serialnum = 12, ), _DISPATCH_ROOT_QUEUE_ENTRY(USER_INITIATED, DISPATCH_PRIORITY_FLAG_OVERCOMMIT, .dq_label = &quot;com.apple.root.user-initiated-qos.overcommit&quot;, .dq_serialnum = 13, ), _DISPATCH_ROOT_QUEUE_ENTRY(USER_INTERACTIVE, 0, .dq_label = &quot;com.apple.root.user-interactive-qos&quot;, .dq_serialnum = 14, ), _DISPATCH_ROOT_QUEUE_ENTRY(USER_INTERACTIVE, DISPATCH_PRIORITY_FLAG_OVERCOMMIT, .dq_label = &quot;com.apple.root.user-interactive-qos.overcommit&quot;, .dq_serialnum = 15, ),}; é€šè¿‡ä¸‹æ ‡ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºå¦‚ä¸‹ç»“è®ºã€‚ è‡ªå®šä¹‰å¹¶å‘é˜Ÿåˆ—targeté˜Ÿåˆ—ä¸ºcom.apple.root.default-qos è‡ªå®šä¹‰ä¸²è¡Œé˜Ÿåˆ—targeté˜Ÿåˆ—ä¸ºcom.apple.root.default-qos.overcommit è‡³æ­¤ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„ä¸€ä¸ªä¸²è¡Œæˆ–è€…å¹¶å‘é˜Ÿåˆ—å°±å·²ç»æ ¹æ®æ¨¡æ¿åˆ›å»ºå®Œæˆäº† 2.1.9 éªŒè¯ å›çœ‹æˆ‘ä»¬å¼€å¤´æ‰“å°çš„ä¸€äº›å…³äºå„ç§é˜Ÿåˆ—çš„ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°ï¼š ä¸²è¡Œé˜Ÿåˆ—ã€å¹¶å‘é˜Ÿåˆ—çš„targetç¡®å®å¯¹åº”æ¨¡æ¿ä¸­çš„å€¼ ä¸²è¡Œé˜Ÿåˆ—ã€å¹¶å‘é˜Ÿåˆ—ã€ä¸»é˜Ÿåˆ—ã€å…¨å±€é˜Ÿåˆ—çš„widthï¼ˆwidthè¡¨ç¤ºé˜Ÿåˆ—ä¸­çš„æœ€å¤§å¹¶å‘æ•°ï¼‰éƒ½ä¸æˆ‘ä»¬çš„åˆ†æä¸€è‡´ï¼Œå³ï¼š ä¸²è¡Œé˜Ÿåˆ—å’Œä¸»é˜Ÿåˆ—çš„widthä¸º1 è‡ªå®šä¹‰å¹¶å‘é˜Ÿåˆ—çš„widthä¸ºDISPATCH_QUEUE_WIDTH_MAXï¼Œæ˜¯æ»¡å€¼-2 å…¨å±€é˜Ÿåˆ—çš„widthä¸ºDISPATCH_QUEUE_WIDTH_POOLï¼Œæ˜¯æ»¡å€¼-1 ç”±æ­¤å¯è§ï¼Œæˆ‘ä»¬å¯¹äºåº•å±‚çš„åˆ†ææ˜¯æ­£ç¡®çš„ã€‚ 2.2 æ ¹é˜Ÿåˆ—æ•°ç»„çš„åˆå§‹åŒ–é™¤äº†dispatch_get_main_queueï¼Œå…¶ä»–é˜Ÿåˆ—éƒ½æ˜¯é€šè¿‡_dispatch_root_queuesåˆ›å»ºçš„ï¼Œé‚£ä¹ˆ _dispatch_root_queues åˆæ˜¯åœ¨å“ªåˆ›å»ºçš„å‘¢ï¼Ÿ ç»“è®ºï¼š libdispatch_initä¹‹åè°ƒç”¨_dispatch_introspection_initï¼Œé€šè¿‡ for å¾ªç¯ï¼Œè°ƒç”¨_dispatch_trace_queue_createï¼Œå†å–å‡º_dispatch_root_queuesé‡Œçš„åœ°å€æŒ‡é’ˆä¸€ä¸ªä¸ªåˆ›å»ºå‡ºæ¥çš„ PSæˆ‘ç”¨çš„libdispatchæºç  è‹¹æœå®˜ç½‘çš„libdispatchæºç  å‚è€ƒiOS GCDæºç æµ…æ iOSåº•å±‚å­¦ä¹  - å¤šçº¿ç¨‹ä¹‹GCDé˜Ÿåˆ—åŸç†ç¯‡","link":"/2021/04/15/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/17-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BGCD%E9%98%9F%E5%88%97%E5%8E%9F%E7%90%86/"},{"title":"18-å¤šçº¿ç¨‹ä¹‹GCDåº”ç”¨","text":"ä¸€ã€å‰è¨€GCDé™¤äº†åŸºæœ¬çš„dispatch_syncå’Œdispatch_asyncç”¨æ³•å¤–ï¼Œè¿˜æœ‰ä¿¡å·é‡ï¼Œè°ƒåº¦ç»„ï¼Œå»¶æ—¶æ‰§è¡Œç­‰ç­‰ã€‚ äºŒã€ä¿¡å·é‡ dispatch_semaphore2.1 å¼•è¨€çœ‹ä¸‹é¢˜ï¼Œé—®ï¼šå¤–é¢ a çš„å€¼ä¸ºå¤šå°‘ï¼Ÿé‡Œé¢ a çš„å€¼åˆä¸ºå¤šå°‘ï¼Ÿ 123456789101112- (void)viewDidLoad { [super viewDidLoad]; __block int a = 0; while (a &lt; 5) { dispatch_async(dispatch_get_global_queue(0, 0), ^{ NSLog(@&quot;é‡Œé¢açš„å€¼ï¼š%d -- %@&quot;, a, [NSThread currentThread]); a++; }); } NSLog(@&quot;å¤–é¢açš„å€¼ï¼š%d&quot;, a);} åˆ†æï¼š ä¸»é˜Ÿåˆ—ä¸­æœ‰whileä»»åŠ¡å’ŒNSLogä»»åŠ¡ï¼Œä¸²å‹æ‰§è¡Œï¼Œæ‰€ä»¥ä¸€å®šæ˜¯æ‰§è¡Œå®Œwhileä¹‹åå†æ‰§è¡ŒNSLogï¼Œæ‰€ä»¥å¤–é¢æ‰“å°çš„ a çš„å€¼ä¸€å®šæ˜¯5ã€‚ ä½†æ˜¯æˆ‘ä»¬çŸ¥é“dispatch_asyncæ˜¯å¼‚æ­¥æ‰§è¡Œçš„å¹¶å‘é˜Ÿåˆ—ï¼Œæ‰€ä»¥ä¼šå¼€è¾Ÿå­çº¿ç¨‹è¿›è¡Œa++æ“ä½œï¼Œä¸”è¿™äº›çº¿ç¨‹æ“ä½œçš„éƒ½æ˜¯ a çš„åŒä¸€ç‰‡å†…å­˜ç©ºé—´ï¼Œä¹Ÿå°±è¡¨ç¤ºå½“ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ¯•åï¼Œæ­¤æ—¶åªåœ¨æ‰§è¡Œçš„çº¿ç¨‹ä¸Šçš„ a å€¼éƒ½ä¼šå˜åŒ–ï¼Œæ‰€ä»¥é‡Œé¢çš„ a ä¸€å®šæ˜¯å¤§äº5çš„ã€‚ æ‰“å°éªŒè¯ï¼š 123456789101112131415161718192021-05-12 14:58:14.253962+0800 Test03[10963:187541] é‡Œé¢açš„å€¼ï¼š0 -- &lt;NSThread: 0x600002380f80&gt;{number = 3, name = (null)}2021-05-12 14:58:14.253989+0800 Test03[10963:187540] é‡Œé¢açš„å€¼ï¼š0 -- &lt;NSThread: 0x6000023be2c0&gt;{number = 4, name = (null)}2021-05-12 14:58:14.253996+0800 Test03[10963:187516] é‡Œé¢açš„å€¼ï¼š0 -- &lt;NSThread: 0x600002380f40&gt;{number = 5, name = (null)}2021-05-12 14:58:14.254001+0800 Test03[10963:187541] é‡Œé¢açš„å€¼ï¼š1 -- &lt;NSThread: 0x600002380f80&gt;{number = 3, name = (null)}2021-05-12 14:58:14.254020+0800 Test03[10963:187540] é‡Œé¢açš„å€¼ï¼š2 -- &lt;NSThread: 0x6000023be2c0&gt;{number = 4, name = (null)}2021-05-12 14:58:14.254049+0800 Test03[10963:187541] é‡Œé¢açš„å€¼ï¼š5 -- &lt;NSThread: 0x600002380f80&gt;{number = 3, name = (null)}2021-05-12 14:58:14.254050+0800 Test03[10963:187084] å¤–é¢açš„å€¼ï¼š52021-05-12 14:58:14.254055+0800 Test03[10963:187560] é‡Œé¢açš„å€¼ï¼š5 -- &lt;NSThread: 0x600002381600&gt;{number = 6, name = (null)}2021-05-12 14:58:14.254074+0800 Test03[10963:187541] é‡Œé¢açš„å€¼ï¼š6 -- &lt;NSThread: 0x600002380f80&gt;{number = 3, name = (null)}2021-05-12 14:58:14.254073+0800 Test03[10963:187561] é‡Œé¢açš„å€¼ï¼š5 -- &lt;NSThread: 0x6000023a19c0&gt;{number = 7, name = (null)}2021-05-12 14:58:14.254080+0800 Test03[10963:187516] é‡Œé¢açš„å€¼ï¼š6 -- &lt;NSThread: 0x600002380f40&gt;{number = 5, name = (null)}2021-05-12 14:58:14.254095+0800 Test03[10963:187517] é‡Œé¢açš„å€¼ï¼š6 -- &lt;NSThread: 0x6000023dc000&gt;{number = 8, name = (null)}2021-05-12 14:58:14.254110+0800 Test03[10963:187540] é‡Œé¢açš„å€¼ï¼š6 -- &lt;NSThread: 0x6000023be2c0&gt;{number = 4, name = (null)}2021-05-12 14:58:14.254166+0800 Test03[10963:187563] é‡Œ\\3512021-05-12 14:58:14.254258+0800 Test03[10963:187567] é‡Œé¢açš„å€¼ï¼š8 -- &lt;NSThread: 0x6000023a2280&gt;{number = 14, name = (null)}... 2021-05-12 14:58:14.260581+0800 Test03[10963:187578] é‡Œé¢açš„å€¼ï¼š55 -- &lt;NSThread: 0x6000023a3240&gt;{number = 25, name = (null)}2021-05-12 14:58:14.391239+0800 Test03[10963:187084] [Lifecycle] Scene state change error: the scene is no longer connected. (NSMenuBarScene_0BD7D9C8-B162-41DB-AB90-B4B866250478) è¿™æ ·çš„å†™æ³•å¿…ç„¶æ˜¯æµªè´¹çº¿ç¨‹èµ„æºçš„ï¼Œéå¸¸ä¸åˆç†ï¼Œé€šå¸¸æˆ‘ä»¬è¿›è¡ŒI/Oæ“ä½œæ—¶ï¼Œéƒ½æ˜¯éœ€è¦åŠ é”æ¥ä¿è¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè¿™æ ·æ•°æ®æ‰ä¸ä¼šå‡ºé”™ã€‚ è¿™é‡Œå¯ä»¥é‡‡ç”¨ä¿¡å·é‡è¿›è¡Œå¤„ç†ã€‚ 2.2 ç”¨é€”ä¿¡å·é‡æ˜¯ç”¨äºå¤šçº¿ç¨‹åŒæ­¥çš„ï¼Œè·Ÿä¸€èˆ¬çš„é”ä¸ä¸€æ ·çš„æ˜¯ï¼Œä¿¡å·é‡ä¸æ˜¯é”å®šæŸä¸€ä¸ªèµ„æºï¼Œè€Œæ˜¯é”å®šæµç¨‹ã€‚æ¯”å¦‚ï¼šæœ‰ Aï¼ŒB ä¸¤ä¸ªçº¿ç¨‹ï¼ŒB çº¿ç¨‹è¦ç­‰ A çº¿ç¨‹å®ŒæˆæŸä¸€ä»»åŠ¡ä»¥åå†è¿›è¡Œè‡ªå·±ä¸‹é¢çš„æ­¥éª¤ï¼Œè¿™å°±æ˜¯é”å®šæµç¨‹ã€‚ é”å®šèµ„æºæŒ‡çš„æ˜¯è¢«é”ä½çš„èµ„æºæ— æ³•è¢«å…¶ä½™çš„çº¿ç¨‹è®¿é—®ï¼Œä»è€Œé˜»å¡çº¿ç¨‹è€Œå®ç°çº¿ç¨‹åŒæ­¥ã€‚ 2.3 ç›¸å…³API1dispatch_semaphore_create(M) åˆ›å»ºä¸€ä¸ªå€¼ä¸º M çš„ä¿¡å·é‡ï¼Œå¦‚æœç”¨äºåŠ é”ï¼Œæ­¤æ—¶ M= 0ã€‚ 1dispatch_semaphore_wait(ä¿¡å·é‡ï¼Œç­‰å¾…æ—¶é—´) å¦‚æœè¯¥ä¿¡å·é‡çš„å€¼å¤§äº0ï¼Œåˆ™ä½¿å…¶ä¿¡å·é‡çš„å€¼-1ï¼Œç„¶åç»§ç»­æ‰§è¡Œåé¢çš„ä»£ç ã€‚ å¦‚æœå°äºç­‰äº0ï¼Œåˆ™é˜»å¡çº¿ç¨‹ç›´åˆ°è¯¥ä¿¡å·é‡çš„å€¼å¤§äº0æˆ–è€…è¾¾åˆ°ç­‰å¾…æ—¶é—´ã€‚ 1dispatch_semaphore_signal(ä¿¡å·é‡) é‡Šæ”¾ä¿¡å·é‡ï¼Œä½¿å¾—è¯¥ä¿¡å·é‡çš„å€¼åŠ 1ã€‚ 2.4 ä½¿ç”¨åœºæ™¯2.4.1 é™åˆ¶çº¿ç¨‹çš„æœ€å¤§å¹¶å‘æ•°12345678dispatch_semaphore_t sema = dispatch_semaphore_create(M);for (NSInteger i = 0;i&lt;N;i++ï¼‰ { dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{ dispatch_semaphore_wait(sema, DISPATCH_TIME_FOREVER); // è€—æ—¶æ“ä½œ dispatch_semaphore_signal(sema); });} å¦‚ä¸Šè¿°ä»£ç å¯çŸ¥ï¼Œæ€»å…±å¼‚æ­¥æ‰§è¡ŒNä¸ªä»»åŠ¡ï¼Œä½†æ˜¯ç”±äºæˆ‘ä»¬è®¾ç½®äº†å€¼ä¸º M çš„ä¿¡å·é‡ï¼Œæ¯ä¸€æ¬¡æ‰§è¡Œä»»åŠ¡çš„æ—¶å€™éƒ½ä¼šå¯¼è‡´ä¿¡å·é‡çš„å‡1ï¼Œè€Œåœ¨ä»»åŠ¡ç»“æŸåä½¿ä¿¡å·é‡åŠ 1ï¼Œå½“ä¿¡å·é‡å‡åˆ°0çš„æ—¶å€™ï¼Œè¯´æ˜æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡æœ‰ M ä¸ªï¼Œè¿™ä¸ªæ—¶å€™å…¶å®ƒä»»åŠ¡å°±ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰ä»»åŠ¡è¢«å®Œæˆæ—¶ï¼Œè¿™äº›ä»»åŠ¡æ‰ä¼šæ‰§è¡Œã€‚ 2.4.2 é˜»å¡å‘è¯·æ±‚çš„çº¿ç¨‹æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦==é˜»å¡==å‘é€è¯·æ±‚çš„çº¿ç¨‹ï¼Œæ¯”å¦‚åœ¨å¤šä¸ªè¯·æ±‚å›è°ƒåç»Ÿä¸€æ“ä½œçš„éœ€æ±‚ï¼Œè€Œè¿™äº›è¯·æ±‚ä¹‹é—´å¹¶æ²¡æœ‰é¡ºåºå…³ç³»ï¼Œä¸”è¿™äº›æ¥å£éƒ½ä¼šå¦å¼€çº¿ç¨‹è¿›è¡Œç½‘ç»œè¯·æ±‚çš„ã€‚ä¸€èˆ¬åœ°ï¼Œè¿™ç§å¤šçº¿ç¨‹å®Œæˆåè¿›è¡Œç»Ÿä¸€æ“ä½œçš„éœ€æ±‚éƒ½ä¼šä½¿ç”¨é˜Ÿåˆ—ç»„(dispatch_group_t)æ¥å®Œæˆï¼Œä½†æ˜¯ç”±äºæ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œæ²¡ç­‰å…¶å¼‚æ­¥å›è°ƒä¹‹åï¼Œè¯·æ±‚çš„çº¿ç¨‹å°±ç»“æŸäº†ï¼Œä¸ºæ­¤ï¼Œå°±éœ€è¦ä½¿ç”¨ä¿¡å·é‡æ¥é˜»å¡ä½å‘è¯·æ±‚çš„çº¿ç¨‹ã€‚å®ç°ä»£ç å¦‚ä¸‹ï¼š 12345678dispatch_async(queue, 0), ^{ dispatch_semaphore_t sema = dispatch_semaphore_create(0); [ç½‘ç»œè¯·æ±‚:^{ //è¯·æ±‚å›è°ƒ dispatch_semaphore_signal(sema); }]; dispatch_semaphore_wait(sema, DISPATCH_TIME_FOREVER);}); è¿™æ ·ï¼Œè¯·æ±‚çš„çº¿ç¨‹å°±å¯ä»¥ç­‰åˆ°å›è°ƒç»“æŸåå†ç»“æŸäº†ï¼Œå†é…åˆé˜Ÿåˆ—ç»„å°±èƒ½å®Œæˆä¸Šè¿°çš„éœ€æ±‚ã€‚è¿™ç§æŠ€å·§å¯ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š å¤šä¸ªè¯·æ±‚ç»“æŸåç»Ÿä¸€æ“ä½œ å¤šä¸ªè¯·æ±‚é¡ºåºæ‰§è¡Œ 2.5 å¯¹äºå¼•è¨€ä¸­ä¾‹å­çš„å¤„ç†äº†è§£äº†ä¿¡å·é‡å¦‚ä½•ä½¿ç”¨åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹å¼•è¨€ä¸­çš„ä¾‹å­è¿›è¡Œä¸‹é¢çš„å¤„ç†ï¼š 123456789101112131415161718- (void)viewDidLoad { [super viewDidLoad]; dispatch_semaphore_t sem = dispatch_semaphore_create(0); __block int a = 0; while (a &lt; 5) { dispatch_async(dispatch_get_global_queue(0, 0), ^{ NSLog(@&quot;é‡Œé¢açš„å€¼ï¼š%d -- %@&quot;, a, [NSThread currentThread]); a++; // ä»»åŠ¡æ‰§è¡Œå®Œäº†æ‰+1 dispatch_semaphore_signal(sem); }); // é”ä½ dispatch_semaphore_wait(sem, DISPATCH_TIME_FOREVER); } NSLog(@&quot;å¤–é¢açš„å€¼ï¼š%d&quot;, a);} ä½¿ç”¨çš„æ˜¯é˜»å¡å½“å‰çº¿ç¨‹çš„æ–¹å¼ï¼Œå¦‚æœä»»åŠ¡ä¸æ‰§è¡Œå®Œï¼Œå°±ä¸ä¼šæ‰§è¡Œä¸‹æ¬¡çš„å¾ªç¯ï¼Œä»è€Œè¾¾åˆ°äº†a++è·Ÿéšwhileå¾ªç¯æ‰§è¡Œ5æ¬¡çš„æ•ˆæœã€‚ æ‰“å°éªŒè¯ï¼š 1234562021-05-12 15:40:26.677802+0800 Test03[11206:214126] é‡Œé¢açš„å€¼ï¼š0 -- &lt;NSThread: 0x60000368a780&gt;{number = 5, name = (null)}2021-05-12 15:40:26.677857+0800 Test03[11206:214126] é‡Œé¢açš„å€¼ï¼š1 -- &lt;NSThread: 0x60000368a780&gt;{number = 5, name = (null)}2021-05-12 15:40:26.677898+0800 Test03[11206:214126] é‡Œé¢açš„å€¼ï¼š2 -- &lt;NSThread: 0x60000368a780&gt;{number = 5, name = (null)}2021-05-12 15:40:26.677938+0800 Test03[11206:214126] é‡Œé¢açš„å€¼ï¼š3 -- &lt;NSThread: 0x60000368a780&gt;{number = 5, name = (null)}2021-05-12 15:40:26.677970+0800 Test03[11206:214126] é‡Œé¢açš„å€¼ï¼š4 -- &lt;NSThread: 0x60000368a780&gt;{number = 5, name = (null)}2021-05-12 15:40:26.677994+0800 Test03[11206:213710] å¤–é¢açš„å€¼ï¼š5 ä¸‰ã€æ …æ å‡½æ•°dispatch_barrier3.1 ç”¨é€”ä½¿ç”¨æ …æ å‡½æ•°å¯ä»¥è®©ä¸¤ç»„å¼‚æ­¥ä»»åŠ¡æœ‰å…ˆåé¡ºåºçš„æ‰§è¡Œã€‚ 3.2 ç›¸å…³API1dispatch_barrier_async ä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ 1dispatch_barrier_sync ä¼šé˜»å¡å½“å‰çº¿ç¨‹ ç®€å•æ¥è¯´dispatch_barrier_asyncæˆ–dispatch_barrier_syncå°†å¼‚æ­¥ä»»åŠ¡åˆ†æˆäº†ä¸¤ç»„ï¼Œæ‰§è¡Œå®Œç¬¬ä¸€ç»„åï¼Œå†æ‰§è¡Œè‡ªå·±ï¼Œç„¶åæ‰§è¡Œé˜Ÿåˆ—ä¸­å‰©ä½™çš„ä»»åŠ¡ã€‚ ç¤ºæ„å›¾ï¼š 3.3 ä½¿ç”¨åœºæ™¯é€šè¿‡ä¾‹å­æ¥çœ‹ä¸€ä¸‹æ …æ å‡½æ•°çš„ä½¿ç”¨ã€‚é€šè¿‡æ‰“å°ç»“æœè¿‡æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ …æ å‡½æ•°å¹¶æ²¡æœ‰é˜»å¡ä¸»çº¿ç¨‹çš„è°ƒç”¨ï¼Œä½†æ˜¯å¼‚æ­¥ä»»åŠ¡2çš„æ‰§è¡Œå®Œæ¯•æ˜¯åœ¨å¼‚æ­¥ä»»åŠ¡1åé¢çš„ã€‚è¯´æ˜æ …æ å¹¶æ²¡æœ‰é˜»å¡çº¿ç¨‹ï¼Œè€Œåªæ˜¯é˜»å¡äº†é˜Ÿåˆ—çš„æ‰§è¡Œã€‚ 123456789101112131415161718dispatch_queue_t concurrentQueue = dispatch_queue_create(&quot;com.imo.barrier1&quot;, DISPATCH_QUEUE_CONCURRENT);NSLog(@&quot;å¼€å§‹&quot;);dispatch_async(concurrentQueue, ^{ NSLog(@&quot;ä»»åŠ¡1-%@&quot;,[NSThread currentThread]);});// æ …æ dispatch_barrier_async(concurrentQueue, ^{ NSLog(@&quot;--------------æ …æ ---------------&quot;);});NSLog(@&quot;ä¸­æ­¢&quot;);dispatch_async(concurrentQueue, ^{ NSLog(@&quot;ä»»åŠ¡2-%@&quot;,[NSThread currentThread]);});NSLog(@&quot;ç»“æŸ&quot;); æ‰“å°ç»“æœï¼š 123456å¼€å§‹ä¸­æ­¢ç»“æŸä»»åŠ¡1-&lt;NSThread: 0x6000022d0a00&gt;{number = 4, name = (null)}--------------æ …æ ---------------ä»»åŠ¡2-&lt;NSThread: 0x6000022d0a00&gt;{number = 4, name = (null)} å¦‚æœå°†ä¾‹å­ä¸­çš„dispatch_barrier_asyncæ¢æˆdispatch_barrier_syncã€‚é€šè¿‡ä¸‹é¢çš„æ‰“å°ç»“æœè¿‡å¯ä»¥çœ‹å‡ºï¼Œdispatch_barrier_syncä¸ä»…é˜»å¡äº†çº¿ç¨‹çš„æ‰§è¡Œï¼Œä¹Ÿé˜»å¡äº†é˜Ÿåˆ—çš„æ‰§è¡Œã€‚æ•´ä¸ªä»»åŠ¡éƒ½æŒ‰ç…§é¡ºåºæ¥æ‰§è¡Œäº†ï¼ˆé˜»å¡ä¸»çº¿ç¨‹çš„æ“ä½œè¿˜æ˜¯è¦å°½é‡é¿å…ï¼‰ã€‚ 123456å¼€å§‹ä»»åŠ¡1-&lt;NSThread: 0x600001e96d00&gt;{number = 5, name = (null)}--------------æ …æ ---------------ä¸­æ­¢ç»“æŸä»»åŠ¡2-&lt;NSThread: 0x600001e96d00&gt;{number = 5, name = (null)} æ³¨æ„äº‹é¡¹âš ï¸ï¼š æ …æ å‡½æ•°æœ€ç›´æ¥çš„ä½œç”¨: æ§åˆ¶ä»»åŠ¡æ‰§è¡Œé¡ºåºï¼ŒåŒæ­¥ dispatch_barrier_async å‰é¢çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•æ‰ä¼šæ¥åˆ°è¿™é‡Œ dispatch_barrier_sync ä½œç”¨ç›¸åŒï¼Œä½†æ˜¯è¿™ä¸ªä¼šå µå¡çº¿ç¨‹ï¼Œå½±å“åé¢ä»»åŠ¡çš„æ‰§è¡Œ æ …æ å‡½æ•°åªèƒ½æ§åˆ¶åŒä¸€å¹¶å‘é˜Ÿåˆ— å››ã€è°ƒåº¦ç»„/é˜Ÿåˆ—ç»„dispatch_group4.1 ç”¨é€”ä¹Ÿæ˜¯ä¸ºäº†è§£å†³å¤šçº¿ç¨‹ä¸­å¤šä¸ªå¼‚æ­¥ä»»åŠ¡é¡ºåºæ‰§è¡Œçš„é—®é¢˜ã€‚ 4.2 ç›¸å…³API1dispatch_group_create ç”¨æ¥åˆ›å»ºä¸€ä¸ªè°ƒåº¦ç»„ 1dispatch_group_async å…ˆæŠŠä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œç„¶åå°†é˜Ÿåˆ—æ”¾åˆ°è°ƒåº¦ç»„ä¸­ 1dispatch_group_enter 1dispatch_group_leave è¿›ç»„å’Œå‡ºç»„ï¼Œå¿…é¡»æˆå¯¹ä½¿ç”¨ï¼Œå’Œdispatch_group_asyncä½œç”¨ç›¸åŒ 1dispatch_group_wait è¿›ç»„ä»»åŠ¡æ‰§è¡Œç­‰å¾… 1dispatch_group_notify æ‰§è¡Œè°ƒåº¦ç»„ç»“æŸåæ¥ä¸‹æ¥çš„ä»»åŠ¡ 4.3 å¸¸è§ç”¨æ³•4.3.1 ä½¿ç”¨ dispatch_group_asyncã€æ¨èã€‘åœ¨æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œè°ƒç”¨dispatch_group_notifyæ–¹æ³•é€šçŸ¥åˆ°æˆ‘ä»¬ã€‚ä¸€èˆ¬åœ¨æ­¤æ–¹æ³•ä¸­è·å–åˆ°dispatch_get_main_queueä¸»çº¿ç¨‹ï¼Œç”¨æ¥åˆ·æ–°UIç­‰æ“ä½œã€‚å…·ä½“ä½¿ç”¨çš„ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920 //åˆ›å»ºè°ƒåº¦ç»„ dispatch_group_t group = dispatch_group_create();// å…¨å±€å¹¶å‘é˜Ÿåˆ— dispatch_queue_t queue = dispatch_get_global_queue(0, 0);// è‡ªå·±åˆ›å»ºçš„å¹¶å‘é˜Ÿåˆ— dispatch_queue_t queue1 = dispatch_queue_create(&quot;com.imo.group&quot;, DISPATCH_QUEUE_CONCURRENT); dispatch_group_async(group, queue, ^{ NSLog(@&quot;ä»»åŠ¡ä¸€&quot;); }); dispatch_group_async(group, queue1, ^{ sleep(2); NSLog(@&quot;ä»»åŠ¡äºŒ&quot;); }); dispatch_group_notify(group, dispatch_get_main_queue(), ^{ NSLog(@&quot;ä»»åŠ¡æ‰§è¡Œå®Œæˆ&quot;); }); æ‰“å°ç»“æœï¼š 123ä»»åŠ¡ä¸€ä»»åŠ¡äºŒä»»åŠ¡æ‰§è¡Œå®Œæˆ 4.3.2 ä½¿ç”¨è¿›ç»„å‡ºç»„ä½¿ç”¨è¿›å‡ºç»„çš„æ–¹å¼å’Œdispatch_group_asyncæ•ˆæœç›¸åŒï¼Œåªä¸è¿‡æ˜¯æœ‰äº†è¿›å‡ºç»„çš„ä»£ç ï¼Œé€»è¾‘æ›´åŠ æ¸…æ™°æ˜äº†ï¼Œä½†æ˜¯å†™æ³•è¾ƒéº»çƒ¦ï¼Œæ¨èä½¿ç”¨ä¸Šä¸€ç§æ–¹å¼ã€‚ dispatch_group_enterå’Œdispatch_group_leaveæ˜¯æˆå¯¹ä½¿ç”¨çš„ï¼Œå¿…é¡»å…ˆè¿›ç»„å†å‡ºç»„ï¼Œç¼ºä¸€ä¸å¯ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚ 123456789101112131415161718192021 // å…¨å±€å¹¶å‘é˜Ÿåˆ—dispatch_queue_t queue = dispatch_get_global_queue(0, 0); // é˜Ÿåˆ—ç»„ dispatch_group_t group = dispatch_group_create(); dispatch_group_enter(group); dispatch_async(queue, ^{ sleep(2); NSLog(@&quot;ä»»åŠ¡ä¸€&quot;); dispatch_group_leave(group); }); dispatch_group_enter(group); dispatch_async(queue, ^{ NSLog(@&quot;ä»»åŠ¡äºŒ&quot;); dispatch_group_leave(group); }); dispatch_group_notify(group, dispatch_get_main_queue(), ^{ NSLog(@&quot;æ‰€æœ‰ä»»åŠ¡å®Œæˆ,å¯ä»¥æ›´æ–°UI&quot;); }); æ‰“å°ç»“æœï¼š 123ä»»åŠ¡äºŒä»»åŠ¡ä¸€æ‰€æœ‰ä»»åŠ¡å®Œæˆ,å¯ä»¥æ›´æ–°UI 4.3.3 ä½¿ç”¨ dispatch_group_waitå¯ä»¥ç†è§£ä¸ºä¸€ç§æ …æ ã€‚ 1dispatch_group_wait(è°ƒåº¦ç»„, ç­‰å¾…æ—¶é—´) ç­‰å¾…æ—¶é—´ï¼š DISPATCH_TIME_FOREVERï¼šæ°¸ä¹…ç­‰å¾… DISPATCH_TIME_NOWï¼šä¸ç­‰å¾…ï¼Œç«‹åˆ»åˆ¤å®šDispatch Groupçš„å¤„ç†æ˜¯å¦å…¨éƒ¨æ‰§è¡Œç»“æŸ å‡½æ•°è¿”å›å€¼ï¼š è¿”å›å€¼ä¸º0ï¼Œå°±æ„å‘³ç€Dispatch Groupä¸­çš„æ“ä½œå…¨éƒ¨æ‰§è¡Œå®Œæ¯• è¿”å›å€¼ä¸ä¸º0ï¼Œå°±æ„å‘³ç€è™½ç„¶ç»è¿‡äº†æŒ‡å®šçš„æ—¶é—´ï¼Œä½†Dispatch Groupä¸­çš„æ“ä½œå¹¶æœªå…¨éƒ¨æ‰§è¡Œå®Œæ¯• ä¸¾ä¾‹ï¼š 1234567891011121314151617181920212223242526dispatch_queue_t queue = dispatch_get_global_queue(0, 0);dispatch_group_t group = dispatch_group_create();dispatch_group_enter(group);dispatch_async(queue, ^{ sleep(2); NSLog(@&quot;ä»»åŠ¡ä¸€&quot;); dispatch_group_leave(group);});long timeout = dispatch_group_wait(group, dispatch_time(DISPATCH_TIME_FOREVER, 0));if (timeout == 0) { NSLog(@&quot;å›æ¥äº†&quot;);}else{ NSLog(@&quot;ç­‰å¾…ä¸­&quot;);}dispatch_group_enter(group);dispatch_async(queue, ^{ NSLog(@&quot;ä»»åŠ¡äºŒ&quot;); dispatch_group_leave(group);});dispatch_group_notify(group, dispatch_get_main_queue(), ^{ NSLog(@&quot;æ‰€æœ‰ä»»åŠ¡å®Œæˆ,å¯ä»¥æ›´æ–°UI&quot;);}); æ‰“å°ç»“æœï¼š 1234ä»»åŠ¡ä¸€å›æ¥äº†ä»»åŠ¡äºŒæ‰€æœ‰ä»»åŠ¡å®Œæˆ,å¯ä»¥æ›´æ–°UI å¦‚æœæˆ‘ä»¬æŠŠè¶…æ—¶æ—¶é—´è®¾ç½®çš„çŸ­ä¸€ç‚¹ï¼Œæ¯”å¦‚1ç§’ï¼Œlong timeout = dispatch_group_wait(group, dispatch_time(DISPATCH_TIME_NOW,1 * NSEC_PER_SEC));å¯ä»¥å‘ç°æ‰“å°ç»“æœä¸åŒï¼Œå’Œæ²¡æœ‰è¿›è¡Œwaitæ—¶çš„æ‰“å°ç»“æœæ˜¯ç›¸åŒçš„ï¼š 1234ç­‰å¾…ä¸­ä»»åŠ¡äºŒä»»åŠ¡ä¸€æ‰€æœ‰ä»»åŠ¡å®Œæˆ,å¯ä»¥æ›´æ–°UI æ³¨æ„äº‹é¡¹âš ï¸ï¼š dispatch_group_enterå’Œdispatch_group_leaveæ˜¯æˆå¯¹ä½¿ç”¨çš„ï¼Œå¿…é¡»å…ˆè¿›ç»„å†å‡ºç»„ï¼Œç¼ºä¸€ä¸å¯ dispatch_group_waitå¯ä»¥è®¾ç½®ç­‰å¾…æ—¶é—´ï¼Œç”¨æ¥åŒºåˆ†å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œ dispatch_group_notifyä¸ºç»„ä»»åŠ¡å…¨éƒ¨å®Œæˆåæ‰§è¡Œçš„å›è°ƒï¼Œä¸€èˆ¬åœ¨å¤„ç†ä¸»çº¿ç¨‹é€»è¾‘ äº”ã€å»¶è¿Ÿå‡½æ•°dispatch_afteréœ€è¦æ³¨æ„çš„æ˜¯ï¼šdispatch_afteræ–¹æ³•å¹¶ä¸æ˜¯åœ¨æŒ‡å®šæ—¶é—´ä¹‹åæ‰å¼€å§‹æ‰§è¡Œå¤„ç†ï¼Œè€Œæ˜¯åœ¨æŒ‡å®šæ—¶é—´ä¹‹åå°†ä»»åŠ¡è¿½åŠ åˆ°ä¸»é˜Ÿåˆ—ä¸­ã€‚ ä¸¥æ ¼æ¥è¯´ï¼Œè¿™ä¸ªæ—¶é—´å¹¶ä¸æ˜¯ç»å¯¹å‡†ç¡®çš„ï¼Œä½†æƒ³è¦å¤§è‡´å»¶è¿Ÿæ‰§è¡Œä»»åŠ¡ï¼Œdispatch_after æ–¹æ³•æ˜¯å¾ˆæœ‰æ•ˆçš„ã€‚ 123456-(void)afterTask{ NSLog(@&quot;å¼€å§‹&quot;); dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(3.0*NSEC_PER_SEC)), dispatch_get_main_queue(), ^{ NSLog(@&quot;æ‰§è¡Œ---%@&quot;,[NSThread currentThread]); });} å…­ã€å•æ¬¡å‡½æ•°dispatch_oncedispatch_onceæ–¹æ³•å¯ä»¥ä¿è¯ä¸€æ®µä»£ç åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­åªè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œè€Œä¸”åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚ 12345678+ (instancetype)shareInstance{ static JYManager *instance = nil; static dispatch_once_t onceToken; dispatch_once(&amp;onceToken, ^{ instance = [JYManager alloc] init]; }); return instance;} ä¸ƒã€äº‹ä»¶æºdispatch_source7.1 ç”¨é€”å¯ä»¥ç”¨æ¥ç›‘å¬ä¸€äº›åº•å±‚çš„ç³»ç»Ÿäº‹ä»¶ã€‚åœ¨æ—¥å¸¸çš„å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä½¿ç”¨å®ƒæ¥åˆ›å»ºä¸€ä¸ªåŸºäºGCDçš„Timerã€‚ä½†æ˜¯å®ƒè¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„ç›‘å¬ç±»å‹ï¼Œé€šè¿‡æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£æˆ‘ä»¬å¯å¾—ä»¥ä¸‹ç›‘å¬ï¼š Timer Dispatch Sourceï¼šå®šæ—¶è°ƒåº¦æºã€‚ Signal Dispatch Sourceï¼šç›‘å¬UNIXä¿¡å·è°ƒåº¦æºï¼Œæ¯”å¦‚ç›‘å¬ä»£è¡¨æŒ‚èµ·æŒ‡ä»¤çš„SIGSTOPä¿¡å·ã€‚ Descriptor Dispatch Sourceï¼šç›‘å¬æ–‡ä»¶ç›¸å…³æ“ä½œå’ŒSocketç›¸å…³æ“ä½œçš„è°ƒåº¦æºã€‚ Process Dispatch Sourceï¼šç›‘å¬è¿›ç¨‹ç›¸å…³çŠ¶æ€çš„è°ƒåº¦æºã€‚ Mach port Dispatch Sourceï¼šç›‘å¬Machç›¸å…³äº‹ä»¶çš„è°ƒåº¦æºã€‚ Custom Dispatch Sourceï¼šç›‘å¬è‡ªå®šä¹‰äº‹ä»¶çš„è°ƒåº¦æº 7.2 ç›¸å…³API dispatch_source_create: åˆ›å»ºäº‹ä»¶æº dispatch_source_set_event_handler: è®¾ç½®æ•°æ®æºå›è°ƒ dispatch_source_merge_data: è®¾ç½®äº‹ä»¶æºæ•°æ® dispatch_source_get_dataï¼šè·å–äº‹ä»¶æºæ•°æ® dispatch_resume: ç»§ç»­ dispatch_suspend: æŒ‚èµ· dispatch_cancle: å–æ¶ˆ 7.3 ä½¿ç”¨å¦‚ä½•ä½¿ç”¨ï¼š â‘ æŒ‡å®šä¸€ä¸ªå¸Œæœ›ç›‘å¬çš„ç³»ç»Ÿäº‹ä»¶ç±»å‹ â‘¡æŒ‡å®šä¸€ä¸ªæ•è·åˆ°äº‹ä»¶åè¿›è¡Œé€»è¾‘å¤„ç†çš„å›è°ƒå‡½æ•° â‘¢å†æŒ‡å®šä¸€ä¸ªè¯¥å›è°ƒå‡½æ•°æ‰§è¡Œçš„é˜Ÿåˆ—å³å¯ ç„¶åå½“ç›‘å¬åˆ°äº‹ä»¶åå°±ä¼šè§¦å‘æŒ‡å®šé˜Ÿåˆ—ä¸­çš„å›è°ƒã€‚ è¿™é‡Œä¸é€šå¸¸çš„æ‰‹åŠ¨æ·»åŠ ä»»åŠ¡çš„æ¨¡å¼ä¸åŒï¼Œä¸€æ—¦dispatch_sourceä¸é˜Ÿåˆ—å…³è”åï¼Œåªè¦ç›‘å¬åˆ°ç³»ç»Ÿäº‹ä»¶ï¼Œdispatch_sourceå°±ä¼šè‡ªåŠ¨å°†ä»»åŠ¡ï¼ˆå›è°ƒå‡½æ•°ï¼‰æ·»åŠ åˆ°å…³è”çš„é˜Ÿåˆ—ä¸­ï¼Œç›´åˆ°æˆ‘ä»¬è°ƒç”¨å‡½æ•°å–æ¶ˆç›‘å¬ã€‚ ä¸ºäº†ä¿è¯ç›‘å¬åˆ°äº‹ä»¶åå›è°ƒå‡½æ•°èƒ½å¤Ÿéƒ½åˆ°æ‰§è¡Œï¼Œå·²å…³è”çš„é˜Ÿåˆ—ä¼šè¢«dispatch_sourceå¼ºå¼•ç”¨ã€‚ 7.4 åº”ç”¨â€”è‡ªå®šä¹‰GCDTimeråœ¨iOSå¼€å‘ä¸­ä¸€èˆ¬ä½¿ç”¨NSTimeræ¥å¤„ç†å®šæ—¶é€»è¾‘ï¼Œä½†NSTimeræ˜¯ä¾èµ–Runloopçš„ï¼Œè€ŒRunloopå¯ä»¥è¿è¡Œåœ¨ä¸åŒçš„æ¨¡å¼ä¸‹ã€‚å¦‚æœNSTimeræ·»åŠ åœ¨ä¸€ç§æ¨¡å¼ä¸‹ï¼Œå½“Runloopè¿è¡Œåœ¨å…¶ä»–æ¨¡å¼ä¸‹çš„æ—¶å€™ï¼Œå®šæ—¶å™¨å°±æŒ‚æœºäº†ï¼›åˆå¦‚æœRunloopåœ¨é˜»å¡çŠ¶æ€ï¼ŒNSTimerè§¦å‘æ—¶é—´å°±ä¼šæ¨è¿Ÿåˆ°ä¸‹ä¸€ä¸ªRunloopå‘¨æœŸã€‚å› æ­¤NSTimeråœ¨è®¡æ—¶ä¸Šä¼šæœ‰è¯¯å·®ï¼Œå¹¶ä¸æ˜¯ç‰¹åˆ«ç²¾ç¡®ï¼Œè€ŒGCDå®šæ—¶å™¨ä¸ä¾èµ–Runloopï¼Œè®¡æ—¶ç²¾åº¦è¦é«˜å¾ˆå¤š ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä»£ç ï¼Œä½¿ç”¨dispatch_sourceæ¥å°è£…ä¸€ä¸ªGCDTimerï¼š Demoåœ°å€ï¼šLink JYTimer.h 123456789101112131415161718192021222324#import &lt;Foundation/Foundation.h&gt;typedef void(^JYTimerBlock)(void);@interface JYTimer : NSObject/// åˆ›å»ºä¸€ä¸ªåŸºäº GCD çš„å®šæ—¶å™¨ï¼Œé»˜è®¤æŒ‚èµ·ï¼Œéœ€è¦æ‰‹åŠ¨å¼€å¯/// @param interval é‡å¤æ—¶é—´é—´éš”/// @param repeat æ˜¯å¦é‡å¤/// @param completion äº‹ä»¶å›è°ƒ+ (instancetype)timerWithInterval:(NSTimeInterval)interval repeat:(BOOL)repeat completion:(JYTimerBlock)completion;/// å¼€å§‹å’Œç»§ç»­å®šæ—¶å™¨- (void)resumeTimer;/// ç»ˆæ­¢å®šæ—¶å™¨- (void)invalidTimer;/// æš‚åœå®šæ—¶å™¨- (void)pauseTimer;@end JYTimer.m 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768#import &quot;JYTimer.h&quot;@interface JYTimer ()// GCDTimer éœ€è¦å¼ºæŒæœ‰ï¼Œå¦åˆ™å‡ºäº†ä½œç”¨åŸŸç«‹å³é‡Šæ”¾ï¼Œä¹Ÿå°±æ²¡æœ‰äº†äº‹ä»¶å›è°ƒ@property (nonatomic, strong) dispatch_source_t timer;@property (nonatomic, assign) BOOL isRuning;@end@implementation JYTimer+ (JYTimer *)timerWithInterval:(NSTimeInterval)interval repeat:(BOOL)repeat completion:(JYTimerBlock)completion { JYTimer *timer = [[JYTimer alloc] initWithInterval:interval repeat:repeat completion:completion]; return timer;}- (instancetype)initWithInterval:(NSTimeInterval)interval repeat:(BOOL)repeat completion:(JYTimerBlock)completion { if (self = [super init]) { self.isRuning = NO; // åˆå§‹åŒ– timer self.timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, dispatch_get_global_queue(0, 0)); // è®¾ç½® timer çš„é¦–æ¬¡æ‰§è¡Œæ—¶é—´ï¼Œé—´éš”ï¼Œç²¾ç¡®åº¦ dispatch_source_set_timer(self.timer, DISPATCH_TIME_NOW, interval * NSEC_PER_SEC, 0 * NSEC_PER_SEC); // è®¾ç½® timer äº‹ä»¶å›è°ƒ __weak typeof(self) weakSelf = self; dispatch_source_set_event_handler(self.timer, ^{ if (completion) { completion(); } if (!repeat) { dispatch_source_cancel(weakSelf.timer); weakSelf.isRuning = NO; weakSelf.timer = nil; } }); } return self;}- (void)resumeTimer { if (self.timer &amp;&amp; !self.isRuning) { dispatch_resume(self.timer); self.isRuning = YES; }}- (void)invalidTimer { if (self.timer) { dispatch_source_cancel(self.timer); self.isRuning = NO; self.timer = nil; }}- (void)pauseTimer { if (self.timer &amp;&amp; self.isRuning) { dispatch_suspend(self.timer); self.isRuning = NO; }}@end æµ‹è¯•ä»£ç ï¼š ViewController.m 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465#import &quot;ViewController.h&quot;#import &quot;JYTimer.h&quot;@interface ViewController ()@property (nonatomic, strong) JYTimer *timer;@end@implementation ViewController- (void)viewDidLoad { [super viewDidLoad]; self.view.backgroundColor = [UIColor whiteColor]; __block int a = 0; JYTimer *timer = [JYTimer timerWithInterval:1.0 repeat:YES completion:^{ a++; NSLog(@&quot;%d&quot;, a); }]; self.timer = timer; [self setupUI];}- (void)setupUI { UIButton *btn = [UIButton new]; [btn setTitle:@&quot;å¼€å§‹&quot; forState:UIControlStateNormal]; btn.frame = CGRectMake(10, 90, 100, 80); btn.backgroundColor = [UIColor systemBlueColor]; [self.view addSubview:btn]; [btn addTarget:self action:@selector(start:) forControlEvents:UIControlEventTouchUpInside]; UIButton *btn1 = [UIButton new]; [btn1 setTitle:@&quot;ç»ˆæ­¢&quot; forState:UIControlStateNormal]; btn1.frame = CGRectMake(10, 190, 100, 80); btn1.backgroundColor = [UIColor systemBlueColor]; [self.view addSubview:btn1]; [btn1 addTarget:self action:@selector(invalid:) forControlEvents:UIControlEventTouchUpInside]; UIButton *btn2 = [UIButton new]; [btn2 setTitle:@&quot;æš‚åœ&quot; forState:UIControlStateNormal]; btn2.frame = CGRectMake(10, 290, 100, 80); btn2.backgroundColor = [UIColor systemBlueColor]; [self.view addSubview:btn2]; [btn2 addTarget:self action:@selector(pause:) forControlEvents:UIControlEventTouchUpInside];}#pragma mark - Event- (void)start:(UIButton *)btn { [self.timer resumeTimer];}- (void)invalid:(UIButton *)btn { [self.timer invalidTimer];}- (void)pause:(UIButton *)btn { [self.timer pauseTimer];}@end ä½¿ç”¨dispatch_sourceè‡ªå®šä¹‰å®šæ—¶å™¨æ³¨æ„ç‚¹ï¼š GCDTimeréœ€è¦å¼ºæŒæœ‰ï¼Œå¦åˆ™å‡ºäº†ä½œç”¨åŸŸç«‹å³é‡Šæ”¾ï¼Œä¹Ÿå°±æ²¡æœ‰äº†äº‹ä»¶å›è°ƒ GCDTimeré»˜è®¤æ˜¯æŒ‚èµ·çŠ¶æ€ï¼Œéœ€è¦æ‰‹åŠ¨æ¿€æ´» GCDTimeræ²¡æœ‰repeatï¼Œéœ€è¦å°è£…æ¥å¢åŠ æ ‡å¿—ä½æ§åˆ¶ GCDTimerå¦‚æœå­˜åœ¨å¾ªç¯å¼•ç”¨ï¼Œä½¿ç”¨weak+strongæˆ–è€…æå‰è°ƒç”¨dispatch_source_cancelå–æ¶ˆtimer dispatch_resumeå’Œdispatch_suspendè°ƒç”¨æ¬¡æ•°éœ€è¦å¹³è¡¡ sourceåœ¨æŒ‚èµ·çŠ¶æ€ä¸‹ï¼Œå¦‚æœç›´æ¥è®¾ç½®source = nilæˆ–è€…é‡æ–°åˆ›å»ºsourceéƒ½ä¼šé€ æˆcrashã€‚æ­£ç¡®çš„æ–¹å¼æ˜¯åœ¨æ¿€æ´»çŠ¶æ€ä¸‹è°ƒç”¨dispatch_source_cancel(source)é‡Šæ”¾å½“å‰çš„source PSæˆ‘å°è£…çš„GCDTimer å‚è€ƒIOS GCDä¸­çš„ä¿¡å·é‡ iOSæ¢ç´¢ å¤šçº¿ç¨‹ä¹‹GCDåº”ç”¨","link":"/2021/05/12/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/18-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BGCD%E5%BA%94%E7%94%A8/"}],"tags":[],"categories":[{"name":"Mac","slug":"Mac","link":"/categories/Mac/"},{"name":"iOSÂ·åº•å±‚åŸç†","slug":"iOSÂ·åº•å±‚åŸç†","link":"/categories/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/"},{"name":"iOSÂ·è´¨é‡&amp;æ•ˆç‡","slug":"iOSÂ·è´¨é‡-æ•ˆç‡","link":"/categories/iOS%C2%B7%E8%B4%A8%E9%87%8F-%E6%95%88%E7%8E%87/"},{"name":"åšå®¢","slug":"åšå®¢","link":"/categories/%E5%8D%9A%E5%AE%A2/"},{"name":"è¯»ä¹¦ç¬”è®°","slug":"è¯»ä¹¦ç¬”è®°","link":"/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"},{"name":"iOSÂ·é—®é¢˜è®°å½•","slug":"iOSÂ·é—®é¢˜è®°å½•","link":"/categories/iOS%C2%B7%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/"},{"name":"iOSÂ·æ•°æ®å­˜å‚¨","slug":"iOSÂ·æ•°æ®å­˜å‚¨","link":"/categories/iOS%C2%B7%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/"},{"name":"iOSÂ·ç»Ÿè®¡","slug":"iOSÂ·ç»Ÿè®¡","link":"/categories/iOS%C2%B7%E7%BB%9F%E8%AE%A1/"}]}