<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>03 - isa原理 - IMO&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="IMO&#039;s Blog"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/avatar4.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="IMO&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description=""><meta property="og:type" content="blog"><meta property="og:title" content="03 - isa原理"><meta property="og:url" content="http://evilimo.com/2020/10/21/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/03-isa%E5%8E%9F%E7%90%86/"><meta property="og:site_name" content="IMO&#039;s Blog"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007786247376.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007786706178.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007786783257.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007786920476.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007787059086.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007787149201.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007787237628.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007787333387.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007787631319.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007787726729.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007787813345.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007787933363.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007788041889.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007788204558.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007788309807.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007789472636.jpg"><meta property="article:published_time" content="2020-10-21T08:15:21.716Z"><meta property="article:modified_time" content="2020-10-21T11:41:02.004Z"><meta property="article:author" content="IMO"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007786247376.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://evilimo.com/2020/10/21/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/03-isa%E5%8E%9F%E7%90%86/"},"headline":"IMO's Blog","image":["https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007786247376.jpg","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007786706178.jpg","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007786783257.jpg","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007786920476.jpg","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007787059086.jpg","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007787149201.jpg","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007787237628.jpg","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007787333387.jpg","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007787631319.jpg","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007787726729.jpg","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007787813345.jpg","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007787933363.jpg","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007788041889.jpg","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007788204558.jpg","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007788309807.jpg","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007789472636.jpg"],"datePublished":"2020-10-21T08:15:21.716Z","dateModified":"2020-10-21T11:41:02.004Z","author":{"@type":"Person","name":"IMO"},"description":""}</script><link rel="canonical" href="http://evilimo.com/2020/10/21/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/03-isa%E5%8E%9F%E7%90%86/"><link rel="icon" href="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/avatar4.png"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.4.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><!--!--><meta name="generator" content="Hexo 5.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/imglogo.png" alt="IMO&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-10-21T08:15:21.716Z" title="2020-10-21T08:15:21.716Z">2020-10-21</time>发表</span><span class="level-item"><time dateTime="2020-10-21T11:41:02.004Z" title="2020-10-21T11:41:02.004Z">2020-10-21</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/">iOS·底层原理</a></span></div></div><h1 class="title is-3 is-size-4-mobile">03 - isa原理</h1><div class="content"><hr>
<a id="more"></a>

<h2 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h2><ul>
<li>在<code>arm64</code>架构之前,<code>isa</code>仅仅是一个指针,保存着类对象(Class)或元类对象(Meta-Class)的内存地址</li>
<li>在<code>arm64</code>架构之后,苹果对<code>isa</code>进行了优化,变成了一个<code>isa_t</code>类型的联合体(union)结构,同时使用<strong>位域</strong>来存储更多的信息:</li>
</ul>
<p>也就是说,我们之前熟知的<code>OC</code>对象的<code>isa</code>指针并不是直接指向类对象或者元类对象的内存地址,而是需要<code>&amp; ISA_MASK</code>通过位运算才能获取类对象或者元类对象的地址.</p>
<p><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007786247376.jpg"></p>
<h2 id="二、联合体位域"><a href="#二、联合体位域" class="headerlink" title="二、联合体位域"></a>二、联合体位域</h2><h3 id="1-位域"><a href="#1-位域" class="headerlink" title="1.位域"></a>1.位域</h3><p>位域是指信息在存储时，并不需要占用一个完整的字节， 而只需占一个或几个二进制位。这样一来不仅节省存储空间，还使处理更加简便。</p>
<h3 id="2-位运算符"><a href="#2-位运算符" class="headerlink" title="2.位运算符"></a>2.位运算符</h3><ul>
<li>位运算符用来对二进制位进行操作</li>
<li>操作数只能为<strong>整型和字符型数据</strong>。</li>
<li><code>C</code>语言中六种位运算符：<code>&amp;</code>按位与、<code>|</code>按位或、<code>^</code>按位异或、<code>~</code>非、<code>&lt;&lt;</code>左移和<code>&gt;&gt;</code>右移。 </li>
</ul>
<h4 id="1-按位与-amp"><a href="#1-按位与-amp" class="headerlink" title="1)按位与&amp;"></a>1)按位与&amp;</h4><p>有0出0,全1出1.</p>
<table>
<thead>
<tr>
<th align="center">A</th>
<th align="center">B</th>
<th align="center">&amp;</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">0</td>
</tr>
<tr>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">0</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
</tr>
</tbody></table>
<h4 id="2-按位或"><a href="#2-按位或" class="headerlink" title="2)按位或 |"></a>2)按位或 |</h4><p>有1出1,全0出0.</p>
<table>
<thead>
<tr>
<th align="center">A</th>
<th align="center">B</th>
<th align="center">I</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">1</td>
</tr>
</tbody></table>
<h4 id="3-按位异或"><a href="#3-按位异或" class="headerlink" title="3)按位异或^"></a>3)按位异或^</h4><p>相同为0,不同为1.</p>
<table>
<thead>
<tr>
<th align="center">A</th>
<th align="center">B</th>
<th align="center">^</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">0</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">1</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">0</td>
</tr>
</tbody></table>
<h4 id="4-非"><a href="#4-非" class="headerlink" title="4)非 ~"></a>4)非 ~</h4><p>非运算即取反运算，在二进制中 1 变 0 ，0 变 1。例如<code>110101</code>进行非运算后为<code>001010</code>，即<code>1010</code>.</p>
<h4 id="5-左移-lt-lt"><a href="#5-左移-lt-lt" class="headerlink" title="5)左移 &lt;&lt;"></a>5)左移 &lt;&lt;</h4><ul>
<li>左移运算就是把<code>&lt;&lt;</code>左边的运算数的各二进位全部左移若干位，移动的位数即<code>&lt;&lt;</code>右边的数的数值。</li>
<li>高位丢弃，低位补0。</li>
<li>左移n位就是乘以2的n次方。例如：<code>a&lt;&lt;4</code>是指把a的各二进位向左移动4位。如原来a=00000011(十进制3)，左移4位后为00110000(十进制48)。</li>
</ul>
<h4 id="6-右移-gt-gt"><a href="#6-右移-gt-gt" class="headerlink" title="6)右移 &gt;&gt;"></a>6)右移 &gt;&gt;</h4><p>右移运算就是把<code>&gt;&gt;</code>左边的运算数的各二进位全部右移若干位，<code>&gt;&gt;</code>右边的数指定移动的位数。例如：设 a=15，a&gt;&gt;2 表示把00001111右移为00000011(十进制3)</p>
<h3 id="3-位运算符的运用"><a href="#3-位运算符的运用" class="headerlink" title="3.位运算符的运用"></a>3.位运算符的运用</h3><h4 id="1-取值"><a href="#1-取值" class="headerlink" title="1)取值"></a>1)取值</h4><ul>
<li><p>可以利用<code>按位与 &amp;</code>运算取出指定位的值</p>
</li>
<li><p>具体操作是想取出哪一位的值就将那一位置为1,其它位都为0,然后同原数据进行按位与计算,即可取出特定的位.</p>
</li>
</ul>
<blockquote>
<p>例: <code>0000 0011</code>取出倒数第三位的值</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 想取出倒数第三位的值，就将倒数第三位的值置为1，其它位为0，跟原数据按位与运算</span></span><br><span class="line">  <span class="number">0000</span> <span class="number">0011</span>		  (源码)</span><br><span class="line">&amp; <span class="number">0000</span> <span class="number">0100</span>		 （掩码）</span><br><span class="line">------------</span><br><span class="line">  <span class="number">0000</span> <span class="number">0000</span>  <span class="comment">// 得出按位与运算后的结果，即可拿到原数据中倒数第三位的值为0</span></span><br><span class="line">  </span><br></pre></td></tr></table></figure>

<p>上面的例子中,我们从<code>0000 0011</code>中取值,则有<code>0000 0011</code>被称之为源码.进行按位与操作设定的<code>0000 0100</code>称之为掩码.</p>
<blockquote>
<p>例: <code>0000 0011</code>取出后三位的值</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 想取出后三位的值，就将掩码后三位置为1，其它位为0，跟原数据按位与运算</span></span><br><span class="line">  <span class="number">0000</span> <span class="number">0011</span>		  (源码)</span><br><span class="line">&amp; <span class="number">0000</span> <span class="number">0111</span>		 （掩码）</span><br><span class="line">------------</span><br><span class="line">  <span class="number">0000</span> <span class="number">0011</span>  <span class="comment">// 得出按位与运算后的结果，即可拿到原数据中后三位的值为011</span></span><br><span class="line">  </span><br></pre></td></tr></table></figure>



<h4 id="2-设值"><a href="#2-设值" class="headerlink" title="2)设值"></a>2)设值</h4><ul>
<li>可以通过<code>按位或 |</code>或者<code>按位与 &amp;</code>运算符将某一位的值设为1或0.</li>
<li>要将某一位的值置为1的话，那么就将掩码中对应位的值设为1，掩码其它位为0，将源码与掩码进行<code>按位或|</code>操作即可.</li>
</ul>
<blockquote>
<p>例: 将<code>0000 0011</code>倒数第三位的值改为1</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 改变倒数第三位的值，就将掩码倒数第三位的值置为1，其它位为0，跟源码按位或运算</span></span><br><span class="line">  <span class="number">0000</span> <span class="number">0011</span></span><br><span class="line">| <span class="number">0000</span> <span class="number">0100</span></span><br><span class="line">------------</span><br><span class="line">  <span class="number">0000</span> <span class="number">0111</span>  <span class="comment">// 即可将源码中倒数第三位的值改为1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>要将某一位的值置为0的话，那么就将掩码中对应位的值设为0，掩码其它位为1，将源码与掩码进行<code>按位与&amp;</code>操作即可.</li>
</ul>
<blockquote>
<p>例: 将<code>0000 0011</code>倒数第二位的值改为0</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 改变倒数第二位的值，就将掩码倒数第二位的值置为0，其它位为1，跟源码`按位与&amp;`运算</span></span><br><span class="line">  <span class="number">0000</span> <span class="number">0011</span></span><br><span class="line">| <span class="number">1111</span> <span class="number">1101</span></span><br><span class="line">------------</span><br><span class="line">  <span class="number">0000</span> <span class="number">0001</span>  <span class="comment">// 即可将源码中倒数第二位的值改为0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="4-位运算的实际应用"><a href="#4-位运算的实际应用" class="headerlink" title="4.位运算的实际应用"></a>4.位运算的实际应用</h3><p>声明一个<code>TCJCar</code>类，类中有四个<code>BOOL</code>类型的属性,分别为<code>front</code>、<code>back</code>、<code>left</code>、<code>right</code>,通过这四个属性来判断这辆小车的行驶方向.<br><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007786706178.jpg"></p>
<p>然后我们来查看一下这个<code>TCJCar</code>类对象所占据的内存大小:<br><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007786783257.jpg"></p>
<p>我们看到,一个<code>TCJCar</code>类的对象占据16个字节.其中包括一个<code>isa</code>指针和四个<code>BOOL</code>类型的属性,8+1+1+1+1=12,根据<strong>内存对齐</strong>原则,所以一个<code>TCJCar</code>类的对象占16个字节.</p>
<p>我们知道,<code>BOOL</code>值只有两种情况:<code>0</code>或<code>1</code>，占据一个字节的内存空间.而一个字节的内存空间中又有8个二进制位，并且二进制同样只有<code>0</code>或<code>1</code>，那么我们完全可以使用1个二进制位来表示一个<code>BOOL</code>值。也就是说我们上面声明的四个<code>BOOL</code>值最终只使用4个二进制位就可以代替，这样就节省了内存空间。那我们如何实现呢？</p>
<p>想要实现四个<code>BOOL</code>值存放在一个字节中，我们可以通过<code>char</code>类型的成员变量来实现。</p>
<p><code>char</code>类型占一个字节内存空间，也就是8个二进制位.可以使用其中最后四个二进制位来存储4个<code>BOOL</code>值。 (当然不能把<code>char</code>类型写成属性,因为一旦写成属性,系统会自动帮我们添加成员变量,自动实现<code>set</code>和<code>get</code>方法)</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TCJCar</span>()</span>&#123;</span><br><span class="line">    <span class="keyword">char</span> _frontBackLeftRight;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果我们赋值<code>_frontBackLeftRight</code>为<code>1</code>,即<code>0b 0000 0001</code>,只使用8个二进制位中的最后4个分别用<code>0</code>或者<code>1</code>来代表<code>front</code>、<code>back</code>、<code>left</code>、<code>right</code>的值.那么此时<code>front</code>、<code>back</code>、<code>left</code>、<code>right</code>的状态为:<br><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007786920476.jpg"></p>
<p>结合我们上文讲的6种位运算符以及使用场景,我们可以分别声明<code>front</code>、<code>back</code>、<code>left</code>、<code>right</code>的掩码,来方便我们进行下一步的位运算取值和赋值:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TCJDirectionFrontMask 0b00001000 <span class="comment">//此二进制数对应十进制数为 8</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TCJDirectionBackMask  0b00000100 <span class="comment">//此二进制数对应十进制数为 4</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TCJDirectionLeftMask  0b00000010 <span class="comment">//此二进制数对应十进制数为 2</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TCJDirectionRightMask 0b00000001 <span class="comment">//此二进制数对应十进制数为 1</span></span></span><br></pre></td></tr></table></figure>

<p>通过对位运算符的左移<code>&lt;&lt;</code>和右移<code>&gt;&gt;</code>的了解，我们可以将上面的代码优化成：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TCJDirectionFrontMask    (1 &lt;&lt; 3)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TCJDirectionBackMask     (1 &lt;&lt; 2)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TCJDirectionLeftMask     (1 &lt;&lt; 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TCJDirectionRightMask    (1 &lt;&lt; 0)</span></span><br></pre></td></tr></table></figure>

<p>自定义的<code>set</code>方法如下:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setFront:(<span class="built_in">BOOL</span>)front</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (front) &#123;<span class="comment">// 如果需要将值置为1，将源码和掩码进行按位或运算</span></span><br><span class="line">        _frontBackLeftRight |= TCJDirectionFrontMask;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;<span class="comment">// 如果需要将值置为0 // 将源码和按位取反后的掩码进行按位与运算</span></span><br><span class="line">        _frontBackLeftRight &amp;= ~TCJDirectionFrontMask;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)setBack:(<span class="built_in">BOOL</span>)back</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (back) &#123;</span><br><span class="line">        _frontBackLeftRight |= TCJDirectionBackMask;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        _frontBackLeftRight &amp;= ~TCJDirectionBackMask;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)setLeft:(<span class="built_in">BOOL</span>)left</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (left) &#123;</span><br><span class="line">        _frontBackLeftRight |= TCJDirectionLeftMask;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        _frontBackLeftRight &amp;= ~TCJDirectionLeftMask;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)setRight:(<span class="built_in">BOOL</span>)right</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (right) &#123;</span><br><span class="line">        _frontBackLeftRight |= TCJDirectionRightMask;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        _frontBackLeftRight &amp;= ~TCJDirectionRightMask;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自定义的<code>get</code>方法如下:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)isFront</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> !!(_frontBackLeftRight &amp; TCJDirectionFrontMask);</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="built_in">BOOL</span>)isBack</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> !!(_frontBackLeftRight &amp; TCJDirectionBackMask);</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="built_in">BOOL</span>)isLeft</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> !!(_frontBackLeftRight &amp; TCJDirectionLeftMask);</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="built_in">BOOL</span>)isRight</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> !!(_frontBackLeftRight &amp; TCJDirectionRightMask);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此处需要注意的是，代码中!为逻辑运算符非，因为<code>_frontBackLeftRight &amp; TCJDirectionFrontMask</code>代码执行后，返回的肯定是一个整型数，如当<code>front</code>为<code>YES</code>时，说明二进制数为<code>0b 0000 1000</code>，对应的十进制数为8，那么进行一次逻辑非运算后，<code>!(8)</code>的值为<code>0</code>，对<code>0</code>再进行一次逻辑非运算<code>!(0)</code>，结果就成了<code>1</code>，那么正好跟<code>front</code>为<code>YES</code>对应.所以此处进行两次逻辑非运算，<code>!!</code>. 当然,还要实现初始化方法:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">instancetype</span>)init</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _frontBackLeftRight = <span class="number">0</span>b00001000;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过测试验证,我们完成了取值和赋值:<br><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007787059086.jpg"></p>
<h3 id="5-使用结构体位域优化代码"><a href="#5-使用结构体位域优化代码" class="headerlink" title="5.使用结构体位域优化代码"></a>5.使用结构体位域优化代码</h3><ul>
<li><p>我们在上文讲到了<code>位域</code>的概念,那么我们就可以使用<code>结构体位域</code>来优化一下我们的代码.这样就不用再额外声明上面代码中的掩码部分了.</p>
</li>
<li><p>位域声明格式是<code>位域名: 位域长度</code>. </p>
</li>
</ul>
<p>在使用<code>位域</code>的过程中需要注意以下几点:</p>
<ol>
<li>如果一个字节所剩空间不够存放另一位域时，应从下一单元起存放该位域.</li>
<li>位域的长度不能大于数据类型本身的长度，比如<code>int</code>类型就不能超过32位二进位.</li>
<li>位域可以无位域名，这时它只用来作填充或调整位置。无名的位域是不能使用的.</li>
</ol>
<p>使用位域优化后的代码:<br><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007787149201.jpg"></p>
<p><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007787237628.jpg"></p>
<p>来测试看一下是否正确,这次我们将<code>front</code>设为<code>YES</code>、<code>back</code>设为<code>NO</code>、<code>left</code>设为<code>NO</code>、<code>right</code>设为<code>YES</code>:<br><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007787333387.jpg"></p>
<p>依旧能完成赋值和取值. 但是代码这样优化后我们去掉了掩码和初始化的代码,可读性很差,我们继续使用联合体进行优化:</p>
<h3 id="6-使用联合体优化代码"><a href="#6-使用联合体优化代码" class="headerlink" title="6.使用联合体优化代码"></a>6.使用联合体优化代码</h3><p>我们可以使用比较高效的位运算来进行赋值和取值，使用<code>union</code>联合体来对数据进行存储。这样不仅可以增加读取效率，还可以增强代码可读性.</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&quot;TCJCar.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//#define TCJDirectionFrontMask 0b00001000 //此二进制数对应十进制数为 8</span></span><br><span class="line"><span class="comment">//#define TCJDirectionBackMask  0b00000100 //此二进制数对应十进制数为 4</span></span><br><span class="line"><span class="comment">//#define TCJDirectionLeftMask  0b00000010 //此二进制数对应十进制数为 2</span></span><br><span class="line"><span class="comment">//#define TCJDirectionRightMask 0b00000001 //此二进制数对应十进制数为 1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TCJDirectionFrontMask    (1 &lt;&lt; 3)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TCJDirectionBackMask     (1 &lt;&lt; 2)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TCJDirectionLeftMask     (1 &lt;&lt; 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TCJDirectionRightMask    (1 &lt;&lt; 0)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TCJCar</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">union</span>&#123;</span><br><span class="line">        <span class="keyword">char</span> bits;</span><br><span class="line">        <span class="comment">// 结构体仅仅是为了增强代码可读性</span></span><br><span class="line">        <span class="keyword">struct</span> &#123;</span><br><span class="line">            <span class="keyword">char</span> front  : <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">char</span> back   : <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">char</span> left   : <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">char</span> right  : <span class="number">1</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;_frontBackLeftRight;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TCJCar</span></span></span><br><span class="line">- (<span class="keyword">instancetype</span>)init</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        _frontBackLeftRight.bits = <span class="number">0</span>b00001000;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)setFront:(<span class="built_in">BOOL</span>)front</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (front) &#123;</span><br><span class="line">        _frontBackLeftRight.bits |= TCJDirectionFrontMask;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        _frontBackLeftRight.bits &amp;= ~TCJDirectionFrontMask;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="built_in">BOOL</span>)isFront</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> !!(_frontBackLeftRight.bits &amp; TCJDirectionFrontMask);</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)setBack:(<span class="built_in">BOOL</span>)back</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (back) &#123;</span><br><span class="line">        _frontBackLeftRight.bits |= TCJDirectionBackMask;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        _frontBackLeftRight.bits &amp;= ~TCJDirectionBackMask;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="built_in">BOOL</span>)isBack</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> !!(_frontBackLeftRight.bits &amp; TCJDirectionBackMask);</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)setLeft:(<span class="built_in">BOOL</span>)left</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (left) &#123;</span><br><span class="line">        _frontBackLeftRight.bits |= TCJDirectionLeftMask;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        _frontBackLeftRight.bits &amp;= ~TCJDirectionLeftMask;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="built_in">BOOL</span>)isLeft</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> !!(_frontBackLeftRight.bits &amp; TCJDirectionLeftMask);</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)setRight:(<span class="built_in">BOOL</span>)right</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (right) &#123;</span><br><span class="line">        _frontBackLeftRight.bits |= TCJDirectionRightMask;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        _frontBackLeftRight.bits &amp;= ~TCJDirectionRightMask;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="built_in">BOOL</span>)isRight</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> !!(_frontBackLeftRight.bits &amp; TCJDirectionRightMask);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>来我们测试看一下是否正确,这次我们依旧将<code>front</code>设为<code>YES</code>、<code>back</code>设为<code>NO</code>、<code>left</code>设为<code>NO</code>、<code>right</code>设为<code>YES</code>:<br><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007787631319.jpg"></p>
<ul>
<li><p>通过结果我们看到依旧能完成赋值和取值. </p>
</li>
<li><p>其中<code>_frontBackLeftRight</code>联合体只占用一个字节,因为结构体中<code>front</code>、<code>back</code>、<code>left</code>、<code>right</code>都只占一位二进制空间,所以结构体只占一个字节,而<code>char</code>类型的<code>bits</code>也只占一个字节.他们都在联合体中,因此共用一个字节的内存即可. </p>
</li>
<li><p>而且我们在<code>set</code>、<code>get</code>方法中的赋值和取值通过使用掩码进行位运算来增加效率，整体逻辑也就很清晰了。但是如果我们在日常开发中这样写代码的话，很可能会被同事打死。虽然代码已经很清晰了，但是整体阅读起来还是很吃力的。我们在这里学习了位运算以及联合体这些知识,更多的是为了方便我们阅读<code>OC</code>底层的代码。下面我们来回到本文主题，查看一下<code>isa_t</code>联合体的源码。</p>
</li>
</ul>
<h2 id="三、isa-t-联合体"><a href="#三、isa-t-联合体" class="headerlink" title="三、isa_t 联合体"></a>三、isa_t 联合体</h2><p><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007787726729.jpg"></p>
<ul>
<li><p>通过源码我们发现<code>isa</code>它是一个联合体,占8个字节,它的特性就是共用内存,或者说是<strong>互斥</strong>,比如说如果<code>cls</code>赋值了就不在对<code>bits</code>进行赋值.</p>
</li>
<li><p>在<code>isa_t</code>联合体内使用宏<code>ISA_BITFIELD</code>定义了位域,我们进入位域内查看源码:<br><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007787813345.jpg"></p>
</li>
</ul>
<ul>
<li>内部分别定义了<code>arm64</code>位架构和<code>x86_64</code>架构的掩码和位域.我们只分析<code>arm64</code>为架构下的部分内容(真机环境下). </li>
<li>可以清楚的看到<code>ISA_BITFIELD</code>位域的内容以及掩码<code>ISA_MASK</code>的值:<code>0x0000000ffffffff8ULL</code>.</li>
<li>我们重点看一下<code>uintptr_t shiftcls : 33;</code>,在<code>shiftcls</code>中存储着类对象和元类对象的内存地址信息,我们上文讲到,对象的<code>isa</code>指针需要同<code>ISA_MASK</code>经过一次按位与运算才能得出真正的类对象地址.那么我们将<code>ISA_MASK</code>的值<code>0x0000000ffffffff8ULL</code>转化为二进制数分析一下:<br><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007787933363.jpg"></li>
</ul>
<ul>
<li>从图中可以看到<code>ISA_MASK</code>的值转化为二进制中有33位都为1，上文讲到按位与运算是可以取出这33位中的值。那么就说明同<code>ISA_MASK</code>进行按位与运算就可以取出类对象和元类对象的内存地址信息. </li>
<li>我们继续分析一下结构体位域中其他的内容代表的含义:<br><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007788041889.jpg"></li>
</ul>
<ul>
<li>在不同的架构下面位域所占的内存大小不同，区别主要在于<code>shiftcls</code>(arm64 真机架构下占33位，x86 模拟器下占44位) 和 <code>extra_rc</code>(arm64 真机架构下占19位，x86 模拟器下占11位);；但是不管是什么架构下所占的整个大小都是64位 == 8字节。</li>
</ul>
<h3 id="本文重要总结"><a href="#本文重要总结" class="headerlink" title="本文重要总结"></a>本文重要总结</h3><ul>
<li><p><code>arm64</code>架构之后，<code>isa</code>指针不单单只存储了类对象和元类对象的内存地址，而是使用<strong>联合体</strong>的方式存储了更多信息。占8字节</p>
</li>
<li><p>其中<code>shiftcls</code>存储了类对象和元类对象的内存地址，需要同<code>ISA_MASK</code>进行<code>按位与 &amp;</code>运算才可以取出其内存地址值.</p>
</li>
</ul>
<h2 id="四、isa关联对象与类"><a href="#四、isa关联对象与类" class="headerlink" title="四、isa关联对象与类"></a>四、isa关联对象与类</h2><ul>
<li><p><code>isa</code>是对象的第一个属性，因为这一属性是来自于继承，要早于对象的成员变量、属性列表、方法列表、所遵循的协议列表.</p>
</li>
<li><p>问题：经过<code>calloc</code>申请内存的时候，isa这个指针是怎么和类进行关联的？</p>
</li>
<li><p>从这里开始定位：<code>obj-&gt;initInstanceIsa(cls, hasCxxDtor)</code>，然后找到<code>initIsa(cls, true, hasCxxDtor)</code>这个方法：</p>
</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="keyword">void</span> </span><br><span class="line">objc_object::initIsa(Class cls, <span class="keyword">bool</span> nonpointer, <span class="keyword">bool</span> hasCxxDtor) </span><br><span class="line">&#123; </span><br><span class="line">    assert(!isTaggedPointer()); </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!nonpointer) &#123;	<span class="comment">// 未优化过的指针,存储着`Class`、`Meta-Class`对象的内存地址信息</span></span><br><span class="line">        isa.cls = cls;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;		<span class="comment">// 优化过的指针，一般都走这里</span></span><br><span class="line">        assert(!DisableNonpointerIsa);</span><br><span class="line">        assert(!cls-&gt;instancesRequireRawIsa());</span><br><span class="line"></span><br><span class="line">        isa_t newisa(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> SUPPORT_INDEXED_ISA</span></span><br><span class="line">        assert(cls-&gt;classArrayIndex() &gt; <span class="number">0</span>);</span><br><span class="line">        newisa.bits = ISA_INDEX_MAGIC_VALUE;</span><br><span class="line">        <span class="comment">// isa.magic is part of ISA_MAGIC_VALUE</span></span><br><span class="line">        <span class="comment">// isa.nonpointer is part of ISA_MAGIC_VALUE</span></span><br><span class="line">        newisa.has_cxx_dtor = hasCxxDtor;</span><br><span class="line">        newisa.indexcls = (uintptr_t)cls-&gt;classArrayIndex();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        newisa.bits = ISA_MAGIC_VALUE;</span><br><span class="line">        <span class="comment">// isa.magic is part of ISA_MAGIC_VALUE</span></span><br><span class="line">        <span class="comment">// isa.nonpointer is part of ISA_MAGIC_VALUE</span></span><br><span class="line">        newisa.has_cxx_dtor = hasCxxDtor;</span><br><span class="line">        newisa.shiftcls = (uintptr_t)cls &gt;&gt; <span class="number">3</span>;	<span class="comment">// 在这里去存储`Class`、`Meta-Class`对象的内存地址信息</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// This write must be performed in a single store in some cases</span></span><br><span class="line">        <span class="comment">// (for example when realizing a class because other threads</span></span><br><span class="line">        <span class="comment">// may simultaneously try to use the class).</span></span><br><span class="line">        <span class="comment">// fixme use atomics here to guarantee single-store and to</span></span><br><span class="line">        <span class="comment">// guarantee memory order w.r.t. the class index table</span></span><br><span class="line">        <span class="comment">// ...but not too atomic because we don&#x27;t want to hurt instantiation</span></span><br><span class="line">        isa = newisa;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>上面第一层判断是<code>isTaggedPointer</code>的断言,这会在后续文章中重点分析</p>
</li>
<li><p>接下来是<code>nonpointer</code>的判断，因为<code>nonpointer</code>优化，它是和普通结构不一样的！通过上文我们知道内存优化的<code>isa_t</code>结构：它采用的是联合体和位域的搭配.(目前我们的类都是<code>nonpointer</code>了)</p>
<ol>
<li><p>如果是非<code>nonpointer</code>,代表普通的指针,存储着<code>Class</code>、<code>Meta-Class</code>对象的内存地址信息</p>
</li>
<li><p>如果是<code>nonpointer</code>,则会进行一系列的初始化操作。其中的<code>newisa.shiftcls = (uintptr_t)cls &gt;&gt; 3;</code>中的<code>shiftcls</code>存储着<code>Class</code>、<code>Meta-Class</code>对象的内存地址信息。验证:【可不看】<br><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007788204558.jpg"></p>
</li>
</ol>
</li>
</ul>
<p>  来我们来对上面<code>LLDB</code>相关的指令进行一波解析: </p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1.&#96;x&#x2F;4gx obj&#96;:代表打印&#96;obj&#96;的4段内存信息 </span><br><span class="line"></span><br><span class="line">2.&#96;p&#x2F;t&#96;:代表打印二进制信息(还有&#96;p&#x2F;o&#96;、&#96;p&#x2F;d&#96;、&#96;p&#x2F;x&#96;分别代表八进制、十进制和十六进制打印) </span><br><span class="line"></span><br><span class="line">3.&#96;p&#x2F;t (uintptr_t)obj.class&#96;将类信息进行二进制打印得到:&#96;$3&#96; </span><br><span class="line"></span><br><span class="line">4.对第一个属性&#96;isa&#96;进行二进制打印&#96;p&#x2F;t 0x001d8001000013f1&#96;得到:&#96;$1&#96; </span><br><span class="line"></span><br><span class="line">5.因为此时我们是在&#96;x86_64&#96;环境下进行打印的,通过上文我们知道在&#96;x86_64&#96;环境下&#96;isa&#96;的&#96;ISA_BITFIELD&#96;位域结构中:前&#96;3&#96;位是&#96;nonpointer&#96;，&#96;has_assoc&#96;，&#96;has_cxx_dtor&#96;，中间&#96;44&#96;位是&#96;shiftcls&#96;，后面&#96;17&#96;位是剩余的内容，同时因为&#96;iOS&#96;是小端模式，那么我们就需要去掉右边的&#96;3&#96;位和左边的&#96;17&#96;位，所以就会采用&#96;$1&gt;&gt;3&lt;&lt;3&#96;然后&#96;$4&lt;&lt;17&gt;&gt;17&#96;的操作了.</span><br></pre></td></tr></table></figure>

<ul>
<li>通过这个测试，我们就知道了<code>isa</code>实现了对象与类之间的关联.</li>
<li>在上文中我们提得到OC对象的<code>isa</code>指针并不是直接指向类对象或者元类对象的内存地址，而是需要<code>&amp; ISA_MASK</code>通过位运算才能获取类对象或者元类对象的地址。我们也来验证一波:<br><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007788309807.jpg"></li>
</ul>
<h2 id="五、对象和类对象"><a href="#五、对象和类对象" class="headerlink" title="五、对象和类对象"></a>五、对象和类对象</h2><ul>
<li>对象<ul>
<li>开辟内存创建的实例对象</li>
<li>开发者根据类实例化出的结果，<code>alloc</code>所开辟的内存空间</li>
<li>对象可以创建多个</li>
</ul>
</li>
<li>类对象<ul>
<li>一个类结构的对象</li>
<li>代码定义的类，系统创建的对象</li>
<li>内存只有一份</li>
</ul>
</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建两个对象，打印内存地址以及类地址</span></span><br><span class="line">MRObject *obj1 = [MRObject alloc];</span><br><span class="line">MRObject *obj2 = [MRObject alloc];</span><br><span class="line"></span><br><span class="line"><span class="comment">// lldb 调试打印</span></span><br><span class="line">(lldb) x/<span class="number">4</span>gx obj1 <span class="comment">// 打印obj1的内存段 0x001d800100001269 isa</span></span><br><span class="line"><span class="number">0x101a282c0</span>: <span class="number">0x001d800100001269</span> <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x101a282d0</span>: <span class="number">0x0000000080080000</span> <span class="number">0x00007fff916afa68</span></span><br><span class="line"></span><br><span class="line">(lldb) x/<span class="number">4</span>gx obj2 <span class="comment">// 打印obj2的内存段 0x001d800100001269 isa</span></span><br><span class="line"><span class="number">0x101a20500</span>: <span class="number">0x001d800100001269</span> <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x101a20510</span>: <span class="number">0x636f72504b575b2d</span> <span class="number">0x70756f7247737365</span></span><br><span class="line"><span class="comment">// 以上两个结果可以看出两个对象的地址不同，但是isa地址是相同的，而isa是关联类的 =&gt; object_getClass 中得出 isa &amp; mask =&gt; 类对象的地址</span></span><br><span class="line"></span><br><span class="line">(lldb) p/x MRObject.class   <span class="comment">// 打印MRObject类对象的地址 0x0000000100001268</span></span><br><span class="line">(Class) $<span class="number">4</span> = <span class="number">0x0000000100001268</span> MRObject</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过上面的isa &amp; mask(_x86_ = 0x00007ffffffffff8) 得到 0x0000000100001268 和类地址相同</span></span><br><span class="line">(lldb) p/x <span class="number">0x001d800100001269</span> &amp; <span class="number">0x00007ffffffffff8</span></span><br><span class="line">(<span class="keyword">long</span>) $<span class="number">5</span> = <span class="number">0x0000000100001268</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 类地址打印的结果即为MRObject类，所以类对象是只有一份的！</span></span><br><span class="line">(lldb) po <span class="number">0x0000000100001268</span></span><br><span class="line">MRObject</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="六、isa-走向、类继承"><a href="#六、isa-走向、类继承" class="headerlink" title="六、isa 走向、类继承"></a>六、isa 走向、类继承</h2><h3 id="6-1-类、元类、根源类"><a href="#6-1-类、元类、根源类" class="headerlink" title="6.1 类、元类、根源类"></a>6.1 类、元类、根源类</h3><ul>
<li>类 class<ul>
<li>代码构造的类，系统创建的对象</li>
</ul>
</li>
<li>元类 meta_class<ul>
<li>类的isa指向的虚拟类，系统创建的；在编译阶段，发现存在类对象，为了方便存储类方法信息等，创建的该类的元类对象</li>
</ul>
</li>
<li>根元类 root_meta_class<ul>
<li>NSObject 的元类，由于 NSObject 是所有类的根类</li>
</ul>
</li>
</ul>
<h3 id="6-2-isa-走向图"><a href="#6-2-isa-走向图" class="headerlink" title="6.2 isa 走向图"></a>6.2 isa 走向图</h3><p>苹果官方<code>isa</code>走位图👇👇<br><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/16007789472636.jpg"></p>
<h3 id="6-3-调试验证"><a href="#6-3-调试验证" class="headerlink" title="6.3 调试验证"></a>6.3 调试验证</h3><blockquote>
<p>MRObject 继承自 NSObject</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> testMRObject() &#123;</span><br><span class="line">    <span class="comment">// MRObject实例对象</span></span><br><span class="line">    <span class="built_in">NSObject</span> *object1 = [MRObject alloc];</span><br><span class="line">    <span class="comment">// MRObject类</span></span><br><span class="line">    Class <span class="keyword">class</span> = object_getClass(object1);</span><br><span class="line">    <span class="comment">// MRObject元类</span></span><br><span class="line">    Class metaClass = object_getClass(<span class="keyword">class</span>);</span><br><span class="line">    <span class="comment">// MRObject根元类</span></span><br><span class="line">    Class rootMetaClass = object_getClass(metaClass);</span><br><span class="line">    <span class="comment">// MRObject根根元类</span></span><br><span class="line">    Class rootRootMetaClass = object_getClass(rootMetaClass);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;MRObject isa -----------------\n%p 实例对象\n%p 类\n%p 元类\n%p 根元类\n%p 根根元类&quot;</span>,object1,<span class="keyword">class</span>,metaClass,rootMetaClass,rootRootMetaClass);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> testNSObject() &#123;</span><br><span class="line">    <span class="comment">// NSObject实例对象</span></span><br><span class="line">    <span class="built_in">NSObject</span> *object1 = [<span class="built_in">NSObject</span> alloc];</span><br><span class="line">    <span class="comment">// NSObject类</span></span><br><span class="line">    Class <span class="keyword">class</span> = object_getClass(object1);</span><br><span class="line">    <span class="comment">// NSObject元类</span></span><br><span class="line">    Class metaClass = object_getClass(<span class="keyword">class</span>);</span><br><span class="line">    <span class="comment">// NSObject根元类</span></span><br><span class="line">    Class rootMetaClass = object_getClass(metaClass);</span><br><span class="line">    <span class="comment">// NSObject根根元类</span></span><br><span class="line">    Class rootRootMetaClass = object_getClass(rootMetaClass);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;NSObject isa -----------------\n%p 实例对象\n%p 类\n%p 元类\n%p 根元类\n%p 根根元类&quot;</span>,object1,<span class="keyword">class</span>,metaClass,rootMetaClass,rootRootMetaClass);</span><br><span class="line">&#125;	</span><br></pre></td></tr></table></figure>

<p><strong>NSLog</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSObject</span> isa -----------------</span><br><span class="line"><span class="number">0x10183e7d0</span> 实例对象</span><br><span class="line"><span class="number">0x100b35140</span> 类</span><br><span class="line"><span class="number">0x100b350f0</span> 元类</span><br><span class="line"><span class="number">0x100b350f0</span> 根元类 [<span class="built_in">NSObject</span>的元类也是根元类]</span><br><span class="line"><span class="number">0x100b350f0</span> 根根元类 == 根元类的isa [说明根元类isa指向自己]</span><br><span class="line"></span><br><span class="line">MRObject isa -----------------</span><br><span class="line"><span class="number">0x10183e3b0</span> 实例对象</span><br><span class="line"><span class="number">0x100001298</span> 类</span><br><span class="line"><span class="number">0x100001270</span> 元类</span><br><span class="line"><span class="number">0x100b350f0</span> 根元类 == <span class="built_in">NSObject</span>元类 [说明根类是<span class="built_in">NSObject</span>]</span><br><span class="line"><span class="number">0x100b350f0</span> 根根元类</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="6-4-总结"><a href="#6-4-总结" class="headerlink" title="6.4 总结"></a>6.4 总结</h3><ul>
<li>继承<ul>
<li>子类  -&gt; 父类 -&gt; 根类(NSObject)</li>
<li>子元类  -&gt; 父元类 -&gt; 根元类(NSObject的元类)</li>
<li>!!!   根元类 -&gt; 根类 (NSObject) 形成闭环</li>
</ul>
</li>
<li>isa 指向<ul>
<li>实例对象 isa -&gt; 类对象(xxxClass) </li>
<li>类对象(xxxClass) isa -&gt; 元类对象(xxxmetaClass) </li>
<li>元类对象(xxxmetaClass) isa -&gt; 根元类对象(NSObject_meta_Class) </li>
<li>根元类对象(NSObject_meta_Class) isa -&gt; 根元类对象(他自己)(形成闭环)</li>
</ul>
</li>
</ul>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/10/20/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/02-%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90/"><span class="level-item">02 - 内存对齐</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" id="toc" style="max-height: 1400px;overflow: auto;"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#一、前言"><span class="level-left"><span class="level-item">一、前言</span></span></a></li><li><a class="level is-mobile" href="#二、联合体位域"><span class="level-left"><span class="level-item">二、联合体位域</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-位域"><span class="level-left"><span class="level-item">1.位域</span></span></a></li><li><a class="level is-mobile" href="#2-位运算符"><span class="level-left"><span class="level-item">2.位运算符</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-按位与-amp"><span class="level-left"><span class="level-item">1)按位与&amp;</span></span></a></li><li><a class="level is-mobile" href="#2-按位或"><span class="level-left"><span class="level-item">2)按位或 |</span></span></a></li><li><a class="level is-mobile" href="#3-按位异或"><span class="level-left"><span class="level-item">3)按位异或^</span></span></a></li><li><a class="level is-mobile" href="#4-非"><span class="level-left"><span class="level-item">4)非 ~</span></span></a></li><li><a class="level is-mobile" href="#5-左移-lt-lt"><span class="level-left"><span class="level-item">5)左移 &lt;&lt;</span></span></a></li><li><a class="level is-mobile" href="#6-右移-gt-gt"><span class="level-left"><span class="level-item">6)右移 &gt;&gt;</span></span></a></li></ul></li><li><a class="level is-mobile" href="#3-位运算符的运用"><span class="level-left"><span class="level-item">3.位运算符的运用</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-取值"><span class="level-left"><span class="level-item">1)取值</span></span></a></li><li><a class="level is-mobile" href="#2-设值"><span class="level-left"><span class="level-item">2)设值</span></span></a></li></ul></li><li><a class="level is-mobile" href="#4-位运算的实际应用"><span class="level-left"><span class="level-item">4.位运算的实际应用</span></span></a></li><li><a class="level is-mobile" href="#5-使用结构体位域优化代码"><span class="level-left"><span class="level-item">5.使用结构体位域优化代码</span></span></a></li><li><a class="level is-mobile" href="#6-使用联合体优化代码"><span class="level-left"><span class="level-item">6.使用联合体优化代码</span></span></a></li></ul></li><li><a class="level is-mobile" href="#三、isa-t-联合体"><span class="level-left"><span class="level-item">三、isa_t 联合体</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#本文重要总结"><span class="level-left"><span class="level-item">本文重要总结</span></span></a></li></ul></li><li><a class="level is-mobile" href="#四、isa关联对象与类"><span class="level-left"><span class="level-item">四、isa关联对象与类</span></span></a></li><li><a class="level is-mobile" href="#五、对象和类对象"><span class="level-left"><span class="level-item">五、对象和类对象</span></span></a></li><li><a class="level is-mobile" href="#六、isa-走向、类继承"><span class="level-left"><span class="level-item">六、isa 走向、类继承</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#6-1-类、元类、根源类"><span class="level-left"><span class="level-item">6.1 类、元类、根源类</span></span></a></li><li><a class="level is-mobile" href="#6-2-isa-走向图"><span class="level-left"><span class="level-item">6.2 isa 走向图</span></span></a></li><li><a class="level is-mobile" href="#6-3-调试验证"><span class="level-left"><span class="level-item">6.3 调试验证</span></span></a></li><li><a class="level is-mobile" href="#6-4-总结"><span class="level-left"><span class="level-item">6.4 总结</span></span></a></li></ul></li><li><a class="level is-mobile" href="#"><span class="level-left"><span class="level-item"> </span></span></a></li></ul></div></div><style>.menu-list > li > a.is-active + .menu-list { display: block; }.menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/imglogo.png" alt="IMO&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2020 IMO</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/speam"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>