<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>03-对象&amp;类的结构 - IMO&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="IMO&#039;s Blog"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/avatar4.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="IMO&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description=""><meta property="og:type" content="blog"><meta property="og:title" content="03-对象&amp;类的结构"><meta property="og:url" content="http://evilimo.com/2020/11/18/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/03-%E5%AF%B9%E8%B1%A1&amp;%E7%B1%BB%E7%9A%84%E7%BB%93%E6%9E%84/"><meta property="og:site_name" content="IMO&#039;s Blog"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20201203141624802.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20201203153659376.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20201203153716457.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20201203153722050.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20201203153739037.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20201203153750735.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20201203153801318.png"><meta property="article:published_time" content="2020-11-18T01:53:55.000Z"><meta property="article:modified_time" content="2020-12-29T08:37:47.755Z"><meta property="article:author" content="IMO"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20201203141624802.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://evilimo.com/2020/11/18/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/03-%E5%AF%B9%E8%B1%A1&%E7%B1%BB%E7%9A%84%E7%BB%93%E6%9E%84/"},"headline":"IMO's Blog","image":["https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20201203141624802.png","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20201203153659376.png","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20201203153716457.png","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20201203153722050.png","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20201203153739037.png","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20201203153750735.png","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20201203153801318.png"],"datePublished":"2020-11-18T01:53:55.000Z","dateModified":"2020-12-29T08:37:47.755Z","author":{"@type":"Person","name":"IMO"},"description":""}</script><link rel="canonical" href="http://evilimo.com/2020/11/18/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/03-%E5%AF%B9%E8%B1%A1&amp;%E7%B1%BB%E7%9A%84%E7%BB%93%E6%9E%84/"><link rel="icon" href="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/avatar4.png"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.4.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><!--!--><meta name="generator" content="Hexo 5.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/imglogo.png" alt="IMO&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-11-18T01:53:55.000Z" title="2020-11-18T01:53:55.000Z">2020-11-18</time>发表</span><span class="level-item"><time dateTime="2020-12-29T08:37:47.755Z" title="2020-12-29T08:37:47.755Z">2020-12-29</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/">iOS·底层原理</a></span></div></div><h1 class="title is-3 is-size-4-mobile">03-对象&amp;类的结构</h1><div class="content"><hr>
<a id="more"></a>

<h2 id="一、对象-amp-类的结构"><a href="#一、对象-amp-类的结构" class="headerlink" title="一、对象&amp;类的结构"></a>一、对象&amp;类的结构</h2><h3 id="1-1-解读类的本质"><a href="#1-1-解读类的本质" class="headerlink" title="1.1 解读类的本质"></a>1.1 解读类的本质</h3><p>从<code>NSObject</code>类的定义开始</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">OBJC_AVAILABLE(<span class="number">10.0</span>, <span class="number">2.0</span>, <span class="number">9.0</span>, <span class="number">1.0</span>, <span class="number">2.0</span>)</span><br><span class="line">OBJC_ROOT_CLASS</span><br><span class="line">OBJC_EXPORT</span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> &lt;<span class="title">NSObject</span>&gt; </span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> clang diagnostic push</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> clang diagnostic ignored <span class="meta-string">&quot;-Wobjc-interface-ivars&quot;</span></span></span><br><span class="line">    Class isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> clang diagnostic pop</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：<code>NSObject</code>有个<code>Class</code>类型的<code>isa</code>成员变量</strong></p>
<p>接下来用<code>Clang</code>编译<code>main.m</code>，输出<code>.cpp</code>文件，看一下<code>NSObject</code>类的底层定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -x objective-c -rewrite-objc -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk main.m</span><br></pre></td></tr></table></figure>



<p>打开<code>main.cpp</code>文件，找到了<code>NSObject</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _REWRITER_typedef_NSObject</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _REWRITER_typedef_NSObject</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span> <span class="title">NSObject</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span>&#125; _objc_exc_NSObject;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">NSObject_IMPL</span> &#123;</span></span><br><span class="line">	Class isa;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>发现<code>NSObject</code>类本质上是<code>objc_object</code>结构体，同时有定义一个<code>NSObject_IMPL</code>结构体（<code>IMPL</code>是<code>implementation</code>的缩写），里面有<code>NSObject类</code>的<code>isa</code>成员变量（对应于<code>OC</code>时的<code>NSObject</code>类定义中的<code>isa</code>成员变量）。</p>
<p>现在把我们自己定义的Person类用clang编译成c++看一下。我们定义的Person类：(有个<code>age</code>属性和<code>run</code>方法)</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">NSInteger</span> age;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)run;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)run &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;I am running.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>编译成c++后：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _REWRITER_typedef_Person</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _REWRITER_typedef_Person</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span> <span class="title">Person</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span>&#125; _objc_exc_Person;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> OBJC_IVAR_$_Person$_age;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Person_IMPL</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">NSObject_IMPL</span> <span class="title">NSObject_IVARS</span>;</span></span><br><span class="line">	NSInteger _age;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> _I_Person_run(Person * self, SEL _cmd) &#123;</span><br><span class="line">    NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_mc_9fhhprrj4k92vxzqm3g127z40000gn_T_main_09fc70_mi_0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> NSInteger _I_Person_age(Person * self, SEL _cmd) &#123; <span class="keyword">return</span> (*(NSInteger *)((<span class="keyword">char</span> *)self + OBJC_IVAR_$_Person$_age)); &#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> _I_Person_setAge_(Person * self, SEL _cmd, NSInteger age) &#123; (*(NSInteger *)((<span class="keyword">char</span> *)self + OBJC_IVAR_$_Person$_age)) = age; &#125;</span><br></pre></td></tr></table></figure>

<p>可见，<code>Person</code>类本质同样是<code>objc_object</code>结构体类型，<code>Person_IMPL</code>结构体内部多了个<code>struct NSObject_IMPL</code>类型的<code>NSObject_IVARS</code>成员变量——即继承自<code>NSObject</code>的类，都有个<code>Class</code>类型的<code>isa</code>成员变量。</p>
<h3 id="1-2-objc-object结构"><a href="#1-2-objc-object结构" class="headerlink" title="1.2 objc_object结构"></a>1.2 <code>objc_object</code>结构</h3><p>源码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> objc_object &#123;</span><br><span class="line">private:</span><br><span class="line">    isa_t isa;</span><br><span class="line">    </span><br><span class="line">public:</span><br><span class="line">    ... <span class="comment">// 一些函数</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">union</span> isa_t &#123;</span><br><span class="line">    isa_t() &#123; &#125;</span><br><span class="line">    isa_t(uintptr_t value) : bits(value) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    Class cls;</span><br><span class="line">    uintptr_t bits;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ISA_BITFIELD)</span></span><br><span class="line">    <span class="keyword">struct</span> &#123;</span><br><span class="line">        ISA_BITFIELD;  <span class="comment">// defined in isa.h</span></span><br><span class="line">    &#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>关于<code>isa_t</code>的分析见上篇文章</p>
</li>
<li><p><code>objc_object</code>结构体内部的方法有五十个左右，大致可分为以下几类</p>
<ul>
<li>一些关于<code>isa</code>的函数，如<code>initIsa()</code>、<code>getIsa()</code>、<code>changeIsa()</code>等</li>
<li>一些弱引用的函数，如<code>isWeaklyReferenced()</code>、<code>setWeaklyReferenced_nolock()</code>等</li>
</ul>
</li>
<li><p>一些内存管理函数，如<code>retain()</code>、<code>release()</code>、<code>autorelease()</code>等</p>
<ul>
<li>两个关联对象函数，分别是<code>hasAssociatedObjects()</code>和<code>setHasAssociatedObjects</code></li>
</ul>
</li>
</ul>
<h3 id="1-3-objc-class结构"><a href="#1-3-objc-class结构" class="headerlink" title="1.3 objc_class结构"></a>1.3 <code>objc_class</code>结构</h3><p>同样先上源码</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_class *Class;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> objc_object *<span class="keyword">id</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> objc_class : objc_object &#123;</span><br><span class="line">    <span class="comment">// Class ISA;</span></span><br><span class="line">    Class superclass;</span><br><span class="line">    cache_t cache;             <span class="comment">// formerly cache pointer and vtable</span></span><br><span class="line">    class_data_bits_t bits;    <span class="comment">// class_rw_t * plus custom rr/alloc flags</span></span><br><span class="line">		</span><br><span class="line">  	class_rw_t *data() &#123; </span><br><span class="line">        <span class="keyword">return</span> bits.data();</span><br><span class="line">    &#125;</span><br><span class="line">    ... <span class="comment">// 一些函数</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>从源码可以看出，<code>Class</code>是<code>objc_class</code>结构体类型的指针变量，继承自<code>objc_object</code>结构体。也就是说，<code>Class</code>有4个成员变量，且它们在内存存储上是有序的，依次分别是：</p>
<p>1.<code>isa</code>：类型是<code>isa_t</code>，<code>64位</code>下长度为8字节，上篇已做过分析，这里略过</p>
<p>2.<code>superclass</code>：类型是<code>Class</code>，表示继承关系，指向当前类的父类，同样8字节</p>
<p>3.<code>cache</code>：类型是<code>cache_t</code>，表示缓存，用于缓存已调用的方法，加速方法的调用。其具体结构如下:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> cache_t &#123;</span><br><span class="line">    <span class="keyword">struct</span> bucket_t *_buckets;  <span class="comment">// 64位下是8字节</span></span><br><span class="line">    mask_t _mask;               <span class="comment">// 64位下是4字节</span></span><br><span class="line">    mask_t _occupied;           <span class="comment">// 64位下是4字节</span></span><br><span class="line"></span><br><span class="line">public:</span><br><span class="line">    ... <span class="comment">// 一些函数</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __LP64__</span></span><br><span class="line"><span class="keyword">typedef</span> uint32_t mask_t;   <span class="comment">// uint32_t    4字节  // x86_64 &amp; arm64 asm are less efficient with 16-bits</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="keyword">typedef</span> uint16_t mask_t;	 <span class="comment">// uint16_t    2字节</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> uint32_t;</span><br></pre></td></tr></table></figure>

<p>可见，<code>cache</code>这个成员变量长度是16字节。</p>
<blockquote>
<p><code>cache</code>比较重要，关于它的分析可戳 <a target="_blank" rel="noopener" href="https://juejin.im/post/6844904070596001806">OC源码分析之方法的缓存原理</a>。</p>
</blockquote>
<p>4.<code>bits</code>：类型是<code>class_data_bits_t</code>，用于存储类的数据（类的方法、属性、遵循的协议等信息），其结构如下</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> class_data_bits_t &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Values are the FAST_ flags above.</span></span><br><span class="line">    uintptr_t bits;     <span class="comment">// unsigned long</span></span><br><span class="line"></span><br><span class="line">private:</span><br><span class="line">    ... <span class="comment">// 一些函数</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其长度也是8字节。根据<code>bits</code>成员变量在<code>objc_object</code>结构体中的描述，它实质上是<code>class_rw_t *</code>加上自定义<code>rr/alloc</code>标志，最重要的是<code>class_rw_t</code>。</p>
<p>接下来将重点介绍它。</p>
<h2 id="二、class-rw-t-amp-class-ro-t分析"><a href="#二、class-rw-t-amp-class-ro-t分析" class="headerlink" title="二、class_rw_t &amp; class_ro_t分析"></a>二、<code>class_rw_t</code> &amp; <code>class_ro_t</code>分析</h2><blockquote>
<p><code>rw</code>是<code>readwrite</code>的意思，而<code>ro</code>则是<code>readonly</code>。</p>
</blockquote>
<p><strong><code>OC</code>类中的属性、方法还有遵循的协议等信息都保存在<code>class_rw_t</code>中</strong>，首先看看<code>class_rw_t</code>的结构：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> class_rw_t &#123;</span><br><span class="line">    uint32_t flags;</span><br><span class="line">    uint32_t version;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> class_ro_t *ro;</span><br><span class="line">    </span><br><span class="line">    method_array_t methods;         <span class="comment">// 方法列表</span></span><br><span class="line">    property_array_t properties;    <span class="comment">// 属性列表</span></span><br><span class="line">    protocol_array_t protocols;     <span class="comment">// 协议列表</span></span><br><span class="line"></span><br><span class="line">    Class firstSubclass;</span><br><span class="line">    Class nextSiblingClass;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *demangledName;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> SUPPORT_INDEXED_ISA</span></span><br><span class="line">    uint32_t index;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    ...<span class="comment">// 一些函数</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __ARM_ARCH_7K__ &gt;= 2  ||  (__arm64__ &amp;&amp; !__LP64__)</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> SUPPORT_INDEXED_ISA 1    <span class="comment">// armv7k or arm64_32</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> SUPPORT_INDEXED_ISA 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>发现<code>class_rw_t</code>中还有一个被<code>const</code>修饰的指针变量 <code>ro</code>，是<code>class_ro_t</code>结构体指针，其中存储了<strong>当前类在编译期确定的方法、成员变量、属性以及遵循的协议等信息</strong>。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> class_ro_t &#123;</span><br><span class="line">    uint32_t flags;</span><br><span class="line">    uint32_t instanceStart;</span><br><span class="line">    uint32_t instanceSize;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __LP64__</span></span><br><span class="line">    uint32_t reserved;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> uint8_t * ivarLayout;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> * name;</span><br><span class="line">    method_list_t * baseMethodList;     <span class="comment">// 方法列表</span></span><br><span class="line">    protocol_list_t * baseProtocols;    <span class="comment">// 协议列表</span></span><br><span class="line">    <span class="keyword">const</span> ivar_list_t * ivars;          <span class="comment">// 成员变量列表</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> uint8_t * weakIvarLayout;</span><br><span class="line">    property_list_t *baseProperties;    <span class="comment">// 属性列表</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// This field exists only when RO_HAS_SWIFT_INITIALIZER is set.</span></span><br><span class="line">    _objc_swiftMetadataInitializer __ptrauth_objc_method_list_imp _swiftMetadataInitializer_NEVER_USE[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    ... <span class="comment">// 一些函数</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h3 id="2-1-获取class-rw-t"><a href="#2-1-获取class-rw-t" class="headerlink" title="2.1 获取class_rw_t"></a>2.1 获取<code>class_rw_t</code></h3><p>要想获取<code>class_rw_t</code>指针地址，需要知道<code>objc_class</code>的<code>bits</code>指针地址，通过对<code>objc_class</code>的结构分析得知，<code>bits</code>指针地址是<code>objc_class</code>首地址偏移32个字节（<code>isa</code> + <code>superclass</code> + <code>cache</code> = 8+8+16=32字节）</p>
<p>也可以从源码得知如何拿到<code>class_rw_t</code>指针</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// objc_class结构体中</span></span><br><span class="line">class_rw_t *data() &#123; </span><br><span class="line">    <span class="keyword">return</span> bits.data();     <span class="comment">// bits是class_data_bits_t类型</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// class_data_bits_t结构体中</span></span><br><span class="line">...</span><br><span class="line">class_rw_t* data() &#123;</span><br><span class="line">    <span class="keyword">return</span> (class_rw_t *)(bits &amp; FAST_DATA_MASK);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 64位下</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FAST_DATA_MASK          0x00007ffffffffff8UL</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>在<code>64位下</code>，<code>class_rw_t</code>指针地址是在[3, 46]数据段，所以也可以用<code>bits &amp; FAST_DATA_MASK</code>计算出<code>class_rw_t</code>指针地址。</p>
</blockquote>
<p>接着通过一个例子来验证<code>class_rw_t</code>和<code>class_ro_t</code>是否存储了类的信息</p>
<h3 id="2-2-准备工作"><a href="#2-2-准备工作" class="headerlink" title="2.2 准备工作"></a>2.2 准备工作</h3><p>给<code>Person</code>类添加<strong>属性、方法和协议</strong>，代码如下</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">PersonProtocol</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)walk;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span> &lt;<span class="title">PersonProtocol</span>&gt; </span>&#123;</span><br><span class="line">    <span class="built_in">NSInteger</span> _gender;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">NSInteger</span> age;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)printMyClassName;</span><br><span class="line">- (<span class="keyword">void</span>)run;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)printMyClassName &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;my class name is Person&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)run &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;I am running.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)walk &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;I am walking.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>然后打上断点</p>
<p><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20201203141624802.png" alt="img"></p>
<p>好了，准备工作完成，下面开始验证</p>
<h3 id="2-3-class-rw-t验证过程"><a href="#2-3-class-rw-t验证过程" class="headerlink" title="2.3 class_rw_t验证过程"></a>2.3 <code>class_rw_t</code>验证过程</h3><p>1.打印<code>Person</code>类</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(lldb) x/<span class="number">5</span>gx pcls</span><br><span class="line"><span class="number">0x100002820</span>: <span class="number">0x001d8001000027f9</span> <span class="number">0x0000000100b39140</span></span><br><span class="line"><span class="number">0x100002830</span>: <span class="number">0x00000001003dc250</span> <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x100002840</span>: <span class="number">0x0000000102237404</span></span><br></pre></td></tr></table></figure>

<p>说明：</p>
<blockquote>
<ul>
<li><code>Person</code>类首地址是<code>0x100002820</code>，因此，<code>0x100002840</code>是其<code>bits</code>地址（32字节就是<code>0x20</code>，<code>0x100002840</code> = <code>0x100002820</code> + <code>0x20</code>），<code>bits</code>内容是<code>0x0000000102237404</code></li>
<li><code>0x001d8001000027f9</code>是<code>Person</code>类的<code>isa</code>地址，指向<code>Person元类</code></li>
<li><code>0x0000000100b39140</code>是<code>Person</code>类的<code>superclass</code>地址，也就是<code>NSObject</code>类首地址</li>
<li><code>0x00000001003dc250 0x0000000000000000</code>则是<code>Person</code>类的<code>cache</code>段</li>
</ul>
</blockquote>
<p>2.打印<code>class_rw_t</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bits &amp; FAST_DATA_MASK</span></span><br><span class="line">(lldb) p (<span class="keyword">class_rw_t</span> *)(<span class="number">0x0000000102237404</span> &amp; <span class="number">0x00007ffffffffff8</span>)</span><br><span class="line">(<span class="keyword">class_rw_t</span> *) $<span class="number">1</span> = <span class="number">0x0000000102237400</span></span><br><span class="line"></span><br><span class="line">(lldb) p *$<span class="number">1</span></span><br><span class="line">(<span class="keyword">class_rw_t</span>) $<span class="number">2</span> = &#123;</span><br><span class="line">  flags = <span class="number">2148139008</span></span><br><span class="line">  version = <span class="number">0</span></span><br><span class="line">  ro = <span class="number">0x0000000100002788</span></span><br><span class="line">  methods = &#123;</span><br><span class="line">    list_array_tt&lt;<span class="keyword">method_t</span>, <span class="keyword">method_list_t</span>&gt; = &#123;</span><br><span class="line">       = &#123;</span><br><span class="line">        <span class="built_in">list</span> = <span class="number">0x0000000100002608</span></span><br><span class="line">        arrayAndFlag = <span class="number">4294977032</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  properties = &#123;</span><br><span class="line">    list_array_tt&lt;<span class="keyword">property_t</span>, <span class="keyword">property_list_t</span>&gt; = &#123;</span><br><span class="line">       = &#123;</span><br><span class="line">        <span class="built_in">list</span> = <span class="number">0x0000000100002720</span></span><br><span class="line">        arrayAndFlag = <span class="number">4294977312</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  protocols = &#123;</span><br><span class="line">    list_array_tt&lt;<span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">protocol_list_t</span>&gt; = &#123;</span><br><span class="line">       = &#123;</span><br><span class="line">        <span class="built_in">list</span> = <span class="number">0x00000001000025a8</span></span><br><span class="line">        arrayAndFlag = <span class="number">4294976936</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  firstSubclass = nil</span><br><span class="line">  nextSiblingClass = NSUUID</span><br><span class="line">  demangledName = <span class="number">0x0000000000000000</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里请大家留意一下<code>class_rw_t</code>的几个关键成员变量：</p>
<blockquote>
<ul>
<li><code>ro</code>地址是<code>0x0000000100002788</code></li>
<li><code>methods</code>的<code>list</code>地址是<code>0x0000000100002608</code></li>
<li><code>properties</code>的<code>list</code>地址是<code>0x0000000100002720</code></li>
<li><code>protocols</code>的<code>list</code>地址是<code>0x0000000100002608</code></li>
</ul>
</blockquote>
<p>3.验证<code>methods</code></p>
<p>目前来看，<code>Person</code>类至少有6个实例方法，分别是<code>run</code>、<code>walk</code>以及<code>name</code>和<code>age</code>的<code>getter</code>、<code>setter</code>，还有1个类方法，即<code>printMyClassName</code>，总计7个方法。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p (<span class="keyword">method_list_t</span> *)<span class="number">0x0000000100002608</span>    <span class="comment">// rw的methods的list地址</span></span><br><span class="line">(<span class="keyword">method_list_t</span> *) $<span class="number">7</span> = <span class="number">0x0000000100002608</span></span><br><span class="line"></span><br><span class="line">(lldb) p *$<span class="number">7</span></span><br><span class="line">(<span class="keyword">method_list_t</span>) $<span class="number">8</span> = &#123;</span><br><span class="line">  entsize_list_tt&lt;<span class="keyword">method_t</span>, <span class="keyword">method_list_t</span>, <span class="number">3</span>&gt; = &#123;</span><br><span class="line">    entsizeAndFlags = <span class="number">26</span></span><br><span class="line">    count = <span class="number">7</span></span><br><span class="line">    first = &#123;</span><br><span class="line">      name = <span class="string">&quot;walk&quot;</span></span><br><span class="line">      types = <span class="number">0x0000000100001e96</span> <span class="string">&quot;v16@0:8&quot;</span></span><br><span class="line">      imp = <span class="number">0x0000000100001530</span> (CCTest`-[Person walk] at main.m:<span class="number">45</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正好是7个方法，让我们看看都是哪些（由于<code>method_list_t</code>继承自<code>entsize_list_tt</code>，可以通过<code>entsize_list_tt</code>的<code>get()</code>函数一一打印）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p $<span class="number">8.</span>get(<span class="number">0</span>)</span><br><span class="line">(<span class="keyword">method_t</span>) $<span class="number">9</span> = &#123;</span><br><span class="line">  name = <span class="string">&quot;walk&quot;</span></span><br><span class="line">  types = <span class="number">0x0000000100001e96</span> <span class="string">&quot;v16@0:8&quot;</span></span><br><span class="line">  imp = <span class="number">0x0000000100001530</span> (CCTest`-[Person walk] at main.m:<span class="number">45</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(lldb) p $<span class="number">8.</span>get(<span class="number">1</span>)</span><br><span class="line">(<span class="keyword">method_t</span>) $<span class="number">10</span> = &#123;</span><br><span class="line">  name = <span class="string">&quot;.cxx_destruct&quot;</span></span><br><span class="line">  types = <span class="number">0x0000000100001e96</span> <span class="string">&quot;v16@0:8&quot;</span></span><br><span class="line">  imp = <span class="number">0x0000000100001600</span> (CCTest`-[Person .cxx_destruct] at main.m:<span class="number">35</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(lldb) p $<span class="number">8.</span>get(<span class="number">2</span>)</span><br><span class="line">(<span class="keyword">method_t</span>) $<span class="number">11</span> = &#123;</span><br><span class="line">  name = <span class="string">&quot;name&quot;</span></span><br><span class="line">  types = <span class="number">0x0000000100001eb1</span> <span class="string">&quot;@16@0:8&quot;</span></span><br><span class="line">  imp = <span class="number">0x0000000100001560</span> (CCTest`-[Person name] at main.m:<span class="number">27</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(lldb) p $<span class="number">8.</span>get(<span class="number">3</span>)</span><br><span class="line">(<span class="keyword">method_t</span>) $<span class="number">12</span> = &#123;</span><br><span class="line">  name = <span class="string">&quot;setName:&quot;</span></span><br><span class="line">  types = <span class="number">0x0000000100001f4b</span> <span class="string">&quot;v24@0:8@16&quot;</span></span><br><span class="line">  imp = <span class="number">0x0000000100001580</span> (CCTest`-[Person setName:] at main.m:<span class="number">27</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(lldb) p $<span class="number">8.</span>get(<span class="number">4</span>)</span><br><span class="line">(<span class="keyword">method_t</span>) $<span class="number">13</span> = &#123;</span><br><span class="line">  name = <span class="string">&quot;age&quot;</span></span><br><span class="line">  types = <span class="number">0x0000000100001f56</span> <span class="string">&quot;q16@0:8&quot;</span></span><br><span class="line">  imp = <span class="number">0x00000001000015c0</span> (CCTest`-[Person age] at main.m:<span class="number">28</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(lldb) p $<span class="number">8.</span>get(<span class="number">5</span>)</span><br><span class="line">(<span class="keyword">method_t</span>) $<span class="number">14</span> = &#123;</span><br><span class="line">  name = <span class="string">&quot;run&quot;</span></span><br><span class="line">  types = <span class="number">0x0000000100001e96</span> <span class="string">&quot;v16@0:8&quot;</span></span><br><span class="line">  imp = <span class="number">0x0000000100001500</span> (CCTest`-[Person run] at main.m:<span class="number">41</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(lldb) p $<span class="number">8.</span>get(<span class="number">6</span>)</span><br><span class="line">(<span class="keyword">method_t</span>) $<span class="number">15</span> = &#123;</span><br><span class="line">  name = <span class="string">&quot;setAge:&quot;</span></span><br><span class="line">  types = <span class="number">0x0000000100001f5e</span> <span class="string">&quot;v24@0:8q16&quot;</span></span><br><span class="line">  imp = <span class="number">0x00000001000015e0</span> (CCTest`-[Person setAge:] at main.m:<span class="number">28</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>显然，<code>class_rw_t</code>的<code>methods</code>确实包含了<code>Person</code>类的全部实例方法，只是多了个<code>.cxx_destruct</code>方法。<code>.cxx_destruct</code>方法原本是为了<code>C++</code>对象析构的，<code>ARC</code>借用了这个方法插入代码实现了自动内存释放的工作，关于其原理这里略过不提。</p>
<blockquote>
<p>思考：类方法<code>printMyClassName</code>哪里去了？</p>
</blockquote>
<p>4.验证<code>properties</code></p>
<p>同理，<code>Person</code>类至少有<code>name</code>和<code>age</code>这两个属性，且看</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p (<span class="keyword">property_list_t</span> *)<span class="number">0x0000000100002720</span>  <span class="comment">// rw的properties的list地址</span></span><br><span class="line">(<span class="keyword">property_list_t</span> *) $<span class="number">18</span> = <span class="number">0x0000000100002720</span></span><br><span class="line"></span><br><span class="line">(lldb) p *$<span class="number">18</span></span><br><span class="line">(<span class="keyword">property_list_t</span>) $<span class="number">19</span> = &#123;</span><br><span class="line">  entsize_list_tt&lt;<span class="keyword">property_t</span>, <span class="keyword">property_list_t</span>, <span class="number">0</span>&gt; = &#123;</span><br><span class="line">    entsizeAndFlags = <span class="number">16</span></span><br><span class="line">    count = <span class="number">6</span></span><br><span class="line">    first = (name = <span class="string">&quot;name&quot;</span>, attributes = <span class="string">&quot;T@\&quot;NSString\&quot;,&amp;,N,V_name&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(lldb) p $<span class="number">19.</span>get(<span class="number">0</span>)</span><br><span class="line">(<span class="keyword">property_t</span>) $<span class="number">20</span> = (name = <span class="string">&quot;name&quot;</span>, attributes = <span class="string">&quot;T@\&quot;NSString\&quot;,&amp;,N,V_name&quot;</span>)</span><br><span class="line">  </span><br><span class="line">(lldb) p $<span class="number">19.</span>get(<span class="number">1</span>)</span><br><span class="line">(<span class="keyword">property_t</span>) $<span class="number">21</span> = (name = <span class="string">&quot;age&quot;</span>, attributes = <span class="string">&quot;Tq,N,V_age&quot;</span>)</span><br><span class="line">  </span><br><span class="line">(lldb) p $<span class="number">19.</span>get(<span class="number">2</span>)</span><br><span class="line">(<span class="keyword">property_t</span>) $<span class="number">22</span> = (name = <span class="string">&quot;hash&quot;</span>, attributes = <span class="string">&quot;TQ,R&quot;</span>)</span><br><span class="line">  </span><br><span class="line">(lldb) p $<span class="number">19.</span>get(<span class="number">3</span>)</span><br><span class="line">(<span class="keyword">property_t</span>) $<span class="number">23</span> = (name = <span class="string">&quot;superclass&quot;</span>, attributes = <span class="string">&quot;T#,R&quot;</span>)</span><br><span class="line">  </span><br><span class="line">(lldb) p $<span class="number">19.</span>get(<span class="number">4</span>)</span><br><span class="line">(<span class="keyword">property_t</span>) $<span class="number">24</span> = (name = <span class="string">&quot;description&quot;</span>, attributes = <span class="string">&quot;T@\&quot;NSString\&quot;,R,C&quot;</span>)</span><br><span class="line">  </span><br><span class="line">(lldb) p $<span class="number">19.</span>get(<span class="number">5</span>)</span><br><span class="line">(<span class="keyword">property_t</span>) $<span class="number">25</span> = (name = <span class="string">&quot;debugDescription&quot;</span>, attributes = <span class="string">&quot;T@\&quot;NSString\&quot;,R,C&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>显然<code>name</code>和<code>age</code>存储在<code>properties</code>中。</p>
<blockquote>
<p>多余的<code>属性</code>也不作赘述。</p>
</blockquote>
<p>5.验证<code>protocols</code></p>
<p>在验证之前，先分析一下<code>protocol_list_t</code>，这个结构体并不是继承自<code>entsize_list_tt</code>的，其结构如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">protocol_list_t</span> &#123;</span></span><br><span class="line">    <span class="comment">// count is 64-bit by accident. </span></span><br><span class="line">    <span class="keyword">uintptr_t</span> count;</span><br><span class="line">    <span class="keyword">protocol_ref_t</span> <span class="built_in">list</span>[<span class="number">0</span>]; <span class="comment">// variable-size</span></span><br><span class="line"></span><br><span class="line">    ... <span class="comment">// 一些函数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意到<code>variable-size</code>这个注释部分（可变大小），仿佛看到了希望</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">uintptr_t</span> <span class="keyword">protocol_ref_t</span>;  <span class="comment">// protocol_t *, but unremapped</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">protocol_t</span> :</span> objc_object &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *mangledName;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">protocol_list_t</span> *<span class="title">protocols</span>;</span></span><br><span class="line">    <span class="keyword">method_list_t</span> *instanceMethods;</span><br><span class="line">    <span class="keyword">method_list_t</span> *classMethods;</span><br><span class="line">    <span class="keyword">method_list_t</span> *optionalInstanceMethods;</span><br><span class="line">    <span class="keyword">method_list_t</span> *optionalClassMethods;</span><br><span class="line">    <span class="keyword">property_list_t</span> *instanceProperties;</span><br><span class="line">    <span class="keyword">uint32_t</span> size;   <span class="comment">// sizeof(protocol_t)</span></span><br><span class="line">    <span class="keyword">uint32_t</span> flags;</span><br><span class="line">    <span class="comment">// Fields below this point are not always present on disk.</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> **_extendedMethodTypes;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *_demangledName;</span><br><span class="line">    <span class="keyword">property_list_t</span> *_classProperties;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">const</span> <span class="keyword">char</span> *<span class="title">demangledName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    ... <span class="comment">// 一些函数</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>protocol_ref_t</code>虽然未映射成<code>protocol_t *</code>，不过应该可以考虑一下强转，实验一下吧（这次是找到<code>PersonProtocol</code>协议）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p (<span class="keyword">protocol_list_t</span> *)<span class="number">0x00000001000025a8</span>  <span class="comment">// rw的protocols的list地址</span></span><br><span class="line">(<span class="keyword">protocol_list_t</span> *) $<span class="number">26</span> = <span class="number">0x00000001000025a8</span></span><br><span class="line">  </span><br><span class="line">(lldb) p *$<span class="number">26</span></span><br><span class="line">(<span class="keyword">protocol_list_t</span>) $<span class="number">27</span> = (count = <span class="number">1</span>, <span class="built_in">list</span> = <span class="keyword">protocol_ref_t</span> [] @ <span class="number">0x00007fb5decb30f8</span>)</span><br><span class="line"></span><br><span class="line">(lldb) p (<span class="keyword">protocol_t</span> *)$<span class="number">26</span>-&gt;<span class="built_in">list</span>[<span class="number">0</span>]</span><br><span class="line">(<span class="keyword">protocol_t</span> *) $<span class="number">32</span> = <span class="number">0x00000001000028a8</span></span><br><span class="line">  </span><br><span class="line">(lldb) p *$<span class="number">32</span></span><br><span class="line">(<span class="keyword">protocol_t</span>) $<span class="number">33</span> = &#123;</span><br><span class="line">  objc_object = &#123;</span><br><span class="line">    isa = &#123;</span><br><span class="line">      cls = Protocol</span><br><span class="line">      bits = <span class="number">4306735304</span></span><br><span class="line">       = &#123;</span><br><span class="line">        nonpointer = <span class="number">0</span></span><br><span class="line">        has_assoc = <span class="number">0</span></span><br><span class="line">        has_cxx_dtor = <span class="number">0</span></span><br><span class="line">        shiftcls = <span class="number">538341913</span></span><br><span class="line">        magic = <span class="number">0</span></span><br><span class="line">        weakly_referenced = <span class="number">0</span></span><br><span class="line">        deallocating = <span class="number">0</span></span><br><span class="line">        has_sidetable_rc = <span class="number">0</span></span><br><span class="line">        extra_rc = <span class="number">0</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  mangledName = <span class="number">0x0000000100001d16</span> <span class="string">&quot;PersonProtocol&quot;</span> <span class="comment">// 出现了！！！</span></span><br><span class="line">  protocols = <span class="number">0x0000000100002568</span></span><br><span class="line">  instanceMethods = <span class="number">0x0000000100002580</span></span><br><span class="line">  classMethods = <span class="number">0x0000000000000000</span></span><br><span class="line">  optionalInstanceMethods = <span class="number">0x0000000000000000</span></span><br><span class="line">  optionalClassMethods = <span class="number">0x0000000000000000</span></span><br><span class="line">  instanceProperties = <span class="number">0x0000000000000000</span></span><br><span class="line">  size = <span class="number">96</span></span><br><span class="line">  flags = <span class="number">0</span></span><br><span class="line">  _extendedMethodTypes = <span class="number">0x00000001000025a0</span></span><br><span class="line">  _demangledName = <span class="number">0x0000000000000000</span></span><br><span class="line">  _classProperties = <span class="number">0x0000000000000000</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>功夫不负有心人，最终验证了<code>class_rw_t</code>的<code>protocols</code>中含有<code>Person</code>类所遵循的<code>PersonProtocol</code>协议。</p>
<p>到了这里，**<code>class_rw_t</code>确实存储了类的实例方法、属性和遵循的协议了。**</p>
<h3 id="2-4-class-ro-t验证过程"><a href="#2-4-class-ro-t验证过程" class="headerlink" title="2.4 class_ro_t验证过程"></a>2.4 <code>class_ro_t</code>验证过程</h3><p>现在就剩下<code>ro</code>了</p>
<p>1.打印<code>class_ro_t</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p $<span class="number">1</span>-&gt;ro</span><br><span class="line">(<span class="keyword">const</span> <span class="keyword">class_ro_t</span> *) $<span class="number">38</span> = <span class="number">0x0000000100002788</span></span><br><span class="line">  </span><br><span class="line">(lldb) p *$<span class="number">38</span></span><br><span class="line">(<span class="keyword">const</span> <span class="keyword">class_ro_t</span>) $<span class="number">39</span> = &#123;</span><br><span class="line">  flags = <span class="number">388</span></span><br><span class="line">  instanceStart = <span class="number">8</span></span><br><span class="line">  instanceSize = <span class="number">32</span></span><br><span class="line">  reserved = <span class="number">0</span></span><br><span class="line">  ivarLayout = <span class="number">0x0000000100001d2e</span> <span class="string">&quot;\x11&quot;</span></span><br><span class="line">  name = <span class="number">0x0000000100001d0f</span> <span class="string">&quot;Person&quot;</span></span><br><span class="line">  baseMethodList = <span class="number">0x0000000100002608</span></span><br><span class="line">  baseProtocols = <span class="number">0x00000001000025a8</span></span><br><span class="line">  ivars = <span class="number">0x00000001000026b8</span></span><br><span class="line">  weakIvarLayout = <span class="number">0x0000000000000000</span></span><br><span class="line">  baseProperties = <span class="number">0x0000000100002720</span></span><br><span class="line">  _swiftMetadataInitializer_NEVER_USE = &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有没有发现什么！**<code>class_ro_t</code>的方法、属性和协议的地址都与<code>class_rw_t</code>的一致<strong>，既然指向的是同一块内存空间，</strong>显然<code>class_ro_t</code>也存储了<code>Person</code>类的实例方法、属性和协议**。</p>
<p>与<code>class_rw_t</code>不同的是，<code>class_ro_t</code>多了一个<code>ivars</code>列表，里面存放的应该是<code>Person</code>类的成员变量。</p>
<p>2.验证<code>ivars</code></p>
<p>Person类的成员变量有：<code>_gender</code>、<code>_name</code>和<code>_age</code></p>
<p>所幸<code>ivar_list_t</code>是继承自<code>entsize_list_tt</code>的，<code>get()</code>函数又可以用了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p $<span class="number">39.</span>ivars</span><br><span class="line">(<span class="keyword">const</span> <span class="keyword">ivar_list_t</span> *<span class="keyword">const</span>) $<span class="number">40</span> = <span class="number">0x00000001000026b8</span></span><br><span class="line">(lldb) p *$<span class="number">40</span></span><br><span class="line">(<span class="keyword">const</span> <span class="keyword">ivar_list_t</span>) $<span class="number">41</span> = &#123;</span><br><span class="line">  entsize_list_tt&lt;<span class="keyword">ivar_t</span>, <span class="keyword">ivar_list_t</span>, <span class="number">0</span>&gt; = &#123;</span><br><span class="line">    entsizeAndFlags = <span class="number">32</span></span><br><span class="line">    count = <span class="number">3</span></span><br><span class="line">    first = &#123;</span><br><span class="line">      offset = <span class="number">0x00000001000027e0</span></span><br><span class="line">      name = <span class="number">0x0000000100001e83</span> <span class="string">&quot;_gender&quot;</span></span><br><span class="line">      type = <span class="number">0x0000000100001f69</span> <span class="string">&quot;q&quot;</span></span><br><span class="line">      alignment_raw = <span class="number">3</span></span><br><span class="line">      size = <span class="number">8</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">(lldb) p $<span class="number">41.</span>get(<span class="number">0</span>)</span><br><span class="line">(<span class="keyword">ivar_t</span>) $<span class="number">42</span> = &#123;</span><br><span class="line">  offset = <span class="number">0x00000001000027e0</span></span><br><span class="line">  name = <span class="number">0x0000000100001e83</span> <span class="string">&quot;_gender&quot;</span></span><br><span class="line">  type = <span class="number">0x0000000100001f69</span> <span class="string">&quot;q&quot;</span></span><br><span class="line">  alignment_raw = <span class="number">3</span></span><br><span class="line">  size = <span class="number">8</span></span><br><span class="line">&#125;</span><br><span class="line">(lldb) p $<span class="number">41.</span>get(<span class="number">1</span>)</span><br><span class="line">(<span class="keyword">ivar_t</span>) $<span class="number">43</span> = &#123;</span><br><span class="line">  offset = <span class="number">0x00000001000027e8</span></span><br><span class="line">  name = <span class="number">0x0000000100001e8b</span> <span class="string">&quot;_name&quot;</span></span><br><span class="line">  type = <span class="number">0x0000000100001f6b</span> <span class="string">&quot;@\&quot;NSString\&quot;&quot;</span></span><br><span class="line">  alignment_raw = <span class="number">3</span></span><br><span class="line">  size = <span class="number">8</span></span><br><span class="line">&#125;</span><br><span class="line">(lldb) p $<span class="number">41.</span>get(<span class="number">2</span>)</span><br><span class="line">(<span class="keyword">ivar_t</span>) $<span class="number">44</span> = &#123;</span><br><span class="line">  offset = <span class="number">0x00000001000027f0</span></span><br><span class="line">  name = <span class="number">0x0000000100001e91</span> <span class="string">&quot;_age&quot;</span></span><br><span class="line">  type = <span class="number">0x0000000100001f69</span> <span class="string">&quot;q&quot;</span></span><br><span class="line">  alignment_raw = <span class="number">3</span></span><br><span class="line">  size = <span class="number">8</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完全符合预期，<code>class_ro_t</code>确实存储了<code>Person</code>类的成员变量。</p>
<h3 id="2-5-rw和ro的联系【下面看不懂了】"><a href="#2-5-rw和ro的联系【下面看不懂了】" class="headerlink" title="2.5 rw和ro的联系【下面看不懂了】"></a>2.5 <code>rw</code>和<code>ro</code>的联系【下面看不懂了】</h3><p>为什么<code>class_rw_t</code>、<code>class_ro_t</code>的方法、属性和协议的地址一致？</p>
<p>在<code>class_data_bits_t</code>结构体中的<code>safe_ro()</code>函数中发现了端倪</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">const</span> <span class="keyword">class_ro_t</span> *<span class="title">safe_ro</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">class_rw_t</span> *maybe_rw = data();</span><br><span class="line">    <span class="keyword">if</span> (maybe_rw-&gt;flags &amp; RW_REALIZED) &#123;</span><br><span class="line">        <span class="comment">// maybe_rw is rw</span></span><br><span class="line">        <span class="keyword">return</span> maybe_rw-&gt;ro;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// maybe_rw is actually ro</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">class_ro_t</span> *)maybe_rw;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可见，<code>rw</code>不一定是<code>rw</code>，也可能是<code>ro</code>。实际上，在编译期间，类的<code>class_data_bits_t *bits</code>指针指向的是<code>class_ro_t *</code>，然后在<code>OC</code>运行时调用了<code>realizeClassWithoutSwift()</code>（苹果开源的<code>objc4-756.2源码</code>是<code>realizeClassWithoutSwift()</code>，在此之前的版本是<code>realizeClass()</code>方法），这个方法主要做的就是利用编译期确定的<code>ro</code>来初始化<code>rw</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ro = (<span class="keyword">const</span> <span class="keyword">class_ro_t</span> *)cls-&gt;data();</span><br><span class="line"><span class="keyword">if</span> (ro-&gt;flags &amp; RO_FUTURE) &#123;</span><br><span class="line">    <span class="comment">// This was a future class. rw data is already allocated.</span></span><br><span class="line">    rw = cls-&gt;data();</span><br><span class="line">    ro = cls-&gt;data()-&gt;ro;</span><br><span class="line">    cls-&gt;changeInfo(RW_REALIZED|RW_REALIZING, RW_FUTURE);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 一般走这里</span></span><br><span class="line">    <span class="comment">// Normal class. Allocate writeable class data.</span></span><br><span class="line">    rw = (<span class="keyword">class_rw_t</span> *)<span class="built_in">calloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">class_rw_t</span>), <span class="number">1</span>);   <span class="comment">// 给rw申请内存</span></span><br><span class="line">    rw-&gt;ro = ro;    <span class="comment">// 设置rw的ro</span></span><br><span class="line">    rw-&gt;flags = RW_REALIZED|RW_REALIZING;   <span class="comment">// 设置flags</span></span><br><span class="line">    cls-&gt;setData(rw);   <span class="comment">// 给cls设置正确的rw</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">... <span class="comment">// 初始化 rw 的其他字段，更新superclass、meta class</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Attach categories</span></span><br><span class="line">methodizeClass(cls);</span><br></pre></td></tr></table></figure>

<p>在代码的最后，还调用了<code>methodizeClass()</code>，其源码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">methodizeClass</span><span class="params">(Class cls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> isMeta = cls-&gt;isMetaClass();</span><br><span class="line">    <span class="keyword">auto</span> rw = cls-&gt;data();</span><br><span class="line">    <span class="keyword">auto</span> ro = rw-&gt;ro;</span><br><span class="line"></span><br><span class="line">    ... <span class="comment">// 打印信息</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Install methods and properties that the class implements itself.</span></span><br><span class="line">    <span class="keyword">method_list_t</span> *<span class="built_in">list</span> = ro-&gt;baseMethods();</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">list</span>) &#123;</span><br><span class="line">        prepareMethodLists(cls, &amp;<span class="built_in">list</span>, <span class="number">1</span>, YES, isBundleClass(cls));</span><br><span class="line">        rw-&gt;methods.attachLists(&amp;<span class="built_in">list</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">property_list_t</span> *proplist = ro-&gt;baseProperties;</span><br><span class="line">    <span class="keyword">if</span> (proplist) &#123;</span><br><span class="line">        rw-&gt;properties.attachLists(&amp;proplist, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protocol_list_t</span> *protolist = ro-&gt;baseProtocols;</span><br><span class="line">    <span class="keyword">if</span> (protolist) &#123;</span><br><span class="line">        rw-&gt;protocols.attachLists(&amp;protolist, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cls-&gt;isRootMetaclass()) &#123;</span><br><span class="line">        addMethod(cls, SEL_initialize, (IMP)&amp;objc_noop_imp, <span class="string">&quot;&quot;</span>, NO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    category_list *cats = unattachedCategoriesForClass(cls, <span class="literal">true</span> <span class="comment">/*realizing*/</span>);</span><br><span class="line">    attachCategories(cls, cats, <span class="literal">false</span> <span class="comment">/*don&#x27;t flush caches*/</span>);</span><br><span class="line"></span><br><span class="line">    ... <span class="comment">// 打印信息</span></span><br><span class="line">    <span class="keyword">if</span> (cats) <span class="built_in">free</span>(cats);</span><br><span class="line">    ... <span class="comment">// 打印信息</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个方法里，<strong>将类自己实现的方法（包括分类）、属性和遵循的协议加载到 <code>methods</code>、<code>properties</code> 和 <code>protocols</code> 列表中。</strong></p>
<p>这就完美解释了为什么运行时<code>rw</code>和<code>ro</code>的方法、属性和协议相同。</p>
<h3 id="2-6-rw和ro在运行时的不同之处"><a href="#2-6-rw和ro在运行时的不同之处" class="headerlink" title="2.6 rw和ro在运行时的不同之处"></a>2.6 <code>rw</code>和<code>ro</code>在运行时的不同之处</h3><p>目前为止的验证都是基于<code>Person</code>类的现有结构，也就是在编译期就确定的，突出不了<code>class_rw_t</code>和<code>class_ro_t</code>的差异性。接下来会用<code>runtime</code>的<code>api</code>在运行时为<code>Person</code>动态添加一个<code>fly()</code>方法，再来一试。</p>
<p>1.添加方法</p>
<p>具体代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fly</span><span class="params">(id obj, SEL sel)</span> </span>&#123;</span><br><span class="line">    NSLog(@<span class="string">&quot;I am flying&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class_addMethod([Person class], NSSelectorFromString(@<span class="string">&quot;fly&quot;</span>), (IMP)fly, <span class="string">&quot;v@:&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>再加一个打印方法，用于打印类的<code>methods</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printMethods</span><span class="params">(Class cls)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (cls == nil) &#123;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    CCNSLog(@<span class="string">&quot;------------ print %@ methods ------------&quot;</span>, NSStringFromClass(cls));</span><br><span class="line">    <span class="keyword">uint32_t</span> count;</span><br><span class="line">    Method *methods = class_copyMethodList(cls, &amp;count);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        Method method = methods[i];</span><br><span class="line">        CCNSLog(@<span class="string">&quot;名字：%@ -- 类型：%s&quot;</span>, NSStringFromSelector(method_getName(method)), method_getTypeEncoding(method));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行一下看效果，发现添加成功，如图</p>
<p><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20201203153659376.png" alt="img"></p>
<p>2.验证过程</p>
<p>先打印<code>class_rw_t</code>，即</p>
<p><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20201203153716457.png" alt="img"></p>
<p>还有<code>class_ro_t</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20201203153722050.png" alt="img"></p>
<p>对比后发现，<strong>两者的属性、协议指针地址未发生变化，但是方法的指针地址不一样了</strong>。 由于<code>class_rw_t</code>是运行时才初始化的，而<code>class_ro_t</code>在编译期间就确定了，因此可以猜测新增的<code>fly</code>方法存储在<code>class_rw_t</code>的<code>methods</code>指针上，<code>class_ro_t</code>的<code>baseMethodList</code>指针从编译期之后就未发生改变。</p>
<p>下面继续验证，首先看<code>class_ro_t</code>的方法列表</p>
<p><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20201203153739037.png" alt="img"></p>
<p><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20201203153750735.png" alt="img"></p>
<p>OK，编译期就确定的方法都在，并且没有<code>fly</code>方法，也就是说<code>class_ro_t</code>的方法列表在运行时基本没变。</p>
<blockquote>
<p><code>class_ro_t</code>的属性列表、成员变量列表、协议在运行时都没有发生改变。感兴趣的同学可以自己尝试验证一下。</p>
</blockquote>
<p>接着看<code>class_rw_t</code>的方法列表</p>
<p><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20201203153801318.png" alt="img"></p>
<p><strong><code>class_rw_t</code>的<code>methods</code>里面数据居然都没有了？</strong> 没办法，这里暂时留个坑吧，暂时不知道原因。</p>
<h2 id="3-总结"><a href="#3-总结" class="headerlink" title="3. 总结"></a>3. 总结</h2><h3 id="3-1-类的结构总结"><a href="#3-1-类的结构总结" class="headerlink" title="3.1 类的结构总结"></a>3.1 类的结构总结</h3><p>关于类的结构，我们了解到：</p>
<ul>
<li>类本质上是<code>objc_object</code>结构体，也就是类也是对象，即万物是对象。</li>
<li>类都包含一个<code>Class</code>类型的成员变量<code>isa</code></li>
<li><code>Class</code>是<code>objc_class</code>结构体类型的指针变量，内部有4个成员变量，即<ul>
<li><code>isa</code>：类型是<code>isa_t</code></li>
<li><code>superclass</code>：类型是<code>Class</code>，表示继承关系，指向类的父类</li>
<li><code>cache</code>：类型是<code>cache_t</code>，表示缓存，用于缓存指针和 <code>vtable</code>，加速方法的调用</li>
<li><code>bits</code>：类型是<code>class_data_bits_t</code>，用于存储类的数据（类的方法、属性、遵循的协议等信息），其长度在<code>64位</code>CPU下为8字节，是个指针，指向<code>class_rw_t *</code></li>
</ul>
</li>
</ul>
<h3 id="3-2-class-rw-t和class-ro-t总结"><a href="#3-2-class-rw-t和class-ro-t总结" class="headerlink" title="3.2 class_rw_t和class_ro_t总结"></a>3.2 <code>class_rw_t</code>和<code>class_ro_t</code>总结</h3><ul>
<li><p><code>class_ro_t</code>存储了类在编译期确定的方法（包括其分类的）、成员变量、属性以及遵循的协议等信息，在运行时不会发生变化。编译期，类的<code>bits</code>指针指向的是<code>class_ro_t</code>指针（即此时class_rw_t 实际上是class_ro_t ）。</p>
<ul>
<li>实例方法存储在类中</li>
<li>类方法存储在元类中（【4.1】将给出证明）</li>
</ul>
</li>
<li><p>在<code>realizeClassWithoutSwift()</code>执行之后，<code>class_rw_t</code>才会被初始化，同时存储类的方法、属性以及遵循的协议，实际上，<code>class_rw_t</code>和<code>class_ro_t</code>两者的方法列表（或属性列表、协议列表）的指针是相同的。</p>
</li>
<li><p>运行时向类动态添加属性、方法时，会修改<code>class_rw_t</code>的属性列表、方法列表指针，但<code>class_ro_t</code>对应的属性列表、方法列表不会变。</p>
</li>
</ul>
<blockquote>
<p>一个待解决的坑：通过运行时添加方法（或属性、协议）改变了 class_rw_t 对应的方法列表（或属性列表、协议列表）的指针后，不知道为什么居然在 class_rw_t 的方法列表（或属性列表、协议列表）上找不到新增的方法（或属性、协议）了。</p>
</blockquote>
<h3 id="3-3-类方法的存储位置"><a href="#3-3-类方法的存储位置" class="headerlink" title="3.3 类方法的存储位置"></a>3.3 类方法的存储位置</h3><p>（Person类的类方法<code>printMyClassName()</code>）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 获取 Person元类</span></span><br><span class="line">(lldb) x/<span class="number">4</span>gx pcls</span><br><span class="line"><span class="number">0x100002820</span>: <span class="number">0x001d8001000027f9</span> <span class="number">0x0000000100b39140</span></span><br><span class="line"><span class="number">0x100002830</span>: <span class="number">0x00000001003dc250</span> <span class="number">0x0000000000000000</span></span><br><span class="line">(lldb) p/x <span class="number">0x001d8001000027f9</span> &amp; <span class="number">0x00007ffffffffff8</span></span><br><span class="line">(<span class="keyword">long</span>) $<span class="number">50</span> = <span class="number">0x00000001000027f8</span></span><br><span class="line">(lldb) po <span class="number">0x00000001000027f8</span></span><br><span class="line">Person  <span class="comment">// Person元类</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 获取 Person元类 的 bits</span></span><br><span class="line">(lldb) x/<span class="number">5</span>gx <span class="number">0x00000001000027f8</span></span><br><span class="line"><span class="number">0x1000027f8</span>: <span class="number">0x001d800100b390f1</span> <span class="number">0x0000000100b390f0</span></span><br><span class="line"><span class="number">0x100002808</span>: <span class="number">0x0000000102237440</span> <span class="number">0x0000000100000003</span></span><br><span class="line"><span class="number">0x100002818</span>: <span class="number">0x00000001022373a0</span> <span class="comment">// Person元类 的 bits</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 获取 Person元类 的 class_rw_t</span></span><br><span class="line">(lldb) p (<span class="keyword">class_rw_t</span> *)(<span class="number">0x00000001022373a0</span> &amp; <span class="number">0x00007ffffffffff8</span>)</span><br><span class="line">(<span class="keyword">class_rw_t</span> *) $<span class="number">52</span> = <span class="number">0x00000001022373a0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 验证 Person元类 的 methods</span></span><br><span class="line">(lldb) p $<span class="number">52</span>-&gt;methods</span><br><span class="line">(<span class="keyword">method_array_t</span>) $<span class="number">55</span> = &#123;</span><br><span class="line">  list_array_tt&lt;<span class="keyword">method_t</span>, <span class="keyword">method_list_t</span>&gt; = &#123;</span><br><span class="line">     = &#123;</span><br><span class="line">      <span class="built_in">list</span> = <span class="number">0x0000000100002270</span></span><br><span class="line">      arrayAndFlag = <span class="number">4294976112</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">(lldb) p (<span class="keyword">method_list_t</span> *)<span class="number">0x0000000100002270</span></span><br><span class="line">(<span class="keyword">method_list_t</span> *) $<span class="number">56</span> = <span class="number">0x0000000100002270</span></span><br><span class="line">(lldb) p *$<span class="number">56</span></span><br><span class="line">(<span class="keyword">method_list_t</span>) $<span class="number">57</span> = &#123;</span><br><span class="line">  entsize_list_tt&lt;<span class="keyword">method_t</span>, <span class="keyword">method_list_t</span>, <span class="number">3</span>&gt; = &#123;</span><br><span class="line">    entsizeAndFlags = <span class="number">26</span></span><br><span class="line">    count = <span class="number">1</span></span><br><span class="line">    first = &#123;</span><br><span class="line">      name = <span class="string">&quot;printMyClassName&quot;</span> <span class="comment">// 成功找到 Person类的类方法</span></span><br><span class="line">      types = <span class="number">0x0000000100001e96</span> <span class="string">&quot;v16@0:8&quot;</span></span><br><span class="line">      imp = <span class="number">0x00000001000014d0</span> (CCTest`+[Person printMyClassName] at main.m:<span class="number">37</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结论：<strong>类方法 存储 在类的元类上，且位于元类的<code>class_ro_t</code>的<code>baseMethodList</code>指针上（或在<code>class_rw_t</code>的<code>methods</code>指针上）</strong></p>
</div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/12/16/%E5%8D%9A%E5%AE%A2/Hexo%20%E9%85%8D%E7%BD%AE/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Hexo 配置</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/11/16/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/02-isa%E5%8E%9F%E7%90%86/"><span class="level-item">02-isa原理</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#一、对象-amp-类的结构"><span class="level-left"><span class="level-item">一、对象&amp;类的结构</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-1-解读类的本质"><span class="level-left"><span class="level-item">1.1 解读类的本质</span></span></a></li><li><a class="level is-mobile" href="#1-2-objc-object结构"><span class="level-left"><span class="level-item">1.2 objc_object结构</span></span></a></li><li><a class="level is-mobile" href="#1-3-objc-class结构"><span class="level-left"><span class="level-item">1.3 objc_class结构</span></span></a></li></ul></li><li><a class="level is-mobile" href="#二、class-rw-t-amp-class-ro-t分析"><span class="level-left"><span class="level-item">二、class_rw_t &amp; class_ro_t分析</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#2-1-获取class-rw-t"><span class="level-left"><span class="level-item">2.1 获取class_rw_t</span></span></a></li><li><a class="level is-mobile" href="#2-2-准备工作"><span class="level-left"><span class="level-item">2.2 准备工作</span></span></a></li><li><a class="level is-mobile" href="#2-3-class-rw-t验证过程"><span class="level-left"><span class="level-item">2.3 class_rw_t验证过程</span></span></a></li><li><a class="level is-mobile" href="#2-4-class-ro-t验证过程"><span class="level-left"><span class="level-item">2.4 class_ro_t验证过程</span></span></a></li><li><a class="level is-mobile" href="#2-5-rw和ro的联系【下面看不懂了】"><span class="level-left"><span class="level-item">2.5 rw和ro的联系【下面看不懂了】</span></span></a></li><li><a class="level is-mobile" href="#2-6-rw和ro在运行时的不同之处"><span class="level-left"><span class="level-item">2.6 rw和ro在运行时的不同之处</span></span></a></li></ul></li><li><a class="level is-mobile" href="#3-总结"><span class="level-left"><span class="level-item">3. 总结</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-1-类的结构总结"><span class="level-left"><span class="level-item">3.1 类的结构总结</span></span></a></li><li><a class="level is-mobile" href="#3-2-class-rw-t和class-ro-t总结"><span class="level-left"><span class="level-item">3.2 class_rw_t和class_ro_t总结</span></span></a></li><li><a class="level is-mobile" href="#3-3-类方法的存储位置"><span class="level-left"><span class="level-item">3.3 类方法的存储位置</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/imglogo.png" alt="IMO&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2020 IMO</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/speam"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>