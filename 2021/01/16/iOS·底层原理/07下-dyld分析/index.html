<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>07下-dyld分析 - IMO&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="IMO&#039;s Blog"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/avatar4.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="IMO&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description=""><meta property="og:type" content="blog"><meta property="og:title" content="07下-dyld分析"><meta property="og:url" content="http://evilimo.com/2021/01/16/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/07%E4%B8%8B-dyld%E5%88%86%E6%9E%90/"><meta property="og:site_name" content="IMO&#039;s Blog"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116160313528.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116171211438.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116171246490.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116173642286.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210115182408705.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210115182546068.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116141000385.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116142834262.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116142853014.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116174014570.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116155542621.png"><meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/1/10/16f8b2abebf9b282?imageView2/0/w/1280/h/960/ignore-error/1"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116155808170.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/dyld.jpg"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116174141455.png"><meta property="article:published_time" content="2021-01-16T09:44:20.341Z"><meta property="article:modified_time" content="2021-02-16T12:53:33.031Z"><meta property="article:author" content="IMO"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116160313528.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://evilimo.com/2021/01/16/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/07%E4%B8%8B-dyld%E5%88%86%E6%9E%90/"},"headline":"IMO's Blog","image":["https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116160313528.png","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116171211438.png","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116171246490.png","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116173642286.png","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210115182408705.png","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210115182546068.png","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116141000385.png","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116142834262.png","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116142853014.png","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116174014570.png","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116155542621.png","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116155808170.png","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/dyld.jpg","https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116174141455.png"],"datePublished":"2021-01-16T09:44:20.341Z","dateModified":"2021-02-16T12:53:33.031Z","author":{"@type":"Person","name":"IMO"},"description":""}</script><link rel="canonical" href="http://evilimo.com/2021/01/16/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/07%E4%B8%8B-dyld%E5%88%86%E6%9E%90/"><link rel="icon" href="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/avatar4.png"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.4.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><!--!--><meta name="generator" content="Hexo 5.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/imglogo.png" alt="IMO&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-16T09:44:20.341Z" title="2021-01-16T09:44:20.341Z">2021-01-16</time>发表</span><span class="level-item"><time dateTime="2021-02-16T12:53:33.031Z" title="2021-02-16T12:53:33.031Z">2021-02-16</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/">iOS·底层原理</a></span></div></div><h1 class="title is-3 is-size-4-mobile">07下-dyld分析</h1><div class="content"><hr>
<a id="more"></a>

<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我们平时编写的程序的入口函数都是<code>main.m文件</code>里面的<code>main函数</code>，但是这就是App的生命起点了吗？</p>
<p><code>+load</code>方法先于<code>main函数</code>执行，那么<code>main</code>函数之前都发生了哪些有趣的事呢？</p>
<h2 id="一、静态库与动态库"><a href="#一、静态库与动态库" class="headerlink" title="一、静态库与动态库"></a>一、静态库与动态库</h2><h4 id="1-编译过程"><a href="#1-编译过程" class="headerlink" title="1.编译过程"></a>1.编译过程</h4><p>在日常开发过程中，开发者会使用成千上万次的<code>Command + B/R</code>进行开发调试，但可能很少有人关注过这个过程中 <code>Xcode</code>帮我们做了哪些事情</p>
<blockquote>
<p>事实上，这个过程分解为4个步骤，分别是预处理(Prepressing)、编译(Compilation)、汇编(Assembly)和链接(Linking)——摘自《程序员的自我修养– 链接、装载与库》</p>
</blockquote>
<p>在以上4个步骤中，IDE主要做了以下几件事:</p>
<ul>
<li><p>**<code>预编译</code>**：处理代码中的<code># 开头</code>的预编译指令。比如删除<code>#define</code>并展开宏定义，将<code>#include</code>包含的文件插入到该指令位置等</p>
</li>
<li><p>**<code>编译</code>**：对预编译处理过的文件进行词法分析、语法分析和语义分析，并进行源代码优化，然后生成汇编代码</p>
</li>
<li><p>**<code>汇编</code>**：通过汇编器将汇编代码转换为机器可以执行的指令，并生成目标文件<code>.o文件</code></p>
</li>
<li><p>**<code>链接</code>**：将目标文件链接成可执行文件。这一过程中，链接器将不同的目标文件链接起来，因为不同的目标文件之间可能有相互引用的变量或调用的函数，如我们经常调用<code>Foundation</code>框架和<code>UIKit</code>框架中的方法和变量，但是这些框架跟我们的代码并不在一个目标文件中，这就需要链接器将它们与我们自己的代码链接起来</p>
<p><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116160313528.png"></p>
</li>
</ul>
<blockquote>
<p><code>Foundation</code>和<code>UIKit</code>这种可以共享代码、实现代码的复用统称为<code>库</code>——是可执行代码的二进制文件，可以被操作系统写入内存，它又分为<code>静态库</code>和<code>动态库</code></p>
</blockquote>
<h4 id="2-静态库"><a href="#2-静态库" class="headerlink" title="2.静态库"></a>2.静态库</h4><p><code>静态库</code>是指链接时完整的拷贝到可执行文件，多次使用多次拷贝，造成冗余，使包变的更大</p>
<p>如<code>.a</code>、<code>.lib</code>都是静态库</p>
<h4 id="3-动态库"><a href="#3-动态库" class="headerlink" title="3.动态库"></a>3.动态库</h4><p><code>动态库</code>是指链接时不复制，程序运行时由系统加在到内存中，供系统调用，系统只需加载一次，多次使用，共用节省内存。</p>
<p>如<code>.dylib</code>、<code>.framework</code>都是动态库</p>
<p><strong>系统的framework是动态的，开发者创建的framework是静态的</strong></p>
<blockquote>
<p>那么链接器又是什么呢？它是怎么链接不同的目标文件的呢？</p>
</blockquote>
<h2 id="二、dyld"><a href="#二、dyld" class="headerlink" title="二、dyld"></a>二、dyld</h2><h4 id="1-dyld简介"><a href="#1-dyld简介" class="headerlink" title="1.dyld简介"></a>1.dyld简介</h4><p><code>dyld(dynamic link editor / dynamic loader)</code>是苹果的<code>动态链接器</code>，负责程序的<code>链接及加载</code>工作，是苹果操作系统的重要组成部分，存在于MacOS系统的<code>(/usr/lib/dyld)</code>目录下。</p>
<p>在应用被编译打包成可执行文件格式的<code>Mach-O</code>文件之后 ，交由<code>dyld</code>负责链接，加载程序。</p>
<h4 id="2-dyld-shared-cache"><a href="#2-dyld-shared-cache" class="headerlink" title="2.dyld_shared_cache"></a>2.dyld_shared_cache</h4><p>由于不止一个程序需要使用<code>UIKit</code>系统动态库，所以不可能在每个程序加载时都去加载所有的系统动态库。</p>
<p>为了优化程序启动速度和利用动态库缓存，苹果从<code>iOS3.1</code>之后，将所有系统库（私有与公有）编译成一个大的缓存文件，这就是<code>dyld_shared_cache</code>，该缓存文件存在iOS系统下的<code>/System/Library/Caches/com.apple.dyld/</code>目录下</p>
<h2 id="三、dyld加载流程"><a href="#三、dyld加载流程" class="headerlink" title="三、dyld加载流程"></a>三、dyld加载流程</h2><p>新建空工程，写下<code>load方法</code>，并在<code>main方法</code>和<code>load方法</code>分别下断点</p>
<p><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116171211438.png"></p>
<p>点击函数调用栈/使用LLVM——<code>bt指令</code>打印，都能看到最初的起点<code>_dyld_start</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116171246490.png" alt="函数调用栈"></p>
<p>接下来通过<a target="_blank" rel="noopener" href="https://github.com/speam/dyldSource.git">dyld源码</a>(版本：dyld-635.2)展开分析<code>_dyld_start</code>：</p>
<h4 id="1-dyld-start"><a href="#1-dyld-start" class="headerlink" title="1._dyld_start"></a>1._dyld_start</h4><p>在源码中全局搜索<code>_dyld_start</code>，会发现它是由汇编实现的</p>
<p>在<code>arm64</code>中，<code>_dyld_start</code>调用了一个看不懂的方法</p>
<p>从注释中得出可能是<code>dyldbootstrap::start</code>方法（其实在“函数调用栈”那张图中汇编代码已经把这个方法暴露出来了）</p>
<p><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116173642286.png"></p>
<h4 id="2-dyldbootstrap-start"><a href="#2-dyldbootstrap-start" class="headerlink" title="2.dyldbootstrap::start"></a>2.dyldbootstrap::start</h4><p>全局搜索<code>dyldbootstrap::start</code>并没有任何有意义结果，那么只能根据经验来瞎蒙一下了——全局搜索<code>空格start(</code>“侥幸”得到了结果</p>
<p>其实<code>dyldbootstrap::start</code>是指<code>dyldbootstrap</code>这个命名空间作用域里的 <code>start</code>函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">uintptr_t</span> <span class="title">start</span><span class="params">(<span class="keyword">const</span> struct macho_header* appsMachHeader, <span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[], </span></span></span><br><span class="line"><span class="function"><span class="params">				<span class="keyword">intptr_t</span> slide, <span class="keyword">const</span> struct macho_header* dyldsMachHeader,</span></span></span><br><span class="line"><span class="function"><span class="params">				<span class="keyword">uintptr_t</span>* startGlue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// if kernel had to slide dyld, we need to fix up load sensitive locations</span></span><br><span class="line">	<span class="comment">// we have to do this before using any global variables</span></span><br><span class="line">    slide = slideOfMainExecutable(dyldsMachHeader);</span><br><span class="line">    <span class="keyword">bool</span> shouldRebase = slide != <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __has_feature(ptrauth_calls)</span></span><br><span class="line">    shouldRebase = <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">if</span> ( shouldRebase ) &#123;</span><br><span class="line">        rebaseDyld(dyldsMachHeader, slide);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// allow dyld to use mach messaging</span></span><br><span class="line">	mach_init();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// kernel sets up env pointer to be just past end of agv array</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>** envp = &amp;argv[argc+<span class="number">1</span>];</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// kernel sets up apple pointer to be just past end of envp array</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>** apple = envp;</span><br><span class="line">	<span class="keyword">while</span>(*apple != <span class="literal">NULL</span>) &#123; ++apple; &#125;</span><br><span class="line">	++apple;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// set up random value for stack canary</span></span><br><span class="line">	__guard_setup(apple);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DYLD_INITIALIZER_SUPPORT</span></span><br><span class="line">	<span class="comment">// run all C++ initializers inside dyld</span></span><br><span class="line">	runDyldInitializers(dyldsMachHeader, slide, argc, argv, envp, apple);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// now that we are done bootstrapping dyld, call dyld&#x27;s main</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> appsSlide = slideOfMainExecutable(appsMachHeader);</span><br><span class="line">	<span class="keyword">return</span> dyld::_main(appsMachHeader, appsSlide, argc, argv, envp, apple, startGlue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>start()</code>函数中主要做了一下几件事：</p>
<ul>
<li>根据<code>dyldsMachHeader</code>计算出<code>slide</code>， 通过<code>slide</code>判定是否需要重定位；这里的<code>slide</code>是根据<code>ASLR技术</code> 计算出的一个随机值，使得程序每一次运行的偏移值都不一样，防止攻击者通过固定地址发起恶意攻击</li>
<li><code>mach_init()</code>初始化（允许dyld使用mach消息传递）</li>
<li>栈溢出保护</li>
<li>计算<code>appsMachHeader</code>的偏移，调用<code>dyld::_main()</code>函数</li>
</ul>
<h4 id="3-dyld-main"><a href="#3-dyld-main" class="headerlink" title="3.dyld::_main()"></a>3.dyld::_main()</h4><p>点击进入<code>dyld::_main()</code>函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uintptr_t</span></span><br><span class="line">_main(<span class="keyword">const</span> macho_header* mainExecutableMH, <span class="keyword">uintptr_t</span> mainExecutableSlide, </span><br><span class="line">		<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[], <span class="keyword">const</span> <span class="keyword">char</span>* envp[], <span class="keyword">const</span> <span class="keyword">char</span>* apple[], </span><br><span class="line">		<span class="keyword">uintptr_t</span>* startGlue)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (dyld3::kdebug_trace_dyld_enabled(DBG_DYLD_TIMING_LAUNCH_EXECUTABLE)) &#123;</span><br><span class="line">		launchTraceID = dyld3::kdebug_trace_dyld_duration_start(DBG_DYLD_TIMING_LAUNCH_EXECUTABLE, (<span class="keyword">uint64_t</span>)mainExecutableMH, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Grab the cdHash of the main executable from the environment</span></span><br><span class="line">	<span class="keyword">uint8_t</span> mainExecutableCDHashBuffer[<span class="number">20</span>];</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">uint8_t</span>* mainExecutableCDHash = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="comment">// 获取主程序hash</span></span><br><span class="line">	<span class="keyword">if</span> ( hexToBytes(_simple_getenv(apple, <span class="string">&quot;executable_cdhash&quot;</span>), <span class="number">40</span>, mainExecutableCDHashBuffer) )</span><br><span class="line">		mainExecutableCDHash = mainExecutableCDHashBuffer;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Trace dyld&#x27;s load</span></span><br><span class="line">	<span class="comment">// 通知kernal内核dyld文件已加载</span></span><br><span class="line">	notifyKernelAboutImage((macho_header*)&amp;__dso_handle, _simple_getenv(apple, <span class="string">&quot;dyld_file&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !TARGET_IPHONE_SIMULATOR</span></span><br><span class="line">	<span class="comment">// Trace the main executable&#x27;s load</span></span><br><span class="line">	<span class="comment">// 通知kernal内核mach-o文件已加载</span></span><br><span class="line">	notifyKernelAboutImage(mainExecutableMH, _simple_getenv(apple, <span class="string">&quot;executable_file&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">uintptr_t</span> result = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">// 保存传入的可执行文件的头部（是一个struct macho_header结构体），后面根据头部访问信息</span></span><br><span class="line">	sMainExecutableMachHeader = mainExecutableMH;</span><br><span class="line">	sMainExecutableSlide = mainExecutableSlide;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __MAC_OS_X_VERSION_MIN_REQUIRED</span></span><br><span class="line">	<span class="comment">// if this is host dyld, check to see if iOS simulator is being run</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>* rootPath = _simple_getenv(envp, <span class="string">&quot;DYLD_ROOT_PATH&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> ( (rootPath != <span class="literal">NULL</span>) ) &#123;</span><br><span class="line">		<span class="comment">// look to see if simulator has its own dyld</span></span><br><span class="line">		<span class="keyword">char</span> simDyldPath[PATH_MAX]; </span><br><span class="line">		strlcpy(simDyldPath, rootPath, PATH_MAX);</span><br><span class="line">		strlcat(simDyldPath, <span class="string">&quot;/usr/lib/dyld_sim&quot;</span>, PATH_MAX);</span><br><span class="line">		<span class="keyword">int</span> fd = my_open(simDyldPath, O_RDONLY, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> ( fd != <span class="number">-1</span> ) &#123;</span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">char</span>* errMessage = useSimulatorDyld(fd, mainExecutableMH, simDyldPath, argc, argv, envp, apple, startGlue, &amp;result);</span><br><span class="line">			<span class="keyword">if</span> ( errMessage != <span class="literal">NULL</span> )</span><br><span class="line">				halt(errMessage);</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	CRSetCrashLogMessage(<span class="string">&quot;dyld: launch started&quot;</span>);</span><br><span class="line">	<span class="comment">// 主要功能1⃣️：根据可执行文件头部，参数等设置上下文信息</span></span><br><span class="line">	setContext(mainExecutableMH, argc, argv, envp, apple);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Pickup the pointer to the exec path.</span></span><br><span class="line">	<span class="comment">// 获取可执行文件路径</span></span><br><span class="line">	sExecPath = _simple_getenv(apple, <span class="string">&quot;executable_path&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// &lt;rdar://problem/13868260&gt; Remove interim apple[0] transition code from dyld</span></span><br><span class="line">	<span class="keyword">if</span> (!sExecPath) sExecPath = apple[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// mach-o 绝对路径</span></span><br><span class="line">	<span class="keyword">if</span> ( sExecPath[<span class="number">0</span>] != <span class="string">&#x27;/&#x27;</span> ) &#123;</span><br><span class="line">		<span class="comment">// have relative path, use cwd to make absolute</span></span><br><span class="line">		<span class="keyword">char</span> cwdbuff[MAXPATHLEN];</span><br><span class="line">	    <span class="keyword">if</span> ( getcwd(cwdbuff, MAXPATHLEN) != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">			<span class="comment">// maybe use static buffer to avoid calling malloc so early...</span></span><br><span class="line">			<span class="keyword">char</span>* s = <span class="keyword">new</span> <span class="keyword">char</span>[<span class="built_in">strlen</span>(cwdbuff) + <span class="built_in">strlen</span>(sExecPath) + <span class="number">2</span>];</span><br><span class="line">			<span class="built_in">strcpy</span>(s, cwdbuff);</span><br><span class="line">			<span class="built_in">strcat</span>(s, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">			<span class="built_in">strcat</span>(s, sExecPath);</span><br><span class="line">			sExecPath = s;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Remember short name of process for later logging</span></span><br><span class="line">	<span class="comment">// 获取可执行文件的名字</span></span><br><span class="line">	sExecShortName = ::<span class="built_in">strrchr</span>(sExecPath, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span> ( sExecShortName != <span class="literal">NULL</span> )</span><br><span class="line">		++sExecShortName;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		sExecShortName = sExecPath;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 主要功能1⃣️：检测进程是否受限</span></span><br><span class="line">    configureProcessRestrictions(mainExecutableMH);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __MAC_OS_X_VERSION_MIN_REQUIRED</span></span><br><span class="line">    <span class="keyword">if</span> ( !gLinkContext.allowEnvVarsPrint &amp;&amp; !gLinkContext.allowEnvVarsPath &amp;&amp; !gLinkContext.allowEnvVarsSharedCache ) &#123;</span><br><span class="line">		pruneEnvironmentVariables(envp, &amp;apple);</span><br><span class="line">		<span class="comment">// set again because envp and apple may have changed or moved</span></span><br><span class="line">		setContext(mainExecutableMH, argc, argv, envp, apple);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">#endif</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 主要功能2⃣️：检查设置环境变量</span></span><br><span class="line">		checkEnvironmentVariables(envp);</span><br><span class="line">		<span class="comment">// 如果DYLD_FALLBACK为nil，将其设置为默认值</span></span><br><span class="line">		defaultUninitializedFallbackPaths(envp);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __MAC_OS_X_VERSION_MIN_REQUIRED</span></span><br><span class="line">	<span class="keyword">if</span> (  ((dyld3::MachOFile*)mainExecutableMH)-&gt;supportsPlatform(dyld3::Platform::iOSMac)</span><br><span class="line">	  &amp;&amp; !((dyld3::MachOFile*)mainExecutableMH)-&gt;supportsPlatform(dyld3::Platform::macOS)) &#123;</span><br><span class="line">		gLinkContext.rootPaths = parseColonList(<span class="string">&quot;/System/iOSSupport&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">		gLinkContext.marzipan = <span class="literal">true</span>;</span><br><span class="line">		<span class="keyword">if</span> ( sEnv.DYLD_FALLBACK_LIBRARY_PATH == sLibraryFallbackPaths )</span><br><span class="line">			sEnv.DYLD_FALLBACK_LIBRARY_PATH = sRestrictedLibraryFallbackPaths;</span><br><span class="line">		<span class="keyword">if</span> ( sEnv.DYLD_FALLBACK_FRAMEWORK_PATH == sFrameworkFallbackPaths )</span><br><span class="line">			sEnv.DYLD_FALLBACK_FRAMEWORK_PATH = sRestrictedFrameworkFallbackPaths;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="comment">// 如果设置了DYLD_PRINT_OPTS环境变量，则打印参数</span></span><br><span class="line">	<span class="keyword">if</span> ( sEnv.DYLD_PRINT_OPTS )</span><br><span class="line">		printOptions(argv);</span><br><span class="line">	<span class="comment">// 如果设置了DYLD_PRINT_ENV环境变量，则打印环境变量</span></span><br><span class="line">	<span class="keyword">if</span> ( sEnv.DYLD_PRINT_ENV ) </span><br><span class="line">		printEnvironmentVariables(envp);</span><br><span class="line">	<span class="comment">// 主要功能2⃣️：根据Mach-O头部获取当前运行架构信息</span></span><br><span class="line">	getHostInfo(mainExecutableMH, mainExecutableSlide);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// load shared cache</span></span><br><span class="line">	<span class="comment">// 主要功能3⃣️：检查共享缓存是否开启，iOS中必须开启</span></span><br><span class="line">	checkSharedRegionDisable((dyld3::MachOLoaded*)mainExecutableMH, mainExecutableSlide);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> TARGET_IPHONE_SIMULATOR</span></span><br><span class="line">	<span class="comment">// &lt;HACK&gt; until &lt;rdar://30773711&gt; is fixed</span></span><br><span class="line">	gLinkContext.sharedRegionMode = ImageLoader::kUsePrivateSharedRegion;</span><br><span class="line">	<span class="comment">// &lt;/HACK&gt;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">if</span> ( gLinkContext.sharedRegionMode != ImageLoader::kDontUseSharedRegion ) &#123;</span><br><span class="line">		<span class="comment">// 主要功能3⃣️：加载共享缓存库</span></span><br><span class="line">		mapSharedCache();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">bool</span> cacheCompatible = (sSharedCacheLoadInfo.loadAddress == <span class="literal">nullptr</span>) || (sSharedCacheLoadInfo.loadAddress-&gt;header.formatVersion == dyld3::closure::kFormatVersion);</span><br><span class="line">	<span class="keyword">if</span> ( cacheCompatible &amp;&amp; (sEnableClosures || inWhiteList(sExecPath)) ) &#123;</span><br><span class="line">		<span class="keyword">const</span> dyld3::closure::LaunchClosure* mainClosure = <span class="literal">nullptr</span>;</span><br><span class="line">		dyld3::closure::LoadedFileInfo mainFileInfo;</span><br><span class="line">		mainFileInfo.fileContent = mainExecutableMH;</span><br><span class="line">		mainFileInfo.path = sExecPath;</span><br><span class="line">		<span class="comment">// <span class="doctag">FIXME:</span> If we are saving this closure, this slice offset/length is probably wrong in the case of FAT files.</span></span><br><span class="line">		mainFileInfo.sliceOffset = <span class="number">0</span>;</span><br><span class="line">		mainFileInfo.sliceLen = <span class="built_in">std</span>::numeric_limits&lt;__typeof(mainFileInfo.sliceLen)&gt;::max();</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">mainExeStatBuf</span>;</span></span><br><span class="line">		<span class="keyword">if</span> ( ::stat(sExecPath, &amp;mainExeStatBuf) == <span class="number">0</span> ) &#123;</span><br><span class="line">			mainFileInfo.inode = mainExeStatBuf.st_ino;</span><br><span class="line">			mainFileInfo.mtime = mainExeStatBuf.st_mtime;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// check for closure in cache first</span></span><br><span class="line">		<span class="keyword">if</span> ( sSharedCacheLoadInfo.loadAddress != <span class="literal">nullptr</span> ) &#123;</span><br><span class="line">			mainClosure = sSharedCacheLoadInfo.loadAddress-&gt;findClosure(sExecPath);</span><br><span class="line">			<span class="keyword">if</span> ( gLinkContext.verboseWarnings &amp;&amp; (mainClosure != <span class="literal">nullptr</span>) )</span><br><span class="line">				dyld::<span class="built_in">log</span>(<span class="string">&quot;dyld: found closure %p (size=%lu) in dyld shared cache\n&quot;</span>, mainClosure, mainClosure-&gt;size());</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">if</span> !TARGET_IPHONE_SIMULATOR</span></span><br><span class="line">		<span class="keyword">if</span> ( (mainClosure == <span class="literal">nullptr</span>) || !closureValid(mainClosure, mainFileInfo, mainExecutableCDHash, <span class="literal">true</span>, envp) ) &#123;</span><br><span class="line">			mainClosure = <span class="literal">nullptr</span>;</span><br><span class="line">			<span class="keyword">if</span> ( sEnableClosures || isStagedApp((dyld3::MachOFile*)mainExecutableMH, sExecPath) ) &#123;</span><br><span class="line">				<span class="comment">// if forcing closures, and no closure in cache, or it is invalid, check for cached closure</span></span><br><span class="line">				mainClosure = findCachedLaunchClosure(mainExecutableCDHash, mainFileInfo, envp);</span><br><span class="line">				<span class="keyword">if</span> ( mainClosure == <span class="literal">nullptr</span> ) &#123;</span><br><span class="line">					<span class="comment">// if  no cached closure found, build new one</span></span><br><span class="line">					mainClosure = buildLaunchClosure(mainExecutableCDHash, mainFileInfo, envp);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		<span class="comment">// try using launch closure</span></span><br><span class="line">		<span class="keyword">if</span> ( mainClosure != <span class="literal">nullptr</span> ) &#123;</span><br><span class="line">			CRSetCrashLogMessage(<span class="string">&quot;dyld3: launch started&quot;</span>);</span><br><span class="line">			<span class="keyword">bool</span> launched = launchWithClosure(mainClosure, sSharedCacheLoadInfo.loadAddress, (dyld3::MachOLoaded*)mainExecutableMH,</span><br><span class="line">											  mainExecutableSlide, argc, argv, envp, apple, &amp;result, startGlue);</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">if</span> !TARGET_IPHONE_SIMULATOR</span></span><br><span class="line">			<span class="keyword">if</span> ( !launched ) &#123;</span><br><span class="line">				<span class="comment">// closure is out of date, build new one</span></span><br><span class="line">				mainClosure = buildLaunchClosure(mainExecutableCDHash, mainFileInfo, envp);</span><br><span class="line">				<span class="keyword">if</span> ( mainClosure != <span class="literal">nullptr</span> ) &#123;</span><br><span class="line">					launched = launchWithClosure(mainClosure, sSharedCacheLoadInfo.loadAddress, (dyld3::MachOLoaded*)mainExecutableMH,</span><br><span class="line">												 mainExecutableSlide, argc, argv, envp, apple, &amp;result, startGlue);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">			<span class="keyword">if</span> ( launched ) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __has_feature(ptrauth_calls)</span></span><br><span class="line">				<span class="comment">// start() calls the result pointer as a function pointer so we need to sign it.</span></span><br><span class="line">				result = (<span class="keyword">uintptr_t</span>)__builtin_ptrauth_sign_unauthenticated((<span class="keyword">void</span>*)result, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">				<span class="keyword">if</span> (sSkipMain)</span><br><span class="line">					result = (<span class="keyword">uintptr_t</span>)&amp;fake_main;</span><br><span class="line">				<span class="keyword">return</span> result;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> ( gLinkContext.verboseWarnings )</span><br><span class="line">					dyld::<span class="built_in">log</span>(<span class="string">&quot;dyld: unable to use closure %p\n&quot;</span>, mainClosure);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> ( gLinkContext.verboseWarnings )</span><br><span class="line">			dyld::<span class="built_in">log</span>(<span class="string">&quot;dyld: not using closure because shared cache format version does not match dyld&#x27;s\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// could not use closure info, launch old way</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// install gdb notifier</span></span><br><span class="line">	stateToHandlers(dyld_image_state_dependents_mapped, sBatchHandlers)-&gt;push_back(notifyGDB);</span><br><span class="line">	stateToHandlers(dyld_image_state_mapped, sSingleHandlers)-&gt;push_back(updateAllImages);</span><br><span class="line">	<span class="comment">// make initial allocations large enough that it is unlikely to need to be re-alloced</span></span><br><span class="line">	sImageRoots.reserve(<span class="number">16</span>);</span><br><span class="line">	sAddImageCallbacks.reserve(<span class="number">4</span>);</span><br><span class="line">	sRemoveImageCallbacks.reserve(<span class="number">4</span>);</span><br><span class="line">	sAddLoadImageCallbacks.reserve(<span class="number">4</span>);</span><br><span class="line">	sImageFilesNeedingTermination.reserve(<span class="number">16</span>);</span><br><span class="line">	sImageFilesNeedingDOFUnregistration.reserve(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !TARGET_IPHONE_SIMULATOR</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> WAIT_FOR_SYSTEM_ORDER_HANDSHAKE</span></span><br><span class="line">	<span class="comment">// &lt;rdar://problem/6849505&gt; Add gating mechanism to dyld support system order file generation process</span></span><br><span class="line">	WAIT_FOR_SYSTEM_ORDER_HANDSHAKE(dyld::gProcessInfo-&gt;systemOrderFlag);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">// add dyld itself to UUID list</span></span><br><span class="line">		<span class="comment">// 主要功能4⃣️：将dyld本身添加到UUID列表</span></span><br><span class="line">		addDyldImageToUUIDList();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> SUPPORT_ACCELERATE_TABLES</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __arm64e__</span></span><br><span class="line">		<span class="comment">// Disable accelerator tables when we have threaded rebase/bind, which is arm64e executables only for now.</span></span><br><span class="line">		<span class="keyword">if</span> (sMainExecutableMachHeader-&gt;cpusubtype == CPU_SUBTYPE_ARM64_E)</span><br><span class="line">			sDisableAcceleratorTables = <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		<span class="keyword">bool</span> mainExcutableAlreadyRebased = <span class="literal">false</span>;</span><br><span class="line">		<span class="keyword">if</span> ( (sSharedCacheLoadInfo.loadAddress != <span class="literal">nullptr</span>) &amp;&amp; !dylibsCanOverrideCache() &amp;&amp; !sDisableAcceleratorTables &amp;&amp; (sSharedCacheLoadInfo.loadAddress-&gt;header.accelerateInfoAddr != <span class="number">0</span>) ) &#123;</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">statBuf</span>;</span></span><br><span class="line">			<span class="keyword">if</span> ( ::stat(IPHONE_DYLD_SHARED_CACHE_DIR <span class="string">&quot;no-dyld2-accelerator-tables&quot;</span>, &amp;statBuf) != <span class="number">0</span> )</span><br><span class="line">				sAllCacheImagesProxy = ImageLoaderMegaDylib::makeImageLoaderMegaDylib(&amp;sSharedCacheLoadInfo.loadAddress-&gt;header, sSharedCacheLoadInfo.slide, mainExecutableMH, gLinkContext);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">reloadAllImages:</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">		CRSetCrashLogMessage(sLoadingCrashMessage);</span><br><span class="line">		<span class="comment">// instantiate ImageLoader for main executable</span></span><br><span class="line">		<span class="comment">// 主要功能5⃣️：实例化主程序</span></span><br><span class="line">		<span class="comment">// 加载可执行文件并生成一个ImageLoader实例对象</span></span><br><span class="line">		<span class="comment">// 这里调用比较深,后续再看</span></span><br><span class="line">		sMainExecutable = instantiateFromLoadedImage(mainExecutableMH, mainExecutableSlide, sExecPath);</span><br><span class="line">		gLinkContext.mainExecutable = sMainExecutable;</span><br><span class="line">		gLinkContext.mainExecutableCodeSigned = hasCodeSignatureLoadCommand(mainExecutableMH);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> TARGET_IPHONE_SIMULATOR</span></span><br><span class="line">		<span class="comment">// check main executable is not too new for this OS</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> ( ! isSimulatorBinary((<span class="keyword">uint8_t</span>*)mainExecutableMH, sExecPath) ) &#123;</span><br><span class="line">				throwf(<span class="string">&quot;program was built for a platform that is not supported by this runtime&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">uint32_t</span> mainMinOS = sMainExecutable-&gt;minOSVersion();</span><br><span class="line"></span><br><span class="line">			<span class="comment">// dyld is always built for the current OS, so we can get the current OS version</span></span><br><span class="line">			<span class="comment">// from the load command in dyld itself.</span></span><br><span class="line">			<span class="keyword">uint32_t</span> dyldMinOS = ImageLoaderMachO::minOSVersion((<span class="keyword">const</span> mach_header*)&amp;__dso_handle);</span><br><span class="line">			<span class="keyword">if</span> ( mainMinOS &gt; dyldMinOS ) &#123;</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">if</span> TARGET_OS_WATCH</span></span><br><span class="line">				throwf(<span class="string">&quot;app was built for watchOS %d.%d which is newer than this simulator %d.%d&quot;</span>,</span><br><span class="line">						mainMinOS &gt;&gt; <span class="number">16</span>, ((mainMinOS &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>),</span><br><span class="line">						dyldMinOS &gt;&gt; <span class="number">16</span>, ((dyldMinOS &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>));</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">elif</span> TARGET_OS_TV</span></span><br><span class="line">				throwf(<span class="string">&quot;app was built for tvOS %d.%d which is newer than this simulator %d.%d&quot;</span>,</span><br><span class="line">						mainMinOS &gt;&gt; <span class="number">16</span>, ((mainMinOS &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>),</span><br><span class="line">						dyldMinOS &gt;&gt; <span class="number">16</span>, ((dyldMinOS &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>));</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">				throwf(<span class="string">&quot;app was built for iOS %d.%d which is newer than this simulator %d.%d&quot;</span>,</span><br><span class="line">						mainMinOS &gt;&gt; <span class="number">16</span>, ((mainMinOS &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>),</span><br><span class="line">						dyldMinOS &gt;&gt; <span class="number">16</span>, ((dyldMinOS &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>));</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">if</span> __MAC_OS_X_VERSION_MIN_REQUIRED</span></span><br><span class="line">		<span class="comment">// &lt;rdar://problem/22805519&gt; be less strict about old mach-o binaries</span></span><br><span class="line">		<span class="keyword">uint32_t</span> mainSDK = sMainExecutable-&gt;sdkVersion();</span><br><span class="line">		gLinkContext.strictMachORequired = (mainSDK &gt;= DYLD_MACOSX_VERSION_10_12) || gLinkContext.allowInsertFailures;</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		<span class="comment">// simulators, iOS, tvOS, and watchOS are always strict</span></span><br><span class="line">		gLinkContext.strictMachORequired = <span class="literal">true</span>;</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">if</span> SUPPORT_ACCELERATE_TABLES</span></span><br><span class="line">		sAllImages.reserve((sAllCacheImagesProxy != <span class="literal">NULL</span>) ? <span class="number">16</span> : INITIAL_IMAGE_COUNT);</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		sAllImages.reserve(INITIAL_IMAGE_COUNT);</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// Now that shared cache is loaded, setup an versioned dylib overrides</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">if</span> SUPPORT_VERSIONED_PATHS</span></span><br><span class="line">		<span class="comment">//检查库的版本是否有更新，有则覆盖原有的</span></span><br><span class="line">		checkVersionedPaths();</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">// dyld_all_image_infos image list does not contain dyld</span></span><br><span class="line">		<span class="comment">// add it as dyldPath field in dyld_all_image_infos</span></span><br><span class="line">		<span class="comment">// for simulator, dyld_sim is in image list, need host dyld added</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> TARGET_IPHONE_SIMULATOR</span></span><br><span class="line">		<span class="comment">// get path of host dyld from table of syscall vectors in host dyld</span></span><br><span class="line">		<span class="keyword">void</span>* addressInDyld = gSyscallHelpers;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		<span class="comment">// get path of dyld itself</span></span><br><span class="line">		<span class="keyword">void</span>*  addressInDyld = (<span class="keyword">void</span>*)&amp;__dso_handle;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		<span class="keyword">char</span> dyldPathBuffer[MAXPATHLEN+<span class="number">1</span>];</span><br><span class="line">		<span class="keyword">int</span> len = proc_regionfilename(getpid(), (<span class="keyword">uint64_t</span>)(<span class="keyword">long</span>)addressInDyld, dyldPathBuffer, MAXPATHLEN);</span><br><span class="line">		<span class="keyword">if</span> ( len &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">			dyldPathBuffer[len] = <span class="string">&#x27;\0&#x27;</span>; <span class="comment">// proc_regionfilename() does not zero terminate returned string</span></span><br><span class="line">			<span class="keyword">if</span> ( <span class="built_in">strcmp</span>(dyldPathBuffer, gProcessInfo-&gt;dyldPath) != <span class="number">0</span> )</span><br><span class="line">				gProcessInfo-&gt;dyldPath = strdup(dyldPathBuffer);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// load any inserted libraries</span></span><br><span class="line">		<span class="comment">// 主要功能6⃣️：插入动态库:加载所有 DYLD_INSERT_LIBRARIES 指定的库</span></span><br><span class="line">		<span class="keyword">if</span>	( sEnv.DYLD_INSERT_LIBRARIES != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span>* lib = sEnv.DYLD_INSERT_LIBRARIES; *lib != <span class="literal">NULL</span>; ++lib) </span><br><span class="line">				loadInsertedDylib(*lib);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// record count of inserted libraries so that a flat search will look at </span></span><br><span class="line">		<span class="comment">// inserted libraries, then main, then others.</span></span><br><span class="line">		sInsertedDylibCount = sAllImages.size()<span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// link main executable</span></span><br><span class="line">		gLinkContext.linkingMainExecutable = <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> SUPPORT_ACCELERATE_TABLES</span></span><br><span class="line">		<span class="keyword">if</span> ( mainExcutableAlreadyRebased ) &#123;</span><br><span class="line">			<span class="comment">// previous link() on main executable has already adjusted its internal pointers for ASLR</span></span><br><span class="line">			<span class="comment">// work around that by rebasing by inverse amount</span></span><br><span class="line">			sMainExecutable-&gt;rebase(gLinkContext, -mainExecutableSlide);</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		<span class="comment">// 主要功能7⃣️：链接主程序</span></span><br><span class="line">		<span class="comment">// link调用比较深,后续来看</span></span><br><span class="line">		link(sMainExecutable, sEnv.DYLD_BIND_AT_LAUNCH, <span class="literal">true</span>, ImageLoader::RPathChain(<span class="literal">NULL</span>, <span class="literal">NULL</span>), <span class="number">-1</span>);</span><br><span class="line">		sMainExecutable-&gt;setNeverUnloadRecursive();</span><br><span class="line">		<span class="keyword">if</span> ( sMainExecutable-&gt;forceFlat() ) &#123;</span><br><span class="line">			gLinkContext.bindFlat = <span class="literal">true</span>;</span><br><span class="line">			gLinkContext.prebindUsage = ImageLoader::kUseNoPrebinding;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// link any inserted libraries</span></span><br><span class="line">		<span class="comment">// do this after linking main executable so that any dylibs pulled in by inserted </span></span><br><span class="line">		<span class="comment">// dylibs (e.g. libSystem) will not be in front of dylibs the program uses</span></span><br><span class="line">		<span class="comment">// 主要功能7⃣️：链接主程序和所有插入的动态库</span></span><br><span class="line">		<span class="keyword">if</span> ( sInsertedDylibCount &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>; i &lt; sInsertedDylibCount; ++i) &#123;</span><br><span class="line">				ImageLoader* image = sAllImages[i+<span class="number">1</span>];</span><br><span class="line">				link(image, sEnv.DYLD_BIND_AT_LAUNCH, <span class="literal">true</span>, ImageLoader::RPathChain(<span class="literal">NULL</span>, <span class="literal">NULL</span>), <span class="number">-1</span>);</span><br><span class="line">				image-&gt;setNeverUnloadRecursive();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// only INSERTED libraries can interpose</span></span><br><span class="line">			<span class="comment">// register interposing info after all inserted libraries are bound so chaining works</span></span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>; i &lt; sInsertedDylibCount; ++i) &#123;</span><br><span class="line">				ImageLoader* image = sAllImages[i+<span class="number">1</span>];</span><br><span class="line">				<span class="comment">// 注册符号插入</span></span><br><span class="line">				image-&gt;registerInterposing(gLinkContext);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// &lt;rdar://problem/19315404&gt; dyld should support interposition even without DYLD_INSERT_LIBRARIES</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">long</span> i=sInsertedDylibCount+<span class="number">1</span>; i &lt; sAllImages.size(); ++i) &#123;</span><br><span class="line">			ImageLoader* image = sAllImages[i];</span><br><span class="line">			<span class="keyword">if</span> ( image-&gt;inSharedCache() )</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			image-&gt;registerInterposing(gLinkContext);</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">if</span> SUPPORT_ACCELERATE_TABLES</span></span><br><span class="line">		<span class="keyword">if</span> ( (sAllCacheImagesProxy != <span class="literal">NULL</span>) &amp;&amp; ImageLoader::haveInterposingTuples() ) &#123;</span><br><span class="line">			<span class="comment">// Accelerator tables cannot be used with implicit interposing, so relaunch with accelerator tables disabled</span></span><br><span class="line">			ImageLoader::clearInterposingTuples();</span><br><span class="line">			<span class="comment">// unmap all loaded dylibs (but not main executable)</span></span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">long</span> i=<span class="number">1</span>; i &lt; sAllImages.size(); ++i) &#123;</span><br><span class="line">				ImageLoader* image = sAllImages[i];</span><br><span class="line">				<span class="keyword">if</span> ( image == sMainExecutable )</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				<span class="keyword">if</span> ( image == sAllCacheImagesProxy )</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				image-&gt;setCanUnload();</span><br><span class="line">				ImageLoader::deleteImage(image);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// note: we don&#x27;t need to worry about inserted images because if DYLD_INSERT_LIBRARIES was set we would not be using the accelerator table</span></span><br><span class="line">			sAllImages.clear();</span><br><span class="line">			sImageRoots.clear();</span><br><span class="line">			sImageFilesNeedingTermination.clear();</span><br><span class="line">			sImageFilesNeedingDOFUnregistration.clear();</span><br><span class="line">			sAddImageCallbacks.clear();</span><br><span class="line">			sRemoveImageCallbacks.clear();</span><br><span class="line">			sAddLoadImageCallbacks.clear();</span><br><span class="line">			sDisableAcceleratorTables = <span class="literal">true</span>;</span><br><span class="line">			sAllCacheImagesProxy = <span class="literal">NULL</span>;</span><br><span class="line">			sMappedRangesStart = <span class="literal">NULL</span>;</span><br><span class="line">			mainExcutableAlreadyRebased = <span class="literal">true</span>;</span><br><span class="line">			gLinkContext.linkingMainExecutable = <span class="literal">false</span>;</span><br><span class="line">			resetAllImages();</span><br><span class="line">			<span class="keyword">goto</span> reloadAllImages;</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// apply interposing to initial set of images</span></span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; sImageRoots.size(); ++i) &#123;</span><br><span class="line">			<span class="comment">//应用符号插入</span></span><br><span class="line">			sImageRoots[i]-&gt;applyInterposing(gLinkContext);</span><br><span class="line">		&#125;</span><br><span class="line">		ImageLoader::applyInterposingToDyldCache(gLinkContext);</span><br><span class="line">		gLinkContext.linkingMainExecutable = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Bind and notify for the main executable now that interposing has been registered</span></span><br><span class="line">		<span class="keyword">uint64_t</span> bindMainExecutableStartTime = mach_absolute_time();</span><br><span class="line">		sMainExecutable-&gt;recursiveBindWithAccounting(gLinkContext, sEnv.DYLD_BIND_AT_LAUNCH, <span class="literal">true</span>);</span><br><span class="line">		<span class="keyword">uint64_t</span> bindMainExecutableEndTime = mach_absolute_time();</span><br><span class="line">		ImageLoaderMachO::fgTotalBindTime += bindMainExecutableEndTime - bindMainExecutableStartTime;</span><br><span class="line">		gLinkContext.notifyBatch(dyld_image_state_bound, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Bind and notify for the inserted images now interposing has been registered</span></span><br><span class="line">		<span class="keyword">if</span> ( sInsertedDylibCount &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>; i &lt; sInsertedDylibCount; ++i) &#123;</span><br><span class="line">				ImageLoader* image = sAllImages[i+<span class="number">1</span>];</span><br><span class="line">				<span class="comment">// 递归绑定符号表</span></span><br><span class="line">				image-&gt;recursiveBind(gLinkContext, sEnv.DYLD_BIND_AT_LAUNCH, <span class="literal">true</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// &lt;rdar://problem/12186933&gt; do weak binding only after all inserted images linked</span></span><br><span class="line">		<span class="comment">// 弱符号绑定</span></span><br><span class="line">		sMainExecutable-&gt;weakBind(gLinkContext);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// If cache has branch island dylibs, tell debugger about them</span></span><br><span class="line">		<span class="keyword">if</span> ( (sSharedCacheLoadInfo.loadAddress != <span class="literal">NULL</span>) &amp;&amp; (sSharedCacheLoadInfo.loadAddress-&gt;header.mappingOffset &gt;= <span class="number">0x78</span>) &amp;&amp; (sSharedCacheLoadInfo.loadAddress-&gt;header.branchPoolsOffset != <span class="number">0</span>) ) &#123;</span><br><span class="line">			<span class="keyword">uint32_t</span> count = sSharedCacheLoadInfo.loadAddress-&gt;header.branchPoolsCount;</span><br><span class="line">			dyld_image_info info[count];</span><br><span class="line">			<span class="keyword">const</span> <span class="keyword">uint64_t</span>* poolAddress = (<span class="keyword">uint64_t</span>*)((<span class="keyword">char</span>*)sSharedCacheLoadInfo.loadAddress + sSharedCacheLoadInfo.loadAddress-&gt;header.branchPoolsOffset);</span><br><span class="line">			<span class="comment">// &lt;rdar://problem/20799203&gt; empty branch pools can be in development cache</span></span><br><span class="line">			<span class="keyword">if</span> ( ((mach_header*)poolAddress)-&gt;magic == sMainExecutableMachHeader-&gt;magic ) &#123;</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> poolIndex=<span class="number">0</span>; poolIndex &lt; count; ++poolIndex) &#123;</span><br><span class="line">					<span class="keyword">uint64_t</span> poolAddr = poolAddress[poolIndex] + sSharedCacheLoadInfo.slide;</span><br><span class="line">					info[poolIndex].imageLoadAddress = (mach_header*)(<span class="keyword">long</span>)poolAddr;</span><br><span class="line">					info[poolIndex].imageFilePath = <span class="string">&quot;dyld_shared_cache_branch_islands&quot;</span>;</span><br><span class="line">					info[poolIndex].imageFileModDate = <span class="number">0</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">// add to all_images list</span></span><br><span class="line">				addImagesToAllImages(count, info);</span><br><span class="line">				<span class="comment">// tell gdb about new branch island images</span></span><br><span class="line">				gProcessInfo-&gt;notification(dyld_image_adding, count, info);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		CRSetCrashLogMessage(<span class="string">&quot;dyld: launch, running initializers&quot;</span>);</span><br><span class="line">		<span class="comment">// 初始化主程序</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">if</span> SUPPORT_OLD_CRT_INITIALIZATION</span></span><br><span class="line">		<span class="comment">// Old way is to run initializers via a callback from crt1.o</span></span><br><span class="line">		<span class="keyword">if</span> ( ! gRunInitializersOldWay ) </span><br><span class="line">			initializeMainExecutable(); </span><br><span class="line">	<span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		<span class="comment">// run all initializers</span></span><br><span class="line">		<span class="comment">// 主要功能8⃣️：执行初始化方法！！</span></span><br><span class="line">		initializeMainExecutable(); </span><br><span class="line">	<span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// notify any montoring proccesses that this process is about to enter main()</span></span><br><span class="line">		<span class="keyword">if</span> (dyld3::kdebug_trace_dyld_enabled(DBG_DYLD_TIMING_LAUNCH_EXECUTABLE)) &#123;</span><br><span class="line">			dyld3::kdebug_trace_dyld_duration_end(launchTraceID, DBG_DYLD_TIMING_LAUNCH_EXECUTABLE, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		notifyMonitoringDyldMain();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// find entry point for main executable</span></span><br><span class="line">		<span class="comment">// 主要功能9⃣️：寻找目标可执行文件入口并执行</span></span><br><span class="line">		<span class="comment">// 从 mach-o 中读取程序入口, 主程序则读取LC_UNIXTHREAD, 就是 main.m</span></span><br><span class="line">		result = (<span class="keyword">uintptr_t</span>)sMainExecutable-&gt;getEntryFromLC_MAIN();</span><br><span class="line">		<span class="keyword">if</span> ( result != <span class="number">0</span> ) &#123;</span><br><span class="line">			<span class="comment">// main executable uses LC_MAIN, we need to use helper in libdyld to call into main()</span></span><br><span class="line">			<span class="keyword">if</span> ( (gLibSystemHelpers != <span class="literal">NULL</span>) &amp;&amp; (gLibSystemHelpers-&gt;version &gt;= <span class="number">9</span>) )</span><br><span class="line">				*startGlue = (<span class="keyword">uintptr_t</span>)gLibSystemHelpers-&gt;startGlueToCallExit;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				halt(<span class="string">&quot;libdyld.dylib support not present for LC_MAIN&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// main executable uses LC_UNIXTHREAD, dyld needs to let &quot;start&quot; in program set up for main()</span></span><br><span class="line">			<span class="comment">// 找到真正 main 函数入口</span></span><br><span class="line">			result = (<span class="keyword">uintptr_t</span>)sMainExecutable-&gt;getEntryFromLC_UNIXTHREAD();</span><br><span class="line">			*startGlue = <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __has_feature(ptrauth_calls)</span></span><br><span class="line">		<span class="comment">// start() calls the result pointer as a function pointer so we need to sign it.</span></span><br><span class="line">		result = (<span class="keyword">uintptr_t</span>)__builtin_ptrauth_sign_unauthenticated((<span class="keyword">void</span>*)result, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span>(<span class="keyword">const</span> <span class="keyword">char</span>* message) &#123;</span><br><span class="line">		syncAllImages();</span><br><span class="line">		halt(message);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span>(...) &#123;</span><br><span class="line">		dyld::<span class="built_in">log</span>(<span class="string">&quot;dyld: launch failed\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	CRSetCrashLogMessage(<span class="string">&quot;dyld2 mode&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sSkipMain) &#123;</span><br><span class="line">		<span class="keyword">if</span> (dyld3::kdebug_trace_dyld_enabled(DBG_DYLD_TIMING_LAUNCH_EXECUTABLE)) &#123;</span><br><span class="line">			dyld3::kdebug_trace_dyld_duration_end(launchTraceID, DBG_DYLD_TIMING_LAUNCH_EXECUTABLE, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		result = (<span class="keyword">uintptr_t</span>)&amp;fake_main;</span><br><span class="line">		*startGlue = (<span class="keyword">uintptr_t</span>)gLibSystemHelpers-&gt;startGlueToCallExit;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 找到真正 main 函数入口后返回</span></span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dyld::_main()</code>主要流程为：</p>
<ul>
<li>设置上下文信息，检测进程是否受限</li>
<li>配置环境变量，获取当前运行架构</li>
<li>检查是否开启共享缓存，并加载共享缓存库</li>
<li>将 dyld 本身添加到 UUID 列表</li>
<li>实例化主程序</li>
<li>加载插入动态库</li>
<li>链接主程序和插入的库，执行符号替换</li>
<li>执行初始化方法</li>
<li>寻找主程序入口</li>
</ul>
<h4 id="3-1-设置上下文信息，检测进程是否受限"><a href="#3-1-设置上下文信息，检测进程是否受限" class="headerlink" title="3.1 设置上下文信息，检测进程是否受限"></a>3.1 设置上下文信息，检测进程是否受限</h4><ul>
<li>调用<code>setContext</code>函数，传入Mach-O头部以及一些参数设置上下文</li>
<li><code>configureProcessRestrictions</code>检测进程是否受限，在上下文中做出对应处理</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// _main函数中</span></span><br><span class="line">setContext(mainExecutableMH, argc, argv, envp, apple);</span><br><span class="line">...</span><br><span class="line">configureProcessRestrictions(mainExecutableMH);</span><br></pre></td></tr></table></figure>

<h4 id="3-2-配置环境变量，获取当前运行架构"><a href="#3-2-配置环境变量，获取当前运行架构" class="headerlink" title="3.2 配置环境变量，获取当前运行架构"></a>3.2 配置环境变量，获取当前运行架构</h4><ul>
<li>从环境变量中获取主要可执行文件的<code>cdHash</code></li>
<li><code>checkEnvironmentVariables(envp)</code>检查设置环境变量</li>
<li><code>defaultUninitializedFallbackPaths(envp)</code>在<code>DYLD_FALLBACK</code>为空时设置默认值</li>
<li><code>getHostInfo(mainExecutableMH, mainExecutableSlide)</code>获取程序架构</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// _main函数中</span></span><br><span class="line"><span class="comment">//如果设置了DYLD_PRINT_OPTS环境变量，则打印参数</span></span><br><span class="line"><span class="keyword">if</span> ( sEnv.DYLD_PRINT_OPTS )</span><br><span class="line">    printOptions(argv);</span><br><span class="line"><span class="comment">//如果设置了DYLD_PRINT_ENV环境变量，则打印环境变量</span></span><br><span class="line"><span class="keyword">if</span> ( sEnv.DYLD_PRINT_ENV ) </span><br><span class="line">    printEnvironmentVariables(envp);</span><br></pre></td></tr></table></figure>

<p>只要设置了这两个环境变量参数，在App启动时就会打印相关参数、环境变量信息（自行尝试）</p>
<p><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210115182408705.png"></p>
<h4 id="3-3-检查是否开启共享缓存，并加载共享缓存库"><a href="#3-3-检查是否开启共享缓存，并加载共享缓存库" class="headerlink" title="3.3 检查是否开启共享缓存，并加载共享缓存库"></a>3.3 检查是否开启共享缓存，并加载共享缓存库</h4><ul>
<li><code>checkSharedRegionDisable</code>检查是否开启共享缓存（iOS 下不会被禁用）</li>
<li><code>mapSharedCache</code>加载共享缓存库，其中调用<code>loadDyldCache</code>函数有这么几种情况：<ul>
<li>仅加载到当前进程<code>mapCachePrivate</code>（模拟器仅支持加载到当前进程）</li>
<li>共享缓存是第一次被加载，就去做加载操作<code>mapCacheSystemWide</code></li>
<li>共享缓存不是第一次被加载，那么就不做任何处理</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210115182546068.png"></p>
<h4 id="3-4-将dyld本身添加到UUID列表"><a href="#3-4-将dyld本身添加到UUID列表" class="headerlink" title="3.4 将dyld本身添加到UUID列表"></a>3.4 将dyld本身添加到UUID列表</h4><p><code>addDyldImageToUUIDList</code>将dyld本身添加到UUID列表</p>
<h4 id="3-5-实例化主程序"><a href="#3-5-实例化主程序" class="headerlink" title="3.5 实例化主程序"></a>3.5 实例化主程序</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sMainExecutable = instantiateFromLoadedImage(mainExecutableMH, mainExecutableSlide, sExecPath);</span><br></pre></td></tr></table></figure>

<p>实例化主程序 , 检测可执行程序格式 .</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> ImageLoaderMachO* <span class="title">instantiateFromLoadedImage</span><span class="params">(<span class="keyword">const</span> macho_header* mh, <span class="keyword">uintptr_t</span> slide, <span class="keyword">const</span> <span class="keyword">char</span>* path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// try mach-o loader</span></span><br><span class="line">	<span class="keyword">if</span> ( isCompatibleMachO((<span class="keyword">const</span> <span class="keyword">uint8_t</span>*)mh, path) ) &#123;</span><br><span class="line">		ImageLoader* image = ImageLoaderMachO::instantiateMainExecutable(mh, slide, path, gLinkContext);</span><br><span class="line">		addImage(image);</span><br><span class="line">		<span class="keyword">return</span> (ImageLoaderMachO*)image;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">throw</span> <span class="string">&quot;main executable not a known format&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>isCompatibleMachO</code> 里就会通过 <code>header</code> 里的 <code>magic</code> , <code>cputype</code> , <code>cpusubtype</code> 去检测是否兼容</p>
<p><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116141000385.png"></p>
<p><code>instantiateMainExecutable</code>中调用<code>ImageLoaderMachO::sniffLoadCommands</code>，这才是真正实例化主程序的函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// determine if this mach-o file has classic or compressed LINKEDIT and number of segments it has</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ImageLoaderMachO::sniffLoadCommands</span><span class="params">(<span class="keyword">const</span> macho_header* mh, <span class="keyword">const</span> <span class="keyword">char</span>* path, <span class="keyword">bool</span> inCache, <span class="keyword">bool</span>* compressed,</span></span></span><br><span class="line"><span class="function"><span class="params">											<span class="keyword">unsigned</span> <span class="keyword">int</span>* segCount, <span class="keyword">unsigned</span> <span class="keyword">int</span>* libCount, <span class="keyword">const</span> LinkContext&amp; context,</span></span></span><br><span class="line"><span class="function"><span class="params">											<span class="keyword">const</span> linkedit_data_command** codeSigCmd,</span></span></span><br><span class="line"><span class="function"><span class="params">											<span class="keyword">const</span> encryption_info_command** encryptCmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *compressed = <span class="literal">false</span>;</span><br><span class="line">    *segCount = <span class="number">0</span>;</span><br><span class="line">    *libCount = <span class="number">0</span>;</span><br><span class="line">    *codeSigCmd = <span class="literal">NULL</span>;</span><br><span class="line">    *encryptCmd = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    ...</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="comment">// fSegmentsArrayCount is only 8-bits</span></span><br><span class="line">    <span class="keyword">if</span> ( *segCount &gt; <span class="number">255</span> )</span><br><span class="line">    	dyld::throwf(<span class="string">&quot;malformed mach-o image: more than 255 segments in %s&quot;</span>, path);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// fSegmentsArrayCount is only 8-bits</span></span><br><span class="line">    <span class="keyword">if</span> ( *libCount &gt; <span class="number">4095</span> )</span><br><span class="line">    	dyld::throwf(<span class="string">&quot;malformed mach-o image: more than 4095 dependent libraries in %s&quot;</span>, path);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ( needsAddedLibSystemDepency(*libCount, mh) )</span><br><span class="line">    	*libCount = <span class="number">1</span>;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里几个字段都与<code>MachO</code>有关：</p>
<ul>
<li><code>compressed</code>：根据<code>LC_DYLD_INFO_ONYL</code>来决定</li>
<li><code>segCount</code>: MachO文件中<code>segment</code>数量，最多不超过255个</li>
<li><code>libCount</code>: MachO文件中<code>依赖的动态库</code>的数量</li>
<li><code>codeSigCmd</code>: 签名信息</li>
<li><code>encryptCmd</code>: 加密信息，如cryptid等</li>
</ul>
<p>经过以上步骤 , 主程序的实例化就已经完成了 </p>
<h4 id="3-6-加载插入动态库"><a href="#3-6-加载插入动态库" class="headerlink" title="3.6 加载插入动态库"></a>3.6 加载插入动态库</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// _main函数中</span></span><br><span class="line"><span class="comment">// load any inserted libraries</span></span><br><span class="line"><span class="keyword">if</span> ( sEnv.DYLD_INSERT_LIBRARIES != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span>* lib = sEnv.DYLD_INSERT_LIBRARIES; *lib != <span class="literal">NULL</span>; ++lib) </span><br><span class="line">        loadInsertedDylib(*lib);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>遍历<code>DYLD_INSERT_LIBRARIES</code>环境变量，调用<code>loadInsertedDylib</code>加载，通过该环境变量我们可以注入自定义的一些动态库代码从而完成安全攻防，<code>loadInsertedDylib</code>内部会从<code>DYLD_ROOT_PATH</code>、<code>LD_LIBRARY_PATH</code>、<code>DYLD_FRAMEWORK_PATH</code>等路径查找<code>dylib</code>并且检查代码签名，无效则直接抛出异常</p>
<h4 id="3-7-链接主程序和插入的库，执行符号替换"><a href="#3-7-链接主程序和插入的库，执行符号替换" class="headerlink" title="3.7 链接主程序和插入的库，执行符号替换"></a>3.7 链接主程序和插入的库，执行符号替换</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// link main executable</span></span><br><span class="line">gLinkContext.linkingMainExecutable = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">link(sMainExecutable, sEnv.DYLD_BIND_AT_LAUNCH, <span class="literal">true</span>, ImageLoader::RPathChain(<span class="literal">NULL</span>, <span class="literal">NULL</span>), <span class="number">-1</span>);</span><br><span class="line">sMainExecutable-&gt;setNeverUnloadRecursive();</span><br><span class="line"><span class="keyword">if</span> ( sMainExecutable-&gt;forceFlat() ) &#123;</span><br><span class="line">	gLinkContext.bindFlat = <span class="literal">true</span>;</span><br><span class="line">	gLinkContext.prebindUsage = ImageLoader::kUseNoPrebinding;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( sInsertedDylibCount &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>; i &lt; sInsertedDylibCount; ++i) &#123;</span><br><span class="line">		ImageLoader* image = sAllImages[i+<span class="number">1</span>];</span><br><span class="line">		link(image, sEnv.DYLD_BIND_AT_LAUNCH, <span class="literal">true</span>, ImageLoader::RPathChain(<span class="literal">NULL</span>, <span class="literal">NULL</span>), <span class="number">-1</span>);</span><br><span class="line">		image-&gt;setNeverUnloadRecursive();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>; i &lt; sInsertedDylibCount; ++i) &#123;</span><br><span class="line">		ImageLoader* image = sAllImages[i+<span class="number">1</span>];</span><br><span class="line">		image-&gt;registerInterposing(gLinkContext);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击进入 <code>link</code> 函数 , <code>link</code> 函数中有一系列 <code>recursiveLoadLibraries</code> , <code>recursiveBindWithAccounting -&gt; recursiveBind</code> , 也就是递归进行符号绑定的过程 .</p>
<p><code>link</code> 函数执行完毕之后 , <code>dyld :: main</code> 会调用 <code>sMainExecutable-&gt;weakBind(gLinkContext);</code> 进行弱绑定 , 懒加载绑定 , 也就是说弱绑定一定发生在 其他库链接绑定完成之后 .</p>
<p>绑定的过程就是我们之前分析的共享缓存绑定的过程 .</p>
<blockquote>
<p>走到了这里 , 主程序已经实例化完毕 , 但还没有加载 , <code>framework</code> 已经加载完毕了 , 那讲到这插一句题外话 , 不同 <code>framework</code> , 谁先会被加载 ? 其实根据二进制顺序有关 , <code>Xcode</code> 中可以自由调整 :</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116142834262.png">拖动就可以自己调整顺序了 , 编译顺序就会根据这个顺序来 , 同样你可以使用 <code>MachOView</code> 来查看二进制顺序 .</p>
<p><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116142853014.png"></p>
<p>至此 , 配置环境变量 -&gt; 加载共享缓存 -&gt; 实例化主程序 -&gt; 加载动态库 -&gt; 链接动态库 就已经完成了 .</p>
<blockquote>
<p>接下来是重中之重</p>
</blockquote>
<h4 id="3-8-执行初始化方法"><a href="#3-8-执行初始化方法" class="headerlink" title="3.8 执行初始化方法"></a>3.8 执行初始化方法</h4><p>回顾一下函数调用栈：</p>
<p><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116174014570.png"></p>
<p>①<code>initializeMainExecutable</code>方法调用<code>runInitializers</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initializeMainExecutable</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// record that we&#x27;ve reached this step</span></span><br><span class="line">	gLinkContext.startedInitializingMainExecutable = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// run initialzers for any inserted dylibs</span></span><br><span class="line">	ImageLoader::InitializerTimingList initializerTimes[allImagesCount()];</span><br><span class="line">	initializerTimes[<span class="number">0</span>].count = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">size_t</span> rootCount = sImageRoots.size();</span><br><span class="line">	<span class="keyword">if</span> ( rootCount &gt; <span class="number">1</span> ) &#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">size_t</span> i=<span class="number">1</span>; i &lt; rootCount; ++i) &#123;</span><br><span class="line">			sImageRoots[i]-&gt;runInitializers(gLinkContext, initializerTimes[<span class="number">0</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// run initializers for main executable and everything it brings up </span></span><br><span class="line">	sMainExecutable-&gt;runInitializers(gLinkContext, initializerTimes[<span class="number">0</span>]);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// register cxa_atexit() handler to run static terminators in all loaded images when this process exits</span></span><br><span class="line">	<span class="keyword">if</span> ( gLibSystemHelpers != <span class="literal">NULL</span> ) </span><br><span class="line">		(*gLibSystemHelpers-&gt;cxa_atexit)(&amp;runAllStaticTerminators, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// dump info if requested</span></span><br><span class="line">	<span class="keyword">if</span> ( sEnv.DYLD_PRINT_STATISTICS )</span><br><span class="line">		ImageLoader::printStatistics((<span class="keyword">unsigned</span> <span class="keyword">int</span>)allImagesCount(), initializerTimes[<span class="number">0</span>]);</span><br><span class="line">	<span class="keyword">if</span> ( sEnv.DYLD_PRINT_STATISTICS_DETAILS )</span><br><span class="line">		ImageLoaderMachO::printStatisticsDetails((<span class="keyword">unsigned</span> <span class="keyword">int</span>)allImagesCount(), initializerTimes[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>②<code>runInitializers</code>调用<code>processInitializers</code>为初始化做准备</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ImageLoader::runInitializers</span><span class="params">(<span class="keyword">const</span> LinkContext&amp; context, InitializerTimingList&amp; timingInfo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint64_t</span> t1 = mach_absolute_time();</span><br><span class="line">	<span class="keyword">mach_port_t</span> thisThread = mach_thread_self();</span><br><span class="line">	ImageLoader::UninitedUpwards up;</span><br><span class="line">	up.count = <span class="number">1</span>;</span><br><span class="line">	up.images[<span class="number">0</span>] = <span class="keyword">this</span>;</span><br><span class="line">	processInitializers(context, thisThread, timingInfo, up);</span><br><span class="line">	context.notifyBatch(dyld_image_state_initialized, <span class="literal">false</span>);</span><br><span class="line">	mach_port_deallocate(mach_task_self(), thisThread);</span><br><span class="line">	<span class="keyword">uint64_t</span> t2 = mach_absolute_time();</span><br><span class="line">	fgTotalInitTime += (t2 - t1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>③<code>processInitializers</code>中遍历<code>image</code>，<code>recursiveInitialization</code>递归初始化镜像</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ImageLoader::processInitializers</span><span class="params">(<span class="keyword">const</span> LinkContext&amp; context, <span class="keyword">mach_port_t</span> thisThread,</span></span></span><br><span class="line"><span class="function"><span class="params">									 InitializerTimingList&amp; timingInfo, ImageLoader::UninitedUpwards&amp; images)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint32_t</span> maxImageCount = context.imageCount()+<span class="number">2</span>;</span><br><span class="line">	ImageLoader::UninitedUpwards upsBuffer[maxImageCount];</span><br><span class="line">	ImageLoader::UninitedUpwards&amp; ups = upsBuffer[<span class="number">0</span>];</span><br><span class="line">	ups.count = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">// Calling recursive init on all images in images list, building a new list of</span></span><br><span class="line">	<span class="comment">// uninitialized upward dependencies.</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">uintptr_t</span> i=<span class="number">0</span>; i &lt; images.count; ++i) &#123;</span><br><span class="line">		images.images[i]-&gt;recursiveInitialization(context, thisThread, images.images[i]-&gt;getPath(), timingInfo, ups);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// If any upward dependencies remain, init them.</span></span><br><span class="line">	<span class="keyword">if</span> ( ups.count &gt; <span class="number">0</span> )</span><br><span class="line">		processInitializers(context, thisThread, timingInfo, ups);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点进去却只有声明，<code>shift+cmd+O</code>搜索<code>recursiveInitialization</code></p>
<p>④<code>recursiveInitialization</code>获取到镜像的初始化</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ImageLoader::recursiveInitialization</span><span class="params">(<span class="keyword">const</span> LinkContext&amp; context, <span class="keyword">mach_port_t</span> this_thread, <span class="keyword">const</span> <span class="keyword">char</span>* pathToInitialize,</span></span></span><br><span class="line"><span class="function"><span class="params">										  InitializerTimingList&amp; timingInfo, UninitedUpwards&amp; uninitUps)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">uint64_t</span> t1 = mach_absolute_time();</span><br><span class="line">	fState = dyld_image_state_dependents_initialized;</span><br><span class="line">	oldState = fState;</span><br><span class="line">	context.notifySingle(dyld_image_state_dependents_initialized, <span class="keyword">this</span>, &amp;timingInfo);</span><br><span class="line">	<span class="comment">// initialize this image</span></span><br><span class="line">	<span class="keyword">bool</span> hasInitializers = <span class="keyword">this</span>-&gt;doInitialization(context);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// let anyone know we finished initializing this image</span></span><br><span class="line">	fState = dyld_image_state_initialized;</span><br><span class="line">	oldState = fState;</span><br><span class="line">	context.notifySingle(dyld_image_state_initialized, <span class="keyword">this</span>, <span class="literal">NULL</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>⑤<code>notifySingle</code>获取到镜像的回调</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">notifySingle</span><span class="params">(dyld_image_states state, <span class="keyword">const</span> ImageLoader* image, ImageLoader::InitializerTimingList* timingInfo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> ( (state == dyld_image_state_dependents_initialized) &amp;&amp; (sNotifyObjCInit != <span class="literal">NULL</span>) &amp;&amp; image-&gt;notifyObjC() ) &#123;</span><br><span class="line">    	<span class="keyword">uint64_t</span> t0 = mach_absolute_time();</span><br><span class="line">    	<span class="function">dyld3::ScopedTimer <span class="title">timer</span><span class="params">(DBG_DYLD_TIMING_OBJC_INIT, (<span class="keyword">uint64_t</span>)image-&gt;machHeader(), <span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">    	(*sNotifyObjCInit)(image-&gt;getRealPath(), image-&gt;machHeader());</span><br><span class="line">    	<span class="keyword">uint64_t</span> t1 = mach_absolute_time();</span><br><span class="line">    	<span class="keyword">uint64_t</span> t2 = mach_absolute_time();</span><br><span class="line">    	<span class="keyword">uint64_t</span> timeInObjC = t1-t0;</span><br><span class="line">    	<span class="keyword">uint64_t</span> emptyTime = (t2-t1)*<span class="number">100</span>;</span><br><span class="line">    	<span class="keyword">if</span> ( (timeInObjC &gt; emptyTime) &amp;&amp; (timingInfo != <span class="literal">NULL</span>) ) &#123;</span><br><span class="line">    		timingInfo-&gt;addTime(image-&gt;getShortName(), timeInObjC);</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>notifySingle中并没有找到函数调用栈中的load_images，其实这是一个回调函数的调用</p>
</blockquote>
<p>【⑥】<code>sNotifyObjCInit</code>在<code>registerObjCNotifiers</code>函数中赋值</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">registerObjCNotifiers</span><span class="params">(_dyld_objc_notify_mapped mapped, _dyld_objc_notify_init init, _dyld_objc_notify_unmapped unmapped)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// record functions to call</span></span><br><span class="line">	sNotifyObjCMapped	= mapped;</span><br><span class="line">	sNotifyObjCInit		= init;</span><br><span class="line">	sNotifyObjCUnmapped = unmapped;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>⑦<code>registerObjCNotifiers</code>在<code>_dyld_objc_notify_register</code>函数中被调用，这个函数只在运行时提供给objc使用</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _dyld_objc_notify_register(_dyld_objc_notify_mapped    mapped,</span><br><span class="line">                                _dyld_objc_notify_init      init,</span><br><span class="line">                                _dyld_objc_notify_unmapped  unmapped)</span><br><span class="line">&#123;</span><br><span class="line">	dyld::registerObjCNotifiers(mapped, init, unmapped);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// _objc_init 调用`_dyld_objc_notify_register`，并调用`load_image`</span></span><br><span class="line"><span class="keyword">void</span> _objc_init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">bool</span> initialized = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (initialized) <span class="keyword">return</span>;</span><br><span class="line">    initialized = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// fixme defer initialization until an objc-using image is found?</span></span><br><span class="line">    environ_init();</span><br><span class="line">    tls_init();</span><br><span class="line">    static_init();</span><br><span class="line">    lock_init();</span><br><span class="line">    exception_init();</span><br><span class="line">    </span><br><span class="line">    _dyld_objc_notify_register(&amp;map_images, load_images, unmap_image);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>⑧<code>context.notifySingle</code>之后，调用<code>ImageLoaderMachO::doInitialization</code>，内部调用</p>
<ul>
<li><code>doImageInit</code></li>
<li><code>ImageLoaderMachO::doModInitFunctions</code></li>
</ul>
<p>⑨<code>doImageInit</code>-&gt;<code>libSystemInitialized</code>-&gt;【根据libObjc源码分析得到】<code>libdispatch_init</code>-&gt;<code>_os_object_init</code>，内部调用<code>_objc_init</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116155542621.png"></p>
<p><strong>验证：</strong></p>
<p>我们直接通过 <code>LLDB</code> 大法来断点调试 <code>libObjc</code> 源码中的 <code>_objc_init</code>，然后通过 <code>bt</code> 命令打印出当前的调用堆栈，此刻一切的一切都是那么的清晰明了：</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/1/10/16f8b2abebf9b282?imageView2/0/w/1280/h/960/ignore-error/1"></p>
<p>⑩<code>doModInitFunctions</code>内部调用<code>__mod_init_funcs section</code>，也就是<code>constructor</code>方法——C++构造方法</p>
<p><strong><code>initializeMainExecutable</code>总结：</strong></p>
<ul>
<li><code>runInitializers</code>-&gt;<code>processInitializers</code>中，遍历<code>recursiveInitialization</code></li>
<li>第一次执行时，进行<code>libsystem</code>初始化——<code>doInitialization</code>-&gt;<code>doImageInit</code>-&gt; <code>libSystemInitialized</code></li>
<li><code>libsystem</code>的初始化，会调用起<code>libdispatch_init</code>，<code>libdispatch</code>初始化会调用<code>_os_object_init</code>， 内部调用了<code>_objc_init</code></li>
<li><code>_objc_init</code>中注册并保存了<code>map_images</code>、<code>load_images</code>、<code>unmap_image</code>函数地址</li>
<li>注册完毕继续回到<code>recursiveInitialization</code>递归下一次调用</li>
</ul>
<h4 id="3-9-寻找主程序入口"><a href="#3-9-寻找主程序入口" class="headerlink" title="3.9 寻找主程序入口"></a>3.9 寻找主程序入口</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// find entry point for main executable</span></span><br><span class="line">result = (<span class="keyword">uintptr_t</span>)sMainExecutable-&gt;getEntryFromLC_MAIN();	</span><br></pre></td></tr></table></figure>

<h2 id="四、dyld加载过程示意图"><a href="#四、dyld加载过程示意图" class="headerlink" title="四、dyld加载过程示意图"></a>四、dyld加载过程示意图</h2><p><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116155808170.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/dyld.jpg"></p>
<p>dyld加载流程代码较多，第一次看大概了解这个过程即可</p>
<h2 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h2><p><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1-20210116174141455.png"></p>
<h2 id="PS"><a href="#PS" class="headerlink" title="PS"></a>PS</h2><p><a target="_blank" rel="noopener" href="https://github.com/speam/dyldSource.git">我的dyld源码</a>(版本：dyld-635.2)</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904068867948552">iOS探索 浅尝辄止dyld加载流程</a></p>
<p>更深入：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904040149729294#heading-7">iOS 底层 - 从头梳理 dyld 加载流程</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904042045374478">iOS 底层探索 - 应用加载</a></p>
</div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/01/21/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/08-%E7%B1%BB%E7%9A%84%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">08-类的加载过程</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/01/15/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/07%E4%B8%8A-%E9%80%9A%E7%94%A8%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E5%92%8CMach-O%E6%96%87%E4%BB%B6/"><span class="level-item">07上-通用二进制文件和Mach-O文件</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#前言"><span class="level-left"><span class="level-item">前言</span></span></a></li><li><a class="level is-mobile" href="#一、静态库与动态库"><span class="level-left"><span class="level-item">一、静态库与动态库</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-动态库"><span class="level-left"><span class="level-item">3.动态库</span></span></a></li></ul></li><li><a class="level is-mobile" href="#二、dyld"><span class="level-left"><span class="level-item">二、dyld</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#2-dyld-shared-cache"><span class="level-left"><span class="level-item">2.dyld_shared_cache</span></span></a></li></ul></li><li><a class="level is-mobile" href="#三、dyld加载流程"><span class="level-left"><span class="level-item">三、dyld加载流程</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-9-寻找主程序入口"><span class="level-left"><span class="level-item">3.9 寻找主程序入口</span></span></a></li></ul></li><li><a class="level is-mobile" href="#四、dyld加载过程示意图"><span class="level-left"><span class="level-item">四、dyld加载过程示意图</span></span></a></li><li><a class="level is-mobile" href="#五、总结"><span class="level-left"><span class="level-item">五、总结</span></span></a></li><li><a class="level is-mobile" href="#PS"><span class="level-left"><span class="level-item">PS</span></span></a></li><li><a class="level is-mobile" href="#参考"><span class="level-left"><span class="level-item">参考</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/imglogo.png" alt="IMO&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2021 IMO</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/speam"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>