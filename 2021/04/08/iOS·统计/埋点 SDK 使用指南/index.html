<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>埋点 SDK 使用指南 - IMO&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="IMO&#039;s Blog"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/avatar4.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="IMO&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description=""><meta property="og:type" content="blog"><meta property="og:title" content="埋点 SDK 使用指南"><meta property="og:url" content="http://evilimo.com/2021/04/08/iOS%C2%B7%E7%BB%9F%E8%AE%A1/%E5%9F%8B%E7%82%B9%20SDK%20%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/"><meta property="og:site_name" content="IMO&#039;s Blog"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://raw.githubusercontent.com/speam/blogImgs/main/image-20210508152738381.png"><meta property="article:published_time" content="2021-04-08T03:52:21.657Z"><meta property="article:modified_time" content="2021-05-08T09:15:24.208Z"><meta property="article:author" content="IMO"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://raw.githubusercontent.com/speam/blogImgs/main/image-20210508152738381.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://evilimo.com/2021/04/08/iOS%C2%B7%E7%BB%9F%E8%AE%A1/%E5%9F%8B%E7%82%B9%20SDK%20%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/"},"headline":"IMO's Blog","image":["https://raw.githubusercontent.com/speam/blogImgs/main/image-20210508152738381.png"],"datePublished":"2021-04-08T03:52:21.657Z","dateModified":"2021-05-08T09:15:24.208Z","author":{"@type":"Person","name":"IMO"},"description":""}</script><link rel="canonical" href="http://evilimo.com/2021/04/08/iOS%C2%B7%E7%BB%9F%E8%AE%A1/%E5%9F%8B%E7%82%B9%20SDK%20%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/"><link rel="icon" href="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/avatar4.png"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.4.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><!--!--><meta name="generator" content="Hexo 5.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/imglogo.png" alt="IMO&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-08T03:52:21.657Z" title="2021-04-08T03:52:21.657Z">2021-04-08</time>发表</span><span class="level-item"><time dateTime="2021-05-08T09:15:24.208Z" title="2021-05-08T09:15:24.208Z">2021-05-08</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/iOS%C2%B7%E7%BB%9F%E8%AE%A1/">iOS·统计</a></span></div></div><h1 class="title is-3 is-size-4-mobile">埋点 SDK 使用指南</h1><div class="content"><hr>
<a id="more"></a>

<h2 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h2><p>本 SDK 包含两大基础功能：</p>
<ul>
<li>通过埋点来采集数据</li>
<li>将采集的数据传输到指定的服务器端（此部分主要使用 Analytics 第三方库实现）</li>
</ul>
<p>目前，业界主流的埋点方式主要有以下三种：</p>
<ul>
<li>代码埋点</li>
<li>全埋点</li>
<li>可视化埋点</li>
</ul>
<p><strong>代码埋点</strong>指应用程序集成埋点 SDK 后，在启动时初始化埋点 SDK，然后在某个事件发生的时候调用埋点 SDK 提供的方法来触发事件，代码埋点是“最原始”的埋点方式，同时也是最万能的埋点方式。</p>
<p><strong>全埋点</strong>指无需 APP 开发者写代码或者只写少量的代码，即可预先自动采集用户的所有或者绝大部分的行为数据，然后根据实际的业务分析需求从中筛选出所需的数据并进行分析。</p>
<p>旧版 SDK 中只有代码埋点；新版 SDK 中，采用代码埋点和全埋点的方式进行数据采集。</p>
<h2 id="二、SDK-集成"><a href="#二、SDK-集成" class="headerlink" title="二、SDK 集成"></a>二、SDK 集成</h2><p>1.Pod 接入依赖库</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod <span class="string">&#x27;Analytics&#x27;</span>，~&gt; <span class="number">4.0</span><span class="number">.5</span> </span><br></pre></td></tr></table></figure>

<p>2.手动把<code>XWRuster.framework</code>拖到到项目中</p>
<p>(3.Target -&gt; Build Settings -&gt; Search Paths 中的 Framework Search Paths 里添加本 SDK 的搜索路径)</p>
<h2 id="三、SDK-基本配置"><a href="#三、SDK-基本配置" class="headerlink" title="三、SDK 基本配置"></a>三、SDK 基本配置</h2><p>1.使用<code>-initWithAppId:serverURL:</code>方法配置 AppId 和上报地址</p>
<p>2.其他配置项可查看<code>XWConfigOptions.h</code>文件：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">XWConfigOptions</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark - 初始化</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 指定初始化方法，设置 serverURL</span></span><br><span class="line"><span class="comment"> @param appId  和后台统一</span></span><br><span class="line"><span class="comment"> @param serverURL 数据接收地址</span></span><br><span class="line"><span class="comment"> @return 配置对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">instancetype</span> _Nonnull )initWithAppId:(<span class="built_in">NSString</span> *_Nonnull)appId serverURL:(<span class="built_in">NSString</span> *_Nonnull)serverURL <span class="built_in">NS_DESIGNATED_INITIALIZER</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 禁用 init 初始化</span></span><br><span class="line">- (<span class="keyword">instancetype</span> _Nonnull )init <span class="built_in">NS_UNAVAILABLE</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 禁用 new 初始化</span></span><br><span class="line">+ (<span class="keyword">instancetype</span> _Nonnull )new <span class="built_in">NS_UNAVAILABLE</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark - 配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment">///初始化SDK的key</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> * _Nonnull appId;</span><br><span class="line"></span><br><span class="line"><span class="comment">///初始化SDK的上报地址</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> * _Nonnull serverURL;</span><br><span class="line"><span class="comment">///sdk上报间隔时间 默认 5</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSTimeInterval</span> flushInterval;</span><br><span class="line"><span class="comment">///sdk上报进程数 默认5</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSUInteger</span> flushQueueSize;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 是否开启插码功能，该功能默认是开启的  整体开关，关闭后所有上报（包括自定义点位都关闭 请谨慎使用）</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> enableTrackAllEvent;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> enableTrackCustomEvent;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 是否开启无埋点插码功能，该功能默认是关闭的  aop以及监听系统通知</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> enableTrackAopEvent;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 是否开启页面声明周期插码功能，该功能默认是开启的</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> enableTrackPageLife;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 是否开启点击事件统计功能，该功能默认是关闭的</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> enableTrackTouch;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 是否开启 WKWebView 的 H5 打通功能，该功能默认是开启的</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> enableJavaScriptBridge;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 是否自动收集 App Crash 日志，该功能默认是开启的</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> enableTrackAppCrash;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 老版本自定义插码开关，该功能是后台控制 （控制 customTrackWithEventId： 和 customTrackWithEventId：eventName: ext: 两个方法）</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">readonly</span>) <span class="built_in">BOOL</span> enableOldCustomTouchEvent;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 通用属性前缀</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> * _Nullable autoPrefix;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 自定义属性前缀</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> * _Nullable customPrefix;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 传入属性的前缀</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> * _Nullable h5Prefix;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 默认为 ***</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> * _Nullable words;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 老插码打印开关</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> enabledOldLog;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 新插码打印开关</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> enabledNewLog;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 控制器黑名单：</span></span><br><span class="line"><span class="comment"> 控制哪些类不需要触发AOP中的页面浏览事件，默认已包含：</span></span><br><span class="line"><span class="comment"> @[</span></span><br><span class="line"><span class="comment">     @&quot;UIInputWindowController&quot;,</span></span><br><span class="line"><span class="comment">     @&quot;UINavigationController&quot;,</span></span><br><span class="line"><span class="comment">     @&quot;UITabBarController&quot;,</span></span><br><span class="line"><span class="comment">     @&quot;UICompatibilityInputViewController&quot;,</span></span><br><span class="line"><span class="comment">     @&quot;UISystemInputAssistantViewController&quot;,</span></span><br><span class="line"><span class="comment">     @&quot;UIPredictionViewController&quot;,</span></span><br><span class="line"><span class="comment">     @&quot;UISystemKeyboardDockController&quot;</span></span><br><span class="line"><span class="comment"> ]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSArray</span> * _Nullable controllerBlackList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h2 id="四、初始化-SDK"><a href="#四、初始化-SDK" class="headerlink" title="四、初始化 SDK"></a>四、初始化 SDK</h2><p>在 <strong>AppDelegate</strong> 的 <code>- application: didFinishLaunchingWithOptions:</code> 中添加初始化代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;XWRuster/XWRuster.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)application:(<span class="built_in">UIApplication</span> *)application didFinishLaunchingWithOptions:(<span class="built_in">NSDictionary</span> *)launchOptions &#123;</span><br><span class="line">  	<span class="comment">// 配置 AppId 和上报地址</span></span><br><span class="line">    XWConfigOptions *options = [[XWConfigOptions alloc] initWithAppId:<span class="string">@&quot;F23ED4B5C8AD4A89B0F9322973F09082&quot;</span> serverURL:<span class="string">@&quot;https://m.sd.10086.cn/collector_service/&quot;</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// H5 打通功能</span></span><br><span class="line">    options.enableJavaScriptBridge = <span class="literal">YES</span>;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 点击事件统计功能</span></span><br><span class="line">    options.enableTrackTouch = <span class="literal">NO</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// AOP</span></span><br><span class="line">    options.enableTrackAopEvent = <span class="literal">YES</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 自动收集 App Crash 日志</span></span><br><span class="line">    options.enableTrackAppCrash = <span class="literal">YES</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 前缀</span></span><br><span class="line">    <span class="comment">//    options.autoPrefix = @&quot;$auto_&quot;;</span></span><br><span class="line">    <span class="comment">//    options.customPrefix = @&quot;$cus_&quot;;</span></span><br><span class="line">    <span class="comment">//    options.h5Prefix = @&quot;$h5_&quot;;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 新插码打印开关</span></span><br><span class="line">    options.enabledNewLog = <span class="literal">YES</span>;</span><br><span class="line">    <span class="comment">// 老插码打印开关</span></span><br><span class="line">    options.enabledOldLog = <span class="literal">NO</span>;</span><br><span class="line">    </span><br><span class="line">    [XWSdRuster configWithConfigOption:options];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="五、新版-amp-旧版-SDK-说明"><a href="#五、新版-amp-旧版-SDK-说明" class="headerlink" title="五、新版 &amp; 旧版 SDK 说明"></a>五、新版 &amp; 旧版 SDK 说明</h2><p>旧版插码 SDK 只具有代码埋点功能，以下是其全部 API：</p>
<p><code>XWSdRuster.h</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 自定义上传事件 event为 touch</span></span><br><span class="line"><span class="comment"> @param eventId 触点标识</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">void</span>)customTrackWithEventId:(<span class="built_in">NSString</span> *_Nonnull)eventId;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 自定义上传事件 event为 touch</span></span><br><span class="line"><span class="comment"> @param eventId 触点标识</span></span><br><span class="line"><span class="comment"> @param eventName 触点名称</span></span><br><span class="line"><span class="comment"> @param ext 扩展属性</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">void</span>)customTrackWithEventId:(<span class="built_in">NSString</span> *_Nonnull)eventId eventName:(<span class="built_in">NSString</span> *_Nonnull)eventName ext:(<span class="built_in">NSDictionary</span> *_Nonnull)ext;</span><br></pre></td></tr></table></figure>



<p>新版插码 SDK 具有全埋点和代码埋点的功能，下文会着重讲。</p>
<h2 id="六、新版-SDK-功能说明"><a href="#六、新版-SDK-功能说明" class="headerlink" title="六、新版 SDK 功能说明"></a>六、新版 SDK 功能说明</h2><h3 id="6-1-上报报文说明"><a href="#6-1-上报报文说明" class="headerlink" title="6.1 上报报文说明"></a>6.1 上报报文说明</h3><p>由于上报是通过<code>Analytics</code>进行的，如要查看完整的上报报文，则需要将项目中的：</p>
<p>Edit Scheme→Run→Arguments→Environment Variables→OS_ACTIVITY_MODE 对应的 disable 去掉。</p>
<p><img src="https://raw.githubusercontent.com/speam/blogImgs/main/image-20210508152738381.png"></p>
<p>SDK 中一个事件的完整上报报文示例：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    anonymousId = <span class="string">&quot;291BBD31-4A7A-4339-A214-3FA4DEA4DCE5&quot;</span>;</span><br><span class="line">    context =     &#123;</span><br><span class="line">        app =         &#123;</span><br><span class="line">            build = <span class="number">21050810</span>;</span><br><span class="line">            name = <span class="string">&quot;\U5c71\U4e1c\U79fb\U52a8&quot;</span>;</span><br><span class="line">            namespace = <span class="string">&quot;cn.10086.shandongmcc&quot;</span>;</span><br><span class="line">            version = <span class="string">&quot;5.5.0&quot;</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        device =         &#123;</span><br><span class="line">            <span class="keyword">id</span> = <span class="string">&quot;9C9C0A98-4E00-5453-BA5F-E489F8BA0EBB&quot;</span>;</span><br><span class="line">            manufacturer = Apple;</span><br><span class="line">            model = <span class="string">&quot;iPad8,6&quot;</span>;</span><br><span class="line">            name = iPad;</span><br><span class="line">            type = ios;</span><br><span class="line">        &#125;;</span><br><span class="line">        library =         &#123;</span><br><span class="line">            name = <span class="string">&quot;analytics-ios&quot;</span>;</span><br><span class="line">            version = <span class="string">&quot;4.0.5&quot;</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        locale = <span class="string">&quot;zh-CN&quot;</span>;</span><br><span class="line">        network =         &#123;</span><br><span class="line">            cellular = <span class="number">0</span>;</span><br><span class="line">            wifi = <span class="number">1</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        os =         &#123;</span><br><span class="line">            name = iOS;</span><br><span class="line">            version = <span class="string">&quot;14.5&quot;</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        screen =         &#123;</span><br><span class="line">            height = <span class="number">667</span>;</span><br><span class="line">            width = <span class="number">375</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        timezone = <span class="string">&quot;Asia/Shanghai&quot;</span>;</span><br><span class="line">        traits =         &#123;&#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    event = <span class="string">&quot;$ElementExposure&quot;</span>;</span><br><span class="line">    integrations =     &#123;&#125;;</span><br><span class="line">    messageId = <span class="string">&quot;01D49861-725A-42A2-BE4E-D8A8DB19E742&quot;</span>;</span><br><span class="line">    properties =     &#123;</span><br><span class="line">        <span class="string">&quot;$clientFormatTime&quot;</span> = <span class="string">&quot;2021-05-08 15:39:23 641&quot;</span>;</span><br><span class="line">        <span class="string">&quot;$clientLongTime&quot;</span> = <span class="string">&quot;1620459563640.605&quot;</span>;</span><br><span class="line">        <span class="string">&quot;$event&quot;</span> = <span class="string">&quot;$ElementExposure&quot;</span>;</span><br><span class="line">        <span class="string">&quot;$isFirstDay&quot;</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="string">&quot;$xa_className&quot;</span> = XWHomeController;</span><br><span class="line">        <span class="string">&quot;$xa_fromClassName&quot;</span> = XWWKWebViewController;</span><br><span class="line">        <span class="string">&quot;$xa_isLogin&quot;</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="string">&quot;$xa_orientation&quot;</span> = V;</span><br><span class="line">        businessId = <span class="number">4230</span>;</span><br><span class="line">        businessName = <span class="string">&quot;\U5e78\U8fd0\U5927\U8f6c\U76d8&quot;</span>;</span><br><span class="line">        pageName = <span class="string">&quot;home_floor_450&quot;</span>;</span><br><span class="line">        transactionType = <span class="string">&quot;\U653f\U4f01\U4e1a\U52a1&quot;</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    timestamp = <span class="string">&quot;2021-05-08T07:39:23.641Z&quot;</span>;</span><br><span class="line">    type = track;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>event</code>字段为事件名，<code>properties</code>字段为此次插码事件对应的一系列属性，这些属性由一部分预置属性和传入属性共同组成。</p>
<p>如果不需要查看冗长的完整报文又想知道触发了哪些事件，则可以通过我们提供的 SDK 事件打印进行查看，由两个开关控制：</p>
<p><code>XWConfigOptions.h</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 老插码打印开关</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> enabledOldLog;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 新插码打印开关</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> enabledNewLog;</span><br></pre></td></tr></table></figure>



<p>开启旧插码打印开关后的 Log：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">function:+[XWSdRuster customTrackWithEventId:eventName:ext:] line:245 content:&#123;</span><br><span class="line"> &quot;formatTime&quot; : &quot;2021-05-08 15:52:43 540&quot;,</span><br><span class="line">&quot;WT.si_x&quot; : &quot;20&quot;,</span><br><span class="line">&quot;WT.nv&quot; : &quot;home&quot;,</span><br><span class="line">&quot;longTime&quot; : &quot;1620460363540&quot;,</span><br><span class="line">&quot;WT.transactionId&quot; : &quot;APP_T_PROVINCE_CONTENT_786569&quot;,</span><br><span class="line">&quot;WT.mobile&quot; : &quot;&quot;,</span><br><span class="line">&quot;whole_life_cycle_statistics_id&quot; : &quot;D2DFBA94-8FC4-492B-8C1A-07143B02921A_1620460343163&quot;,</span><br><span class="line">&quot;eventId&quot; : &quot;2200046&quot;,</span><br><span class="line">&quot;WT.event&quot; : &quot;2200046&quot;,</span><br><span class="line">&quot;eventName&quot; : &quot;首页_轮播图_2_流量加油&quot;,</span><br><span class="line">&quot;WT.sdnv&quot; : &quot;首页_轮播图_2_流量加油&quot;,</span><br><span class="line">&quot;WT.av&quot; : &quot;5.5.0&quot;,</span><br><span class="line">&quot;WT.action_type&quot; : &quot;exp&quot;,</span><br><span class="line">&quot;WT.cid&quot; : &quot;1b3a5529fcedc2c49d01f5d45e13ce384a0536d505770d6f200b2114b41c1f0d&quot;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>开启新插码打印开关后的 Log：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">function:-[TOEventStore track:properties:] line:382 content:</span><br><span class="line">事件名：$ElementExposure</span><br><span class="line">属性：</span><br><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;pageName&quot;</span> : <span class="string">&quot;home_floor_450&quot;</span>,</span><br><span class="line"><span class="attr">&quot;businessName&quot;</span> : <span class="string">&quot;直播&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$xa_className&quot;</span> : <span class="string">&quot;XWHomeController&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$xa_isLogin&quot;</span> : <span class="string">&quot;false&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$event&quot;</span> : <span class="string">&quot;$ElementExposure&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$isFirstDay&quot;</span> : <span class="string">&quot;false&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$xa_fromClassName&quot;</span> : <span class="string">&quot;XWWKWebViewController&quot;</span>,</span><br><span class="line"><span class="attr">&quot;transactionType&quot;</span> : <span class="string">&quot;政企业务&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$clientFormatTime&quot;</span> : <span class="string">&quot;2021-05-08 15:51:35 772&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$xa_orientation&quot;</span> : <span class="string">&quot;V&quot;</span>,</span><br><span class="line"><span class="attr">&quot;businessId&quot;</span> : <span class="string">&quot;4621&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$clientLongTime&quot;</span> : <span class="string">&quot;1620460295772.308&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-2-后台配置说明"><a href="#6-2-后台配置说明" class="headerlink" title="6.2 后台配置说明"></a>6.2 后台配置说明</h3><p>在 SDK 初始化时会去请求后台配置项，用于配置上传地址和控制新老插码开关，具体报文如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">&quot;integrations&quot;</span>: &#123;</span><br><span class="line">   <span class="attr">&quot;Segment.io&quot;</span>: &#123;</span><br><span class="line">       <span class="attr">&quot;apiKey&quot;</span>: <span class="string">&quot;XXXXXXXXXXXXXXXXXXXX&quot;</span>,<span class="comment">// 身份凭证</span></span><br><span class="line">       <span class="attr">&quot;perm&quot;</span>: <span class="string">&quot;0101&quot;</span>,</span><br><span class="line">       <span class="attr">&quot;collectServer&quot;</span>: <span class="string">&quot;https://m.sd.10086.cn/collector_service/XXXXXXXXXXXXXXXXXXXX/import&quot;</span><span class="comment">// 数据上传地址</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">&quot;config&quot;</span>: &#123;</span><br><span class="line">       <span class="attr">&quot;oldTouch&quot;</span>:<span class="number">0</span>, <span class="comment">// 1代表关闭老版插码，否则表示开启</span></span><br><span class="line">       <span class="attr">&quot;newTouch&quot;</span>:<span class="number">0</span>:<span class="comment">// 1代表关闭新版插码，否则表示开启</span></span><br><span class="line">       <span class="string">&quot;其它配置项&quot;</span>:<span class="string">&quot;...&quot;</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-设置属性的前缀"><a href="#6-3-设置属性的前缀" class="headerlink" title="6.3 设置属性的前缀"></a>6.3 设置属性的前缀</h3><p><code>XWConfigOptions</code>类中的<code>autoPrefix</code>属性可以配置预置属性的前缀，<code>customPrefix</code>属性可以配置自定义属性前缀，<code>h5Prefix</code>属性可以配置 H5 传入属性的前缀。</p>
<p>假设在项目中进行如下配置：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">options.autoPrefix = <span class="string">@&quot;$auto_&quot;</span>;</span><br><span class="line">options.customPrefix = <span class="string">@&quot;$custom_&quot;</span>;</span><br><span class="line">options.h5Prefix = <span class="string">@&quot;$h5_&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>则上报报文如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">&quot;event&quot;: &quot;touch&quot;,</span><br><span class="line">&quot;properties&quot; = &#123;</span><br><span class="line">    &quot;$auto_customTouchName&quot; = &quot;11&quot;;</span><br><span class="line">    &quot;$auto_formatTime&quot; = &quot;2021-04-08 11:03:15 647&quot;;</span><br><span class="line">    &quot;$auto_longTime&quot; = &quot;1617850995646.862&quot;;</span><br><span class="line">    &quot;$custom_testKey1&quot; = &quot;test&quot;;</span><br><span class="line">    &quot;$custom_testKey2&quot; = &quot;test&quot;;</span><br><span class="line">    &#125;;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">&quot;event&quot;: &quot;touch&quot;,</span><br><span class="line">&quot;properties&quot; = &#123;</span><br><span class="line">    &quot;$auto_dataSubmit&quot; = &quot;iOS&quot;;</span><br><span class="line">    &quot;$h5_testkey&quot; = &quot;测试点击&quot;;</span><br><span class="line">    &#125;;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="6-4-全埋点"><a href="#6-4-全埋点" class="headerlink" title="6.4 全埋点"></a>6.4 全埋点</h3><h4 id="6-4-1-开启和关闭全埋点功能"><a href="#6-4-1-开启和关闭全埋点功能" class="headerlink" title="6.4.1 开启和关闭全埋点功能"></a>6.4.1 开启和关闭全埋点功能</h4><p><code>XWConfigOptions.h</code>：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 全埋点总开关，默认关闭</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> enableTrackAopEvent;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// 点击全埋点开关，默认关闭</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> enableTrackTouch;</span><br></pre></td></tr></table></figure>



<p><code>enableTrackAopEvent</code>属性控制全埋点的总开关，默认关闭，需手动打开。</p>
<p><code>enableTrackTouch</code>属性是在全埋点总开关打开的基础上，控制全埋点的点击开关，默认关闭，需手动打开。</p>
<h4 id="6-4-2-应用启动事件"><a href="#6-4-2-应用启动事件" class="headerlink" title="6.4.2 应用启动事件"></a>6.4.2 应用启动事件</h4><p>在 SDK 刚初始化完成的时候立即触发应用启动事件，所以应该将此 SDK 的初始化写在自己项目中的<code>-application:didFinishLaunchingWithOptions:</code>方法中，且位置越靠前越好。</p>
<p>上传报文：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;$event&quot;</span> : <span class="string">&quot;$AppStart&quot;</span>,</span><br><span class="line"><span class="string">&quot;$isFirstDay&quot;</span> : <span class="string">&quot;false&quot;</span>,</span><br><span class="line"><span class="string">&quot;$xa_bootTime&quot;</span> : <span class="string">&quot;44.54398155212402&quot;</span>,</span><br><span class="line"><span class="string">&quot;$clientLongTime&quot;</span> : <span class="string">&quot;1620442030733.773&quot;</span>,</span><br><span class="line"><span class="string">&quot;$xa_startType&quot;</span> : <span class="string">&quot;3&quot;</span>,</span><br><span class="line"><span class="string">&quot;$clientFormatTime&quot;</span> : <span class="string">&quot;2021-05-08 10:47:10 734&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="6-4-3-应用退出事件"><a href="#6-4-3-应用退出事件" class="headerlink" title="6.4.3 应用退出事件"></a>6.4.3 应用退出事件</h4><p>应用即将被杀死前会触发<code>$AppEnd</code>事件。</p>
<p>上传报文：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;$event&quot;</span> : <span class="string">&quot;$AppEnd&quot;</span>,</span><br><span class="line"><span class="string">&quot;$clientFormatTime&quot;</span> : <span class="string">&quot;2021-05-08 10:48:54 903&quot;</span>,</span><br><span class="line"><span class="string">&quot;$clientLongTime&quot;</span> : <span class="string">&quot;1620442134902.711&quot;</span>,</span><br><span class="line"><span class="string">&quot;$xa_duration&quot;</span> : <span class="string">&quot;7563.519954681396&quot;</span>,</span><br><span class="line"><span class="string">&quot;$xa_exit_time&quot;</span> : <span class="string">&quot;1620442134.901742&quot;</span>,</span><br><span class="line"><span class="string">&quot;$xa_lastUrl&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="string">&quot;$xa_exit_format&quot;</span> : <span class="string">&quot;2021-05-08 10:48:54 902&quot;</span>,</span><br><span class="line"><span class="string">&quot;$isFirstDay&quot;</span> : <span class="string">&quot;false&quot;</span>,</span><br><span class="line"><span class="string">&quot;$xa_lastClassName&quot;</span> : <span class="string">&quot;XWHomeController&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="6-4-4-应用启动时长"><a href="#6-4-4-应用启动时长" class="headerlink" title="6.4.4 应用启动时长"></a>6.4.4 应用启动时长</h4><p>应用启动时长统计是通过计算应用程序从进入前台处于活跃状态到结束进程的时间，减去应用处于后台不活跃状态的整个运行时间间隔来完成的。</p>
<p>于上述<code>$AppEnd</code>事件中上传此值：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;$event&quot;</span> : <span class="string">&quot;$AppEnd&quot;</span>,</span><br><span class="line"> ...</span><br><span class="line"><span class="string">&quot;$xa_duration&quot;</span> : <span class="string">&quot;7563.519954681396&quot;</span>,</span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="6-4-5-崩溃采集"><a href="#6-4-5-崩溃采集" class="headerlink" title="6.4.5 崩溃采集"></a>6.4.5 崩溃采集</h4><p>苹果公司其实在 iOS 系统中提供了自动收集应用崩溃并上报的功能，打开方式为：在 iPhone 中进入设置 ➞ 隐私 ➞ 分析与改进 ➞ 打开“与 App 开发者共享”。但并不是所有的 iPhone 用户都开启了该功能，因此对于采集 SDK 来说，崩溃采集上报也需要我们自己实现。</p>
<p>采集应用程序的崩溃分为以下两种方式：</p>
<ul>
<li>NSException 异常</li>
<li>Unix 信号异常</li>
</ul>
<p>新插码 SDK 目前采集的是 NSException 异常，当应用崩溃时，记录此次崩溃事件，于下次应用启动时上报。</p>
<p>此功能也有开关控制，且独立于全埋点总开关：</p>
<p><code>XWConfigOptions.h</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 是否自动收集 App Crash 日志，该功能默认是开启的</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> enableTrackAppCrash;</span><br></pre></td></tr></table></figure>



<p>上传报文：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;$clientFormatTime&quot; = &quot;2021-05-08 11:31:26 646&quot;;</span><br><span class="line">    &quot;$clientLongTime&quot; = &quot;1620444686645.091&quot;;</span><br><span class="line">    &quot;$event&quot; = &quot;$AppCrashed&quot;;</span><br><span class="line">    &quot;$isFirstDay&quot; = false;</span><br><span class="line">    &quot;$xa_crashTrace&quot; = &quot;[ Uncaught Exception ]</span><br><span class="line">\nName: NSRangeException, Reason: *** -[__NSArrayI objectAtIndexedSubscript:]: index 3 beyond bounds [0 .. 2]</span><br><span class="line">\n[ Fe Symbols Start ]</span><br><span class="line">\n0   CoreFoundation                      0x00000001925f2a5c 7519E999-1053-3367-B9D5-8844F6D3BDC6 + 1227356</span><br><span class="line">\n1   libobjc.A.dylib                     0x0000000192319fa4 objc_exception_throw + 56</span><br><span class="line">\n2   CoreFoundation                      0x0000000192648360 7519E999-1053-3367-B9D5-8844F6D3BDC6 + 1577824</span><br><span class="line">\n3   CoreFoundation                      0x00000001924e92a0 7519E999-1053-3367-B9D5-8844F6D3BDC6 + 139936</span><br><span class="line">\n4   XWRusterOCDemo                      0x000000010446a980 -[ViewController crash] + 296</span><br><span class="line">\n5   XWRusterOCDemo                      0x000000010446a788 -[ViewController tableView:didSelectRowAtIndexPath:] + 344</span><br><span class="line">\n6   UIKitCore                           0x0000000196842948 D7630067-7A00-3CB7-99E1-E7F6C55D85C5 + 12376392</span><br><span class="line">\n7   UIKitCore                           0x0000000196842464 D7630067-7A00-3CB7-99E1-E7F6C55D85C5 + 12375140</span><br><span class="line">\n8   UIKitCore                           0x0000000196842b64 D7630067-7A00-3CB7-99E1-E7F6C55D85C5 + 12376932</span><br><span class="line">\n9   UIKitCore                           0x0000000196681c84 D7630067-7A00-3CB7-99E1-E7F6C55D85C5 + 10538116</span><br><span class="line">\n10  UIKitCore                           0x00000001966717d4 D7630067-7A00-3CB7-99E1-E7F6C55D85C5 + 10471380</span><br><span class="line">\n11  UIKitCore                           0x00000001966a1744 D7630067-7A00-3CB7-99E1-E7F6C55D85C5 + 10667844</span><br><span class="line">\n12  CoreFoundation                      0x000000019256fe68 7519E999-1053-3367-B9D5-8844F6D3BDC6 + 691816</span><br><span class="line">\n13  CoreFoundation                      0x000000019256ad54 7519E999-1053-3367-B9D5-8844F6D3BDC6 + 671060</span><br><span class="line">\n14  CoreFoundation                      0x000000019256b320 7519E999-1053-3367-B9D5-8844F6D3BDC6 + 672544</span><br><span class="line">\n15  CoreFoundation                      0x000000019256aadc CFRunLoopRunSpecific + 464</span><br><span class="line">\n16  GraphicsServices                    0x000000019c50b328 GSEventRunModal + 104</span><br><span class="line">\n17  UIKitCore                           0x000000019667863c UIApplicationMain + 1936</span><br><span class="line">\n18  XWRusterOCDemo                      0x000000010446cdbc main + 120</span><br><span class="line">\n19  libdyld.dylib                       0x00000001923f4360 7B531A15-3E73-3185-90E2-B88D9476DA5E + 4960</span><br><span class="line">\n[ Fe Symbols End ]</span><br><span class="line">\n</span><br><span class="line">\n&quot;;</span><br><span class="line">    &quot;$xa_exception&quot; = NSRangeException;</span><br><span class="line">    &quot;$xa_formatTime&quot; = &quot;2021-05-08 11:31:10 871&quot;;</span><br><span class="line">    &quot;$xa_lastClassName&quot; = &quot;&quot;;</span><br><span class="line">    &quot;$xa_lastUrl&quot; = &quot;&quot;;</span><br><span class="line">    &quot;$xa_longTime&quot; = 1620444670871;</span><br><span class="line">    &quot;$xa_timeOutLong&quot; = 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="6-4-6-原生页面点击事件"><a href="#6-4-6-原生页面点击事件" class="headerlink" title="6.4.6 原生页面点击事件"></a>6.4.6 原生页面点击事件</h4><p>包含普通按钮点击、tableView 点击、collectionView 点击、tabBar 点击的全埋点。可自行打印 Log 查看。</p>
<p>通过此开关进行单独控制：</p>
<p><code>XWConfigOptions.h</code>：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 点击全埋点开关，默认关闭</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> enableTrackTouch;</span><br></pre></td></tr></table></figure>



<h4 id="6-4-7-原生页面打开、关闭及浏览时长统计"><a href="#6-4-7-原生页面打开、关闭及浏览时长统计" class="headerlink" title="6.4.7 原生页面打开、关闭及浏览时长统计"></a>6.4.7 原生页面打开、关闭及浏览时长统计</h4><p>页面打开触发<code>$PageLoad</code>事件，包含页面路径（上一个打开的原生页面），上报报文：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;event&quot;</span>: <span class="string">&quot;$PageLoad&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        “$clientLongTime”：1608703614208,</span><br><span class="line">        ”$clientFormatTime“：&quot;2021-01-01 00:00:00 321&quot;</span><br><span class="line">        &quot;$isFirstDay&quot;: &quot;false&quot; // 是否第一次访问（不是每天第一次而是整个生涯的第一次）</span><br><span class="line">        &quot;$userMobile&quot;:&quot;67894rhtgjfeiruyhejd&quot; // 加密后的用户标识</span><br><span class="line">        &quot;$event&quot;:&quot;$PageLoad&quot;</span><br><span class="line">        &quot;$pageUrl&quot;: &quot;&quot;, // 如果是webView则记录H5地址</span><br><span class="line">        &quot;$pageReferrer&quot;: &quot;&quot;, // 上一个H5的地址</span><br><span class="line">        &quot;$pageTitle&quot;: &quot;&quot;, // H5标题</span><br><span class="line">    &quot;$xa_className&quot;: &quot;&quot;,</span><br><span class="line">    &quot;$xa_fromClassName&quot;: &quot;&quot;,</span><br><span class="line">    &quot;$xa_isLogin&quot;: &quot;true&quot;, // 是否登录</span><br><span class="line">    &quot;$xa_orientation&quot;: &quot;&quot;, // 屏幕方向，V竖屏，H横屏</span><br><span class="line">    &quot;$xa_screenName&quot;:&quot;&quot;// 页面标题，不一定有</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>页面关闭触发<code>$PageStayLength</code>事件，包含原生页面驻留时长，上报报文：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;event&quot;</span>: <span class="string">&quot;$PageStayLength&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        &quot;$clientLongTime&quot;：1608703614208,</span><br><span class="line">        &quot;$clientFormatTime&quot;：&quot;2021-01-01 00:00:00 321&quot;,</span><br><span class="line">        &quot;$isFirstDay&quot;: &quot;false&quot; // 是否第一次访问（不是每天第一次而是整个生涯的第一次）</span><br><span class="line">        &quot;$userMobile&quot;:&quot;67894rhtgjfeiruyhejd&quot; // 加密后的用户标识</span><br><span class="line">        &quot;$event&quot;:&quot;$PageStayLength&quot;</span><br><span class="line">        &quot;$pageUrl&quot;: &quot;&quot;, // 如果是 webView 则记录 H5 地址</span><br><span class="line">        &quot;$pageReferrer&quot;: &quot;&quot;, // 上一个H5的地址</span><br><span class="line">        &quot;$pageTitle&quot;: &quot;&quot;, // H5 标题</span><br><span class="line">        &quot;$pageDuration&quot;:12343 // H5 驻留时长</span><br><span class="line">    &quot;$xa_className&quot;: &quot;&quot;,</span><br><span class="line">    &quot;$xa_fromClassName&quot;: &quot;&quot;,</span><br><span class="line">    &quot;$xa_isLogin&quot;: &quot;true&quot;, // 是否登录</span><br><span class="line">    &quot;$xa_orientation&quot;: &quot;&quot;, // 屏幕方向，V竖屏，H横屏</span><br><span class="line">    &quot;$xa_nativeDuration&quot;:16087 // 原生页面驻留时长</span><br><span class="line">    &quot;$xa_screenName&quot;:&quot;&quot; // 页面标题</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>由于 iOS 的机制，App 在页面浏览时会夹杂着一些看不到的、非开发者写的控制器，所以在页面打开时会触发多余的<code>$PageLoad</code>事件，于是我们引入了黑名单机制，即在黑名单里配置哪些控制器及其子类不能触发页面打开和关闭事件。</p>
<p>使用<code>XWConfigOptions</code>类的<code>@property (nonatomic, strong) NSArray * _Nullable controllerBlackList;</code>属性进行配置。默认已包含：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@[</span><br><span class="line">    <span class="string">@&quot;UIInputWindowController&quot;</span>,</span><br><span class="line">    <span class="string">@&quot;UINavigationController&quot;</span>,</span><br><span class="line">    <span class="string">@&quot;UITabBarController&quot;</span>,</span><br><span class="line">    <span class="string">@&quot;UICompatibilityInputViewController&quot;</span>,</span><br><span class="line">    <span class="string">@&quot;UISystemInputAssistantViewController&quot;</span>,</span><br><span class="line">    <span class="string">@&quot;UIPredictionViewController&quot;</span>,</span><br><span class="line">    <span class="string">@&quot;UISystemKeyboardDockController&quot;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>开发者页可以自行添加，来过略掉自己项目中不需要触发页面打开和关闭事件的控制器。</p>
</blockquote>
<h4 id="6-4-8-WKWebView-页面加载错误"><a href="#6-4-8-WKWebView-页面加载错误" class="headerlink" title="6.4.8 WKWebView 页面加载错误"></a>6.4.8 WKWebView 页面加载错误</h4><p>能够捕获到常见的 http 错误。</p>
<p>上报报文：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;event&quot;</span>: <span class="string">&quot;$Error&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;$clientLongTime&quot;</span>: <span class="string">&quot;1620454190114.114&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;$xa_className&quot;</span>: <span class="string">&quot;XWWKWebViewController&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;$xa_title&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;$xa_fromTitle&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;$xa_path&quot;</span>: <span class="string">&quot;https://m.sd.10086.cn/sd_fe_service/sd2023/index.html#/&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;$xa_line&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;$userMobile&quot;</span>: <span class="string">&quot;c46f73828bda53dfae9b084d807fae66&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;$isFirstDay&quot;</span>: <span class="string">&quot;false&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;$event&quot;</span>: <span class="string">&quot;$Error&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;$xa_fromUrl&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;$xa_name&quot;</span>: <span class="string">&quot;微博签到&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;$xa_fromClassName&quot;</span>: <span class="string">&quot;XWWKWebViewController&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;$clientFormatTime&quot;</span>: <span class="string">&quot;2021-05-08 14:09:50 114&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;$xa_message&quot;</span>: <span class="string">&quot;Error Domain=NSURLErrorDomain Code=-1002 &quot;</span>unsupported URL<span class="string">&quot; UserInfo=&#123;_NSURLErrorFailingURLSessionTaskErrorKey=LocalDataTask &lt;11D57D43-E993-4CE3-B6FA-16E7EE760254&gt;.&lt;11&gt;, NSLocalizedDescription=unsupported URL, _WKRecoveryAttempterErrorKey=&lt;WKReloadFrameErrorRecoveryAttempter: 0x282480540&gt;, networkTaskDescription=LocalDataTask &lt;11D57D43-E993-4CE3-B6FA-16E7EE760254&gt;.&lt;11&gt;, NSErrorFailingURLStringKey=sinaweibo://cardlist?containerid=102803&amp;finish=true&amp;open_direct=1&amp;extparam=from_mobilesign_5310&amp;luicode=10000629&amp;lfid=sansiline_shouting_015&amp;launchid=10000629-sansiline_shouting_015&amp;callbackurl=sdmccweb://sd.10086.cn/honeybeeEden&amp;extparam=from_mobilesign_5310_18764741016_1620454189_cefe542cb8bea141851547701dc10740ffc448ad8738d9d8b5d54c3b7bff34a2, NSErrorFailingURLKey=sinaweibo://cardlist?containerid=102803&amp;finish=true&amp;open_direct=1&amp;extparam=from_mobilesign_5310&amp;luicode=10000629&amp;lfid=sansiline_shouting_015&amp;launchid=10000629-sansiline_shouting_015&amp;callbackurl=sdmccweb://sd.10086.cn/honeybeeEden&amp;extparam=from_mobilesign_5310_18764741016_1620454189_cefe542cb8bea141851547701dc10740ffc448ad8738d9d8b5d54c3b7bff34a2, NSUnderlyingError=0x282a27270 &#123;Error Domain=kCFErrorDomainCFNetwork Code=-1002 &quot;</span>(<span class="literal">null</span>)<span class="string">&quot;&#125;&#125;&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;$xa_url&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;$xa_errorType&quot;</span>: <span class="string">&quot;6&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="6-4-9-与H5打通"><a href="#6-4-9-与H5打通" class="headerlink" title="6.4.9 与H5打通"></a>6.4.9 与H5打通</h4><p>常见的打通方案有以下两种：</p>
<ul>
<li>通过拦截 WebView 请求进行打通</li>
<li>通过 JavaScript 与 WebView 相互调用进行打通</li>
</ul>
<p>通过拦截请求实现打通，是一种比较通用的方案，不过实现相对复杂，再加上 UserAgent 的不稳定性，都会导致打通失败。所以新插码 SDK 采用第二种方案。</p>
<p>首先双方约定好交互方法，然后通过<code>message.body</code>中的<code>event</code>字段的值区分事件，当进入一个 H5 页面的时候值为<code>page</code>，H5 页面消失时值为<code>unpage</code>，由此我们在这两个时机触发埋点采集。</p>
<p>H5 页面进入触发<code>$PageLoad</code>事件（与打开原生页面事件保持一致），上报报文：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">&quot;$xa_className&quot;</span> : <span class="string">&quot;XWWKWebViewController&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$xa_isLogin&quot;</span> : <span class="string">&quot;true&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$userMobile&quot;</span> : <span class="string">&quot;c46f73828bda53dfae9b084d807fae66&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$event&quot;</span> : <span class="string">&quot;$PageLoad&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$pageTitle&quot;</span> : <span class="string">&quot;segmentio project&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$isFirstDay&quot;</span> : <span class="string">&quot;false&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$lastPageTitle&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$pageUrl&quot;</span> : <span class="string">&quot;http://m.sd.10086.cn/fe_service/xwcode/index.html&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$xa_fromClassName&quot;</span> : <span class="string">&quot;XWWKWebViewController&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$xa_screenName&quot;</span> : <span class="string">&quot;segmentio project&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$xa_orientation&quot;</span> : <span class="string">&quot;V&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$clientFormatTime&quot;</span> : <span class="string">&quot;2021-05-08 14:36:45 042&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$pageReferrer&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$clientLongTime&quot;</span> : <span class="string">&quot;1620455805041.908&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>H5 页面离开时触发<code>$PageStayLength</code>事件（与打开原生页面事件保持一致），上报报文：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">&quot;$xa_className&quot;</span> : <span class="string">&quot;XWWKWebViewController&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$xa_isLogin&quot;</span> : <span class="string">&quot;true&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$userMobile&quot;</span> : <span class="string">&quot;c46f73828bda53dfae9b084d807fae66&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$event&quot;</span> : <span class="string">&quot;$PageStayLength&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$pageTitle&quot;</span> : <span class="string">&quot;segmentio project&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$isFirstDay&quot;</span> : <span class="string">&quot;false&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$xa_nativeDuration&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$lastPageTitle&quot;</span> : <span class="string">&quot;segmentio project&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$pageUrl&quot;</span> : <span class="string">&quot;http://m.sd.10086.cn/fe_service/xwcode/index.html&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$xa_fromClassName&quot;</span> : <span class="string">&quot;XWWKWebViewController&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$pageDuration&quot;</span> : <span class="string">&quot;122.4269866943359&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$xa_screenName&quot;</span> : <span class="string">&quot;segmentio project&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$xa_orientation&quot;</span> : <span class="string">&quot;V&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$clientFormatTime&quot;</span> : <span class="string">&quot;2021-05-08 14:36:45 166&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$pageReferrer&quot;</span> : <span class="string">&quot;http://m.sd.10086.cn/fe_service/xwcode/index.html&quot;</span>,</span><br><span class="line"><span class="attr">&quot;$clientLongTime&quot;</span> : <span class="string">&quot;1620455805166.079&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>其中：</p>
<ul>
<li><code>$lastPageTitle</code>是上一个 H5 页面的标题</li>
<li><code>$pageReferrer</code>是上一个 H5 页面的 URL</li>
<li><code>$pageUrl</code>是当前 H5 页面的 URL</li>
<li><code>$pageTitle</code>是当前 H5 页面的标题</li>
<li><code>$pageDuration</code>记录了当前 H5 页面的驻留时长</li>
</ul>
<h3 id="6-5-代码埋点"><a href="#6-5-代码埋点" class="headerlink" title="6.5 代码埋点"></a>6.5 代码埋点</h3><h4 id="6-5-1-用户登录"><a href="#6-5-1-用户登录" class="headerlink" title="6.5.1 用户登录"></a>6.5.1 用户登录</h4><p>当用户注册成功或者进行登录时，需要调用SDK 的 <code>+ loginWithUserId:</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[XWSdRuster loginWithUserId:<span class="string">@&quot;UserID&quot;</span>];</span><br></pre></td></tr></table></figure>



<h4 id="6-5-2-用户注销"><a href="#6-5-2-用户注销" class="headerlink" title="6.5.2 用户注销"></a>6.5.2 用户注销</h4><p>当用户退出登录时，需要调用 SDK 的<code>+logout</code>接口：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[XWSdRuster logout];</span><br></pre></td></tr></table></figure>

<p>此方法不会上传任何信息，只是抹除本地的一些暂存信息。</p>
<h4 id="6-5-3-配置用户组"><a href="#6-5-3-配置用户组" class="headerlink" title="6.5.3 配置用户组"></a>6.5.3 配置用户组</h4><p>当用户登录后，可以调用 SDK 的<code>+loginWithGroupId:</code>接口，将该用户纳入某个组内，以关联用户关系：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[XWSdRuster loginWithGroupId:<span class="string">@&quot;GroupID&quot;</span>];</span><br></pre></td></tr></table></figure>



<h4 id="6-5-4-点击事件插码"><a href="#6-5-4-点击事件插码" class="headerlink" title="6.5.4 点击事件插码"></a>6.5.4 点击事件插码</h4><p>上传必要的点击事件。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 点击插码</span></span><br><span class="line"><span class="comment">/// @param eventName 事件名</span></span><br><span class="line"><span class="comment">/// @param properties 扩展属性</span></span><br><span class="line">+ (<span class="keyword">void</span>)touchWithEventName:(<span class="built_in">NSString</span> *_Nullable)eventName properties:(<span class="built_in">NSDictionary</span> *_Nonnull)properties;</span><br></pre></td></tr></table></figure>



<h4 id="6-5-5-曝光事件插码"><a href="#6-5-5-曝光事件插码" class="headerlink" title="6.5.5 曝光事件插码"></a>6.5.5 曝光事件插码</h4><p>某页面是否曝光给用户时，可以用来上传相关的信息。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 曝光插码 event为 customExposure</span></span><br><span class="line"><span class="comment"> @param properties 扩展属性</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">void</span>)exposureEventWithProperties:(<span class="built_in">NSDictionary</span> *_Nullable)properties;</span><br></pre></td></tr></table></figure>



<h4 id="6-5-6-上传用户信息"><a href="#6-5-6-上传用户信息" class="headerlink" title="6.5.6 上传用户信息"></a>6.5.6 上传用户信息</h4><p>上传登录用户的个人信息，内容自定义。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 上传自定义用户信息</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> @param properties 用户信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">void</span>)userEvent:(<span class="built_in">NSDictionary</span> *_Nonnull)properties;</span><br></pre></td></tr></table></figure>



<h4 id="6-5-7-错误上报"><a href="#6-5-7-错误上报" class="headerlink" title="6.5.7 错误上报"></a>6.5.7 错误上报</h4><p>H5 内和原生中出现的错误都可以通过此方法上报</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// H5 和 原生错误上报</span></span><br><span class="line"><span class="comment">/// @param errorType 错误类型:JS报错、JS加载失败、图片加载失败、API访问错误、API访问失败、H5页面加载失败、H5页面报错</span></span><br><span class="line"><span class="comment">/// @param path 路径(图片时为URL)</span></span><br><span class="line"><span class="comment">/// @param line 错误行号（用于js）</span></span><br><span class="line"><span class="comment">/// @param message 失败原因，堆栈错误信息</span></span><br><span class="line">+ (<span class="keyword">void</span>)errorEventType:(<span class="built_in">NSString</span> *_Nullable)errorType path:(<span class="built_in">NSString</span> *_Nullable)path line:(<span class="built_in">NSString</span> *_Nullable)line message:(<span class="built_in">NSString</span> *_Nullable)message;</span><br></pre></td></tr></table></figure>



<h4 id="6-5-8-上传用户位置"><a href="#6-5-8-上传用户位置" class="headerlink" title="6.5.8 上传用户位置"></a>6.5.8 上传用户位置</h4><p>将获取到的用户位置信息上传，经纬度必传，其中上传的字段都会被加密。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 上传定位信息</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> @param latitude 纬度</span></span><br><span class="line"><span class="comment"> @param longitude 经度</span></span><br><span class="line"><span class="comment"> @param otherInfo 扩展属性 privence city area address</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">void</span>)locateWithLongitude:(<span class="built_in">NSString</span> *_Nonnull)longitude latitude:(<span class="built_in">NSString</span> *_Nonnull)latitude otherInfo:(XWTrackLocation *_Nullable)otherInfo;</span><br></pre></td></tr></table></figure>



<h4 id="6-5-9-完全自定义插码"><a href="#6-5-9-完全自定义插码" class="headerlink" title="6.5.9 完全自定义插码"></a>6.5.9 完全自定义插码</h4><p>可以自定义事件名，事件属性，甚至可以对sdk做二次封装扩展，配合后台发挥更大的作用。不要忘了，属性会被自动添加前缀。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 完全自由的自定义事件</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> @param event 事件</span></span><br><span class="line"><span class="comment"> @param properties 额外参数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">void</span>)fullyCustomTrack:(<span class="built_in">NSString</span> * _Nonnull)event properties:(<span class="built_in">NSDictionary</span> * _Nullable)properties;</span><br></pre></td></tr></table></figure>



<h4 id="6-5-10-发送队列消息"><a href="#6-5-10-发送队列消息" class="headerlink" title="6.5.10 发送队列消息"></a>6.5.10 发送队列消息</h4><p>如果队列中有暂存的消息体，立即发送。  </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 立即上报所有的插码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">void</span>)flush;</span><br></pre></td></tr></table></figure>

<h3 id="6-6-加密部分"><a href="#6-6-加密部分" class="headerlink" title="6.6 加密部分"></a>6.6 加密部分</h3><p>App 调用<code>-loginWithUserId:</code>方法时传入的明文手机号和调用<code>-locateWithLongitude:latitude:otherInfo:</code>传入的位置信息都会被 SDK 进行加密后再上报。</p>
<p>使用 AES 对称加密，相关配置：</p>
<ul>
<li><p>密钥长度：128</p>
</li>
<li><p>加密模式：CBC</p>
</li>
<li><p>填充方式：PKCS7Padding</p>
</li>
<li><p>初始向量：16-Bytes–String</p>
</li>
<li><p>加密 key：默认为<code>***</code>，可通过<code>XWConfigOptions</code>类进行控制：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 默认为 ***</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> * _Nullable words;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/05/08/Mac/Mac%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E6%97%A0%E6%B3%95%E6%89%93%E5%BC%80%E6%88%96%E6%96%87%E4%BB%B6%E6%8D%9F%E5%9D%8F%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Mac应用程序无法打开或文件损坏的解决办法</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/04/06/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/15-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8B%E5%9F%BA%E7%A1%80%E5%8E%9F%E7%90%86/"><span class="level-item">15-多线程之基础原理</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#一、简介"><span class="level-left"><span class="level-item">一、简介</span></span></a></li><li><a class="level is-mobile" href="#二、SDK-集成"><span class="level-left"><span class="level-item">二、SDK 集成</span></span></a></li><li><a class="level is-mobile" href="#三、SDK-基本配置"><span class="level-left"><span class="level-item">三、SDK 基本配置</span></span></a></li><li><a class="level is-mobile" href="#四、初始化-SDK"><span class="level-left"><span class="level-item">四、初始化 SDK</span></span></a></li><li><a class="level is-mobile" href="#五、新版-amp-旧版-SDK-说明"><span class="level-left"><span class="level-item">五、新版 &amp; 旧版 SDK 说明</span></span></a></li><li><a class="level is-mobile" href="#六、新版-SDK-功能说明"><span class="level-left"><span class="level-item">六、新版 SDK 功能说明</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#6-1-上报报文说明"><span class="level-left"><span class="level-item">6.1 上报报文说明</span></span></a></li><li><a class="level is-mobile" href="#6-2-后台配置说明"><span class="level-left"><span class="level-item">6.2 后台配置说明</span></span></a></li><li><a class="level is-mobile" href="#6-3-设置属性的前缀"><span class="level-left"><span class="level-item">6.3 设置属性的前缀</span></span></a></li><li><a class="level is-mobile" href="#6-4-全埋点"><span class="level-left"><span class="level-item">6.4 全埋点</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#6-4-1-开启和关闭全埋点功能"><span class="level-left"><span class="level-item">6.4.1 开启和关闭全埋点功能</span></span></a></li><li><a class="level is-mobile" href="#6-4-2-应用启动事件"><span class="level-left"><span class="level-item">6.4.2 应用启动事件</span></span></a></li><li><a class="level is-mobile" href="#6-4-3-应用退出事件"><span class="level-left"><span class="level-item">6.4.3 应用退出事件</span></span></a></li><li><a class="level is-mobile" href="#6-4-4-应用启动时长"><span class="level-left"><span class="level-item">6.4.4 应用启动时长</span></span></a></li><li><a class="level is-mobile" href="#6-4-5-崩溃采集"><span class="level-left"><span class="level-item">6.4.5 崩溃采集</span></span></a></li><li><a class="level is-mobile" href="#6-4-6-原生页面点击事件"><span class="level-left"><span class="level-item">6.4.6 原生页面点击事件</span></span></a></li><li><a class="level is-mobile" href="#6-4-7-原生页面打开、关闭及浏览时长统计"><span class="level-left"><span class="level-item">6.4.7 原生页面打开、关闭及浏览时长统计</span></span></a></li><li><a class="level is-mobile" href="#6-4-8-WKWebView-页面加载错误"><span class="level-left"><span class="level-item">6.4.8 WKWebView 页面加载错误</span></span></a></li><li><a class="level is-mobile" href="#6-4-9-与H5打通"><span class="level-left"><span class="level-item">6.4.9 与H5打通</span></span></a></li></ul></li><li><a class="level is-mobile" href="#6-5-代码埋点"><span class="level-left"><span class="level-item">6.5 代码埋点</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#6-5-1-用户登录"><span class="level-left"><span class="level-item">6.5.1 用户登录</span></span></a></li><li><a class="level is-mobile" href="#6-5-2-用户注销"><span class="level-left"><span class="level-item">6.5.2 用户注销</span></span></a></li><li><a class="level is-mobile" href="#6-5-3-配置用户组"><span class="level-left"><span class="level-item">6.5.3 配置用户组</span></span></a></li><li><a class="level is-mobile" href="#6-5-4-点击事件插码"><span class="level-left"><span class="level-item">6.5.4 点击事件插码</span></span></a></li><li><a class="level is-mobile" href="#6-5-5-曝光事件插码"><span class="level-left"><span class="level-item">6.5.5 曝光事件插码</span></span></a></li><li><a class="level is-mobile" href="#6-5-6-上传用户信息"><span class="level-left"><span class="level-item">6.5.6 上传用户信息</span></span></a></li><li><a class="level is-mobile" href="#6-5-7-错误上报"><span class="level-left"><span class="level-item">6.5.7 错误上报</span></span></a></li><li><a class="level is-mobile" href="#6-5-8-上传用户位置"><span class="level-left"><span class="level-item">6.5.8 上传用户位置</span></span></a></li><li><a class="level is-mobile" href="#6-5-9-完全自定义插码"><span class="level-left"><span class="level-item">6.5.9 完全自定义插码</span></span></a></li><li><a class="level is-mobile" href="#6-5-10-发送队列消息"><span class="level-left"><span class="level-item">6.5.10 发送队列消息</span></span></a></li></ul></li><li><a class="level is-mobile" href="#6-6-加密部分"><span class="level-left"><span class="level-item">6.6 加密部分</span></span></a></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/imglogo.png" alt="IMO&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2021 IMO</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/speam"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>