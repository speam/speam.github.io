<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>14-KVOåŸç† - IMO&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="IMO&#039;s Blog"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/avatar4.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="IMO&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description=""><meta property="og:type" content="blog"><meta property="og:title" content="14-KVOåŸç†"><meta property="og:url" content="http://evilimo.com/2021/03/26/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/14-KVO%E5%8E%9F%E7%90%86/"><meta property="og:site_name" content="IMO&#039;s Blog"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://raw.githubusercontent.com/speam/blogImgs/main/1-20210326110016951.png"><meta property="og:image" content="https://raw.githubusercontent.com/speam/blogImgs/main/1-20210326111146603.png"><meta property="og:image" content="https://raw.githubusercontent.com/speam/blogImgs/main/1-20210326111216225.png"><meta property="og:image" content="https://raw.githubusercontent.com/speam/blogImgs/main/1-20210326111516736.png"><meta property="og:image" content="https://raw.githubusercontent.com/speam/blogImgs/main/1-20210326111634225.png"><meta property="og:image" content="https://raw.githubusercontent.com/speam/blogImgs/main/1-20210326112140165.png"><meta property="og:image" content="https://raw.githubusercontent.com/speam/blogImgs/main/1-20210326113052837.png"><meta property="og:image" content="https://raw.githubusercontent.com/speam/blogImgs/main/1-20210326113218384.png"><meta property="og:image" content="https://raw.githubusercontent.com/speam/blogImgs/main/image-20210329174500156.png"><meta property="og:image" content="https://raw.githubusercontent.com/speam/blogImgs/main/image-20210329175903523.png"><meta property="article:published_time" content="2021-03-26T03:09:32.152Z"><meta property="article:modified_time" content="2021-03-30T07:10:28.287Z"><meta property="article:author" content="IMO"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://raw.githubusercontent.com/speam/blogImgs/main/1-20210326110016951.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://evilimo.com/2021/03/26/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/14-KVO%E5%8E%9F%E7%90%86/"},"headline":"IMO's Blog","image":["https://raw.githubusercontent.com/speam/blogImgs/main/1-20210326110016951.png","https://raw.githubusercontent.com/speam/blogImgs/main/1-20210326111146603.png","https://raw.githubusercontent.com/speam/blogImgs/main/1-20210326111216225.png","https://raw.githubusercontent.com/speam/blogImgs/main/1-20210326111516736.png","https://raw.githubusercontent.com/speam/blogImgs/main/1-20210326111634225.png","https://raw.githubusercontent.com/speam/blogImgs/main/1-20210326112140165.png","https://raw.githubusercontent.com/speam/blogImgs/main/1-20210326113052837.png","https://raw.githubusercontent.com/speam/blogImgs/main/1-20210326113218384.png","https://raw.githubusercontent.com/speam/blogImgs/main/image-20210329174500156.png","https://raw.githubusercontent.com/speam/blogImgs/main/image-20210329175903523.png"],"datePublished":"2021-03-26T03:09:32.152Z","dateModified":"2021-03-30T07:10:28.287Z","author":{"@type":"Person","name":"IMO"},"description":""}</script><link rel="canonical" href="http://evilimo.com/2021/03/26/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/14-KVO%E5%8E%9F%E7%90%86/"><link rel="icon" href="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/avatar4.png"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.4.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><!--!--><meta name="generator" content="Hexo 5.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/imglogo.png" alt="IMO&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">é¦–é¡µ</a><a class="navbar-item" href="/archives">å½’æ¡£</a><a class="navbar-item" href="/categories">åˆ†ç±»</a><a class="navbar-item" href="/about">å…³äº</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="ç›®å½•" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="æœç´¢" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-03-26T03:09:32.152Z" title="2021-03-26T03:09:32.152Z">2021-03-26</time>å‘è¡¨</span><span class="level-item"><time dateTime="2021-03-30T07:10:28.287Z" title="2021-03-30T07:10:28.287Z">2021-03-30</time>æ›´æ–°</span><span class="level-item"><a class="link-muted" href="/categories/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/">iOSÂ·åº•å±‚åŸç†</a></span></div></div><h1 class="title is-3 is-size-4-mobile">14-KVOåŸç†</h1><div class="content"><hr>
<a id="more"></a>

<h2 id="ä¸€ã€KVOç®€è¿°"><a href="#ä¸€ã€KVOç®€è¿°" class="headerlink" title="ä¸€ã€KVOç®€è¿°"></a>ä¸€ã€KVOç®€è¿°</h2><p><code>KVOï¼ˆKey-Value Observingï¼‰</code>æ˜¯ä¸€å¥—äº‹ä»¶è§‚å¯Ÿ &amp; é€šçŸ¥æœºåˆ¶ï¼Œå¼€å‘è€…å¯ä»¥ä½¿ç”¨å®ƒæ¥ç›‘æµ‹å¯¹è±¡å±æ€§çš„å˜åŒ–å¹¶åšå‡ºå“åº”ã€‚</p>
<p>åœ¨<a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/KeyValueObserving/KeyValueObserving.html">Documentation Archieve</a>ä¸­æåˆ°ä¸€å¥æƒ³è¦ç†è§£<code>KVO</code>ï¼Œå¿…é¡»å…ˆç†è§£<code>KVC</code>ï¼Œå› ä¸º<code>é”®å€¼è§‚å¯Ÿ</code>æ˜¯å»ºç«‹åœ¨<code>é”®å€¼ç¼–ç </code>çš„åŸºç¡€ä¸Šã€‚</p>
<blockquote>
<p>è€Œ<code>KVO</code>å’Œ<code>NSNotificatioCenter</code>éƒ½æ˜¯ iOS è§‚å¯Ÿè€…æ¨¡å¼çš„ä¸€ç§å®ç°ï¼Œä¸¤è€…çš„åŒºåˆ«åœ¨äºï¼š</p>
<ul>
<li>ç›¸å¯¹äºè¢«è§‚å¯Ÿè€…å’Œè§‚å¯Ÿè€…ä¹‹é—´çš„å…³ç³»ï¼Œ<code>KVO</code>æ˜¯ä¸€å¯¹ä¸€çš„ï¼Œ<code>NSNotificatioCenter</code>æ˜¯ä¸€å¯¹å¤šçš„</li>
<li><code>KVO</code>å¯¹è¢«ç›‘å¬å¯¹è±¡æ— ä¾µå…¥æ€§ï¼Œä¸éœ€è¦ä¿®æ”¹å…¶å†…éƒ¨ä»£ç å³å¯å®ç°ç›‘å¬</li>
</ul>
</blockquote>
<h2 id="äºŒã€KVOä½¿ç”¨åŠæ³¨æ„ç‚¹"><a href="#äºŒã€KVOä½¿ç”¨åŠæ³¨æ„ç‚¹" class="headerlink" title="äºŒã€KVOä½¿ç”¨åŠæ³¨æ„ç‚¹"></a>äºŒã€KVOä½¿ç”¨åŠæ³¨æ„ç‚¹</h2><h3 id="2-1-åŸºæœ¬ä½¿ç”¨"><a href="#2-1-åŸºæœ¬ä½¿ç”¨" class="headerlink" title="2.1 åŸºæœ¬ä½¿ç”¨"></a>2.1 åŸºæœ¬ä½¿ç”¨</h3><p>KVOä½¿ç”¨ä¸‰éƒ¨æ›²ï¼š</p>
<ul>
<li>æ³¨å†Œè§‚å¯Ÿè€…</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">self</span>.person addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@&quot;name&quot;</span> options:(<span class="built_in">NSKeyValueObservingOptionNew</span> | <span class="built_in">NSKeyValueObservingOptionOld</span>) context:<span class="literal">NULL</span>];</span><br></pre></td></tr></table></figure>

<ul>
<li>å®ç°å›è°ƒ</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>,<span class="keyword">id</span>&gt; *)change context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    <span class="keyword">if</span> ([keyPath isEqualToString:<span class="string">@&quot;name&quot;</span>]) <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, change);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ç§»é™¤è§‚å¯Ÿè€…</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">    [<span class="keyword">self</span>.person removeObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@&quot;name&quot;</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-context-è¯´æ˜"><a href="#2-2-context-è¯´æ˜" class="headerlink" title="2.2 context è¯´æ˜"></a>2.2 context è¯´æ˜</h3><p>å¦‚æœçˆ¶ç±»ä¸­æœ‰ä¸ª<code>name</code>å±æ€§ï¼Œå­ç±»ä¸­ä¹Ÿæœ‰ä¸ª<code>name</code>å±æ€§ï¼Œä¸¤è€…éƒ½æ³¨å†Œå¯¹<code>name</code>çš„è§‚å¯Ÿï¼Œé‚£ä¹ˆä»…é€šè¿‡<code>keyPath</code>å·²ç»åŒºåˆ†ä¸äº†æ˜¯å“ªä¸ª<code>name</code>å‘ç”Ÿå˜åŒ–äº†ï¼Œç°æœ‰ä¸¤ä¸ªè§£å†³åŠæ³•ï¼š</p>
<ul>
<li>å¤šåŠ ä¸€å±‚åˆ¤æ–­ï¼šåˆ¤æ–­<code>object</code>ï¼Œä½†æ˜¯ä¼šå‡ºç°å¾ˆå¤š ifâ€¦elseâ€¦</li>
<li>ä½¿ç”¨<code>context</code>ä¼ é€’ä¿¡æ¯ï¼Œæ›´å®‰å…¨ã€æ›´å¯æ‰©å±•</li>
</ul>
<p><strong><code>context</code>ä½¿ç”¨æ€»ç»“:</strong></p>
<ul>
<li>ä¸ä½¿ç”¨contextä½œä¸ºè§‚å¯Ÿå€¼</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// contextæ˜¯ void * ç±»å‹ï¼Œåº”è¯¥å¡« NULL è€Œä¸æ˜¯ nil</span></span><br><span class="line">[<span class="keyword">self</span>.person addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@&quot;name&quot;</span> options:(<span class="built_in">NSKeyValueObservingOptionNew</span>) context:<span class="literal">NULL</span>];</span><br></pre></td></tr></table></figure>

<ul>
<li>ä½¿ç”¨contextä¼ é€’ä¿¡æ¯</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *PersonNameContext = &amp;PersonNameContext;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *ChildNameContext = &amp;ChildNameContext;</span><br><span class="line"></span><br><span class="line">[<span class="keyword">self</span>.person addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@&quot;name&quot;</span> options:(<span class="built_in">NSKeyValueObservingOptionNew</span>) context:PersonNameContext];</span><br><span class="line">[<span class="keyword">self</span>.child addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@&quot;name&quot;</span> options:(<span class="built_in">NSKeyValueObservingOptionNew</span>) context:ChildNameContext];</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>,<span class="keyword">id</span>&gt; *)change context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    <span class="keyword">if</span> (context == PersonNameContext) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, change);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (context == ChildNameContext) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, change);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-ç§»é™¤è§‚å¯Ÿçš„å¿…è¦æ€§"><a href="#2-3-ç§»é™¤è§‚å¯Ÿçš„å¿…è¦æ€§" class="headerlink" title="2.3 ç§»é™¤è§‚å¯Ÿçš„å¿…è¦æ€§"></a>2.3 ç§»é™¤è§‚å¯Ÿçš„å¿…è¦æ€§</h3><p>ä¸ç§»é™¤ä¼šå¸¦æ¥æ½œåœ¨çš„éšæ‚£ï¼š</p>
<p>å¦‚æœè§‚å¯Ÿè€…å¯¹è±¡ dealloc çš„æ—¶å€™æ²¡æœ‰ç§»é™¤å¯¹ç›®æ ‡å±æ€§çš„è§‚å¯Ÿï¼Œå½“ç›®æ ‡å±æ€§æ”¹å˜çš„æ—¶å€™ï¼Œè¿˜æ˜¯ä¼šé€šçŸ¥è¯¥è§‚å¯Ÿè€…ï¼Œä½†æ˜¯è¯¥è§‚å¯Ÿè€…æ­¤æ—¶å·²ç»é‡Šæ”¾äº†ï¼Œå°±ä¼šå‡ºç°é‡æŒ‡é’ˆçš„æƒ…å†µã€‚</p>
<p>ä¾‹å¦‚ï¼š<code>LGPerson</code>æ˜¯ä¸€ä¸ªå•ä¾‹å¯¹è±¡ï¼Œå®ƒæœ‰ä¸ªå±æ€§<code>name</code>ã€‚ç„¶ååœ¨<code>FirstViewController</code>å’Œ<code>SecondViewController</code>ä¸­éƒ½å¯¹<code>LGPerson</code>å¯¹è±¡çš„<code>name</code>å±æ€§è¿›è¡Œäº†KVOè§‚å¯Ÿã€‚</p>
<p>æ“ä½œé¡ºåºæ˜¯ä»<code>FirstViewController</code>pushåˆ°<code>SecondViewController</code>ï¼Œç„¶åä»<code>SecondViewController</code>pop åˆ°<code>FirstViewController</code>ã€‚</p>
<p>å‡å¦‚<code>SecondViewController</code>åœ¨ dealloc çš„æ—¶å€™æ²¡æœ‰ç§»é™¤è§‚å¯Ÿè€…ï¼Œä½†æ˜¯è¿™ä¸ª<code>LGPerson</code>å¯¹è±¡ç”±äºæ˜¯å•ä¾‹æ‰€ä»¥æ²¡æœ‰é”€æ¯ã€‚ç„¶ååœ¨<code>FirstViewController</code>ä¸­<code>name</code>å±æ€§è¢«æ”¹å˜äº†ã€‚æ­¤æ—¶å°±ä¼šé€šçŸ¥å®ƒçš„è§‚å¯Ÿè€…å³<code>SecondViewController</code>ï¼Œä½†æ˜¯<code>SecondViewController</code>è¿™ä¸ªè§‚å¯Ÿè€…å·²ç»é‡Šæ”¾äº†ï¼Œå†æ¬¡è®¿é—®å®ƒå°±ä¼šé€ æˆè®¿é—®é‡æŒ‡é’ˆçš„æƒ…å†µã€‚</p>
<p><strong>æ‰€ä»¥è¯´ï¼Œè¯¥ç§»é™¤è§‚å¯Ÿçš„æ—¶å€™å°±è¦ç§»é™¤ã€‚</strong></p>
<blockquote>
<p>è‹¹æœå®˜æ–¹æ¨èçš„æ–¹å¼æ˜¯â€”â€”åœ¨<code>init</code>çš„æ—¶å€™è¿›è¡Œ<code>addObserver</code>ï¼Œåœ¨<code>dealloc</code>æ—¶<code>removeObserver</code>ï¼Œè¿™æ ·å¯ä»¥ä¿è¯<code>add</code>å’Œ<code>remove</code>æ˜¯æˆå¯¹å‡ºç°çš„ï¼Œè¿™æ˜¯ä¸€ç§æ¯”è¾ƒç†æƒ³çš„ä½¿ç”¨æ–¹å¼</p>
</blockquote>
<h3 id="2-4-æ‰‹åŠ¨è§¦å‘é”®å€¼è§‚å¯Ÿ"><a href="#2-4-æ‰‹åŠ¨è§¦å‘é”®å€¼è§‚å¯Ÿ" class="headerlink" title="2.4 æ‰‹åŠ¨è§¦å‘é”®å€¼è§‚å¯Ÿ"></a>2.4 æ‰‹åŠ¨è§¦å‘é”®å€¼è§‚å¯Ÿ</h3><p>æœ‰æ—¶å€™ä¸šåŠ¡éœ€æ±‚éœ€è¦è§‚å¯ŸæŸä¸ªå±æ€§å€¼ï¼Œä¸€ä¼šå„¿è¦è§‚å¯Ÿäº†ï¼Œä¸€ä¼šåˆä¸è¦è§‚å¯Ÿäº†â€¦å¦‚æœæŠŠ<code>KVOä¸‰éƒ¨æ›²</code>æ•´ä½“å»æ‰ã€å†æ•´ä½“æ·»ä¸Šï¼Œå¿…ç„¶åˆæ˜¯ä¸€é¡¿ç¹çè€Œåˆä¸å¿…è¦çš„å·¥ä½œï¼Œå¥½åœ¨KVOä¸­æœ‰ä¸¤ç§åŠæ³•å¯ä»¥æ‰‹åŠ¨è§¦å‘é”®å€¼è§‚å¯Ÿï¼š</p>
<ul>
<li>å°†è¢«è§‚å¯Ÿè€…çš„<code>automaticallyNotifiesObserversForKey</code>è¿”å›NOï¼ˆå¯ä»¥åªå¯¹æŸä¸ªå±æ€§è®¾ç½®ï¼‰ï¼Œè¿™æ ·å°±ä¸ä¼šè‡ªåŠ¨è§‚å¯Ÿå±æ€§çš„å˜åŒ–äº†ï¼Œè€Œæ˜¯é€šè¿‡æ‰‹åŠ¨é€šçŸ¥çš„æ–¹å¼å»è§‚å¯Ÿã€‚</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">BOOL</span>)automaticallyNotifiesObserversForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> ([key isEqualToString:<span class="string">@&quot;name&quot;</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> automaticallyNotifiesObserversForKey:key];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>ä½¿ç”¨<code>willChangeValueForKey</code>ã€<code>didChangeValueForKey</code>é‡å†™è¢«è§‚å¯Ÿè€…çš„å±æ€§çš„<code>setter</code>æ–¹æ³•</p>
<p>è¿™ä¸¤ä¸ªæ–¹æ³•ç”¨äºé€šçŸ¥ç³»ç»Ÿè¯¥ key çš„å±æ€§å€¼å³å°†å’Œå·²ç»å˜æ›´äº†</p>
</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setName:(<span class="built_in">NSString</span> *)name &#123;</span><br><span class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@&quot;name&quot;</span>];</span><br><span class="line">    _name = name;</span><br><span class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@&quot;name&quot;</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸¤ç§æ–¹å¼ä½¿ç”¨çš„æ’åˆ—ç»„åˆå¦‚ä¸‹ï¼Œå¯ä»¥è‡ªç”±ç»„åˆå¦‚ä½•ä½¿ç”¨</p>
<table>
<thead>
<tr>
<th>æƒ…å†µ</th>
<th>å›è°ƒæ¬¡æ•°</th>
</tr>
</thead>
<tbody><tr>
<td>æ­£å¸¸æƒ…å†µ</td>
<td>1</td>
</tr>
<tr>
<td>automaticallyNotifiesObserversForKeyä¸ºNO</td>
<td>0</td>
</tr>
<tr>
<td>automaticallyNotifiesObserversForKeyä¸ºNOä¸”æ·»åŠ willChangeValueForKeyã€didChangeValueForKey</td>
<td>1</td>
</tr>
<tr>
<td>automaticallyNotifiesObserversForKeyä¸ºYESä¸”æ·»åŠ willChangeValueForKeyã€didChangeValueForKey</td>
<td>2</td>
</tr>
</tbody></table>
<blockquote>
<p>æœ€è¿‘å‘ç°[self willChangeValueForKey:name]å’Œ[self willChangeValueForKey:â€nameâ€]ä¸¤ç§å†™æ³•æ˜¯ä¸åŒçš„ç»“æœï¼šé‡å†™setteræ–¹æ³•å–å±æ€§å€¼æ“ä½œä¸ä¼šé¢å¤–å‘é€é€šçŸ¥ï¼›è€Œä½¿ç”¨â€œnameâ€ä¼šé¢å¤–å‘é€ä¸€æ¬¡é€šçŸ¥</p>
</blockquote>
<h3 id="2-5-Key-ä¾èµ–æƒ…å†µ"><a href="#2-5-Key-ä¾èµ–æƒ…å†µ" class="headerlink" title="2.5 Key ä¾èµ–æƒ…å†µ"></a>2.5 Key ä¾èµ–æƒ…å†µ</h3><p>æ¯”å¦‚æœ‰ä¸€ä¸ªä¸‹è½½ä»»åŠ¡çš„éœ€æ±‚ï¼Œæ ¹æ®<code>æ€»ä¸‹è½½é‡Total</code>å’Œ<code>å½“å‰å·²ä¸‹è½½é‡Current</code>æ¥å¾—åˆ°<code>å½“å‰ä¸‹è½½è¿›åº¦progress</code>ï¼Œè¿™ä¸ªéœ€æ±‚å°±æœ‰ä¸¤ç§å®ç°ï¼š</p>
<ul>
<li>åˆ†åˆ«è§‚å¯Ÿ<code>æ€»ä¸‹è½½é‡Total</code>å’Œ<code>å½“å‰å·²ä¸‹è½½é‡Current</code>ä¸¤ä¸ªå±æ€§ï¼Œå…¶ä¸­ä¸€ä¸ªå±æ€§å‘ç”Ÿå˜åŒ–æ—¶è®¡ç®—æ±‚å€¼<code>å½“å‰ä¸‹è½½è¿›åº¦Process</code>ã€å¤ªéº»çƒ¦äº†ã€‘</li>
<li>å®ç°<code>keyPathsForValuesAffectingValueForKey</code>æ–¹æ³•ï¼Œå¹¶è§‚å¯Ÿ<code>progress</code>å±æ€§ã€é‡‡ç”¨ã€‘</li>
</ul>
<p><code>progress</code>å±æ€§å—åˆ°<code>current</code>å’Œ<code>total</code>å±æ€§å˜åŒ–çš„å½±å“ï¼Œå¦‚æœæˆ‘ä»¬æƒ³åªç›‘å¬<code>progress</code>ï¼Œåˆä¿è¯<code>current</code>å’Œ<code>total</code>å˜åŒ–æ—¶èƒ½æ”¶åˆ°<code>KVO</code>ä¸­çš„å›è°ƒå‘Šè¯‰æˆ‘ä»¬<code>progress</code>å˜åŒ–äº†ï¼Œæˆ‘ä»¬éœ€è¦å®ç°<code>+keyPathsForValuesAffectingValueForKey:</code>æ–¹æ³•æ¥å…³è”ä¸¤ä¸ªå±æ€§åˆ°<code>progress</code>ä¸Šï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSSet</span>&lt;<span class="built_in">NSString</span> *&gt; *)keyPathsForValuesAffectingValueForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="built_in">NSSet</span> *keyPaths = [<span class="keyword">super</span> keyPathsForValuesAffectingValueForKey:key];</span><br><span class="line">    <span class="keyword">if</span> ([key isEqualToString:<span class="string">@&quot;progress&quot;</span>]) &#123;</span><br><span class="line">        <span class="built_in">NSArray</span> *affectingKeys = @[<span class="string">@&quot;current&quot;</span>, <span class="string">@&quot;total&quot;</span>];</span><br><span class="line">        keyPaths = [keyPaths setByAddingObjectsFromArray:affectingKeys];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> keyPaths;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Person ç±»ä¸­<code>progess</code>å—åˆ°ä¸¤ä¸ªå±æ€§å˜åŒ–çš„å½±å“</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">CGFloat</span>)progress &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.current / <span class="keyword">self</span>.total;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ·»åŠ ç›‘å¬ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Person *p = [Person new];</span><br><span class="line"><span class="keyword">self</span>.person = p;</span><br><span class="line">p.current = <span class="number">0</span>;</span><br><span class="line">p.total = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">[<span class="keyword">self</span>.person addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@&quot;progress&quot;</span> options:(<span class="built_in">NSKeyValueObservingOptionNew</span>) context:<span class="literal">NULL</span>];</span><br></pre></td></tr></table></figure>

<p>ç›‘å¬å›è°ƒï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>,<span class="keyword">id</span>&gt; *)change context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, change);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·ï¼Œ<code>current</code>å’Œ<code>total</code>å˜åŒ–æ—¶ï¼Œå°±èƒ½ç›‘å¬åˆ°<code>progress</code>çš„å˜åŒ–äº†ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    <span class="keyword">self</span>.person.current += <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">self</span>.person.total += <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-6-å¯å˜æ•°ç»„"><a href="#2-6-å¯å˜æ•°ç»„" class="headerlink" title="2.6 å¯å˜æ•°ç»„"></a>2.6 å¯å˜æ•°ç»„</h3><p>é¦–å…ˆæ·»åŠ å¯¹<code>dataArray</code>è¿™ä¸ªå¯å˜æ•°ç»„çš„è§‚å¯Ÿï¼š</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">self</span>.person addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@&quot;dateArray&quot;</span> options:(<span class="built_in">NSKeyValueObservingOptionNew</span>) context:<span class="literal">NULL</span>];</span><br></pre></td></tr></table></figure>

<p>ç„¶åè°ƒç”¨ä¸‹é¢ä»£ç ï¼Œå¯¹<code>dateArray</code>æ•°ç»„æ·»åŠ å…ƒç´ </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">self</span>.person.dateArray addObject:<span class="string">@&quot;hello&quot;</span>];</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·ä¼šä¸ä¼šè§¦å‘KVOé€šçŸ¥å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¸ä¼šçš„ï¼Œå› ä¸ºKVOæ˜¯ç»™äºˆsetæ–¹æ³•çš„ï¼Œè¿™æ ·ä¸ä¼šè§¦å‘setæ–¹æ³•ï¼Œæ‰€ä»¥å°±ä¸ä¼šè§¦å‘KVOé€šçŸ¥ã€‚æ­£ç¡®çš„åšæ³•åº”è¯¥æ˜¯ä¸‹é¢è¿™æ ·</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="keyword">self</span>.person mutableArrayValueForKey:<span class="string">@&quot;dateArray&quot;</span>] addObject:<span class="string">@&quot;hello&quot;</span>];</span><br></pre></td></tr></table></figure>

<h2 id="ä¸‰ã€KVO-åº•å±‚åŸç†â€”isa-swizzling"><a href="#ä¸‰ã€KVO-åº•å±‚åŸç†â€”isa-swizzling" class="headerlink" title="ä¸‰ã€KVO åº•å±‚åŸç†â€”isa-swizzling"></a>ä¸‰ã€KVO åº•å±‚åŸç†â€”isa-swizzling</h2><h3 id="3-1-å®˜æ–¹è§£é‡Š"><a href="#3-1-å®˜æ–¹è§£é‡Š" class="headerlink" title="3.1 å®˜æ–¹è§£é‡Š"></a>3.1 å®˜æ–¹è§£é‡Š</h3><p><img src="https://raw.githubusercontent.com/speam/blogImgs/main/1-20210326110016951.png" alt="img"></p>
<p><code>Key-Value Observing Programming Guide</code>ä¸­æœ‰ä¸€æ®µåº•å±‚å®ç°åŸç†çš„å™è¿°</p>
<blockquote>
<ul>
<li>KVOæ˜¯ä½¿ç”¨<code>isa-swizzling</code>æŠ€æœ¯å®ç°çš„</li>
<li><code>isa</code>æŒ‡é’ˆæŒ‡å‘å¯¹è±¡çš„ç±»</li>
<li>åœ¨ä¸ºå¯¹è±¡çš„å±æ€§æ³¨å†Œè§‚å¯Ÿè€…æ—¶ï¼Œå°†ä¿®æ”¹è§‚å¯Ÿå¯¹è±¡çš„<code>isa</code>æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸­é—´ç±»è€Œä¸æ˜¯çœŸå®ç±»ã€‚æ‰€ä»¥<code>isa</code>æŒ‡é’ˆçš„å€¼ä¸ä¸€å®šåæ˜ å¯¹è±¡çš„å®é™…ç±»ã€‚</li>
<li>æ‚¨æ°¸è¿œä¸åº”ä¾é <code>isa</code>æŒ‡é’ˆæ¥ç¡®å®šç±»æˆå‘˜èº«ä»½ã€‚ç›¸åï¼Œæ‚¨åº”è¯¥ä½¿ç”¨<code>class</code>æ–¹æ³•æ¥ç¡®å®šå¯¹è±¡å®ä¾‹çš„ç±»</li>
</ul>
</blockquote>
<h3 id="3-2-ä»£ç æ¢ç´¢"><a href="#3-2-ä»£ç æ¢ç´¢" class="headerlink" title="3.2 ä»£ç æ¢ç´¢"></a>3.2 ä»£ç æ¢ç´¢</h3><ul>
<li><p>æ³¨å†Œè§‚å¯Ÿè€…ä¹‹å‰ï¼šç±»å¯¹è±¡ä¸º</p>
<p><code>FXPerson</code>ï¼Œå®ä¾‹å¯¹è±¡isaæŒ‡å‘<code>FXPerson</code></p>
<p><img src="https://raw.githubusercontent.com/speam/blogImgs/main/1-20210326111146603.png" alt="img"></p>
</li>
<li><p>æ³¨å†Œè§‚å¯Ÿè€…ä¹‹åï¼šç±»å¯¹è±¡ä¸º</p>
<p><code>FXPerson</code>ï¼Œå®ä¾‹å¯¹è±¡<code>isa</code>æŒ‡å‘<code>NSKVONotifying_FXPerson</code></p>
<p><img src="https://raw.githubusercontent.com/speam/blogImgs/main/1-20210326111216225.png" alt="img"></p>
</li>
</ul>
<p>ä»è¿™ä¸¤å›¾ä¸­å¯ä»¥å¾—å‡ºä¸€ä¸ªç»“è®ºï¼šè§‚å¯Ÿè€…æ³¨å†Œå‰å<code>FXPersonç±»</code>æ²¡å‘ç”Ÿå˜åŒ–ï¼Œä½†å®ä¾‹å¯¹è±¡çš„<code>isa</code>æŒ‡å‘å‘ç”Ÿäº†å˜åŒ–</p>
<p>é‚£ä¹ˆè¿™ä¸ªåŠ¨æ€ç”Ÿæˆçš„ä¸­é—´ç±»<code>NSKVONotifying_FXPerson</code>å’Œ<code>FXPerson</code>æ˜¯ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ</p>
<p>åœ¨æ³¨å†Œè§‚å¯Ÿè€…å‰ååˆ†åˆ«æ‰“å°å­ç±»â€”â€”å‘ç°<code>NSKVONotifying_FXPerson</code>æ˜¯<code>FXPerson</code>çš„å­ç±»</p>
<p><img src="https://raw.githubusercontent.com/speam/blogImgs/main/1-20210326111516736.png" alt="img"></p>
<h3 id="3-3-åŠ¨æ€å­ç±»æ¢ç´¢"><a href="#3-3-åŠ¨æ€å­ç±»æ¢ç´¢" class="headerlink" title="3.3 åŠ¨æ€å­ç±»æ¢ç´¢"></a>3.3 åŠ¨æ€å­ç±»æ¢ç´¢</h3><p>â‘ é¦–å…ˆå¾—æ˜ç™½åŠ¨æ€å­ç±»è§‚å¯Ÿçš„æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>ä¸‹é¢è§‚å¯Ÿ<code>å±æ€§å˜é‡name</code>å’Œ<code>æˆå‘˜å˜é‡nickname</code>æ¥æ‰¾åŒºåˆ«ï¼šä¸¤ä¸ªå˜é‡åŒæ—¶å‘ç”Ÿå˜åŒ–ï¼Œä½†åªæœ‰<code>å±æ€§å˜é‡</code>ç›‘å¬åˆ°å›è°ƒâ€”â€”è¯´æ˜åŠ¨æ€å­ç±»è§‚å¯Ÿçš„æ˜¯<code>setter</code>æ–¹æ³•</p>
<p><img src="https://raw.githubusercontent.com/speam/blogImgs/main/1-20210326111634225.png" alt="img"></p>
<p>â‘¡é€šè¿‡<code>runtime-API</code>æ‰“å°ä¸€ä¸‹åŠ¨æ€å­ç±»å’Œè§‚å¯Ÿç±»çš„æ–¹æ³•</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)printClassAllMethod:(Class)cls &#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    Method *methodList = class_copyMethodList(cls, &amp;count);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt;count; i++) &#123;</span><br><span class="line">        Method method = methodList[i];</span><br><span class="line">        SEL sel = method_getName(method);</span><br><span class="line">        IMP imp = class_getMethodImplementation(cls, sel);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%@-%p&quot;</span>,<span class="built_in">NSStringFromSelector</span>(sel),imp);</span><br><span class="line">    &#125;</span><br><span class="line">    free(methodList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/speam/blogImgs/main/1-20210326112140165.png" alt="img"></p>
<p>é€šè¿‡æ‰“å°å¯ä»¥çœ‹å‡ºï¼š</p>
<ul>
<li><code>FXPersonç±»</code>ä¸­çš„æ–¹æ³•æ²¡æœ‰æ”¹å˜ï¼ˆimpå®ç°åœ°å€æ²¡æœ‰å˜åŒ–ï¼‰</li>
<li><code>NSKVONotifying_FXPersonç±»</code>ä¸­é‡å†™äº†çˆ¶ç±»<code>FXPerson</code>çš„<code>dealloc</code>æ–¹æ³•</li>
<li><code>NSKVONotifying_FXPersonç±»</code>ä¸­é‡å†™äº†åŸºç±»<code>NSObject</code>çš„<code>class</code>æ–¹æ³•å’Œ<code>_isKVOA</code>æ–¹æ³•<ul>
<li>é‡å†™çš„<code>class</code>æ–¹æ³•å¯ä»¥æŒ‡å›<code>FXPersonç±»</code></li>
</ul>
</li>
<li><code>NSKVONotifying_FXPerson</code>ç±»ä¸­é‡å†™äº†çˆ¶ç±»<code>FXPerson</code>çš„<code>setName</code>æ–¹æ³•<ul>
<li>å› ä¸ºå­ç±»åªç»§æ‰¿ã€ä¸é‡å†™æ˜¯ä¸ä¼šæœ‰æ–¹æ³•impçš„ï¼ˆé‚£ä¹ˆè°ƒç”¨æ–¹æ³•æ—¶ä¼šé—®çˆ¶ç±»è¦æ–¹æ³•å®ç°ï¼‰</li>
<li>ä¸”ä¸¤ä¸ª<code>setName</code>çš„åœ°å€æŒ‡é’ˆä¸ä¸€æ ·</li>
<li>æ¯è§‚å¯Ÿä¸€ä¸ª<code>å±æ€§å˜é‡</code>å°±é‡å†™ä¸€ä¸ª<code>setter</code>æ–¹æ³•ï¼ˆå¯è‡ªè¡Œè®ºè¯ï¼‰</li>
</ul>
</li>
</ul>
<p>â‘¢<code>dealloc</code>ä¹‹å<code>isa</code>æŒ‡å‘è°ï¼Ÿâ€”â€”æŒ‡å›åŸç±»</p>
<p><img src="https://raw.githubusercontent.com/speam/blogImgs/main/1-20210326113052837.png" alt="img"></p>
<p>â‘£<code>dealloc</code>ä¹‹ååŠ¨æ€å­ç±»ä¼šé”€æ¯å—ï¼Ÿâ€”â€”ä¸ä¼š</p>
<p>é¡µé¢popåå†æ¬¡pushè¿›æ¥æ‰“å°<code>FXPersonç±»</code>çš„å­ç±»ï¼Œå­ç±»<code>NSKVONotifying_FXPersonç±»</code>ä¾æ—§å­˜åœ¨</p>
<p><img src="https://raw.githubusercontent.com/speam/blogImgs/main/1-20210326113218384.png" alt="img"></p>
<p>â‘¤<code>automaticallyNotifiesObserversForKey</code>æ˜¯å¦ä¼šå½±å“åŠ¨æ€å­ç±»ç”Ÿæˆâ€”â€”ä¼š</p>
<p>åŠ¨æ€å­ç±»ä¼šæ ¹æ®è§‚å¯Ÿå±æ€§çš„<code>automaticallyNotifiesObserversForKey</code>çš„å¸ƒå°”å€¼æ¥å†³å®šæ˜¯å¦ç”Ÿæˆ</p>
<h3 id="3-4-æ€»ç»“"><a href="#3-4-æ€»ç»“" class="headerlink" title="3.4 æ€»ç»“"></a>3.4 æ€»ç»“</h3><ol>
<li><code>automaticallyNotifiesObserversForKey</code>ä¸º<code>YES</code>æ—¶æ³¨å†Œè§‚å¯Ÿå±æ€§ä¼šç”ŸæˆåŠ¨æ€å­ç±»<code>NSKVONotifying_XXX</code></li>
<li>åŠ¨æ€å­ç±»è§‚å¯Ÿçš„æ˜¯<code>setter</code>æ–¹æ³•</li>
<li>åŠ¨æ€å­ç±»é‡å†™äº†è§‚å¯Ÿå±æ€§çš„<code>setter</code>æ–¹æ³•ã€<code>dealloc</code>ã€<code>class</code>ã€<code>_isKVOA</code>æ–¹æ³•<ul>
<li><code>setter</code>æ–¹æ³•ç”¨äºè§‚å¯Ÿé”®å€¼</li>
<li><code>dealloc</code>æ–¹æ³•ç”¨äºé‡Šæ”¾æ—¶å°†<code>isa</code>æŒ‡å‘åŸæ¥çš„ç±»</li>
<li><code>class</code>æ–¹æ³•ç”¨äºæŒ‡å›åŠ¨æ€å­ç±»çš„çˆ¶ç±»</li>
<li><code>_isKVOA</code>ç”¨æ¥æ ‡è¯†æ˜¯å¦æ˜¯åœ¨è§‚å¯Ÿè€…çŠ¶æ€çš„ä¸€ä¸ªæ ‡å¿—ä½</li>
</ul>
</li>
<li><code>dealloc</code>ä¹‹å<code>isa</code>æŒ‡å‘åŸæ¥çš„ç±»</li>
<li><code>dealloc</code>ä¹‹ååŠ¨æ€å­ç±»ä¸ä¼šé”€æ¯</li>
</ol>
<h3 id="3-5-åŸç†å›¾"><a href="#3-5-åŸç†å›¾" class="headerlink" title="3.5 åŸç†å›¾"></a>3.5 åŸç†å›¾</h3><p>å‡è®¾æˆ‘ä»¬è¦è§‚å¯Ÿçš„æ˜¯ Person å®ä¾‹å¯¹è±¡çš„ age å±æ€§ã€‚</p>
<h4 id="æ·»åŠ è§‚å¯Ÿè€…ä¹‹å‰"><a href="#æ·»åŠ è§‚å¯Ÿè€…ä¹‹å‰" class="headerlink" title="æ·»åŠ è§‚å¯Ÿè€…ä¹‹å‰"></a>æ·»åŠ è§‚å¯Ÿè€…ä¹‹å‰</h4><img src="https://raw.githubusercontent.com/speam/blogImgs/main/image-20210329174500156.png" alt="image-20210329174500156" style="zoom:50%;" />

<h4 id="æ·»åŠ è§‚å¯Ÿè€…ä¹‹å"><a href="#æ·»åŠ è§‚å¯Ÿè€…ä¹‹å" class="headerlink" title="æ·»åŠ è§‚å¯Ÿè€…ä¹‹å"></a>æ·»åŠ è§‚å¯Ÿè€…ä¹‹å</h4><img src="https://raw.githubusercontent.com/speam/blogImgs/main/image-20210329175903523.png" alt="image-20210329175903523" style="zoom: 50%;" />

<h2 id="å››ã€è‡ªå·±å®ç°KVO"><a href="#å››ã€è‡ªå·±å®ç°KVO" class="headerlink" title="å››ã€è‡ªå·±å®ç°KVO"></a>å››ã€è‡ªå·±å®ç°KVO</h2><p>æˆ‘çš„å®Œæ•´ä»£ç å·²æ”¾åˆ° GitHubï¼š<a target="_blank" rel="noopener" href="https://github.com/speam/ExploreKVO.git">LinkğŸ”—</a></p>
<h3 id="4-1-å‰è¨€"><a href="#4-1-å‰è¨€" class="headerlink" title="4.1 å‰è¨€"></a>4.1 å‰è¨€</h3><p>ä¸‹é¢æˆ‘ä»¬æ ¹æ®ç³»ç»Ÿ KVO çš„åŸç†ï¼Œç®€å•å®ç°ä¸€ä¸‹ KVOã€‚</p>
<ul>
<li><p>æ­¤è¿‡ç¨‹ä¸­ä¼šæœ‰ runtime-API çš„ä½¿ç”¨å’Œæ¥å£è®¾è®¡æ€è·¯çš„è®²è§£ï¼Œæœ€ç»ˆçš„è‡ªå®šä¹‰ KVO èƒ½æ»¡è¶³åŸºæœ¬ä½¿ç”¨çš„éœ€æ±‚ä½†ä»ä¸å®Œå–„ï¼Œä½†æ­¤è¿‡ç¨‹ä¸­æœ€é‡è¦çš„æ˜¯äº†è§£å¹¶æ¨¡ä»¿ç³»ç»Ÿå®ç°åŸç†ï¼Œä»¥åŠåŠ æ·±å¯¹ runtime çš„ç†è§£ã€‚</p>
</li>
<li><p>ç³»ç»Ÿçš„ KVO æ³¨å†Œã€å›è°ƒã€è‡ªåŠ¨ç§»é™¤è§‚å¯Ÿè€…åœ¨å†™æ³•ä¸Šéƒ½æ˜¯åˆ†ç¦»çš„ï¼Œä½¿ç”¨èµ·æ¥ç¨æ˜¾ä¸ç®€æ´ï¼Œæ‰€ä»¥æˆ‘ä»¬è‡ªå®šä¹‰çš„ KVO å°†ä½¿ç”¨ block å›è°ƒå’Œè‡ªåŠ¨é‡Šæ”¾æ¥ä¼˜åŒ–è¿™ä¸€ç‚¹ä¸è¶³ã€‚</p>
</li>
<li><p>è‡ªå®šä¹‰ KVO çš„ä¼˜åŒ–å…¶å®æ˜¯å‚è€ƒäº† <a target="_blank" rel="noopener" href="https://github.com/facebookarchive/KVOController">FBKVOController</a> çš„å®ç°ï¼Œä½† FBKVOController æ˜¯é€šè¿‡ä¸­é—´å±‚å¯¹ç›¸åº”å±æ€§è¿›è¡Œè§‚å¯Ÿï¼Œç„¶åå›è°ƒåˆ°è§‚å¯Ÿè€…ï¼Œå…¶åœ¨å†…å­˜ç®¡ç†ä¸Šæ›´åŠ å®‰å…¨ï¼›æˆ‘ä»¬çš„è‡ªå®šä¹‰ KVO æ˜¯ç›´æ¥è¿›è¡Œè§‚å¯Ÿï¼Œé€»è¾‘ä¸Šæ›´ç®€å•æ˜“æ‡‚ã€‚</p>
</li>
</ul>
<p>é¦–å…ˆå›é¡¾ç³»ç»Ÿ KVO çš„é€»è¾‘ï¼š</p>
<p>1.<code>automaticallyNotifiesObserversForKey</code>ä¸º<code>YES</code>æ—¶ï¼Œæ³¨å†Œè§‚å¯Ÿå±æ€§ä¼šç”ŸæˆåŠ¨æ€å­ç±»<code>NSKVONotifying_XXX</code></p>
<p>2.åŠ¨æ€å­ç±»è§‚å¯Ÿçš„æ˜¯å¯¹åº”å±æ€§çš„<code>setter</code>æ–¹æ³•</p>
<p>3.åŠ¨æ€å­ç±»é‡å†™äº†è§‚å¯Ÿå±æ€§çš„<code>setter</code>æ–¹æ³•ã€<code>dealloc</code>ã€<code>class</code>ã€<code>_isKVOA</code>æ–¹æ³•</p>
<ul>
<li><code>setter</code>æ–¹æ³•ç”¨äºè§‚å¯Ÿé”®å€¼</li>
<li><code>dealloc</code>æ–¹æ³•ç”¨äºé‡Šæ”¾æ—¶å°†<code>isa</code>æŒ‡å‘åŸæ¥çš„ç±»</li>
<li><code>class</code>æ–¹æ³•ç”¨äºæŒ‡å›åŠ¨æ€å­ç±»çš„çˆ¶ç±»</li>
<li><code>_isKVOA</code>ç”¨æ¥æ ‡è¯†æ˜¯å¦æ˜¯åœ¨è§‚å¯Ÿè€…çŠ¶æ€çš„ä¸€ä¸ªæ ‡å¿—ä½ã€è¿™ä¸ªæ²¡å®ç°ã€‘</li>
</ul>
<p>4.<code>dealloc</code>ä¹‹å<code>isa</code>æŒ‡å‘åŸæ¥çš„ç±»</p>
<p>5.<code>dealloc</code>ä¹‹ååŠ¨æ€å­ç±»ä¸ä¼šé”€æ¯</p>
<h3 id="4-2-åˆå§‹åŒ–"><a href="#4-2-åˆå§‹åŒ–" class="headerlink" title="4.2 åˆå§‹åŒ–"></a>4.2 åˆå§‹åŒ–</h3><p>åˆ›å»ºNSObjectçš„åˆ†ç±»ï¼šNSObject+JYKVOï¼Œæä¾›æ·»åŠ è§‚å¯Ÿè€…çš„æ¥å£ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NS_ASSUME_NONNULL_BEGIN</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span>(^JYKVOBlock)(<span class="keyword">id</span> observer, <span class="built_in">NSString</span> *keyPath, <span class="keyword">id</span> oldValue,<span class="keyword">id</span> newValue);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">JYKVO</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/// å¯¹å±æ€§æ·»åŠ è§‚å¯Ÿ</span></span><br><span class="line"><span class="comment">/// @param observer è§‚å¯Ÿè€…</span></span><br><span class="line"><span class="comment">/// @param keyPath è§‚å¯Ÿçš„å±æ€§</span></span><br><span class="line"><span class="comment">/// @param block å±æ€§æ”¹å˜åçš„å›è°ƒ</span></span><br><span class="line">- (<span class="keyword">void</span>)jy_addObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath block:(JYKVOBlock)block;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NS_ASSUME_NONNULL_END</span></span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢å¼€å§‹å®ç°<code>jy_addObserver:forKeyPath:block:</code>æ–¹æ³•ï¼š</p>
<h3 id="4-3-éªŒè¯æ˜¯å¦å­˜åœ¨setteræ–¹æ³•ï¼Œåªè§‚å¯Ÿå±æ€§"><a href="#4-3-éªŒè¯æ˜¯å¦å­˜åœ¨setteræ–¹æ³•ï¼Œåªè§‚å¯Ÿå±æ€§" class="headerlink" title="4.3 éªŒè¯æ˜¯å¦å­˜åœ¨setteræ–¹æ³•ï¼Œåªè§‚å¯Ÿå±æ€§"></a>4.3 éªŒè¯æ˜¯å¦å­˜åœ¨setteræ–¹æ³•ï¼Œåªè§‚å¯Ÿå±æ€§</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ¤æ–­æ˜¯å¦æœ‰å¯¹åº”çš„ setter</span></span><br><span class="line">  <span class="keyword">if</span> (![<span class="keyword">self</span> isContainSetterMethodFromKeyPath:keyPath]) <span class="keyword">return</span>;</span><br></pre></td></tr></table></figure>

<p><code>isContainSetterMethodFromKeyPath:</code>æ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// åˆ¤æ–­æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ setter</span></span><br><span class="line"><span class="comment">/// @param keyPath å±æ€§å</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)isContainSetterMethodFromKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    Class <span class="keyword">class</span>         = object_getClass(<span class="keyword">self</span>);</span><br><span class="line">    SEL setterSeletor   = <span class="built_in">NSSelectorFromString</span>(setterForKeyPath(keyPath));</span><br><span class="line">    Method setterMethod = class_getInstanceMethod(<span class="keyword">class</span>, setterSeletor);</span><br><span class="line">    <span class="keyword">if</span> (!setterMethod) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;æ²¡æ‰¾åˆ°å±æ€§:%@çš„setteræ–¹æ³•&quot;</span>, keyPath);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-4-åˆ¤æ–­automaticallyNotifiesObserversForKeyæ–¹æ³•è¿”å›çš„å¸ƒå°”å€¼"><a href="#4-4-åˆ¤æ–­automaticallyNotifiesObserversForKeyæ–¹æ³•è¿”å›çš„å¸ƒå°”å€¼" class="headerlink" title="4.4 åˆ¤æ–­automaticallyNotifiesObserversForKeyæ–¹æ³•è¿”å›çš„å¸ƒå°”å€¼"></a>4.4 åˆ¤æ–­automaticallyNotifiesObserversForKeyæ–¹æ³•è¿”å›çš„å¸ƒå°”å€¼</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">BOOL</span> isAutomatically = [<span class="keyword">self</span> jy_performSelectorWithMethodName:<span class="string">@&quot;automaticallyNotifiesObserversForKey:&quot;</span> keyPath:keyPath];</span><br><span class="line"><span class="keyword">if</span> (!isAutomatically) <span class="keyword">return</span>;</span><br></pre></td></tr></table></figure>

<p>ä¸º<code>YES</code>æ—¶æ‰ä¼šç»§ç»­</p>
<h3 id="4-5-åŠ¨æ€ç”Ÿæˆå­ç±»"><a href="#4-5-åŠ¨æ€ç”Ÿæˆå­ç±»" class="headerlink" title="4.5 åŠ¨æ€ç”Ÿæˆå­ç±»"></a>4.5 åŠ¨æ€ç”Ÿæˆå­ç±»</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŠ¨æ€ç”Ÿæˆå­ç±»</span></span><br><span class="line">Class newClass = [<span class="keyword">self</span> createChildClassWithKeyPath:keyPath];</span><br></pre></td></tr></table></figure>

<p><code>createChildClassWithKeyPath:</code>æ–¹æ³•æ˜¯æˆ‘ä»¬çš„æ ¸å¿ƒæ–¹æ³•ï¼Œåˆ†æ­¥æ¥çœ‹ï¼š</p>
<p>â‘´ æ ¹æ® keyPath æ‹¼æ¥ä¸­é—´ç±»çš„åç§°ï¼Œç„¶åå¦‚æœä¸å­˜åœ¨ä¸­é—´ç±»çš„è¯ï¼Œå°±åˆ›å»ºï¼Œå¦‚æœå·²ç»å­˜åœ¨ï¼Œä¸éœ€è¦é‡å¤åˆ›å»º</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–æ–°ç±»çš„ç±»å</span></span><br><span class="line">    <span class="built_in">NSString</span> *oldClassName = <span class="built_in">NSStringFromClass</span>([<span class="keyword">self</span> <span class="keyword">class</span>]);</span><br><span class="line">    <span class="built_in">NSString</span> *newClassName = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;%@%@&quot;</span>, kJYKVOPrefix, oldClassName];</span><br><span class="line">    Class newClass = <span class="built_in">NSClassFromString</span>(newClassName);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é˜²æ­¢é‡å¤åˆ›å»ºæ–°ç±»</span></span><br><span class="line">    <span class="keyword">if</span> (newClass) <span class="keyword">return</span> newClass;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”³è¯·ç±»</span></span><br><span class="line"><span class="comment">     * å¦‚æœå†…å­˜ä¸­ä¸å­˜åœ¨, åˆ›å»ºç”Ÿæˆ</span></span><br><span class="line"><span class="comment">     * å‚æ•°ä¸€: çˆ¶ç±»</span></span><br><span class="line"><span class="comment">     * å‚æ•°äºŒ: æ–°ç±»çš„åå­—</span></span><br><span class="line"><span class="comment">     * å‚æ•°ä¸‰: æ–°ç±»çš„å¼€è¾Ÿçš„é¢å¤–ç©ºé—´</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    newClass = objc_allocateClassPair([<span class="keyword">self</span> <span class="keyword">class</span>], newClassName.UTF8String, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// æ³¨å†Œç±»</span></span><br><span class="line">    objc_registerClassPair(newClass);</span><br></pre></td></tr></table></figure>

<p>â‘µ æ·»åŠ <code>+class</code>æ–¹æ³•</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ·»åŠ  +class æ–¹æ³•</span></span><br><span class="line">SEL classSEL = <span class="built_in">NSSelectorFromString</span>(<span class="string">@&quot;class&quot;</span>);</span><br><span class="line">Method classMethod = class_getInstanceMethod([<span class="keyword">self</span> <span class="keyword">class</span>], classSEL);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *classTypes = method_getTypeEncoding(classMethod);</span><br><span class="line">class_addMethod(newClass, classSEL, (IMP)jy_class, classTypes);</span><br></pre></td></tr></table></figure>

<p>â‘¶ æ·»åŠ å¯¹åº”å±æ€§çš„<code>setter</code>æ–¹æ³•</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ·»åŠ  setter</span></span><br><span class="line">SEL setterSEL = <span class="built_in">NSSelectorFromString</span>(setterForKeyPath(keyPath));</span><br><span class="line">Method setterMethod = class_getInstanceMethod([<span class="keyword">self</span> <span class="keyword">class</span>], setterSEL);</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *setterTypes = method_getTypeEncoding(setterMethod);</span><br><span class="line">class_addMethod(newClass, setterSEL, (IMP)jy_setter, setterTypes);</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>jy_setter</code>æ˜¯æˆ‘ä»¬è‡ªå·±å¯¹<code>setter</code>æ–¹æ³•çš„å®ç°ï¼Œæ€è·¯å¦‚ä¸‹ï¼š</p>
<p>â‘  å› ä¸ºæˆ‘ä»¬ä½¿ç”¨KVOæ—¶å€™ï¼Œæ˜¯å¯¹æ“ä½œçš„ç±»(ä¾‹å¦‚ LGPerson)çš„å±æ€§èµ‹å€¼ï¼Œè¿™é‡Œå› ä¸ºå°† isa æŒ‡å‘äº†æ–°åˆ›å»ºçš„ä¸­é—´å­ç±»(NSKVONotifying_LGPerson)ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦è°ƒç”¨çˆ¶ç±»(LGPerson)çš„setter æ–¹æ³•è¿›è¡Œå±æ€§èµ‹å€¼ã€‚æˆ‘ä»¬è¿™é‡Œé€šè¿‡<code>objc_msgSendSuper</code>å‘é€æ¶ˆæ¯æ¥å®ç°ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1ï¸âƒ£è½¬å‘ç»™çˆ¶ç±»ï¼Œæ”¹å˜çˆ¶ç±»çš„å€¼</span></span><br><span class="line"><span class="keyword">void</span> (*jy_msgSendSuper)(<span class="keyword">void</span> *, SEL, <span class="keyword">id</span>) = (<span class="keyword">void</span> *)objc_msgSendSuper;</span><br><span class="line"><span class="keyword">struct</span> objc_super superStruct = &#123;</span><br><span class="line">    .receiver = <span class="keyword">self</span>,</span><br><span class="line">    .super_class = class_getSuperclass(object_getClass(<span class="keyword">self</span>)),</span><br><span class="line">&#125;;</span><br><span class="line">jy_msgSendSuper(&amp;superStruct, _cmd, newValue);</span><br></pre></td></tr></table></figure>

<p>â‘¡ å–åŸæ¥çš„å€¼ï¼Œç”¨äºå›è°ƒ</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2ï¸âƒ£å–æ—§å€¼</span></span><br><span class="line"><span class="built_in">NSString</span> *keyPath = getterForSetter(<span class="built_in">NSStringFromSelector</span>(_cmd));</span><br><span class="line"><span class="keyword">id</span> oldValue = [<span class="keyword">self</span> valueForKey:keyPath];</span><br></pre></td></tr></table></figure>

<p>â‘¢ å±æ€§æ”¹å˜åæˆ‘ä»¬è¿˜éœ€è¦é€šè¿‡ block çš„æ–¹å¼å›è°ƒåˆ°æ·»åŠ è§‚å¯Ÿçš„åœ°æ–¹</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3ï¸âƒ£é€šçŸ¥è§‚å¯Ÿè€…</span></span><br><span class="line"><span class="comment">// 1.æ‹¿åˆ°è§‚å¯Ÿè€…ï¼Œåœ¨æ·»åŠ è§‚å¯Ÿè€…çš„æ—¶å€™é€šè¿‡å…³è”å¯¹è±¡å°† observer å­˜å‚¨äº†èµ·æ¥ã€‚</span></span><br><span class="line"><span class="built_in">NSMutableArray</span> *mArray = objc_getAssociatedObject(<span class="keyword">self</span>, (__bridge <span class="keyword">const</span> <span class="keyword">void</span> * _Nonnull)(kJYKVOAssiociateKey));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.æ¶ˆæ¯å‘é€ç»™è§‚å¯Ÿè€…</span></span><br><span class="line"><span class="keyword">for</span> (JYKVOInfo *info <span class="keyword">in</span> mArray) &#123;</span><br><span class="line">    <span class="keyword">if</span> ([info.keyPath isEqualToString:keyPath] &amp;&amp; info.handleBlock) &#123;</span><br><span class="line">        info.handleBlock(info.observer, keyPath, oldValue, newValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â‘· ç„¶åä¸ºäº†å®ç°è‡ªåŠ¨ç§»é™¤è§‚å¯Ÿè€…ï¼Œæˆ‘ä»¬è¿˜è¦äº¤æ¢ä¸€ä¸‹ dealloc æ–¹æ³•çš„å®ç°ï¼Œåœ¨é‡Œé¢åšä¸€äº›äº‹æƒ…</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// äº¤æ¢ dealloc å®ç°</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line"><span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">    [<span class="keyword">self</span> JYMethodSwizzlingWithClass:[<span class="keyword">self</span> <span class="keyword">class</span>] oriSEL:<span class="built_in">NSSelectorFromString</span>(<span class="string">@&quot;dealloc&quot;</span>) swizzledSEL:<span class="keyword">@selector</span>(jy_dealloc)];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å½“å¯¹è±¡é”€æ¯çš„æ—¶å€™ä¼šè°ƒç”¨ deallocï¼Œåœ¨è¯¥æ–¹æ³•ä¸­å°† isa æŒ‡é’ˆé‡æ–°æŒ‡å‘åŸæ¥çš„ç±»</span></span><br><span class="line">- (<span class="keyword">void</span>)jy_dealloc &#123;</span><br><span class="line">    Class superClass = [<span class="keyword">self</span> <span class="keyword">class</span>];</span><br><span class="line">    object_setClass(<span class="keyword">self</span>, superClass);</span><br><span class="line">    [<span class="keyword">self</span> jy_dealloc];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-6-å°†isaæŒ‡å‘åˆ›å»ºå¥½çš„åŠ¨æ€å­ç±»"><a href="#4-6-å°†isaæŒ‡å‘åˆ›å»ºå¥½çš„åŠ¨æ€å­ç±»" class="headerlink" title="4.6 å°†isaæŒ‡å‘åˆ›å»ºå¥½çš„åŠ¨æ€å­ç±»"></a>4.6 å°†isaæŒ‡å‘åˆ›å»ºå¥½çš„åŠ¨æ€å­ç±»</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// isaæŒ‡å‘ä¿®æ”¹-&gt;æŒ‡å‘åŠ¨æ€å­ç±»</span></span><br><span class="line">object_setClass(<span class="keyword">self</span>, newClass);</span><br></pre></td></tr></table></figure>

<h3 id="4-7-ä¿å­˜observerä¿¡æ¯ï¼Œåœ¨setteræ–¹æ³•ä¸­é€šçŸ¥observerçš„æ—¶å€™éœ€è¦ç”¨åˆ°è¯¥ä¿¡æ¯"><a href="#4-7-ä¿å­˜observerä¿¡æ¯ï¼Œåœ¨setteræ–¹æ³•ä¸­é€šçŸ¥observerçš„æ—¶å€™éœ€è¦ç”¨åˆ°è¯¥ä¿¡æ¯" class="headerlink" title="4.7 ä¿å­˜observerä¿¡æ¯ï¼Œåœ¨setteræ–¹æ³•ä¸­é€šçŸ¥observerçš„æ—¶å€™éœ€è¦ç”¨åˆ°è¯¥ä¿¡æ¯"></a>4.7 ä¿å­˜observerä¿¡æ¯ï¼Œåœ¨setteræ–¹æ³•ä¸­é€šçŸ¥observerçš„æ—¶å€™éœ€è¦ç”¨åˆ°è¯¥ä¿¡æ¯</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¿å­˜ä¿¡æ¯</span></span><br><span class="line">JYKVOInfo *info = [[JYKVOInfo alloc] initWitObserver:observer forKeyPath:keyPath handleBlock:block];</span><br><span class="line"><span class="built_in">NSMutableArray</span> *mArray = objc_getAssociatedObject(<span class="keyword">self</span>, (__bridge <span class="keyword">const</span> <span class="keyword">void</span> * _Nonnull)(kJYKVOAssiociateKey));</span><br><span class="line"><span class="keyword">if</span> (!mArray) &#123;</span><br><span class="line">    mArray = [<span class="built_in">NSMutableArray</span> arrayWithCapacity:<span class="number">1</span>];</span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, (__bridge <span class="keyword">const</span> <span class="keyword">void</span> * _Nonnull)(kJYKVOAssiociateKey), mArray, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">&#125;</span><br><span class="line">[mArray addObject:info];</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ä½¿ç”¨<code>JYKVOInfo</code>è¿™ä¸ª<code>model</code>æ¥å­˜å‚¨<code>observer</code>ä¿¡æ¯ï¼Œå› ä¸ºå¯èƒ½ä¼šè¿˜æœ‰å¤šä¸ª<code>observer</code>ï¼Œæ‰€ä»¥ä½¿ç”¨æ•°ç»„çš„å½¢å¼è¿›è¡Œå­˜å‚¨ã€‚</p>
<p>ç°åœ¨å¯ä»¥ç»™ä¸€ä¸ªå±æ€§æ·»åŠ è§‚å¯Ÿæµ‹è¯•ä¸€ä¸‹äº†ã€‚</p>
<h3 id="4-8-æµ‹è¯•"><a href="#4-8-æµ‹è¯•" class="headerlink" title="4.8 æµ‹è¯•"></a>4.8 æµ‹è¯•</h3><p>ä¾æ—§æ˜¯<code>Person</code>ç±»ï¼Œæœ‰ä¸€ä¸ªç®€å•çš„<code>name</code>æˆå‘˜å±æ€§ã€‚</p>
<p>ä¸‹é¢åœ¨æ§åˆ¶å™¨ä¸­æ·»åŠ å¯¹<code>name</code>å±æ€§çš„è§‚å¯Ÿï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.person = [Person new];</span><br><span class="line"><span class="keyword">self</span>.person.name = <span class="string">@&quot;æ—§åå­—&quot;</span>;</span><br><span class="line"></span><br><span class="line">[<span class="keyword">self</span>.person jy_addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@&quot;name&quot;</span> block:^(<span class="keyword">id</span>  _Nonnull observer, <span class="built_in">NSString</span> * _Nonnull keyPath, <span class="keyword">id</span>  _Nonnull oldValue, <span class="keyword">id</span>  _Nonnull newValue) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;æ—§å€¼ï¼š%@&quot;</span>, oldValue);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;æ–°å€¼ï¼š%@&quot;</span>, newValue);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;pathï¼š%@&quot;</span>, keyPath);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<p>ç‚¹å‡»å±å¹•çš„æ—¶å€™å»æ”¹å˜è¿™ä¸ªå¯¹è±¡çš„<code>name</code>çš„å€¼ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    <span class="keyword">self</span>.person.name = <span class="string">@&quot;æ–°åå­—&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>ç„¶åå°† demo è¿è¡Œï¼Œç‚¹å‡»è¿™ä¸ªæ§åˆ¶å™¨ï¼ŒæŸ¥çœ‹æ‰“å°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2021-03-30 14:48:14.483797+0800 OCTest[13317:272742] æ—§å€¼ï¼šæ—§åå­—</span><br><span class="line">2021-03-30 14:48:14.483927+0800 OCTest[13317:272742] æ–°å€¼ï¼šæ–°åå­—</span><br><span class="line">2021-03-30 14:48:14.483983+0800 OCTest[13317:272742] pathï¼šname</span><br></pre></td></tr></table></figure>



<p>è‡³æ­¤å°±å®Œæˆäº† KVO çš„ç®€å•å®ç°ã€‚</p>
<h2 id="PS"><a href="#PS" class="headerlink" title="PS"></a>PS</h2><p><a target="_blank" rel="noopener" href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/KeyValueObserving/KeyValueObserving.html">è‹¹æœå¼€å‘æ–‡æ¡£- KVO åŸç†çš„ä»‹ç»</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/facebookarchive/KVOController">FBKVOController</a> </p>
<p><a target="_blank" rel="noopener" href="https://github.com/speam/ExploreKVO.git">æˆ‘çš„å®Œæ•´ä»£ç </a></p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a target="_blank" rel="noopener" href="https://github.com/facebookarchive">facebookarchive</a>/<a target="_blank" rel="noopener" href="https://github.com/facebookarchive/KVOController">KVOController</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/bf99c6dbfc03">KVOåŸç†åˆ†æ</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904090569277447">iOSæ¢ç´¢ KVOåŸç†åŠè‡ªå®šä¹‰</a></p>
<p><a target="_blank" rel="noopener" href="https://www.yuque.com/365cshitou/ontheroad/customkvo">è‡ªå®šä¹‰KVO</a></p>
</div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/03/28/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E3%80%8A%E6%8C%87%E6%95%B0%E5%9F%BA%E9%87%91%E6%8A%95%E8%B5%84%E6%8C%87%E5%8D%97%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">ã€ŠæŒ‡æ•°åŸºé‡‘æŠ•èµ„æŒ‡å—ã€‹è¯»ä¹¦ç¬”è®°</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/03/23/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/13-KVC%E5%8E%9F%E7%90%86/"><span class="level-item">13-KVCåŸç†</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">ç›®å½•</h3><ul class="menu-list"><li><a class="level is-mobile" href="#ä¸€ã€KVOç®€è¿°"><span class="level-left"><span class="level-item">ä¸€ã€KVOç®€è¿°</span></span></a></li><li><a class="level is-mobile" href="#äºŒã€KVOä½¿ç”¨åŠæ³¨æ„ç‚¹"><span class="level-left"><span class="level-item">äºŒã€KVOä½¿ç”¨åŠæ³¨æ„ç‚¹</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#2-1-åŸºæœ¬ä½¿ç”¨"><span class="level-left"><span class="level-item">2.1 åŸºæœ¬ä½¿ç”¨</span></span></a></li><li><a class="level is-mobile" href="#2-2-context-è¯´æ˜"><span class="level-left"><span class="level-item">2.2 context è¯´æ˜</span></span></a></li><li><a class="level is-mobile" href="#2-3-ç§»é™¤è§‚å¯Ÿçš„å¿…è¦æ€§"><span class="level-left"><span class="level-item">2.3 ç§»é™¤è§‚å¯Ÿçš„å¿…è¦æ€§</span></span></a></li><li><a class="level is-mobile" href="#2-4-æ‰‹åŠ¨è§¦å‘é”®å€¼è§‚å¯Ÿ"><span class="level-left"><span class="level-item">2.4 æ‰‹åŠ¨è§¦å‘é”®å€¼è§‚å¯Ÿ</span></span></a></li><li><a class="level is-mobile" href="#2-5-Key-ä¾èµ–æƒ…å†µ"><span class="level-left"><span class="level-item">2.5 Key ä¾èµ–æƒ…å†µ</span></span></a></li><li><a class="level is-mobile" href="#2-6-å¯å˜æ•°ç»„"><span class="level-left"><span class="level-item">2.6 å¯å˜æ•°ç»„</span></span></a></li></ul></li><li><a class="level is-mobile" href="#ä¸‰ã€KVO-åº•å±‚åŸç†â€”isa-swizzling"><span class="level-left"><span class="level-item">ä¸‰ã€KVO åº•å±‚åŸç†â€”isa-swizzling</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-1-å®˜æ–¹è§£é‡Š"><span class="level-left"><span class="level-item">3.1 å®˜æ–¹è§£é‡Š</span></span></a></li><li><a class="level is-mobile" href="#3-2-ä»£ç æ¢ç´¢"><span class="level-left"><span class="level-item">3.2 ä»£ç æ¢ç´¢</span></span></a></li><li><a class="level is-mobile" href="#3-3-åŠ¨æ€å­ç±»æ¢ç´¢"><span class="level-left"><span class="level-item">3.3 åŠ¨æ€å­ç±»æ¢ç´¢</span></span></a></li><li><a class="level is-mobile" href="#3-4-æ€»ç»“"><span class="level-left"><span class="level-item">3.4 æ€»ç»“</span></span></a></li><li><a class="level is-mobile" href="#3-5-åŸç†å›¾"><span class="level-left"><span class="level-item">3.5 åŸç†å›¾</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#æ·»åŠ è§‚å¯Ÿè€…ä¹‹å‰"><span class="level-left"><span class="level-item">æ·»åŠ è§‚å¯Ÿè€…ä¹‹å‰</span></span></a></li><li><a class="level is-mobile" href="#æ·»åŠ è§‚å¯Ÿè€…ä¹‹å"><span class="level-left"><span class="level-item">æ·»åŠ è§‚å¯Ÿè€…ä¹‹å</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#å››ã€è‡ªå·±å®ç°KVO"><span class="level-left"><span class="level-item">å››ã€è‡ªå·±å®ç°KVO</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#4-1-å‰è¨€"><span class="level-left"><span class="level-item">4.1 å‰è¨€</span></span></a></li><li><a class="level is-mobile" href="#4-2-åˆå§‹åŒ–"><span class="level-left"><span class="level-item">4.2 åˆå§‹åŒ–</span></span></a></li><li><a class="level is-mobile" href="#4-3-éªŒè¯æ˜¯å¦å­˜åœ¨setteræ–¹æ³•ï¼Œåªè§‚å¯Ÿå±æ€§"><span class="level-left"><span class="level-item">4.3 éªŒè¯æ˜¯å¦å­˜åœ¨setteræ–¹æ³•ï¼Œåªè§‚å¯Ÿå±æ€§</span></span></a></li><li><a class="level is-mobile" href="#4-4-åˆ¤æ–­automaticallyNotifiesObserversForKeyæ–¹æ³•è¿”å›çš„å¸ƒå°”å€¼"><span class="level-left"><span class="level-item">4.4 åˆ¤æ–­automaticallyNotifiesObserversForKeyæ–¹æ³•è¿”å›çš„å¸ƒå°”å€¼</span></span></a></li><li><a class="level is-mobile" href="#4-5-åŠ¨æ€ç”Ÿæˆå­ç±»"><span class="level-left"><span class="level-item">4.5 åŠ¨æ€ç”Ÿæˆå­ç±»</span></span></a></li><li><a class="level is-mobile" href="#4-6-å°†isaæŒ‡å‘åˆ›å»ºå¥½çš„åŠ¨æ€å­ç±»"><span class="level-left"><span class="level-item">4.6 å°†isaæŒ‡å‘åˆ›å»ºå¥½çš„åŠ¨æ€å­ç±»</span></span></a></li><li><a class="level is-mobile" href="#4-7-ä¿å­˜observerä¿¡æ¯ï¼Œåœ¨setteræ–¹æ³•ä¸­é€šçŸ¥observerçš„æ—¶å€™éœ€è¦ç”¨åˆ°è¯¥ä¿¡æ¯"><span class="level-left"><span class="level-item">4.7 ä¿å­˜observerä¿¡æ¯ï¼Œåœ¨setteræ–¹æ³•ä¸­é€šçŸ¥observerçš„æ—¶å€™éœ€è¦ç”¨åˆ°è¯¥ä¿¡æ¯</span></span></a></li><li><a class="level is-mobile" href="#4-8-æµ‹è¯•"><span class="level-left"><span class="level-item">4.8 æµ‹è¯•</span></span></a></li></ul></li><li><a class="level is-mobile" href="#PS"><span class="level-left"><span class="level-item">PS</span></span></a></li><li><a class="level is-mobile" href="#å‚è€ƒ"><span class="level-left"><span class="level-item">å‚è€ƒ</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/imglogo.png" alt="IMO&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2021 IMO</span>Â Â Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>Â &amp;Â <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/speam"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="å›åˆ°é¡¶ç«¯" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="æƒ³è¦æŸ¥æ‰¾ä»€ä¹ˆ..."></div><a class="searchbox-close" href="javascript:;">Ã—</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"æƒ³è¦æŸ¥æ‰¾ä»€ä¹ˆ...","untitled":"(æ— æ ‡é¢˜)","posts":"æ–‡ç« ","pages":"é¡µé¢","categories":"åˆ†ç±»","tags":"æ ‡ç­¾"});
        });</script></body></html>