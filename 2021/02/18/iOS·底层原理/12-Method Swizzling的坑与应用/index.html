<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>12-Method Swizzling的坑与应用 - IMO&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="IMO&#039;s Blog"><meta name="msapplication-TileImage" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/avatar4.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="IMO&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta description=""><meta property="og:type" content="blog"><meta property="og:title" content="12-Method Swizzling的坑与应用"><meta property="og:url" content="http://evilimo.com/2021/02/18/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/12-Method%20Swizzling%E7%9A%84%E5%9D%91%E4%B8%8E%E5%BA%94%E7%94%A8/"><meta property="og:site_name" content="IMO&#039;s Blog"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1581261054804-ed5bb44f-2426-4b5f-9d6d-8002a32a2e3b-20210218100112589.png"><meta property="article:published_time" content="2021-02-18T01:51:58.136Z"><meta property="article:modified_time" content="2021-02-18T08:19:44.440Z"><meta property="article:author" content="IMO"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1581261054804-ed5bb44f-2426-4b5f-9d6d-8002a32a2e3b-20210218100112589.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://evilimo.com/2021/02/18/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/12-Method%20Swizzling%E7%9A%84%E5%9D%91%E4%B8%8E%E5%BA%94%E7%94%A8/"},"headline":"IMO's Blog","image":["https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1581261054804-ed5bb44f-2426-4b5f-9d6d-8002a32a2e3b-20210218100112589.png"],"datePublished":"2021-02-18T01:51:58.136Z","dateModified":"2021-02-18T08:19:44.440Z","author":{"@type":"Person","name":"IMO"},"description":""}</script><link rel="canonical" href="http://evilimo.com/2021/02/18/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/12-Method%20Swizzling%E7%9A%84%E5%9D%91%E4%B8%8E%E5%BA%94%E7%94%A8/"><link rel="icon" href="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/avatar4.png"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.4.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><!--!--><meta name="generator" content="Hexo 5.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/imglogo.png" alt="IMO&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-02-18T01:51:58.136Z" title="2021-02-18T01:51:58.136Z">2021-02-18</time>发表</span><span class="level-item"><time dateTime="2021-02-18T08:19:44.440Z" title="2021-02-18T08:19:44.440Z">2021-02-18</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/">iOS·底层原理</a></span></div></div><h1 class="title is-3 is-size-4-mobile">12-Method Swizzling的坑与应用</h1><div class="content"><hr>
<a id="more"></a>

<h1 id="一、方法的本质"><a href="#一、方法的本质" class="headerlink" title="一、方法的本质"></a>一、方法的本质</h1><p><code>Objective-C</code>中，方法是由<code>SEL</code>和<code>IMP</code>组成的，前者叫做方法编号，后者叫方法实现。<br><code>OC</code>中调用方法叫做发送消息，发送消息前会先查找消息，查找过程就是通过<code>SEL</code>查找<code>IMP</code>的过程，另外，我们经常在代码中使用<code>@selector(someMethod)</code>这样的语法，<code>@selector()</code>叫做方法选择器，其返回的就是<code>SEL</code>，真正执行时会根据这个<code>SEL</code>查找对应的<code>IMP</code>。</p>
<h1 id="二、MethodSwizzling-原理"><a href="#二、MethodSwizzling-原理" class="headerlink" title="二、MethodSwizzling 原理"></a>二、MethodSwizzling 原理</h1><p>比如有方法<code>sel1</code>对应<code>imp1</code>，<code>sel2</code>对应<code>imp2</code>，经过方法交换，使得<code>runtime</code>在方法查找时将<code>sel1</code>的查找结果变为<code>imp2</code>：</p>
<p>￼<img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/1581261054804-ed5bb44f-2426-4b5f-9d6d-8002a32a2e3b-20210218100112589.png"></p>
<h1 id="三、Method-Swizzling-相关函数-API"><a href="#三、Method-Swizzling-相关函数-API" class="headerlink" title="三、Method Swizzling 相关函数 API"></a>三、Method Swizzling 相关函数 API</h1><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过SEL获取一个方法</span></span><br><span class="line">class_getInstanceMethod</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取一个方法的实现</span></span><br><span class="line">method_getImplementation</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取一个OC实现的编码类型</span></span><br><span class="line">method_getTypeEncoding</span><br><span class="line"></span><br><span class="line"><span class="comment">// 给方法添加实现</span></span><br><span class="line">class_addMethod</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用一个方法的实现替换另一个方法的实现</span></span><br><span class="line">class_replaceMethod</span><br><span class="line"></span><br><span class="line"><span class="comment">// 交换两个方法的实现</span></span><br><span class="line">method_exchangeImplementations</span><br></pre></td></tr></table></figure>

<h1 id="四、简单示例"><a href="#四、简单示例" class="headerlink" title="四、简单示例"></a>四、简单示例</h1><p>新建一个<code>iOS</code>工程，新建一个<code>Person</code>类，并为<code>Person</code>添加两个方法<code>-walk</code>和<code>-run</code>：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Person.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)walk;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)run;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Person.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)walk &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;walk&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)run &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;run&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>新建一个<code>NSObject</code>的分类<code>MethodSwizzling</code>如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NSObject+MethodSwizzling.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSObject</span> (<span class="title">MethodSwizzling</span>)</span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)methodswizzlingWithClass:(Class)cls orgSEL:(SEL)orgSEL targetSEL:(SEL)targetSEL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// NSObject+MethodSwizzling.m</span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">MethodSwizzling</span>)</span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)methodswizzlingWithClass:(Class)cls orgSEL:(SEL)orgSEL targetSEL:(SEL)targetSEL &#123;</span><br><span class="line">    Method orgMethod = class_getInstanceMethod(cls, orgSEL);</span><br><span class="line">    Method tgtMethod = class_getInstanceMethod(cls, targetSEL);</span><br><span class="line">    method_exchangeImplementations(orgMethod, tgtMethod);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>在<code>Person.m</code>中重写<code>+load</code>方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        [<span class="keyword">self</span> methodswizzlingWithClass:<span class="keyword">self</span></span><br><span class="line">                                orgSEL:<span class="keyword">@selector</span>(walk)</span><br><span class="line">                             targetSEL:<span class="keyword">@selector</span>(run)];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>ViewController</code>的<code>-viewDidLoad</code>中调用<code>-walk</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    Person *person &#x3D; [[Person alloc] init];</span><br><span class="line">    [person walk];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行程序，控制台输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2020-02-09 21:26:07.613230+0800 TestObjC[1716:74628] run</span><br></pre></td></tr></table></figure>

<p>调用的是<code>-walk</code>，实际执行的是<code>-run</code>，完成了方法交换。</p>
<h1 id="五、坑点"><a href="#五、坑点" class="headerlink" title="五、坑点"></a>五、坑点</h1><h2 id="5-1-交换方法后再调用-load-方法"><a href="#5-1-交换方法后再调用-load-方法" class="headerlink" title="5.1 交换方法后再调用 load 方法"></a>5.1 交换方法后再调用 load 方法</h2><p>第一个坑点比较简单，就是我们在<code>load</code>中交换完方法后，不做处理的话，如果再去调用<code>load</code>，方法<code>IMP</code>会又被交换回来，导致交换不成功。</p>
<p>解决的方法也比较简单：使用单例模式来交换方法，保证方法的交换只执行一次</p>
<h2 id="5-2-在继承的类中进行方法交换导致交换的结果和预期不一致"><a href="#5-2-在继承的类中进行方法交换导致交换的结果和预期不一致" class="headerlink" title="5.2 在继承的类中进行方法交换导致交换的结果和预期不一致"></a>5.2 在继承的类中进行方法交换导致交换的结果和预期不一致</h2><p>具体描述是：在子类中交换它独有的方法和继承自父类的方法，子类交换是成功了，但是父类中的方法也被交换了。</p>
<p>使用的时候多注意一下。</p>
<p>例：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Person.h</span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Person</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)walk;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">Person.m</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Person</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)walk &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;walk&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>



<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Student.h</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Student</span> : <span class="title">Person</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)study;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">Student.m</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Student</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)study &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;study&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        [<span class="keyword">self</span> methodSwizzlingWithClass:<span class="keyword">self</span> orgSEL:<span class="keyword">@selector</span>(walk) targetSEL:<span class="keyword">@selector</span>(study)];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)methodSwizzlingWithClass:(Class)cls orgSEL:(SEL)orgSEL targetSEL:(SEL)targetSEL &#123;</span><br><span class="line">    Method orgMethod = class_getInstanceMethod(cls, orgSEL);</span><br><span class="line">    Method tgtMethod = class_getInstanceMethod(cls, targetSEL);</span><br><span class="line"></span><br><span class="line">    method_exchangeImplementations(orgMethod, tgtMethod);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Student 类中方法交换成功了</span></span><br><span class="line">Student *s = [Student new];</span><br><span class="line">[s walk];		<span class="comment">// study</span></span><br><span class="line">[s study];  <span class="comment">// walk</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 但是顺便也把父类给交换了（这是我们不需要的，多注意）</span></span><br><span class="line">Person *p = [Person new];</span><br><span class="line">[p walk];		<span class="comment">// study</span></span><br></pre></td></tr></table></figure>

<h2 id="5-3-要交换的方法未实现时会交换失败"><a href="#5-3-要交换的方法未实现时会交换失败" class="headerlink" title="5.3 要交换的方法未实现时会交换失败"></a>5.3 要交换的方法未实现时会交换失败</h2><p>还是上面的例子，如果 Student 类中，只声明了 -study 方法，但是未实现，再交换 -walk 方法和 -study 方法就会交换失败，还是之前的老样子，这点也要注意（不过正常人写不出这种代码）</p>
<h1 id="六、常见应用"><a href="#六、常见应用" class="headerlink" title="六、常见应用"></a>六、常见应用</h1><h2 id="6-1-埋点统计"><a href="#6-1-埋点统计" class="headerlink" title="6.1 埋点统计"></a>6.1 埋点统计</h2><h3 id="6-1-1-页面浏览事件"><a href="#6-1-1-页面浏览事件" class="headerlink" title="6.1.1 页面浏览事件"></a>6.1.1 页面浏览事件</h3><p>在 iOS 开发中最常见的三种埋点，就是对页面进入次数、页面停留时间、点击事件的埋点。这些都可以通过Method Swizzling来实现。</p>
<p>通过交换<code>UIViewController</code>中<code>viewWillAppear</code>和<code>viewWillDisappear</code>的方法，来实现了进入界面和退出界面的统计，并记录了相关的类名，通过映射的关系，就可以清楚的知道用户的行为了。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIViewController</span> (<span class="title">logger</span>)</span></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        <span class="comment">// 通过 @selector 获得被替换和替换方法的 SEL，作为 SMHook:hookClass:fromeSelector:toSelector 的参数传入 </span></span><br><span class="line">        SEL fromSelectorAppear = <span class="keyword">@selector</span>(viewWillAppear:);</span><br><span class="line">        SEL toSelectorAppear = <span class="keyword">@selector</span>(hook_viewWillAppear:);</span><br><span class="line">        [SMHook hookClass:<span class="keyword">self</span> fromSelector:fromSelectorAppear toSelector:toSelectorAppear];</span><br><span class="line">        </span><br><span class="line">        SEL fromSelectorDisappear = <span class="keyword">@selector</span>(viewWillDisappear:);</span><br><span class="line">        SEL toSelectorDisappear = <span class="keyword">@selector</span>(hook_viewWillDisappear:);</span><br><span class="line">        </span><br><span class="line">        [SMHook hookClass:<span class="keyword">self</span> fromSelector:fromSelectorDisappear toSelector:toSelectorDisappear];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)hook_viewWillAppear:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line">    <span class="comment">// 先执行插入代码，再执行原 viewWillAppear 方法</span></span><br><span class="line">    [<span class="keyword">self</span> insertToViewWillAppear];</span><br><span class="line">    [<span class="keyword">self</span> hook_viewWillAppear:animated];</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)hook_viewWillDisappear:(<span class="built_in">BOOL</span>)animated &#123;</span><br><span class="line">    <span class="comment">// 执行插入代码，再执行原 viewWillDisappear 方法</span></span><br><span class="line">    [<span class="keyword">self</span> insertToViewWillDisappear];</span><br><span class="line">    [<span class="keyword">self</span> hook_viewWillDisappear:animated];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)insertToViewWillAppear &#123;</span><br><span class="line">    <span class="comment">// 在 ViewWillAppear 时进行日志的埋点</span></span><br><span class="line">    [[[[SMLogger create]</span><br><span class="line">       message:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;%@ Appear&quot;</span>,<span class="built_in">NSStringFromClass</span>([<span class="keyword">self</span> <span class="keyword">class</span>])]]</span><br><span class="line">      classify:ProjectClassifyOperation]</span><br><span class="line">     save];</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)insertToViewWillDisappear &#123;</span><br><span class="line">    ✅/ 在 ViewWillDisappear 时进行日志的埋点</span><br><span class="line">    [[[[SMLogger create]</span><br><span class="line">       message:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;%@ Disappear&quot;</span>,<span class="built_in">NSStringFromClass</span>([<span class="keyword">self</span> <span class="keyword">class</span>])]]</span><br><span class="line">      classify:ProjectClassifyOperation]</span><br><span class="line">     save];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h3 id="6-1-2-控件点击事件"><a href="#6-1-2-控件点击事件" class="headerlink" title="6.1.2 控件点击事件"></a>6.1.2 控件点击事件</h3><p>那么点击方法，我们也可以通过运行时进行方法替换实现无侵入埋点。</p>
<p><strong>原理：</strong></p>
<p>当我们为一个控件添加 Target-Action 后，用户操作控件（比如点击）时，首先会调用<code>-sendAction:to:forEvent:</code>方法，并将事件转发给应用程序的 UIApplication 对象。（UIApplication 类中对应的是<code>-sendAction:from:forEvent:</code>方法）</p>
<p>如果 Target 不为空，应用程序会让该对象调用对应的方法响应事件；如果 Target 为空，应用程序会在响应链中搜索定义了该方法的对象，然后执行该方法。</p>
<p>因此我们可以通过 Method Swizzling 交换 UIApplication 类中的<code>-sendAction:from:forEvent:</code>方法，然后在交换后的方法中触发采集事件。</p>
<p><strong>完整代码：</strong></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&quot;UIApplication+XWTracking.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&quot;XWTrackingAnalysisSDK.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&quot;NSObject+XWSwizzler.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&quot;UIView+XWTracking.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIApplication</span> (<span class="title">XWTracking</span>)</span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    [<span class="built_in">UIApplication</span> xwtracking_swizzleMethod:<span class="keyword">@selector</span>(sendAction:to:from:forEvent:) withMethod:<span class="keyword">@selector</span>(xwtracking_sendAction:to:from:forEvent:)];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)xwtracking_sendAction:(SEL)action to:(<span class="keyword">nullable</span> <span class="keyword">id</span>)target from:(<span class="keyword">nullable</span> <span class="keyword">id</span>)sender forEvent:(<span class="keyword">nullable</span> <span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    <span class="comment">// UITabBarItem继承自NSObject，不过滤会崩溃</span></span><br><span class="line">    <span class="built_in">BOOL</span> condition = ((event.allTouches.anyObject.phase == <span class="built_in">UITouchPhaseEnded</span>) || [sender isKindOfClass:<span class="built_in">UISwitch</span>.class] || [sender isKindOfClass:<span class="built_in">UISegmentedControl</span>.class] || [sender isKindOfClass:<span class="built_in">UIStepper</span>.class]) &amp;&amp; !([sender isKindOfClass:<span class="built_in">UITabBarItem</span>.class] || [sender isKindOfClass:<span class="built_in">UIBarButtonItem</span>.class]);</span><br><span class="line">    <span class="keyword">if</span> (condition) &#123;</span><br><span class="line">        <span class="comment">// 触发$AppClick事件</span></span><br><span class="line">        [XWTrackingAnalysisSDK.shareInstance trackAppClickWithView:sender properties:<span class="literal">nil</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 调用原有实现</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> xwtracking_sendAction:action to:target from:sender forEvent:event];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>和 <code>UIViewController</code>生命周期埋点不同的是，<code>UIButton</code>在一个视图类中可能有多个不同的继承类，相同 <code>UIButton</code>的子类在不同视图类的埋点也要区别开：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)trackAppClickWithView:(<span class="built_in">UIView</span> *)view properties:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *,<span class="keyword">id</span>&gt; *)properties &#123;</span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *eventProperties = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    <span class="comment">// 获取控件类型</span></span><br><span class="line">    eventProperties[<span class="string">@&quot;$element_type&quot;</span>] = view.xwtracking_elementType;</span><br><span class="line">    <span class="comment">// 获取控件显示文本</span></span><br><span class="line">    eventProperties[<span class="string">@&quot;$element_content&quot;</span>] = view.xwtracking_elementContent;</span><br><span class="line">    <span class="comment">// 获取控件所在的 UIViewController</span></span><br><span class="line">    <span class="built_in">UIViewController</span> *vc = view.xwtracking_viewController;</span><br><span class="line">    <span class="comment">// 设置页面相关属性</span></span><br><span class="line">    eventProperties[<span class="string">@&quot;$screen_name&quot;</span>] = <span class="built_in">NSStringFromClass</span>(vc.class);</span><br><span class="line">    <span class="comment">// 添加自定义属性</span></span><br><span class="line">    [eventProperties addEntriesFromDictionary:properties];</span><br><span class="line">    <span class="comment">// 触发$AppClick事件</span></span><br><span class="line">    [XWTrackingAnalysisSDK.shareInstance track:<span class="string">@&quot;$AppClick&quot;</span> properties:eventProperties];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除了 <code>UIViewController</code>、<code>UIButton</code> 控件以外，Cocoa 框架的其他控件都可以使用这种方法来进行无侵入埋点。以 Cocoa 框架中最复杂的 <code>UITableView</code> 控件为例，你可以使用 <code>hook setDelegate</code> 方法来实现无侵入埋点。另外，对于 Cocoa 框架中的手势事件（<code>Gesture Event</code>），我们也可以通过 <code>hook initWithTarget:action:</code>方法来实现无侵入埋点。</p>
<h2 id="6-2-防止数组，字典等越界崩溃"><a href="#6-2-防止数组，字典等越界崩溃" class="headerlink" title="6.2 防止数组，字典等越界崩溃"></a>6.2 防止数组，字典等越界崩溃</h2><p>数组越界等是最容易造成<code>crash</code>的一种方式，而且一般崩溃起来比较严重，所以我们要尽量避免。</p>
<p>在iOS中<code>NSNumber、NSArray、NSDictionary</code>等这些类都是<code>类簇(Class Clusters)</code>，一个<code>NSArray</code>的实现可能由多个类组成。所以如果想对<code>NSArray</code>进行<code>Swizzling</code>，必须获取到其<strong>真身</strong>进行<code>Swizzling</code>，直接对<strong>NSArray进行操作是无效的</strong>。这是因为Method Swizzling对NSArray这些的类簇是不起作用的。</p>
<p>因为这些类簇类，其实是一种抽象工厂的设计模式。抽象工厂内部有很多其它继承自当前类的子类，抽象工厂类会根据不同情况，创建不同的抽象对象来进行使用。例如我们调用<code>NSArray</code>的<code>objectAtIndex:</code>方法，这个类会在方法内部判断，内部创建不同抽象类进行操作。</p>
<p>所以如果我们对<code>NSArray</code>类进行<code>Swizzling</code>操作其实只是对父类进行了操作，在<code>NSArray</code>内部会创建其他子类来执行操作，真正执行<code>Swizzling</code>操作的并不是<code>NSArray</code>自身，所以我们应该对其“真身”进行操作。</p>
<p>下面列举了<code>NSArray</code>和<code>NSDictionary</code>本类的类名，可以通过Runtime函数取出本类：</p>
<table>
<thead>
<tr>
<th align="left">类名</th>
<th align="left">真身</th>
</tr>
</thead>
<tbody><tr>
<td align="left">NSArray</td>
<td align="left">__NSArrayI</td>
</tr>
<tr>
<td align="left">NSMutableArray</td>
<td align="left">__NSArrayM</td>
</tr>
<tr>
<td align="left">NSDictionary</td>
<td align="left">__NSDictionaryI</td>
</tr>
<tr>
<td align="left">NSMutableDictionary</td>
<td align="left">__NSDictionaryM</td>
</tr>
</tbody></table>
<h3 id="6-2-1-处理-NSArray"><a href="#6-2-1-处理-NSArray" class="headerlink" title="6.2.1 处理 NSArray"></a>6.2.1 处理 NSArray</h3><p>NSArray+CrashHandle.h</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  NSArray+CrashHandle.h</span></span><br><span class="line"><span class="comment">//  Test14</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Created by IMO on 2020/10/10.</span></span><br><span class="line"><span class="comment">//  Copyright © 2020 IMO. All rights reserved.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NS_ASSUME_NONNULL_BEGIN</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSArray</span> (<span class="title">CrashHandle</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NS_ASSUME_NONNULL_END</span></span><br></pre></td></tr></table></figure>



<p>NSArray+CrashHandle.m</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  NSArray+CrashHandle.m</span></span><br><span class="line"><span class="comment">//  Test14</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Created by IMO on 2020/10/10.</span></span><br><span class="line"><span class="comment">//  Copyright © 2020 IMO. All rights reserved.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&quot;NSArray+CrashHandle.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSArray</span> (<span class="title">CrashHandle</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果下面代码不起作用，造成这个问题的原因大多都是其调用了super load方法。在下面的load方法中，不应该调用父类的load方法。这样会导致方法交换无效</span></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;    </span><br><span class="line">    Method fromMethod = class_getInstanceMethod(objc_getClass(<span class="string">&quot;__NSArrayI&quot;</span>), <span class="keyword">@selector</span>(objectAtIndex:));</span><br><span class="line">    Method toMethod = class_getInstanceMethod(objc_getClass(<span class="string">&quot;__NSArrayI&quot;</span>), <span class="keyword">@selector</span>(xw_objectAtIndex:));</span><br><span class="line">    method_exchangeImplementations(fromMethod, toMethod);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)xw_objectAtIndex:(<span class="built_in">NSUInteger</span>)index &#123;</span><br><span class="line">    <span class="keyword">if</span> (index &gt; <span class="keyword">self</span>.count - <span class="number">1</span>) &#123;   <span class="comment">// 数组越界</span></span><br><span class="line">        <span class="keyword">@try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> [<span class="keyword">self</span> xw_objectAtIndex:index];</span><br><span class="line">        &#125; <span class="keyword">@catch</span> (<span class="built_in">NSException</span> *exception) &#123;</span><br><span class="line">            <span class="comment">// 在崩溃后会打印崩溃信息。如果是线上，可以在这里将崩溃信息发送到服务器</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;---------- %s Crash Because Method %s  ----------\n&quot;</span>, class_getName(<span class="keyword">self</span>.class), __func__);</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, [exception callStackSymbols]);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">        &#125; <span class="keyword">@finally</span> &#123;&#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;	<span class="comment">// 如果没有问题，则正常进行方法调用</span></span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">self</span> xw_objectAtIndex:index];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>



<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">**************************调用******************************</span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 测试代码</span></span><br><span class="line">    <span class="built_in">NSArray</span> *array = @[@<span class="number">0</span>, @<span class="number">1</span>, @<span class="number">2</span>, @<span class="number">3</span>];</span><br><span class="line">    [array objectAtIndex:<span class="number">3</span>];</span><br><span class="line">    <span class="comment">//本来要奔溃的，但是没有，打印出了信息</span></span><br><span class="line">    [array objectAtIndex:<span class="number">4</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-2-2-处理-NSMutableArray"><a href="#6-2-2-处理-NSMutableArray" class="headerlink" title="6.2.2 处理 NSMutableArray"></a>6.2.2 处理 NSMutableArray</h3><p>NSMutableArray+CrashHandle.h</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  NSMutableArray+CrashHandle.h</span></span><br><span class="line"><span class="comment">//  Test14</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Created by IMO on 2020/10/10.</span></span><br><span class="line"><span class="comment">//  Copyright © 2020 IMO. All rights reserved.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NS_ASSUME_NONNULL_BEGIN</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSMutableArray</span> (<span class="title">CrashHandle</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NS_ASSUME_NONNULL_END</span></span><br></pre></td></tr></table></figure>



<p>NSMutableArray+CrashHandle.m</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  NSMutableArray+CrashHandle.m</span></span><br><span class="line"><span class="comment">//  Test14</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Created by IMO on 2020/10/10.</span></span><br><span class="line"><span class="comment">//  Copyright © 2020 IMO. All rights reserved.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&quot;NSMutableArray+CrashHandle.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSMutableArray</span> (<span class="title">CrashHandle</span>)</span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;   </span><br><span class="line">    Method fromMethod = class_getInstanceMethod(objc_getClass(<span class="string">&quot;__NSArrayM&quot;</span>), <span class="keyword">@selector</span>(objectAtIndex:));</span><br><span class="line">    Method toMethod = class_getInstanceMethod(objc_getClass(<span class="string">&quot;__NSArrayM&quot;</span>), <span class="keyword">@selector</span>(xw_objectAtIndex:));</span><br><span class="line">    method_exchangeImplementations(fromMethod, toMethod);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)xw_objectAtIndex:(<span class="built_in">NSUInteger</span>)index &#123;</span><br><span class="line">    <span class="keyword">if</span> (index &gt; <span class="keyword">self</span>.count - <span class="number">1</span>) &#123;   <span class="comment">// 数组越界</span></span><br><span class="line">        <span class="keyword">@try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> [<span class="keyword">self</span> xw_objectAtIndex:index];</span><br><span class="line">        &#125; <span class="keyword">@catch</span> (<span class="built_in">NSException</span> *exception) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;---------- %s Crash Because Method %s  ----------\n&quot;</span>, class_getName(<span class="keyword">self</span>.class), __func__);</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, [exception callStackSymbols]);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">        &#125; <span class="keyword">@finally</span> &#123;&#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">self</span> xw_objectAtIndex:index];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>以上的两个例子，只是开发中常用的，还有很多其他的应用，就需要根据需求来不断调整了。这些都属于 AOP 面向切面编程的一个实际应用，Method Swizzling 也是其在 iOS 开发中应用的最常用的一种 AOP 思想</p>
</blockquote>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="">iOS底层学习 - Runtime之Method Swizzling黑魔法</a></p>
<p><a target="_blank" rel="noopener" href="https://www.yuque.com/365cshitou/ontheroad/methodswizzling">Objective-C 的 MethodSwizzling</a></p>
</div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/02/17/iOS%C2%B7%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/11-weak%E5%8E%9F%E7%90%86%E6%8E%A2%E7%A9%B6/"><span class="level-item">11-weak原理探究</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#一、方法的本质"><span class="level-left"><span class="level-item">一、方法的本质</span></span></a></li><li><a class="level is-mobile" href="#二、MethodSwizzling-原理"><span class="level-left"><span class="level-item">二、MethodSwizzling 原理</span></span></a></li><li><a class="level is-mobile" href="#三、Method-Swizzling-相关函数-API"><span class="level-left"><span class="level-item">三、Method Swizzling 相关函数 API</span></span></a></li><li><a class="level is-mobile" href="#四、简单示例"><span class="level-left"><span class="level-item">四、简单示例</span></span></a></li><li><a class="level is-mobile" href="#五、坑点"><span class="level-left"><span class="level-item">五、坑点</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#5-1-交换方法后再调用-load-方法"><span class="level-left"><span class="level-item">5.1 交换方法后再调用 load 方法</span></span></a></li><li><a class="level is-mobile" href="#5-2-在继承的类中进行方法交换导致交换的结果和预期不一致"><span class="level-left"><span class="level-item">5.2 在继承的类中进行方法交换导致交换的结果和预期不一致</span></span></a></li><li><a class="level is-mobile" href="#5-3-要交换的方法未实现时会交换失败"><span class="level-left"><span class="level-item">5.3 要交换的方法未实现时会交换失败</span></span></a></li></ul></li><li><a class="level is-mobile" href="#六、常见应用"><span class="level-left"><span class="level-item">六、常见应用</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#6-1-埋点统计"><span class="level-left"><span class="level-item">6.1 埋点统计</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#6-1-1-页面浏览事件"><span class="level-left"><span class="level-item">6.1.1 页面浏览事件</span></span></a></li><li><a class="level is-mobile" href="#6-1-2-控件点击事件"><span class="level-left"><span class="level-item">6.1.2 控件点击事件</span></span></a></li></ul></li><li><a class="level is-mobile" href="#6-2-防止数组，字典等越界崩溃"><span class="level-left"><span class="level-item">6.2 防止数组，字典等越界崩溃</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#6-2-1-处理-NSArray"><span class="level-left"><span class="level-item">6.2.1 处理 NSArray</span></span></a></li><li><a class="level is-mobile" href="#6-2-2-处理-NSMutableArray"><span class="level-left"><span class="level-item">6.2.2 处理 NSMutableArray</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#参考"><span class="level-left"><span class="level-item">参考</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="https://cdn.jsdelivr.net/gh/speam/blogImgs@main/imglogo.png" alt="IMO&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2021 IMO</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/speam"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>